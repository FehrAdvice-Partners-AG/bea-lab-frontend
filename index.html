<!DOCTYPE html>
<html lang="de">
<head>
<script>if(location.hostname==='bea-lab.io')location.replace('https://www.bea-lab.io'+location.pathname+location.search+location.hash);</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>BEATRIX – The Strategic Intelligence Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #0a1628; --navy-light: #111d35; --navy-mid: #162244; --navy-card: #1a2847; --navy-hover: #1f3055;
            --border: #253556; --border-light: #2d4070;
            --accent: #5b8af5; --accent-light: #7ba3ff; --accent-glow: rgba(91,138,245,0.12); --accent-glow-strong: rgba(91,138,245,0.25);
            --text: #e4e9f2; --text-secondary: #8899b8; --text-muted: #586a8e; --white: #ffffff;
            --success: #34d399; --success-bg: rgba(52,211,153,0.1); --warning: #fbbf24;
            --error: #f87171; --error-bg: rgba(248,113,113,0.08);
            --radius: 14px; --radius-sm: 8px; --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Plus Jakarta Sans',-apple-system,sans-serif; background:var(--navy); color:var(--text); min-height:100vh; overflow-x:hidden; -webkit-font-smoothing:antialiased; }
        body::before { content:''; position:fixed; inset:0; background:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(91,138,245,0.06),transparent),radial-gradient(ellipse 60% 50% at 80% 100%,rgba(91,138,245,0.04),transparent); pointer-events:none; z-index:0; }

        /* ── Login/Register Overlay ──────────────────────── */
        .auth-overlay { position:fixed; inset:0; z-index:10000; background:var(--navy); display:flex; align-items:center; justify-content:center; transition:opacity 0.5s ease, visibility 0.5s ease; }
        .auth-overlay.hidden { opacity:0; visibility:hidden; pointer-events:none; }
        .auth-card { width:100%; max-width:420px; padding:48px 40px; text-align:center; }
        .auth-logo { width:80px; height:80px; border-radius:20px; margin:0 auto 28px; object-fit:cover; box-shadow:0 8px 40px rgba(91,138,245,0.2); }
        .auth-title { font-size:28px; font-weight:800; color:var(--white); margin-bottom:6px; letter-spacing:-0.3px; }
        .auth-title span { background:linear-gradient(135deg,var(--accent),var(--accent-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .auth-subtitle { font-size:14px; color:var(--text-secondary); margin-bottom:32px; line-height:1.6; }
        .auth-form { display:flex; flex-direction:column; gap:14px; }
        .auth-input-wrapper { position:relative; }
        .auth-input-wrapper svg { position:absolute; left:16px; top:50%; transform:translateY(-50%); width:18px; height:18px; stroke:var(--text-muted); transition:var(--transition); pointer-events:none; }
        .auth-input { width:100%; padding:14px 16px 14px 46px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius); color:var(--text); font-family:inherit; font-size:15px; outline:none; transition:var(--transition); }
        .auth-input::placeholder { color:var(--text-muted); }
        .auth-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); background:var(--navy-card); }
        .auth-btn { width:100%; padding:14px; background:var(--accent); color:white; border:none; border-radius:var(--radius); font-size:15px; font-weight:700; font-family:inherit; cursor:pointer; transition:var(--transition); box-shadow:0 4px 20px rgba(91,138,245,0.3); display:flex; align-items:center; justify-content:center; gap:10px; }
        .auth-btn:hover { background:var(--accent-light); transform:translateY(-1px); box-shadow:0 6px 28px rgba(91,138,245,0.4); }
        .auth-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
        .auth-error { font-size:13px; color:var(--error); padding:10px 14px; background:var(--error-bg); border:1px solid rgba(248,113,113,0.15); border-radius:var(--radius-sm); display:none; animation:shake 0.4s ease; text-align:left; }
        .auth-error.visible { display:block; }
        .auth-success { font-size:13px; color:var(--success); padding:10px 14px; background:var(--success-bg); border:1px solid rgba(52,211,153,0.15); border-radius:var(--radius-sm); display:none; text-align:left; }
        .auth-success.visible { display:block; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 50%{transform:translateX(6px)} 75%{transform:translateX(-4px)} }
        .auth-switch { margin-top:24px; font-size:13px; color:var(--text-muted); }
        .auth-switch a { color:var(--accent); text-decoration:none; font-weight:600; cursor:pointer; }
        .auth-switch a:hover { color:var(--accent-light); text-decoration:underline; }
        .auth-footer { margin-top:28px; font-size:11px; color:var(--text-muted); }
        .auth-footer a { color:var(--accent); text-decoration:none; }
        .auth-panel { display:none; }
        .auth-panel.active { display:block; }
        .auth-divider { display:flex; align-items:center; gap:12px; margin:4px 0; font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; }
        .auth-divider::before, .auth-divider::after { content:''; flex:1; height:1px; background:var(--border); }

        /* ── Nav ─────────────────────────────────────────── */
        .nav { position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:space-between; padding:0 40px; height:64px; background:rgba(10,22,40,0.9); backdrop-filter:blur(24px); border-bottom:1px solid var(--border); }
        .nav-brand { display:flex; align-items:center; gap:14px; text-decoration:none; }
        .nav-logo-img { height:34px; width:auto; border-radius:6px; }
        .nav-title { font-size:16px; font-weight:700; color:var(--white); letter-spacing:1.5px; text-transform:uppercase; }
        .nav-links { display:flex; align-items:center; gap:4px; }
        .nav-link { padding:8px 16px; font-size:13px; font-weight:500; color:var(--text-secondary); text-decoration:none; border-radius:var(--radius-sm); transition:var(--transition); }
        .nav-link:hover, .nav-link.active { color:var(--white); background:var(--navy-mid); }
        /* ── Nav Dropdowns ── */
        .nav-dropdown { position:relative; }
        .nav-dropdown-trigger { padding:8px 16px; font-size:13px; font-weight:500; color:var(--text-secondary); border-radius:var(--radius-sm); transition:var(--transition); cursor:pointer; display:flex; align-items:center; gap:6px; background:none; border:none; font-family:inherit; }
        .nav-dropdown-trigger:hover, .nav-dropdown-trigger.active { color:var(--white); background:var(--navy-mid); }
        .nav-dropdown-trigger svg { width:10px; height:10px; opacity:0.5; transition:transform 0.2s; }
        .nav-dropdown.open .nav-dropdown-trigger svg { transform:rotate(180deg); }
        .nav-dropdown-menu { display:none; position:absolute; top:calc(100% + 6px); left:0; min-width:260px; background:var(--navy-mid); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 12px 32px rgba(0,0,0,0.4); padding:6px; z-index:200; }
        .nav-dropdown.open .nav-dropdown-menu { display:block; }
        .nav-dropdown-item { display:flex; align-items:center; gap:10px; padding:10px 14px; font-size:13px; font-weight:500; color:var(--text-secondary); text-decoration:none; border-radius:var(--radius-sm); transition:var(--transition); cursor:pointer; white-space:nowrap; }
        .nav-dropdown-item:hover { color:var(--white); background:rgba(255,255,255,0.06); }
        .nav-dropdown-item.active { color:var(--white); background:rgba(255,255,255,0.08); }
        .nav-dropdown-item svg { width:15px; height:15px; opacity:0.5; flex-shrink:0; }
        .nav-dropdown-item:hover svg { opacity:0.8; }
        .nav-dropdown-divider { height:1px; background:var(--border); margin:4px 6px; }
        .nav-dropdown-header { padding:6px 14px 4px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:rgba(255,255,255,0.25); pointer-events:none; }
        .nav-right { display:flex; align-items:center; gap:12px; }
        .nav-status { display:flex; align-items:center; gap:7px; font-size:12px; font-weight:500; color:var(--success); padding:5px 12px; background:var(--success-bg); border-radius:20px; }
        .nav-status .dot { width:6px; height:6px; border-radius:50%; background:var(--success); animation:pulse 2s infinite; }
        .nav-user { font-size:12px; color:var(--text-secondary); padding:5px 12px; background:var(--navy-light); border:1px solid var(--border); border-radius:20px; }
        .nav-logout { padding:5px 12px; font-size:12px; font-weight:500; color:var(--text-muted); background:var(--navy-light); border:1px solid var(--border); border-radius:20px; cursor:pointer; transition:var(--transition); font-family:inherit; display:flex; align-items:center; gap:5px; }
        .nav-logout:hover { color:var(--error); border-color:rgba(248,113,113,0.3); background:var(--error-bg); }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        /* ── Hero ────────────────────────────────────────── */
        .hero { position:relative; z-index:1; text-align:center; padding:80px 24px 60px; border-bottom:1px solid var(--border); }
        .hero-logo { width:120px; height:120px; border-radius:24px; margin:0 auto 32px; object-fit:cover; box-shadow:0 8px 40px rgba(91,138,245,0.15); }
        .hero h1 { font-size:42px; font-weight:800; letter-spacing:-0.5px; color:var(--white); margin-bottom:12px; }
        .hero h1 span { background:linear-gradient(135deg,var(--accent),var(--accent-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .hero .subtitle { font-size:17px; color:var(--text-secondary); max-width:520px; margin:0 auto 36px; line-height:1.7; }
        .hero-stats { display:flex; justify-content:center; gap:40px; }
        .hero-stat { text-align:center; }
        .hero-stat .num { font-size:28px; font-weight:800; color:var(--white); }
        .hero-stat .label { font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-top:2px; }

        /* ── Sections ───────────────────────────────────── */
        .section { display:none; position:relative; z-index:1; }
        .section.active { display:block; }
        .container { max-width:960px; margin:0 auto; padding:40px 24px 80px; }
        .section-header { margin-bottom:32px; }
        .section-header h2 { font-size:24px; font-weight:700; color:var(--white); margin-bottom:6px; }
        .section-header p { font-size:14px; color:var(--text-secondary); line-height:1.6; }
        .db-selector { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:28px; }
        .db-option { padding:16px 18px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius); cursor:pointer; transition:var(--transition); }
        .db-option:hover { background:var(--navy-card); border-color:var(--border-light); }
        .db-option.selected { background:var(--navy-card); border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .db-option-title { font-size:14px; font-weight:600; color:var(--white); margin-bottom:3px; display:flex; align-items:center; gap:8px; }
        .db-dot { width:8px; height:8px; border-radius:50%; }
        .db-option-desc { font-size:12px; color:var(--text-muted); }
        .tabs { display:flex; gap:4px; margin-bottom:28px; background:var(--navy-light); padding:4px; border-radius:var(--radius); border:1px solid var(--border); width:fit-content; }
        .tab { padding:10px 22px; border-radius:10px; font-size:13px; font-weight:600; color:var(--text-secondary); cursor:pointer; transition:var(--transition); border:none; background:none; font-family:inherit; }
        .tab:hover { color:var(--text); }
        .tab.active { background:var(--navy-card); color:var(--white); box-shadow:0 2px 8px rgba(0,0,0,0.2); }
        .upload-zone { border:2px dashed var(--border); border-radius:var(--radius); padding:52px 40px; text-align:center; cursor:pointer; transition:var(--transition); background:var(--navy-light); position:relative; overflow:hidden; }
        .upload-zone::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse at center,var(--accent-glow),transparent 70%); opacity:0; transition:var(--transition); }
        .upload-zone:hover,.upload-zone.dragover { border-color:var(--accent); background:var(--navy-card); }
        .upload-zone:hover::before,.upload-zone.dragover::before { opacity:1; }
        .upload-icon { position:relative; z-index:1; margin-bottom:16px; }
        .upload-icon svg { width:36px; height:36px; stroke:var(--accent); }
        .upload-zone h3 { position:relative; z-index:1; font-size:16px; font-weight:600; margin-bottom:6px; color:var(--white); }
        .upload-zone h3 span { color:var(--accent-light); text-decoration:underline; text-underline-offset:2px; }
        .upload-zone p { position:relative; z-index:1; font-size:13px; color:var(--text-muted); margin-bottom:12px; }
        .upload-formats { position:relative; z-index:1; display:flex; gap:6px; justify-content:center; flex-wrap:wrap; }
        .format-badge { padding:3px 9px; font-size:10px; font-weight:700; font-family:'JetBrains Mono',monospace; background:var(--navy-card); border:1px solid var(--border); border-radius:5px; color:var(--text-secondary); }
        .file-section,.text-section { display:none; }
        .file-section.active,.text-section.active { display:block; }
        .input-group { margin-bottom:16px; }
        .input-group label { display:block; font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:6px; }
        .input-field,.textarea-field { width:100%; padding:10px 14px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text); font-family:inherit; font-size:13px; outline:none; transition:var(--transition); }
        .input-field:focus,.textarea-field:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .textarea-field { min-height:200px; resize:vertical; line-height:1.7; }
        .text-zone { border:2px dashed var(--border); border-radius:var(--radius); padding:0; text-align:center; cursor:text; transition:var(--transition); background:var(--navy-light); position:relative; overflow:hidden; min-height:180px; }
        .text-zone::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse at center,var(--accent-glow),transparent 70%); opacity:0; transition:var(--transition); pointer-events:none; }
        .text-zone:hover,.text-zone.active { border-color:var(--accent); background:var(--navy-card); }
        .text-zone:hover::before,.text-zone.active::before { opacity:1; }
        .text-zone-placeholder { padding:52px 40px; pointer-events:none; transition:opacity 0.2s; }
        .text-zone-placeholder h3 { position:relative; z-index:1; font-size:16px; font-weight:600; margin-bottom:6px; color:var(--white); }
        .text-zone-placeholder h3 span { color:var(--accent-light); text-decoration:underline; text-underline-offset:2px; }
        .text-zone-placeholder p { position:relative; z-index:1; font-size:13px; color:var(--text-muted); margin-bottom:0; }
        .text-zone.has-content .text-zone-placeholder,.text-zone.focused .text-zone-placeholder { display:none; }
        .text-zone-input { position:absolute; inset:0; width:100%; height:100%; min-height:180px; border:none; border-radius:var(--radius); background:transparent; padding:20px; font-size:14px; line-height:1.8; color:var(--text); font-family:inherit; resize:none; outline:none; opacity:0; transition:opacity 0.2s; }
        .text-zone.has-content .text-zone-input,.text-zone.focused .text-zone-input { opacity:1; position:relative; min-height:180px; }
        .text-zone.has-content,.text-zone.focused { border-style:solid; border-color:var(--accent); padding:0; }
        .input-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
        .tag-container { display:flex; flex-wrap:wrap; gap:6px; padding:8px 12px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius-sm); min-height:40px; align-items:center; cursor:text; transition:var(--transition); }
        .tag-container:focus-within { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .tag { display:flex; align-items:center; gap:4px; padding:3px 8px 3px 10px; background:var(--accent-glow); border:1px solid rgba(91,138,245,0.3); border-radius:6px; font-size:12px; font-weight:500; color:var(--accent-light); }
        .tag button { background:none; border:none; color:var(--accent-light); cursor:pointer; font-size:14px; padding:0 2px; opacity:0.6; }
        .tag button:hover { opacity:1; }
        .tag-input { border:none; outline:none; background:none; color:var(--text); font-family:inherit; font-size:13px; flex:1; min-width:80px; }
        .file-list { margin-top:20px; display:flex; flex-direction:column; gap:8px; }
        .file-item { display:flex; align-items:center; gap:12px; padding:12px 16px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius-sm); animation:slideIn 0.3s ease; }
        @keyframes slideIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }
        .file-type-icon { width:38px; height:38px; border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; font-family:'JetBrains Mono',monospace; text-transform:uppercase; flex-shrink:0; }
        .file-type-icon.pdf { background:rgba(239,68,68,0.12); color:#f87171; border:1px solid rgba(239,68,68,0.2); }
        .file-type-icon.txt { background:rgba(96,165,250,0.12); color:#60a5fa; border:1px solid rgba(96,165,250,0.2); }
        .file-type-icon.md { background:rgba(52,211,153,0.12); color:#34d399; border:1px solid rgba(52,211,153,0.2); }
        .file-type-icon.doc { background:rgba(96,165,250,0.12); color:#60a5fa; border:1px solid rgba(96,165,250,0.2); }
        .file-info { flex:1; min-width:0; }
        .file-name { font-size:13px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .file-meta { font-size:11px; color:var(--text-muted); margin-top:2px; }
        .progress-bar { height:3px; background:var(--navy); border-radius:2px; overflow:hidden; max-width:180px; }
        .progress-fill { height:100%; background:var(--accent); border-radius:2px; transition:width 0.3s; }
        .file-status { font-size:11px; font-weight:600; padding:3px 9px; border-radius:5px; white-space:nowrap; }
        .file-status.pending { color:var(--text-muted); background:var(--navy-light); }
        .file-status.uploading { color:var(--accent-light); background:var(--accent-glow); }
        .file-status.analyzing { color:var(--accent-light); background:var(--accent-glow); }
        .file-status.success { color:var(--success); background:var(--success-bg); }
        .file-status.error { color:var(--error); background:var(--error-bg); }
        .file-remove { background:none; border:none; color:var(--text-muted); cursor:pointer; padding:4px; transition:var(--transition); border-radius:4px; }
        .file-remove:hover { color:var(--error); background:var(--error-bg); }
        .actions { margin-top:28px; display:flex; align-items:center; justify-content:space-between; }
        .btn { padding:11px 24px; border-radius:var(--radius-sm); font-size:13px; font-weight:600; font-family:inherit; cursor:pointer; transition:var(--transition); border:none; display:flex; align-items:center; gap:8px; }
        .btn-primary { background:var(--accent); color:white; box-shadow:0 2px 12px rgba(91,138,245,0.3); }
        .btn-primary:hover { background:var(--accent-light); transform:translateY(-1px); box-shadow:0 4px 20px rgba(91,138,245,0.4); }
        .btn-primary:disabled { opacity:0.4; cursor:not-allowed; transform:none; box-shadow:none; }
        .btn-secondary { background:var(--navy-card); color:var(--text-secondary); border:1px solid var(--border); }
        .btn-secondary:hover { background:var(--navy-hover); color:var(--text); }
        .upload-count { font-size:13px; color:var(--text-muted); }
        .doc-table { width:100%; border-collapse:collapse; }
        .doc-table th { text-align:left; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); padding:10px 14px; border-bottom:1px solid var(--border); }
        .doc-table td { padding:12px 14px; font-size:13px; border-bottom:1px solid rgba(37,53,86,0.5); color:var(--text-secondary); }
        .doc-table tr:hover td { background:var(--navy-light); }
        .doc-table .doc-name { color:var(--white); font-weight:500; }
        .status-badge { display:inline-flex; align-items:center; gap:5px; font-size:11px; font-weight:600; }
        .status-badge::before { content:''; width:5px; height:5px; border-radius:50%; background:var(--success); }
        .empty-state { text-align:center; padding:60px 20px; color:var(--text-muted); }
        .empty-state svg { width:48px; height:48px; stroke:var(--border-light); margin-bottom:16px; }
        .empty-state h3 { font-size:16px; color:var(--text-secondary); margin-bottom:6px; }
        .toast-container { position:fixed; bottom:24px; right:24px; z-index:1000; display:flex; flex-direction:column; gap:8px; }
        .toast { padding:12px 18px; border-radius:var(--radius-sm); font-size:13px; font-weight:500; display:flex; align-items:center; gap:8px; animation:toastIn 0.3s ease; box-shadow:0 8px 32px rgba(0,0,0,0.3); border:1px solid var(--border); background:var(--navy-card); }
        .toast.success { border-left:3px solid var(--success); } .toast.error { border-left:3px solid var(--error); } .toast.info { border-left:3px solid var(--accent); }
        @keyframes toastIn { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:translateX(0)} }
        .spinner { width:14px; height:14px; border:2px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation:spin 0.6s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)} }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
        @keyframes fadeSlideIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
        .mb-default-badge { display:inline-block;font-size:10px;font-weight:600;color:var(--accent);background:rgba(139,170,255,0.1);border:1px solid rgba(139,170,255,0.2);padding:2px 8px;border-radius:10px;margin-top:6px;letter-spacing:0.3px;text-transform:uppercase; }
        .footer { position:relative; z-index:1; text-align:center; padding:32px 24px; border-top:1px solid var(--border); font-size:12px; color:var(--text-muted); }
        .footer a { color:var(--accent); text-decoration:none; }

        /* ── Admin Dashboard ───────────────────────────────── */
        .admin-cards { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:32px; }
        .admin-card { padding:24px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); }
        .admin-card-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:8px; }
        .admin-card-value { font-size:28px; font-weight:800; color:var(--white); }
        .task-filter { padding:6px 14px; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:8px; color:rgba(255,255,255,0.4); font-size:12px; cursor:pointer; transition:all 0.15s; }
        .task-filter:hover { background:rgba(255,255,255,0.06); color:rgba(255,255,255,0.6); }
        .task-filter.active { background:rgba(42,127,142,0.12); border-color:rgba(42,127,142,0.3); color:var(--accent); font-weight:600; }
        .task-row { display:flex; align-items:center; gap:12px; padding:12px 16px; background:var(--navy-card); border:1px solid var(--border); border-radius:10px; transition:all 0.15s; }
        .task-row:hover { border-color:rgba(42,127,142,0.3); background:rgba(42,127,142,0.04); }
        .task-row.done { opacity:0.4; }
        .task-check { width:20px; height:20px; border:2px solid rgba(255,255,255,0.15); border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:all 0.15s; }
        .task-check:hover { border-color:var(--accent); }
        .task-check.checked { background:var(--accent); border-color:var(--accent); }
        .task-pri-urgent { border-left:3px solid #ef4444; }
        .task-pri-high { border-left:3px solid #fbbf24; }
        .task-pri-normal { border-left:3px solid rgba(255,255,255,0.1); }
        .task-pri-low { border-left:3px solid rgba(255,255,255,0.04); }
        .admin-card-sub { font-size:12px; color:var(--text-secondary); margin-top:4px; }
        .admin-section-title { font-size:16px; font-weight:700; color:var(--white); margin-bottom:16px; display:flex; align-items:center; gap:10px; }
        .admin-section-title .badge { font-size:11px; font-weight:600; padding:3px 10px; border-radius:20px; background:var(--accent-glow); color:var(--accent-light); border:1px solid rgba(91,138,245,0.2); }
        .user-table { width:100%; border-collapse:collapse; margin-bottom:32px; }
        .user-table th { text-align:left; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); padding:10px 14px; border-bottom:1px solid var(--border); }
        .user-table td { padding:12px 14px; font-size:13px; border-bottom:1px solid rgba(37,53,86,0.5); color:var(--text-secondary); }
        .user-table tr:hover td { background:var(--navy-light); }
        .user-email { color:var(--white); font-weight:500; }
        .user-badge { display:inline-flex; align-items:center; gap:4px; font-size:10px; font-weight:700; padding:3px 8px; border-radius:4px; text-transform:uppercase; letter-spacing:0.3px; }
        .user-badge.admin { background:rgba(251,191,36,0.12); color:var(--warning); border:1px solid rgba(251,191,36,0.2); }
        .user-badge.user { background:var(--navy-light); color:var(--text-muted); border:1px solid var(--border); }
        .user-badge.active { background:var(--success-bg); color:var(--success); border:1px solid rgba(52,211,153,0.2); }
        .user-badge.inactive { background:var(--error-bg); color:var(--error); border:1px solid rgba(248,113,113,0.2); }
        .btn-toggle { padding:5px 12px; font-size:11px; font-weight:600; font-family:inherit; cursor:pointer; border-radius:6px; transition:var(--transition); border:1px solid var(--border); background:var(--navy-light); color:var(--text-secondary); }
        .btn-toggle:hover { background:var(--navy-hover); color:var(--white); border-color:var(--border-light); }
        .btn-toggle.deactivate:hover { color:var(--error); border-color:rgba(248,113,113,0.3); background:var(--error-bg); }
        .btn-toggle.activate:hover { color:var(--success); border-color:rgba(52,211,153,0.3); background:var(--success-bg); }
        .settings-row { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius-sm); margin-bottom:10px; }
        .settings-label { font-size:13px; color:var(--text); font-weight:500; }
        .settings-value { font-size:13px; color:var(--accent-light); font-weight:600; font-family:'JetBrains Mono',monospace; }
        .nav-link.admin-link { color:var(--warning); }
        .comp-cat-tab { display:inline-flex;align-items:center;gap:6px;padding:7px 14px;font-size:12px;font-weight:500;color:rgba(255,255,255,0.4);background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.15s; }
        .comp-cat-tab:hover { color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.05); }
        .comp-cat-tab.active { color:white;background:rgba(42,127,142,0.15);border-color:rgba(42,127,142,0.3); }
        .comp-cat-count { font-size:10px;padding:1px 6px;border-radius:6px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.3); }
        .comp-cat-tab.active .comp-cat-count { background:rgba(42,127,142,0.2);color:rgba(255,255,255,0.6); }
        .comp-card:hover { transform:translateY(-2px);border-color:rgba(42,127,142,0.3) !important;background:rgba(255,255,255,0.03) !important; }
        .comp-card.active { border-color:rgba(42,127,142,0.5) !important;background:rgba(42,127,142,0.08) !important;box-shadow:0 0 20px rgba(42,127,142,0.1); }
        .prj-mode-card:hover { transform:translateY(-2px);border-color:rgba(42,127,142,0.3) !important; }
        .prj-mode-card.active { border-color:rgba(42,127,142,0.5) !important;background:rgba(42,127,142,0.08) !important;box-shadow:0 0 20px rgba(42,127,142,0.1); }
        .prj-tab { padding:8px 14px;font-size:12px;color:rgba(255,255,255,0.4);cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;transition:all 0.15s;flex-shrink:0; }
        .prj-tab:hover { color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.02);border-radius:6px 6px 0 0; }
        .prj-tab.active { color:var(--accent-light);border-bottom-color:var(--accent);font-weight:600; }
        .prj-tab-content { display:none; }
        .prj-tab-content.active { display:block; }
        .prj-main-tab-content { display:none; }
        .prj-main-tab-content.active { display:block; }
        .prj-inhalt-card:hover { border-color:rgba(42,127,142,0.4) !important; background:rgba(42,127,142,0.04) !important; }
        .nav-link.admin-link:hover,.nav-link.admin-link.active { color:var(--warning); background:rgba(251,191,36,0.08); }

        /* ── Password Modal ──────────────────────────────── */
        .modal-overlay { position:fixed; inset:0; z-index:9999; background:rgba(10,22,40,0.85); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; opacity:0; visibility:hidden; transition:all 0.3s ease; }
        .modal-overlay.visible { opacity:1; visibility:visible; }
        .modal { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:36px; width:100%; max-width:400px; }
        .modal h3 { font-size:18px; font-weight:700; color:var(--white); margin-bottom:20px; }
        .modal-input { width:100%; padding:12px 14px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text); font-family:inherit; font-size:14px; outline:none; transition:var(--transition); margin-bottom:12px; }
        .modal-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:8px; }
        .modal-msg { font-size:13px; padding:10px 14px; border-radius:var(--radius-sm); margin-bottom:12px; display:none; }
        .modal-msg.error { display:block; color:var(--error); background:var(--error-bg); border:1px solid rgba(248,113,113,0.15); }
        .modal-msg.success { display:block; color:var(--success); background:var(--success-bg); border:1px solid rgba(52,211,153,0.15); }
        .nav-user { cursor:pointer; transition:var(--transition); }
        .nav-user:hover { border-color:var(--accent); color:var(--text); }
        /* ── Profile ──────────────────────── */
        .profile-grid { display:grid; grid-template-columns:280px 1fr; gap:32px; }
        .profile-card { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:32px; text-align:center; }
        .profile-avatar-wrap { position:relative; width:120px; height:120px; margin:0 auto 20px; }
        .profile-avatar { width:120px; height:120px; border-radius:50%; object-fit:cover; border:3px solid var(--border); background:var(--navy-mid); display:flex; align-items:center; justify-content:center; font-size:40px; font-weight:700; color:var(--accent); overflow:hidden; }
        .profile-avatar img { width:100%; height:100%; object-fit:cover; }
        .profile-avatar-edit { position:absolute; bottom:4px; right:4px; width:32px; height:32px; border-radius:50%; background:var(--accent); border:2px solid var(--navy-card); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:var(--transition); }
        .profile-avatar-edit:hover { transform:scale(1.1); }
        .profile-avatar-edit svg { width:14px; height:14px; stroke:white; }
        .profile-name { font-size:20px; font-weight:700; color:var(--white); margin-bottom:4px; }
        .profile-position { font-size:13px; color:var(--text-secondary); margin-bottom:16px; }
        .profile-meta { display:flex; flex-direction:column; gap:8px; text-align:left; padding-top:16px; border-top:1px solid var(--border); }
        .profile-meta-item { display:flex; align-items:center; gap:10px; font-size:13px; color:var(--text-secondary); }
        .profile-meta-item svg { width:16px; height:16px; stroke:var(--text-muted); flex-shrink:0; }
        .profile-form { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:32px; }
        .profile-form h3 { font-size:16px; font-weight:700; color:var(--white); margin-bottom:20px; }
        .profile-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
        .profile-field { display:flex; flex-direction:column; gap:6px; }
        .profile-field.full { grid-column:1/-1; }
        .profile-field label { font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.5px; }
        .profile-field input, .profile-field textarea { background:var(--navy-mid); border:1px solid var(--border); border-radius:var(--radius-sm); padding:10px 14px; color:var(--text); font-family:inherit; font-size:14px; transition:var(--transition); }
        .profile-field input:focus, .profile-field textarea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .profile-field textarea { resize:vertical; min-height:80px; }
        .profile-tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
        .profile-tag { padding:4px 12px; background:var(--accent-glow); border:1px solid rgba(91,138,245,0.2); border-radius:20px; font-size:12px; color:var(--accent-light); display:flex; align-items:center; gap:4px; }
        .profile-tag .remove { cursor:pointer; opacity:0.6; } .profile-tag .remove:hover { opacity:1; }
        .profile-actions { display:flex; gap:12px; justify-content:flex-end; margin-top:24px; padding-top:20px; border-top:1px solid var(--border); }
        .linkedin-btn { display:inline-flex; align-items:center; gap:8px; padding:10px 20px; background:#0a66c2; color:white; border:none; border-radius:var(--radius-sm); font-family:inherit; font-size:13px; font-weight:600; cursor:pointer; transition:var(--transition); }
        .linkedin-btn:hover { background:#004182; }
        .linkedin-btn.connected { background:var(--navy-mid); border:1px solid var(--border); color:var(--text-secondary); }
        .linkedin-section { margin-top:20px; padding-top:16px; border-top:1px solid var(--border); }
        /* ── Chat ──────────────────────── */
        .chat-container { max-width:900px; margin:0 auto; display:flex; flex-direction:column; height:calc(100vh - 72px); height:calc(100dvh - 72px); padding:0 20px; }
        .chat-header { padding:24px 0 16px; text-align:center; flex-shrink:0; }
        .chat-header h2 { font-size:22px; font-weight:800; color:var(--white); margin-bottom:4px; }
        .chat-header h2 span { background:linear-gradient(135deg,var(--accent),var(--accent-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .chat-header p { font-size:13px; color:var(--text-secondary); }
        .chat-messages { flex:3 1 0%; overflow-y:auto; padding:8px 0 16px; display:flex; flex-direction:column; gap:16px; scroll-behavior:smooth; min-height:80px; }
        .chat-messages::-webkit-scrollbar { width:6px; } .chat-messages::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
        .chat-msg { display:flex; gap:12px; max-width:85%; animation:msgIn 0.3s ease; }
        @keyframes msgIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
        .chat-msg.user { align-self:flex-end; flex-direction:row-reverse; }
        .chat-msg-avatar { width:32px; height:32px; border-radius:50%; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; }
        .chat-msg.user .chat-msg-avatar { background:var(--accent-glow); color:var(--accent); border:1px solid rgba(91,138,245,0.3); }
        .chat-msg.assistant .chat-msg-avatar { background:linear-gradient(135deg,#1a2a47,#162244); color:var(--accent-light); border:1px solid var(--border); }
        .chat-msg-body { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:14px 18px; font-size:14px; line-height:1.7; color:var(--text); }
        .chat-msg.user .chat-msg-body { background:var(--accent-glow-strong); border-color:rgba(91,138,245,0.25); }
        .chat-msg-body p { margin-bottom:8px; } .chat-msg-body p:last-child { margin-bottom:0; }
        .chat-msg-body code { background:var(--navy-mid); padding:1px 6px; border-radius:4px; font-family:'JetBrains Mono',monospace; font-size:13px; }
        .chat-msg-body strong { color:var(--white); font-weight:600; }
        .chat-msg-body ul, .chat-msg-body ol { margin:8px 0; padding-left:20px; } .chat-msg-body li { margin:4px 0; }
        .chat-sources { display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; padding-top:8px; border-top:1px solid var(--border); }
        .chat-source-tag { font-size:11px; padding:3px 10px; background:var(--navy-mid); border:1px solid var(--border); border-radius:12px; color:var(--text-secondary); }
        .chat-input-area { flex:0 0 auto; padding:8px 0 12px; display:flex; flex-direction:column; }
        .chat-input-wrap { display:flex; gap:10px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:8px 8px 8px 14px; transition:var(--transition); align-items:flex-end; }
        .chat-input-wrap:focus-within { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .chat-input { flex:1; background:none; border:none; color:var(--text); font-family:inherit; font-size:16px; outline:none; resize:none; line-height:1.5; min-height:0; }
        .chat-input::placeholder { color:var(--text-muted); }
        .chat-input-wrap .chat-send-btn { align-self:flex-end; }
        .chat-input-wrap button { align-self:flex-end; }
        @media (max-width:1024px) {
            .chat-container { padding:0 12px; }
            .chat-header { padding:12px 0 8px; }
            .chat-header h2 { font-size:18px; }
            .chat-header p { display:none; }
            .chat-input-area { padding:6px 0 8px; }
            .footer { display:none; }
        }
        /* ── Keyboard open: ALL devices ── */
        .keyboard-open .footer { display:none !important; }
        .keyboard-open #prjChatIndicator { display:none; }
        .keyboard-open .chat-welcome { display:none; }
        .keyboard-open .chat-header { display:none; }

        /* ── Keyboard open: Tablet (iPad etc.) ── */
        @media (min-width:601px) {
            .keyboard-open .chat-messages { flex:2 1 0%; min-height:120px; max-height:40vh; }
            .keyboard-open .chat-input-area { flex:1 0 auto; }
            .keyboard-open .chat-input { min-height:60px; max-height:30vh; }
            .keyboard-open .chat-container { height:100dvh; height:100vh; }
            .keyboard-open .nav { height:48px; padding:0 20px; }
            .keyboard-open .nav-title { font-size:13px; }
        }

        /* ── Keyboard open: Phone only ── */
        @media (max-width:600px) {
            .keyboard-open .chat-input-area { padding:4px 0 4px; flex:1; display:flex; flex-direction:column; }
            .keyboard-open .chat-input-wrap { flex:1; align-items:stretch; }
            .keyboard-open .chat-messages { display:none; }
            .keyboard-open .chat-input { min-height:120px; max-height:50vh; flex:1; }
            .keyboard-open #mainChatAttachments { display:none !important; }
            .keyboard-open .nav { display:none; }
            .keyboard-open .chat-container { height:100dvh; height:100vh; padding-top:8px; }
        }
        .chat-send-btn { width:42px; height:42px; border-radius:12px; background:var(--accent); border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:var(--transition); flex-shrink:0; }
        .chat-send-btn:hover { background:var(--accent-light); transform:scale(1.05); }
        .chat-send-btn:disabled { opacity:0.4; cursor:not-allowed; transform:none; }
        .chat-send-btn svg { width:18px; height:18px; stroke:white; }
        .chat-typing { display:flex; gap:4px; padding:8px 0; }
        .chat-typing span { width:8px; height:8px; border-radius:50%; background:var(--text-muted); animation:typing 1.4s ease-in-out infinite; }
        .chat-typing span:nth-child(2) { animation-delay:0.2s; } .chat-typing span:nth-child(3) { animation-delay:0.4s; }
        @keyframes typing { 0%,60%,100% { transform:translateY(0); opacity:0.4; } 30% { transform:translateY(-6px); opacity:1; } }
        .chat-welcome { text-align:center; padding:60px 20px; }
        .chat-welcome-icon { width:80px; height:80px; border-radius:50%; background:var(--accent-glow); border:1px solid rgba(91,138,245,0.2); display:flex; align-items:center; justify-content:center; margin:0 auto 24px; }
        .chat-welcome-icon img { width:50px; height:50px; border-radius:50%; object-fit:cover; }
        .chat-welcome h3 { font-size:20px; font-weight:700; color:var(--white); margin-bottom:8px; }
        .chat-welcome p { font-size:14px; color:var(--text-secondary); max-width:500px; margin:0 auto 28px; line-height:1.6; }
        .chat-suggestions { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
        .chat-suggestion { padding:8px 16px; background:var(--navy-card); border:1px solid var(--border); border-radius:20px; font-size:13px; color:var(--text-secondary); cursor:pointer; transition:var(--transition); font-family:inherit; }
        .chat-suggestion:hover { border-color:var(--accent); color:var(--accent-light); background:var(--accent-glow); }

        /* ═══════ MODEL BUILDING ═══════ */
        .mb-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:32px; flex-wrap:wrap; gap:16px; }
        .mb-header h2 { font-size:24px; font-weight:700; color:var(--white); margin:0; }
        .mb-header p { font-size:14px; color:var(--text-secondary); margin:4px 0 0; }
        .mb-progress { display:flex; gap:4px; padding:16px 0; margin-bottom:28px; overflow-x:auto; }
        .mb-step-dot { display:flex; flex-direction:column; align-items:center; gap:6px; min-width:70px; cursor:pointer; }
        .mb-step-num { width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; border:2px solid var(--border); color:var(--text-muted); background:var(--navy-light); transition:var(--transition); }
        .mb-step-dot.active .mb-step-num { border-color:var(--accent); color:var(--white); background:var(--accent); box-shadow:0 0 16px var(--accent-glow); }
        .mb-step-dot.completed .mb-step-num { border-color:var(--success); color:var(--white); background:var(--success); }
        .mb-step-dot.completed .mb-step-num::after { content:'✓'; }
        .mb-step-label { font-size:10px; color:var(--text-muted); text-align:center; white-space:nowrap; transition:var(--transition); }
        .mb-step-dot.active .mb-step-label { color:var(--accent-light); font-weight:600; }
        .mb-step-dot.completed .mb-step-label { color:var(--success); }
        .mb-step-line { flex:1; height:2px; background:var(--border); align-self:center; margin:0 -8px; margin-bottom:22px; }
        .mb-step-line.completed { background:var(--success); }

        .mb-panel { display:none; animation:fadeIn 0.3s ease; }
        .mb-panel.active { display:block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

        .mb-step-title { font-size:20px; font-weight:700; color:var(--white); margin-bottom:4px; }
        .mb-step-desc { font-size:14px; color:var(--text-secondary); margin-bottom:24px; line-height:1.6; }

        .mb-choices { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:24px; }
        .mb-choice { padding:20px; background:var(--navy-light); border:2px solid var(--border); border-radius:var(--radius); cursor:pointer; transition:var(--transition); position:relative; }
        .mb-choice:hover { border-color:var(--border-light); background:var(--navy-card); transform:translateY(-2px); }
        .mb-choice.selected { border-color:var(--accent); background:rgba(91,138,245,0.06); box-shadow:0 0 0 3px var(--accent-glow); }
        .mb-choice-num { position:absolute; top:12px; right:14px; width:24px; height:24px; border-radius:50%; background:var(--navy-mid); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:var(--text-muted); }
        .mb-choice.selected .mb-choice-num { background:var(--accent); border-color:var(--accent); color:var(--white); }
        .mb-choice-icon { font-size:24px; margin-bottom:10px; }
        .mb-choice-title { font-size:15px; font-weight:700; color:var(--white); margin-bottom:6px; }
        .mb-choice-desc { font-size:12px; color:var(--text-secondary); line-height:1.5; }
        .mb-choice-meta { font-size:11px; color:var(--text-muted); margin-top:8px; padding-top:8px; border-top:1px solid var(--border); }
        .mb-choice.custom-choice { border-style:dashed; }

        .mb-actions { display:flex; gap:12px; margin-top:24px; }
        .mb-btn { padding:12px 28px; border-radius:var(--radius); font-size:14px; font-weight:600; cursor:pointer; transition:var(--transition); border:none; font-family:inherit; }
        .mb-btn-primary { background:var(--accent); color:var(--white); }
        .mb-btn-primary:hover { background:var(--accent-light); box-shadow:0 4px 16px rgba(91,138,245,0.3); }
        .mb-btn-primary:disabled { opacity:0.4; cursor:not-allowed; }
        .mb-btn-secondary { background:var(--navy-light); color:var(--text-secondary); border:1px solid var(--border); }
        .mb-btn-secondary:hover { color:var(--white); border-color:var(--border-light); }
        .mb-btn-back { background:none; color:var(--text-muted); border:1px solid var(--border); }

        .mb-input { width:100%; padding:12px 16px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius); color:var(--text); font-family:inherit; font-size:14px; outline:none; transition:var(--transition); margin-bottom:12px; }
        .mb-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .mb-textarea { min-height:80px; resize:vertical; }
        .mb-label { font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:6px; display:block; }

        .mb-info-box { padding:16px 20px; background:rgba(91,138,245,0.06); border:1px solid rgba(91,138,245,0.15); border-radius:var(--radius); margin-bottom:20px; }
        .mb-info-box p { font-size:13px; color:var(--text-secondary); line-height:1.6; margin:0; }
        .mb-info-box strong { color:var(--accent-light); }
        .mb-inline-progress { margin-top:20px;padding:20px;background:rgba(139,170,255,0.04);border:1px solid rgba(139,170,255,0.1);border-radius:var(--radius); }
        .mb-prog-header { display:flex;align-items:center;gap:12px;margin-bottom:14px; }
        .mb-prog-spinner { width:18px;height:18px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0; }
        .mb-prog-bar-bg { height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;margin-bottom:8px; }
        .mb-prog-bar { height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#818cf8);border-radius:3px;transition:width 0.6s ease; }
        .mb-prog-meta { display:flex;justify-content:space-between;font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:12px; }
        .mb-prog-stages { display:flex;flex-direction:column;gap:4px; }
        .mb-prog-stage { display:flex;align-items:center;gap:8px;font-size:12px;color:rgba(255,255,255,0.35);transition:all 0.3s; }
        .mb-prog-stage.active { color:rgba(255,255,255,0.9); }
        .mb-prog-stage.done { color:rgba(34,197,94,0.8); }
        .mb-prog-dot { width:16px;height:16px;border-radius:50%;border:1.5px solid rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0; }
        .mb-prog-stage.active .mb-prog-dot { border-color:var(--accent);background:rgba(139,170,255,0.15); }
        .mb-prog-stage.done .mb-prog-dot { border-color:#22c55e;background:rgba(34,197,94,0.15); }

        .mb-registry { display:grid; gap:12px; margin-top:20px; }
        .mb-model-card { padding:16px 20px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius); display:flex; align-items:center; gap:16px; transition:var(--transition); cursor:pointer; }
        .mb-model-card:hover { border-color:var(--border-light); background:var(--navy-card); }
        .mb-model-id { font-size:11px; font-weight:700; color:var(--accent); background:var(--accent-glow); padding:4px 10px; border-radius:12px; white-space:nowrap; }
        .mb-model-info { flex:1; }
        .mb-model-name { font-size:14px; font-weight:600; color:var(--white); }
        .mb-model-meta { font-size:12px; color:var(--text-muted); margin-top:2px; }
        .mb-model-version { font-size:11px; color:var(--text-muted); background:var(--navy-mid); padding:3px 8px; border-radius:8px; }

        .mb-summary { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:24px; margin-bottom:20px; }
        .mb-summary-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:13px; }
        .mb-summary-row:last-child { border-bottom:none; }
        .mb-summary-label { color:var(--text-muted); }
        .mb-summary-value { color:var(--white); font-weight:600; }

        .mb-mode-cards { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:28px; }
        .mb-mode-card { padding:20px 16px; background:var(--navy-light); border:2px solid var(--border); border-radius:var(--radius); cursor:pointer; text-align:center; transition:var(--transition); }
        .mb-mode-card:hover { border-color:var(--border-light); transform:translateY(-2px); }
        .mb-mode-card.selected { border-color:var(--accent); background:rgba(91,138,245,0.06); }
        .mb-mode-icon { font-size:28px; margin-bottom:10px; }
        .mb-mode-name { font-size:14px; font-weight:700; color:var(--white); margin-bottom:4px; }
        .mb-mode-time { font-size:11px; color:var(--accent-light); margin-bottom:6px; }
        .mb-mode-desc { font-size:11px; color:var(--text-muted); line-height:1.4; }

        .nav-hamburger { display:none; width:36px; height:36px; align-items:center; justify-content:center; background:none; border:1px solid var(--border); border-radius:8px; cursor:pointer; color:var(--text-secondary); transition:var(--transition); }
        .nav-hamburger:hover { border-color:var(--border-light); color:var(--white); }
        .nav-hamburger svg { width:18px; height:18px; }
        @media (max-width:768px) { .mb-choices { grid-template-columns:1fr; } .mb-mode-cards { grid-template-columns:1fr 1fr; } #brfTypeCards { grid-template-columns:1fr 1fr !important; } #brfStep2Content .mb-choice { padding:8px 10px !important; } #caConfirmContent > div:first-child { grid-template-columns:1fr !important; } }
        @media (max-width:768px) { .profile-grid { grid-template-columns:1fr; } .profile-row { grid-template-columns:1fr; } }
        @media (max-width:640px) {
            .nav { padding:0 10px; flex-wrap:wrap; height:auto; min-height:48px; }
            .nav-brand { gap:8px; }
            .nav-brand .nav-title { font-size:15px; }
            .nav-brand .nav-logo-img { width:28px; height:28px; }
            .nav-links { display:none; width:100%; order:3; flex-direction:column; padding:8px 0 12px; border-top:1px solid var(--border); }
            .nav-links.mobile-open { display:flex; }
            .nav-links .nav-link { padding:12px 16px; font-size:14px; border-radius:8px; }
            .nav-links .nav-dropdown { width:100%; }
            .nav-links .nav-dropdown-trigger { width:100%; padding:12px 16px; font-size:14px; justify-content:flex-start; }
            .nav-links .nav-dropdown-menu { position:static; background:rgba(15,30,55,0.6); border:none; box-shadow:none; margin:0; padding:0 0 0 20px; border-radius:0; }
            .nav-links .nav-dropdown-item { padding:10px 16px; font-size:13px; }
            .nav-links .nav-dropdown.open .nav-dropdown-menu { display:flex; flex-direction:column; }
            .nav-right { order:2; gap:4px; margin-left:auto; }
            .nav-right .nav-status { display:none; }
            .nav-right .nav-logout { display:none; }
            .nav-right #appVersion { display:none; }
            .nav-right .nav-user { font-size:11px; padding:4px 10px; max-width:80px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
            .nav-right .admin-link { padding:4px; }
            .nav-right .admin-link svg { width:13px; height:13px; }
            .nav-hamburger { display:flex; order:1; margin-left:auto; margin-right:4px; width:32px; height:32px; }
            .hero { padding:48px 16px 40px; } .hero h1 { font-size:28px; }
            .hero-stats { gap:20px; } .container { padding:24px 16px 60px; } .db-selector { grid-template-columns:1fr; }
            .input-row { grid-template-columns:1fr; } .upload-zone { padding:36px 20px; } .actions { flex-direction:column; gap:12px; }
            .auth-card { padding:36px 24px; } .auth-title { font-size:24px; }
            #caPsiCards { grid-template-columns:repeat(2,1fr) !important; }
            .mb-mode-cards { grid-template-columns:1fr !important; }
            .mb-choices { grid-template-columns:1fr !important; }
        }
        /* ── Universities ─────────────────────── */
        .uni-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:16px; }
        .uni-card { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:20px; cursor:pointer; transition:var(--transition); position:relative; overflow:hidden; }
        .uni-card:hover { border-color:var(--accent); transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,0.3); }
        .uni-card-icon { font-size:28px; margin-bottom:12px; }
        .uni-card-title { font-size:16px; font-weight:700; color:var(--white); margin-bottom:4px; }
        .uni-card-sub { font-size:13px; color:var(--text-secondary); margin-bottom:12px; line-height:1.5; }
        .uni-card-stats { display:flex; gap:12px; flex-wrap:wrap; }
        .uni-stat { font-size:12px; color:var(--text-muted); display:flex; align-items:center; gap:4px; }
        .uni-stat b { color:var(--accent-light); font-weight:600; }
        .uni-back { display:inline-flex; align-items:center; gap:6px; padding:6px 14px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-secondary); font-size:13px; cursor:pointer; transition:var(--transition); border:none; font-family:inherit; }
        .uni-back:hover { color:var(--accent-light); }
        .uni-paper { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius-sm); padding:16px; margin-bottom:8px; transition:var(--transition); }
        .uni-paper:hover { border-color:var(--border-light); }
        .uni-paper-title { font-size:14px; font-weight:600; color:var(--text); margin-bottom:6px; line-height:1.5; }
        .uni-paper-meta { font-size:12px; color:var(--text-muted); display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
        .uni-paper-actions { display:flex; gap:8px; margin-top:10px; }
        .uni-btn-sm { padding:5px 12px; border-radius:6px; font-size:11px; font-weight:600; cursor:pointer; transition:var(--transition); border:1px solid; font-family:inherit; }
        .uni-btn-pdf { background:rgba(52,211,153,0.1); border-color:rgba(52,211,153,0.3); color:var(--success); text-decoration:none; display:inline-flex; align-items:center; gap:4px; }
        .uni-btn-pdf:hover { background:rgba(52,211,153,0.2); }
        .uni-btn-import { background:var(--accent-glow); border-color:rgba(91,138,245,0.3); color:var(--accent-light); }
        .uni-btn-import:hover { background:var(--accent-glow-strong); }
        .uni-btn-import.imported { background:rgba(52,211,153,0.1); border-color:rgba(52,211,153,0.3); color:var(--success); pointer-events:none; }
        .uni-prof-header { display:flex; align-items:center; gap:16px; margin-bottom:24px; flex-wrap:wrap; }
        .uni-prof-avatar { width:56px; height:56px; border-radius:50%; background:var(--navy-mid); border:2px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:700; color:var(--accent); flex-shrink:0; }
        .uni-prof-info h3 { font-size:20px; font-weight:700; color:var(--white); }
        .uni-prof-info p { font-size:13px; color:var(--text-secondary); }
        .uni-badge { display:inline-block; padding:3px 10px; border-radius:20px; font-size:11px; font-weight:600; background:var(--accent-glow); color:var(--accent-light); border:1px solid rgba(91,138,245,0.2); }
    </style>
</head>
<body>

    <!-- ═══════ AUTH OVERLAY ═══════ -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-card">
            <img src="/logo.jpeg" alt="BEATRIX" class="auth-logo">
            <h1 class="auth-title">BEATRIX <span>Lab</span></h1>
            <p class="auth-subtitle">Strategic Intelligence Suite</p>

            <!-- LOGIN PANEL -->
            <div class="auth-panel active" id="loginPanel">
                <div class="auth-form">
                    <div class="auth-error" id="loginError"></div>
                    <div class="auth-input-wrapper">
                        <input type="email" class="auth-input" id="loginEmail" placeholder="E-Mail-Adresse" autocomplete="email">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    </div>
                    <div class="auth-input-wrapper">
                        <input type="password" class="auth-input" id="loginPassword" placeholder="Passwort" autocomplete="current-password">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <button class="auth-btn" id="loginBtn" onclick="doLogin()">Anmelden</button>
                    <div style="text-align:center;margin-top:10px"><a onclick="showAuthPanel('forgot')" style="font-size:13px;color:var(--accent);cursor:pointer">Passwort vergessen?</a></div>
                </div>
                <div class="auth-switch">Noch kein Konto? <a onclick="showAuthPanel('register')">Jetzt registrieren</a></div>
            </div>

            <!-- REGISTER PANEL -->
            <div class="auth-panel" id="registerPanel">
                <div class="auth-form">
                    <div class="auth-error" id="registerError"></div>
                    <div class="auth-success" id="registerSuccess"></div>
                    <div class="auth-input-wrapper">
                        <input type="text" class="auth-input" id="regName" placeholder="Name (optional)" autocomplete="name">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </div>
                    <div class="auth-input-wrapper">
                        <input type="email" class="auth-input" id="regEmail" placeholder="E-Mail-Adresse" autocomplete="email">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    </div>
                    <div class="auth-input-wrapper">
                        <input type="password" class="auth-input" id="regPassword" placeholder="Passwort (mind. 6 Zeichen)" autocomplete="new-password">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <button class="auth-btn" id="registerBtn" onclick="doRegister()">Registrieren</button>
                    <div id="resendArea" style="display:none;margin-top:12px;text-align:center;font-size:13px;color:var(--text-muted)">
                        Keine E-Mail erhalten? <a onclick="resendVerification()" style="color:var(--accent);cursor:pointer;font-weight:600">Erneut senden</a>
                    </div>
                </div>
                <div class="auth-switch">Bereits registriert? <a onclick="showAuthPanel('login')">Anmelden</a></div>
            </div>

            <!-- FORGOT PASSWORD PANEL -->
            <div class="auth-panel" id="forgotPanel">
                <div class="auth-form">
                    <p style="font-size:14px;color:var(--text-muted);margin-bottom:16px;text-align:center">Gib deine E-Mail-Adresse ein und wir senden dir einen Link zum Zurücksetzen deines Passworts.</p>
                    <div class="auth-error" id="forgotError"></div>
                    <div class="auth-success" id="forgotSuccess" style="display:none;padding:12px;background:var(--success-bg);border:1px solid rgba(52,211,153,0.15);border-radius:var(--radius-sm);color:var(--success);font-size:13px;margin-bottom:12px"></div>
                    <div class="auth-input-wrapper">
                        <input type="email" class="auth-input" id="forgotEmail" placeholder="E-Mail-Adresse" autocomplete="email">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    </div>
                    <button class="auth-btn" id="forgotBtn" onclick="doForgotPassword()">Reset-Link senden</button>
                </div>
                <div class="auth-switch">Zurück zur <a onclick="showAuthPanel('login')">Anmeldung</a></div>
            </div>

            <div class="auth-footer"><a href="https://fehradvice.com" target="_blank">FehrAdvice & Partners AG</a> · Zürich</div>
        </div>
    </div>

    <!-- ═══════ MAIN APP ═══════ -->
    <nav class="nav">
        <a href="#" class="nav-brand" onclick="showSection('hero')"><img src="/logo.jpeg" alt="BEATRIX" class="nav-logo-img"><span class="nav-title">BEATRIX</span></a>
        <button class="nav-hamburger" id="navHamburger" onclick="toggleMobileNav()" aria-label="Menu">
            <svg id="hamburgerIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <div class="nav-links">
            <a href="#" class="nav-link active" data-section="chat" onclick="showSection('chat',this)">💬 Fragen</a>
            <a href="#" class="nav-link" id="navTopProjects" data-section="myprojects" onclick="showSection('myprojects',this)" style="display:none">📋 Projekte</a>
            <div class="nav-dropdown" id="navDropBehavioral">
                <button class="nav-dropdown-trigger" onclick="toggleDropdown('navDropBehavioral')">
                    🧠 Behavioral Design <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="nav-dropdown-menu">
                    <div class="nav-dropdown-header">Einstieg</div>
                    <a class="nav-dropdown-item" data-section="briefing" onclick="navDropClick('briefing',this)">
                        📋 Briefing
                    </a>
                    <div class="nav-dropdown-divider"></div>
                    <div class="nav-dropdown-header">Verstehen</div>
                    <a class="nav-dropdown-item" id="navDropContext" data-section="context" onclick="navDropClick('context',this)">
                        🔬 Kontext-Analyse
                    </a>
                    <a class="nav-dropdown-item" data-section="segments" onclick="navDropClick('segments',this)">
                        👥 Segment-Analyse
                    </a>
                    <a class="nav-dropdown-item" data-section="journey" onclick="navDropClick('journey',this)">
                        🗺️ Behavioral Journey
                    </a>
                    <div class="nav-dropdown-divider"></div>
                    <div class="nav-dropdown-header">Gestalten</div>
                    <a class="nav-dropdown-item" data-section="nutzen" onclick="navDropClick('nutzen',this)">
                        💎 Nutzen & Anreize
                    </a>
                    <a class="nav-dropdown-item" data-section="architektur" onclick="navDropClick('architektur',this)">
                        ⚖️ Entscheidungsarchitektur
                    </a>
                    <a class="nav-dropdown-item" data-section="model" onclick="navDropClick('model',this)">
                        🏗️ Modell-Building
                    </a>
                    <div class="nav-dropdown-divider"></div>
                    <div class="nav-dropdown-header">Messen</div>
                    <a class="nav-dropdown-item" data-section="audit" onclick="navDropClick('audit',this)">
                        📊 Behavioral Audit
                    </a>
                    <a class="nav-dropdown-item" data-section="wirkung" onclick="navDropClick('wirkung',this)">
                        📈 Wirkungsmessung
                    </a>
                    <div class="nav-dropdown-divider"></div>
                    <div class="nav-dropdown-header">Prüfen</div>
                    <a class="nav-dropdown-item" data-section="evidenz" onclick="navDropClick('evidenz',this)">
                        🧪 Evidenz-Check
                    </a>
                </div>
            </div>
            <div class="nav-dropdown" id="navDropWissen">
                <button class="nav-dropdown-trigger" onclick="toggleDropdown('navDropWissen')">
                    📚 Wissen <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="nav-dropdown-menu">
                    <a class="nav-dropdown-item" data-section="upload" onclick="navDropClick('upload',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        Upload
                    </a>
                    <a class="nav-dropdown-item" data-section="documents" onclick="navDropClick('documents',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Dokumente
                    </a>
                    <a class="nav-dropdown-item" data-section="uploadpriority" onclick="navDropClick('uploadpriority',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/><path d="M12 11v6"/><path d="M9 14l3-3 3 3"/></svg>
                        Upload Priority
                    </a>
                    <a class="nav-dropdown-item" data-section="paperfinder" onclick="navDropClick('paperfinder',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/><path d="M11 8v6"/><path d="M8 11h6"/></svg>
                        Paper Finder
                    </a>
                    <a class="nav-dropdown-item" data-section="universities" onclick="navDropClick('universities',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 22h20"/><path d="M6 18V7"/><path d="M18 18V7"/><path d="M2 7l10-5 10 5"/><path d="M10 11h4v7h-4z"/></svg>
                        Universitäten
                    </a>
                </div>
            </div>
            <div class="nav-dropdown" id="navDropBusiness" style="display:none">
                <button class="nav-dropdown-trigger" onclick="toggleDropdown('navDropBusiness')">
                    📊 Business <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="nav-dropdown-menu">
                    <a class="nav-dropdown-item" id="navDropMyProjects" data-section="myprojects" onclick="navDropClick('myprojects',this)" style="display:none">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                        Kundenprojekte
                    </a>
                    <a class="nav-dropdown-item" id="navDropLeads" data-section="leads" onclick="navDropClick('leads',this)" style="display:none">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        CRM
                    </a>
                    <a class="nav-dropdown-item" id="navDropCompanies" data-section="companies" onclick="navDropClick('companies',this)" style="display:none">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>
                        Firmen
                    </a>
                    <a class="nav-dropdown-item" id="navDropProjects" data-section="projects" onclick="navDropClick('projects',this)" style="display:none">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                        Alle Projekte
                    </a>
                    <a class="nav-dropdown-item" id="navDropTasks" data-section="tasks" onclick="navDropClick('tasks',this)" style="display:none">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        Tasks
                    </a>
                </div>
            </div>
        </div>
        <div class="nav-right">
            <div class="nav-status"><span class="dot"></span> Online</div>
            <span style="font-size:10px;color:rgba(255,255,255,0.15);margin-left:4px" id="appVersion">v3.17</span>
            <a href="#" class="nav-link admin-link" data-section="admin" id="navAdmin" onclick="showSection('admin',this)" style="display:none" title="Admin">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </a>
            <span class="nav-user" id="navUser" onclick="showSection('profile')" title="Profil"></span>
            <button class="nav-logout" onclick="doLogout()">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                Abmelden
            </button>
        </div>
    </nav>

    <section class="hero" id="hero-section" style="display:none">
        <img src="/logo.jpeg" alt="BEATRIX Logo" class="hero-logo">
        <h1>BEATRIX <span>Intelligence Suite</span></h1>
        <p class="subtitle">Knowledge Base für Behavioral Economics. Lade Dokumente, Axiome und Research Papers in die BEATRIX-Datenbank.</p>
        <div class="hero-stats">
            <div class="hero-stat"><div class="num" id="statDocs">–</div><div class="label">Dokumente</div></div>
            <div class="hero-stat"><div class="num" id="statKB">–</div><div class="label">Knowledge Base</div></div>
            <div class="hero-stat"><div class="num" id="statAxioms">–</div><div class="label">BCM Axiome</div></div>
        </div>
    </section>

    <!-- ═══════ CHAT SECTION ═══════ -->
    <section class="section active" id="chat-section">
        <div class="chat-container">
            <div class="chat-header">
                <h2>Frag <span>BEATRIX</span></h2>
                <p>Deine Fragen zu Behavioral Economics, BCM und der Knowledge Base</p>
                <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-top:6px">
                    <span id="chatSessionBadge" style="font-size:10px;color:var(--text-muted);font-family:monospace;background:rgba(255,255,255,0.04);padding:2px 8px;border-radius:4px;cursor:pointer" title="Session-Verlauf anzeigen" onclick="toggleSessionHistory()"></span>
                    <span id="chatSessionType" style="font-size:11px;padding:2px 10px;border-radius:12px;display:none;font-weight:600;letter-spacing:0.02em;cursor:pointer;position:relative" title="Klick zum Wechseln" onclick="showSessionTypePicker(this)"></span>
                    <button onclick="startNewChatSession()" style="font-size:11px;padding:3px 10px;background:rgba(42,127,142,0.1);border:1px solid rgba(42,127,142,0.25);border-radius:6px;color:var(--accent-light);cursor:pointer;transition:all 0.15s" onmouseenter="this.style.background='rgba(42,127,142,0.2)'" onmouseleave="this.style.background='rgba(42,127,142,0.1)'">+ Neuer Chat</button>
                    <button id="btnCloseSession" onclick="closeCurrentSession()" style="font-size:11px;padding:3px 10px;background:rgba(220,80,80,0.08);border:1px solid rgba(220,80,80,0.2);border-radius:6px;color:rgba(220,130,130,0.9);cursor:pointer;transition:all 0.15s;display:none" onmouseenter="this.style.background='rgba(220,80,80,0.18)'" onmouseleave="this.style.background='rgba(220,80,80,0.08)'">✕ Session schliessen</button>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages" onclick="chatAreaClick(event)">
                <div class="chat-welcome" id="chatWelcome">
                    <div class="chat-welcome-icon"><img src="/logo.jpeg" alt="BEATRIX"></div>
                    <h3 id="chatWelcomeTitle">Hallo! Ich bin BEATRIX.</h3>
                    <p id="chatWelcomeText">Stelle mir eine Frage zu Behavioral Economics, zum Behavioral Competence Model oder zu Dokumenten in der Knowledge Base.</p>
                    <div class="chat-suggestions" id="chatWelcomeSuggestions">
                        <button class="chat-suggestion" onclick="askSuggestion(this)">Was ist das BCM?</button>
                        <button class="chat-suggestion" onclick="askSuggestion(this)">Erkläre Complementarity</button>
                        <button class="chat-suggestion" onclick="askSuggestion(this)" style="border-color:rgba(52,211,153,0.2);color:rgba(52,211,153,0.6)">📋 Neues Projekt eröffnen</button>
                        <button class="chat-suggestion" onclick="askSuggestion(this)" style="border-color:rgba(251,191,36,0.2);color:rgba(251,191,36,0.6)">🎯 Neuen Lead erfassen</button>
                        <button class="chat-suggestion" onclick="askSuggestion(this)" style="border-color:rgba(139,170,255,0.2);color:rgba(139,170,255,0.6)">🔬 BCM-Modell bauen</button>
                        <button class="chat-suggestion" onclick="askSuggestion(this)" style="border-color:rgba(232,163,61,0.2);color:rgba(232,163,61,0.6)">🧠 Ausgangslage erfassen</button>
                    </div>
                </div>
            </div>
            <div class="chat-input-area">
                <div id="chatSessionBar" style="display:flex;align-items:center;justify-content:center;gap:8px;padding:4px 0 6px;flex-wrap:wrap">
                    <span id="chatSessionBadge2" style="font-size:10px;color:var(--text-muted);font-family:monospace;background:rgba(255,255,255,0.04);padding:2px 8px;border-radius:4px;cursor:pointer" title="Session-Verlauf anzeigen" onclick="toggleSessionHistory()"></span>
                    <button onclick="showSessionTypePicker(this)" style="font-size:10px;padding:2px 8px;background:rgba(42,127,142,0.06);border:1px solid rgba(42,127,142,0.15);border-radius:4px;color:rgba(42,127,142,0.6);cursor:pointer;font-family:inherit" title="Session-Typ wechseln">🏷 Projekt</button>
                    <button onclick="startNewChatSession()" style="font-size:10px;padding:2px 8px;background:rgba(42,127,142,0.06);border:1px solid rgba(42,127,142,0.15);border-radius:4px;color:rgba(42,127,142,0.6);cursor:pointer;font-family:inherit">+ Neuer Chat</button>
                    <button id="btnCloseSession2" onclick="closeCurrentSession()" style="font-size:10px;padding:2px 8px;background:rgba(220,80,80,0.05);border:1px solid rgba(220,80,80,0.12);border-radius:4px;color:rgba(220,130,130,0.5);cursor:pointer;display:none;font-family:inherit">✕ Session schliessen</button>
                </div>
                <div id="prjChatIndicator" style="padding:6px 14px;margin-bottom:6px;background:rgba(42,127,142,0.06);border:1px solid rgba(42,127,142,0.15);border-radius:8px;font-size:11px;color:rgba(42,127,142,0.7)">
                    💡 <strong>BEATRIX Command Mode</strong> – Projekte, Leads, Modelle, Kontext per Sprache.
                    <span onclick="toggleBxCmd()" style="cursor:pointer;margin-left:8px;color:rgba(255,255,255,0.3)">✕</span>
                </div>
                <div id="mainChatAttachments" style="display:none;padding:0 0 8px;display:flex;flex-wrap:wrap;gap:6px"></div>
                <div class="chat-input-wrap">
                    <button id="prjChatToggle" onclick="toggleBxCmd()" style="padding:8px 10px;background:rgba(42,127,142,0.15);border:1px solid rgba(42,127,142,0.4);border-radius:8px;color:var(--accent-light);font-size:14px;cursor:pointer;flex-shrink:0;transition:all 0.15s;line-height:1;align-self:flex-end" title="BEATRIX Command Mode aktiv (klicken zum Beenden)">💡</button>
                    <input type="file" id="mainChatFileInput" style="display:none" accept=".pdf,.txt,.md,.csv,.json,.docx,.ics,.png,.jpg,.jpeg,.gif,.webp" onchange="mainChatFileSelected(this)" multiple>
                    <button onclick="document.getElementById('mainChatFileInput').click()" style="padding:8px 10px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.4);font-size:14px;cursor:pointer;flex-shrink:0;transition:all 0.15s;line-height:1;align-self:flex-end" title="Datei anhängen">📎</button>
                    <div style="flex:1;display:flex;flex-direction:column;min-height:0">
                        <textarea class="chat-input" id="chatInput" placeholder="Stelle mir eine Frage oder beschreibe was du brauchst..." rows="2" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}" oninput="autoResize(this)"></textarea>
                    </div>
                    <button class="chat-send-btn" id="chatSendBtn" onclick="sendChat()" title="Senden">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="upload-section">
        <div class="container">
            <div class="section-header"><h2>Dokument hochladen</h2><p>PDFs, Texte und Axiom-Definitionen in die BEATRIX Knowledge Base einfügen.</p></div>
            <div class="db-selector">
                <div class="db-option selected" data-db="knowledge_base" onclick="selectDB(this)"><div class="db-option-title"><span class="db-dot" style="background:var(--accent)"></span> Knowledge Base</div><div class="db-option-desc">Dokumente & Literatur</div></div>
                <div class="db-option" data-db="bcm_axioms" onclick="selectDB(this)"><div class="db-option-title"><span class="db-dot" style="background:var(--success)"></span> BCM Axiome</div><div class="db-option-desc">Axiom-Definitionen</div></div>
                <div class="db-option" data-db="research" onclick="selectDB(this)"><div class="db-option-title"><span class="db-dot" style="background:var(--warning)"></span> Research Papers</div><div class="db-option-desc">Akademische Publikationen</div></div>
            </div>
            <div class="tabs"><button class="tab active" onclick="switchTab('file',this)">Datei-Upload</button><button class="tab" onclick="switchTab('text',this)">Text eingeben</button></div>
            <div class="file-section active" id="file-section">
                <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
                    <h3>Dateien hierher ziehen oder <span>durchsuchen</span></h3>
                    <p>Maximal 50 MB pro Datei</p>
                    <div class="upload-formats"><span class="format-badge">PDF</span><span class="format-badge">TXT</span><span class="format-badge">MD</span><span class="format-badge">DOCX</span><span class="format-badge">CSV</span><span class="format-badge">JSON</span></div>
                </div>
                <input type="file" id="fileInput" multiple accept=".pdf,.txt,.md,.docx,.csv,.json" style="display:none">
                <div class="file-list" id="fileList"></div>
                <div id="fileAnalysisPreview" style="display:none;margin-top:12px;padding:14px 18px;background:rgba(42,127,142,0.06);border:1px solid rgba(42,127,142,0.2);border-radius:12px">
                    <div id="fileAnalysisContent" style="font-size:12px;color:var(--text-secondary)"></div>
                </div>
                <div id="fileMetaFields" style="margin-top:16px">
                    <div class="input-group"><label>Titel</label><input type="text" class="input-field" id="fileTitle" placeholder="Wird automatisch erkannt..."></div>
                    <div class="input-row">
                        <div class="input-group"><label>Kategorie</label><select class="input-field" id="fileCategory"><option value="general">Allgemein</option><option value="axiom">Axiom</option><option value="paper">Paper</option><option value="book">Buch</option><option value="study">Studie/Report</option><option value="note">Notiz</option></select></div>
                        <div class="input-group"><label>Sprache</label><select class="input-field" id="fileLang"><option value="de">Deutsch</option><option value="en">English</option></select></div>
                    </div>
                    <div class="input-group"><label>Tags</label><div class="tag-container" id="fileTagContainer" onclick="this.querySelector('.tag-input').focus()"><input type="text" class="tag-input" id="fileTagInput" placeholder="Tag eingeben + Enter"></div></div>
                </div>
            </div>
            <div class="text-section" id="text-section">
                <div class="text-zone" id="textZone" onclick="document.getElementById('textContent').focus()">
                    <div class="text-zone-placeholder" id="textZonePlaceholder">
                        <div class="upload-icon"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>
                        <h3>Text hier einfügen oder <span>tippen</span></h3>
                        <p>Texte, Axiom-Definitionen, Paper-Abstracts</p>
                    </div>
                    <textarea class="textarea-field text-zone-input" id="textContent" placeholder="" onpaste="setTimeout(()=>{updateTextZone();analyzeTextContent()},300)" oninput="updateTextZone();debounceTextAnalysis()"></textarea>
                </div>
                <div id="textCharCount" style="display:none;margin-top:6px;text-align:right;font-size:11px;color:var(--text-muted)"></div>
                <div id="textAnalysisPreview" style="display:none;margin-top:12px;margin-bottom:16px;padding:14px 18px;background:rgba(42,127,142,0.06);border:1px solid rgba(42,127,142,0.2);border-radius:12px">
                    <div id="textAnalysisContent" style="font-size:12px;color:var(--text-secondary)"></div>
                </div>
                <div class="input-group"><label>Titel</label><input type="text" class="input-field" id="textTitle" placeholder="Wird automatisch erkannt..."></div>
                <div class="input-row">
                    <div class="input-group"><label>Kategorie</label><select class="input-field" id="textCategory"><option value="general">Allgemein</option><option value="axiom">Axiom</option><option value="paper">Paper</option><option value="book">Buch</option><option value="study">Studie/Report</option><option value="note">Notiz</option></select></div>
                    <div class="input-group"><label>Sprache</label><select class="input-field" id="textLang"><option value="de">Deutsch</option><option value="en">English</option></select></div>
                </div>
                <div class="input-group"><label>Tags</label><div class="tag-container" id="tagContainer" onclick="this.querySelector('.tag-input').focus()"><input type="text" class="tag-input" id="tagInput" placeholder="Tag eingeben + Enter"></div></div>
            </div>
            <div class="actions">
                <span class="upload-count" id="uploadCount"></span>
                <div style="display:flex;gap:10px;align-items:center">
                    <button class="btn btn-secondary" onclick="clearAll()">Zurücksetzen</button>
                    <button class="btn btn-primary" id="submitBtn" onclick="submitUpload()">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        In Datenbank laden
                    </button>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="documents-section">
        <div class="container"><div class="section-header" style="display:flex;justify-content:space-between;align-items:center"><div><h2>Dokumente</h2><p>Übersicht aller indexierten Dokumente in der BEATRIX Knowledge Base.</p></div><div style="display:flex;gap:8px"><button onclick="bulkApeReview()" style="padding:8px 16px;background:rgba(255,140,0,0.12);border:1px solid rgba(255,140,0,0.3);border-radius:10px;color:#ff8c00;font-size:12px;cursor:pointer;white-space:nowrap" id="bulkApeBtn">🔥 Alle APE-reviewen</button><button onclick="bulkClassifyDocs()" style="padding:8px 16px;background:rgba(42,127,142,0.12);border:1px solid rgba(42,127,142,0.3);border-radius:10px;color:var(--accent);font-size:12px;cursor:pointer;white-space:nowrap" id="bulkClassifyBtn">🧬 Alle klassifizieren</button></div></div>
        <div id="docFilterBar" style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap"></div>
        <div id="docTableWrapper"></div></div>
    </section>

    <!-- ═══════ UPLOAD PRIORITY SECTION ═══════ -->
    <section class="section" id="uploadpriority-section">
        <div class="container">
            <div class="section-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                <div>
                    <h2>📋 Upload Priority – Top 100</h2>
                    <p>Die wichtigsten Papers für die Knowledge Base, priorisiert nach Integration Level, Content Level und Vernetzung.</p>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                    <div id="upStatsBar" style="display:flex;gap:6px;flex-wrap:wrap"></div>
                    <button onclick="loadUploadPriority()" style="padding:8px 16px;background:rgba(42,127,142,0.12);border:1px solid rgba(42,127,142,0.3);border-radius:10px;color:var(--accent);font-size:12px;cursor:pointer">🔄 Aktualisieren</button>
                </div>
            </div>
            <div id="upFilterBar" style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap">
                <button class="up-filter active" data-filter="all" onclick="upFilter('all',this)" style="padding:4px 12px;border-radius:6px;border:1px solid var(--border);background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.6);font-size:11px;cursor:pointer">Alle</button>
                <button class="up-filter" data-filter="I5" onclick="upFilter('I5',this)" style="padding:4px 12px;border-radius:6px;border:1px solid rgba(139,92,246,0.2);background:transparent;color:rgba(139,92,246,0.6);font-size:11px;cursor:pointer">I5 Foundational</button>
                <button class="up-filter" data-filter="I4" onclick="upFilter('I4',this)" style="padding:4px 12px;border-radius:6px;border:1px solid rgba(59,130,246,0.2);background:transparent;color:rgba(59,130,246,0.6);font-size:11px;cursor:pointer">I4 Core</button>
                <button class="up-filter" data-filter="I3" onclick="upFilter('I3',this)" style="padding:4px 12px;border-radius:6px;border:1px solid rgba(52,211,153,0.2);background:transparent;color:rgba(52,211,153,0.6);font-size:11px;cursor:pointer">I3 Standard</button>
                <button class="up-filter" data-filter="doi" onclick="upFilter('doi',this)" style="padding:4px 12px;border-radius:6px;border:1px solid rgba(251,191,36,0.2);background:transparent;color:rgba(251,191,36,0.6);font-size:11px;cursor:pointer">Mit DOI</button>
            </div>
            <div id="upTableWrapper" style="min-height:200px">
                <div style="text-align:center;padding:60px 20px;color:rgba(255,255,255,0.3)">Lade Priority-Liste...</div>
            </div>
            <div id="upMethodology" style="margin-top:16px;padding:14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:10px;display:none">
                <div style="font-size:11px;color:rgba(255,255,255,0.35);line-height:1.6">
                    <strong style="color:rgba(255,255,255,0.5)">Priorisierung:</strong> Priority = IL-Gewicht (I5=500, I4=400, I3=300, I2=150, I1=50) + CL-Boost (L2=80, L1=20) + DOI-Boost (+15) + Case-Links (+5/Case, max 100) + Prior-Score (×50)
                </div>
            </div>
        </div>
    </section>

    <!-- ═══════ PAPER FINDER SECTION ═══════ -->
    <section class="section" id="paperfinder-section">
        <div class="container">
            <div class="section-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                <div>
                    <h2>🔍 Paper Finder</h2>
                    <p>Verifizierte PDF-Quellen für Behavioral Economics Forscher. Google Scholar → Homepage → PDFs.</p>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                    <div id="pfStatsBar" style="display:flex;gap:6px;flex-wrap:wrap"></div>
                    <button onclick="loadPaperFinder()" style="padding:8px 16px;background:rgba(42,127,142,0.12);border:1px solid rgba(42,127,142,0.3);border-radius:10px;color:var(--accent);font-size:12px;cursor:pointer">🔄 Aktualisieren</button>
                </div>
            </div>
            <!-- Filter bar -->
            <div id="pfFilterBar" style="display:none;margin-bottom:12px;display:flex;gap:6px;flex-wrap:wrap"></div>
            <!-- Algorithm info -->
            <div id="pfAlgoInfo" style="margin-bottom:16px;padding:12px 16px;background:rgba(42,127,142,0.05);border:1px solid rgba(42,127,142,0.15);border-radius:10px;display:none">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                    <span style="font-size:14px">🧠</span>
                    <span style="font-size:12px;font-weight:600;color:var(--accent)" id="pfAlgoName">Discovery Algorithm</span>
                </div>
                <div id="pfAlgoSteps" style="display:flex;gap:6px;flex-wrap:wrap;font-size:11px"></div>
            </div>
            <!-- Researcher cards -->
            <div id="pfResearcherGrid" style="min-height:200px">
                <div style="text-align:center;padding:60px 20px;color:rgba(255,255,255,0.3)">Lade Paper Finder...</div>
            </div>
            <!-- Detail panel (shown when clicking a researcher) -->
            <div id="pfDetailPanel" style="display:none;margin-top:16px;padding:20px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:12px"></div>
        </div>
    </section>

    <!-- ═══════ UNIVERSITIES SECTION ═══════ -->
    <section class="section" id="universities-section">
        <div class="container">
            <div class="section-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                <div>
                    <h2>🏛 Universitäten</h2>
                    <p>Forschungspapiere nach Universität, Department und Professor — direkt aus institutionellen Repositorien.</p>
                </div>
                <div id="uni-stats" style="display:flex;gap:16px;flex-wrap:wrap"></div>
            </div>

            <!-- Breadcrumb -->
            <div id="uni-breadcrumb" style="display:flex;align-items:center;gap:8px;margin-bottom:20px;font-size:13px;color:var(--text-secondary)"></div>

            <!-- Search -->
            <div style="margin-bottom:24px">
                <input type="text" id="uni-search" placeholder="Professor oder Paper suchen..." oninput="uniFilter()" style="width:100%;padding:12px 16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:14px;font-family:inherit;outline:none;transition:var(--transition)" onfocus="this.style.borderColor=&apos;var(--accent)&apos;" onblur="this.style.borderColor=&apos;var(--border)&apos;">
            </div>

            <!-- Content container -->
            <div id="uni-content"><div style="padding:20px;color:var(--text-muted)">⏳ Loading universities data...</div></div>
        </div>
    </section>

    <!-- ═══════ UNIVERSITIES SECTION ═══════ -->
    

    <!-- ═══════ MODEL BUILDING SECTION ═══════ -->
    <section class="section" id="model-section">
        <div class="container">
            <div class="mb-header">
                <div>
                    <h2>Modell-Building</h2>
                    <p>Evidenzbasierte Verhaltensmodelle mit dem EEE Workflow designen</p>
                </div>
                <button class="mb-btn mb-btn-secondary" onclick="mbShowRegistry()" id="mbRegistryBtn">📋 Modell-Registry (21)</button>
            </div>

            <!-- PROGRESS BAR -->
            <div class="mb-progress" id="mbProgress" style="display:none">
                <div class="mb-step-dot active" data-step="0"><div class="mb-step-num">0</div><div class="mb-step-label">Init</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="1"><div class="mb-step-num">1</div><div class="mb-step-label">Entry Point</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="2"><div class="mb-step-num">2</div><div class="mb-step-label">Scope</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="3"><div class="mb-step-num">3</div><div class="mb-step-label">Kontext Ψ</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="4"><div class="mb-step-num">4</div><div class="mb-step-label">Modell</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="5"><div class="mb-step-num">5</div><div class="mb-step-label">Parameter</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="6"><div class="mb-step-num">6</div><div class="mb-step-label">Ergebnis</div></div>
            </div>

            <!-- ═══ START: Mode Selection ═══ -->
            <div class="mb-panel active" id="mbStart">
                <div class="mb-step-title">Neues Verhaltensmodell designen</div>
                <div class="mb-step-desc">Der EEE Workflow (Appendix EEE: METHOD-DESIGN) führt dich Schritt für Schritt zum evidenzbasierten Modell. Wähle deinen Modus:</div>

                <div class="mb-mode-cards">
                    <div class="mb-mode-card" onclick="mbSelectMode(this,'schnell')">
                        <div class="mb-mode-icon">⚡</div>
                        <div class="mb-mode-name">Schnell</div>
                        <div class="mb-mode-time">~10 Minuten</div>
                        <div class="mb-mode-desc">3 Fragen → komplettes 10C Modell via GGG Defaults</div>
                    </div>
                    <div class="mb-mode-card" onclick="mbSelectMode(this,'gefuehrt')">
                        <div class="mb-mode-icon">🎯</div>
                        <div class="mb-mode-name">Geführt</div>
                        <div class="mb-mode-time">~45 Minuten</div>
                        <div class="mb-mode-desc">Alle Steps mit Erklärungen & 3+1 Optionen</div>
                    </div>
                    <div class="mb-mode-card" onclick="mbSelectMode(this,'template')">
                        <div class="mb-mode-icon">📦</div>
                        <div class="mb-mode-name">Template</div>
                        <div class="mb-mode-time">~20 Minuten</div>
                        <div class="mb-mode-desc">Seed-Modell aus Registry anpassen</div>
                    </div>
                    <div class="mb-mode-card" onclick="mbSelectMode(this,'custom')">
                        <div class="mb-mode-icon">🔧</div>
                        <div class="mb-mode-name">Custom</div>
                        <div class="mb-mode-time">Variabel</div>
                        <div class="mb-mode-desc">Freie Gestaltung, maximale Kontrolle</div>
                    </div>
                </div>

                <div class="mb-actions">
                    <button class="mb-btn mb-btn-primary" id="mbStartBtn" disabled onclick="mbStartWorkflow()">Workflow starten →</button>
                </div>
            </div>

            <!-- ═══ STEP 0: Session Init ═══ -->
            <div class="mb-panel" id="mbStep0">
                <!-- VIEW A: Choices -->
                <div id="mbStep0ViewA">
                    <div class="mb-step-title">Wähle deine Problemstellung</div>
                    <div class="mb-step-desc">BEATRIX leitet daraus Domain, Scope und Lieferobjekte ab.</div>

                    <div id="mbStep0Choices" style="display:flex;flex-direction:column;gap:10px;margin:20px 0">
                        <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">
                            <div style="font-size:24px;margin-bottom:8px">⏳</div>
                            Lade personalisierte Vorschläge...
                        </div>
                    </div>

                    <div style="display:flex;gap:10px;margin-top:8px">
                        <div class="mb-choice" style="flex:1;border:1px dashed rgba(139,170,255,0.25)" onclick="mbShowCustomInput()">
                            <div class="mb-choice-icon" style="font-size:16px">✏️</div>
                            <div class="mb-choice-title">Eigene Problemstellung</div>
                        </div>
                        <div class="mb-choice" style="flex:1;border:1px dashed rgba(139,170,255,0.25)" onclick="mbLetBeatrixDefine()">
                            <div class="mb-choice-icon" style="font-size:16px">🤖</div>
                            <div class="mb-choice-title">BEATRIX definiert</div>
                        </div>
                    </div>

                    <div id="mbCustomInput" style="display:none;margin-top:16px">
                        <textarea class="mb-input mb-textarea" id="mbQuestion" placeholder="Beschreibe das Verhalten, die Entscheidung oder das Phänomen, das du modellieren möchtest..." style="min-height:80px"></textarea>
                        <div style="margin-top:10px">
                            <button class="mb-btn mb-btn-primary" onclick="mbProcessStep0()">Analysieren →</button>
                        </div>
                    </div>
                </div>

                <!-- VIEW B: Analysis (hidden initially) -->
                <div id="mbStep0ViewB" style="display:none">
                    <div class="mb-step-title">Session-Analyse</div>
                    <div id="mbStep0SelectedQ" style="font-size:14px;color:rgba(255,255,255,0.7);margin-bottom:16px;padding:12px 16px;background:rgba(139,170,255,0.05);border-left:3px solid var(--accent);border-radius:0 8px 8px 0;line-height:1.6"></div>

                    <div id="mbProgress0" class="mb-inline-progress" style="display:none"></div>

                    <div id="mbStep0Result" style="display:none">
                        <div class="mb-summary" id="mbSessionSummary"></div>
                    </div>

                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoToStart()">← Zurück</button>
                        <button class="mb-btn mb-btn-back" onclick="mbStep0Back()">↻ Andere Frage</button>
                        <button class="mb-btn mb-btn-primary" id="mbStep0Btn" disabled>BEATRIX analysiert...</button>
                    </div>
                </div>
            </div>

            <!-- ═══ STEP 1: Entry Point ═══ -->
            <div class="mb-panel" id="mbStep1">
                <div id="mbStep1ViewA">
                    <div class="mb-step-title">Entry Point wählen</div>
                    <div class="mb-step-desc">Starte mit Theorie oder Praxis?</div>
                    <div class="mb-choices">
                        <div class="mb-choice" onclick="mbSelect(this,'theory')">
                            <div class="mb-choice-num">1</div>
                            <div class="mb-choice-icon">📚</div>
                            <div class="mb-choice-title">Theory-Driven</div>
                            <div class="mb-choice-desc">Start mit existierenden CORE Appendices (AAA-AW). Passt, wenn du ein EBF-Konzept anwenden möchtest.</div>
                            <div class="mb-choice-meta">→ Begin with EBF concept</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'practice')">
                            <div class="mb-choice-num">2</div>
                            <div class="mb-choice-icon">🎯</div>
                            <div class="mb-choice-title">Practice-Driven</div>
                            <div class="mb-choice-desc">Start mit konkretem Problem oder Situation. Passt, wenn du ein reales Verhalten modellieren musst.</div>
                            <div class="mb-choice-meta">→ Begin with Gestaltungsanlass</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'hybrid')">
                            <div class="mb-choice-num">3</div>
                            <div class="mb-choice-icon">🔄</div>
                            <div class="mb-choice-title">Hybrid</div>
                            <div class="mb-choice-desc">Abwechselnde Theorie-Praxis-Zyklen. Passt, wenn Iteration erforderlich ist.</div>
                            <div class="mb-choice-meta">→ Theory ↔ Practice Iteration</div>
                        </div>
                        <div class="mb-choice custom-choice" onclick="mbSelect(this,'custom')">
                            <div class="mb-choice-num">4</div>
                            <div class="mb-choice-icon">🔧</div>
                            <div class="mb-choice-title">Custom</div>
                            <div class="mb-choice-desc">Freie Wahl — du definierst den Entry Point selbst.</div>
                        </div>
                    </div>
                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoStep(0)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" disabled id="mbStep1Btn" onclick="mbConfirmAndAdvance(1,2)">Weiter →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ STEP 2: Scope ═══ -->
            <div class="mb-panel" id="mbStep2">
                <div id="mbStep2ViewA">
                    <div class="mb-step-title">Scope wählen</div>
                    <div class="mb-step-desc">Welchen Verhaltenstyp modellierst du?</div>
                    <div class="mb-choices">
                        <div class="mb-choice" onclick="mbSelect(this,'decision')">
                            <div class="mb-choice-num">1</div>
                            <div class="mb-choice-icon">⚖️</div>
                            <div class="mb-choice-title">Decision</div>
                            <div class="mb-choice-desc">Einmalentscheidung: Rentenmodell wählen, Impfung, Jobwechsel, Kaufentscheid.</div>
                            <div class="mb-choice-meta">Mathematik: Logistic / Binary Choice</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'continuous')">
                            <div class="mb-choice-num">2</div>
                            <div class="mb-choice-icon">📈</div>
                            <div class="mb-choice-title">Continuous</div>
                            <div class="mb-choice-desc">Wiederholtes Verhalten: Sparbetrag, Energieverbrauch, Trainingsfrequenz.</div>
                            <div class="mb-choice-meta">Mathematik: Linear / CES Functional Form</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'process')">
                            <div class="mb-choice-num">3</div>
                            <div class="mb-choice-icon">🔄</div>
                            <div class="mb-choice-title">Process</div>
                            <div class="mb-choice-desc">Veränderung über Zeit: Habit-Bildung, Learning, Adoption Journey.</div>
                            <div class="mb-choice-meta">Mathematik: Dynamic / BCJ Models</div>
                        </div>
                        <div class="mb-choice custom-choice" onclick="mbSelect(this,'custom')">
                            <div class="mb-choice-num">4</div>
                            <div class="mb-choice-icon">🔧</div>
                            <div class="mb-choice-title">Custom</div>
                            <div class="mb-choice-desc">Spezifisch definieren — kombiniere oder erweitere die Typen.</div>
                        </div>
                    </div>
                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoStep(1)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" disabled id="mbStep2Btn" onclick="mbConfirmAndAdvance(2,3)">Weiter →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ STEP 3: Context Ψ ═══ -->
            <div class="mb-panel" id="mbStep3">
                <div id="mbStep3ViewA">
                    <div class="mb-step-title">Kontext-Spezifikation (Ψ)</div>
                    <div class="mb-step-desc">Welche Kontextdimensionen sind relevant?</div>
                    <div class="mb-choices">
                        <div class="mb-choice" onclick="mbSelect(this,'ggg-default')">
                            <div class="mb-choice-num">1</div>
                            <div class="mb-choice-icon">📊</div>
                            <div class="mb-choice-title">GGG Defaults</div>
                            <div class="mb-choice-desc">Vorkonfigurierte Ψ-Werte nach Domain & Level aus Tabelle GGG-1 (trust, digital_adoption, autonomy, risk_aversion).</div>
                            <div class="mb-choice-meta">Empfohlen für Schnell-Modus</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'custom-psi')">
                            <div class="mb-choice-num">2</div>
                            <div class="mb-choice-icon">🎛️</div>
                            <div class="mb-choice-title">Custom Ψ-Dimensionen</div>
                            <div class="mb-choice-desc">Du definierst explizit welche Ψ-Faktoren relevant sind (z.B. Saisonalität, Peer Effects, Availability).</div>
                            <div class="mb-choice-meta">Für spezifische Kontexte</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'full-8psi')">
                            <div class="mb-choice-num">3</div>
                            <div class="mb-choice-icon">🔬</div>
                            <div class="mb-choice-title">Alle 8 Ψ-Dimensionen</div>
                            <div class="mb-choice-desc">Vollständige Analyse aller 8 Kontextdimensionen.</div>
                            <div class="mb-choice-meta">Maximale Tiefe</div>
                        </div>
                        <div class="mb-choice custom-choice" onclick="mbSelect(this,'custom')">
                            <div class="mb-choice-num">4</div>
                            <div class="mb-choice-icon">🔧</div>
                            <div class="mb-choice-title">Custom</div>
                            <div class="mb-choice-desc">Eigene Kontext-Konfiguration mit freier Ψ-Auswahl.</div>
                        </div>
                    </div>
                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoStep(2)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" disabled id="mbStep3Btn" onclick="mbProcessStep3()">BEATRIX analysieren lassen →</button>
                    </div>
                </div>

                <!-- ViewB: Processing -->
                <div id="mbStep3ViewB" style="display:none">
                    <div class="mb-step-title">Ψ-Kontext wird analysiert</div>
                    <div id="mbStep3Selection" style="font-size:14px;color:rgba(255,255,255,0.7);margin-bottom:16px;padding:12px 16px;background:rgba(139,170,255,0.05);border-left:3px solid var(--accent);border-radius:0 8px 8px 0"></div>
                    <div id="mbProgress3" class="mb-inline-progress" style="display:none"></div>
                    <div id="mbStep3Result" style="margin-top:16px"></div>
                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoStep(2)">← Zurück</button>
                        <button class="mb-btn mb-btn-back" onclick="mbStep3Back()">↻ Andere Wahl</button>
                        <button class="mb-btn mb-btn-primary" id="mbStep3NextBtn" disabled>BEATRIX analysiert...</button>
                    </div>
                </div>
            </div>
                </div>
            </div>

            <!-- ═══ STEP 4: Model ═══ -->
            <div class="mb-panel" id="mbStep4">
                <div class="mb-step-title">Schritt 4: Modell-Spezifikation</div>
                <div class="mb-step-desc">BEATRIX durchsucht die Modell-Registry und baut das 10C-Mapping.</div>
                <div id="mbModelResult" style="min-height:120px">
                    <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">
                        <div style="font-size:20px;margin-bottom:8px">📊</div>
                        Klicke «Modell erstellen» um die Analyse zu starten.
                    </div>
                </div>
                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="mbGoStep(3)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="mbStep4Btn" onclick="mbRunStep4()">Modell erstellen →</button>
                </div>
            </div>

            <!-- ═══ STEP 5: Parameters ═══ -->
            <div class="mb-panel" id="mbStep5">
                <div class="mb-step-title">Schritt 5: Parameter-Schätzung</div>
                <div class="mb-step-desc">LLMMC Prior generieren und Bayesian Updating mit BCM2 & Papers.</div>
                <div id="mbParamResult" style="min-height:120px">
                    <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">
                        <div style="font-size:20px;margin-bottom:8px">🔬</div>
                        Klicke «Parameter schätzen» um die Berechnung zu starten.
                    </div>
                </div>
                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="mbGoStep(4)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="mbStep5Btn" onclick="mbRunStep5()">Parameter schätzen →</button>
                </div>
            </div>

            <!-- ═══ STEP 6: Result ═══ -->
            <div class="mb-panel" id="mbStep6">
                <div class="mb-step-title">Schritt 6: Ergebnis & Report</div>
                <div class="mb-step-desc">Wähle die Report-Tiefe. BEATRIX streamt den Bericht live.</div>

                <!-- Depth Choice -->
                <div id="mbDepthChoice" style="display:flex;gap:12px;margin:20px 0">
                    <div onclick="mbSelectDepth('standard', this)" id="mbDepthStd" style="flex:1;padding:18px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:all 0.2s"
                         onmouseover="if(!this.classList.contains('depth-active'))this.style.background='rgba(255,255,255,0.04)'"
                         onmouseout="if(!this.classList.contains('depth-active'))this.style.background='transparent'">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:6px">📋 Standard</div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5">Kompakter Report mit Key Facts, 10C Mapping, BCM Parametern und Handlungsempfehlungen.</div>
                        <div style="font-size:11px;color:var(--accent);margin-top:8px">~15 Sek. · 1–2 Seiten</div>
                    </div>
                    <div onclick="mbSelectDepth('deep', this)" id="mbDepthDeep" style="flex:1;padding:18px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:all 0.2s"
                         onmouseover="if(!this.classList.contains('depth-active'))this.style.background='rgba(255,255,255,0.04)'"
                         onmouseout="if(!this.classList.contains('depth-active'))this.style.background='transparent'">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:6px">🔬 Standard++</div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5">Vertiefte Analyse mit Ψ-Kontext-Matrix, Sensitivitätsanalyse, Interventions-Roadmap und Detail-Tabellen.</div>
                        <div style="font-size:11px;color:var(--accent);margin-top:8px">~30 Sek. · 4–6 Seiten</div>
                    </div>
                </div>

                <!-- Progress Container -->
                <div id="mbComputeProgress" style="margin:24px 0;display:none">
                    <div style="display:flex;align-items:center;gap:12px">
                        <div id="mbComputeSpinner" style="width:16px;height:16px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0"></div>
                        <div>
                            <div id="mbComputeStage" style="font-size:14px;font-weight:600;color:rgba(255,255,255,0.9)">Verbinde mit BEATRIX...</div>
                            <div id="mbComputeDetail" style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px"></div>
                        </div>
                    </div>
                    <div id="mbComputeStages"></div>
                    <div id="mbComputeTime" style="font-size:11px;color:rgba(255,255,255,0.3);margin-top:8px"></div>
                    <div id="mbProgressBar" style="display:none"></div>
                    <div id="mbComputePercent" style="display:none"></div>
                </div>

                <!-- Result (streamed) -->
                <div id="mbResultContent" style="display:none"></div>

                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="mbGoStep(5)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="mbComputeBtn" onclick="mbComputeResult()" disabled style="opacity:0.4">Report generieren →</button>
                    <button class="mb-btn mb-btn-primary" id="mbExportBtn" onclick="mbExportModel()" style="display:none">📄 Exportieren</button>
                    <button class="mb-btn mb-btn-secondary" onclick="mbGoToStart()" style="display:none" id="mbNewModelBtn">Neues Modell</button>
                </div>
            </div>

            <!-- ═══ REGISTRY VIEW ═══ -->
            <div class="mb-panel" id="mbRegistry">
                <div class="mb-step-title">Modell-Registry</div>
                <div class="mb-step-desc">21 evidenzbasierte Modelle im EBF Framework.</div>
                <div class="mb-registry" id="mbRegistryList"></div>
                <div class="mb-actions" style="margin-top:20px">
                    <button class="mb-btn mb-btn-back" onclick="mbGoToStart()">← Zurück zum Workflow</button>
                </div>
            </div>

        </div>
    </section>

    <!-- ═══════ AUSGANGSLAGE / KONTEXT SECTION ═══════ -->
    <section class="section" id="context-section">
        <div class="container">
            <div class="mb-header">
                <div>
                    <h2>Kontext-Analyse</h2>
                    <p>8 Ψ-Dimensionen × 5-Ebenen-Hierarchie — weil ohne Kontext jede Antwort falsch ist</p>
                </div>
                <div style="display:flex;gap:8px">
                    <button class="mb-btn mb-btn-secondary" onclick="caShowHistory()" id="caHistoryBtn">📋 Bisherige Analysen</button>
                </div>
            </div>

            <!-- PROGRESS BAR -->
            <div class="mb-progress" id="caProgress" style="display:none">
                <div class="mb-step-dot active" data-castep="0"><div class="mb-step-num">1</div><div class="mb-step-label">Thema</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-castep="1"><div class="mb-step-num">2</div><div class="mb-step-label">Kontext</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-castep="2"><div class="mb-step-num">3</div><div class="mb-step-label">Situation</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-castep="3"><div class="mb-step-num">4</div><div class="mb-step-label">Analyse</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-castep="4"><div class="mb-step-num">5</div><div class="mb-step-label">Ergebnis</div></div>
            </div>

            <!-- ═══ START: Mode Selection ═══ -->
            <div class="mb-panel active" id="caStart">
                <div class="mb-step-title">Neue Kontextanalyse starten</div>
                <div class="mb-step-desc">Die Kontextanalyse identifiziert alle relevanten Einflussfaktoren auf Verhalten und Entscheidungen. Jeder Kontext — Land, Branche, Organisation, Situation — verändert, wie Menschen sich verhalten.</div>

                <div class="mb-mode-cards">
                    <div class="mb-mode-card" onclick="caSelectMode(this,'schnell')">
                        <div class="mb-mode-icon">⚡</div>
                        <div class="mb-mode-name">Schnell</div>
                        <div class="mb-mode-time">~5 Minuten</div>
                        <div class="mb-mode-desc">Frage eingeben → BEATRIX analysiert alle 5 Ebenen automatisch</div>
                    </div>
                    <div class="mb-mode-card" onclick="caSelectMode(this,'gefuehrt')">
                        <div class="mb-mode-icon">🎯</div>
                        <div class="mb-mode-name">Geführt</div>
                        <div class="mb-mode-time">~15 Minuten</div>
                        <div class="mb-mode-desc">Schritt für Schritt: Land → Branche → Situation, mit Auswahlhilfen</div>
                    </div>
                    <div class="mb-mode-card" onclick="caSelectMode(this,'projekt')">
                        <div class="mb-mode-icon">📊</div>
                        <div class="mb-mode-name">Projekt</div>
                        <div class="mb-mode-time">~10 Minuten</div>
                        <div class="mb-mode-desc">Für einen bestehenden Kunden/Projekt aus der Datenbank</div>
                    </div>
                    <div class="mb-mode-card" onclick="caSelectMode(this,'vergleich')">
                        <div class="mb-mode-icon">🔄</div>
                        <div class="mb-mode-name">Vergleich</div>
                        <div class="mb-mode-time">~20 Minuten</div>
                        <div class="mb-mode-desc">Zwei Kontexte vergleichen — wie ändern sich Parameter von A → B?</div>
                    </div>
                </div>

                <div class="mb-actions">
                    <button class="mb-btn mb-btn-primary" id="caStartBtn" disabled onclick="caStartWorkflow()">Analyse starten →</button>
                </div>
            </div>

            <!-- ═══ STEP 0: Thema/Frage ═══ -->
            <div class="mb-panel" id="caStep0">
                <div class="mb-step-title">Was willst du analysieren?</div>
                <div class="mb-step-desc">Beschreibe das Verhalten, die Entscheidung oder die Fragestellung. BEATRIX identifiziert daraus die relevanten Ψ-Dimensionen.</div>

                <div id="caStep0Suggestions" style="display:flex;flex-direction:column;gap:10px;margin:20px 0">
                    <div style="text-align:center;padding:30px;color:rgba(255,255,255,0.5)">
                        <div style="font-size:24px;margin-bottom:8px">⏳</div>
                        Lade kontextbasierte Vorschläge...
                    </div>
                </div>

                <div style="display:flex;gap:10px;margin-top:8px">
                    <div class="mb-choice" style="flex:1;border:1px dashed rgba(139,170,255,0.25)" onclick="caShowCustomInput()">
                        <div class="mb-choice-icon" style="font-size:16px">✏️</div>
                        <div class="mb-choice-title">Eigene Frage eingeben</div>
                    </div>
                </div>

                <div id="caCustomInput" style="display:none;margin-top:16px">
                    <textarea class="mb-input mb-textarea" id="caQuestion" placeholder="z.B. 'Warum wechseln Schweizer Bankkunden so selten ihren Anbieter?' oder 'Wie kann die BFE Hausbesitzer zu Heizungssanierung motivieren?'" style="min-height:80px"></textarea>
                    <div style="margin-top:10px">
                        <button class="mb-btn mb-btn-primary" onclick="caProcessStep0()">Analysieren →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ SMART STEP 1: KONTEXT BESTÄTIGEN ═══ -->
            <div class="mb-panel" id="caStepConfirm">
                <div class="mb-step-title" id="caConfirmTitle">Kontext wird erkannt...</div>
                <div class="mb-step-desc" id="caConfirmDesc">BEATRIX analysiert deine Frage...</div>

                <div id="caConfirmLoading" style="padding:30px;text-align:center">
                    <div class="spinner" style="margin:0 auto 12px"></div>
                    <div style="font-size:13px;color:rgba(255,255,255,0.5)">Frage wird analysiert...</div>
                </div>

                <div id="caConfirmContent" style="display:none">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
                        <!-- Land -->
                        <div style="padding:14px 16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)" id="caConfLand">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <span style="font-size:11px;text-transform:uppercase;color:var(--text-muted);font-weight:600;letter-spacing:0.5px">🌍 Land</span>
                                <span onclick="caConfirmEdit('land')" style="font-size:11px;color:var(--accent);cursor:pointer;text-decoration:underline">ändern</span>
                            </div>
                            <div id="caConfLandValue" style="font-size:15px;font-weight:600;color:var(--white)">–</div>
                            <div id="caConfLandEdit" style="display:none;margin-top:8px">
                                <select class="mb-input" id="caConfLandSelect" onchange="caConfirmPick('land')" style="width:100%;box-sizing:border-box;font-size:13px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--accent)">
                                    <option value="ch">🇨🇭 Schweiz</option>
                                    <option value="at">🇦🇹 Österreich</option>
                                    <option value="de">🇩🇪 Deutschland</option>
                                    <option value="custom_macro">🌍 Anderes Land</option>
                                </select>
                                <input class="mb-input" id="caConfLandCustom" placeholder="Land beschreiben..." style="display:none;width:100%;box-sizing:border-box;margin-top:6px;font-size:12px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                            </div>
                        </div>

                        <!-- Branche -->
                        <div style="padding:14px 16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)" id="caConfBranche">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <span style="font-size:11px;text-transform:uppercase;color:var(--text-muted);font-weight:600;letter-spacing:0.5px">🏢 Branche</span>
                                <span onclick="caConfirmEdit('branche')" style="font-size:11px;color:var(--accent);cursor:pointer;text-decoration:underline">ändern</span>
                            </div>
                            <div id="caConfBrancheValue" style="font-size:15px;font-weight:600;color:var(--white)">–</div>
                            <div id="caConfBrancheEdit" style="display:none;margin-top:8px">
                                <select class="mb-input" id="caConfBrancheSelect" onchange="caConfirmPick('branche')" style="width:100%;box-sizing:border-box;font-size:13px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--accent)">
                                    <option value="finance">🏦 Finanzdienstleistung</option>
                                    <option value="health">🏥 Gesundheit</option>
                                    <option value="public">🏛️ Öffentlicher Sektor</option>
                                    <option value="energy">⚡ Energie</option>
                                    <option value="retail">🛍️ Retail / Handel</option>
                                    <option value="tech">💻 Technologie</option>
                                    <option value="education">🎓 Bildung</option>
                                    <option value="custom_meso">🏢 Andere Branche</option>
                                </select>
                                <input class="mb-input" id="caConfBrancheCustom" placeholder="Branche beschreiben..." style="display:none;width:100%;box-sizing:border-box;margin-top:6px;font-size:12px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                            </div>
                        </div>

                        <!-- Organisation -->
                        <div style="padding:14px 16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)" id="caConfOrg">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <span style="font-size:11px;text-transform:uppercase;color:var(--text-muted);font-weight:600;letter-spacing:0.5px">🏢 Organisation</span>
                                <span onclick="caConfirmEdit('org')" style="font-size:11px;color:var(--accent);cursor:pointer;text-decoration:underline">ändern</span>
                            </div>
                            <div id="caConfOrgValue" style="font-size:15px;font-weight:600;color:var(--white)">–</div>
                            <div id="caConfOrgEdit" style="display:none;margin-top:8px">
                                <select class="mb-input" id="caConfOrgSelect" onchange="caConfirmPick('org')" style="width:100%;box-sizing:border-box;font-size:13px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--accent)">
                                    <option value="company">🏢 Unternehmen</option>
                                    <option value="public">🏛️ Behörde / Öffentlich</option>
                                    <option value="healthcare">🏥 Gesundheitseinrichtung</option>
                                    <option value="general">👤 Allgemein</option>
                                </select>
                                <input class="mb-input" id="caConfOrgCustom" placeholder="Konkretes Unternehmen (optional)..." style="width:100%;box-sizing:border-box;margin-top:6px;font-size:12px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                            </div>
                        </div>

                        <!-- Perspektive -->
                        <div style="padding:14px 16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)" id="caConfPersp">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <span style="font-size:11px;text-transform:uppercase;color:var(--text-muted);font-weight:600;letter-spacing:0.5px">👁️ Perspektive</span>
                                <span onclick="caConfirmEdit('persp')" style="font-size:11px;color:var(--accent);cursor:pointer;text-decoration:underline">ändern</span>
                            </div>
                            <div id="caConfPerspValue" style="font-size:15px;font-weight:600;color:var(--white)">–</div>
                            <div id="caConfPerspEdit" style="display:none;margin-top:8px">
                                <select class="mb-input" id="caConfPerspSelect" onchange="caConfirmPick('persp')" style="width:100%;box-sizing:border-box;font-size:13px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--accent)">
                                    <option value="kunden">🛒 Kunden</option>
                                    <option value="mitarbeitende">👔 Mitarbeitende</option>
                                    <option value="management">📊 Management</option>
                                    <option value="alle">🔄 Alle Perspektiven (Strategie)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="caBack(0)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" onclick="caConfirmDone()" id="caConfirmBtn">✅ Stimmt — weiter zur Situation →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ SMART STEP 2: SITUATION (Scenario-based) ═══ -->
            <div class="mb-panel" id="caStepScenarios">
                <div class="mb-step-title">In welcher Situation?</div>
                <div class="mb-step-desc" id="caScenarioDesc">Wähle ein typisches Szenario oder beschreibe die Situation selbst.</div>

                <div id="caScenarioLoading" style="padding:30px;text-align:center">
                    <div class="spinner" style="margin:0 auto 12px"></div>
                    <div style="font-size:13px;color:rgba(255,255,255,0.5)">Typische Szenarien werden generiert...</div>
                </div>

                <div id="caScenarioCards" style="display:none">
                    <div class="mb-choices" id="caScenarioChoices">
                        <!-- Filled by JS -->
                    </div>

                    <!-- Custom scenario (collapsed by default) -->
                    <div id="caCustomScenario" style="display:none;margin-top:16px;padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:12px">🎨 Eigenes Szenario definieren</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
                            <select class="mb-input" id="caMicroWhere" style="font-size:12px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                                <option value="">📍 Ort...</option>
                                <option value="home">🏠 Zuhause</option>
                                <option value="workplace">🏢 Arbeitsplatz</option>
                                <option value="store">🛒 Geschäft</option>
                                <option value="online">💻 Online / App</option>
                                <option value="public">🚶 Unterwegs</option>
                                <option value="healthcare">🏥 Arztpraxis / Behörde</option>
                            </select>
                            <select class="mb-input" id="caMicroSocial" style="font-size:12px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                                <option value="">👥 Wer dabei...</option>
                                <option value="solo">🙋 Allein</option>
                                <option value="dyadic">🤝 Zu zweit</option>
                                <option value="small_group">👨‍👩‍👧 Kleine Gruppe</option>
                                <option value="large_group">🏛️ Grosse Gruppe</option>
                                <option value="anonymous">🌐 Anonym</option>
                            </select>
                            <select class="mb-input" id="caMicroTime" style="font-size:12px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                                <option value="">⏰ Zeitrahmen...</option>
                                <option value="urgent">⚡ Sofort</option>
                                <option value="moderate">📅 Tage/Wochen</option>
                                <option value="relaxed">🌿 Viel Zeit</option>
                                <option value="recurring">🔄 Wiederkehrend</option>
                            </select>
                            <select class="mb-input" id="caMicroCognitive" style="font-size:12px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                                <option value="">🧠 Zustand...</option>
                                <option value="analytical">🔬 Aufmerksam</option>
                                <option value="intuitive">💨 Autopilot</option>
                                <option value="stressed">😰 Gestresst</option>
                                <option value="fatigued">😴 Erschöpft</option>
                                <option value="motivated">🔥 Motiviert</option>
                            </select>
                        </div>
                        <textarea class="mb-input mb-textarea" id="caMicroNotes" placeholder="Besondere Umstände..." style="min-height:50px;width:100%;box-sizing:border-box;font-size:12px"></textarea>
                    </div>

                    <div class="mb-actions" style="margin-top:16px">
                        <button class="mb-btn mb-btn-back" onclick="caBack(1)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" id="caScenarioBtn" disabled onclick="caAnalyzeFromScenario()">🔍 Kontextprofil erstellen →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ OLD STEPS (hidden, used for edit fallback) ═══ -->
            <!-- ═══ STEP 1: MACRO ═══ -->
            <div class="mb-panel" id="caStep1">
                <div id="caStep1ViewA">
                    <div class="mb-step-title">Land & Rahmenbedingungen</div>
                    <div class="mb-step-desc">In welchem Land und regulatorischen Umfeld findet die Entscheidung statt?</div>
                    <div class="mb-choices" id="caStep1Choices">
                        <div class="mb-choice" onclick="caSelect(this,'ch')">
                            <div class="mb-choice-num">1</div>
                            <div class="mb-choice-icon">🇨🇭</div>
                            <div class="mb-choice-title">Schweiz</div>
                            <div class="mb-choice-desc">Direkte Demokratie, hohe Eigenverantwortung, Konsenskultur, wohlhabend.</div>
                            <div class="mb-choice-meta">DACH-CH</div>
                        </div>
                        <div class="mb-choice" onclick="caSelect(this,'at')">
                            <div class="mb-choice-num">2</div>
                            <div class="mb-choice-icon">🇦🇹</div>
                            <div class="mb-choice-title">Österreich</div>
                            <div class="mb-choice-desc">Sozialpartnerschaft, EU-Recht, Gemeinschaftskultur, starke Traditionen.</div>
                            <div class="mb-choice-meta">DACH-AT</div>
                        </div>
                        <div class="mb-choice" onclick="caSelect(this,'de')">
                            <div class="mb-choice-num">3</div>
                            <div class="mb-choice-icon">🇩🇪</div>
                            <div class="mb-choice-title">Deutschland</div>
                            <div class="mb-choice-desc">Föderalismus, EU-Recht, Sicherheitskultur, grösste EU-Volkswirtschaft.</div>
                            <div class="mb-choice-meta">DACH-DE</div>
                        </div>
                        <div class="mb-choice custom-choice" onclick="caSelect(this,'custom_macro')">
                            <div class="mb-choice-num">✎</div>
                            <div class="mb-choice-icon">🌍</div>
                            <div class="mb-choice-title">Anderes Land</div>
                            <div class="mb-choice-desc">Land, Regeln und kulturellen Rahmen frei beschreiben.</div>
                            <div class="mb-choice-meta">→ Freitext</div>
                        </div>
                    </div>
                    <div id="caCustomMacro" style="display:none;margin-bottom:16px">
                        <input class="mb-input" id="caMacroCustom" placeholder="Land/Region und institutioneller Rahmen beschreiben..." style="width:100%;box-sizing:border-box">
                    </div>
                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="caBack(0)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" id="caStep1Btn" disabled onclick="caNextStep(1)">Weiter →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ STEP 2: MESO ═══ -->
            <div class="mb-panel" id="caStep2">
                <div class="mb-step-title">Branche & Umfeld</div>
                <div class="mb-step-desc">In welcher Branche und welchem organisatorischen Umfeld bewegt sich die Person?</div>
                <div class="mb-choices" id="caStep2Choices">
                    <div class="mb-choice" onclick="caSelect(this,'finance')">
                        <div class="mb-choice-num">1</div>
                        <div class="mb-choice-icon">🏦</div>
                        <div class="mb-choice-title">Finanzdienstleistung</div>
                        <div class="mb-choice-desc">Reguliert, hohes Vertrauen erforderlich, lange Entscheidungszyklen.</div>
                    </div>
                    <div class="mb-choice" onclick="caSelect(this,'health')">
                        <div class="mb-choice-num">2</div>
                        <div class="mb-choice-icon">🏥</div>
                        <div class="mb-choice-title">Gesundheit</div>
                        <div class="mb-choice-desc">Asymmetrische Information, hohe Emotionalität, Expert-Laie-Dynamik.</div>
                    </div>
                    <div class="mb-choice" onclick="caSelect(this,'public')">
                        <div class="mb-choice-num">3</div>
                        <div class="mb-choice-icon">🏛️</div>
                        <div class="mb-choice-title">Öffentlicher Sektor</div>
                        <div class="mb-choice-desc">Politische Rahmenbedingungen, Bürger als Zielgruppe, Gemeinwohl.</div>
                    </div>
                    <div class="mb-choice custom-choice" onclick="caSelect(this,'custom_meso')">
                        <div class="mb-choice-num">✎</div>
                        <div class="mb-choice-icon">🏢</div>
                        <div class="mb-choice-title">Andere Branche</div>
                        <div class="mb-choice-desc">Industrie, Energie, Bildung, Technologie, Retail...</div>
                    </div>
                </div>
                <div id="caCustomMeso" style="display:none;margin-bottom:16px">
                    <input class="mb-input" id="caMesoCustom" placeholder="Branche, Unternehmensgrösse und Marktumfeld beschreiben..." style="width:100%;box-sizing:border-box">
                </div>
                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="caBack(1)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="caStep2Btn" disabled onclick="caGoToOrg()">Weiter →</button>
                </div>
            </div>

            <!-- ═══ STEP 3: ORGANISATION ═══ -->
            <div class="mb-panel" id="caStepOrg">
                <div class="mb-step-title">Für welche Organisation?</div>
                <div class="mb-step-desc">Wähle ein bestehendes Unternehmen aus dem CRM oder lege ein neues an.</div>

                <div class="mb-choices" id="caOrgTypeChoices">
                    <div class="mb-choice" onclick="caSelectOrgType(this,'company')">
                        <div class="mb-choice-num">1</div>
                        <div class="mb-choice-icon">🏢</div>
                        <div class="mb-choice-title">Unternehmen</div>
                        <div class="mb-choice-desc">Privatwirtschaftliches Unternehmen — Bank, Versicherung, Industrie, etc.</div>
                    </div>
                    <div class="mb-choice" onclick="caSelectOrgType(this,'public')">
                        <div class="mb-choice-num">2</div>
                        <div class="mb-choice-icon">🏛️</div>
                        <div class="mb-choice-title">Behörde / Öffentliche Institution</div>
                        <div class="mb-choice-desc">Verwaltung, Regulierungsbehörde, staatliche Organisation.</div>
                    </div>
                    <div class="mb-choice" onclick="caSelectOrgType(this,'healthcare')">
                        <div class="mb-choice-num">3</div>
                        <div class="mb-choice-icon">🏥</div>
                        <div class="mb-choice-title">Gesundheitseinrichtung</div>
                        <div class="mb-choice-desc">Spital, Krankenkasse, Pflegeeinrichtung, Praxis.</div>
                    </div>
                    <div class="mb-choice" onclick="caSelectOrgType(this,'general')">
                        <div class="mb-choice-num">4</div>
                        <div class="mb-choice-icon">👤</div>
                        <div class="mb-choice-title">Allgemein / kein spezifisches Unternehmen</div>
                        <div class="mb-choice-desc">Grundlagenanalyse für einen Markt oder eine Zielgruppe, ohne konkreten Kunden.</div>
                    </div>
                </div>

                <!-- CRM Search (appears when company/public/healthcare selected) -->
                <div id="caOrgSearch" style="display:none;margin-top:16px">
                    <div style="padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:10px">🔍 Bestehender Kunde aus CRM</div>
                        <input class="mb-input" id="caOrgSearchInput" placeholder="Name eingeben zum Suchen..." oninput="caSearchOrg()" style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border);margin-bottom:10px">
                        <div id="caOrgResults" style="max-height:200px;overflow-y:auto"></div>
                        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
                            <button class="mb-btn mb-btn-secondary" onclick="caNewOrg()" style="font-size:12px;padding:6px 14px">➕ Neue Organisation anlegen</button>
                        </div>
                    </div>
                </div>

                <!-- New Org Form (appears on click) -->
                <div id="caNewOrgForm" style="display:none;margin-top:16px">
                    <div style="padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:10px">➕ Neue Organisation</div>
                        <input class="mb-input" id="caNewOrgName" placeholder="Name der Organisation" style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border);margin-bottom:8px">
                        <input class="mb-input" id="caNewOrgDesc" placeholder="Kurzbeschreibung (optional)" style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                    </div>
                </div>

                <div class="mb-actions" style="margin-top:16px">
                    <button class="mb-btn mb-btn-back" onclick="caBackToStep('caStep2',2)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="caOrgBtn" disabled onclick="caGoToPersp()">Weiter →</button>
                </div>
            </div>

            <!-- ═══ STEP 4: PERSPEKTIVE ═══ -->
            <div class="mb-panel" id="caStepPersp">
                <div class="mb-step-title">Wessen Verhalten analysieren wir?</div>
                <div class="mb-step-desc" id="caPerspDesc">Aus welcher Perspektive soll der Kontext verstanden werden?</div>

                <div class="mb-choices" id="caPerspChoices">
                    <div class="mb-choice" onclick="caSelectPersp(this,'kunden')">
                        <div class="mb-choice-num">1</div>
                        <div class="mb-choice-icon">🛒</div>
                        <div class="mb-choice-title">Kunden</div>
                        <div class="mb-choice-desc">Wie erleben die Kunden die Entscheidungssituation? Was treibt ihr Verhalten?</div>
                    </div>
                    <div class="mb-choice" onclick="caSelectPersp(this,'mitarbeitende')">
                        <div class="mb-choice-num">2</div>
                        <div class="mb-choice-icon">👔</div>
                        <div class="mb-choice-title">Mitarbeitende</div>
                        <div class="mb-choice-desc">Wie verhalten sich Berater, Sachbearbeiter, Pflegende im Arbeitsalltag?</div>
                    </div>
                    <div class="mb-choice" onclick="caSelectPersp(this,'management')">
                        <div class="mb-choice-num">3</div>
                        <div class="mb-choice-icon">📊</div>
                        <div class="mb-choice-title">Management / Entscheider</div>
                        <div class="mb-choice-desc">Wie trifft die Geschäftsleitung strategische Entscheidungen?</div>
                    </div>
                    <div class="mb-choice" onclick="caSelectPersp(this,'alle')">
                        <div class="mb-choice-num">4</div>
                        <div class="mb-choice-icon">🔄</div>
                        <div class="mb-choice-title">Alle Perspektiven (Strategie)</div>
                        <div class="mb-choice-desc">Ganzheitliche Analyse über alle Stakeholder — ideal für strategische Projekte.</div>
                    </div>
                </div>

                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="caBackToStep('caStepOrg',3)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="caPerspBtn" disabled onclick="caGoToSituation()">Weiter →</button>
                </div>
            </div>

            <!-- ═══ STEP 5: SITUATION (was STEP 3: MICRO) ═══ -->
            <div class="mb-panel" id="caStep3">
                <div class="mb-step-title">Die konkrete Situation</div>
                <div class="mb-step-desc">In welcher Situation befindet sich die Person, wenn sie die Entscheidung trifft?</div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px">
                    <div style="padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:4px">📍 Wo passiert es?</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">Der physische oder digitale Ort der Entscheidung</div>
                        <select class="mb-input" id="caMicroWhere" onchange="caUpdateMicroBtn()" style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                            <option value="">Ort wählen...</option>
                            <option value="home">🏠 Zuhause — entspannte Umgebung</option>
                            <option value="workplace">🏢 Am Arbeitsplatz — professionelles Umfeld</option>
                            <option value="store">🛒 Im Geschäft — beim Einkaufen</option>
                            <option value="online">💻 Online / App — am Bildschirm</option>
                            <option value="public">🚶 Unterwegs / öffentlicher Raum</option>
                            <option value="healthcare">🏥 Arztpraxis / Behörde — formelles Setting</option>
                        </select>
                    </div>
                    <div style="padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:4px">👥 Wer ist dabei?</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">Sozialer Druck beeinflusst Entscheidungen massiv</div>
                        <select class="mb-input" id="caMicroSocial" onchange="caUpdateMicroBtn()" style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                            <option value="">Situation wählen...</option>
                            <option value="solo">🙋 Allein — niemand schaut zu</option>
                            <option value="dyadic">🤝 Zu zweit — Berater, Partner, Kollege</option>
                            <option value="small_group">👨‍👩‍👧 Kleine Gruppe — Team, Familie, Freunde</option>
                            <option value="large_group">🏛️ Grosse Gruppe — Organisation, Gremium</option>
                            <option value="anonymous">🌐 Anonym — Online-Community, Masse</option>
                        </select>
                    </div>
                    <div style="padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:4px">⏰ Wie viel Zeit bleibt?</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">Zeitdruck verändert wie Menschen entscheiden</div>
                        <select class="mb-input" id="caMicroTime" onchange="caUpdateMicroBtn()" style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                            <option value="">Zeitrahmen wählen...</option>
                            <option value="urgent">⚡ Sofort — muss jetzt entschieden werden</option>
                            <option value="moderate">📅 Tage bis Wochen — etwas Bedenkzeit</option>
                            <option value="relaxed">🌿 Viel Zeit — Monate, kein Druck</option>
                            <option value="recurring">🔄 Wiederkehrend — Routine-Entscheidung</option>
                        </select>
                    </div>
                    <div style="padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:4px">🧠 In welchem Zustand?</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">Der mentale Zustand bestimmt die Entscheidungsqualität</div>
                        <select class="mb-input" id="caMicroCognitive" onchange="caUpdateMicroBtn()" style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                            <option value="">Zustand wählen...</option>
                            <option value="analytical">🔬 Aufmerksam — denkt gründlich nach</option>
                            <option value="intuitive">💨 Auf Autopilot — entscheidet aus dem Bauch</option>
                            <option value="stressed">😰 Gestresst — viel um die Ohren</option>
                            <option value="fatigued">😴 Erschöpft — am Ende eines langen Tages</option>
                            <option value="motivated">🔥 Motiviert — will aktiv etwas verändern</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom:16px">
                    <textarea class="mb-input mb-textarea" id="caMicroNotes" placeholder="Optional: Gibt es besondere Umstände? Z.B. 'Kurz vor Pensionierung', 'Gerade Kinder bekommen', 'Neuer Job'..." style="min-height:60px;width:100%;box-sizing:border-box;font-size:13px"></textarea>
                </div>

                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="caBackToStep('caStepPersp',4)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="caStep3Btn" disabled onclick="caAnalyze()">🔍 Kontextprofil erstellen →</button>
                </div>
            </div>

            <!-- ═══ STEP 4: Ψ-Profil ═══ -->
            <div class="mb-panel" id="caStep4">
                <div class="mb-step-title">Kontextprofil wird erstellt...</div>
                <div class="mb-step-desc">BEATRIX analysiert die 8 Ψ-Dimensionen basierend auf deinen Angaben und der BCM2-Kontextdatenbank.</div>

                <div id="caAnalysisProgress" style="padding:40px;text-align:center">
                    <div class="spinner" style="margin:0 auto 16px"></div>
                    <div style="font-size:14px;color:rgba(255,255,255,0.6)" id="caAnalysisStatus">Kontextdatenbank wird geladen...</div>
                </div>

                <div id="caAnalysisResult" style="display:none">
                    <!-- Context Breadcrumb -->
                    <div id="caResultBreadcrumb" style="display:none;flex-wrap:wrap;gap:6px;margin-bottom:16px"></div>

                    <!-- Allgemeine Perspektive: Big Picture -->
                    <div id="caPerspectiveBox" style="padding:20px 24px;background:linear-gradient(135deg,rgba(27,54,93,0.4),rgba(27,54,93,0.15));border:1px solid rgba(139,170,255,0.2);border-radius:var(--radius);margin-bottom:20px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                            <span style="font-size:20px">🔭</span>
                            <div style="font-size:15px;font-weight:700;color:var(--white)">Allgemeine Perspektive</div>
                        </div>
                        <div id="caPerspectiveText" style="font-size:14px;color:rgba(255,255,255,0.88);line-height:1.85"></div>
                    </div>

                    <!-- Ψ Dimension Cards -->
                    <div id="caPsiCards" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px"></div>

                    <!-- Context Story: Plain Language Translation -->
                    <div id="caStoryBox" style="padding:20px;background:linear-gradient(135deg,rgba(42,127,142,0.08),rgba(232,163,61,0.05));border:1px solid rgba(42,127,142,0.25);border-radius:var(--radius);margin-bottom:16px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
                            <span style="font-size:20px">🌍</span>
                            <div style="font-size:15px;font-weight:700;color:var(--white)">Was bedeutet das konkret?</div>
                        </div>
                        <div id="caStoryText" style="font-size:14px;color:rgba(255,255,255,0.85);line-height:1.8;margin-bottom:16px"></div>
                        <div id="caStoryDims" style="display:flex;flex-direction:column;gap:8px"></div>
                    </div>

                    <!-- Parameter Implications -->
                    <div id="caParamBox" style="padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px">
                        <div style="font-size:14px;font-weight:600;color:var(--white);margin-bottom:10px">📐 Parameter-Implikationen</div>
                        <div id="caParams" style="font-size:13px;color:rgba(255,255,255,0.7);line-height:1.7"></div>
                    </div>

                    <!-- AI Analysis -->
                    <div id="caInsightBox" style="padding:16px;background:rgba(139,170,255,0.05);border:1px solid rgba(139,170,255,0.15);border-radius:var(--radius);margin-bottom:16px">
                        <div style="font-size:14px;font-weight:600;color:var(--accent-light);margin-bottom:10px">💡 Kontext-Synthese</div>
                        <div id="caInsight" style="font-size:13px;color:rgba(255,255,255,0.75);line-height:1.7"></div>
                    </div>

                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="caBack(3)">← Zurück</button>
                        <button class="mb-btn mb-btn-secondary" id="caSaveBtn" onclick="caSaveAndUse()">💾 Speichern</button>
                        <button class="mb-btn mb-btn-secondary" id="caDeepenBtn" onclick="caDeepen()" style="display:none;background:rgba(255,170,0,0.15);border-color:rgba(255,170,0,0.4);color:#ffaa00">🔍 Kontext vertiefen</button>
                        <button class="mb-btn mb-btn-primary" onclick="caUseInChat()">💬 Im Chat verwenden →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ HISTORY: Bisherige Analysen ═══ -->
            <div class="mb-panel" id="caHistory">
                <div class="mb-step-title">Bisherige Kontextanalysen</div>
                <div class="mb-step-desc">Gespeicherte Kontextprofile aus früheren Analysen.</div>
                <div id="caHistoryList" style="display:flex;flex-direction:column;gap:10px">
                    <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">Wird geladen...</div>
                </div>
                <div class="mb-actions" style="margin-top:16px">
                    <button class="mb-btn mb-btn-back" onclick="caGoToStart()">← Neue Analyse</button>
                </div>
            </div>
        </div>
    </section>

    <!-- ═══════ BRIEFING SECTION ═══════ -->
    <section class="section" id="briefing-section">
        <div class="container">
            <div class="section-header">
                <h2>Briefing</h2>
                <p>Starte mit dem, was du hast — BEATRIX holt dich ab und leitet dich weiter.</p>
            </div>
            <div style="max-width:800px;margin:0 auto">

                <!-- STEP 1: Entry Type Selection -->
                <div id="brfStep1">
                    <div style="font-size:16px;font-weight:600;color:var(--white);margin-bottom:6px;text-align:center">Womit startest du?</div>
                    <div style="font-size:13px;color:var(--text-muted);margin-bottom:24px;text-align:center">Wähle deinen Ausgangspunkt — BEATRIX führt dich von dort aus weiter.</div>

                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px" id="brfTypeCards">
                        <div class="mb-choice" style="padding:20px 16px;text-align:center;cursor:pointer" onclick="brfSelectType('frage')">
                            <div style="font-size:32px;margin-bottom:10px">🔍</div>
                            <div style="font-size:14px;font-weight:600;color:var(--white);margin-bottom:6px">Eine Frage</div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Warum tun oder lassen Menschen etwas? Ein Verhalten, das ich verstehen will.</div>
                        </div>
                        <div class="mb-choice" style="padding:20px 16px;text-align:center;cursor:pointer" onclick="brfSelectType('kunde')">
                            <div style="font-size:32px;margin-bottom:10px">🏢</div>
                            <div style="font-size:14px;font-weight:600;color:var(--white);margin-bottom:6px">Ein Kunde</div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Eine Organisation kommt mit einem Anliegen. Ich kenne den Kunden.</div>
                        </div>
                        <div class="mb-choice" style="padding:20px 16px;text-align:center;cursor:pointer" onclick="brfSelectType('ziel')">
                            <div style="font-size:32px;margin-bottom:10px">🎯</div>
                            <div style="font-size:14px;font-weight:600;color:var(--white);margin-bottom:6px">Ein Ziel</div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">So soll es in Zukunft aussehen. Ein Soll-Zustand oder eine Ambition.</div>
                        </div>
                        <div class="mb-choice" style="padding:20px 16px;text-align:center;cursor:pointer" onclick="brfSelectType('loesung')">
                            <div style="font-size:32px;margin-bottom:10px">🛠️</div>
                            <div style="font-size:14px;font-weight:600;color:var(--white);margin-bottom:6px">Eine Lösung</div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Wir haben ein Produkt, eine Massnahme oder eine Intervention — wird sie wirken?</div>
                        </div>
                        <div class="mb-choice" style="padding:20px 16px;text-align:center;cursor:pointer" onclick="brfSelectType('daten')">
                            <div style="font-size:32px;margin-bottom:10px">📊</div>
                            <div style="font-size:14px;font-weight:600;color:var(--white);margin-bottom:6px">Eine Beobachtung</div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Die Zahlen zeigen etwas Unerwartetes. Ein Gap, ein Trend, eine Anomalie.</div>
                        </div>
                        <div class="mb-choice" style="padding:20px 16px;text-align:center;cursor:pointer" onclick="brfSelectType('sorge')">
                            <div style="font-size:32px;margin-bottom:10px">🚫</div>
                            <div style="font-size:14px;font-weight:600;color:var(--white);margin-bottom:6px">Eine Sorge</div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Das darf auf keinen Fall passieren. Ein Risiko, das ich vermeiden will.</div>
                        </div>
                    </div>
                </div>

                <!-- STEP 2: Type-specific detail -->
                <div id="brfStep2" style="display:none">
                    <button class="mb-btn mb-btn-back" onclick="brfBack()" style="margin-bottom:16px">← Zurück</button>
                    <div id="brfStep2Header" style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
                        <span id="brfStep2Icon" style="font-size:32px"></span>
                        <div>
                            <div id="brfStep2Title" style="font-size:16px;font-weight:700;color:var(--white)"></div>
                            <div id="brfStep2Subtitle" style="font-size:13px;color:var(--text-muted)"></div>
                        </div>
                    </div>

                    <!-- Dynamic content per type -->
                    <div id="brfStep2Content"></div>

                    <!-- Common: describe more -->
                    <div style="margin-top:20px;padding:20px;background:var(--navy-card);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:8px" id="brfDetailLabel">Beschreibe es genauer</div>
                        <textarea class="mb-input mb-textarea" id="brfDetailInput" style="min-height:80px;width:100%;box-sizing:border-box;font-size:14px;line-height:1.6"></textarea>
                        <div style="margin-top:12px">
                            <button class="mb-btn mb-btn-primary" onclick="brfAnalyze()" id="brfAnalyzeBtn">🧠 BEATRIX, analysiere das →</button>
                        </div>
                    </div>
                </div>

                <!-- STEP 3: AI Result + Routing -->
                <div id="brfStep3" style="display:none">
                    <button class="mb-btn mb-btn-back" onclick="brfBackTo2()" style="margin-bottom:16px">← Zurück</button>
                    <div id="briefingResult"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- ═══════ SEGMENTS SECTION ═══════ -->
    <section class="section" id="segments-section">
        <div class="container">
            <div class="section-header">
                <h2>Segment-Analyse</h2>
                <p>Wer ist die Zielgruppe? Verhaltensbasierte Segmentierung jenseits von Demografie.</p>
            </div>
            <div style="text-align:center;padding:60px 20px">
                <div style="font-size:48px;margin-bottom:16px">👥</div>
                <div style="font-size:18px;font-weight:600;color:var(--white);margin-bottom:8px">Segment-Analyse</div>
                <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto;line-height:1.6">Verhaltensbasierte Segmente identifizieren: Nicht wer Menschen <em>sind</em>, sondern wie sie <em>entscheiden</em>. Basierend auf Ψ-Profilen, nicht Demografie.</div>
                <div style="margin-top:20px;padding:12px 20px;background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.2);border-radius:var(--radius);display:inline-block;font-size:13px;color:var(--accent-light)">🚧 In Entwicklung — Q2 2026</div>
            </div>
        </div>
    </section>

    <!-- ═══════ JOURNEY SECTION ═══════ -->
    <section class="section" id="journey-section">
        <div class="container">
            <div class="section-header">
                <h2>Behavioral Journey</h2>
                <p>Wo stehen die Menschen im Veränderungsprozess? Von Awareness über Readiness zu Action.</p>
            </div>
            <div style="text-align:center;padding:60px 20px">
                <div style="font-size:48px;margin-bottom:16px">🗺️</div>
                <div style="font-size:18px;font-weight:600;color:var(--white);margin-bottom:8px">Behavioral Change Journey</div>
                <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto;line-height:1.6">Die Reise vom Nicht-Wissen zum Handeln: Awareness → Consideration → Readiness → Action → Habit. Für jede Stufe andere Interventionen.</div>
                <div style="margin-top:20px;padding:12px 20px;background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.2);border-radius:var(--radius);display:inline-block;font-size:13px;color:var(--accent-light)">🚧 In Entwicklung — Q2 2026</div>
            </div>
        </div>
    </section>

    <!-- ═══════ NUTZEN SECTION ═══════ -->
    <section class="section" id="nutzen-section">
        <div class="container">
            <div class="section-header">
                <h2>Nutzen & Anreize</h2>
                <p>Was treibt die Entscheidung? Wahrgenommener Nutzen, Kosten und Barrieren.</p>
            </div>
            <div style="text-align:center;padding:60px 20px">
                <div style="font-size:48px;margin-bottom:16px">💎</div>
                <div style="font-size:18px;font-weight:600;color:var(--white);margin-bottom:8px">Nutzen- & Anreizanalyse</div>
                <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto;line-height:1.6">Was gewinnen Menschen durch eine Veränderung? Was verlieren sie? Welche Barrieren stehen im Weg — real und wahrgenommen?</div>
                <div style="margin-top:20px;padding:12px 20px;background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.2);border-radius:var(--radius);display:inline-block;font-size:13px;color:var(--accent-light)">🚧 In Entwicklung — Q2 2026</div>
            </div>
        </div>
    </section>

    <!-- ═══════ ARCHITEKTUR SECTION ═══════ -->
    <section class="section" id="architektur-section">
        <div class="container">
            <div class="section-header">
                <h2>Entscheidungsarchitektur</h2>
                <p>Wie wird die Entscheidung präsentiert? Touchpoints, Defaults, Framing, Choice Architecture.</p>
            </div>
            <div style="text-align:center;padding:60px 20px">
                <div style="font-size:48px;margin-bottom:16px">⚖️</div>
                <div style="font-size:18px;font-weight:600;color:var(--white);margin-bottom:8px">Entscheidungsarchitektur</div>
                <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto;line-height:1.6">Defaults, Framing, Sequencing, Social Proof — die konkreten Hebel, mit denen Entscheidungen gestaltet werden. Wo, wann und wie die Intervention ansetzt.</div>
                <div style="margin-top:20px;padding:12px 20px;background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.2);border-radius:var(--radius);display:inline-block;font-size:13px;color:var(--accent-light)">🚧 In Entwicklung — Q3 2026</div>
            </div>
        </div>
    </section>

    <!-- ═══════ AUDIT SECTION ═══════ -->
    <section class="section" id="audit-section">
        <div class="container">
            <div class="section-header">
                <h2>Behavioral Audit</h2>
                <p>Ist-Zustand erheben: Was passiert heute? Baseline für Verhaltensveränderung.</p>
            </div>
            <div style="text-align:center;padding:60px 20px">
                <div style="font-size:48px;margin-bottom:16px">📊</div>
                <div style="font-size:18px;font-weight:600;color:var(--white);margin-bottom:8px">Behavioral Audit</div>
                <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto;line-height:1.6">Systematische Bestandsaufnahme: Welches Verhalten zeigt die Zielgruppe heute? KPIs, Conversion Rates, Drop-offs — die Baseline vor jeder Intervention.</div>
                <div style="margin-top:20px;padding:12px 20px;background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.2);border-radius:var(--radius);display:inline-block;font-size:13px;color:var(--accent-light)">🚧 In Entwicklung — Q3 2026</div>
            </div>
        </div>
    </section>

    <!-- ═══════ WIRKUNG SECTION ═══════ -->
    <section class="section" id="wirkung-section">
        <div class="container">
            <div class="section-header">
                <h2>Wirkungsmessung</h2>
                <p>Hat die Intervention gewirkt? Vorher/Nachher, Effect Sizes, RCT-Ergebnisse.</p>
            </div>
            <div style="text-align:center;padding:60px 20px">
                <div style="font-size:48px;margin-bottom:16px">📈</div>
                <div style="font-size:18px;font-weight:600;color:var(--white);margin-bottom:8px">Wirkungsmessung</div>
                <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto;line-height:1.6">Soll vs. Ist: Was hat die Intervention bewirkt? Effect Size berechnen, statistische Signifikanz prüfen, ROI der Verhaltensänderung dokumentieren.</div>
                <div style="margin-top:20px;padding:12px 20px;background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.2);border-radius:var(--radius);display:inline-block;font-size:13px;color:var(--accent-light)">🚧 In Entwicklung — Q3 2026</div>
            </div>
        </div>
    </section>

    <!-- ═══════ EVIDENZ SECTION ═══════ -->
    <section class="section" id="evidenz-section">
        <div class="container">
            <div class="section-header">
                <h2>Evidenz-Check</h2>
                <p>Was sagt die Forschung? Theorien, Studien und empirische Evidenz prüfen.</p>
            </div>
            <div style="text-align:center;padding:60px 20px">
                <div style="font-size:48px;margin-bottom:16px">🧪</div>
                <div style="font-size:18px;font-weight:600;color:var(--white);margin-bottom:8px">Evidenz-Check</div>
                <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto;line-height:1.6">186 Theorien, 200+ Mechanismen, 94 Parameter in der BEATRIX-Wissensdatenbank. Welche Evidenz stützt unseren Ansatz? Wo sind die Grenzen?</div>
                <div style="margin-top:20px;padding:12px 20px;background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.2);border-radius:var(--radius);display:inline-block;font-size:13px;color:var(--accent-light)">🚧 In Entwicklung — Q2 2026</div>
            </div>
        </div>
    </section>

    <!-- ═══════ LEADS SECTION ═══════ -->
    <section class="section" id="leads-section">
        <div class="container">
            <div class="section-header">
                <h2>CRM</h2>
                <p>Pipeline, Kontakte und Lead-Management. <span id="crmDateInfo" style="color:rgba(255,255,255,0.3)"></span></p>
            </div>

            <!-- KPI Cards -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:20px" id="crmKpis">
                <div onclick="crmShowLeadTimeline()" style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:border-color 0.2s" onmouseover="this.style.borderColor='rgba(255,255,255,0.15)'" onmouseout="this.style.borderColor='var(--border)'">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Aktive Leads ↗</div>
                    <div id="crmKpiActive" style="font-size:24px;font-weight:700;color:white;margin:4px 0">–</div>
                </div>
                <div style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Pipeline (gew.)</div>
                    <div id="crmKpiPipeline" style="font-size:24px;font-weight:700;color:var(--accent-light);margin:4px 0">–</div>
                </div>
                <div style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Won</div>
                    <div id="crmKpiWon" style="font-size:24px;font-weight:700;color:#34d399;margin:4px 0">–</div>
                </div>
                <div style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Conversion</div>
                    <div id="crmKpiConv" style="font-size:24px;font-weight:700;color:#fbbf24;margin:4px 0">–</div>
                </div>
                <div onclick="crmShowCompanies()" style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:border-color 0.2s" onmouseover="this.style.borderColor='rgba(255,255,255,0.15)'" onmouseout="this.style.borderColor='var(--border)'">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Firmen ↗</div>
                    <div id="crmKpiCompanies" style="font-size:24px;font-weight:700;color:rgba(255,255,255,0.6);margin:4px 0">–</div>
                </div>
            </div>

            <!-- View Toggle + Actions -->
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap">
                <div style="display:flex;border:1px solid var(--border);border-radius:8px;overflow:hidden">
                    <button class="fb-tool active" id="crmViewKanban" onclick="crmSetView('kanban')" style="border:none;border-radius:0;font-size:12px">▣ Kanban</button>
                    <button class="fb-tool" id="crmViewTable" onclick="crmSetView('table')" style="border:none;border-radius:0;font-size:12px">☰ Tabelle</button>
                </div>
                <div style="flex:1"></div>
                <input type="text" id="crmSearchInput" placeholder="🔍 Lead suchen..." oninput="crmSearchFilter(this.value)" style="background:rgba(255,255,255,0.06);border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:12px;color:white;width:200px;outline:none" />
                <button class="mb-btn mb-btn-primary" onclick="crmShowDealForm()" style="font-size:12px;padding:6px 14px">+ Neuer Lead</button>
                <button class="mb-btn mb-btn-back" onclick="crmSyncGithub()" style="font-size:12px;padding:6px 14px" id="crmSyncBtn">🔄 Synchronisieren</button>
            </div>

            <!-- Sync Hint -->
            <div id="crmSyncHint" style="display:none;padding:20px;background:rgba(139,170,255,0.06);border:1px solid rgba(139,170,255,0.15);border-radius:12px;margin-bottom:16px;text-align:center;cursor:pointer" onclick="crmSyncGithub()">
                <div style="font-size:14px;color:white;margin-bottom:6px">🔄 60 Leads verfügbar</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-bottom:12px">Klicke hier um die Lead-Datenbank zu synchronisieren.</div>
                <button class="mb-btn mb-btn-primary" onclick="event.stopPropagation();crmSyncGithub()" style="font-size:13px;padding:10px 28px;cursor:pointer">Jetzt synchronisieren</button>
            </div>

            <!-- New Deal Form (hidden) -->
            <div id="crmDealForm" style="display:none;padding:20px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px;margin-bottom:16px">
                <div style="font-size:14px;font-weight:600;color:white;margin-bottom:12px" id="crmDealFormTitle">Neuer Lead</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <input class="mb-input" id="crmDealTitle" placeholder="Lead-Titel / Projekt" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealCompany" placeholder="Firma" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealContact" placeholder="Kontaktperson" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealEmail" placeholder="E-Mail" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealValue" placeholder="Wert (CHF)" type="number" style="font-size:13px;padding:8px 12px">
                    <select class="mb-input" id="crmDealStage" style="font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                        <option value="prospect">Prospect</option>
                        <option value="qualified">Qualified</option>
                        <option value="proposal">Proposal</option>
                        <option value="negotiation">Negotiation</option>
                        <option value="won">Won</option>
                        <option value="active">Active</option>
                    </select>
                    <input class="mb-input" id="crmDealSource" placeholder="Quelle" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealNextAction" placeholder="Nächste Aktion" style="font-size:13px;padding:8px 12px">
                </div>
                <textarea class="mb-input" id="crmDealNotes" placeholder="Notizen..." style="font-size:13px;padding:8px 12px;margin-top:10px;min-height:50px;width:100%;box-sizing:border-box"></textarea>
                <div style="display:flex;gap:8px;margin-top:12px">
                    <button class="mb-btn mb-btn-primary" onclick="crmSaveDeal()" style="font-size:12px;padding:6px 14px">Speichern</button>
                    <button class="mb-btn mb-btn-back" onclick="document.getElementById('crmDealForm').style.display='none'" style="font-size:12px;padding:6px 14px">Abbrechen</button>
                </div>
            </div>

            <!-- Kanban Board -->
            <!-- Company Filter Banner -->
            <div id="crmFilterBanner" style="display:none;align-items:center;gap:10px;padding:10px 16px;background:rgba(42,127,142,0.08);border:1px solid rgba(42,127,142,0.2);border-radius:10px;margin-bottom:12px">
                <span style="font-size:12px;color:#2A7F8E">🏢 Gefiltert nach Firma</span>
                <span style="flex:1"></span>
                <button onclick="crmClearFilter()" style="font-size:11px;padding:4px 12px;background:rgba(42,127,142,0.15);color:#2A7F8E;border:1px solid rgba(42,127,142,0.3);border-radius:8px;cursor:pointer">✕ Filter aufheben</button>
            </div>

            <div id="crmKanban" style="display:flex;gap:10px;overflow-x:auto;padding-bottom:12px;min-height:300px">
                <!-- Columns injected by JS -->
            </div>

            <!-- Table View (hidden) -->
            <div id="crmTable" style="display:none;overflow-x:auto">
                <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">Laden...</div>
            </div>
        </div>
    </section>

    <!-- Deal Detail Drawer -->
    <div id="crmDrawer" style="display:none;position:fixed;top:0;right:0;bottom:0;width:min(440px,90vw);z-index:9000;background:var(--navy-card);border-left:1px solid var(--border);box-shadow:-8px 0 30px rgba(0,0,0,0.4);overflow-y:auto;transition:transform 0.25s ease">
        <div style="padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px">
            <div style="flex:1">
                <div style="font-size:16px;font-weight:700;color:white" id="crmDrawerTitle">Lead</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.4)" id="crmDrawerCompany">Firma</div>
            </div>
            <button onclick="crmCloseDrawer()" style="border:none;background:none;color:rgba(255,255,255,0.4);font-size:18px;cursor:pointer;padding:4px">✕</button>
        </div>
        <div id="crmDrawerContent" style="padding:16px"></div>
    </div>

    <!-- Companies Section (full page) -->
    <section class="section" id="companies-section">
        <div class="container">
            <!-- List View -->
            <div id="companiesListView">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap">
                    <div style="flex:1">
                        <h2 style="margin:0;font-size:22px;color:white">🏢 Firmen</h2>
                        <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px" id="crmCompaniesCount"></div>
                    </div>
                    <input id="crmCompaniesSearch" type="text" placeholder="Suchen…" oninput="crmFilterCompanies()" style="font-size:13px;padding:8px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:10px;color:white;width:min(240px,40vw);outline:none">
                    <button class="mb-btn mb-btn-primary" onclick="crmToggleCompanyForm()" style="font-size:12px;padding:6px 14px">+ Neue Firma</button>
                </div>
                <!-- New Company Form -->
                <div id="crmCompanyForm" style="display:none;margin-bottom:16px;padding:20px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:14px;font-weight:600;color:white;margin-bottom:14px">🏢 Neue Firma anlegen</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        <div style="position:relative">
                            <label style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Firmenname * <span id="zefixStatus" style="color:#4dd0e1;font-size:9px;margin-left:6px"></span></label>
                            <input id="ncName" type="text" placeholder="z.B. Swisscom AG, BMW AG – sucht in CH 🇨🇭 + DE 🇩🇪" oninput="registryAutoSearch()" style="width:100%;box-sizing:border-box;padding:8px 12px;margin-top:4px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;outline:none">
                            <div id="zefixResults" style="display:none;position:absolute;top:100%;left:0;right:0;z-index:100;background:#1a2744;border:1px solid var(--border);border-radius:0 0 10px 10px;max-height:280px;overflow-y:auto;box-shadow:0 8px 24px rgba(0,0,0,0.5)"></div>
                        </div>
                        <div>
                            <label style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Kürzel (3-5 Buchstaben)</label>
                            <input id="ncCode" type="text" placeholder="z.B. SWC" maxlength="6" style="width:100%;box-sizing:border-box;padding:8px 12px;margin-top:4px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;outline:none;text-transform:uppercase">
                        </div>
                        <div>
                            <label style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Branche</label>
                            <select id="ncIndustry" style="width:100%;box-sizing:border-box;padding:8px 12px;margin-top:4px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;outline:none">
                                <option value="">– Auswählen –</option>
                                <option value="finance">Finanz</option>
                                <option value="insurance">Versicherung</option>
                                <option value="retail">Handel</option>
                                <option value="fmcg">FMCG</option>
                                <option value="construction">Bau</option>
                                <option value="packaging">Verpackung</option>
                                <option value="public_sector">Öffentlicher Sektor</option>
                                <option value="telecom">Telekom</option>
                                <option value="media">Medien</option>
                                <option value="automotive">Automobil</option>
                                <option value="pharma_health">Pharma / Health</option>
                                <option value="manufacturing">Industrie</option>
                                <option value="technology">Technologie</option>
                                <option value="energy">Energie</option>
                                <option value="transport">Transport</option>
                                <option value="creative">Kreativ</option>
                                <option value="ngo">NGO / Verband</option>
                                <option value="consulting">Consulting</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Land</label>
                            <select id="ncCountry" style="width:100%;box-sizing:border-box;padding:8px 12px;margin-top:4px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;outline:none">
                                <option value="CH">🇨🇭 Schweiz</option>
                                <option value="AT">🇦🇹 Österreich</option>
                                <option value="DE">🇩🇪 Deutschland</option>
                                <option value="SE">🇸🇪 Schweden</option>
                                <option value="UK">🇬🇧 UK</option>
                                <option value="US">🇺🇸 USA</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Website</label>
                            <input id="ncWebsite" type="text" placeholder="z.B. www.swisscom.ch" style="width:100%;box-sizing:border-box;padding:8px 12px;margin-top:4px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;outline:none">
                        </div>
                        <div>
                            <label style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Owner</label>
                            <select id="ncOwner" style="width:100%;box-sizing:border-box;padding:8px 12px;margin-top:4px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;outline:none">
                                <option value="GF">GF – Gerhard Fehr</option>
                                <option value="AF">AF – Andrea Fehr</option>
                                <option value="MR">MR</option>
                                <option value="MdL">MdL</option>
                                <option value="AJ">AJ</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top:10px">
                        <label style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Notizen</label>
                        <input id="ncNotes" type="text" placeholder="Optional" style="width:100%;box-sizing:border-box;padding:8px 12px;margin-top:4px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;outline:none">
                    </div>
                    <div style="display:flex;gap:8px;margin-top:14px;justify-content:flex-end">
                        <button onclick="crmToggleCompanyForm()" class="mb-btn mb-btn-back" style="font-size:12px;padding:6px 14px">Abbrechen</button>
                        <button onclick="crmSaveNewCompany()" class="mb-btn mb-btn-primary" style="font-size:12px;padding:6px 14px" id="ncSaveBtn">Firma anlegen</button>
                    </div>
                </div>
                <!-- Category Cards -->
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px" id="companyCategoryCards">
                    <div class="comp-card" data-cat="active" onclick="companySetCategory('active',this)" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.15s;text-align:center">
                        <div style="font-size:28px;margin-bottom:6px">🟢</div>
                        <div style="font-size:22px;font-weight:700;color:white" id="catCountActive">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">Aktive Projekte</div>
                    </div>
                    <div class="comp-card" data-cat="leads" onclick="companySetCategory('leads',this)" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.15s;text-align:center">
                        <div style="font-size:28px;margin-bottom:6px">🟡</div>
                        <div style="font-size:22px;font-weight:700;color:white" id="catCountLeads">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">Leads</div>
                    </div>
                    <div class="comp-card" data-cat="past" onclick="companySetCategory('past',this)" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.15s;text-align:center">
                        <div style="font-size:28px;margin-bottom:6px">🔵</div>
                        <div style="font-size:22px;font-weight:700;color:white" id="catCountPast">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">Frühere Projekte</div>
                    </div>
                    <div class="comp-card" data-cat="new" onclick="companySetCategory('new',this)" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.15s;text-align:center">
                        <div style="font-size:28px;margin-bottom:6px">⚪</div>
                        <div style="font-size:22px;font-weight:700;color:white" id="catCountNew">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">Noch nie gearbeitet</div>
                    </div>
                </div>
                <div id="companyFilterBanner" style="display:none;margin-bottom:12px;padding:8px 16px;background:rgba(42,127,142,0.06);border:1px solid rgba(42,127,142,0.15);border-radius:8px;align-items:center;gap:8px">
                    <span style="font-size:12px;color:rgba(255,255,255,0.5)" id="companyFilterLabel"></span>
                    <span onclick="companySetCategory('all')" style="font-size:11px;color:var(--accent);cursor:pointer;margin-left:auto">✕ Alle zeigen</span>
                </div>
                <div id="crmCompaniesList" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
            </div>

            <!-- Profile View (hidden by default) -->
            <div id="companiesProfileView" style="display:none">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap">
                    <button onclick="companyBackToList()" style="font-size:12px;padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);cursor:pointer">← Alle Firmen</button>
                    <h2 style="margin:0;font-size:22px;color:white" id="companyProfileName"></h2>
                    <span style="font-size:12px;color:rgba(255,255,255,0.3)" id="companyProfileCode"></span>
                    <span id="companyProfileCatBadge"></span>
                </div>
                <div id="companyProfileContent"></div>
            </div>
        </div>
    </section>

    <!-- Projects Section -->
    <!-- ═══════ MY PROJECTS (Kundenprojekte) ═══════ -->
    <section class="section" id="myprojects-section">
        <div class="container">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap">
                <div style="flex:1">
                    <h2 style="margin:0;font-size:22px;color:white">📋 Projekte</h2>
                    <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px" id="myPrjSubtitle"></div>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                    <div id="myPrjToggle" style="display:flex;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;overflow:hidden">
                        <button onclick="myPrjSetScope('mine')" id="myPrjToggleMine" style="padding:6px 14px;font-size:12px;font-weight:600;border:none;cursor:pointer;transition:all 0.15s;background:var(--accent);color:white">Meine</button>
                        <button onclick="myPrjSetScope('all')" id="myPrjToggleAll" style="padding:6px 14px;font-size:12px;font-weight:600;border:none;cursor:pointer;transition:all 0.15s;background:transparent;color:rgba(255,255,255,0.4);display:none">Alle</button>
                    </div>
                    <select id="myPrjFilter" onchange="myPrjRender()" style="padding:6px 12px;background:var(--navy-card);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.7);font-size:12px;cursor:pointer">
                        <option value="all">Alle Status</option>
                        <option value="active">Aktiv</option>
                        <option value="planning">In Planung</option>
                        <option value="completed">Abgeschlossen</option>
                    </select>
                    <button onclick="prjStartWizard();showSection('projects')" style="padding:8px 18px;background:linear-gradient(135deg,var(--accent),#2A7F8E);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s">+ Neues Projekt</button>
                </div>
            </div>
            <!-- KPI Cards -->
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px" id="myPrjKpis">
                <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:22px;font-weight:700;color:#34d399" id="myPrjActive">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">Aktiv</div>
                </div>
                <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:22px;font-weight:700;color:#fbbf24" id="myPrjPlanning">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">In Planung</div>
                </div>
                <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:22px;font-weight:700;color:rgba(139,170,255,0.6)" id="myPrjDone">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">Abgeschlossen</div>
                </div>
                <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:22px;font-weight:700;color:white" id="myPrjTotal">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">Meine Total</div>
                </div>
            </div>
            <div id="myPrjList" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
        </div>
    </section>

    <section class="section" id="projects-section">
        <div class="container">
            <!-- Projects List View -->
            <div id="prjListView">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap">
                    <div style="flex:1">
                        <h2 style="margin:0;font-size:22px;color:white">📋 Projekte</h2>
                        <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px" id="prjCount"></div>
                    </div>
                    <button onclick="prjStartWizard()" style="padding:8px 18px;background:linear-gradient(135deg,var(--accent),#2A7F8E);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s">+ Neues Projekt</button>
                </div>
                <!-- KPI Cards -->
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px">
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                        <div style="font-size:22px;font-weight:700;color:#34d399" id="prjCountActive">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4)">Aktiv</div>
                    </div>
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                        <div style="font-size:22px;font-weight:700;color:#fbbf24" id="prjCountPlanning">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4)">In Planung</div>
                    </div>
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                        <div style="font-size:22px;font-weight:700;color:rgba(139,170,255,0.6)" id="prjCountCompleted">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4)">Abgeschlossen</div>
                    </div>
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                        <div style="font-size:22px;font-weight:700;color:white" id="prjCountTotal">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4)">Total</div>
                    </div>
                </div>
                <div id="prjList" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
            </div>

            <!-- Wizard View -->
            <div id="prjWizardView" style="display:none">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
                    <button onclick="prjCancelWizard()" style="font-size:12px;padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);cursor:pointer">← Abbrechen</button>
                    <h2 style="margin:0;font-size:20px;color:white">Neues Projekt eröffnen</h2>
                </div>

                <!-- Mode Selector -->
                <div id="prjModeSelector" style="display:flex;gap:12px;margin-bottom:24px">
                    <div class="prj-mode-card active" data-mode="schnell" onclick="prjSetMode('schnell')" style="flex:1;background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.15s;text-align:center">
                        <div style="font-size:24px;margin-bottom:8px">⚡</div>
                        <div style="font-size:14px;font-weight:600;color:white">Schnell</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:4px">Firma wählen, Rest auto-fill<br>~30 Sekunden</div>
                    </div>
                    <div class="prj-mode-card" data-mode="gefuehrt" onclick="prjSetMode('gefuehrt')" style="flex:1;background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.15s;text-align:center">
                        <div style="font-size:24px;margin-bottom:8px">🧭</div>
                        <div style="font-size:14px;font-weight:600;color:white">Geführt</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:4px">5 Schritte, vollständig<br>~5 Minuten</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div id="prjProgress" style="display:none;margin-bottom:24px">
                    <div style="display:flex;gap:4px" id="prjProgressSteps"></div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.3);margin-top:6px" id="prjProgressLabel"></div>
                </div>

                <!-- Step 1: Firma & Lead -->
                <div class="prj-step" id="prjStep1" style="display:none">
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:16px">1 · Firma & Lead wählen</div>
                        <div style="margin-bottom:16px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Firma *</label>
                            <select id="prjFirma" onchange="prjOnFirmaChange()" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px">
                                <option value="">Firma auswählen…</option>
                            </select>
                        </div>
                        <div id="prjFirmaInfo" style="display:none;padding:12px;background:rgba(42,127,142,0.05);border:1px solid rgba(42,127,142,0.15);border-radius:8px;margin-bottom:16px;font-size:12px;color:rgba(255,255,255,0.5)"></div>
                        <div style="margin-bottom:16px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Lead verknüpfen (optional)</label>
                            <select id="prjLead" onchange="prjOnLeadChange()" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px">
                                <option value="">Kein Lead / Neues Projekt</option>
                            </select>
                        </div>
                        <div id="prjLeadInfo" style="display:none;padding:12px;background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.1);border-radius:8px;font-size:12px;color:rgba(255,255,255,0.5)"></div>
                        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:20px">
                            <button onclick="prjGoStep(2)" id="prjStep1Next" disabled style="padding:8px 20px;background:var(--accent);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer;opacity:0.5">Weiter →</button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Projektdefinition -->
                <div class="prj-step" id="prjStep2" style="display:none">
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:16px">2 · Projektdefinition</div>
                        <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px">
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Projektname *</label>
                                <input id="prjName" type="text" placeholder="z.B. Off-Site Kader 2026" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;box-sizing:border-box">
                            </div>
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Typ *</label>
                                <select id="prjType" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px">
                                    <option value="beratung">Beratung</option>
                                    <option value="workshop">Workshop / Off-Site</option>
                                    <option value="studie">Studie / Research</option>
                                    <option value="intervention">Intervention</option>
                                    <option value="keynote">Keynote / Vortrag</option>
                                    <option value="training">Training / Schulung</option>
                                    <option value="retainer">Retainer / laufend</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:16px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:8px">Projektkategorie *</label>
                            <div style="display:flex;gap:8px" id="prjCategoryCards">
                                <div onclick="prjSelectCategory(this,'mandat')" data-cat="mandat" style="flex:1;padding:14px;background:rgba(52,211,153,0.06);border:2px solid rgba(52,211,153,0.3);border-radius:10px;cursor:pointer;text-align:center;transition:all 0.15s" class="prj-cat-card active">
                                    <div style="font-size:22px">💼</div>
                                    <div style="font-size:12px;font-weight:600;color:#34d399;margin-top:4px">Mandat</div>
                                    <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:2px">Bezahltes Projekt</div>
                                </div>
                                <div onclick="prjSelectCategory(this,'lead')" data-cat="lead" style="flex:1;padding:14px;background:rgba(255,255,255,0.02);border:2px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;transition:all 0.15s" class="prj-cat-card">
                                    <div style="font-size:22px">🎯</div>
                                    <div style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.5);margin-top:4px">Lead</div>
                                    <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:2px">Akquise / Offerte</div>
                                </div>
                                <div onclick="prjSelectCategory(this,'probono')" data-cat="probono" style="flex:1;padding:14px;background:rgba(255,255,255,0.02);border:2px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;transition:all 0.15s" class="prj-cat-card">
                                    <div style="font-size:22px">🤝</div>
                                    <div style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.5);margin-top:4px">Pro Bono</div>
                                    <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:2px">Unentgeltlich</div>
                                </div>
                            </div>
                            <input type="hidden" id="prjCategory" value="mandat">
                        </div>
                        <div style="margin-top:16px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Beschreibung / Ziele</label>
                            <textarea id="prjDesc" rows="3" placeholder="Was soll erreicht werden?" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;resize:vertical;box-sizing:border-box"></textarea>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-top:20px">
                            <button onclick="prjGoStep(1)" style="padding:8px 20px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:13px;cursor:pointer">← Zurück</button>
                            <button onclick="prjGoStep(3)" style="padding:8px 20px;background:var(--accent);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer">Weiter →</button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Timeline & Budget -->
                <div class="prj-step" id="prjStep3" style="display:none">
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:16px">3 · Timeline & Budget</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Startdatum</label>
                                <input id="prjStart" type="date" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;box-sizing:border-box">
                            </div>
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Enddatum</label>
                                <input id="prjEnd" type="date" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;box-sizing:border-box">
                            </div>
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Budget (CHF)</label>
                                <input id="prjBudget" type="number" placeholder="z.B. 85000" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;box-sizing:border-box">
                            </div>
                        </div>
                        <div style="margin-top:16px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Abrechnungsmodell</label>
                            <div style="display:flex;gap:8px">
                                <label style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;color:rgba(255,255,255,0.6)"><input type="radio" name="prjBilling" value="fixed" checked> Fixpreis</label>
                                <label style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;color:rgba(255,255,255,0.6)"><input type="radio" name="prjBilling" value="time_material"> Time & Material</label>
                                <label style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;color:rgba(255,255,255,0.6)"><input type="radio" name="prjBilling" value="retainer"> Retainer</label>
                            </div>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-top:20px">
                            <button onclick="prjGoStep(2)" style="padding:8px 20px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:13px;cursor:pointer">← Zurück</button>
                            <button onclick="prjGoStep(4)" style="padding:8px 20px;background:var(--accent);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer">Weiter →</button>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Team -->
                <div class="prj-step" id="prjStep4" style="display:none">
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:16px">4 · Team</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">FA Owner / Projektleiter *</label>
                                <select id="prjOwner" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px">
                                    <option value="GF">Gerhard Fehr (GF)</option>
                                    <option value="MFA">Michael Fehr (MFA)</option>
                                    <option value="NGS">Nora Gavazaj Susuri (NGS)</option>
                                    <option value="AFA">Andrea Fehr (AFA)</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">FA Teammitglieder</label>
                                <input id="prjTeam" type="text" placeholder="z.B. MFA, NGS" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;box-sizing:border-box">
                            </div>
                        </div>
                        <div style="margin-top:16px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Kunden-Ansprechpartner</label>
                            <div id="prjClientContacts" style="font-size:12px;color:rgba(255,255,255,0.5);padding:8px 0">Wird aus Firma/Lead geladen…</div>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-top:20px">
                            <button onclick="prjGoStep(3)" style="padding:8px 20px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:13px;cursor:pointer">← Zurück</button>
                            <button onclick="prjGoStep(5)" style="padding:8px 20px;background:var(--accent);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer">Review →</button>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Review & Eröffnen -->
                <div class="prj-step" id="prjStep5" style="display:none">
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:16px">5 · Review & Eröffnen</div>
                        <div id="prjReviewContent" style="font-size:13px;color:rgba(255,255,255,0.7);line-height:1.8"></div>
                        <div style="display:flex;justify-content:space-between;margin-top:20px">
                            <button onclick="prjGoStep(4)" style="padding:8px 20px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:13px;cursor:pointer">← Zurück</button>
                            <button onclick="prjCreate()" id="prjCreateBtn" style="padding:10px 24px;background:linear-gradient(135deg,#34d399,#2A7F8E);border:none;border-radius:8px;color:white;font-size:14px;font-weight:700;cursor:pointer">✓ Projekt eröffnen → GitHub</button>
                        </div>
                    </div>
                </div>

                <!-- Schnell Mode Panel -->
                <div id="prjSchnellPanel" style="display:none">
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:16px">⚡ Schnell-Eröffnung</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Firma *</label>
                                <select id="prjSchnellFirma" onchange="prjSchnellAutoFill()" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px">
                                    <option value="">Firma auswählen…</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Projektname *</label>
                                <input id="prjSchnellName" type="text" placeholder="Projektname" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;box-sizing:border-box">
                            </div>
                        </div>
                        <div id="prjSchnellPreview" style="display:none;padding:14px;background:rgba(42,127,142,0.05);border:1px solid rgba(42,127,142,0.15);border-radius:8px;margin-bottom:16px;font-size:12px;color:rgba(255,255,255,0.5);line-height:1.6"></div>
                        <button onclick="prjSchnellCreate()" id="prjSchnellBtn" disabled style="width:100%;padding:12px;background:linear-gradient(135deg,#34d399,#2A7F8E);border:none;border-radius:8px;color:white;font-size:14px;font-weight:700;cursor:pointer;opacity:0.5">✓ Jetzt eröffnen → GitHub</button>
                    </div>
                </div>
            </div>

            <!-- Project Landing Page (Hybrid Tab Layout) -->
            <div id="prjLandingView" style="display:none">
                <!-- Sticky Header -->
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                    <button onclick="prjBackToList()" id="prjBackBtn" style="font-size:12px;padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);cursor:pointer">← Projekte</button>
                </div>

                <!-- Project Header Card -->
                <div id="prjLandingHeader" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:0"></div>

                <!-- 3 Main Tabs -->
                <div id="prjTabBar" style="display:flex;gap:2px;padding:12px 0 0 0;margin-bottom:0;border-bottom:1px solid var(--border)">
                    <div class="prj-tab active" data-tab="overview" onclick="prjSwitchMainTab('overview')" style="flex:1;text-align:center;font-weight:700">🏠 Übersicht</div>
                    <div class="prj-tab" data-tab="inhalt" onclick="prjSwitchMainTab('inhalt')" style="flex:1;text-align:center;font-weight:700">🧠 Inhalt</div>
                    <div class="prj-tab" data-tab="pm" onclick="prjSwitchMainTab('pm')" style="flex:1;text-align:center;font-weight:700">📋 PM</div>
                </div>

                <!-- ═══ TAB: ÜBERSICHT ═══ -->
                <div class="prj-main-tab-content active" id="prjMainOverview" style="padding-top:20px">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
                        <div>
                            <div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Verfügbare Ressourcen</div>
                            <div id="prjLandingResources" style="display:flex;flex-direction:column;gap:8px"></div>
                        </div>
                        <div>
                            <div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Projektdaten</div>
                            <div id="prjLandingData" style="display:flex;flex-direction:column;gap:8px"></div>
                        </div>
                    </div>
                    <div id="prjLandingOtherSection" style="margin-top:20px;display:none">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                            <div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:1px">🔗 Verknüpfte Projekte</div>
                            <div style="display:flex;gap:6px">
                                <button onclick="prjLinkProjectStart()" style="font-size:10px;padding:3px 10px;background:rgba(42,127,142,0.08);border:1px solid rgba(42,127,142,0.2);border-radius:6px;color:var(--accent);cursor:pointer;font-family:inherit">+ Projekt verknüpfen</button>
                                <button onclick="prjToggleLinkedPanel()" style="font-size:10px;padding:3px 8px;background:none;border:1px solid var(--border);border-radius:6px;color:var(--text-muted);cursor:pointer;font-family:inherit">✕</button>
                            </div>
                        </div>
                        <div id="prjLandingOther" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
                    </div>

                    <!-- Project Chat (identical to main chat) -->
                    <div style="margin-top:24px">
                        <div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">💬 Frage zu diesem Projekt</div>
                        <div style="background:var(--navy-deep);border:1px solid var(--border);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;max-height:600px">
                            <div class="chat-messages" id="prjChatMessages" style="flex:1;min-height:120px;max-height:460px;padding:16px">
                                <div id="prjChatWelcome" style="text-align:center;padding:24px 20px">
                                    <div style="font-size:24px;margin-bottom:8px">🧠</div>
                                    <div style="font-size:13px;color:var(--text-secondary);line-height:1.6">BEATRIX kennt den Projektkontext.<br>Stelle Fragen — Ergebnisse werden im Projekt gespeichert.</div>
                                </div>
                            </div>
                            <div class="chat-input-area" style="padding:12px 16px 16px">
                                <div id="prjChatAttachments" style="display:none;padding:0 0 8px;display:flex;flex-wrap:wrap;gap:6px"></div>
                                <div class="chat-input-wrap">
                                    <input type="file" id="prjChatFileInput" style="display:none" accept=".pdf,.txt,.md,.csv,.json,.docx,.ics,.png,.jpg,.jpeg,.gif,.webp" onchange="prjChatFileSelected(this)" multiple>
                                    <button onclick="document.getElementById('prjChatFileInput').click()" style="width:42px;height:42px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition);flex-shrink:0;color:var(--text-muted);font-size:16px" title="Datei anhängen">📎</button>
                                    <textarea class="chat-input" id="prjChatInput" placeholder="z.B. Erstelle eine Kontext-Analyse für dieses Projekt..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();prjChatSend()}" oninput="autoResize(this)"></textarea>
                                    <button class="chat-send-btn" onclick="prjChatSend()" id="prjChatSendBtn" title="Senden">
                                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ═══ TAB: INHALT (Behavioral Design im Projektkontext) ═══ -->
                <div class="prj-main-tab-content" id="prjMainInhalt" style="padding-top:20px">
                    <div style="font-size:13px;color:var(--text-muted);margin-bottom:20px">Behavioral Design Arbeit für dieses Projekt — alle Analysen und Modelle werden hier gespeichert.</div>

                    <!-- Inhalt Module Cards -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" id="prjInhaltModules">
                        <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:rgba(255,255,255,0.25);letter-spacing:1px;grid-column:1/-1;padding:4px 0">VERSTEHEN</div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('context')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">🔬</span>
                                <div style="font-size:14px;font-weight:700;color:white">Kontext-Analyse</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Land, Branche, Situation → Ψ-Profil</div>
                            <div id="prjModStatus_context" style="margin-top:8px"></div>
                        </div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('segmente')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">👥</span>
                                <div style="font-size:14px;font-weight:700;color:white">Segment-Analyse</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Zielgruppen identifizieren & verstehen</div>
                            <div id="prjModStatus_segmente" style="margin-top:8px"></div>
                        </div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('journey')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">🗺️</span>
                                <div style="font-size:14px;font-weight:700;color:white">Behavioral Journey</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Awareness → Readiness → Action</div>
                            <div id="prjModStatus_journey" style="margin-top:8px"></div>
                        </div>

                        <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:rgba(255,255,255,0.25);letter-spacing:1px;grid-column:1/-1;padding:12px 0 4px 0">GESTALTEN</div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('nutzen')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">💎</span>
                                <div style="font-size:14px;font-weight:700;color:white">Nutzen & Anreize</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Nutzen, Kosten, Barrieren</div>
                            <div id="prjModStatus_nutzen" style="margin-top:8px"></div>
                        </div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('architektur')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">⚖️</span>
                                <div style="font-size:14px;font-weight:700;color:white">Entscheidungsarchitektur</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Touchpoints, Defaults, Framing</div>
                            <div id="prjModStatus_architektur" style="margin-top:8px"></div>
                        </div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('model')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">🏗️</span>
                                <div style="font-size:14px;font-weight:700;color:white">Modell-Building</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">EEE-Workflow: Gesamtmodell bauen</div>
                            <div id="prjModStatus_model" style="margin-top:8px"></div>
                        </div>

                        <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:rgba(255,255,255,0.25);letter-spacing:1px;grid-column:1/-1;padding:12px 0 4px 0">MESSEN & PRÜFEN</div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('audit')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">📊</span>
                                <div style="font-size:14px;font-weight:700;color:white">Behavioral Audit</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Ist-Zustand erheben</div>
                            <div id="prjModStatus_audit" style="margin-top:8px"></div>
                        </div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('wirkung')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">📈</span>
                                <div style="font-size:14px;font-weight:700;color:white">Wirkungsmessung</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Soll vs. Ist</div>
                            <div id="prjModStatus_wirkung" style="margin-top:8px"></div>
                        </div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('evidenz')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">🧪</span>
                                <div style="font-size:14px;font-weight:700;color:white">Evidenz-Check</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Forschung, Theorien & Daten</div>
                            <div id="prjModStatus_evidenz" style="margin-top:8px"></div>
                        </div>
                    </div>
                </div>

                <!-- ═══ TAB: PM (Projektmanagement) ═══ -->
                <div class="prj-main-tab-content" id="prjMainPm" style="padding-top:12px">
                    <!-- PM Sub-Tabs -->
                    <div style="display:flex;gap:2px;overflow-x:auto;padding:0 0 0 0;margin-bottom:20px;border-bottom:1px solid var(--border);scrollbar-width:thin">
                        <div class="prj-tab active" data-tab="auftrag" onclick="prjSwitchTab('auftrag')">📋 Auftrag</div>
                        <div class="prj-tab" data-tab="planung" onclick="prjSwitchTab('planung')">📅 Planung</div>
                        <div class="prj-tab" data-tab="meetings" onclick="prjSwitchTab('meetings')">📝 Meetings</div>
                        <div class="prj-tab" data-tab="deliverables" onclick="prjSwitchTab('deliverables')">📦 Deliverables</div>
                        <div class="prj-tab" data-tab="dokumente" onclick="prjSwitchTab('dokumente')">📄 Dokumente</div>
                        <div class="prj-tab" data-tab="budget" onclick="prjSwitchTab('budget')">💰 Budget</div>
                        <div class="prj-tab" data-tab="risiken" onclick="prjSwitchTab('risiken')">⚠ Risiken</div>
                        <div class="prj-tab" data-tab="kommunikation" onclick="prjSwitchTab('kommunikation')">💬 Komm.</div>
                        <div class="prj-tab" data-tab="learnings" onclick="prjSwitchTab('learnings')">📊 Learnings</div>
                    </div>

                    <!-- PM Sub-Tab Contents -->
                    <div class="prj-tab-content active" id="prjTabAuftrag">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
                                <div style="font-size:16px;font-weight:700;color:white">📋 Beratungsauftrag</div>
                                <button onclick="prjStartEdit('auftrag')" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.4);font-size:12px;cursor:pointer">✏ Bearbeiten</button>
                            </div>
                            <div id="prjAuftragContent" style="font-size:13px;color:rgba(255,255,255,0.7);line-height:1.8"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabPlanung">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
                                <div style="font-size:16px;font-weight:700;color:white">📅 Projektplanung</div>
                                <button onclick="prjStartEdit('planung')" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.4);font-size:12px;cursor:pointer">✏ Bearbeiten</button>
                            </div>
                            <div id="prjPlanungContent" style="font-size:13px;color:rgba(255,255,255,0.7);line-height:1.8"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabMeetings">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
                                <div style="font-size:16px;font-weight:700;color:white">📝 Meetings & Protokolle</div>
                                <button onclick="prjAddMeeting()" style="padding:6px 14px;background:var(--accent);border:none;border-radius:8px;color:white;font-size:12px;font-weight:600;cursor:pointer">+ Neues Meeting</button>
                            </div>
                            <div id="prjMeetingsContent" style="font-size:13px;color:rgba(255,255,255,0.7)"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabDeliverables">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
                                <div style="font-size:16px;font-weight:700;color:white">📦 Deliverables & Ergebnisse</div>
                                <button onclick="prjStartEdit('deliverables')" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.4);font-size:12px;cursor:pointer">✏ Bearbeiten</button>
                            </div>
                            <div id="prjDeliverablesContent" style="font-size:13px;color:rgba(255,255,255,0.7)"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabDokumente">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="font-size:16px;font-weight:700;color:white;margin-bottom:20px">📄 Dokumente</div>
                            <div id="prjDokumenteContent" style="font-size:13px;color:rgba(255,255,255,0.7)"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabBudget">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
                                <div style="font-size:16px;font-weight:700;color:white">💰 Budget & Abrechnung</div>
                                <button onclick="prjStartEdit('budget')" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.4);font-size:12px;cursor:pointer">✏ Bearbeiten</button>
                            </div>
                            <div id="prjBudgetContent" style="font-size:13px;color:rgba(255,255,255,0.7)"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabRisiken">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
                                <div style="font-size:16px;font-weight:700;color:white">⚠ Risiken & Entscheidungen</div>
                                <button onclick="prjStartEdit('risiken')" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.4);font-size:12px;cursor:pointer">✏ Bearbeiten</button>
                            </div>
                            <div id="prjRisikenContent" style="font-size:13px;color:rgba(255,255,255,0.7)"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabKommunikation">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="font-size:16px;font-weight:700;color:white;margin-bottom:20px">💬 Kommunikation</div>
                            <div id="prjKommunikationContent" style="font-size:13px;color:rgba(255,255,255,0.7)"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabLearnings">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="font-size:16px;font-weight:700;color:white;margin-bottom:20px">📊 Learnings & Evaluation</div>
                            <div id="prjLearningsContent" style="font-size:13px;color:rgba(255,255,255,0.7)"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ═══════ TASKS SECTION ═══════ -->
    <section class="section" id="tasks-section">
        <div class="container">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap">
                <div style="flex:1">
                    <h2 style="margin:0;font-size:22px;color:white">✅ Tasks</h2>
                    <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px" id="taskCount"></div>
                </div>
                <button onclick="showNewTaskModal()" style="padding:8px 18px;background:linear-gradient(135deg,var(--accent),#2A7F8E);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer">+ Neue Aufgabe</button>
            </div>
            <!-- KPI Cards -->
            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px" id="taskKpis">
                <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:22px;font-weight:700;color:#ef4444" id="taskOverdue">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">Überfällig</div>
                </div>
                <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:22px;font-weight:700;color:#fbbf24" id="taskDueToday">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">Heute fällig</div>
                </div>
                <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:22px;font-weight:700;color:rgba(139,170,255,0.8)" id="taskDueWeek">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">Diese Woche</div>
                </div>
                <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:22px;font-weight:700;color:#34d399" id="taskActive">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">Offen</div>
                </div>
                <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:22px;font-weight:700;color:rgba(255,255,255,0.3)" id="taskDone">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">Erledigt</div>
                </div>
            </div>
            <!-- Filters -->
            <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap" id="taskFilters">
                <button class="task-filter active" data-filter="active" onclick="filterTasks('active',this)">Alle offenen</button>
                <button class="task-filter" data-filter="consultant" onclick="filterTasks('consultant',this)">👤 Berater</button>
                <button class="task-filter" data-filter="bdm" onclick="filterTasks('bdm',this)">🏢 BDM</button>
                <button class="task-filter" data-filter="beatrix" onclick="filterTasks('beatrix',this)">🤖 BEATRIX</button>
                <button class="task-filter" data-filter="external" onclick="filterTasks('external',this)">🔄 Extern</button>
                <button class="task-filter" data-filter="done" onclick="filterTasks('done',this)">✓ Erledigt</button>
            </div>
            <!-- Task List -->
            <div id="taskList" style="display:flex;flex-direction:column;gap:8px"></div>
        </div>
    </section>

    <section class="section" id="admin-section">
        <div class="container">
            <div class="section-header"><h2>⚙ Administration</h2><p>Benutzer verwalten und Systemeinstellungen konfigurieren.</p></div>
            <div class="admin-cards" id="adminCards">
                <div class="admin-card"><div class="admin-card-label">Benutzer</div><div class="admin-card-value" id="adminStatUsers">–</div><div class="admin-card-sub">Registriert</div></div>
                <div class="admin-card"><div class="admin-card-label">Registrierung</div><div class="admin-card-value" id="adminStatReg" style="font-size:18px">–</div><div class="admin-card-sub" id="adminStatRegSub"></div></div>
                <div class="admin-card"><div class="admin-card-label">Dokumente</div><div class="admin-card-value" id="adminStatDocs">–</div><div class="admin-card-sub">In Datenbank</div></div>
                <div class="admin-card" style="cursor:pointer" onclick="document.getElementById('adminFeedbackSection').scrollIntoView({behavior:'smooth'})"><div class="admin-card-label">Feedback</div><div class="admin-card-value" id="adminStatFb">–</div><div class="admin-card-sub" id="adminStatFbSub">offen</div></div>
            </div>
            <div class="admin-section-title">Benutzer <span class="badge" id="adminUserCount">0</span></div>
            <div id="adminUserTable"></div>
            <div class="admin-section-title" style="margin-top:32px" id="adminFeedbackSection">Feedback <span class="badge" id="adminFbCount">0</span></div>
            <div id="adminFeedbackList"></div>
            <div class="admin-section-title" style="margin-top:32px">Einstellungen</div>
            <div id="adminSettings"></div>
        </div>
    </section>

    <!-- ═══════ PROFILE SECTION ═══════ -->
    <section class="section" id="profile-section">
        <div class="container">
            <div class="section-header"><h2>Profil</h2><p>Dein persönliches Profil in der BEATRIX Intelligence Suite.</p></div>
            <div class="profile-grid">
                <div>
                    <div class="profile-card">
                        <div class="profile-avatar-wrap">
                            <div class="profile-avatar" id="profileAvatar">
                                <span id="profileInitials"></span>
                            </div>
                            <label class="profile-avatar-edit" for="photoUpload" title="Foto ändern">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                            </label>
                            <input type="file" id="photoUpload" accept="image/jpeg,image/png,image/webp" style="display:none" onchange="uploadPhoto(this)">
                        </div>
                        <div class="profile-name" id="profileDisplayName">–</div>
                        <div class="profile-position" id="profileDisplayPosition">–</div>
                        <div class="profile-meta">
                            <div class="profile-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><rect x="2" y="3" width="20" height="18" rx="2"/><path d="M2 8h20"/></svg>
                                <span id="profileDisplayEmail">–</span>
                            </div>
                            <div class="profile-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                <span id="profileDisplayCompany">–</span>
                            </div>
                            <div class="profile-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.12 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.362 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.338 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                                <span id="profileDisplayPhone">–</span>
                            </div>
                            <div class="profile-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                                <span>Mitglied seit <span id="profileMemberSince">–</span></span>
                            </div>
                        </div>
                        <div class="linkedin-section">
                            <button class="linkedin-btn" id="linkedinBtn" onclick="connectLinkedIn()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                                <span id="linkedinBtnText">Mit LinkedIn verbinden</span>
                            </button>
                        </div>
                    </div>
                    <div class="profile-card" style="margin-top:16px">
                        <div style="text-align:left">
                            <div style="font-size:12px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">Expertise</div>
                            <div class="profile-tags" id="profileExpertiseTags"></div>
                            <div style="display:flex;gap:8px;margin-top:10px">
                                <input type="text" class="modal-input" id="expertiseInput" placeholder="Neue Expertise + Enter" style="flex:1;margin:0;font-size:12px;padding:6px 10px" onkeydown="if(event.key==='Enter'){addExpertise();event.preventDefault()}">
                            </div>
                        </div>
                    </div>
                    <!-- ═══ Ψ-PROFILE CARD ═══ -->
                    <div class="profile-card" style="margin-top:16px" id="psiProfileCard">
                        <div style="text-align:left">
                            <div style="font-size:12px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:16px">🧠 Ψ-Profil</div>
                            <div id="psiProfileContent" style="color:var(--text-secondary);font-size:13px">Lade Ψ-Profil...</div>
                        </div>
                    </div>
                </div>
                <div class="profile-form">
                    <h3>Profil bearbeiten</h3>
                    <div class="profile-row">
                        <div class="profile-field"><label>Name</label><input type="text" id="profileName" placeholder="Vor- und Nachname"></div>
                        <div class="profile-field"><label>Position</label><input type="text" id="profilePosition" placeholder="z.B. CEO, Researcher"></div>
                    </div>
                    <div class="profile-row">
                        <div class="profile-field"><label>Unternehmen</label><input type="text" id="profileCompany" placeholder="z.B. FehrAdvice & Partners AG"></div>
                        <div class="profile-field"><label>Telefon</label><input type="text" id="profilePhone" placeholder="+41 ..."></div>
                    </div>
                    <div class="profile-row">
                        <div class="profile-field full"><label>LinkedIn URL</label><input type="text" id="profileLinkedin" placeholder="https://linkedin.com/in/..."></div>
                    </div>
                    <div class="profile-row">
                        <div class="profile-field full"><label>Bio</label><textarea id="profileBio" placeholder="Kurze Beschreibung, Schwerpunkte, Forschungsinteressen..."></textarea></div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-secondary" onclick="openPwModal()">🔑 Passwort ändern</button>
                        <button class="btn btn-primary" onclick="saveProfile()">
                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            Profil speichern
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ═══ Decision Confirmation Overlay ═══ -->
    <div id="mbConfirmOverlay" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(8,12,24,0.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);opacity:0;transition:opacity 0.3s ease">
        <div id="mbConfirmCard" style="position:absolute;bottom:0;left:0;right:0;background:var(--navy-mid);border-top:1px solid var(--border);padding:28px 24px 36px;transform:translateY(100%);transition:transform 0.35s cubic-bezier(0.22,1,0.36,1);max-height:70vh;overflow-y:auto">
            <div style="max-width:680px;margin:0 auto">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                    <div id="mbConfirmIcon" style="font-size:28px;flex-shrink:0"></div>
                    <div>
                        <div id="mbConfirmStep" style="font-size:11px;color:var(--accent);font-weight:600;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:2px"></div>
                        <div id="mbConfirmTitle" style="font-size:18px;font-weight:700;color:white"></div>
                    </div>
                </div>
                <div id="mbConfirmBody" style="font-size:14px;line-height:1.7;color:rgba(255,255,255,0.7);margin-bottom:20px"></div>
                <div id="mbConfirmImplication" style="background:rgba(139,170,255,0.06);border:1px solid rgba(139,170,255,0.12);border-radius:10px;padding:14px 16px;margin-bottom:24px">
                    <div style="font-size:11px;font-weight:600;color:var(--accent);letter-spacing:0.4px;text-transform:uppercase;margin-bottom:6px">Was das bedeutet</div>
                    <div id="mbConfirmImplText" style="font-size:13px;line-height:1.6;color:rgba(255,255,255,0.75)"></div>
                </div>
                <div style="display:flex;gap:12px">
                    <button onclick="mbConfirmBack()" style="padding:12px 20px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-size:14px;cursor:pointer">← Andere Wahl</button>
                    <button id="mbConfirmBtn" onclick="mbConfirmProceed()" style="flex:1;padding:12px 20px;border-radius:10px;border:none;background:var(--accent);color:white;font-size:14px;font-weight:600;cursor:pointer">Weiter →</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">BEATRIX – The Strategic Intelligence Suite · <a href="https://fehradvice.com" target="_blank">FehrAdvice & Partners AG</a> · Zürich</footer>
    <div class="toast-container" id="toastContainer"></div>

    <!-- ═══ INSIGHT QUESTION MODAL ═══ -->
    <div id="insightModal" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px">
        <div style="background:var(--card);border-radius:20px;max-width:640px;width:100%;padding:36px;position:relative;border:1px solid rgba(139,170,255,0.15);max-height:90vh;overflow-y:auto">
            <div style="text-align:center;margin-bottom:20px">
                <div style="font-size:28px;margin-bottom:6px">🧠</div>
                <div style="font-size:14px;color:var(--accent);font-weight:600;letter-spacing:1px" id="insightLabel">Ψ-PROFILING</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px" id="insightCounter">Frage 1</div>
            </div>
            <div style="font-size:17px;line-height:1.5;color:rgba(255,255,255,0.9);text-align:center;margin-bottom:20px;font-weight:500" id="insightQuestion"></div>
            <div id="insightNudge" style="display:none;text-align:center;font-size:13px;color:var(--accent);margin-bottom:12px;font-style:italic"></div>
            <div id="insightChoices" style="display:flex;flex-direction:column;gap:8px"></div>
            <div style="display:flex;gap:12px;margin-top:20px;justify-content:center">
                <button id="insightSkipBtn" style="display:none;padding:10px 24px;border-radius:12px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:rgba(255,255,255,0.5);cursor:pointer;font-size:14px" onclick="insightSkip()">Überspringen</button>
            </div>
            <div style="text-align:center;margin-top:14px">
                <div style="display:flex;gap:6px;justify-content:center" id="insightDots"></div>
            </div>
        </div>
    </div>

    <!-- ═══════ PASSWORD MODAL ═══════ -->
    <div class="modal-overlay" id="pwModal" onclick="if(event.target===this)closePwModal()">
        <div class="modal">
            <h3>🔑 Passwort ändern</h3>
            <div class="modal-msg" id="pwMsg"></div>
            <input type="password" class="modal-input" id="pwCurrent" placeholder="Aktuelles Passwort">
            <input type="password" class="modal-input" id="pwNew" placeholder="Neues Passwort (mind. 6 Zeichen)">
            <input type="password" class="modal-input" id="pwConfirm" placeholder="Neues Passwort bestätigen">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePwModal()">Abbrechen</button>
                <button class="btn btn-primary" id="pwBtn" onclick="changePassword()">Ändern</button>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';
        console.log('🟢 BEATRIX v3.12.3 loaded — mbRenderMd active');
        let files=[], tags=[], selectedDB='knowledge_base', currentTab='file', authToken=null, currentUser=null;

        function H() { return authToken ? {'Authorization':`Bearer ${authToken}`} : {}; }

        // ── Auth ────────────────────────────────────────
        function showAuthPanel(panel) {
            document.querySelectorAll('.auth-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(panel+'Panel').classList.add('active');
            document.querySelectorAll('.auth-error,.auth-success').forEach(e => e.classList.remove('visible'));
        }

        async function checkAuth() {
            const saved = sessionStorage.getItem('bea_token');
            const user = sessionStorage.getItem('bea_user');
            if (saved) {
                try {
                    const r = await fetch(`${API}/auth/check`, {headers:{'Authorization':`Bearer ${saved}`}});
                    if (r.ok) {
                        authToken = saved;
                        currentUser = user ? JSON.parse(user) : (await r.json());
                        // Also check JWT for admin + CRM flags
                        try { const p = JSON.parse(atob(saved.split('.')[1])); currentUser.admin = p.admin || false; currentUser.role = p.role || 'researcher'; currentUser.crm_access = p.crm_access || false; currentUser.crm_role = p.crm_role || 'none'; currentUser.crm_owner_code = p.crm_owner_code || ''; currentUser.lead_management = p.lead_management || false; } catch(e) {}
                        document.getElementById('authOverlay').classList.add('hidden');
                        document.getElementById('navUser').textContent = currentUser.name || currentUser.email;
                        if (currentUser.admin) document.getElementById('navAdmin').style.display = 'inline';
                        applyUserTabs();
                        console.log('Session restore:', currentUser.email, 'admin:', currentUser.admin);
                        if(document.getElementById('fbBtn')) document.getElementById('fbBtn').style.display = 'flex';
                        loadStats();
                        // Returning user — always simplify welcome
                        sessionStorage.setItem('bea_returning', '1');
                        setTimeout(() => showReturningWelcome(), 100);
                        return;
                    }
                } catch(e) {}
                sessionStorage.removeItem('bea_token');
                sessionStorage.removeItem('bea_user');
            }
            document.getElementById('authOverlay').classList.remove('hidden');
        }

        function onAuthSuccess(data) {
            authToken = data.token;
            currentUser = data.user;
            // Decode JWT to get admin status + CRM access
            try { const p = JSON.parse(atob(data.token.split('.')[1])); currentUser.admin = p.admin || false; currentUser.role = p.role || 'researcher'; currentUser.crm_access = p.crm_access || false; currentUser.crm_role = p.crm_role || 'none'; currentUser.crm_owner_code = p.crm_owner_code || ''; currentUser.lead_management = p.lead_management || false; } catch(e) { currentUser.admin = false; currentUser.role = 'researcher'; currentUser.crm_access = false; }
            sessionStorage.setItem('bea_token', authToken);
            sessionStorage.setItem('bea_user', JSON.stringify(currentUser));
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('navUser').textContent = data.user.name || data.user.email;
            if (currentUser.admin) document.getElementById('navAdmin').style.display = 'inline';
            applyUserTabs();
            console.log('Auth success:', currentUser.email, 'admin:', currentUser.admin);
            if(document.getElementById('fbBtn')) document.getElementById('fbBtn').style.display = 'flex';
            loadStats();
            showToast(`Willkommen, ${data.user.name || data.user.email}!`, 'success');
            // Resume or init session
            if (!loadSessionFromStorage()) {
                chatSessionId = generateSessionId();
                saveSessionToStorage();
            }
            setTimeout(() => { updateSessionBadge(); resumeSession(); updateCloseSessionBtn(); adaptWelcomeForUser(); }, 300);
            // Trigger insight question after login
            setTimeout(() => insightStart('login'), 800);
        }

        async function adaptWelcomeForUser() {
            // Check if returning user: has previous sessions or has logged in before
            const isReturning = sessionStorage.getItem('bea_returning') === '1';
            if (isReturning) {
                showReturningWelcome();
                return;
            }
            try {
                const r = await fetch(`${API}/chat/sessions`, {headers: H()});
                if (r.ok) {
                    const sessions = await r.json();
                    if (sessions.length > 1) {
                        sessionStorage.setItem('bea_returning', '1');
                        showReturningWelcome();
                    }
                }
            } catch(e) {}
        }

        function showReturningWelcome() {
            const title = document.getElementById('chatWelcomeTitle');
            const text = document.getElementById('chatWelcomeText');
            const suggestions = document.getElementById('chatWelcomeSuggestions');
            if (!title) return;
            const name = (currentUser?.name || '').split(' ')[0] || '';
            const hour = new Date().getHours();
            const greeting = hour < 12 ? 'Guten Morgen' : hour < 17 ? 'Hallo' : 'Guten Abend';
            title.textContent = `${greeting}${name ? ', ' + name : ''}.`;
            text.textContent = 'Was kann ich für dich tun?';
            if (suggestions) suggestions.style.display = 'none';
        }

        // ── Insight / Ψ-Profiling (5-Choice Architecture) ──────────
        let insightState = { questionNum: 0, currentQuestion: null, startTime: null, context: 'login' };
        const INSIGHT_ENABLED = false; // ← Feature-Flag: auf true setzen um Intro-Fragen wieder zu aktivieren

        async function insightStart(context = 'login') {
            if (!INSIGHT_ENABLED) return; // Sistiert bis Reaktivierung
            insightState = { questionNum: 0, currentQuestion: null, startTime: null, context };
            await insightNext();
        }

        async function insightNext() {
            try {
                const resp = await fetch(`${API}/insight/question?context=${insightState.context}`, { headers: H() });
                if (!resp.ok) return insightClose();
                const data = await resp.json();
                insightState.currentQuestion = data;
                insightState.startTime = Date.now();
                insightState.questionNum = data.question_number;

                const modal = document.getElementById('insightModal');
                modal.style.display = 'flex';
                document.getElementById('insightQuestion').textContent = data.question;
                document.getElementById('insightCounter').textContent = `Frage ${data.question_number}` + (data.total_answered > 0 ? ` · ${data.total_answered} bisherige` : '');

                // Label: mandatory / nudged / voluntary
                const label = document.getElementById('insightLabel');
                if (data.is_mandatory) {
                    label.textContent = 'Ψ-PROFILING · PFLICHTFRAGE';
                    label.style.color = 'var(--accent)';
                } else if (data.is_nudged) {
                    label.textContent = 'Ψ-PROFILING · EMPFOHLEN';
                    label.style.color = '#f59e0b';
                } else {
                    label.textContent = 'Ψ-PROFILING · FREIWILLIG';
                    label.style.color = 'rgba(255,255,255,0.4)';
                }

                // Nudge message
                const nudgeEl = document.getElementById('insightNudge');
                if (data.nudge_message) { nudgeEl.textContent = data.nudge_message; nudgeEl.style.display = 'block'; }
                else { nudgeEl.style.display = 'none'; }

                // Render 5 choice cards
                const choicesEl = document.getElementById('insightChoices');
                if (data.choices && data.choices.length > 0) {
                    choicesEl.innerHTML = data.choices.map((c, i) => `
                        <div onclick="insightSelectChoice(this, ${i + 1}, '${(c.label || '').replace(/'/g, "\'")}')"
                             style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:background 0.15s;-webkit-tap-highlight-color:rgba(139,170,255,0.2)"
                             onmouseover="this.style.background='rgba(255,255,255,0.06)'"
                             onmouseout="if(!this.classList.contains('ins-selected'))this.style.background='transparent'">
                            <div style="font-size:18px;flex-shrink:0;width:28px;text-align:center">${c.icon || '○'}</div>
                            <div style="font-size:15px;color:rgba(255,255,255,0.8)">${c.label}</div>
                        </div>
                    `).join('');
                } else {
                    choicesEl.innerHTML = '';
                }

                // Skip button
                document.getElementById('insightSkipBtn').style.display = data.can_skip ? 'block' : 'none';

                // Progress dots
                const dotsEl = document.getElementById('insightDots');
                let dots = '';
                for (let i = 1; i <= Math.max(3, data.question_number); i++) {
                    const active = i === data.question_number;
                    const done = i < data.question_number;
                    dots += `<div style="width:8px;height:8px;border-radius:50%;background:${done ? 'var(--accent)' : active ? 'white' : 'rgba(255,255,255,0.2)'}"></div>`;
                }
                dotsEl.innerHTML = dots;
            } catch(e) {
                console.error('Insight load error:', e);
                insightClose();
            }
        }

        async function insightSelectChoice(el, choiceIndex, choiceLabel) {
            // Mark selected
            el.parentElement.querySelectorAll('div[onclick]').forEach(c => {
                c.classList.remove('ins-selected');
                c.style.background = 'transparent';
            });
            el.classList.add('ins-selected');
            el.style.background = 'rgba(139,170,255,0.12)';

            await new Promise(r => setTimeout(r, 300));

            const latency = Date.now() - insightState.startTime;
            const q = insightState.currentQuestion;

            try {
                await fetch(`${API}/insight/answer`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_text: q.question,
                        question_id: q.question_id,
                        answer_text: choiceLabel,
                        choice_index: choiceIndex,
                        latency_ms: latency,
                        question_number: q.question_number,
                        was_mandatory: q.is_mandatory,
                        was_nudged: q.is_nudged,
                        skipped: false,
                        context: insightState.context,
                    })
                });

                // Flow: mandatory→next, nudged→next, voluntary→ask
                if (q.question_number < 3) {
                    await insightNext();
                } else {
                    insightClose();
                    showToast('Ψ-Profil aktualisiert ✓', 'success');
                }
            } catch(e) {
                console.error('Insight submit error:', e);
            }
        }

        async function insightSkip() {
            const q = insightState.currentQuestion;
            try {
                await fetch(`${API}/insight/skip`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_text: q.question, question_id: q.question_id,
                        question_number: q.question_number, context: insightState.context,
                    })
                });
            } catch(e) {}
            insightClose();
            showToast('Ψ-Profiling übersprungen', 'info');
        }

        function insightClose() {
            document.getElementById('insightModal').style.display = 'none';
        }

        async function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pw = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('loginError');
            if (!email || !pw) { err.textContent='Bitte E-Mail und Passwort eingeben.'; err.classList.add('visible'); return; }
            btn.disabled=true; btn.innerHTML='<div class="spinner"></div> Anmelden...'; err.classList.remove('visible');
            try {
                const r = await fetch(`${API}/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw})});
                if (!r.ok) {
                    const d=await r.json().catch(()=>({}));
                    const msg = d.detail||'Anmeldung fehlgeschlagen.';
                    if (r.status === 403 && msg.includes('nicht bestätigt')) {
                        err.innerHTML = msg + ' <a style="color:var(--accent);cursor:pointer;font-weight:600" onclick="resendFromLogin()">Erneut senden</a>';
                    } else { err.textContent = msg; }
                    err.classList.add('visible'); btn.disabled=false; btn.textContent='Anmelden'; return;
                }
                onAuthSuccess(await r.json());
            } catch(e) { err.textContent='Verbindungsfehler: ' + e.message + ' [' + API + '/login]'; err.classList.add('visible'); }
            btn.disabled=false; btn.textContent='Anmelden';
        }

        async function resendFromLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pw = document.getElementById('loginPassword').value;
            if (!email || !pw) return;
            const err = document.getElementById('loginError');
            try {
                const r = await fetch(`${API}/resend-verification`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw})});
                const d = await r.json();
                if (r.ok) { err.innerHTML='✓ Neuer Bestätigungslink gesendet!'; err.style.color='var(--success)'; }
                else { err.textContent = d.detail || 'Fehler'; }
            } catch(e) { err.textContent='Verbindungsfehler'; }
        }

        async function doForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();
            const btn = document.getElementById('forgotBtn');
            const err = document.getElementById('forgotError');
            const suc = document.getElementById('forgotSuccess');
            err.classList.remove('visible'); suc.style.display='none';
            if (!email) { err.textContent='Bitte E-Mail-Adresse eingeben.'; err.classList.add('visible'); return; }
            btn.disabled=true; btn.innerHTML='<div class="spinner"></div> Wird gesendet...';
            try {
                const r = await fetch(`${API}/forgot-password`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email})});
                const d = await r.json();
                if (r.ok) { suc.textContent='✓ ' + d.message; suc.style.display='block'; }
                else { err.textContent=d.detail||'Fehler'; err.classList.add('visible'); }
            } catch(e) { err.textContent='Verbindungsfehler'; err.classList.add('visible'); }
            btn.disabled=false; btn.textContent='Reset-Link senden';
        }

        async function doRegister() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pw = document.getElementById('regPassword').value;
            const btn = document.getElementById('registerBtn');
            const err = document.getElementById('registerError');
            const suc = document.getElementById('registerSuccess');
            err.classList.remove('visible'); if(suc) suc.classList.remove('visible');
            if (!email || !pw) { err.textContent='Bitte E-Mail und Passwort eingeben.'; err.classList.add('visible'); return; }
            if (pw.length < 6) { err.textContent='Passwort muss mindestens 6 Zeichen haben.'; err.classList.add('visible'); return; }
            btn.disabled=true; btn.innerHTML='<div class="spinner"></div> Registrieren...';
            try {
                const r = await fetch(`${API}/register`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw, name:name||null})});
                const d = await r.json();
                if (!r.ok) { err.textContent=d.detail||'Registrierung fehlgeschlagen.'; err.classList.add('visible'); btn.disabled=false; btn.textContent='Registrieren'; return; }
                if (d.status === 'verification_required') {
                    // Show verification message
                    if(suc) { suc.textContent = d.message; suc.classList.add('visible'); }
                    else { err.style.color='var(--success)'; err.style.background='var(--success-bg)'; err.style.borderColor='rgba(52,211,153,0.15)'; err.textContent = d.message; err.classList.add('visible'); }
                    btn.disabled=false; btn.textContent='Registrieren';
                    // Show resend link
                    setTimeout(() => {
                        const resendEl = document.getElementById('resendArea');
                        if (resendEl) { resendEl.style.display='block'; resendEl.dataset.email=email; resendEl.dataset.pw=pw; }
                    }, 500);
                    return;
                }
                onAuthSuccess(d);
            } catch(e) { err.textContent='Verbindungsfehler.'; err.classList.add('visible'); }
            btn.disabled=false; btn.textContent='Registrieren';
        }

        async function resendVerification() {
            const resendEl = document.getElementById('resendArea');
            const email = resendEl?.dataset.email;
            const pw = resendEl?.dataset.pw;
            if (!email || !pw) return;
            const btn = resendEl.querySelector('a');
            const origText = btn.textContent;
            btn.textContent = 'Wird gesendet...'; btn.style.pointerEvents='none';
            try {
                const r = await fetch(`${API}/resend-verification`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw})});
                const d = await r.json();
                if (r.ok) { btn.textContent='✓ Gesendet!'; btn.style.color='var(--success)'; }
                else { btn.textContent = d.detail || 'Fehler'; btn.style.color='var(--error)'; }
            } catch(e) { btn.textContent='Fehler'; btn.style.color='var(--error)'; }
            setTimeout(() => { btn.textContent=origText; btn.style.color=''; btn.style.pointerEvents=''; }, 4000);
        }

        function doLogout() {
            authToken=null; currentUser=null;
            sessionStorage.removeItem('bea_token'); sessionStorage.removeItem('bea_user');
            clearSessionStorage();
            if(document.getElementById('fbBtn')) document.getElementById('fbBtn').style.display = 'none';
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('loginEmail').value=''; document.getElementById('loginPassword').value='';
            document.querySelectorAll('.auth-error,.auth-success').forEach(e => e.classList.remove('visible'));
            showAuthPanel('login');
        }

        document.getElementById('loginPassword').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
        document.getElementById('loginEmail').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
        document.getElementById('regPassword').addEventListener('keydown', e => { if(e.key==='Enter') doRegister(); });

        // ── App Logic ───────────────────────────────────
        function showSection(name,el) {
            // Close any open dropdowns + mobile nav
            document.querySelectorAll('.nav-dropdown.open').forEach(d => d.classList.remove('open'));
            closeMobileNav();
            // Clear all active states
            document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
            document.querySelectorAll('.nav-dropdown-trigger').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.nav-dropdown-item').forEach(i=>i.classList.remove('active'));
            // Set active state
            if(el && el.classList.contains('nav-link')) el.classList.add('active');
            // Show section
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            const sec=document.getElementById(name+'-section'); if(sec) sec.classList.add('active');
            document.getElementById('hero-section').style.display = (name==='upload') ? '' : 'none';
            if(name==='documents') loadDocuments();
            if(name==='uploadpriority') loadUploadPriority();
            if(name==='paperfinder') loadPaperFinder();
            if(name==='universities') loadUniversities();
            if(name==='admin') loadAdminData();
            if(name==='context') caInit();
            if(name==='leads') crmLoad();
            if(name==='companies') crmLoadCompanies();
            if(name==='projects') prjLoad();
            if(name==='tasks') loadTasks();
            if(name==='myprojects') myPrjLoad();
            if(name==='profile') loadProfile();
            if(name==='chat') {
                // New session when coming from another section (no mixing)
                if(window._currentSection && window._currentSection !== 'chat') {
                    startNewChatSession();
                }
                loadChatHistory();
                document.getElementById('chatInput').focus();
            }
            window._currentSection = name;
            if(name==='model') { if (!mbUserProfile) mbLoadUserProfile().then(() => mbApplyDefault('start')); }
        }

        function toggleMobileNav() {
            const links = document.querySelector('.nav-links');
            const isOpen = links.classList.toggle('mobile-open');
            const icon = document.getElementById('hamburgerIcon');
            if (isOpen) {
                icon.innerHTML = '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>';
            } else {
                icon.innerHTML = '<line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>';
            }
        }

        function closeMobileNav() {
            const links = document.querySelector('.nav-links');
            if (links) links.classList.remove('mobile-open');
            const icon = document.getElementById('hamburgerIcon');
            if (icon) icon.innerHTML = '<line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>';
        }

        function toggleDropdown(id) {
            const dd = document.getElementById(id);
            const wasOpen = dd.classList.contains('open');
            document.querySelectorAll('.nav-dropdown.open').forEach(d => d.classList.remove('open'));
            if (!wasOpen) dd.classList.add('open');
        }

        function navDropClick(section, itemEl) {
            // Close dropdown + mobile nav
            document.querySelectorAll('.nav-dropdown.open').forEach(d => d.classList.remove('open'));
            closeMobileNav();
            // Clear all actives
            document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
            document.querySelectorAll('.nav-dropdown-trigger').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.nav-dropdown-item').forEach(i=>i.classList.remove('active'));
            // Mark dropdown item + parent trigger as active
            if(itemEl) itemEl.classList.add('active');
            const parentTrigger = itemEl?.closest('.nav-dropdown')?.querySelector('.nav-dropdown-trigger');
            if(parentTrigger) parentTrigger.classList.add('active');
            // Show the section
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            const sec=document.getElementById(section+'-section'); if(sec) sec.classList.add('active');
            document.getElementById('hero-section').style.display = (section==='upload') ? '' : 'none';
            if(section==='documents') loadDocuments();
            if(section==='universities') loadUniversities();
            if(section==='admin') loadAdminData();
            if(section==='context') caInit();
            if(section==='leads') crmLoad();
            if(section==='companies') crmLoadCompanies();
            if(section==='projects') prjLoad();
            if(section==='myprojects') myPrjLoad();
            if(section==='profile') loadProfile();
        }

        // Close dropdowns on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown.open').forEach(d => d.classList.remove('open'));
            }
        });
        function switchTab(tab,el) { currentTab=tab; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); document.getElementById('file-section').classList.toggle('active',tab==='file'); document.getElementById('text-section').classList.toggle('active',tab==='text'); updateCount(); }

        function updateTextZone() {
            const zone = document.getElementById('textZone');
            const ta = document.getElementById('textContent');
            const cc = document.getElementById('textCharCount');
            if (ta.value.trim()) {
                zone.classList.add('has-content');
                cc.style.display = '';
                cc.textContent = ta.value.length.toLocaleString() + ' Zeichen';
            } else {
                zone.classList.remove('has-content');
                cc.style.display = 'none';
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            const ta = document.getElementById('textContent');
            const zone = document.getElementById('textZone');
            if (ta && zone) {
                ta.addEventListener('focus', () => zone.classList.add('focused','active'));
                ta.addEventListener('blur', () => { zone.classList.remove('focused'); if(!ta.value.trim()) zone.classList.remove('active'); });
            }
        });
        function selectDB(el) { document.querySelectorAll('.db-option').forEach(o=>o.classList.remove('selected')); el.classList.add('selected'); selectedDB=el.dataset.db; }

        const dropZone=document.getElementById('dropZone');
        ['dragenter','dragover'].forEach(e=>dropZone.addEventListener(e,ev=>{ev.preventDefault();dropZone.classList.add('dragover');}));
        ['dragleave','drop'].forEach(e=>dropZone.addEventListener(e,ev=>{ev.preventDefault();dropZone.classList.remove('dragover');}));
        dropZone.addEventListener('drop',e=>addFiles([...e.dataTransfer.files]));
        document.getElementById('fileInput').addEventListener('change',e=>{addFiles([...e.target.files]);e.target.value='';});

        function addFiles(nf) { const ok=['.pdf','.txt','.md','.docx','.csv','.json']; for(const f of nf){const ext='.'+f.name.split('.').pop().toLowerCase(); if(!ok.includes(ext)){showToast(`${f.name}: nicht unterstützt`,'error');continue;} if(f.size>50*1024*1024){showToast(`${f.name}: zu groß`,'error');continue;} files.push({file:f,status:'pending',progress:0,id:Date.now()+Math.random()});} renderFileList();updateCount();
            // Single file: show analysis + meta fields
            // Batch (2+): hide meta fields, backend auto-classifies each
            const metaFields = document.getElementById('fileMetaFields');
            const preview = document.getElementById('fileAnalysisPreview');
            if(files.length===1) {
                if(metaFields) metaFields.style.display='';
                analyzeFileContent(files[0].file);
            } else {
                // Batch mode: hide per-file meta, show batch hint
                if(metaFields) metaFields.style.display='none';
                if(preview) { preview.style.display=''; document.getElementById('fileAnalysisContent').innerHTML=`<div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">📦</span><div><span style="font-weight:600;color:var(--accent-light)">Batch-Upload: ${files.length} Dateien</span><div style="font-size:11px;color:var(--text-muted);margin-top:2px">Jede Datei wird einzeln analysiert und automatisch klassifiziert (Paper / Buch / Studie / Allgemein)</div></div></div>`; }
            }
        }
        function removeFile(id) { files=files.filter(f=>f.id!==id); renderFileList();updateCount();
            const metaFields = document.getElementById('fileMetaFields');
            const preview = document.getElementById('fileAnalysisPreview');
            if(!files.length) {
                if(preview) preview.style.display='none';
                if(metaFields) metaFields.style.display='';
            } else if(files.length===1) {
                // Switched from batch to single: show meta + run analysis
                if(metaFields) metaFields.style.display='';
                analyzeFileContent(files[0].file);
            }
        }
        function renderFileList() { document.getElementById('fileList').innerHTML=files.map(f=>{const ext=f.file.name.split('.').pop().toLowerCase();const cls=ext==='pdf'?'pdf':ext==='md'?'md':ext==='docx'?'doc':'txt';const sz=f.file.size<1024*1024?(f.file.size/1024).toFixed(1)+' KB':(f.file.size/1024/1024).toFixed(1)+' MB';const statusText=f.status==='pending'?'Bereit':f.status==='analyzing'?'<div class="spinner" style="width:12px;height:12px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:4px"></div> Analysiert…':f.status==='uploading'?f.progress+'%':f.status==='success'?'✓ Fertig':f._statusText?`✗ ${f._statusText}`:'✗ Fehler';return`<div class="file-item"><div class="file-type-icon ${cls}">${ext}</div><div class="file-info"><div class="file-name">${f.file.name}</div><div class="file-meta">${sz}${f._result?.title&&f._result.title!==f.file.name?' · '+f._result.title:''}</div></div>${f.status==='uploading'?`<div><div class="progress-bar"><div class="progress-fill" style="width:${f.progress}%"></div></div></div>`:''}<span class="file-status ${f.status}">${statusText}</span>${f.status==='pending'?`<button class="file-remove" onclick="removeFile(${f.id})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`:''}</div>`;}).join(''); }
        function updateCount() { const el=document.getElementById('uploadCount'); el.textContent=currentTab==='file'?(files.length?`${files.length} Datei${files.length>1?'en':''}`:''):(document.getElementById('textContent').value.length?`${document.getElementById('textContent').value.length} Zeichen`:''); }

        document.getElementById('tagInput').addEventListener('keydown',e=>{if(e.key==='Enter'&&e.target.value.trim()){e.preventDefault();if(!tags.includes(e.target.value.trim())){tags.push(e.target.value.trim());renderTags();}e.target.value='';}});
        function removeTag(t){tags=tags.filter(x=>x!==t);renderTags();}
        function renderTags(){const c=document.getElementById('tagContainer'),inp=document.getElementById('tagInput');if(!c||!inp)return;c.innerHTML='';tags.forEach(t=>{const s=document.createElement('span');s.className='tag';s.innerHTML=`${t} <button onclick="removeTag('${t}')">&times;</button>`;c.appendChild(s);});c.appendChild(inp);}

        // ── Text Auto-Analysis (on paste / input) ──
        let textAnalysisTimer = null;
        let lastAnalyzedLength = 0;

        function debounceTextAnalysis() {
            clearTimeout(textAnalysisTimer);
            const text = document.getElementById('textContent').value;
            updateCount();
            // Only trigger if text changed significantly (>500 chars difference or first time)
            if (Math.abs(text.length - lastAnalyzedLength) > 500 || (text.length > 300 && lastAnalyzedLength === 0)) {
                textAnalysisTimer = setTimeout(() => analyzeTextContent(), 1500);
            }
        }

        async function analyzeTextContent() {
            const text = document.getElementById('textContent').value.trim();
            const preview = document.getElementById('textAnalysisPreview');
            const content = document.getElementById('textAnalysisContent');

            if (text.length < 100) {
                preview.style.display = 'none';
                return;
            }

            lastAnalyzedLength = text.length;
            preview.style.display = '';
            content.innerHTML = '<span style="animation:blink 0.8s infinite">⏳</span> BEATRIX analysiert den Text...';

            try {
                const r = await fetch(`${API}/text/analyze`, {
                    method: 'POST',
                    headers: {...H(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({text: text.slice(0, 10000), total_length: text.length})
                });
                if (!r.ok) throw new Error('Analyse fehlgeschlagen');
                const d = await r.json();
                if (!d.ok) throw new Error(d.error || 'Analyse fehlgeschlagen');

                // Auto-fill fields
                if (d.title && !document.getElementById('textTitle').value.trim()) {
                    document.getElementById('textTitle').value = d.title;
                }
                if (d.language) {
                    document.getElementById('textLang').value = d.language;
                }
                if (d.category) {
                    document.getElementById('textCategory').value = d.category;
                }
                if (d.tags?.length && tags.length === 0) {
                    tags = d.tags;
                    renderTags();
                }
                // Auto-select database
                if (d.database && d.database !== selectedDB) {
                    const dbEl = document.querySelector(`.db-option[data-db="${d.database}"]`);
                    if (dbEl) selectDB(dbEl);
                }

                content.innerHTML = renderAnalysisPreviewHtml(d);
            } catch(e) {
                content.innerHTML = `<span style="color:var(--error)">❌ ${e.message}</span>`;
            }
        }

        function renderAnalysisPreviewHtml(d) {
            // ── BOOK detected ──
            if (d.book_detected) {
                const bm = d.book_meta || {};
                const isbn = d.isbn || '';
                let metaHtml = '';
                const parts = [];
                if (bm.authors?.length) parts.push(`✍️ ${bm.authors.join(', ')}`);
                if (bm.publisher) parts.push(`📚 ${bm.publisher}`);
                if (bm.publish_date) parts.push(`📅 ${bm.publish_date}`);
                if (bm.pages) parts.push(`📄 ${bm.pages} Seiten`);
                if (parts.length) metaHtml = `<div style="margin-top:8px;font-size:12px;color:var(--text-secondary);display:flex;flex-wrap:wrap;gap:12px">${parts.join(' · ')}</div>`;

                let isbnHtml = '';
                if (isbn) {
                    isbnHtml = `<div style="margin-top:8px;padding:8px 14px;background:rgba(0,0,0,0.15);border-radius:10px;display:flex;align-items:center;gap:10px">
                        <span style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted)">ISBN</span>
                        <code style="font-size:13px;color:#34d399;font-family:'JetBrains Mono',monospace">${isbn}</code>
                        ${d.isbn_data?.cover_url ? `<img src="${d.isbn_data.cover_url}" style="height:40px;border-radius:3px;margin-left:auto" alt="Cover">` : ''}
                    </div>`;
                }

                const signalTags = d.book_signals?.length
                    ? `<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px">${d.book_signals.map(s => `<span style="padding:1px 6px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:4px;font-size:10px">${s}</span>`).join('')}</div>`
                    : '';
                const summaryHtml = d.summary
                    ? `<div style="margin-top:8px;padding:8px 12px;background:rgba(255,255,255,0.02);border-radius:8px;font-style:italic;color:var(--text-secondary);font-size:12px">${d.summary}</div>`
                    : '';
                const fileInfo = d.filename
                    ? `${d.filename} · ${d.chars?.toLocaleString() || '?'} Zeichen`
                    : `${d.chars?.toLocaleString() || '?'} Zeichen`;

                return `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                        <span style="font-size:18px">📖</span>
                        <div>
                            <span style="color:#f59e0b;font-weight:600">Buch erkannt</span> (Score: ${d.book_score})
                            <div style="font-size:11px;color:var(--text-muted);margin-top:2px">${fileInfo}</div>
                        </div>
                    </div>
                    ${signalTags}${metaHtml}${isbnHtml}${summaryHtml}
                    <div style="margin-top:8px;font-size:11px;color:#f59e0b">→ Wird automatisch in <code style="font-size:10px">books/</code> auf GitHub übernommen</div>
                `;
            }

            // ── STUDY/REPORT detected ──
            if (d.study_detected) {
                const sm = d.study_meta || {};
                const typeLabel = d.study_type_label || 'Report/Studie';
                const typeIcons = {consulting:'🏢', think_tank:'🧠', international_org:'🌐', government:'🏛️', policy_brief:'📋', industry_report:'📊', survey_study:'📈', report:'📄'};
                const typeIcon = typeIcons[d.study_type] || '📊';

                let metaHtml = '';
                const parts = [];
                if (sm.authors?.length) parts.push(`✍️ ${sm.authors.join(', ')}`);
                if (sm.organization) parts.push(`${typeIcon} ${sm.organization}`);
                if (parts.length) metaHtml = `<div style="margin-top:8px;font-size:12px;color:var(--text-secondary);display:flex;flex-wrap:wrap;gap:12px">${parts.join(' · ')}</div>`;

                const signalTags = d.study_signals?.length
                    ? `<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px">${d.study_signals.map(s => `<span style="padding:1px 6px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:4px;font-size:10px">${s}</span>`).join('')}</div>`
                    : '';
                const summaryHtml = d.summary
                    ? `<div style="margin-top:8px;padding:8px 12px;background:rgba(255,255,255,0.02);border-radius:8px;font-style:italic;color:var(--text-secondary);font-size:12px">${d.summary}</div>`
                    : '';
                const fileInfo = d.filename
                    ? `${d.filename} · ${d.chars?.toLocaleString() || '?'} Zeichen`
                    : `${d.chars?.toLocaleString() || '?'} Zeichen`;

                return `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                        <span style="font-size:18px">${typeIcon}</span>
                        <div>
                            <span style="color:#8b5cf6;font-weight:600">${typeLabel} erkannt</span> (Score: ${d.study_score})
                            <div style="font-size:11px;color:var(--text-muted);margin-top:2px">${fileInfo}</div>
                        </div>
                    </div>
                    <div style="margin-top:6px;display:inline-block;padding:3px 10px;background:rgba(139,92,246,0.15);border:1px solid rgba(139,92,246,0.3);border-radius:6px;font-size:11px;color:#a78bfa;font-weight:500">${typeLabel}</div>
                    ${signalTags}${metaHtml}${summaryHtml}
                    <div style="margin-top:8px;font-size:11px;color:#8b5cf6">→ Wird automatisch in <code style="font-size:10px">studies/</code> auf GitHub übernommen</div>
                `;
            }

            // ── PAPER or normal document ──
            const paperIcon = d.paper_detected ? '📚' : '📄';
            const paperLabel = d.paper_detected
                ? `<span style="color:#34d399;font-weight:600">Wissenschaftliches Paper erkannt</span> (Score: ${d.paper_score})`
                : `<span style="color:var(--text-muted)">Kein Paper — normales Dokument</span>`;
            let levelHtml = '';
            if (d.paper_detected && d.content_level) {
                const clColors = {L0:'#ef4444',L1:'#f59e0b',L2:'#3b82f6',L3:'#10b981'};
                const ilColors = {I1:'#ef4444',I2:'#f59e0b',I3:'#3b82f6',I4:'#8b5cf6',I5:'#10b981'};
                levelHtml = `<div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
                    <div style="flex:1;min-width:200px;padding:10px 14px;background:rgba(0,0,0,0.15);border-radius:10px;border-left:3px solid ${clColors[d.content_level]||'#666'}">
                        <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:4px">Content Level</div>
                        <div style="font-size:16px;font-weight:700;color:${clColors[d.content_level]||'#fff'}">${d.content_level}</div>
                        <div style="font-size:11px;color:var(--text-secondary);margin-top:2px">${d.content_level_desc||''}</div>
                    </div>
                    <div style="flex:1;min-width:200px;padding:10px 14px;background:rgba(0,0,0,0.15);border-radius:10px;border-left:3px solid ${ilColors[d.integration_level]||'#666'}">
                        <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:4px">Integration Level</div>
                        <div style="font-size:16px;font-weight:700;color:${ilColors[d.integration_level]||'#fff'}">${d.integration_level||'—'}</div>
                        <div style="font-size:11px;color:var(--text-secondary);margin-top:2px">${d.integration_level_desc||''}</div>
                    </div>
                </div>`;
            }
            let structHtml = '';
            if (d.structural) {
                const sLabels = {S1_research_question:'S1 Forschungsfrage',S2_methodology:'S2 Methodik',S3_sample_data:'S3 Stichprobe',S4_findings:'S4 Ergebnisse',S5_validity:'S5 Validität',S6_reproducibility:'S6 Reproduzierbarkeit'};
                structHtml = `<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px">${Object.entries(d.structural).map(([k,v])=>`<span style="padding:2px 8px;border-radius:4px;font-size:10px;${v?'background:rgba(52,211,153,0.12);color:#34d399;border:1px solid rgba(52,211,153,0.2)':'background:rgba(255,255,255,0.03);color:var(--text-muted);border:1px solid var(--border)'}">${v?'✓':'○'} ${sLabels[k]||k}</span>`).join('')}</div>`;
            }
            let ebfHtml = '';
            if (d.ebf) {
                const parts = [];
                if (d.ebf.evidence_tier) {
                    const tierLabel = {1:'🥇 Gold',2:'🥈 Silber',3:'🥉 Bronze'};
                    const tierColor = {1:'#fbbf24',2:'#9ca3af',3:'#b45309'};
                    parts.push(`<span style="color:${tierColor[d.ebf.evidence_tier]||'#fff'}">Evidenz: ${tierLabel[d.ebf.evidence_tier]||d.ebf.evidence_tier}</span>`);
                }
                if (d.ebf.methodology?.design) parts.push(`Design: ${d.ebf.methodology.design}`);
                if (d.ebf.methodology?.identification) parts.push(`ID: ${d.ebf.methodology.identification}`);
                if (d.ebf.journal) parts.push(`📰 ${d.ebf.journal}`);
                if (d.ebf.doi) parts.push(`DOI: ${d.ebf.doi}`);
                let dimHtml = '';
                if (d.ebf.ebf_dimensions?.length) {
                    dimHtml = `<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px">${d.ebf.ebf_dimensions.map(dim=>`<span style="padding:2px 8px;background:rgba(42,127,142,0.15);border:1px solid rgba(42,127,142,0.3);border-radius:4px;font-size:10px;color:var(--accent)" title="${dim.connection||''}">${dim.dimension}</span>`).join('')}</div>`;
                }
                let psiHtml = '';
                if (d.ebf.psi_dimensions?.length) {
                    const psiIcons = {'Ψ_I':'📋','Ψ_S':'👥','Ψ_C':'🧠','Ψ_K':'🌍','Ψ_E':'💰','Ψ_T':'⏰','Ψ_M':'🔧','Ψ_P':'🎯'};
                    psiHtml = `<div style="margin-top:4px;display:flex;flex-wrap:wrap;gap:4px">${d.ebf.psi_dimensions.map(p=>`<span style="padding:2px 8px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:4px;font-size:10px;color:#a78bfa" title="${p.relevance||''}">${psiIcons[p.psi]||'Ψ'} ${p.psi}</span>`).join('')}</div>`;
                }
                let findHtml = '';
                if (d.ebf.key_findings?.length) {
                    findHtml = `<div style="margin-top:6px">${d.ebf.key_findings.slice(0,3).map(f=>`<div style="font-size:11px;color:var(--text-secondary);padding:3px 0">• ${f.finding}${f.effect_size?' <span style="color:#34d399">(d='+f.effect_size+')</span>':''}</div>`).join('')}</div>`;
                }
                ebfHtml = `<div style="margin-top:10px;padding:10px 14px;background:rgba(0,0,0,0.15);border-radius:10px">
                    <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:6px">EBF-Klassifikation</div>
                    <div style="font-size:12px;color:var(--text-secondary);display:flex;flex-wrap:wrap;gap:12px">${parts.join(' · ')}</div>
                    ${dimHtml}${psiHtml}${findHtml}
                </div>`;
            }
            let pidHtml = d.paper_id ? `<div style="margin-top:6px;font-size:11px;color:var(--text-muted)">Paper-ID: <code style="background:rgba(255,255,255,0.05);padding:1px 6px;border-radius:3px;font-family:monospace">${d.paper_id}</code></div>` : '';
            const signalTags = d.paper_signals?.length
                ? `<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px">${d.paper_signals.map(s => `<span style="padding:1px 6px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:4px;font-size:10px">${s}</span>`).join('')}</div>`
                : '';
            const summaryHtml = d.summary
                ? `<div style="margin-top:8px;padding:8px 12px;background:rgba(255,255,255,0.02);border-radius:8px;font-style:italic;color:var(--text-secondary);font-size:12px">${d.summary}</div>`
                : '';
            const fileInfo = d.filename
                ? `${d.filename} · ${d.chars?.toLocaleString() || '?'} Zeichen`
                : `${d.chars?.toLocaleString() || '?'} Zeichen · Felder auto-befüllt ✓`;
            return `
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                    <span style="font-size:18px">${paperIcon}</span>
                    <div>
                        <div>${paperLabel}</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-top:2px">${fileInfo}</div>
                    </div>
                </div>
                ${signalTags}${levelHtml}${structHtml}${ebfHtml}${summaryHtml}${pidHtml}
                ${d.paper_detected ? '<div style="margin-top:8px;font-size:11px;color:#34d399">→ Wird automatisch in die Paper-Datenbank auf GitHub übernommen</div>' : ''}
            `;
        }

        let fileTags = [];
        function renderFileTags() {
            const container = document.getElementById('fileTagContainer');
            const input = document.getElementById('fileTagInput');
            container.innerHTML = '';
            fileTags.forEach((t,i) => {
                const span = document.createElement('span');
                span.className = 'tag';
                span.innerHTML = `${t}<button onclick="fileTags.splice(${i},1);renderFileTags()">×</button>`;
                container.appendChild(span);
            });
            container.appendChild(input);
        }
        document.addEventListener('DOMContentLoaded', () => {
            const fti = document.getElementById('fileTagInput');
            if (fti) fti.addEventListener('keydown', e => {
                if (e.key === 'Enter' && fti.value.trim()) {
                    e.preventDefault();
                    fileTags.push(fti.value.trim());
                    fti.value = '';
                    renderFileTags();
                }
            });
        });

        async function analyzeFileContent(file) {
            const preview = document.getElementById('fileAnalysisPreview');
            const content = document.getElementById('fileAnalysisContent');
            // Set file status to analyzing
            const fileObj = files.find(f => f.file === file);
            if (fileObj) { fileObj.status = 'analyzing'; renderFileList(); }
            preview.style.display = '';
            content.innerHTML = '<span style="animation:blink 0.8s infinite">⏳</span> BEATRIX analysiert die Datei...';
            try {
                const fd = new FormData();
                fd.append('file', file);
                const r = await fetch(`${API}/file/analyze`, {method:'POST', headers:H(), body:fd});
                if (!r.ok) throw new Error('Analyse fehlgeschlagen');
                const d = await r.json();
                if (!d.ok) throw new Error(d.error || 'Analyse fehlgeschlagen');
                // Auto-select database if paper
                if (d.database && d.database !== selectedDB) {
                    const dbEl = document.querySelector(`.db-option[data-db="${d.database}"]`);
                    if (dbEl) selectDB(dbEl);
                }
                content.innerHTML = renderAnalysisPreviewHtml(d);
                // Populate metadata fields
                if (d.title) document.getElementById('fileTitle').value = d.title;
                if (d.language) document.getElementById('fileLang').value = d.language;
                if (d.category) document.getElementById('fileCategory').value = d.category;
                if (d.tags?.length) { fileTags = d.tags; renderFileTags(); }
                // Set file status back to pending (ready for upload)
                if (fileObj) { fileObj.status = 'pending'; renderFileList(); }
            } catch(e) {
                content.innerHTML = `<span style="color:var(--error)">❌ ${e.message}</span>`;
                if (fileObj) { fileObj.status = 'pending'; renderFileList(); }
            }
        }

        async function submitUpload() {
            const btn=document.getElementById('submitBtn');
            if(currentTab==='file'){
                if(!files.length){showToast('Bitte Dateien auswählen','error');return;}
                btn.disabled=true;btn.innerHTML='<div class="spinner"></div> Hochladen...';
                const isBatch = files.length > 1;
                const batchResults = {success:0, papers:0, books:0, studies:0, general:0, duplicates:0, errors:0, items:[]};
                for(let i=0; i<files.length; i++){
                    const f = files[i];
                    if(f.status!=='pending')continue;
                    f.status='uploading';renderFileList();
                    if(isBatch) btn.innerHTML=`<div class="spinner"></div> ${i+1}/${files.length}...`;
                    try{
                        const fd=new FormData();fd.append('file',f.file);fd.append('database',selectedDB);
                        // Single file: send metadata from analysis fields
                        // Batch: let backend auto-detect everything
                        if(!isBatch) {
                            const fTitle = document.getElementById('fileTitle')?.value?.trim();
                            const fCat = document.getElementById('fileCategory')?.value;
                            const fLang = document.getElementById('fileLang')?.value;
                            if (fTitle) fd.append('title', fTitle);
                            if (fCat) fd.append('category', fCat);
                            if (fLang) fd.append('language', fLang);
                            if (fileTags.length) fd.append('tags', JSON.stringify(fileTags));
                        }
                        const r=await fetch(`${API}/upload`,{method:'POST',headers:H(),body:fd});
                        if(r.status===401){doLogout();showToast('Sitzung abgelaufen','error');return;}
                        if(r.status===409){
                            const dup=await r.json();
                            if(isBatch) {
                                batchResults.duplicates++;
                                batchResults.items.push({name:f.file.name, status:'duplicate', title:dup.title});
                                f.status='error'; f._statusText='Duplikat';
                            } else {
                                showDuplicateModal(dup);
                                f.status='error';
                            }
                            renderFileList();continue;
                        }
                        if(!r.ok)throw new Error(await r.text());
                        const result = await r.json();
                        f.status='success';f.progress=100;
                        f._result = result;
                        if(isBatch) {
                            batchResults.success++;
                            const ghUrl = result.github_url || '';
                            const cat = ghUrl.includes('/books/') ? 'books' : ghUrl.includes('/studies/') ? 'studies' : ghUrl.includes('/papers/') ? 'papers' : 'general';
                            batchResults[cat]++;
                            batchResults.items.push({name:f.file.name, status:'ok', title:result.title, category:cat, github:result.github_url});
                        }
                    }catch(e){
                        f.status='error';
                        if(isBatch) { batchResults.errors++; batchResults.items.push({name:f.file.name, status:'error', error:e.message}); }
                        else showToast(`${f.file.name}: ${e.message}`,'error');
                    }
                    renderFileList();
                }
                if(isBatch) {
                    // Show batch summary
                    showBatchSummary(batchResults);
                } else {
                    const ok=files.filter(f=>f.status==='success').length;
                    if(ok){
                        const lastOk = files.filter(f=>f.status==='success').pop();
                        const res = lastOk?._result || {};
                        const isPaper = res.github_url || (res.status && res.status.includes('github'));
                        showUploadProgress(res.title || lastOk?.file?.name || 'Dokument', isPaper, res, ok);
                    }
                }
            } else {
                const title=document.getElementById('textTitle').value.trim(),content=document.getElementById('textContent').value.trim();
                if(!content){showToast('Bitte Text eingeben','error');return;}
                btn.disabled=true;btn.innerHTML='<div class="spinner"></div> Speichern...';
                try{
                    const r=await fetch(`${API}/text`,{method:'POST',headers:{...H(),'Content-Type':'application/json'},body:JSON.stringify({title:title||'Untitled',content,category:document.getElementById('textCategory').value,language:document.getElementById('textLang').value,tags,database:selectedDB})});
                    if(r.status===401){doLogout();showToast('Sitzung abgelaufen','error');return;}
                    if(r.status===409){
                        const dup=await r.json();
                        showDuplicateModal(dup);
                        btn.disabled=false;btn.innerHTML='<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> In Datenbank laden';
                        return;
                    }
                    if(!r.ok)throw new Error(await r.text());
                    const result = await r.json();
                    const isPaper = result.github_url || (result.status && result.status.includes('github'));
                    showUploadProgress(result.title || title || 'Dokument', isPaper, result);
                    document.getElementById('textTitle').value='';document.getElementById('textContent').value='';
                    tags=[];renderTags();lastAnalyzedLength=0;
                    document.getElementById('textAnalysisPreview').style.display='none';
                }catch(e){showToast(e.message,'error');}
            }
            btn.disabled=false;btn.innerHTML='<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> In Datenbank laden';loadStats();
        }

        function showDuplicateModal(dup) {
            // Remove existing modals
            const old = document.getElementById('duplicateModal');
            if (old) old.remove();
            const old2 = document.getElementById('uploadProgressModal');
            if (old2) old2.remove();

            const catIcons = {paper:'📚',report:'📊',presentation:'📑',note:'📝',document:'📄'};
            const icon = catIcons[dup.category] || '📄';
            const tagsHtml = (dup.tags||[]).filter(t=>t.trim()).map(t =>
                `<span style="display:inline-block;padding:2px 10px;border-radius:12px;font-size:11px;background:rgba(99,102,241,0.15);color:rgba(129,140,248,0.9);margin:2px">${t.trim()}</span>`
            ).join('');

            const modal = document.createElement('div');
            modal.id = 'duplicateModal';
            modal.style.cssText = 'position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);animation:fadeIn 0.2s ease';

            // Phase 1: Progress animation (same style as upload)
            modal.innerHTML = `
                <div id="dupCard" style="background:var(--surface);border:1px solid var(--border);border-radius:16px;max-width:480px;width:92vw;padding:32px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.5);animation:slideUp 0.25s ease;text-align:center">
                    <div id="dupIcon" style="font-size:36px;margin-bottom:16px;transition:all 0.3s ease">📄</div>
                    <div id="dupTitle" style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Dokument wird geprüft...</div>
                    <div style="font-size:12px;color:var(--text-muted);margin-bottom:20px;max-width:360px;margin-left:auto;margin-right:auto">
                        ${(dup.title||'').length > 60 ? (dup.title||'').substring(0,57)+'…' : (dup.title||'')}
                    </div>
                    <div style="background:rgba(255,255,255,0.06);border-radius:8px;height:6px;overflow:hidden;margin-bottom:12px">
                        <div id="dupBar" style="height:100%;border-radius:8px;width:0%;transition:width 0.6s cubic-bezier(0.4,0,0.2,1);background:linear-gradient(90deg,rgba(99,102,241,0.8),rgba(52,211,153,0.8))"></div>
                    </div>
                    <div id="dupStep" style="font-size:12px;color:var(--text-secondary);min-height:18px;transition:opacity 0.2s">Dokument wird analysiert...</div>
                </div>
            `;
            document.body.appendChild(modal);

            // Phase 1 steps
            const steps = [
                { icon: '📄', text: 'Dokument wird analysiert...', pct: 20, delay: 0 },
                { icon: '🔬', text: 'Wissenschaftliche Signale erkannt...', pct: 45, delay: 1500 },
                { icon: '🧠', text: 'Abgleich mit der BEA-Wissensdatenbank...', pct: 70, delay: 3000 },
                { icon: '📚', text: 'Paper wurde identifiziert!', pct: 100, delay: 4500 }
            ];

            steps.forEach(step => {
                setTimeout(() => {
                    const bar = document.getElementById('dupBar');
                    const stepEl = document.getElementById('dupStep');
                    const iconEl = document.getElementById('dupIcon');
                    if (!bar) return;
                    bar.style.width = step.pct + '%';
                    if (iconEl) iconEl.textContent = step.icon;
                    if (stepEl) { stepEl.style.opacity = '0'; setTimeout(() => { if(stepEl) { stepEl.textContent = step.text; stepEl.style.opacity = '1'; }}, 200); }
                }, step.delay + 300);
            });

            // Phase 2: Transition to duplicate info (after progress completes)
            setTimeout(() => {
                const card = document.getElementById('dupCard');
                if (!card) return;
                card.style.transition = 'all 0.4s ease';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.96)';

                setTimeout(() => {
                    if (!card) return;
                    card.style.textAlign = 'left';
                    card.style.padding = '0';
                    card.style.maxWidth = '520px';
                    card.innerHTML = `
                        <!-- Header -->
                        <div style="background:linear-gradient(135deg,rgba(52,211,153,0.12),rgba(99,102,241,0.08));padding:28px 28px 20px;border-bottom:1px solid var(--border)">
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                                <div style="width:44px;height:44px;border-radius:12px;background:rgba(52,211,153,0.15);display:flex;align-items:center;justify-content:center;font-size:22px">✅</div>
                                <div>
                                    <div style="font-size:13px;color:rgba(52,211,153,0.9);font-weight:600;letter-spacing:0.3px">Bereits in der Wissensdatenbank</div>
                                    <div style="font-size:10px;color:var(--text-muted);margin-top:2px">Aufgenommen am ${dup.date}</div>
                                </div>
                            </div>
                            <div style="font-size:15px;font-weight:600;color:var(--text-primary);line-height:1.4">${icon} ${dup.title}</div>
                        </div>

                        <!-- Body -->
                        <div style="padding:20px 28px">
                            <p style="font-size:13px;color:var(--text-secondary);line-height:1.6;margin:0 0 16px">
                                Diese wissenschaftliche Arbeit wurde am <strong style="color:var(--text-primary)">${dup.date}</strong> erfolgreich in die BEATRIX-Wissensdatenbank aufgenommen.
                                Ein erneutes Hochladen ist nicht nötig.
                            </p>
                            ${tagsHtml ? `<div style="margin-bottom:16px">${tagsHtml}</div>` : ''}
                            <p style="font-size:12px;color:var(--text-muted);margin:0">
                                Ich kann dir aber helfen, dieses Paper besser zu verstehen:
                            </p>
                        </div>

                        <!-- Action Choices -->
                        <div style="padding:0 28px 24px;display:flex;flex-direction:column;gap:8px">
                            <button onclick="duplicateAction('explain','${dup.doc_id}','${escAttr(dup.title)}')" style="width:100%;padding:12px 16px;border-radius:10px;border:1px solid rgba(99,102,241,0.3);background:rgba(99,102,241,0.08);color:rgba(165,180,252,0.95);font-size:13px;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;transition:all 0.15s" onmouseenter="this.style.background='rgba(99,102,241,0.15)';this.style.borderColor='rgba(99,102,241,0.5)'" onmouseleave="this.style.background='rgba(99,102,241,0.08)';this.style.borderColor='rgba(99,102,241,0.3)'">
                                <span style="font-size:16px">🔍</span>
                                <div>
                                    <div style="font-weight:500">Zusammenfassung & Kernaussagen</div>
                                    <div style="font-size:11px;color:var(--text-muted);margin-top:2px">Was sind die wichtigsten Erkenntnisse dieses Papers?</div>
                                </div>
                            </button>
                            <button onclick="duplicateAction('relevance','${dup.doc_id}','${escAttr(dup.title)}')" style="width:100%;padding:12px 16px;border-radius:10px;border:1px solid rgba(52,211,153,0.3);background:rgba(52,211,153,0.08);color:rgba(110,231,183,0.95);font-size:13px;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;transition:all 0.15s" onmouseenter="this.style.background='rgba(52,211,153,0.15)';this.style.borderColor='rgba(52,211,153,0.5)'" onmouseleave="this.style.background='rgba(52,211,153,0.08)';this.style.borderColor='rgba(52,211,153,0.3)'">
                                <span style="font-size:16px">🧩</span>
                                <div>
                                    <div style="font-weight:500">Relevanz für unsere Projekte</div>
                                    <div style="font-size:11px;color:var(--text-muted);margin-top:2px">Wo spielt dieses Paper im BCM-Kontext eine Rolle?</div>
                                </div>
                            </button>
                            <button onclick="duplicateAction('connections','${dup.doc_id}','${escAttr(dup.title)}')" style="width:100%;padding:12px 16px;border-radius:10px;border:1px solid rgba(251,191,36,0.3);background:rgba(251,191,36,0.06);color:rgba(253,224,71,0.9);font-size:13px;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;transition:all 0.15s" onmouseenter="this.style.background='rgba(251,191,36,0.12)';this.style.borderColor='rgba(251,191,36,0.5)'" onmouseleave="this.style.background='rgba(251,191,36,0.06)';this.style.borderColor='rgba(251,191,36,0.3)'">
                                <span style="font-size:16px">🔗</span>
                                <div>
                                    <div style="font-weight:500">Verbindungen zu anderen Papers</div>
                                    <div style="font-size:11px;color:var(--text-muted);margin-top:2px">Welche verwandten Studien haben wir in der Wissensdatenbank?</div>
                                </div>
                            </button>
                        </div>

                        <!-- Footer -->
                        <div style="padding:0 28px 20px;text-align:center">
                            <button onclick="closeDuplicateModal()" style="padding:8px 24px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text-muted);font-size:12px;cursor:pointer;transition:all 0.15s" onmouseenter="this.style.borderColor='var(--text-secondary)'" onmouseleave="this.style.borderColor='var(--border)'">
                                Schliessen
                            </button>
                        </div>
                    `;
                    card.style.opacity = '1';
                    card.style.transform = 'scale(1)';
                }, 350);
            }, 6000); // Phase 2 starts after ~6s

            modal.addEventListener('click', (e) => { if (e.target === modal) closeDuplicateModal(); });
        }

        function escAttr(s) { return (s||'').replace(/'/g, "\\'").replace(/"/g, '&quot;'); }

        function closeDuplicateModal() {
            const m = document.getElementById('duplicateModal');
            if (m) m.remove();
            // Reset file list – remove errored files, re-enable button
            files = files.filter(f => f.status !== 'error');
            renderFileList(); updateCount();
            if (!files.length) {
                document.getElementById('fileAnalysisPreview').style.display = 'none';
                document.getElementById('fileMetaFields').style.display = '';
                // Reset meta fields
                document.getElementById('fileTitle').value = '';
                document.getElementById('fileCategory').value = 'general';
                document.getElementById('fileLang').value = 'de';
                fileTags = []; renderFileTags();
            }
            const btn = document.getElementById('submitBtn');
            btn.disabled = false;
            btn.innerHTML = '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> In Datenbank laden';
        }

        function showUploadProgress(title, isPaper, result, fileCount) {
            const old = document.getElementById('uploadProgressModal');
            if (old) old.remove();

            const modal = document.createElement('div');
            modal.id = 'uploadProgressModal';
            modal.style.cssText = 'position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);animation:fadeIn 0.2s ease';

            const steps = isPaper ? [
                { icon: '📄', text: 'Dokument wird analysiert...', pct: 15 },
                { icon: '🔬', text: 'Wissenschaftliche Signale erkannt...', pct: 30 },
                { icon: '🧠', text: 'Inhalte werden indexiert...', pct: 50 },
                { icon: '📚', text: 'Integration in die BEA-Wissensdatenbank...', pct: 70 },
                { icon: '🔗', text: 'Paper wird auf GitHub archiviert...', pct: 85 },
                { icon: '✅', text: 'Erfolgreich integriert!', pct: 100 }
            ] : [
                { icon: '📄', text: 'Dokument wird analysiert...', pct: 20 },
                { icon: '🧠', text: 'Inhalte werden indexiert...', pct: 50 },
                { icon: '📚', text: 'Integration in die BEA-Wissensdatenbank...', pct: 80 },
                { icon: '✅', text: 'Erfolgreich gespeichert!', pct: 100 }
            ];

            const countLabel = fileCount > 1 ? `${fileCount} Dateien` : '';

            modal.innerHTML = `
                <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;max-width:460px;width:90vw;padding:32px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.5);animation:slideUp 0.25s ease;text-align:center">
                    <div id="upProgressIcon" style="font-size:36px;margin-bottom:16px;transition:all 0.3s ease">📄</div>
                    <div style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:6px;line-height:1.4" id="upProgressTitle">${isPaper ? '📚 Wissenschaftliche Arbeit erkannt' : '📄 Dokument wird verarbeitet'}</div>
                    <div style="font-size:12px;color:var(--text-muted);margin-bottom:20px;max-width:360px;margin-left:auto;margin-right:auto" id="upProgressSubtitle">
                        ${title.length > 60 ? title.substring(0,57)+'…' : title}
                        ${countLabel ? `<span style="opacity:0.5"> · ${countLabel}</span>` : ''}
                    </div>
                    <!-- Progress bar -->
                    <div style="background:rgba(255,255,255,0.06);border-radius:8px;height:6px;overflow:hidden;margin-bottom:12px;position:relative">
                        <div id="upProgressBar" style="height:100%;border-radius:8px;width:0%;transition:width 0.6s cubic-bezier(0.4,0,0.2,1);background:linear-gradient(90deg,rgba(99,102,241,0.8),rgba(52,211,153,0.8))"></div>
                    </div>
                    <div id="upProgressStep" style="font-size:12px;color:var(--text-secondary);min-height:18px;transition:opacity 0.2s">Dokument wird analysiert...</div>
                </div>
            `;
            document.body.appendChild(modal);

            // Animate through steps
            const totalDuration = isPaper ? 12000 : 8000;
            const stepDelay = totalDuration / steps.length;

            steps.forEach((step, i) => {
                setTimeout(() => {
                    const bar = document.getElementById('upProgressBar');
                    const stepEl = document.getElementById('upProgressStep');
                    const iconEl = document.getElementById('upProgressIcon');
                    const titleEl = document.getElementById('upProgressTitle');
                    if (!bar) return;

                    bar.style.width = step.pct + '%';
                    if (stepEl) { stepEl.style.opacity = '0'; setTimeout(() => { stepEl.textContent = step.text; stepEl.style.opacity = '1'; }, 200); }
                    if (iconEl) iconEl.textContent = step.icon;

                    // Final step: show success state
                    if (i === steps.length - 1) {
                        bar.style.background = 'linear-gradient(90deg,rgba(52,211,153,0.9),rgba(52,211,153,0.7))';
                        if (titleEl) titleEl.innerHTML = '✅ Upload erfolgreich — Danke!';
                        setTimeout(() => {
                            const m = document.getElementById('uploadProgressModal');
                            if (!m) return;
                            const docId = result?.id || result?.document_id || '';
                            m.querySelector('div > div').innerHTML += `
                                <div style="margin-top:20px;animation:fadeIn 0.3s ease;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
                                    ${docId ? `<button onclick="document.getElementById('uploadProgressModal').remove();viewDocument('${docId}');setTimeout(()=>apeReviewDocument(),500)" style="padding:10px 24px;border-radius:10px;border:none;background:rgba(255,140,0,0.15);color:#ff8c00;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s" onmouseenter="this.style.background='rgba(255,140,0,0.25)'" onmouseleave="this.style.background='rgba(255,140,0,0.15)'">
                                        🔥 Jetzt APE-reviewen
                                    </button>` : ''}
                                    <button onclick="document.getElementById('uploadProgressModal').remove();files=[];renderFileList();updateCount();document.getElementById('fileAnalysisPreview').style.display='none';document.getElementById('fileMetaFields').style.display='';document.getElementById('fileTitle').value='';document.getElementById('fileCategory').value='general';document.getElementById('fileLang').value='de';fileTags=[];renderFileTags();loadStats();" style="padding:10px 32px;border-radius:10px;border:none;background:rgba(52,211,153,0.15);color:rgba(52,211,153,0.95);font-size:13px;font-weight:500;cursor:pointer;transition:all 0.15s" onmouseenter="this.style.background='rgba(52,211,153,0.25)'" onmouseleave="this.style.background='rgba(52,211,153,0.15)'">
                                        Weiter arbeiten
                                    </button>
                                </div>
                            `;
                        }, 600);
                    }
                }, stepDelay * i + 400); // +400ms initial delay
            });
        }

        function showBatchSummary(results) {
            const old = document.getElementById('uploadProgressModal');
            if (old) old.remove();

            const modal = document.createElement('div');
            modal.id = 'uploadProgressModal';
            modal.style.cssText = 'position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);animation:fadeIn 0.2s ease';

            const total = results.success + results.duplicates + results.errors;
            const cats = [];
            if (results.papers) cats.push(`📚 ${results.papers} Paper${results.papers>1?'s':''}`);
            if (results.books) cats.push(`📖 ${results.books} Buch/Bücher`);
            if (results.studies) cats.push(`📊 ${results.studies} Studie${results.studies>1?'n':''}`);
            if (results.general) cats.push(`📄 ${results.general} Dokument${results.general>1?'e':''}`);

            const catHtml = cats.length ? `<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:12px">${cats.map(c => `<span style="padding:4px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;font-size:12px">${c}</span>`).join('')}</div>` : '';

            const warnings = [];
            if (results.duplicates) warnings.push(`⚠️ ${results.duplicates} Duplikat${results.duplicates>1?'e':''}`);
            if (results.errors) warnings.push(`❌ ${results.errors} Fehler`);
            const warnHtml = warnings.length ? `<div style="margin-top:8px;font-size:11px;color:var(--text-muted)">${warnings.join(' · ')}</div>` : '';

            // Item list (scrollable)
            const itemsHtml = results.items.map(it => {
                const icon = it.status==='ok' ? (it.category==='papers'?'📚':it.category==='books'?'📖':it.category==='studies'?'📊':'📄') : it.status==='duplicate' ? '⚠️' : '❌';
                const statusColor = it.status==='ok' ? 'rgba(52,211,153,0.8)' : it.status==='duplicate' ? 'rgba(245,158,11,0.8)' : 'rgba(239,68,68,0.8)';
                const label = it.status==='ok' ? (it.title||it.name) : it.status==='duplicate' ? `${it.name} (Duplikat)` : `${it.name} (Fehler)`;
                return `<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:11px"><span>${icon}</span><span style="color:${statusColor};flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${label}</span></div>`;
            }).join('');

            modal.innerHTML = `
                <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;max-width:500px;width:90vw;padding:32px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.5);animation:slideUp 0.25s ease;text-align:center">
                    <div style="font-size:36px;margin-bottom:12px">📦</div>
                    <div style="font-size:16px;font-weight:600;color:var(--text-primary)">Batch-Upload abgeschlossen</div>
                    <div style="font-size:24px;font-weight:700;color:rgba(52,211,153,0.9);margin-top:8px">${results.success} von ${total} erfolgreich</div>
                    ${catHtml}${warnHtml}
                    <div style="max-height:200px;overflow-y:auto;margin-top:16px;padding:12px;background:rgba(0,0,0,0.15);border-radius:10px;text-align:left">
                        ${itemsHtml}
                    </div>
                    <div style="margin-top:20px">
                        <button onclick="document.getElementById('uploadProgressModal').remove();files=[];renderFileList();updateCount();loadStats();document.getElementById('fileAnalysisPreview').style.display='none';document.getElementById('fileMetaFields').style.display='';" style="padding:10px 32px;border-radius:10px;border:none;background:rgba(52,211,153,0.15);color:rgba(52,211,153,0.95);font-size:13px;font-weight:500;cursor:pointer;transition:all 0.15s" onmouseenter="this.style.background='rgba(52,211,153,0.25)'" onmouseleave="this.style.background='rgba(52,211,153,0.15)'">
                            Weiter arbeiten
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function duplicateAction(action, docId, title) {
            closeDuplicateModal();
            // Reset upload state
            files = []; renderFileList(); updateCount();
            document.getElementById('fileAnalysisPreview').style.display = 'none';
            document.getElementById('fileMetaFields').style.display = '';
            const btn = document.getElementById('submitBtn');
            btn.disabled = false;
            btn.innerHTML = '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> In Datenbank laden';

            // Switch to Chat section (showSection auto-starts new session)
            const navLink = document.querySelector('[data-section="chat"]');
            showSection('chat', navLink);

            // Pre-fill and auto-submit
            const prompts = {
                explain: `Fasse das Paper "${title}" zusammen: Was sind die Kernaussagen, Methodik und wichtigsten Erkenntnisse?`,
                relevance: `Erkläre mir, wo das Paper "${title}" im BCM-Kontext und für unsere Beratungsprojekte relevant ist. Welche Ψ-Dimensionen und Interventionstypen werden berührt?`,
                connections: `Welche anderen Papers in unserer Wissensdatenbank sind thematisch verwandt mit "${title}"? Zeige mir die Verbindungen und wie sie sich ergänzen.`
            };
            const input = document.getElementById('chatInput');
            if (input && prompts[action]) {
                input.value = prompts[action];
                input.style.height = 'auto';
                input.style.height = input.scrollHeight + 'px';
                // Auto-submit after short delay for UI to settle
                setTimeout(() => sendChat(), 300);
            }
        }

        let _allDocs = [];
        let _docFilter = 'docs'; // default: no chat

        async function loadDocuments() {
            const w=document.getElementById('docTableWrapper');
            try{const r=await fetch(`${API}/documents`,{headers:H()});if(r.status===401){doLogout();return;}
                _allDocs=await r.json();
                if(!_allDocs.length){w.innerHTML=`<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><h3>Noch keine Dokumente</h3><p>Lade dein erstes Dokument hoch.</p></div>`;return;}
                renderDocFilters();
                renderDocTable();
            }catch(e){w.innerHTML='<p style="color:var(--error)">Fehler beim Laden</p>';}
        }

        function renderDocFilters() {
            const bar = document.getElementById('docFilterBar');
            if (!bar) return;
            const chatCount = _allDocs.filter(d => (d.file_type||d.source_type)==='chat').length;
            const paperCount = _allDocs.filter(d => d.database_target==='research' || d.metadata?.is_paper).length;
            const docCount = _allDocs.filter(d => (d.file_type||d.source_type)!=='chat').length;
            const filters = [
                { id:'docs', label:`📄 Dokumente (${docCount})`, active: _docFilter==='docs' },
                { id:'papers', label:`📚 Papers (${paperCount})`, active: _docFilter==='papers' },
                { id:'chat', label:`💬 Chat (${chatCount})`, active: _docFilter==='chat' },
                { id:'all', label:`Alle (${_allDocs.length})`, active: _docFilter==='all' }
            ];
            bar.innerHTML = filters.map(f =>
                `<button onclick="_docFilter='${f.id}';renderDocFilters();renderDocTable()" style="padding:6px 14px;font-size:12px;border-radius:8px;cursor:pointer;transition:all 0.15s;border:1px solid ${f.active?'var(--accent)':'var(--border)'};background:${f.active?'rgba(42,127,142,0.15)':'transparent'};color:${f.active?'var(--accent)':'rgba(255,255,255,0.4)'};font-weight:${f.active?'600':'400'}">${f.label}</button>`
            ).join('');
        }

        function renderDocTable() {
            const w=document.getElementById('docTableWrapper');
            let docs = _allDocs;
            if (_docFilter === 'docs') docs = docs.filter(d => (d.file_type||d.source_type)!=='chat');
            else if (_docFilter === 'papers') docs = docs.filter(d => d.database_target==='research' || d.metadata?.is_paper);
            else if (_docFilter === 'chat') docs = docs.filter(d => (d.file_type||d.source_type)==='chat');

            if(!docs.length){w.innerHTML=`<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.3)">Keine Einträge in dieser Kategorie.</div>`;return;}
            const db={knowledge_base:'Knowledge Base',bcm_axioms:'BCM Axiome',research:'Research'};
            const clC={L0:'#ef4444',L1:'#f59e0b',L2:'#3b82f6',L3:'#10b981'};
            const ilC={I1:'#ef4444',I2:'#f59e0b',I3:'#3b82f6',I4:'#8b5cf6',I5:'#10b981'};
            w.innerHTML=`<table class="doc-table"><thead><tr><th>Dokument</th><th>Typ</th><th>Level</th><th>Datenbank</th><th>Von</th><th>Datum</th><th>Status</th></tr></thead><tbody>${docs.map(d=>{const date=new Date(d.created_at).toLocaleDateString('de-CH',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});const user=d.uploaded_by?(d.uploaded_by.split('@')[0].split('.').map(p=>p[0]?.toUpperCase()||'').join('')):'–';return`<tr onclick="viewDocument('${d.id}')" style="cursor:pointer" title="Klicken zum Anzeigen"><td class="doc-name">${d.title}</td><td><span class="format-badge">${(d.file_type||d.source_type).toUpperCase()}</span></td><td style="white-space:nowrap;font-size:11px">${d.metadata?.content_level?`<span style="color:${clC[d.metadata.content_level]||'#666'};font-weight:600">${d.metadata.content_level}</span>`:'—'}${d.metadata?.integration_level?` <span style="color:${ilC[d.metadata.integration_level]||'#666'}">${d.metadata.integration_level}</span>`:''}</td><td>${db[d.database_target]||d.database_target}</td><td style="font-size:11px;color:rgba(255,255,255,0.4)">${user}</td><td>${date}</td><td><span class="status-badge">${d.status}</span></td></tr>`;}).join('')}</tbody></table>`;
        }

        let currentDocId = null;

        async function viewDocument(docId) {
            currentDocId = docId;
            // Show modal with loading state
            let modal = document.getElementById('docDetailModal');
            if (!modal) {
                document.body.insertAdjacentHTML('beforeend', `
                <div id="docDetailModal" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);padding:20px;overflow-y:auto" onclick="if(event.target===this)this.style.display='none'">
                    <div style="max-width:900px;margin:40px auto;background:var(--navy-card);border:1px solid var(--border);border-radius:16px;overflow:hidden">
                        <div id="docDetailHeader" style="padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
                            <div id="docDetailTitle" style="font-size:16px;font-weight:600;color:var(--text-primary);flex:1;margin-right:12px"></div>
                            <div style="display:flex;gap:8px;align-items:center">
                                <span id="docDetailBadges"></span>
                                <button id="docReviewBtn" onclick="reviewDocument()" style="padding:5px 12px;background:rgba(139,92,246,0.15);border:1px solid rgba(139,92,246,0.3);border-radius:8px;color:#a78bfa;font-size:11px;cursor:pointer;white-space:nowrap" title="Behavioral Economics Review">🧠 Review</button>
                                <button id="docApeReviewBtn" onclick="apeReviewDocument()" style="padding:5px 12px;background:rgba(255,140,0,0.15);border:1px solid rgba(255,140,0,0.3);border-radius:8px;color:#ff8c00;font-size:11px;cursor:pointer;white-space:nowrap" title="APE Multi-Model Review (Claude + GPT + Grok + Gemini)">🔥 APE Review</button>
                                <button id="docTriageBtn" onclick="triageDocument()" style="padding:5px 12px;background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);border-radius:8px;color:#fbbf24;font-size:11px;cursor:pointer;white-space:nowrap" title="PURSUE/CONSIDER/SKIP Triage">⚡ Triage</button>
                                <button id="docIntegrityBtn" onclick="integrityCheckDocument()" style="padding:5px 12px;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);border-radius:8px;color:#f87171;font-size:11px;cursor:pointer;white-space:nowrap" title="Integrity Scan">🔍 Integrity</button>
                                <button id="docMultiReviewBtn" onclick="multiReviewDocument()" style="padding:5px 12px;background:rgba(52,211,153,0.15);border:1px solid rgba(52,211,153,0.3);border-radius:8px;color:#34d399;font-size:11px;cursor:pointer;white-space:nowrap" title="3 Perspektiven Review">⚔️ Multi</button>
                                <button id="docClassifyBtn" onclick="classifyDocument()" style="padding:5px 12px;background:rgba(42,127,142,0.15);border:1px solid rgba(42,127,142,0.3);border-radius:8px;color:var(--accent);font-size:11px;cursor:pointer;white-space:nowrap">🧬 Klassifizieren</button>
                                <button onclick="document.getElementById('docDetailModal').style.display='none'" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer;padding:4px 8px">✕</button>
                            </div>
                        </div>
                        <div id="docDetailMeta" style="padding:12px 24px;border-bottom:1px solid var(--border);font-size:12px;color:var(--text-secondary);display:flex;flex-wrap:wrap;gap:16px"></div>
                        <div id="docDetailClassification" style="display:none;padding:16px 24px;border-bottom:1px solid var(--border)"></div>
                        <div id="docDetailReview" style="display:none;padding:16px 24px;border-bottom:1px solid var(--border)"></div>
                        <div id="docDetailContent" style="padding:24px;max-height:70vh;overflow-y:auto">
                            <pre style="white-space:pre-wrap;word-wrap:break-word;font-family:inherit;font-size:13px;line-height:1.7;color:var(--text-secondary);margin:0"></pre>
                        </div>
                    </div>
                </div>`);
                modal = document.getElementById('docDetailModal');
            }

            document.getElementById('docDetailTitle').textContent = 'Laden...';
            document.getElementById('docDetailBadges').innerHTML = '';
            document.getElementById('docDetailMeta').innerHTML = '';
            document.getElementById('docDetailContent').querySelector('pre').textContent = '';
            document.getElementById('docDetailClassification').style.display = 'none';
            document.getElementById('docDetailClassification').innerHTML = '';
            document.getElementById('docDetailReview').style.display = 'none';
            document.getElementById('docDetailReview').innerHTML = '';
            modal.style.display = '';

            try {
                const r = await fetch(`${API}/documents/${docId}`, {headers: H()});
                if (!r.ok) throw new Error('Fehler beim Laden');
                const d = await r.json();

                document.getElementById('docDetailTitle').textContent = d.title;

                // Badges
                const typeBadge = `<span class="format-badge">${(d.file_type || d.source_type).toUpperCase()}</span>`;
                const statusBadge = `<span class="status-badge">${d.status}</span>`;
                const paperBadge = d.metadata?.paper_detected ? '<span style="background:rgba(52,211,153,0.1);color:#34d399;padding:2px 8px;border-radius:6px;font-size:11px">📚 Paper</span>' : '';
                const clBadge = d.metadata?.content_level ? `<span style="background:rgba(59,130,246,0.1);color:#60a5fa;padding:2px 8px;border-radius:6px;font-size:11px">${d.metadata.content_level}</span>` : '';
                const ilBadge = d.metadata?.integration_level ? `<span style="background:rgba(139,92,246,0.1);color:#a78bfa;padding:2px 8px;border-radius:6px;font-size:11px">${d.metadata.integration_level}</span>` : '';
                document.getElementById('docDetailBadges').innerHTML = `${paperBadge} ${clBadge} ${ilBadge} ${typeBadge} ${statusBadge}`;

                // Update classify button visibility
                const classBtn = document.getElementById('docClassifyBtn');
                if (classBtn) classBtn.style.display = d.metadata?.classified_at ? 'none' : '';

                // Meta info
                const date = new Date(d.created_at).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
                const dbNames = {knowledge_base:'Knowledge Base', bcm_axioms:'BCM Axiome', research:'Research'};
                let metaHtml = `<span>📅 ${date}</span>`;
                metaHtml += `<span>📂 ${dbNames[d.database_target] || d.database_target}</span>`;
                if (d.uploaded_by) metaHtml += `<span>👤 ${d.uploaded_by}</span>`;
                if (d.file_size) metaHtml += `<span>📦 ${(d.file_size / 1024).toFixed(0)} KB</span>`;
                if (d.content) metaHtml += `<span>📝 ${d.content.length.toLocaleString()} Zeichen</span>`;
                if (d.language) metaHtml += `<span>🌐 ${d.language}</span>`;
                if (d.github_url) metaHtml += `<a href="${d.github_url}" target="_blank" style="color:var(--accent);text-decoration:none">🔗 GitHub</a>`;
                if (d.tags?.length) metaHtml += `<span>🏷️ ${d.tags.join(', ')}</span>`;
                if (d.metadata?.paper_id) metaHtml += `<span style="font-family:monospace;font-size:11px">🆔 ${d.metadata.paper_id}</span>`;
                document.getElementById('docDetailMeta').innerHTML = metaHtml;

                // Show existing classification if present
                renderDocClassification(d.metadata);

                // Check for existing BEATRIX review
                renderDocReview(d.metadata, d.id);

                // Content
                const content = d.content || '(Kein Inhalt)';
                const pre = document.getElementById('docDetailContent').querySelector('pre');
                if (content.length > 50000) {
                    pre.textContent = content.slice(0, 50000) + `\n\n... [${(content.length / 1000).toFixed(0)}K Zeichen, gekürzt für Anzeige]`;
                } else {
                    pre.textContent = content;
                }
            } catch(e) {
                document.getElementById('docDetailTitle').textContent = 'Fehler';
                document.getElementById('docDetailContent').querySelector('pre').textContent = e.message;
            }
        }

        function renderDocClassification(meta) {
            const el = document.getElementById('docDetailClassification');
            if (!meta?.classified_at && !meta?.content_level) { el.style.display = 'none'; return; }
            el.style.display = '';

            const clColors = {L0:'#ef4444',L1:'#f59e0b',L2:'#3b82f6',L3:'#10b981'};
            const ilColors = {I1:'#ef4444',I2:'#f59e0b',I3:'#3b82f6',I4:'#8b5cf6',I5:'#10b981'};
            const clDescs = {L0:'Minimal',L1:'Basis (Abstract)',L2:'Strukturiert',L3:'Volltext'};
            const ilDescs = {I1:'MINIMAL',I2:'STANDARD',I3:'CASE',I4:'THEORY',I5:'FULL'};

            let html = '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">';

            // Content Level + Integration Level boxes
            if (meta.content_level) {
                html += `<div style="flex:1;min-width:140px;padding:8px 12px;background:rgba(0,0,0,0.15);border-radius:8px;border-left:3px solid ${clColors[meta.content_level]||'#666'}">
                    <div style="font-size:9px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted)">Content</div>
                    <div style="font-size:18px;font-weight:700;color:${clColors[meta.content_level]||'#fff'}">${meta.content_level}</div>
                    <div style="font-size:10px;color:var(--text-secondary)">${clDescs[meta.content_level]||''}</div>
                </div>`;
            }
            if (meta.integration_level) {
                html += `<div style="flex:1;min-width:140px;padding:8px 12px;background:rgba(0,0,0,0.15);border-radius:8px;border-left:3px solid ${ilColors[meta.integration_level]||'#666'}">
                    <div style="font-size:9px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted)">Integration</div>
                    <div style="font-size:18px;font-weight:700;color:${ilColors[meta.integration_level]||'#fff'}">${meta.integration_level}</div>
                    <div style="font-size:10px;color:var(--text-secondary)">${ilDescs[meta.integration_level]||''}</div>
                </div>`;
            }

            // Evidence Tier
            if (meta.ebf?.evidence_tier) {
                const tierLabel = {1:'🥇 Gold',2:'🥈 Silber',3:'🥉 Bronze'};
                const tierColor = {1:'#fbbf24',2:'#9ca3af',3:'#b45309'};
                html += `<div style="flex:1;min-width:140px;padding:8px 12px;background:rgba(0,0,0,0.15);border-radius:8px;border-left:3px solid ${tierColor[meta.ebf.evidence_tier]||'#666'}">
                    <div style="font-size:9px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted)">Evidenz</div>
                    <div style="font-size:16px;font-weight:700;color:${tierColor[meta.ebf.evidence_tier]||'#fff'}">${tierLabel[meta.ebf.evidence_tier]||'?'}</div>
                    <div style="font-size:10px;color:var(--text-secondary)">${meta.ebf.evidence_tier_reason||''}</div>
                </div>`;
            }
            html += '</div>';

            // Structural S1-S6
            if (meta.structural) {
                const sL = {S1_research_question:'S1 Forschungsfrage',S2_methodology:'S2 Methodik',S3_sample_data:'S3 Stichprobe',S4_findings:'S4 Ergebnisse',S5_validity:'S5 Validität',S6_reproducibility:'S6 Reproduzierbarkeit'};
                html += `<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">${Object.entries(meta.structural).map(([k,v])=>`<span style="padding:2px 6px;border-radius:4px;font-size:10px;${v?'background:rgba(52,211,153,0.1);color:#34d399':'background:rgba(255,255,255,0.03);color:var(--text-muted)'}">${v?'✓':'○'} ${sL[k]||k}</span>`).join('')}</div>`;
            }

            // EBF Dimensions
            if (meta.ebf?.ebf_dimensions?.length) {
                html += `<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:4px">${meta.ebf.ebf_dimensions.map(d=>`<span style="padding:2px 8px;background:rgba(42,127,142,0.12);border:1px solid rgba(42,127,142,0.25);border-radius:4px;font-size:10px;color:var(--accent)" title="${d.connection||''}">${d.dimension}</span>`).join('')}</div>`;
            }

            // Ψ Dimensions
            if (meta.ebf?.psi_dimensions?.length) {
                const psiIcons = {'Ψ_I':'📋','Ψ_S':'👥','Ψ_C':'🧠','Ψ_K':'🌍','Ψ_E':'💰','Ψ_T':'⏰','Ψ_M':'🔧','Ψ_P':'🎯'};
                html += `<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:4px">${meta.ebf.psi_dimensions.map(p=>`<span style="padding:2px 8px;background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2);border-radius:4px;font-size:10px;color:#a78bfa" title="${p.relevance||''}">${psiIcons[p.psi]||'Ψ'} ${p.psi}</span>`).join('')}</div>`;
            }

            // Key Findings
            if (meta.ebf?.key_findings?.length) {
                html += `<div style="margin-top:6px">${meta.ebf.key_findings.slice(0,3).map(f=>`<div style="font-size:11px;color:var(--text-secondary);padding:2px 0">• ${f.finding}${f.effect_size?' <span style="color:#34d399">(d='+f.effect_size+')</span>':''}</div>`).join('')}</div>`;
            }

            // Classification timestamp
            if (meta.classified_at) {
                const cDate = new Date(meta.classified_at).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
                html += `<div style="margin-top:8px;font-size:10px;color:var(--text-muted)">Klassifiziert: ${cDate}${meta.classification_method === 'bulk_heuristic' ? ' (Bulk, ohne Claude)' : ' (Claude EBF)'} <button onclick="classifyDocument()" style="margin-left:8px;padding:2px 8px;background:rgba(42,127,142,0.1);border:1px solid rgba(42,127,142,0.2);border-radius:4px;color:var(--accent);font-size:10px;cursor:pointer">🔄 Neu klassifizieren</button></div>`;
            }

            el.innerHTML = html;
        }

        async function classifyDocument() {
            if (!currentDocId) return;
            const btn = document.getElementById('docClassifyBtn');
            if (btn) { btn.disabled = true; btn.textContent = '⏳ Analysiere...'; }

            try {
                const r = await fetch(`${API}/documents/${currentDocId}/classify`, {
                    method: 'POST', headers: H()
                });
                if (!r.ok) throw new Error(await r.text());
                const d = await r.json();
                showToast(`Klassifiziert: ${d.content_level} / ${d.integration_level || '—'}`, 'success');
                // Reload detail
                viewDocument(currentDocId);
                // Reload list
                loadDocuments();
            } catch(e) {
                showToast(`Fehler: ${e.message}`, 'error');
                if (btn) { btn.disabled = false; btn.textContent = '🧬 Klassifizieren'; }
            }
        }

        function renderDocReview(meta, docId) {
            const el = document.getElementById('docDetailReview');
            if (!meta?.review_type && !meta?.reviewed_doc_id) {
                // Check if this doc HAS a review (search for it)
                el.style.display = 'none';
                return;
            }
            // If this IS a review, show review metadata
            if (meta?.review_type === 'beatrix_behavioral_economics') {
                el.style.display = '';
                const scoreColor = meta.score >= 65 ? '#34d399' : meta.score >= 45 ? '#fbbf24' : '#ef4444';
                const verdictColor = {'ACCEPT':'#34d399','CONDITIONAL ACCEPT':'#60a5fa','MAJOR REVISION':'#f59e0b','REJECT':'#ef4444'}[meta.verdict] || '#9ca3af';
                const recLabel = meta.score >= 65 ? 'PURSUE' : meta.score >= 45 ? 'CONSIDER' : 'SKIP';
                let html = `<div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px">
                    <div style="display:flex;align-items:baseline;gap:6px">
                        <span style="font-size:9px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted)">BEATRIX Review</span>
                        <span style="font-size:22px;font-weight:700;color:${scoreColor}">${meta.score}</span>
                        <span style="font-size:12px;color:var(--text-muted)">/100</span>
                        <span style="padding:2px 8px;background:${scoreColor}22;color:${scoreColor};border-radius:4px;font-size:10px;font-weight:600">${recLabel}</span>
                    </div>
                    <div style="padding:3px 10px;background:${verdictColor}22;color:${verdictColor};border-radius:6px;font-size:11px;font-weight:600">${meta.verdict || 'UNKNOWN'}</span></div>
                </div>`;
                // Ψ-Dimensions
                if (meta.psi_dimensions?.length) {
                    html += `<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">${meta.psi_dimensions.map(p=>`<span style="padding:2px 8px;background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2);border-radius:4px;font-size:10px;color:#a78bfa">Ψ${p}</span>`).join('')}</div>`;
                }
                // Behavioral mechanisms
                if (meta.behavioral_mechanisms?.length) {
                    html += `<div style="display:flex;flex-wrap:wrap;gap:4px">${meta.behavioral_mechanisms.map(m=>`<span style="padding:2px 8px;background:rgba(42,127,142,0.08);border:1px solid rgba(42,127,142,0.2);border-radius:4px;font-size:10px;color:var(--accent)">${m.replace(/_/g,' ')}</span>`).join('')}</div>`;
                }
                // Link to reviewed doc
                if (meta.reviewed_doc_id) {
                    html += `<div style="margin-top:8px"><a href="#" onclick="viewDocument('${meta.reviewed_doc_id}');return false" style="font-size:11px;color:var(--accent)">📄 ${meta.reviewed_doc_title || 'Originaldokument anzeigen'}</a></div>`;
                }
                el.innerHTML = html;
            }
        }

        async function reviewDocument() {
            if (!currentDocId) return;
            const btn = document.getElementById('docReviewBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<span class="loading-spinner" style="width:12px;height:12px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:4px"></span> Analysiere...'; }

            // Show progress in review section
            const reviewEl = document.getElementById('docDetailReview');
            reviewEl.style.display = '';
            reviewEl.innerHTML = `<div style="display:flex;align-items:center;gap:10px;padding:12px 0">
                <div class="loading-spinner" style="width:20px;height:20px;border-width:2px"></div>
                <div>
                    <div style="font-size:13px;color:var(--text-primary)">BEATRIX Behavioral Economics Review wird erstellt...</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:2px">BCM 2.0 + Ψ-Dimensionen Analyse (ca. 30-60 Sek.)</div>
                </div>
            </div>`;

            try {
                const r = await fetch(`${API}/documents/${currentDocId}/review`, {
                    method: 'POST', headers: H()
                });
                if (!r.ok) {
                    const err = await r.text();
                    throw new Error(err);
                }
                const d = await r.json();

                // Show success with score
                const scoreColor = d.score >= 65 ? '#34d399' : d.score >= 45 ? '#fbbf24' : '#ef4444';
                const verdictColor = {'ACCEPT':'#34d399','CONDITIONAL ACCEPT':'#60a5fa','MAJOR REVISION':'#f59e0b','REJECT':'#ef4444'}[d.verdict] || '#9ca3af';
                const recLabel = d.score >= 65 ? 'PURSUE' : d.score >= 45 ? 'CONSIDER' : 'SKIP';
                const tags = d.tags || {};

                let html = `<div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px">
                    <div style="display:flex;align-items:baseline;gap:6px">
                        <span style="font-size:9px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted)">BEATRIX Review</span>
                        <span style="font-size:26px;font-weight:700;color:${scoreColor}">${d.score}</span>
                        <span style="font-size:12px;color:var(--text-muted)">/100</span>
                        <span style="padding:3px 10px;background:${scoreColor}22;color:${scoreColor};border-radius:6px;font-size:11px;font-weight:600">${recLabel}</span>
                    </div>
                    <div style="padding:4px 12px;background:${verdictColor}22;color:${verdictColor};border-radius:6px;font-size:12px;font-weight:600">${d.verdict}</div>
                </div>`;

                // Ψ-Dimensions
                if (tags.psi_dimensions?.length) {
                    const psiNames = {1:'Risk Perception',2:'Time Preferences',3:'Social Preferences',4:'Reference Dependence',5:'Attention/Salience',6:'Self-Control',7:'Beliefs & Mental Models',8:'Identity & Self-Image'};
                    html += `<div style="margin-bottom:8px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:4px">Ψ-Dimensionen</div><div style="display:flex;flex-wrap:wrap;gap:4px">${tags.psi_dimensions.map(p=>`<span style="padding:3px 10px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.25);border-radius:6px;font-size:10px;color:#a78bfa" title="${psiNames[p]||''}">Ψ${p} ${psiNames[p]||''}</span>`).join('')}</div></div>`;
                }

                // Behavioral mechanisms
                if (tags.behavioral_mechanisms?.length) {
                    html += `<div style="margin-bottom:8px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:4px">Behavioral Mechanisms</div><div style="display:flex;flex-wrap:wrap;gap:4px">${tags.behavioral_mechanisms.map(m=>`<span style="padding:3px 10px;background:rgba(42,127,142,0.1);border:1px solid rgba(42,127,142,0.25);border-radius:6px;font-size:10px;color:var(--accent)">${m.replace(/_/g,' ')}</span>`).join('')}</div></div>`;
                }

                // BCM Dimensions
                if (tags.bcm_dimensions?.length) {
                    html += `<div style="margin-bottom:8px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:4px">BCM Dimensions</div><div style="display:flex;flex-wrap:wrap;gap:4px">${tags.bcm_dimensions.map(d=>`<span style="padding:3px 10px;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-radius:6px;font-size:10px;color:#fbbf24">${d.replace(/_/g,' ')}</span>`).join('')}</div></div>`;
                }

                // Links
                html += `<div style="display:flex;gap:12px;margin-top:10px;font-size:11px">`;
                if (d.review_id) html += `<a href="#" onclick="viewDocument('${d.review_id}');return false" style="color:#a78bfa;text-decoration:none">📖 Vollständiges Review anzeigen</a>`;
                if (d.github?.url) html += `<a href="${d.github.url}" target="_blank" style="color:var(--accent);text-decoration:none">🔗 GitHub</a>`;
                html += `</div>`;

                reviewEl.innerHTML = html;
                showToast(`BEATRIX Review: ${d.score}/100 – ${d.verdict}`, 'success');
                if (btn) { btn.disabled = false; btn.innerHTML = '🧠 BEATRIX Review'; }

            } catch(e) {
                reviewEl.innerHTML = `<div style="color:#ef4444;font-size:12px">❌ Review fehlgeschlagen: ${e.message?.slice(0,200)}</div>`;
                showToast(`Review-Fehler: ${e.message?.slice(0,100)}`, 'error');
                if (btn) { btn.disabled = false; btn.innerHTML = '🧠 Review'; }
            }
        }

        async function triageDocument() {
            if (!currentDocId) return;
            const btn = document.getElementById('docTriageBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '⏳ Triage...'; }
            const reviewEl = document.getElementById('docDetailReview');
            reviewEl.style.display = '';
            reviewEl.innerHTML = `<div style="display:flex;align-items:center;gap:10px;padding:12px 0">
                <div class="loading-spinner" style="width:20px;height:20px;border-width:2px"></div>
                <div><div style="font-size:13px;color:var(--text-primary)">Paper-Triage: PURSUE / CONSIDER / SKIP</div>
                <div style="font-size:11px;color:var(--text-muted)">Bewertung + Conditions (ca. 15-30 Sek.)</div></div></div>`;
            try {
                const r = await fetch(`${API}/documents/${currentDocId}/triage`, {method:'POST',headers:H()});
                if (!r.ok) throw new Error(await r.text());
                const d = await r.json();
                const sc = d.score||0;
                const rec = d.recommendation||'?';
                const recColor = {'PURSUE':'#34d399','CONSIDER':'#fbbf24','SKIP':'#ef4444'}[rec]||'#9ca3af';
                let html = `<div style="display:flex;align-items:baseline;gap:8px;margin-bottom:10px">
                    <span style="font-size:9px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted)">Triage</span>
                    <span style="font-size:26px;font-weight:700;color:${recColor}">${sc}</span>
                    <span style="font-size:12px;color:var(--text-muted)">/100</span>
                    <span style="padding:3px 12px;background:${recColor}22;color:${recColor};border-radius:6px;font-size:12px;font-weight:700">${rec}</span>
                </div>`;
                if (d.dimensions) {
                    html += `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">${Object.entries(d.dimensions).map(([k,v])=>`<span style="padding:4px 10px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:6px;font-size:10px"><span style="color:var(--text-muted)">${k.replace(/_/g,' ')}</span> <strong style="color:${v.score>=18?'#34d399':v.score>=13?'#fbbf24':'#ef4444'}">${v.score}/25</strong></span>`).join('')}</div>`;
                }
                if (d.conditions?.length) {
                    html += `<div style="margin-bottom:8px"><div style="font-size:9px;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px">⚠️ Conditions</div>${d.conditions.map(c=>`<div style="font-size:11px;color:#fbbf24;padding:2px 0">→ ${c}</div>`).join('')}</div>`;
                }
                if (d.one_line_summary) html += `<div style="font-size:11px;color:var(--text-secondary);font-style:italic">${d.one_line_summary}</div>`;
                if (d.kill_reason) html += `<div style="font-size:11px;color:#ef4444;margin-top:4px">❌ Kill: ${d.kill_reason}</div>`;
                reviewEl.innerHTML = html;
                showToast(`Triage: ${sc}/100 → ${rec}`, 'success');
            } catch(e) {
                reviewEl.innerHTML = `<div style="color:#ef4444;font-size:12px">❌ Triage fehlgeschlagen: ${e.message?.slice(0,200)}</div>`;
                showToast(`Triage-Fehler`, 'error');
            }
            if (btn) { btn.disabled = false; btn.innerHTML = '⚡ Triage'; }
        }

        async function integrityCheckDocument() {
            if (!currentDocId) return;
            const btn = document.getElementById('docIntegrityBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '⏳ Scanning...'; }
            const reviewEl = document.getElementById('docDetailReview');
            reviewEl.style.display = '';
            reviewEl.innerHTML = `<div style="display:flex;align-items:center;gap:10px;padding:12px 0">
                <div class="loading-spinner" style="width:20px;height:20px;border-width:2px"></div>
                <div><div style="font-size:13px;color:var(--text-primary)">Integrity Scan: 6 Kategorien</div>
                <div style="font-size:11px;color:var(--text-muted)">Claims, Quellen, Methodik, Limitationen (ca. 20-40 Sek.)</div></div></div>`;
            try {
                const r = await fetch(`${API}/documents/${currentDocId}/integrity-check`, {method:'POST',headers:H()});
                if (!r.ok) throw new Error(await r.text());
                const d = await r.json();
                const verdict = d.overall_verdict||'?';
                const verdictColor = verdict==='CLEAN'?'#34d399':'#ef4444';
                const flags = d.flags||[];
                const highF = flags.filter(f=>f.severity==='HIGH').length;
                const medF = flags.filter(f=>f.severity==='MEDIUM').length;
                let html = `<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                    <span style="font-size:9px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted)">Integrity</span>
                    <span style="padding:4px 14px;background:${verdictColor}22;color:${verdictColor};border-radius:6px;font-size:13px;font-weight:700">${verdict==='CLEAN'?'✅':'⚠️'} ${verdict}</span>
                    <span style="font-size:11px;color:var(--text-muted)">${highF} HIGH · ${medF} MEDIUM · ${flags.length-highF-medF} LOW</span>
                </div>`;
                if (flags.length) {
                    html += `<div style="display:flex;flex-direction:column;gap:4px">${flags.slice(0,6).map(f=>{
                        const sColor = {HIGH:'#ef4444',MEDIUM:'#fbbf24',LOW:'#9ca3af'}[f.severity]||'#666';
                        return `<div style="padding:6px 10px;background:rgba(0,0,0,0.15);border-left:3px solid ${sColor};border-radius:0 6px 6px 0;font-size:11px">
                            <span style="color:${sColor};font-weight:600">[${f.severity}]</span> <span style="color:var(--text-secondary)">${f.category?.replace(/_/g,' ')}</span>
                            <div style="color:var(--text-muted);font-size:10px;margin-top:2px">${f.evidence?.slice(0,150)||''}</div>
                        </div>`;}).join('')}</div>`;
                }
                if (d.summary) html += `<div style="font-size:11px;color:var(--text-secondary);margin-top:8px">${d.summary}</div>`;
                reviewEl.innerHTML = html;
                showToast(`Integrity: ${verdict} (${highF}H/${medF}M)`, verdict==='CLEAN'?'success':'error');
            } catch(e) {
                reviewEl.innerHTML = `<div style="color:#ef4444;font-size:12px">❌ Integrity Scan fehlgeschlagen: ${e.message?.slice(0,200)}</div>`;
            }
            if (btn) { btn.disabled = false; btn.innerHTML = '🔍 Integrity'; }
        }

        async function multiReviewDocument() {
            if (!currentDocId) return;
            const btn = document.getElementById('docMultiReviewBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '⏳ 3 Reviews...'; }
            const reviewEl = document.getElementById('docDetailReview');
            reviewEl.style.display = '';
            reviewEl.innerHTML = `<div style="display:flex;align-items:center;gap:10px;padding:12px 0">
                <div class="loading-spinner" style="width:20px;height:20px;border-width:2px"></div>
                <div><div style="font-size:13px;color:var(--text-primary)">Multi-Perspektiven Review wird erstellt...</div>
                <div style="font-size:11px;color:var(--text-muted)">🔬 Analytisch + 🏢 Praxis + 😈 Devil's Advocate (ca. 60-90 Sek.)</div></div></div>`;
            try {
                const r = await fetch(`${API}/documents/${currentDocId}/multi-review`, {method:'POST',headers:H()});
                if (!r.ok) throw new Error(await r.text());
                const d = await r.json();
                const v = d.verdicts||{};
                const consensus = d.consensus||'?';
                const cColor = {'ACCEPT':'#34d399','MINOR REVISION':'#60a5fa','MAJOR REVISION':'#fbbf24','REJECT':'#ef4444'}[consensus]||'#9ca3af';
                let html = `<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
                    <span style="font-size:9px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted)">Multi-Review</span>
                    <span style="padding:4px 14px;background:${cColor}22;color:${cColor};border-radius:6px;font-size:13px;font-weight:700">${consensus}</span>
                    <span style="font-size:11px;color:${d.all_agree?'#34d399':'#fbbf24'}">${d.all_agree?'✅ Einstimmig':'⚠️ Disagreement'}</span>
                </div>`;
                const icons = {analytical:'🔬',practical:'🏢',devils_advocate:'😈'};
                const names = {analytical:'Analytisch',practical:'Praxis',devils_advocate:"Devil's Advocate"};
                html += `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">${Object.entries(v).map(([k,verdict])=>{
                    const vc = {'ACCEPT':'#34d399','MINOR REVISION':'#60a5fa','MAJOR REVISION':'#fbbf24','REJECT':'#ef4444'}[verdict]||'#9ca3af';
                    return `<div style="flex:1;min-width:120px;padding:8px 12px;background:rgba(0,0,0,0.15);border-radius:8px;border-left:3px solid ${vc}">
                        <div style="font-size:10px;color:var(--text-muted)">${icons[k]||''} ${names[k]||k}</div>
                        <div style="font-size:12px;font-weight:600;color:${vc}">${verdict}</div>
                    </div>`;}).join('')}</div>`;
                if (d.synthesis_preview) html += `<div style="font-size:11px;color:var(--text-secondary);line-height:1.5">${d.synthesis_preview}</div>`;
                if (d.review_id) html += `<div style="margin-top:8px"><a href="#" onclick="viewDocument('${d.review_id}');return false" style="font-size:11px;color:#34d399">📖 Vollständiges Multi-Review anzeigen</a></div>`;
                reviewEl.innerHTML = html;
                showToast(`Multi-Review: ${consensus} ${d.all_agree?'(einstimmig)':'(Disagreement)'}`, 'success');
            } catch(e) {
                reviewEl.innerHTML = `<div style="color:#ef4444;font-size:12px">❌ Multi-Review fehlgeschlagen: ${e.message?.slice(0,200)}</div>`;
            }
            if (btn) { btn.disabled = false; btn.innerHTML = '⚔️ Multi'; }
        }

        async function apeReviewDocument() {
            if (!currentDocId) return;
            const btn = document.getElementById('docApeReviewBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '⏳ APE...'; }
            const reviewEl = document.getElementById('docDetailReview');
            reviewEl.style.display = '';
            reviewEl.innerHTML = `<div style="padding:16px 0">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
                    <div class="loading-spinner" style="width:22px;height:22px;border-width:2px"></div>
                    <div>
                        <div style="font-size:14px;font-weight:600;color:#ff8c00">APE Multi-Model Review</div>
                        <div style="font-size:11px;color:var(--text-muted)">Alle verfügbaren Reviewer werden parallel aufgerufen...</div>
                    </div>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:6px">
                    <span id="apeStatus_beatrix" style="padding:4px 10px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:6px;font-size:10px;color:#a78bfa">🧠 BEATRIX ⏳</span>
                    <span id="apeStatus_contrarian" style="padding:4px 10px;background:rgba(234,179,8,0.1);border:1px solid rgba(234,179,8,0.2);border-radius:6px;font-size:10px;color:#eab308">⚡ Haiku ⏳</span>
                    <span id="apeStatus_methodologist" style="padding:4px 10px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:6px;font-size:10px;color:#60a5fa">🔬 GPT ⏳</span>
                    <span id="apeStatus_skeptic" style="padding:4px 10px;background:rgba(251,146,60,0.1);border:1px solid rgba(251,146,60,0.2);border-radius:6px;font-size:10px;color:#fb923c">🦊 Grok ⏳</span>
                    <span id="apeStatus_practitioner" style="padding:4px 10px;background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.2);border-radius:6px;font-size:10px;color:#34d399">💼 Gemini ⏳</span>
                </div>
                <div style="font-size:10px;color:var(--text-muted);margin-top:8px">Je nach verfügbaren API Keys: 30-120 Sek.</div>
            </div>`;
            try {
                const r = await fetch(`${API}/documents/${currentDocId}/ape-review`, {method:'POST',headers:H(),body:JSON.stringify({})});
                if (!r.ok) throw new Error((await r.json().catch(()=>({}))).detail || await r.text());
                const d = await r.json();
                const revs = d.reviewers || {};
                const errs = d.errors || {};
                const consensus = d.consensus || '?';
                const avgScore = d.avg_score || 0;
                const cColor = {'ACCEPT':'#34d399','CONDITIONAL ACCEPT':'#60a5fa','MINOR REVISION':'#60a5fa','MAJOR REVISION':'#fbbf24','REJECT':'#ef4444'}[consensus]||'#9ca3af';

                let html = `<div style="margin-bottom:14px">
                    <div style="display:flex;align-items:baseline;gap:10px;margin-bottom:6px">
                        <span style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:#ff8c00;font-weight:600">🔥 APE Review</span>
                        <span style="font-size:28px;font-weight:700;color:${cColor}">${avgScore.toFixed(0)}</span>
                        <span style="font-size:12px;color:var(--text-muted)">/100 avg</span>
                        <span style="padding:3px 12px;background:${cColor}22;color:${cColor};border-radius:6px;font-size:12px;font-weight:700">${consensus}</span>
                        <span style="font-size:11px;color:${d.unanimous?'#34d399':'#fbbf24'}">${d.unanimous?'✅ Einstimmig':'⚠️ Disagreement'}</span>
                    </div>
                </div>`;

                // Reviewer cards
                html += `<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px">`;
                for (const [key, rev] of Object.entries(revs)) {
                    const vc = {'ACCEPT':'#34d399','CONDITIONAL ACCEPT':'#60a5fa','MINOR REVISION':'#60a5fa','MAJOR REVISION':'#fbbf24','REJECT':'#ef4444'}[rev.verdict]||'#9ca3af';
                    html += `<div style="flex:1;min-width:140px;padding:10px 14px;background:rgba(0,0,0,0.2);border-radius:10px;border-left:3px solid ${vc}">
                        <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">${rev.icon} ${rev.name}</div>
                        <div style="font-size:16px;font-weight:700;color:${vc}">${rev.score}/100</div>
                        <div style="font-size:10px;color:${vc};margin-top:2px">${rev.verdict}</div>
                        <div style="font-size:9px;color:var(--text-muted);margin-top:6px;line-height:1.4">${(rev.preview||'').slice(0,120)}...</div>
                    </div>`;
                }
                html += `</div>`;

                // Errors (unavailable reviewers)
                if (Object.keys(errs).length) {
                    html += `<div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">Nicht verfügbar: ${Object.entries(errs).map(([k,v])=>`${k} (${v.slice(0,40)})`).join(', ')}</div>`;
                }

                // Synthesis
                if (d.synthesis_preview) {
                    html += `<div style="padding:10px 14px;background:rgba(255,140,0,0.05);border:1px solid rgba(255,140,0,0.15);border-radius:8px;margin-bottom:8px">
                        <div style="font-size:10px;color:#ff8c00;font-weight:600;margin-bottom:4px">🔄 Synthese</div>
                        <div style="font-size:11px;color:var(--text-secondary);line-height:1.5">${d.synthesis_preview}</div>
                    </div>`;
                }

                // Link to full review
                if (d.review_id) {
                    html += `<a href="#" onclick="viewDocument('${d.review_id}');return false" style="font-size:11px;color:#ff8c00">📖 Vollständiges APE Review anzeigen</a>`;
                }

                reviewEl.innerHTML = html;
                showToast(`APE Review: ${consensus} (${avgScore.toFixed(0)}/100) – ${Object.keys(revs).length} Reviewer`, 'success');
            } catch(e) {
                reviewEl.innerHTML = `<div style="color:#ef4444;font-size:12px">❌ APE Review fehlgeschlagen: ${e.message?.slice(0,300)}</div>`;
                showToast(`APE Review Fehler`, 'error');
            }
            if (btn) { btn.disabled = false; btn.innerHTML = '🔥 APE Review'; }
        }

        function addMsgActionButtons(msgEl) {
            if (!msgEl) return;
            // Find the closest .chat-msg ancestor or use msgEl itself
            const chatMsg = msgEl.closest('.chat-msg') || msgEl;
            // Ensure a STABLE id (bxStreamMsg gets removed later, so replace it)
            let msgId = chatMsg.id;
            if (!msgId || msgId === 'bxStreamMsg') {
                msgId = 'msg_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
                chatMsg.id = msgId;
            }
            // Don't add if already present
            if (chatMsg.querySelector('[onclick*="copyAnswer"]')) return;
            const body = chatMsg.querySelector('.chat-msg-body');
            if (!body) return;
            body.insertAdjacentHTML('beforeend', `<div style="margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.04);display:flex;gap:6px">
                <button onclick="copyAnswer('${msgId}')" style="padding:3px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:rgba(255,255,255,0.3);font-size:10px;cursor:pointer;transition:all 0.15s" onmouseenter="this.style.background='rgba(255,255,255,0.06)';this.style.color='rgba(255,255,255,0.6)'" onmouseleave="this.style.background='transparent';this.style.color='rgba(255,255,255,0.3)'">📋 Kopieren</button>
                <button onclick="challengeAnswer('${msgId}')" style="padding:3px 10px;border-radius:6px;border:1px solid rgba(255,140,0,0.2);background:transparent;color:rgba(255,140,0,0.5);font-size:10px;cursor:pointer;transition:all 0.15s" onmouseenter="this.style.background='rgba(255,140,0,0.1)';this.style.color='#ff8c00'" onmouseleave="this.style.background='transparent';this.style.color='rgba(255,140,0,0.5)'">🔥 Challenge</button>
            </div>`);
        }

        async function copyAnswer(msgId) {
            const msgEl = document.getElementById(msgId);
            if (!msgEl) return;
            const bodyEl = msgEl.querySelector('.chat-msg-body');
            const clone = bodyEl.cloneNode(true);
            // Remove button bar and challenge results
            clone.querySelectorAll('div[style*="border-top"], div[style*="rgba(255,140,0"]').forEach(el => el.remove());
            const text = clone.innerText.trim();
            const btn = msgEl.querySelector('[onclick*="copyAnswer"]');
            
            let ok = false;
            
            // Method 1: Modern clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try { await navigator.clipboard.writeText(text); ok = true; } catch(e) {}
            }
            
            // Method 2: iOS Safari workaround
            if (!ok) {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.setAttribute('readonly', '');
                ta.style.cssText = 'position:fixed;top:0;left:0;width:1px;height:1px;padding:0;border:none;outline:none;box-shadow:none;opacity:0.01';
                document.body.appendChild(ta);
                
                // iOS specific: must use setSelectionRange
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                if (isIOS) {
                    ta.contentEditable = true;
                    ta.readOnly = false;
                    const range = document.createRange();
                    range.selectNodeContents(ta);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                    ta.setSelectionRange(0, 999999);
                } else {
                    ta.select();
                }
                
                try { ok = document.execCommand('copy'); } catch(e) {}
                document.body.removeChild(ta);
            }
            
            // Method 3: Last resort - show selectable text
            if (!ok) {
                const popup = document.createElement('div');
                popup.style.cssText = 'position:fixed;inset:0;z-index:99999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)';
                popup.onclick = (e) => { if (e.target === popup) popup.remove(); };
                popup.innerHTML = `<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;max-width:90vw;max-height:70vh;padding:20px;overflow:auto">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <span style="font-size:13px;font-weight:600;color:white">Text zum Kopieren (alles markieren → kopieren)</span>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">✕</button>
                    </div>
                    <textarea readonly style="width:100%;min-height:200px;background:rgba(0,0,0,0.3);color:var(--text-secondary);border:1px solid var(--border);border-radius:8px;padding:12px;font-size:13px;line-height:1.6;font-family:inherit;resize:vertical">${text.replace(/</g,'&lt;')}</textarea>
                </div>`;
                document.body.appendChild(popup);
                const textArea = popup.querySelector('textarea');
                textArea.focus();
                textArea.setSelectionRange(0, textArea.value.length);
                return;
            }
            
            if (btn && ok) { const orig = btn.innerHTML; btn.innerHTML = '✅ Kopiert'; setTimeout(() => btn.innerHTML = orig, 1500); }
        }

        async function challengeAnswer(msgId) {
            const msgEl = document.getElementById(msgId);
            if (!msgEl) return;
            const bodyEl = msgEl.querySelector('.chat-msg-body');
            const originalText = bodyEl.innerText.replace(/🔥 Challenge$/,'').trim();
            if (!originalText || originalText.length < 20) return;

            // Replace challenge button with loading
            const challengeBtn = msgEl.querySelector('[onclick*="challengeAnswer"]');
            if (challengeBtn) challengeBtn.outerHTML = `<div style="margin-top:8px;padding:10px 14px;background:rgba(255,140,0,0.04);border:1px solid rgba(255,140,0,0.1);border-radius:8px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <div class="loading-spinner" style="width:14px;height:14px;border-width:2px"></div>
                    <span style="font-size:10px;color:#ff8c00;font-weight:600">5 ECHTE MODELLE CHALLENGEN UNABHÄNGIG...</span>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:4px" id="challengeStatus_${msgId}">
                    <span style="padding:2px 8px;border-radius:4px;font-size:9px;background:rgba(139,92,246,0.1);color:#a78bfa">🧠 Sonnet ⏳</span>
                    <span style="padding:2px 8px;border-radius:4px;font-size:9px;background:rgba(59,130,246,0.1);color:#60a5fa">🔬 GPT ⏳</span>
                    <span style="padding:2px 8px;border-radius:4px;font-size:9px;background:rgba(251,146,60,0.1);color:#fb923c">🦊 Grok ⏳</span>
                    <span style="padding:2px 8px;border-radius:4px;font-size:9px;background:rgba(52,211,153,0.1);color:#34d399">💼 Gemini ⏳</span>
                    <span style="padding:2px 8px;border-radius:4px;font-size:9px;background:rgba(234,179,8,0.1);color:#eab308">⚡ Haiku ⏳</span>
                </div>
            </div>`;

            try {
                const r = await fetch(`${API}/challenge`, {
                    method: 'POST', headers: {...H(), 'Content-Type':'application/json'},
                    body: JSON.stringify({ text: originalText.slice(0, 4000) })
                });
                if (!r.ok) throw new Error((await r.json().catch(()=>({}))).detail || 'Challenge failed');
                const d = await r.json();

                let html = `<div style="margin-top:8px;padding:14px;background:rgba(255,140,0,0.04);border:1px solid rgba(255,140,0,0.12);border-radius:10px">
                    <div style="font-size:10px;color:#ff8c00;font-weight:600;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px">🔥 APE CHALLENGE – ${d.models_used} ECHTE MODELLE</div>`;

                for (const [key, ch] of Object.entries(d.challenges || {})) {
                    html += `<div style="margin-bottom:10px;padding:8px 12px;background:rgba(0,0,0,0.15);border-radius:8px;border-left:2px solid rgba(255,140,0,0.3)">
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">${ch.icon} <strong>${ch.name}</strong> <span style="opacity:0.4">${ch.model}</span></div>
                        <div style="font-size:12px;color:var(--text-secondary);line-height:1.6">${formatMessage(ch.challenge)}</div>
                    </div>`;
                }

                if (d.errors && Object.keys(d.errors).length) {
                    html += `<div style="font-size:9px;color:var(--text-muted);margin-bottom:6px">Nicht verfügbar: ${Object.keys(d.errors).join(', ')}</div>`;
                }

                if (d.synthesis) {
                    html += `<div style="margin-top:8px;padding:10px 12px;background:rgba(255,140,0,0.06);border-radius:8px">
                        <div style="font-size:10px;color:#ff8c00;font-weight:600;margin-bottom:4px">🔄 SYNTHESE</div>
                        <div style="font-size:12px;color:var(--text-secondary);line-height:1.6">${formatMessage(d.synthesis)}</div>
                    </div>`;
                }

                html += `</div>`;

                const statusEl = document.getElementById('challengeStatus_' + msgId);
                if (statusEl) statusEl.closest('div[style*="rgba(255,140,0"]').outerHTML = html;
            } catch(e) {
                const statusEl = document.getElementById('challengeStatus_' + msgId);
                if (statusEl) statusEl.closest('div[style*="rgba(255,140,0"]').outerHTML = `<span style="font-size:10px;color:#ef4444">❌ Challenge fehlgeschlagen: ${e.message?.slice(0,100)}</span>`;
            }
        }

        async function bulkApeReview() {
            const btn = document.getElementById('bulkApeBtn');
            if (!await bxConfirm('APE Review für ALLE Dokumente starten? Das kann mehrere Minuten dauern und kostet API Credits.', {title:'APE Review', icon:'🔥', confirmText:'Review starten', danger:false})) return;
            btn.disabled = true; btn.innerHTML = '⏳ Reviewe...';
            try {
                const r = await fetch(`${API}/documents`, {headers:H()});
                const docs = await r.json();
                // Filter: only docs without existing APE review
                const toReview = docs.filter(d => !d.title?.startsWith('APE Review:') && !d.title?.startsWith('Multi-Review:'));
                let done = 0, errors = 0;
                for (const doc of toReview) {
                    btn.innerHTML = `⏳ ${done+1}/${toReview.length}...`;
                    try {
                        await fetch(`${API}/documents/${doc.id}/ape-review`, {method:'POST',headers:H(),body:JSON.stringify({})});
                        done++;
                    } catch(e) { errors++; }
                }
                showToast(`APE Review: ${done} ✅, ${errors} ❌`, done > 0 ? 'success' : 'error');
                loadDocs();
            } catch(e) { showToast('Bulk APE Review fehlgeschlagen', 'error'); }
            btn.disabled = false; btn.innerHTML = '🔥 Alle APE-reviewen';
        }

        async function bulkClassifyDocs() {
            const btn = document.getElementById('bulkClassifyBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '⏳ Klassifiziere alle...'; }

            try {
                const r = await fetch(`${API}/documents/classify-all`, {
                    method: 'POST', headers: {...H(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({force: false})
                });
                if (!r.ok) throw new Error(await r.text());
                const d = await r.json();
                showToast(`✅ ${d.classified} klassifiziert, ${d.skipped} übersprungen, ${d.errors} Fehler`, 'success');
                loadDocuments();
            } catch(e) {
                showToast(`Fehler: ${e.message}`, 'error');
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '🧬 Alle klassifizieren'; }
            }
        }

        // ── Role-Based Tab Visibility ──────────────────
        // Role → Tab mapping (which tabs each role can see)
        const ROLE_TABS = {
            researcher:        [],             // standard tabs only
            sales:             ['context'],    // + Ausgangslage (CRM via crm_access)
            operations:        ['context'],    // + Ausgangslage
            senior_management: ['context'],    // + Ausgangslage (CRM auto-enabled)
            partner:           ['context'],    // + Ausgangslage (CRM auto-enabled)
            admin:             ['context']     // + everything (admin+CRM tabs handled separately)
        };

        function applyUserTabs() {
            const email = (currentUser?.email || '').toLowerCase();
            const isAdmin = currentUser?.admin || false;
            const role = currentUser?.role || 'researcher';
            const isFehrAdvice = email.endsWith('@fehradvice.com');
            const hasCrmAccess = currentUser?.crm_access || false;
            console.log('applyUserTabs - email:', email, 'admin:', isAdmin, 'role:', role, 'crm:', hasCrmAccess);

            // Admin gear icon (only for admins)
            const adminEl = document.getElementById('navAdmin');
            if (adminEl) adminEl.style.display = isAdmin ? 'inline' : 'none';

            // Kontext-Analyse is always visible (core EBF workflow under Behavioral Design)
            // No role restriction needed

            // Business dropdown items (CRM, Firmen, Projekte-Admin)
            const showCrm = isFehrAdvice && hasCrmAccess;
            const leadsEl = document.getElementById('navDropLeads');
            if (leadsEl) leadsEl.style.display = showCrm ? 'flex' : 'none';
            const compEl = document.getElementById('navDropCompanies');
            if (compEl) compEl.style.display = showCrm ? 'flex' : 'none';
            const projEl = document.getElementById('navDropProjects');
            if (projEl) projEl.style.display = showCrm ? 'flex' : 'none';
            const taskEl = document.getElementById('navDropTasks');
            if (taskEl) taskEl.style.display = isFehrAdvice ? 'flex' : 'none';
            const myProjEl = document.getElementById('navDropMyProjects');
            if (myProjEl) myProjEl.style.display = 'none'; // hidden, now top-level

            // Top-level Projekte — visible for all logged-in users
            const topProj = document.getElementById('navTopProjects');
            if (topProj) topProj.style.display = '';

            // Business dropdown only visible if CRM items exist
            const businessDrop = document.getElementById('navDropBusiness');
            if (businessDrop) {
                businessDrop.style.display = showCrm ? 'flex' : 'none';
            }

            console.log('Nav: CRM=' + showCrm, 'Admin=' + isAdmin);
        }

        // ── Kontext / Ausgangslage ──────────────────────
        // Kontext-Analyse state managed by caState and caHistoryData

        // ── KONTEXT-ANALYSE WORKFLOW ──────────────────────────
        const caState = { mode: null, step: -1, question: '', macro: null, meso: null, macroCustom: null, mesoCustom: null, orgType: null, orgCode: null, orgName: null, perspective: null, micro: {}, result: null, lineageId: null, currentVersionId: null, customerCode: null, projectSlug: null, smartParse: null, scenarios: [] };
        let caHistoryData = [];

        const PSI_DIMS = [
            { key: 'psi_i', icon: '📋', label: 'Ψ_I Regeln', desc: 'Gesetze, Defaults, Vorschriften' },
            { key: 'psi_s', icon: '👥', label: 'Ψ_S Sozial', desc: 'Soziale Normen, Peer Effects' },
            { key: 'psi_c', icon: '🧠', label: 'Ψ_C Kognitiv', desc: 'Attention, Cognitive Load' },
            { key: 'psi_k', icon: '🌍', label: 'Ψ_K Kultur', desc: 'Werte, Traditionen, Identität' },
            { key: 'psi_e', icon: '💰', label: 'Ψ_E Ressourcen', desc: 'Budget, Zeit, Energie' },
            { key: 'psi_t', icon: '⏰', label: 'Ψ_T Zeit', desc: 'Zeitdruck, Lebensphase' },
            { key: 'psi_m', icon: '🔧', label: 'Ψ_M Tools', desc: 'Technologie, Infrastruktur' },
            { key: 'psi_f', icon: '📍', label: 'Ψ_F Ort', desc: 'Physisches Setting' }
        ];

        function caInit() {
            // Load suggestions based on user profile
            caLoadSuggestions();
        }

        function caSelectMode(el, mode) {
            if (el.classList.contains('selected') && caState.mode === mode) {
                caStartWorkflow(); return;
            }
            document.querySelectorAll('#caStart .mb-mode-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            caState.mode = mode;
            document.getElementById('caStartBtn').disabled = false;
        }

        function caStartWorkflow() {
            if (!caState.mode) return;
            caState.step = 0;
            caShowPanel('caStep0');
            document.getElementById('caProgress').style.display = 'flex';
            caUpdateProgress(0);
            if (caState.mode === 'schnell') {
                caShowCustomInput(); // Jump to text input for schnell mode
            }
        }

        function caShowPanel(id) {
            document.querySelectorAll('#context-section .mb-panel').forEach(p => p.classList.remove('active'));
            const el = document.getElementById(id);
            if (el) el.classList.add('active');
        }

        function caUpdateProgress(step) {
            document.querySelectorAll('#caProgress .mb-step-dot').forEach((dot, i) => {
                dot.classList.remove('active', 'completed');
                if (i < step) dot.classList.add('completed');
                if (i === step) dot.classList.add('active');
            });
            document.querySelectorAll('#caProgress .mb-step-line').forEach((line, i) => {
                line.classList.toggle('completed', i < step);
            });
        }

        // ═══ BRIEFING FUNCTIONS — Choice Architecture ═══
        const brfState = { type: null, subChoice: null };

        const BRF_TYPES = {
            frage: {
                icon: '🔍', title: 'Du hast eine Frage',
                subtitle: 'Etwas an einem Verhalten gibt dir zu denken.',
                label: 'Was genau willst du verstehen?',
                placeholder: 'z.B. "Warum wechseln Kunden so selten den Anbieter?" oder "Wieso nutzen nur 3% den Self-Service?"',
                quickPicks: [
                    { icon: '🔄', text: 'Warum tun Menschen etwas nicht, obwohl es in ihrem Interesse wäre?' },
                    { icon: '⚡', text: 'Warum handeln Menschen gegen ihre eigenen Absichten?' },
                    { icon: '📉', text: 'Warum ist eine Kennzahl so tief/hoch — was steckt dahinter?' },
                    { icon: '🤷', text: 'Warum funktioniert etwas in einem Kontext, aber nicht in einem anderen?' }
                ]
            },
            kunde: {
                icon: '🏢', title: 'Du hast einen Kunden',
                subtitle: 'Eine Organisation kommt mit einem Anliegen.',
                label: 'Um welchen Kunden geht es — und was ist das Thema?',
                placeholder: 'z.B. "UBS Private Banking — junge Erben wechseln nicht in die Vermögensverwaltung"',
                quickPicks: [
                    { icon: '🏦', text: 'Eine Bank will die Kundenaktivierung verbessern' },
                    { icon: '🏥', text: 'Eine Versicherung will Prävention fördern' },
                    { icon: '🏛️', text: 'Eine Behörde will Compliance erhöhen' },
                    { icon: '⚡', text: 'Ein Energieversorger will Wechselverhalten verstehen' }
                ],
                showCrm: true
            },
            ziel: {
                icon: '🎯', title: 'Du hast ein Ziel',
                subtitle: 'Ein Soll-Zustand, eine Ambition, eine Vision.',
                label: 'Was soll in Zukunft anders sein?',
                placeholder: 'z.B. "In 3 Jahren sollen 40% der Kunden den Self-Service nutzen" oder "NPS von 34 auf 55"',
                quickPicks: [
                    { icon: '📈', text: 'Eine Kennzahl soll sich verbessern (KPI, Conversion, NPS...)' },
                    { icon: '🔄', text: 'Ein Verhalten soll sich ändern (mehr, weniger, anders...)' },
                    { icon: '🌱', text: 'Ein neues Verhalten soll entstehen (Adoption, Gewohnheit...)' },
                    { icon: '🏔️', text: 'Eine Transformation: "So soll es in 5 Jahren aussehen"' }
                ]
            },
            loesung: {
                icon: '🛠️', title: 'Du hast eine Lösung',
                subtitle: 'Ein Produkt, eine Massnahme, eine Intervention — wird sie wirken?',
                label: 'Was ist die Lösung und für wen?',
                placeholder: 'z.B. "Wir launchen eine Vorsorge-App für Millennials" oder "Wir ändern den Default bei der Organspende"',
                quickPicks: [
                    { icon: '📱', text: 'Wir launchen ein digitales Produkt (App, Portal, Tool...)' },
                    { icon: '📝', text: 'Wir ändern einen Prozess (Onboarding, Beratung, Antrag...)' },
                    { icon: '💬', text: 'Wir ändern die Kommunikation (Brief, E-Mail, Kampagne...)' },
                    { icon: '⚙️', text: 'Wir ändern die Entscheidungsarchitektur (Default, Framing, Timing...)' }
                ]
            },
            daten: {
                icon: '📊', title: 'Du hast eine Beobachtung',
                subtitle: 'Die Zahlen zeigen etwas — aber was bedeutet es?',
                label: 'Was zeigen die Daten?',
                placeholder: 'z.B. "Conversion nur 2%, Branchenschnitt ist 8%" oder "80% öffnen die App, aber nur 5% schliessen den Prozess ab"',
                quickPicks: [
                    { icon: '📉', text: 'Ein Gap: Unsere Zahl ist viel schlechter als der Benchmark' },
                    { icon: '🔻', text: 'Ein Drop-off: Viele starten, wenige schliessen ab' },
                    { icon: '🤔', text: 'Eine Anomalie: Das Verhalten ist anders als erwartet' },
                    { icon: '📊', text: 'Ein Vergleich: Zwei Gruppen/Märkte verhalten sich unterschiedlich' }
                ]
            },
            sorge: {
                icon: '🚫', title: 'Du hast eine Sorge',
                subtitle: 'Etwas darf auf keinen Fall passieren.',
                label: 'Was willst du vermeiden — und warum?',
                placeholder: 'z.B. "Die NPS darf nicht unter 40 fallen" oder "Kein Vertrauensverlust bei der Digitalisierung"',
                quickPicks: [
                    { icon: '📉', text: 'Eine Kennzahl darf nicht sinken (NPS, Kundenbindung, Vertrauen...)' },
                    { icon: '💔', text: 'Kunden dürfen nicht abwandern bei einer Veränderung' },
                    { icon: '😤', text: 'Eine Massnahme darf keinen Backlash erzeugen' },
                    { icon: '⚠️', text: 'Ein Reputationsrisiko muss vermieden werden' }
                ]
            }
        };

        function brfSelectType(type) {
            brfState.type = type;
            const cfg = BRF_TYPES[type];
            if (!cfg) return;

            // Mark selected card
            document.querySelectorAll('#brfTypeCards .mb-choice').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            // Fill Step 2
            document.getElementById('brfStep2Icon').textContent = cfg.icon;
            document.getElementById('brfStep2Title').textContent = cfg.title;
            document.getElementById('brfStep2Subtitle').textContent = cfg.subtitle;
            document.getElementById('brfDetailLabel').textContent = cfg.label;
            document.getElementById('brfDetailInput').placeholder = cfg.placeholder;
            document.getElementById('brfDetailInput').value = '';

            // Build quick picks
            let html = '<div style="font-size:12px;color:var(--text-muted);margin-bottom:10px">Typische Ausgangspunkte — klicke zum Übernehmen:</div>';
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
            (cfg.quickPicks || []).forEach(qp => {
                html += `<div class="mb-choice" style="padding:10px 12px;cursor:pointer;text-align:left" onclick="brfQuickPick(this)">
                    <div style="display:flex;align-items:flex-start;gap:8px">
                        <span style="font-size:16px;flex-shrink:0">${qp.icon}</span>
                        <span style="font-size:12px;color:var(--white);line-height:1.5">${qp.text}</span>
                    </div>
                </div>`;
            });
            html += '</div>';

            // CRM search for 'kunde' type
            if (cfg.showCrm && crmCompaniesData && crmCompaniesData.length > 0) {
                html += `<div style="margin-top:16px;padding:14px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                    <div style="font-size:12px;font-weight:600;color:var(--white);margin-bottom:8px">🔎 Kunde im CRM suchen</div>
                    <input class="mb-input" id="brfCrmSearch" oninput="brfSearchCrm()" placeholder="Name oder Code eingeben..." style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px">
                    <div id="brfCrmResults" style="max-height:160px;overflow-y:auto;margin-top:8px"></div>
                </div>`;
            }

            document.getElementById('brfStep2Content').innerHTML = html;

            // Transition
            document.getElementById('brfStep1').style.display = 'none';
            document.getElementById('brfStep2').style.display = 'block';
            document.getElementById('brfStep3').style.display = 'none';
        }

        function brfQuickPick(el) {
            const text = el.querySelector('span:last-child')?.textContent?.trim();
            if (text) document.getElementById('brfDetailInput').value = text;
            // Deselect others, select this
            el.parentElement.querySelectorAll('.mb-choice').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        function brfSearchCrm() {
            const q = (document.getElementById('brfCrmSearch')?.value || '').toLowerCase().trim();
            const container = document.getElementById('brfCrmResults');
            if (!q || q.length < 2) { container.innerHTML = ''; return; }
            const matches = (crmCompaniesData || []).filter(c =>
                (c.name||'').toLowerCase().includes(q) ||
                (c.code||'').toLowerCase().includes(q) ||
                (c.children||[]).some(ch => (ch.name||'').toLowerCase().includes(q))
            ).slice(0, 6);
            container.innerHTML = matches.map(c => `
                <div style="padding:8px 10px;cursor:pointer;border-radius:6px;font-size:13px;color:var(--white);display:flex;align-items:center;gap:8px" 
                     onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background=''" 
                     onclick="brfPickCrm('${c.code}','${(c.name||'').replace(/'/g,"\\'")}')">
                    <span style="font-size:16px">🏢</span>
                    <div><div style="font-weight:600">${c.name}</div><div style="font-size:11px;color:var(--text-muted)">${c.code} · ${c.industry || ''}</div></div>
                </div>
            `).join('');
        }

        function brfPickCrm(code, name) {
            brfState.crmCode = code;
            brfState.crmName = name;
            const input = document.getElementById('brfDetailInput');
            const current = input.value.trim();
            input.value = current ? `${name} — ${current}` : name;
            document.getElementById('brfCrmResults').innerHTML = `<div style="padding:6px 10px;font-size:12px;color:#10b981">✓ ${name} (${code}) ausgewählt</div>`;
        }

        function brfBack() {
            document.getElementById('brfStep1').style.display = 'block';
            document.getElementById('brfStep2').style.display = 'none';
            document.getElementById('brfStep3').style.display = 'none';
        }

        function brfBackTo2() {
            document.getElementById('brfStep2').style.display = 'block';
            document.getElementById('brfStep3').style.display = 'none';
        }

        function briefingFill(el) {
            // Legacy compat
            const text = el.querySelector('div:last-child')?.textContent?.replace(/^"|"$/g, '').trim();
            if (text) document.getElementById('brfDetailInput').value = text;
        }

        async function brfAnalyze() {
            const input = document.getElementById('brfDetailInput').value.trim();
            if (!input) { showToast('Bitte beschreibe deinen Ausgangspunkt genauer', 'error'); return; }

            // Show step 3 with loading
            document.getElementById('brfStep2').style.display = 'none';
            document.getElementById('brfStep3').style.display = 'block';
            const resultDiv = document.getElementById('briefingResult');
            resultDiv.innerHTML = `<div style="text-align:center;padding:30px"><div class="spinner" style="margin:0 auto 12px"></div><div style="font-size:13px;color:rgba(255,255,255,0.5)">BEATRIX analysiert dein Briefing...</div></div>`;

            const typeLabel = BRF_TYPES[brfState.type]?.title || brfState.type;

            const prompt = `Analysiere dieses Briefing und erstelle eine strukturierte Einschätzung.

Typ: ${brfState.type} (${typeLabel})
Input: "${input}"
${brfState.crmCode ? `CRM-Kunde: ${brfState.crmName} (${brfState.crmCode})` : ''}

Antworte NUR als valides JSON:
{
  "zusammenfassung": "2-3 Sätze: Was habe ich verstanden? Was ist der Kern des Anliegens?",
  "erkannt": {
    "land": "Erkanntes Land oder null",
    "branche": "Erkannte Branche oder null",
    "organisation": "Erkannte Organisation oder null",
    "perspektive": "Kunden / Mitarbeitende / Management / null",
    "verhalten": "Beschriebenes Verhalten oder null",
    "ziel": "Genanntes Ziel oder null",
    "kennzahlen": "Genannte Zahlen/KPIs oder null"
  },
  "empfehlung": {
    "section": "context|segmente|journey|nutzen|architektur|model|audit|wirkung|evidenz",
    "label": "Name des empfohlenen nächsten Schritts",
    "grund": "2 Sätze: Warum ist das der richtige nächste Schritt?",
    "frage_fuer_analyse": "Die Kernfrage, die an die Analyse übergeben wird — klar formuliert"
  },
  "alternativen": [
    { "section": "...", "label": "...", "grund": "1 Satz warum auch sinnvoll" },
    { "section": "...", "label": "...", "grund": "1 Satz" }
  ],
  "offene_fragen": ["Was BEATRIX noch wissen müsste, um besser zu helfen", "Max 3 Fragen"]
}`;

            try {
                const resp = await fetch(`${API}/chat`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: prompt, system_prompt: 'Du bist BEATRIX Briefing-Analyst bei FehrAdvice & Partners. Antworte NUR als valides JSON. Kein Markdown.' })
                });
                const data = await resp.json();
                const text = (data.response || data.answer || '').replace(/```json|```/g, '').trim();
                const result = JSON.parse(text);
                brfRenderResult(result, input);
            } catch (e) {
                console.error('Briefing parse error:', e);
                resultDiv.innerHTML = `<div style="padding:20px;background:var(--navy-card);border:1px solid var(--border);border-radius:var(--radius)">
                    <div style="font-size:14px;color:var(--white);margin-bottom:12px">Automatische Einordnung nicht möglich — starte direkt:</div>
                    <div style="display:flex;flex-wrap:wrap;gap:8px">
                        <button class="mb-btn mb-btn-primary" onclick="briefingGoTo('context','${encodeURIComponent(input)}')">🔬 Kontext-Analyse</button>
                        <button class="mb-btn" onclick="briefingGoTo('chat','${encodeURIComponent(input)}')">💬 Im Chat besprechen</button>
                    </div>
                </div>`;
            }
        }

        // Keep old briefingAnalyze as alias
        async function briefingAnalyze() { await brfAnalyze(); }

        function brfRenderResult(r, originalInput) {
            const resultDiv = document.getElementById('briefingResult');
            const sectionIcons = { context:'🔬', segmente:'👥', journey:'🗺️', nutzen:'💎', architektur:'⚖️', model:'🏗️', audit:'📊', wirkung:'📈', evidenz:'🧪' };

            // Erkannte Felder als Pills
            const erkannt = r.erkannt || {};
            const erkanntPills = Object.entries(erkannt)
                .filter(([k,v]) => v && v !== 'null' && v !== null)
                .map(([k,v]) => `<span style="display:inline-block;padding:5px 12px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.25);border-radius:14px;font-size:12px;color:#10b981;font-weight:500">✓ ${v}</span>`)
                .join(' ');

            // Offene Fragen
            const offenHtml = (r.offene_fragen || []).filter(q => q)
                .map(q => `<div style="padding:5px 0;font-size:13px;color:rgba(255,255,255,0.7)">❓ ${q}</div>`)
                .join('');

            // Alternativen
            const altHtml = (r.alternativen || [])
                .map(a => `<button class="mb-btn" style="font-size:12px;padding:8px 14px" onclick="briefingGoTo('${a.section}','${encodeURIComponent(r.empfehlung?.frage_fuer_analyse || originalInput)}')">${sectionIcons[a.section]||'📌'} ${a.label}<span style="display:block;font-size:10px;color:var(--text-muted);font-weight:400;margin-top:2px">${a.grund}</span></button>`)
                .join(' ');

            const emp = r.empfehlung || {};

            resultDiv.innerHTML = `
                <div style="padding:24px;background:var(--navy-card);border:1px solid var(--border);border-radius:var(--radius)">
                    <!-- Zusammenfassung -->
                    <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:20px">
                        <span style="font-size:28px">${BRF_TYPES[brfState.type]?.icon || '📋'}</span>
                        <div style="font-size:14px;color:rgba(255,255,255,0.88);line-height:1.75">${r.zusammenfassung || ''}</div>
                    </div>

                    <!-- Erkannt -->
                    ${erkanntPills ? `<div style="margin-bottom:18px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--text-muted);letter-spacing:0.8px;margin-bottom:8px">Erkannt</div><div style="display:flex;flex-wrap:wrap;gap:6px">${erkanntPills}</div></div>` : ''}

                    <!-- Offene Fragen -->
                    ${offenHtml ? `<div style="margin-bottom:20px;padding:14px;background:rgba(245,158,11,0.05);border:1px solid rgba(245,158,11,0.15);border-radius:var(--radius)"><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:#f59e0b;letter-spacing:0.8px;margin-bottom:6px">Was noch offen ist</div>${offenHtml}</div>` : ''}

                    <!-- Empfehlung -->
                    <div style="padding:18px;background:linear-gradient(135deg,rgba(91,138,245,0.1),rgba(91,138,245,0.03));border:1px solid rgba(91,138,245,0.25);border-radius:var(--radius);margin-bottom:18px">
                        <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--accent);letter-spacing:0.8px;margin-bottom:10px">Empfohlener nächster Schritt</div>
                        <div style="font-size:16px;font-weight:700;color:var(--white);margin-bottom:4px">${sectionIcons[emp.section]||'📌'} ${emp.label || emp.section}</div>
                        <div style="font-size:13px;color:var(--text-muted);margin-bottom:14px;line-height:1.6">${emp.grund || ''}</div>
                        <button class="mb-btn mb-btn-primary" onclick="briefingGoTo('${emp.section}','${encodeURIComponent(emp.frage_fuer_analyse || originalInput)}')">→ ${emp.label || emp.section} starten</button>
                    </div>

                    <!-- Alternativen -->
                    ${altHtml ? `<div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--text-muted);letter-spacing:0.8px;margin-bottom:10px">Oder alternativ</div><div style="display:flex;flex-wrap:wrap;gap:8px">${altHtml}</div></div>` : ''}
                </div>`;
        }

        function briefingGoTo(section, encodedInput) {
            const input = decodeURIComponent(encodedInput);
            // Navigate to section
            const navItem = document.querySelector(`.nav-dropdown-item[data-section="${section}"]`);
            navDropClick(section, navItem);

            // Pre-fill where possible
            if (section === 'context') {
                // Start Kontext-Analyse gefuehrt with this input
                setTimeout(() => {
                    caStartMode('gefuehrt');
                    setTimeout(() => {
                        const qEl = document.getElementById('caQuestion');
                        if (qEl) qEl.value = input;
                        document.getElementById('caCustomInput').style.display = 'block';
                    }, 100);
                }, 200);
            } else if (section === 'chat') {
                // Switch to chat and pre-fill
                showSection('chat');
                setTimeout(() => {
                    const chatInput = document.getElementById('chatInput');
                    if (chatInput) { chatInput.value = input; chatInput.focus(); }
                }, 200);
            }
            // For placeholder sections, navigation is enough
        }

        function caGoToStart() {
            caState.step = -1;
            caState.mode = null;
            caState.lineageId = null;
            caState.currentVersionId = null;
            caState.orgType = null; caState.orgCode = null; caState.orgName = null; caState.perspective = null;
            document.querySelectorAll('#caStart .mb-mode-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('caStartBtn').disabled = true;
            document.getElementById('caProgress').style.display = 'none';
            caShowPanel('caStart');
        }

        function caBack(toStep) {
            caState.step = toStep;
            caShowPanel(CA_PANELS[toStep]);
            caUpdateProgress(toStep);
        }

        async function caDeepen() {
            // Auto-save schnell result first (v1)
            if (!caState.currentVersionId) {
                await caSaveAndUse();
            }
            // Switch to gefuehrt mode, keep question + lineage
            const keepQuestion = caState.question;
            const keepLineage = caState.lineageId;
            caState.mode = 'gefuehrt';
            caState.result = null;
            caState.step = 1;
            // Reset all context selections
            caState.macro = null; caState.meso = null; caState.micro = null;
            caState.orgType = null; caState.orgCode = null; caState.orgName = null; caState.perspective = null;
            caState.question = keepQuestion;
            caState.lineageId = keepLineage;
            // Go to smart confirm (AI will parse question)
            document.getElementById('caProgress').style.display = 'flex';
            caShowPanel('caStepConfirm');
            caUpdateProgress(1);
            showToast('🔍 Jetzt Kontext vertiefen — gleiche Frage, tiefere Analyse', 'info');
            await caSmartParse(keepQuestion);
        }

        function caSelect(el, value) {
            const parent = el.closest('.mb-choices') || el.parentElement;
            parent.querySelectorAll('.mb-choice').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            // Enable the corresponding next button
            const step = el.closest('.mb-panel');
            if (step) {
                const btn = step.querySelector('.mb-btn-primary');
                if (btn) btn.disabled = false;
            }
            // Store value and toggle custom inputs
            if (step?.id === 'caStep1') {
                caState.macro = value;
                const customEl = document.getElementById('caCustomMacro');
                if (customEl) customEl.style.display = value === 'custom_macro' ? 'block' : 'none';
            }
            if (step?.id === 'caStep2') {
                caState.meso = value;
                const customEl = document.getElementById('caCustomMeso');
                if (customEl) customEl.style.display = value === 'custom_meso' ? 'block' : 'none';
            }
        }

        function caShowCustomInput() {
            document.getElementById('caCustomInput').style.display = 'block';
            document.getElementById('caQuestion').focus();
        }

        async function caLoadSuggestions() {
            const container = document.getElementById('caStep0Suggestions');
            if (!container) return;
            // Generate context-relevant suggestions
            const suggestions = [
                { icon: '🏦', text: 'Warum wechseln Schweizer so selten den Bankanbieter?', domain: 'FIN' },
                { icon: '🏥', text: 'Wie können Patienten zu besserer Medikamenten-Adhärenz motiviert werden?', domain: 'HLT' },
                { icon: '⚡', text: 'Welche Kontextfaktoren beeinflussen die Entscheidung zum Heizungsersatz?', domain: 'ENV' },
                { icon: '🗳️', text: 'Wie verändert Social Media den politischen Entscheidungskontext?', domain: 'POL' },
                { icon: '🏢', text: 'Welcher Kontext fördert/hemmt Innovationsverhalten in Organisationen?', domain: 'ORG' },
            ];
            container.innerHTML = suggestions.map(s => `
                <div class="mb-choice" style="padding:14px 16px;display:flex;align-items:center;gap:12px" onclick="caSelectSuggestion(this,'${s.text.replace(/'/g,"\\'")}')">
                    <div style="font-size:20px;min-width:32px;text-align:center">${s.icon}</div>
                    <div>
                        <div style="font-size:13px;color:var(--white);line-height:1.4">${s.text}</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-top:2px">${s.domain}</div>
                    </div>
                </div>
            `).join('');
        }

        function caSelectSuggestion(el, text) {
            caState.question = text;
            if (caState.mode === 'schnell') {
                caRunSchnell(text);
            } else {
                // Smart flow: go to confirm with AI parse
                caState.step = 1;
                caShowPanel('caStepConfirm');
                caUpdateProgress(1);
                caSmartParse(text);
            }
        }

        async function caProcessStep0() {
            const q = document.getElementById('caQuestion').value.trim();
            if (!q) { showToast('Bitte Frage eingeben', 'error'); return; }
            caState.question = q;
            if (caState.mode === 'schnell') {
                caRunSchnell(q);
            } else {
                // Smart parse: AI extracts context from question
                caState.step = 1;
                caShowPanel('caStepConfirm');
                caUpdateProgress(1);
                await caSmartParse(q);
            }
        }

        // ═══ SMART PARSE: Extract context from question via AI ═══
        async function caSmartParse(question) {
            document.getElementById('caConfirmLoading').style.display = 'block';
            document.getElementById('caConfirmContent').style.display = 'none';

            const parsePrompt = `Analysiere diese Frage und extrahiere den Kontext. Antworte NUR als JSON:
"${question}"

{
  "land": { "code": "ch|at|de|custom_macro", "label": "Schweiz|Österreich|Deutschland|[Land]", "confidence": 0.0-1.0 },
  "branche": { "code": "finance|health|public|energy|retail|tech|education|custom_meso", "label": "Finanzdienstleistung|Gesundheit|...", "confidence": 0.0-1.0 },
  "organisation": { "code": "company|public|healthcare|general", "label": "Beschreibung der Organisation", "name": "konkreter Name falls erkannt oder null", "confidence": 0.0-1.0 },
  "perspektive": { "code": "kunden|mitarbeitende|management|alle", "label": "Kunden|Mitarbeitende|Management|Alle Perspektiven", "confidence": 0.0-1.0 },
  "szenarien": [
    { "title": "Kurzer Titel (max 6 Worte)", "desc": "2-3 Sätze die die konkrete Entscheidungssituation beschreiben. Wer, Wo, Wann, in welchem Zustand.", "where": "home|workplace|store|online|public|healthcare", "social": "solo|dyadic|small_group|large_group|anonymous", "time": "urgent|moderate|relaxed|recurring", "cognitive": "analytical|intuitive|stressed|fatigued|motivated", "icon": "passendes Emoji" },
    { "title": "...", "desc": "...", "where": "...", "social": "...", "time": "...", "cognitive": "...", "icon": "..." },
    { "title": "...", "desc": "...", "where": "...", "social": "...", "time": "...", "cognitive": "...", "icon": "..." }
  ]
}

Regeln:
- Wenn Land nicht klar: Default "ch" (FehrAdvice ist in Zürich), confidence: 0.3
- Wenn Branche nicht klar: besten Guess machen, confidence angeben
- Szenarien: IMMER genau 3 realistische, unterschiedliche Entscheidungssituationen generieren
- Szenario 1: Die häufigste/typischste Situation
- Szenario 2: Eine alternative Situation
- Szenario 3: Eine weniger offensichtliche aber relevante Situation`;

            try {
                const resp = await fetch(`${API}/chat`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: parsePrompt, system_prompt: 'Du bist ein Kontext-Parser. Antworte NUR als valides JSON. Kein Markdown, kein Text.' })
                });
                const data = await resp.json();
                const text = (data.response || data.answer || '').replace(/```json|```/g, '').trim();
                caState.smartParse = JSON.parse(text);
            } catch (e) {
                console.error('Smart parse failed:', e);
                // Fallback defaults
                caState.smartParse = {
                    land: { code: 'ch', label: '🇨🇭 Schweiz', confidence: 0.3 },
                    branche: { code: 'finance', label: '🏦 Finanzdienstleistung', confidence: 0.3 },
                    organisation: { code: 'general', label: 'Allgemein', name: null, confidence: 0.3 },
                    perspektive: { code: 'kunden', label: '🛒 Kunden', confidence: 0.3 },
                    szenarien: []
                };
            }
            caRenderConfirm();
        }

        function caRenderConfirm() {
            const p = caState.smartParse;
            if (!p) return;

            document.getElementById('caConfirmLoading').style.display = 'none';
            document.getElementById('caConfirmContent').style.display = 'block';
            document.getElementById('caConfirmTitle').textContent = 'Erkannter Kontext — stimmt das?';
            document.getElementById('caConfirmDesc').textContent = `"${caState.question}"`;

            // Set state from parsed values
            caState.macro = p.land?.code || 'ch';
            caState.meso = p.branche?.code || 'finance';
            caState.orgType = p.organisation?.code || 'general';
            caState.orgName = p.organisation?.name || p.organisation?.label || 'Allgemein';
            caState.perspective = p.perspektive?.code || 'kunden';

            const landLabels = { ch: '🇨🇭 Schweiz', at: '🇦🇹 Österreich', de: '🇩🇪 Deutschland' };
            const brancheLabels = { finance: '🏦 Finanzdienstleistung', health: '🏥 Gesundheit', public: '🏛️ Öffentlicher Sektor', energy: '⚡ Energie', retail: '🛍️ Retail', tech: '💻 Technologie', education: '🎓 Bildung' };
            const orgLabels = { company: '🏢 Unternehmen', public: '🏛️ Behörde', healthcare: '🏥 Gesundheitseinrichtung', general: '👤 Allgemein' };
            const perspLabels = { kunden: '🛒 Kunden', mitarbeitende: '👔 Mitarbeitende', management: '📊 Management', alle: '🔄 Alle Perspektiven' };

            // Render values with confidence indicator
            const confDot = (c) => c >= 0.7 ? '🟢' : c >= 0.4 ? '🟡' : '🔴';

            document.getElementById('caConfLandValue').innerHTML = `${landLabels[p.land?.code] || p.land?.label || 'Schweiz'} <span style="font-size:11px">${confDot(p.land?.confidence||0)}</span>`;
            document.getElementById('caConfBrancheValue').innerHTML = `${brancheLabels[p.branche?.code] || p.branche?.label || '–'} <span style="font-size:11px">${confDot(p.branche?.confidence||0)}</span>`;
            const orgDisplay = p.organisation?.name ? `${orgLabels[p.organisation?.code] || ''} — ${p.organisation.name}` : (orgLabels[p.organisation?.code] || p.organisation?.label || 'Allgemein');
            document.getElementById('caConfOrgValue').innerHTML = `${orgDisplay} <span style="font-size:11px">${confDot(p.organisation?.confidence||0)}</span>`;
            document.getElementById('caConfPerspValue').innerHTML = `${perspLabels[p.perspektive?.code] || p.perspektive?.label || 'Kunden'} <span style="font-size:11px">${confDot(p.perspektive?.confidence||0)}</span>`;

            // Pre-select dropdowns
            const landSel = document.getElementById('caConfLandSelect');
            if (landSel) landSel.value = p.land?.code || 'ch';
            const brancheSel = document.getElementById('caConfBrancheSelect');
            if (brancheSel) brancheSel.value = p.branche?.code || 'finance';
            const orgSel = document.getElementById('caConfOrgSelect');
            if (orgSel) orgSel.value = p.organisation?.code || 'general';
            const perspSel = document.getElementById('caConfPerspSelect');
            if (perspSel) perspSel.value = p.perspektive?.code || 'kunden';

            // Store scenarios for next step
            caState.scenarios = p.szenarien || [];
        }

        function caConfirmEdit(field) {
            // Toggle edit mode for a field
            const editEl = document.getElementById(`caConf${field.charAt(0).toUpperCase()+field.slice(1)}Edit`);
            if (!editEl) {
                // Handle camelCase fields
                const map = { land: 'Land', branche: 'Branche', org: 'Org', persp: 'Persp' };
                const el = document.getElementById(`caConf${map[field]}Edit`);
                if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
                return;
            }
            editEl.style.display = editEl.style.display === 'none' ? 'block' : 'none';
        }

        function caConfirmPick(field) {
            const map = { land: 'Land', branche: 'Branche', org: 'Org', persp: 'Persp' };
            const sel = document.getElementById(`caConf${map[field]}Select`);
            if (!sel) return;
            const val = sel.value;

            const landLabels = { ch: '🇨🇭 Schweiz', at: '🇦🇹 Österreich', de: '🇩🇪 Deutschland', custom_macro: '🌍 Anderes Land' };
            const brancheLabels = { finance: '🏦 Finanzdienstleistung', health: '🏥 Gesundheit', public: '🏛️ Öffentlicher Sektor', energy: '⚡ Energie', retail: '🛍️ Retail', tech: '💻 Technologie', education: '🎓 Bildung', custom_meso: '🏢 Andere' };
            const orgLabels = { company: '🏢 Unternehmen', public: '🏛️ Behörde', healthcare: '🏥 Gesundheitseinrichtung', general: '👤 Allgemein' };
            const perspLabels = { kunden: '🛒 Kunden', mitarbeitende: '👔 Mitarbeitende', management: '📊 Management', alle: '🔄 Alle Perspektiven' };

            if (field === 'land') {
                caState.macro = val;
                document.getElementById('caConfLandValue').innerHTML = landLabels[val] || val;
                document.getElementById('caConfLandCustom').style.display = val === 'custom_macro' ? 'block' : 'none';
            } else if (field === 'branche') {
                caState.meso = val;
                document.getElementById('caConfBrancheValue').innerHTML = brancheLabels[val] || val;
                document.getElementById('caConfBrancheCustom').style.display = val === 'custom_meso' ? 'block' : 'none';
            } else if (field === 'org') {
                caState.orgType = val;
                document.getElementById('caConfOrgValue').innerHTML = orgLabels[val] || val;
            } else if (field === 'persp') {
                caState.perspective = val;
                document.getElementById('caConfPerspValue').innerHTML = perspLabels[val] || val;
            }

            // Hide edit after pick
            document.getElementById(`caConf${map[field]}Edit`).style.display = 'none';
        }

        function caConfirmDone() {
            // Check custom fields
            if (caState.macro === 'custom_macro') {
                const custom = document.getElementById('caConfLandCustom')?.value?.trim();
                if (custom) caState.macroCustom = custom;
            }
            if (caState.meso === 'custom_meso') {
                const custom = document.getElementById('caConfBrancheCustom')?.value?.trim();
                if (custom) caState.mesoCustom = custom;
            }
            const orgCustom = document.getElementById('caConfOrgCustom')?.value?.trim();
            if (orgCustom) caState.orgName = orgCustom;

            // Go to scenarios
            caState.step = 2;
            caShowPanel('caStepScenarios');
            caUpdateProgress(2);
            caRenderScenarios();
        }

        // ═══ SCENARIO CARDS ═══
        function caRenderScenarios() {
            const scenarios = caState.scenarios || [];
            const container = document.getElementById('caScenarioChoices');
            document.getElementById('caScenarioLoading').style.display = 'none';
            document.getElementById('caScenarioCards').style.display = 'block';

            let html = scenarios.map((s, i) => `
                <div class="mb-choice" onclick="caPickScenario(${i})" data-scenario="${i}">
                    <div class="mb-choice-num">${i+1}</div>
                    <div class="mb-choice-icon">${s.icon || '📌'}</div>
                    <div class="mb-choice-title">${s.title}</div>
                    <div class="mb-choice-desc">${s.desc}</div>
                </div>
            `).join('');

            // Custom scenario option
            html += `
                <div class="mb-choice custom-choice" onclick="caPickCustomScenario()" style="border-style:dashed">
                    <div class="mb-choice-num">✎</div>
                    <div class="mb-choice-icon">🎨</div>
                    <div class="mb-choice-title">Eigenes Szenario</div>
                    <div class="mb-choice-desc">Ort, Beteiligte, Zeitrahmen und mentalen Zustand selbst definieren.</div>
                </div>`;

            container.innerHTML = html;

            // Update description with context
            const desc = document.getElementById('caScenarioDesc');
            if (caState.orgName && caState.orgName !== 'Allgemein') {
                desc.textContent = `In welcher konkreten Situation befinden sich die ${caState.perspective === 'kunden' ? 'Kunden' : caState.perspective === 'mitarbeitende' ? 'Mitarbeitenden' : caState.perspective === 'management' ? 'Entscheider' : 'Stakeholder'} von ${caState.orgName}?`;
            }
        }

        function caPickScenario(idx) {
            const s = caState.scenarios[idx];
            if (!s) return;
            // Deselect all, select this
            document.querySelectorAll('#caScenarioChoices .mb-choice').forEach(c => c.classList.remove('selected'));
            document.querySelector(`#caScenarioChoices .mb-choice[data-scenario="${idx}"]`)?.classList.add('selected');
            document.getElementById('caCustomScenario').style.display = 'none';

            // Store micro from scenario
            caState.micro = {
                where: s.where || '',
                social: s.social || '',
                time: s.time || '',
                cognitive: s.cognitive || '',
                notes: s.desc || '',
                scenario_title: s.title
            };
            document.getElementById('caScenarioBtn').disabled = false;
        }

        function caPickCustomScenario() {
            document.querySelectorAll('#caScenarioChoices .mb-choice').forEach(c => c.classList.remove('selected'));
            document.querySelector('#caScenarioChoices .custom-choice')?.classList.add('selected');
            document.getElementById('caCustomScenario').style.display = 'block';
            caState.micro = {}; // Will be filled from dropdowns
            document.getElementById('caScenarioBtn').disabled = false;
        }

        function caAnalyzeFromScenario() {
            // If custom scenario, collect from dropdowns
            if (!caState.micro?.scenario_title) {
                caState.micro = {
                    where: document.getElementById('caMicroWhere')?.value || '',
                    social: document.getElementById('caMicroSocial')?.value || '',
                    time: document.getElementById('caMicroTime')?.value || '',
                    cognitive: document.getElementById('caMicroCognitive')?.value || '',
                    notes: document.getElementById('caMicroNotes')?.value?.trim() || ''
                };
            }
            caState.step = 3;
            caShowPanel('caStep4');
            caUpdateProgress(3);
            caRunAnalysis();
        }

        const CA_PANELS = ['caStep0','caStepConfirm','caStepScenarios','caStep4','caStep4'];

        function caNextStep(fromStep) {
            const next = fromStep + 1;
            caState.step = next;
            caShowPanel(CA_PANELS[next]);
            caUpdateProgress(next);
        }

        function caBackToStep(panelId, stepNum) {
            caState.step = stepNum;
            caShowPanel(panelId);
            caUpdateProgress(stepNum);
        }

        // ═══ ORGANISATION STEP ═══
        function caGoToOrg() {
            caState.step = 3;
            caShowPanel('caStepOrg');
            caUpdateProgress(3);
        }

        function caSelectOrgType(el, type) {
            document.querySelectorAll('#caOrgTypeChoices .mb-choice').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            caState.orgType = type;
            caState.orgCode = null;
            caState.orgName = null;

            const searchEl = document.getElementById('caOrgSearch');
            const formEl = document.getElementById('caNewOrgForm');
            formEl.style.display = 'none';

            if (type === 'general') {
                searchEl.style.display = 'none';
                caState.orgName = 'Allgemein';
                document.getElementById('caOrgBtn').disabled = false;
            } else {
                searchEl.style.display = 'block';
                document.getElementById('caOrgBtn').disabled = true;
                document.getElementById('caOrgSearchInput').value = '';
                document.getElementById('caOrgResults').innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:8px">Tippe um zu suchen...</div>';
                // Load CRM data if not loaded
                if (!crmCompaniesData.length) crmLoadCompanies();
            }
        }

        function caSearchOrg() {
            const q = document.getElementById('caOrgSearchInput').value.toLowerCase().trim();
            const el = document.getElementById('caOrgResults');
            if (!q) { el.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:8px">Tippe um zu suchen...</div>'; return; }

            // Search in CRM companies data
            const matches = crmCompaniesData.filter(c =>
                (c.name || '').toLowerCase().includes(q) ||
                (c.code || '').toLowerCase().includes(q) ||
                (c.children || []).some(ch => (ch.name || '').toLowerCase().includes(q))
            ).slice(0, 8);

            if (!matches.length) {
                el.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:8px">Keine Treffer — erstelle eine neue Organisation ↓</div>';
                return;
            }

            el.innerHTML = matches.map(c => `
                <div onclick="caPickOrg('${c.code || ''}','${(c.name||'').replace(/'/g,"\\\'")}')" style="padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border);transition:background 0.15s;font-size:13px;display:flex;align-items:center;gap:10px" onmouseover="this.style.background='rgba(91,138,245,0.1)'" onmouseout="this.style.background='transparent'">
                    <span style="font-size:18px">🏢</span>
                    <div>
                        <div style="color:var(--white);font-weight:500">${c.name || 'Unbekannt'}</div>
                        <div style="font-size:11px;color:var(--text-muted)">${c.code || ''} · ${c.industry || c.type || ''}</div>
                    </div>
                </div>
            `).join('');
        }

        function caPickOrg(code, name) {
            caState.orgCode = code;
            caState.orgName = name;
            caState.customerCode = code;
            document.getElementById('caOrgSearchInput').value = name;
            document.getElementById('caOrgResults').innerHTML = `<div style="padding:10px 14px;background:rgba(91,138,245,0.1);border-radius:8px;font-size:13px;color:var(--accent-light)">✅ ${name} (${code}) ausgewählt</div>`;
            document.getElementById('caOrgBtn').disabled = false;
            document.getElementById('caNewOrgForm').style.display = 'none';
        }

        function caNewOrg() {
            document.getElementById('caNewOrgForm').style.display = 'block';
            document.getElementById('caOrgResults').innerHTML = '';
            document.getElementById('caOrgSearchInput').value = '';
            document.getElementById('caNewOrgName').focus();
            document.getElementById('caNewOrgName').oninput = () => {
                const name = document.getElementById('caNewOrgName').value.trim();
                if (name) {
                    caState.orgName = name;
                    caState.orgCode = null; // New, no code yet
                    document.getElementById('caOrgBtn').disabled = false;
                } else {
                    document.getElementById('caOrgBtn').disabled = true;
                }
            };
        }

        // ═══ PERSPEKTIVE STEP ═══
        function caGoToPersp() {
            caState.step = 4;
            caShowPanel('caStepPersp');
            caUpdateProgress(4);
            // Update description based on org
            const desc = document.getElementById('caPerspDesc');
            if (caState.orgName && caState.orgName !== 'Allgemein') {
                desc.textContent = `Wessen Verhalten bei ${caState.orgName} möchten wir verstehen?`;
            }
        }

        function caSelectPersp(el, value) {
            document.querySelectorAll('#caPerspChoices .mb-choice').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            caState.perspective = value;
            document.getElementById('caPerspBtn').disabled = false;
        }

        function caGoToSituation() {
            caState.step = 5;
            caShowPanel('caStep3');
            caUpdateProgress(5);
        }

        function caUpdateMicroBtn() {
            const w = document.getElementById('caMicroWhere').value;
            const s = document.getElementById('caMicroSocial').value;
            const btn = document.getElementById('caStep3Btn');
            if (btn) btn.disabled = !(w && s);
        }

        async function caAnalyze() {
            // Collect MICRO data (fallback for old step)
            caState.micro = {
                where: document.getElementById('caMicroWhere')?.value || '',
                social: document.getElementById('caMicroSocial')?.value || '',
                time: document.getElementById('caMicroTime')?.value || '',
                cognitive: document.getElementById('caMicroCognitive')?.value || '',
                notes: document.getElementById('caMicroNotes')?.value?.trim() || ''
            };
            caState.step = 3;
            caShowPanel('caStep4');
            caUpdateProgress(3);
            await caRunAnalysis();
        }

        async function caRunAnalysis() {
            const statusEl = document.getElementById('caAnalysisStatus');
            const progressEl = document.getElementById('caAnalysisProgress');
            const resultEl = document.getElementById('caAnalysisResult');
            progressEl.style.display = 'block';
            resultEl.style.display = 'none';

            const steps = ['Wissen wird geladen...', 'Landeskontext analysieren...', 'Branchenumfeld einordnen...', 'Situation verstehen...', 'Kontextprofil erstellen...', 'Auswirkungen ableiten...'];
            for (let i = 0; i < steps.length; i++) {
                statusEl.textContent = steps[i];
                await new Promise(r => setTimeout(r, 600));
            }

            // Call AI for full analysis
            const orgInfo = caState.orgName && caState.orgName !== 'Allgemein' ? `\nOrganisation: ${caState.orgName}${caState.orgCode ? ' ('+caState.orgCode+')' : ''} [Typ: ${caState.orgType || 'unbekannt'}]` : '';
            const perspInfo = caState.perspective ? `\nPerspektive: ${caState.perspective === 'alle' ? 'Alle Stakeholder (strategische Gesamtanalyse)' : caState.perspective === 'kunden' ? 'Kunden/Endnutzer' : caState.perspective === 'mitarbeitende' ? 'Mitarbeitende/Frontline' : 'Management/Entscheider'}` : '';

            const prompt = caState.mode === 'schnell'
                ? `Führe eine vollständige EBF-Kontextanalyse durch für folgende Frage:\n"${caState.question}"\n\nAnalysiere alle 5 Ebenen (MACRO→MESO→MICRO→INDIVIDUAL→META) und alle 8 Ψ-Dimensionen.`
                : `Führe eine EBF-Kontextanalyse durch:\nFrage: "${caState.question}"\nMACRO: ${caState.macro}${caState.macro==='custom_macro' ? ' ('+(caState.macroCustom || document.getElementById('caMacroCustom')?.value || '')+')' : ''}\nMESO: ${caState.meso}${caState.meso==='custom_meso' ? ' ('+(caState.mesoCustom || document.getElementById('caMesoCustom')?.value || '')+')' : ''}${orgInfo}${perspInfo}\nMICRO: Ort=${caState.micro?.where||''}, Sozial=${caState.micro?.social||''}, Zeit=${caState.micro?.time||''}, Kognitiv=${caState.micro?.cognitive||''}${caState.micro?.notes ? ', Notizen: '+caState.micro.notes : ''}${caState.micro?.scenario_title ? '\nSzenario: '+caState.micro.scenario_title : ''}`;

            const sysPrompt = `Du bist BEATRIX Kontext-Analyst. Analysiere mit dem EBF Ψ-Framework.

Antworte EXAKT in diesem JSON-Format (kein Markdown, kein Text davor/danach):
{
  "psi_profile": {
    "psi_i": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz in Alltagssprache: Was bedeutet das für die Person konkret?" },
    "psi_s": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz Alltagssprache" },
    "psi_c": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz Alltagssprache" },
    "psi_k": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz Alltagssprache" },
    "psi_e": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz Alltagssprache" },
    "psi_t": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz Alltagssprache" },
    "psi_m": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz Alltagssprache" },
    "psi_f": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz Alltagssprache" }
  },
  "context_story": "Ein Absatz (4-6 Sätze) in einfacher Sprache, der die gesamte Situation aus Sicht der betroffenen Person beschreibt. Kein Fachjargon, keine griechischen Buchstaben, keine Zahlenwerte. Schreibe so, als würdest du einem Kunden erklären, in welcher Welt sich die Zielgruppe befindet. Beginne mit 'Die Menschen in diesem Kontext...' oder 'Stell dir vor...'",
  "allgemeine_perspektive": "Ein Absatz (3-5 Sätze) aus der Vogelperspektive: Was ist das GROSSE BILD dieses Kontexts? Welche Kräfte wirken auf das Verhalten? Was macht diesen Kontext besonders oder herausfordernd? Schreibe wie ein erfahrener Berater, der einem CEO in 30 Sekunden erklärt, warum sich Menschen hier so verhalten wie sie es tun. Kein Jargon, keine Zahlenwerte.",
  "parameters": {
    "lambda": { "value": "Zahl", "note": "Erklärung warum dieser Wert im Kontext" },
    "beta": { "value": "Zahl", "note": "Erklärung" },
    "theta": { "value": "Zahl", "note": "Erklärung" },
    "delta": { "value": "Zahl", "note": "Erklärung" }
  },
  "synthesis": "2-3 Sätze Zusammenfassung: Was bedeutet dieser Kontext für Verhaltensvorhersagen?",
  "implications": ["Implikation 1", "Implikation 2", "Implikation 3"],
  "confidence": "LLMMC Prior | Confidence: 0.0-1.0",
  "macro_summary": "1 Satz MACRO",
  "meso_summary": "1 Satz MESO",
  "micro_summary": "1 Satz MICRO"
}

WICHTIG für "plain" und "context_story":
- Schreibe für einen Berater, der den Kontext seinem Kunden erklärt
- Keine griechischen Buchstaben (λ, β, Ψ)
- Keine Zahlenwerte oder Scores
- Konkrete Beispiele aus dem Alltag der Zielgruppe
- "plain" pro Dimension: Was SPÜRT oder ERLEBT die Person?
- "context_story": Die Geschichte des Kontexts als zusammenhängende Erzählung

Werte-Skala für Ψ: 0.0 = minimal/absent, 0.5 = moderat, 1.0 = maximal/dominant.
Parameter sind KONTEXTABHÄNGIG: λ(Ψ), β(Ψ), θ(Ψ) — KEINE Konstanten!`;

            try {
                const r = await fetch(`${API}/chat`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: prompt, system_prompt: sysPrompt, context: 'context_analysis' })
                });
                if (!r.ok) throw new Error('Analysis failed');

                let text = '';
                if (r.headers.get('content-type')?.includes('text/event-stream')) {
                    const reader = r.body.getReader();
                    const decoder = new TextDecoder();
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        for (const line of chunk.split('\n')) {
                            if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                                try { const d = JSON.parse(line.slice(6)); if (d.content) text += d.content; } catch(e) {}
                            }
                        }
                    }
                } else {
                    const data = await r.json();
                    text = data.response || data.content || JSON.stringify(data);
                }

                // Parse JSON from response
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    caState.result = JSON.parse(jsonMatch[0]);
                    caRenderResult();
                } else {
                    throw new Error('No JSON in response');
                }
            } catch(e) {
                console.error('CA analysis error:', e);
                // Generate fallback result
                caState.result = caGenerateFallback();
                caRenderResult();
            }
        }

        function caGenerateFallback() {
            return {
                allgemeine_perspektive: 'Ohne spezifischere Angaben zum Kontext können wir nur ein grobes Bild zeichnen. Jede Verhaltensveränderung hängt davon ab, in welcher Welt sich die Menschen befinden — welche Regeln gelten, wer zuschaut, wie viel Zeit und Geld zur Verfügung steht, und ob die Situation Nachdenken erlaubt oder schnelle Entscheidungen erzwingt. Je mehr wir über den konkreten Kontext wissen, desto präziser können wir vorhersagen, was funktioniert.',
                psi_profile: {
                    psi_i: { value: 0.6, label: 'Moderater regulatorischer Rahmen', key_factors: ['Gesetzgebung', 'Defaults'], plain: 'Es gibt klare Regeln und Vorgaben, aber auch Spielraum für eigene Entscheidungen.' },
                    psi_s: { value: 0.5, label: 'Gemischte soziale Einflüsse', key_factors: ['Peer Effects', 'Normen'], plain: 'Was andere tun, spielt eine Rolle — aber man fühlt sich nicht stark unter Beobachtung.' },
                    psi_c: { value: 0.4, label: 'Moderate kognitive Belastung', key_factors: ['Komplexität', 'Aufmerksamkeit'], plain: 'Die Entscheidung ist nicht trivial, aber auch nicht überwältigend — man muss sich etwas Zeit nehmen.' },
                    psi_k: { value: 0.5, label: 'Kultureller Standardkontext', key_factors: ['Werte', 'Tradition'], plain: 'Kulturelle Gewohnheiten und Werte spielen mit, ohne die Entscheidung zu dominieren.' },
                    psi_e: { value: 0.5, label: 'Durchschnittliche Ressourcen', key_factors: ['Budget', 'Zeit'], plain: 'Geld und Zeit sind vorhanden, aber begrenzt — man wägt ab, was sich lohnt.' },
                    psi_t: { value: 0.4, label: 'Moderater Zeitdruck', key_factors: ['Deadline', 'Rhythmus'], plain: 'Es besteht kein akuter Zeitdruck, aber die Entscheidung sollte irgendwann fallen.' },
                    psi_m: { value: 0.5, label: 'Standard-Tooling', key_factors: ['Digital', 'Analog'], plain: 'Die nötigen Werkzeuge und Informationen sind grundsätzlich verfügbar.' },
                    psi_f: { value: 0.5, label: 'Neutrales Setting', key_factors: ['Ort', 'Zugang'], plain: 'Der Ort der Entscheidung hat keinen starken Einfluss — weder besonders förderlich noch hinderlich.' }
                },
                context_story: 'Die Menschen in diesem Kontext bewegen sich in einem relativ stabilen Umfeld. Sie haben grundsätzlich Zugang zu Informationen und Ressourcen, stehen aber vor einer Entscheidung, die nicht ganz einfach ist. Soziale Einflüsse spielen eine Rolle — man schaut durchaus, was andere machen — aber letztlich fühlt sich jeder für seine eigene Entscheidung verantwortlich. Es gibt keinen akuten Handlungsdruck, was dazu führen kann, dass Entscheidungen aufgeschoben werden. Die kulturelle Prägung gibt eine Richtung vor, ohne die Wahl zu erzwingen.',
                parameters: {
                    lambda: { value: '2.25', note: 'GGG Default — kein kontextspezifischer Modifier' },
                    beta: { value: '0.95', note: 'Leicht present-biased im Standardkontext' },
                    theta: { value: '0.5', note: 'Mittlere Aufmerksamkeit' },
                    delta: { value: '0.97', note: 'Standard-Diskontierung' }
                },
                synthesis: 'Ohne spezifischere Kontextdaten werden GGG-Defaults verwendet. Die Parameter sind LLMMC Priors und sollten mit empirischen Daten kalibriert werden.',
                implications: ['GGG Defaults aktiv — alle Parameter mit Vorsicht nutzen', 'Kontextspezifische Daten würden die Präzision erhöhen', 'BCM2-Datenbank für empirische Ankerwerte konsultieren'],
                confidence: 'LLMMC Prior | Confidence: 0.35',
                macro_summary: 'Standard DACH-Kontext angenommen',
                meso_summary: 'Branchenkontext nicht spezifiziert',
                micro_summary: 'Situationsspezifische Faktoren unbekannt'
            };
        }

        function caRenderResult() {
            const r = caState.result;
            if (!r) return;

            document.getElementById('caAnalysisProgress').style.display = 'none';
            document.getElementById('caAnalysisResult').style.display = 'block';
            document.querySelector('#caStep4 .mb-step-title').textContent = 'Kontextprofil — Ergebnis';
            document.querySelector('#caStep4 .mb-step-desc').textContent = caState.question;

            // Context breadcrumb
            const bcParts = [];
            if (caState.macro && caState.macro !== 'custom_macro') bcParts.push(caState.macro === 'ch' ? '🇨🇭 Schweiz' : caState.macro === 'at' ? '🇦🇹 Österreich' : caState.macro === 'de' ? '🇩🇪 Deutschland' : caState.macro);
            if (caState.meso && caState.meso !== 'custom_meso') bcParts.push(caState.meso === 'finance' ? '🏦 Finanz' : caState.meso === 'health' ? '🏥 Gesundheit' : caState.meso === 'public' ? '🏛️ Öffentlich' : caState.meso);
            if (caState.orgName && caState.orgName !== 'Allgemein') bcParts.push('🏢 ' + caState.orgName);
            if (caState.perspective) bcParts.push(caState.perspective === 'alle' ? '🔄 Alle Perspektiven' : caState.perspective === 'kunden' ? '🛒 Kunden' : caState.perspective === 'mitarbeitende' ? '👔 Mitarbeitende' : '📊 Management');
            const bcEl = document.getElementById('caResultBreadcrumb');
            if (bcEl) {
                bcEl.innerHTML = bcParts.length ? bcParts.map(p => `<span style="padding:3px 10px;background:rgba(91,138,245,0.1);border:1px solid rgba(91,138,245,0.2);border-radius:12px;font-size:11px;color:var(--accent-light)">${p}</span>`).join('') : '';
                bcEl.style.display = bcParts.length ? 'flex' : 'none';
            }

            caUpdateProgress(4);

            // Show "Kontext vertiefen" button only in schnell mode
            const deepenBtn = document.getElementById('caDeepenBtn');
            if (deepenBtn) deepenBtn.style.display = caState.mode === 'schnell' ? 'inline-flex' : 'none';

            // 0) Allgemeine Perspektive — Big Picture
            const perspEl = document.getElementById('caPerspectiveText');
            if (perspEl) {
                perspEl.textContent = r.allgemeine_perspektive || '';
                document.getElementById('caPerspectiveBox').style.display = r.allgemeine_perspektive ? 'block' : 'none';
            }

            // Render Ψ cards
            const cardsEl = document.getElementById('caPsiCards');
            cardsEl.innerHTML = PSI_DIMS.map(dim => {
                const data = r.psi_profile?.[dim.key] || { value: 0.5, label: '–', key_factors: [] };
                const pct = Math.round(data.value * 100);
                const hue = data.value < 0.3 ? 200 : data.value < 0.7 ? 45 : 140;
                return `
                <div style="padding:14px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">
                        <span style="font-size:16px">${dim.icon}</span>
                        <span style="font-size:12px;font-weight:700;color:var(--white)">${dim.label}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <div style="flex:1;height:6px;background:var(--navy-mid);border-radius:3px;overflow:hidden">
                            <div style="width:${pct}%;height:100%;background:hsl(${hue},70%,55%);border-radius:3px;transition:width 0.8s ease"></div>
                        </div>
                        <span style="font-size:13px;font-weight:700;color:hsl(${hue},70%,65%)">${data.value.toFixed(2)}</span>
                    </div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.6);line-height:1.4;margin-bottom:4px">${data.label}</div>
                    <div style="font-size:10px;color:rgba(255,255,255,0.35)">${(data.key_factors||[]).join(' · ')}</div>
                </div>`;
            }).join('');

            // ── Context Story Box: Plain Language Translation ──
            const storyTextEl = document.getElementById('caStoryText');
            const storyDimsEl = document.getElementById('caStoryDims');
            const storyBoxEl = document.getElementById('caStoryBox');

            if (r.context_story || PSI_DIMS.some(d => r.psi_profile?.[d.key]?.plain)) {
                storyBoxEl.style.display = 'block';

                // Main story paragraph
                storyTextEl.innerHTML = r.context_story
                    ? `<p style="margin:0">${r.context_story}</p>`
                    : '';

                // Per-dimension plain-language bullets
                const dimLines = PSI_DIMS.map(dim => {
                    const data = r.psi_profile?.[dim.key];
                    if (!data?.plain) return '';
                    const hue = data.value < 0.3 ? 200 : data.value < 0.7 ? 45 : 140;
                    return `
                    <div style="display:flex;align-items:flex-start;gap:10px;padding:8px 12px;background:rgba(255,255,255,0.03);border-radius:8px">
                        <span style="font-size:16px;min-width:24px;text-align:center;margin-top:1px">${dim.icon}</span>
                        <div style="flex:1">
                            <div style="font-size:12px;font-weight:600;color:hsl(${hue},60%,70%);margin-bottom:2px">${dim.label.replace(/Ψ_[A-Z]\s*/,'')}</div>
                            <div style="font-size:13px;color:rgba(255,255,255,0.75);line-height:1.5">${data.plain}</div>
                        </div>
                    </div>`;
                }).filter(Boolean).join('');

                storyDimsEl.innerHTML = dimLines;
            } else {
                storyBoxEl.style.display = 'none';
            }

            // Render parameters
            const paramsEl = document.getElementById('caParams');
            const params = r.parameters || {};
            paramsEl.innerHTML = Object.entries(params).map(([k, v]) =>
                `<div style="display:flex;align-items:baseline;gap:8px;margin-bottom:6px">
                    <span style="font-weight:700;color:var(--accent-light);min-width:24px">${k === 'lambda' ? 'λ' : k === 'beta' ? 'β' : k === 'theta' ? 'θ' : k === 'delta' ? 'δ' : k}</span>
                    <span style="font-weight:600;color:var(--white)">${v.value}</span>
                    <span style="color:rgba(255,255,255,0.45);font-size:12px">— ${v.note}</span>
                </div>`
            ).join('');

            // Render synthesis
            const insightEl = document.getElementById('caInsight');
            let html = `<p style="margin-bottom:10px">${r.synthesis || ''}</p>`;
            if (r.implications?.length) {
                html += '<div style="margin-top:8px">' + r.implications.map(imp =>
                    `<div style="display:flex;align-items:baseline;gap:6px;margin-bottom:4px;font-size:12px"><span style="color:var(--accent)">→</span> ${imp}</div>`
                ).join('') + '</div>';
            }
            if (r.confidence) {
                html += `<div style="margin-top:10px;padding:8px 12px;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-radius:8px;font-size:11px;color:rgba(251,191,36,0.8)">⚠️ ${r.confidence}</div>`;
            }
            insightEl.innerHTML = html;
        }

        async function caSaveAndUse() {
            const r = caState.result;
            if (!r) return;
            const payload = {
                question: caState.question,
                mode: caState.mode,
                macro_context: caState.macro ? { country: caState.macro, custom: caState.macroCustom || document.getElementById('caMacroCustom')?.value } : null,
                meso_context: caState.meso ? { industry: caState.meso, custom: caState.mesoCustom || document.getElementById('caMesoCustom')?.value, org_type: caState.orgType, org_name: caState.orgName, perspective: caState.perspective } : null,
                micro_context: caState.micro || null,
                psi_profile: r.psi_profile,
                parameters: r.parameters,
                synthesis: r.synthesis,
                implications: r.implications,
                confidence: r.confidence,
                customer_code: caState.customerCode || null,
                project_slug: caState.projectSlug || null,
                lineage_id: caState.lineageId || null
            };
            try {
                // Try new versioned endpoint first
                let resp = await fetch(`${API}/psi-analyses`, {
                    method: 'POST', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (resp.ok) {
                    const result = await resp.json();
                    showToast(`Kontextprofil gespeichert: ${result.lineage_id} v${result.version}`, 'success');
                    caState.lineageId = result.lineage_id;
                    caState.currentVersionId = result.id;
                    return;
                }
                // Fallback: save to old contexts table
                const fallback = {
                    client: 'Ψ-Analyse',
                    project: caState.question.substring(0, 80),
                    domain: 'OTH',
                    status: 'aktiv',
                    situation: JSON.stringify(r.psi_profile || {}),
                    goal: r.synthesis || '',
                    constraints: r.confidence || ''
                };
                resp = await fetch(`${API}/contexts`, {
                    method: 'POST', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(fallback)
                });
                if (resp.ok) {
                    showToast('Kontextprofil gespeichert', 'success');
                } else {
                    throw new Error('Both endpoints failed');
                }
            } catch(e) {
                console.error('Save error:', e);
                showToast('Fehler beim Speichern', 'error');
            }
        }

        function caUseInChat() {
            const r = caState.result;
            if (!r) return;
            // Build context string for chat
            const psiSummary = PSI_DIMS.map(d => {
                const v = r.psi_profile?.[d.key];
                return v ? `${d.label}: ${v.value.toFixed(2)} (${v.label})` : '';
            }).filter(Boolean).join('\n');
            const params = Object.entries(r.parameters||{}).map(([k,v]) => `${k}=${v.value}`).join(', ');
            const ctxMsg = `[KONTEXT-ANALYSE]\nFrage: ${caState.question}\n\nΨ-Profil:\n${psiSummary}\n\nParameter: ${params}\n\nSynthese: ${r.synthesis}`;
            // Switch to chat and populate
            showSection('chat', document.querySelector('[data-section="chat"]'));
            setTimeout(() => {
                const input = document.getElementById('chatInput');
                if (input) {
                    input.value = ctxMsg;
                    input.style.height = 'auto';
                    input.style.height = input.scrollHeight + 'px';
                    input.focus();
                }
            }, 200);
        }

        async function caShowHistory() {
            caShowPanel('caHistory');
            document.getElementById('caProgress').style.display = 'none';
            const container = document.getElementById('caHistoryList');
            container.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)"><div class="spinner" style="margin:0 auto 12px"></div>Wird geladen...</div>';
            try {
                let analyses = [];
                // Try new versioned endpoint
                let r = await fetch(`${API}/psi-analyses`, { headers: H() });
                if (r.ok) {
                    analyses = await r.json();
                } else {
                    // Fallback: load from old contexts table
                    r = await fetch(`${API}/contexts`, { headers: H() });
                    if (r.ok) {
                        const old = await r.json();
                        analyses = old.filter(c => c.client === 'Ψ-Analyse' || c.client === 'Kontextanalyse').map(c => {
                            let psiProfile = {};
                            try { psiProfile = JSON.parse(c.situation); } catch(e) {}
                            return {
                                id: c.id,
                                lineage_id: `LEGACY-${c.id}`,
                                version: 1,
                                question: c.project || c.client || '–',
                                mode: 'schnell',
                                psi_profile: psiProfile,
                                parameters: {},
                                synthesis: c.goal || '',
                                confidence: c.constraints || '',
                                created_by: c.created_by,
                                created_at: c.created_at
                            };
                        });
                    }
                }
                if (!analyses.length) {
                    container.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">Noch keine Ψ-Analysen gespeichert.</div>';
                    return;
                }

                // Group by lineage
                const lineages = {};
                analyses.forEach(a => {
                    if (!lineages[a.lineage_id]) lineages[a.lineage_id] = [];
                    lineages[a.lineage_id].push(a);
                });

                container.innerHTML = Object.entries(lineages).map(([lid, versions]) => {
                    const latest = versions[0]; // already sorted DESC
                    const date = new Date(latest.created_at).toLocaleDateString('de-CH', { day: '2-digit', month: 'short', year: 'numeric' });
                    const psi = latest.psi_profile || {};

                    // Mini Ψ bars
                    const psiMini = PSI_DIMS.map(d => {
                        const v = psi[d.key];
                        if (!v) return '';
                        const pct = Math.round(v.value * 100);
                        const hue = v.value < 0.3 ? 200 : v.value < 0.7 ? 45 : 140;
                        return `<div style="display:flex;align-items:center;gap:4px;min-width:110px">
                            <span style="font-size:12px">${d.icon}</span>
                            <div style="flex:1;height:4px;background:var(--navy-mid);border-radius:2px;overflow:hidden;max-width:50px">
                                <div style="width:${pct}%;height:100%;background:hsl(${hue},70%,55%);border-radius:2px"></div>
                            </div>
                            <span style="font-size:11px;color:hsl(${hue},70%,65%);font-weight:600">${v.value.toFixed(1)}</span>
                        </div>`;
                    }).join('');

                    // Version pills
                    const versionPills = versions.map(v => {
                        const isLatest = v.id === latest.id;
                        const vDate = new Date(v.created_at).toLocaleDateString('de-CH', { day: '2-digit', month: '2-digit' });
                        return `<span onclick="caLoadVersion('${v.id}')" style="font-size:10px;padding:2px 8px;border-radius:10px;cursor:pointer;transition:all 0.2s;${isLatest ? 'background:var(--accent);color:white' : 'background:var(--navy-mid);color:rgba(255,255,255,0.5);border:1px solid var(--border)'}" title="${vDate}">v${v.version}</span>`;
                    }).join('');

                    // Params
                    const params = latest.parameters || {};
                    const paramStr = Object.entries(params).map(([k,v]) => {
                        const sym = k === 'lambda' ? 'λ' : k === 'beta' ? 'β' : k === 'theta' ? 'θ' : k === 'delta' ? 'δ' : k;
                        return `<span style="color:var(--accent-light)">${sym}</span>=${v.value}`;
                    }).join('  ');

                    return `
                    <div style="padding:16px 18px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap">
                            <span style="font-size:11px;font-family:monospace;color:var(--accent-light);background:var(--accent-glow);padding:2px 8px;border-radius:6px">${lid}</span>
                            <span style="font-weight:600;color:var(--white);font-size:14px;flex:1">${latest.question?.substring(0,80) || '–'}${(latest.question?.length||0) > 80 ? '...' : ''}</span>
                            <span style="font-size:11px;color:rgba(255,255,255,0.25)">${date}</span>
                        </div>
                        <div style="display:flex;flex-wrap:wrap;gap:6px 12px;margin-bottom:10px">${psiMini}</div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:8px">${paramStr}</div>
                        ${latest.synthesis ? `<div style="font-size:12px;color:rgba(255,255,255,0.55);line-height:1.5;margin-bottom:8px">${latest.synthesis.substring(0,200)}${latest.synthesis.length > 200 ? '...' : ''}</div>` : ''}
                        <div style="display:flex;align-items:center;gap:8px;border-top:1px solid rgba(255,255,255,0.04);padding-top:8px;flex-wrap:wrap">
                            <span style="font-size:10px;color:rgba(255,255,255,0.3)">Versionen:</span>
                            ${versionPills}
                            <div style="flex:1"></div>
                            <button onclick="caNewVersion('${lid}','${latest.question?.replace(/'/g,"\\'")}')" style="font-size:11px;padding:3px 10px;background:rgba(139,170,255,0.08);color:var(--accent-light);border:1px solid rgba(139,170,255,0.2);border-radius:6px;cursor:pointer" title="Neue Version dieser Analyse">+ v${versions.length+1}</button>
                            <button onclick="caDeleteAnalysis('${latest.id}')" style="font-size:11px;padding:3px 8px;background:transparent;color:rgba(248,113,113,0.5);border:1px solid rgba(248,113,113,0.15);border-radius:6px;cursor:pointer">Löschen</button>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) {
                console.error('History load:', e);
                container.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">Fehler beim Laden.</div>';
            }
        }

        function caNewVersion(lineageId, question) {
            caState.lineageId = lineageId;
            caState.question = question;
            caState.mode = 'schnell';
            caRunSchnell(question);
        }

        async function caLoadVersion(analysisId) {
            // Could expand to show full detail of a specific version
            showToast(`Version ${analysisId} — Detail-View kommt bald`, 'info');
        }

        async function caDeleteAnalysis(id) {
            if (!await bxConfirm('Ψ-Analyse wirklich löschen?', {title:'Analyse löschen', icon:'🗑️', confirmText:'Löschen', danger:true})) return;
            try {
                let resp = await fetch(`${API}/psi-analyses/${id}`, { method: 'DELETE', headers: H() });
                if (!resp.ok) {
                    // Fallback: try old contexts endpoint
                    resp = await fetch(`${API}/contexts/${id}`, { method: 'DELETE', headers: H() });
                }
                showToast('Analyse gelöscht', 'success');
                caShowHistory();
            } catch(e) { showToast('Fehler', 'error'); }
        }

        // Keep legacy ctxLoad as alias
        async function ctxLoad() { caInit(); }

        // ── CRM ──────────────────────────────────────────
        let crmDeals = [];
        let crmView = 'kanban';
        const CRM_STAGES = [
            { id: 'prospect', label: 'Prospect', color: 'rgba(139,170,255,0.8)', prob: 10, icon: '🎯' },
            { id: 'qualified', label: 'Qualified', color: 'rgba(56,189,248,0.8)', prob: 25, icon: '✅' },
            { id: 'proposal', label: 'Proposal', color: 'rgba(251,191,36,0.8)', prob: 50, icon: '📄' },
            { id: 'negotiation', label: 'Negotiation', color: 'rgba(232,163,61,0.9)', prob: 75, icon: '🤝' },
            { id: 'won', label: 'Won', color: 'rgba(52,211,153,0.8)', prob: 100, icon: '🏆' },
            { id: 'active', label: 'Active', color: 'rgba(52,211,153,0.6)', prob: 100, icon: '⚡' },
            { id: 'dormant', label: 'Dormant', color: 'rgba(148,163,184,0.5)', prob: 5, icon: '💤' },
            { id: 'churned', label: 'Churned', color: 'rgba(248,113,113,0.4)', prob: 0, icon: '📉' },
            { id: 'lost', label: 'Lost', color: 'rgba(248,113,113,0.6)', prob: 0, icon: '✗' }
        ];
        const CRM_PIPELINE = ['prospect', 'qualified', 'proposal', 'negotiation', 'won', 'active'];

        let crmLastSync = null;

        async function crmLoad() {
            try {
                const [dealsR, statsR] = await Promise.all([
                    fetch(`${API}/crm/deals`, { headers: H() }),
                    fetch(`${API}/crm/stats`, { headers: H() })
                ]);
                crmDeals = dealsR.ok ? await dealsR.json() : [];
                const stats = statsR.ok ? await statsR.json() : {};
                crmRenderKpis(stats);
                crmRenderView();
                const hint = document.getElementById('crmSyncHint');
                if (hint) hint.style.display = crmDeals.length ? 'none' : 'block';
                // Date info
                const di = document.getElementById('crmDateInfo');
                if (di) {
                    const today = new Date().toLocaleDateString('de-CH', {day:'2-digit', month:'long', year:'numeric'});
                    const syncInfo = crmLastSync ? ` · Letzter Sync: ${crmLastSync.toLocaleTimeString('de-CH', {hour:'2-digit', minute:'2-digit'})}` : '';
                    di.textContent = `Stand: ${today}${syncInfo}`;
                }
            } catch(e) { console.error('CRM load:', e); crmDeals = []; crmRenderView(); }
        }

        function crmRenderKpis(s) {
            document.getElementById('crmKpiActive').textContent = s.active_deals || 0;
            document.getElementById('crmKpiPipeline').textContent = s.pipeline_value ? new Intl.NumberFormat('de-CH', {notation:'compact'}).format(s.pipeline_value) + ' CHF' : '–';
            document.getElementById('crmKpiWon').textContent = s.won_deals || 0;
            document.getElementById('crmKpiConv').textContent = (s.conversion_rate || 0) + '%';
            document.getElementById('crmKpiCompanies').textContent = s.companies || 0;
        }

        function crmShowLeadTimeline() {
            if (!crmDeals || !crmDeals.length) { showToast('Keine Leads geladen', 'error'); return; }

            const now = new Date();
            const startOfWeek = d => { const dd = new Date(d); dd.setHours(0,0,0,0); dd.setDate(dd.getDate() - dd.getDay() + 1); return dd; };
            const thisWeekStart = startOfWeek(now);
            const lastWeekStart = new Date(thisWeekStart); lastWeekStart.setDate(lastWeekStart.getDate() - 7);
            const twoWeeksStart = new Date(thisWeekStart); twoWeeksStart.setDate(twoWeeksStart.getDate() - 14);

            // Active deals (not won/lost)
            const active = crmDeals.filter(d => d.stage !== 'won' && d.stage !== 'lost');

            const groups = [
                { label: '🟢 Diese Woche', color: '#34d399', deals: [] },
                { label: '🟡 Letzte Woche', color: '#fbbf24', deals: [] },
                { label: '🟠 Vor 2 Wochen', color: '#f97316', deals: [] },
                { label: '⚪ Älter', color: 'rgba(255,255,255,0.3)', deals: [] }
            ];

            active.forEach(d => {
                const created = d.created_at ? new Date(d.created_at) : new Date(0);
                if (created >= thisWeekStart) groups[0].deals.push(d);
                else if (created >= lastWeekStart) groups[1].deals.push(d);
                else if (created >= twoWeeksStart) groups[2].deals.push(d);
                else groups[3].deals.push(d);
            });

            const stageMap = Object.fromEntries((typeof CRM_STAGES !== 'undefined' ? CRM_STAGES : []).map(s => [s.id, s]));

            const renderGroup = (g) => {
                if (!g.deals.length) return '';
                const sorted = g.deals.sort((a,b) => new Date(b.created_at||0) - new Date(a.created_at||0));
                const rows = sorted.map(d => {
                    const s = stageMap[d.stage] || {};
                    const val = d.value ? new Intl.NumberFormat('de-CH').format(d.value) + ' CHF' : '';
                    const date = d.created_at ? new Date(d.created_at).toLocaleDateString('de-CH', {day:'2-digit', month:'2-digit'}) : '';
                    const owner = (d.owner||'').replace('OWN-','');
                    return `<div onclick="crmOpenDeal('${d.id}');document.getElementById('crmTimelineModal')?.remove()" style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--navy-card);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:border-color 0.15s" onmouseover="this.style.borderColor='rgba(255,255,255,0.15)'" onmouseout="this.style.borderColor='var(--border)'">
                        <div style="width:6px;height:6px;border-radius:50%;background:${s.color||'#94a3b8'};flex-shrink:0"></div>
                        <div style="flex:1;min-width:0">
                            <div style="font-size:13px;font-weight:500;color:white;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d.title||'–'}</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.3)">${d.company_name||''} ${d.contact_name ? '· '+d.contact_name : ''}</div>
                        </div>
                        <div style="text-align:right;flex-shrink:0">
                            <span style="font-size:10px;padding:2px 6px;border-radius:6px;background:${s.color||'#94a3b8'}15;color:${s.color||'#94a3b8'};border:1px solid ${s.color||'#94a3b8'}25">${s.icon||''} ${s.label||d.stage}</span>
                            ${val ? `<div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">${val}</div>` : ''}
                        </div>
                        <div style="font-size:10px;color:rgba(255,255,255,0.2);flex-shrink:0;min-width:36px;text-align:right">${date}<br>${owner ? `<span style="font-size:9px">${owner}</span>` : ''}</div>
                    </div>`;
                }).join('');
                return `<div style="margin-bottom:20px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                        <div style="font-size:13px;font-weight:600;color:${g.color}">${g.label}</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.3)">${g.deals.length} Lead${g.deals.length!==1?'s':''}</div>
                        <div style="flex:1;height:1px;background:rgba(255,255,255,0.04)"></div>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:6px">${rows}</div>
                </div>`;
            };

            const totalActive = active.length;
            const modal = document.createElement('div');
            modal.id = 'crmTimelineModal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            modal.innerHTML = `<div style="background:var(--navy-mid);border:1px solid var(--border);border-radius:16px;width:100%;max-width:640px;max-height:85vh;display:flex;flex-direction:column;overflow:hidden">
                <div style="display:flex;align-items:center;gap:12px;padding:20px 24px 16px;border-bottom:1px solid var(--border)">
                    <div style="font-size:22px;font-weight:700;color:white;flex:1">📊 ${totalActive} Aktive Leads</div>
                    <div style="display:flex;gap:12px;font-size:11px;color:rgba(255,255,255,0.3)">
                        <span style="color:#34d399">● ${groups[0].deals.length} diese Woche</span>
                        <span style="color:#fbbf24">● ${groups[1].deals.length} letzte Woche</span>
                        <span style="color:#f97316">● ${groups[2].deals.length} vor 2 Wo.</span>
                    </div>
                    <span onclick="this.closest('#crmTimelineModal').remove()" style="cursor:pointer;color:rgba(255,255,255,0.3);font-size:20px;padding:4px">✕</span>
                </div>
                <div style="flex:1;overflow-y:auto;padding:20px 24px">
                    ${groups.map(g => renderGroup(g)).join('')}
                    ${!active.length ? '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.3)">Keine aktiven Leads</div>' : ''}
                </div>
            </div>`;
            document.body.appendChild(modal);
        }

        function crmSetView(v) {
            crmView = v;
            document.getElementById('crmViewKanban').classList.toggle('active', v === 'kanban');
            document.getElementById('crmViewTable').classList.toggle('active', v === 'table');
            document.getElementById('crmKanban').style.display = v === 'kanban' ? 'flex' : 'none';
            document.getElementById('crmTable').style.display = v === 'table' ? 'block' : 'none';
            crmRenderView();
        }

        function crmRenderView() {
            // Show/hide filter banner
            const banner = document.getElementById('crmFilterBanner');
            if (banner) banner.style.display = crmCompanyFilter ? 'flex' : 'none';
            if (crmView === 'kanban') crmRenderKanban(); else crmRenderTable();
        }

        let crmSearchTerm = '';
        function crmSearchFilter(val) { crmSearchTerm = val.toLowerCase().trim(); crmRenderView(); }

        function crmGetFilteredDeals() {
            let deals = crmDeals;
            if (crmCompanyFilter) deals = deals.filter(d => d.company_id === crmCompanyFilter || d.company === crmCompanyFilter);
            if (crmSearchTerm) deals = deals.filter(d => {
                const hay = [d.title, d.company_name, d.contact_name, d.opportunity, d.next_action, d.owner, d.notes, d.id, d.lead_code].filter(Boolean).join(' ').toLowerCase();
                return hay.includes(crmSearchTerm);
            });
            return deals;
        }

        function crmClearFilter() { crmCompanyFilter = null; crmRenderView(); }

        function crmRenderKanban() {
            const container = document.getElementById('crmKanban');
            const deals = crmGetFilteredDeals();
            container.innerHTML = CRM_PIPELINE.map(stageId => {
                const stage = CRM_STAGES.find(s => s.id === stageId);
                const stageDeals = deals.filter(d => d.stage === stageId);
                const stageValue = stageDeals.reduce((s, d) => s + (d.value || 0), 0);
                return `<div class="crm-col" data-stage="${stageId}" ondragover="event.preventDefault();this.style.background='rgba(139,170,255,0.05)'" ondragleave="this.style.background=''" ondrop="crmDrop(event,'${stageId}');this.style.background=''">
                    <div style="padding:10px 12px;border-bottom:2px solid ${stage.color};display:flex;align-items:center;gap:6px">
                        <span style="font-size:11px">${stage.icon}</span>
                        <span style="font-size:12px;font-weight:600;color:white;flex:1">${stage.label}</span>
                        <span style="font-size:11px;color:rgba(255,255,255,0.3)">${stageDeals.length}</span>
                    </div>
                    <div style="padding:6px;flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:5px;max-height:60vh">
                        ${stageDeals.length === 0 ? '<div style="text-align:center;padding:16px;font-size:11px;color:rgba(255,255,255,0.15)">–</div>' :
                        stageDeals.map(d => crmRenderCard(d, stage.color)).join('')}
                    </div>
                </div>`;
            }).join('');
            const other = crmDeals.filter(d => !CRM_PIPELINE.includes(d.stage));
            if (other.length) {
                container.innerHTML += `<div style="min-width:80px;background:rgba(255,255,255,0.02);border-radius:10px;border:1px solid rgba(255,255,255,0.04)"><div style="padding:10px;text-align:center"><div style="font-size:11px;color:rgba(255,255,255,0.2)">Archiv</div><div style="font-size:16px;color:rgba(255,255,255,0.3)">${other.length}</div></div></div>`;
            }
        }

        function crmRenderCard(d, stageColor) {
            const val = d.value ? new Intl.NumberFormat('de-CH').format(d.value) : '';
            const owner = d.owner ? d.owner.replace('OWN-','') : '';
            const hot = d.notes && d.notes.includes('🔥') ? '🔥' : '';
            return `<div class="crm-card" draggable="true" ondragstart="event.dataTransfer.setData('text/plain','${d.id}')" onclick="crmOpenDeal('${d.id}')">
                <div style="display:flex;align-items:center;gap:4px">
                    <div style="font-size:12px;font-weight:600;color:white;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1">${d.title||'–'} ${hot}</div>
                </div>
                ${d.lead_code ? `<div style="font-size:9px;color:var(--accent);opacity:0.7;margin-top:1px;font-family:monospace">${d.lead_code}</div>` : ''}
                <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:1px">${d.company_name||''}</div>
                ${d.contact_name ? `<div style="font-size:10px;color:rgba(255,255,255,0.25);margin-top:3px">👤 ${d.contact_name}</div>` : ''}
                ${d.next_action ? `<div style="font-size:10px;color:rgba(251,191,36,0.8);margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">→ ${d.next_action}</div>` : ''}
                <div style="display:flex;align-items:center;gap:4px;margin-top:4px">
                    ${val ? `<span style="font-size:10px;font-weight:600;color:${stageColor}">${val} CHF</span>` : ''}
                    <span style="flex:1"></span>
                    ${owner ? `<span style="font-size:9px;padding:1px 5px;border-radius:6px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.3)">${owner}</span>` : ''}
                </div>
            </div>`;
        }

        async function crmDrop(event, newStage) {
            event.preventDefault();
            const dealId = event.dataTransfer.getData('text/plain');
            if (!dealId) return;
            try {
                await fetch(`${API}/crm/deals/${dealId}`, { method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' }, body: JSON.stringify({ stage: newStage }) });
                crmLoad(); showToast('Stage aktualisiert', 'success');
            } catch(e) { showToast('Fehler', 'error'); }
        }

        function crmRenderTable() {
            const deals = crmGetFilteredDeals();
            if (!deals.length) { document.getElementById('crmTable').innerHTML = `<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">${crmSearchTerm ? 'Keine Leads für «' + crmSearchTerm + '» gefunden.' : crmCompanyFilter ? 'Keine Leads für diese Firma.' : 'Keine Leads. Klicke «Synchronisieren» um Leads zu importieren.'} ${crmCompanyFilter || crmSearchTerm ? '<br><a style="color:var(--accent);cursor:pointer" onclick="crmClearFilter();document.getElementById(\'crmSearchInput\').value=\'\';crmSearchTerm=\'\';">Filter aufheben</a>' : ''}</div>`; return; }
            const stageMap = Object.fromEntries(CRM_STAGES.map(s => [s.id, s]));
            const rows = deals.map(d => {
                const s = stageMap[d.stage] || {};
                const date = d.created_at ? new Date(d.created_at).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',year:'2-digit'}) : '';
                const val = d.value ? new Intl.NumberFormat('de-CH').format(d.value) + ' CHF' : '–';
                const owner = (d.owner||'').replace('OWN-','');
                return `<tr style="border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer" onclick="crmOpenDeal('${d.id}')"><td style="padding:8px 10px;font-weight:500;color:white;font-size:13px">${d.title||'–'}</td><td style="padding:8px 10px;color:var(--accent);font-size:11px;font-family:monospace;opacity:0.7">${d.lead_code||'–'}</td><td style="padding:8px 10px;color:rgba(255,255,255,0.5);font-size:12px">${d.company_name||'–'}</td><td style="padding:8px 10px"><span style="font-size:10px;padding:2px 8px;border-radius:10px;background:${s.color||'#94a3b8'}22;color:${s.color||'#94a3b8'};border:1px solid ${s.color||'#94a3b8'}33">${s.icon||''} ${s.label||d.stage}</span></td><td style="padding:8px 10px;color:rgba(255,255,255,0.5);font-size:12px">${val}</td><td style="padding:8px 10px;color:rgba(255,255,255,0.25);font-size:11px">${owner}</td><td style="padding:8px 10px;color:rgba(255,255,255,0.25);font-size:11px">${date}</td></tr>`;
            }).join('');
            document.getElementById('crmTable').innerHTML = `<table style="width:100%;border-collapse:collapse"><thead><tr style="border-bottom:1px solid rgba(255,255,255,0.08)"><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Lead</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Code</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Firma</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Stage</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Wert</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Owner</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Erstellt</th></tr></thead><tbody>${rows}</tbody></table>`;
        }

        async function crmShowDealForm() { const f=document.getElementById('crmDealForm'); f.style.display=f.style.display==='none'?'block':'none'; }

        async function crmSaveDeal() {
            const title = document.getElementById('crmDealTitle').value.trim();
            const company = document.getElementById('crmDealCompany').value.trim();
            if (!title && !company) { showToast('Bitte Lead-Titel oder Firma', 'error'); return; }
            try {
                await fetch(`${API}/crm/deals`, { method: 'POST', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: title||company, company_name: company, contact_name: document.getElementById('crmDealContact').value.trim(), contact_email: document.getElementById('crmDealEmail').value.trim(), value: parseFloat(document.getElementById('crmDealValue').value)||0, stage: document.getElementById('crmDealStage').value, source: document.getElementById('crmDealSource').value.trim(), next_action: document.getElementById('crmDealNextAction').value.trim(), notes: document.getElementById('crmDealNotes').value.trim() })
                });
                showToast('Lead erstellt ✓', 'success');
                document.getElementById('crmDealForm').style.display = 'none';
                ['crmDealTitle','crmDealCompany','crmDealContact','crmDealEmail','crmDealValue','crmDealSource','crmDealNextAction','crmDealNotes'].forEach(id => document.getElementById(id).value = '');
                crmLoad();
            } catch(e) { showToast('Fehler', 'error'); }
        }

        function crmOpenDeal(id) {
            const deal = crmDeals.find(d => d.id === id);
            if (!deal) return;
            document.getElementById('crmDrawerTitle').textContent = deal.title || '–';
            document.getElementById('crmDrawerCompany').textContent = deal.company_name || '–';
            const stageMap = Object.fromEntries(CRM_STAGES.map(s => [s.id, s]));
            const s = stageMap[deal.stage] || {};
            const val = deal.value ? new Intl.NumberFormat('de-CH').format(deal.value) + ' CHF' : '–';
            const created = deal.created_at ? new Date(deal.created_at).toLocaleDateString('de-CH') : '';
            const owner = (deal.owner||'').replace('OWN-','');
            document.getElementById('crmDrawerContent').innerHTML = `
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap">
                    <span style="font-size:12px;padding:4px 12px;border-radius:12px;background:${s.color||'#94a3b8'}22;color:${s.color||'#94a3b8'};border:1px solid ${s.color||'#94a3b8'}44;font-weight:600">${s.icon||''} ${s.label||deal.stage}</span>
                    <span style="font-size:13px;font-weight:600;color:var(--accent-light)">${val}</span>
                    <span style="font-size:12px;color:rgba(255,255,255,0.3)">${deal.probability||0}%</span>
                    ${owner ? `<span style="font-size:11px;padding:2px 8px;border-radius:8px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.4)">👤 ${owner}</span>` : ''}
                </div>
                <div style="display:flex;gap:3px;margin-bottom:16px;flex-wrap:wrap">
                    ${CRM_STAGES.map(st => `<button onclick="crmChangeStage('${id}','${st.id}')" style="padding:5px 6px;border-radius:6px;border:1px solid ${st.id===deal.stage?st.color:'rgba(255,255,255,0.06)'};background:${st.id===deal.stage?st.color+'22':'transparent'};color:${st.id===deal.stage?'white':'rgba(255,255,255,0.2)'};font-size:9px;cursor:pointer;font-family:inherit">${st.icon} ${st.label}</button>`).join('')}
                </div>
                <div style="border-top:1px solid var(--border);padding-top:12px"><div style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;margin-bottom:8px">Details</div>
                <div style="display:grid;grid-template-columns:80px 1fr;gap:6px;font-size:13px">
                    <span style="color:rgba(255,255,255,0.3)">Firma</span><span style="color:white">${deal.company_name||'–'}</span>
                    <span style="color:rgba(255,255,255,0.3)">Kontakt</span><span style="color:white">${deal.contact_name||'–'}</span>
                    <span style="color:rgba(255,255,255,0.3)">Quelle</span><span style="color:rgba(255,255,255,0.6)">${deal.source||'–'}</span>
                    <span style="color:rgba(255,255,255,0.3)">Owner</span><span style="color:rgba(255,255,255,0.6)">${owner}</span>
                    <span style="color:rgba(255,255,255,0.3)">Erstellt</span><span style="color:rgba(255,255,255,0.6)">${created}</span>
                </div></div>
                ${deal.next_action ? `<div style="margin-top:12px;padding:10px 12px;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-radius:8px"><div style="font-size:10px;color:rgba(251,191,36,0.7);font-weight:600">NÄCHSTE AKTION</div><div style="font-size:13px;color:white;margin-top:2px">${deal.next_action}</div>${deal.next_action_date?`<div style="font-size:11px;color:rgba(251,191,36,0.5);margin-top:2px">📅 ${deal.next_action_date}</div>`:''}</div>` : ''}
                ${deal.notes ? `<div style="margin-top:12px"><div style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;margin-bottom:6px">Notizen</div><div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5;white-space:pre-wrap;max-height:200px;overflow-y:auto">${deal.notes}</div></div>` : ''}
                <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px"><div style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;margin-bottom:8px">Quick-Notiz</div>
                <div style="display:flex;gap:6px"><input class="mb-input" id="crmQuickNote" placeholder="Notiz..." style="flex:1;font-size:13px;padding:8px 12px" onkeydown="if(event.key==='Enter')crmAddNote('${id}')"><button class="mb-btn mb-btn-primary" onclick="crmAddNote('${id}')" style="font-size:12px;padding:6px 12px">+</button></div></div>
                <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px;display:flex;flex-direction:column;gap:8px">
                    ${deal.stage !== 'won' && deal.stage !== 'lost' && deal.stage !== 'churned' ? `
                    <button onclick="crmLeadWon('${id}')" style="width:100%;padding:10px 16px;border-radius:8px;border:none;background:linear-gradient(135deg,rgba(52,211,153,0.15),rgba(42,127,142,0.15));color:#34d399;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s;text-align:left" onmouseenter="this.style.background='linear-gradient(135deg,rgba(52,211,153,0.25),rgba(42,127,142,0.25))'" onmouseleave="this.style.background='linear-gradient(135deg,rgba(52,211,153,0.15),rgba(42,127,142,0.15))'">✅ Lead gewonnen → Projekt eröffnen</button>
                    <button onclick="crmLeadLost('${id}')" style="width:100%;padding:10px 16px;border-radius:8px;border:none;background:rgba(239,68,68,0.08);color:rgba(239,68,68,0.6);font-size:13px;font-weight:500;cursor:pointer;transition:all 0.15s;text-align:left" onmouseenter="this.style.background='rgba(239,68,68,0.15)';this.style.color='#ef4444'" onmouseleave="this.style.background='rgba(239,68,68,0.08)';this.style.color='rgba(239,68,68,0.6)'">❌ Lead verloren → Verlustanalyse</button>
                    ` : deal.stage === 'won' ? `<div style="padding:8px 12px;background:rgba(52,211,153,0.08);border:1px solid rgba(52,211,153,0.2);border-radius:8px;font-size:12px;color:#34d399">✅ Gewonnen – Projekt aktiv</div>` : deal.stage === 'lost' || deal.stage === 'churned' ? `<div style="padding:8px 12px;background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.15);border-radius:8px;font-size:12px;color:rgba(239,68,68,0.6)">❌ Verloren</div>` : ''}
                    <button class="mb-btn mb-btn-back" onclick="crmDeleteDeal('${id}')" style="font-size:11px;padding:5px 12px;color:rgba(248,113,113,0.7)">🗑 Löschen</button>
                </div>`;
            document.getElementById('crmDrawer').style.display = 'block';
        }

        function crmCloseDrawer() { document.getElementById('crmDrawer').style.display = 'none'; }

        async function crmLeadWon(id) {
            const deal = crmDeals.find(d => d.id === id);
            if (!deal) return;
            if (!await bxConfirm(`Lead "${deal.title}" als GEWONNEN markieren und Projekt eröffnen?`, {title:'Lead gewonnen! 🎉', icon:'🏆', confirmText:'Projekt eröffnen'})) return;

            // 1. Move to "won" stage
            try {
                await crmChangeStage(id, 'won');
            } catch(e) {}

            // 2. Add note
            try {
                const r = await fetch(`${API}/crm/deals/${id}`, {
                    method: 'PUT', headers: {...H(), 'Content-Type':'application/json'},
                    body: JSON.stringify({ notes: (deal.notes||'') + `\n\n✅ GEWONNEN – ${new Date().toLocaleDateString('de-CH')} – Projekt wird eröffnet` })
                });
            } catch(e) {}

            // 3. Close drawer, switch to chat, pre-fill project command
            crmCloseDrawer();
            showSection('chat', document.querySelector('[data-section="chat"]'));
            const chatInput = document.getElementById('chatInput');
            const customerCode = (deal.company_code || deal.company_name || '').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,8);
            const owner = (deal.owner||'').replace('OWN-','');
            const value = deal.value ? Math.round(deal.value) : '';
            chatInput.value = `Neues Projekt eröffnen: Kunde=${deal.company_name||customerCode}, Projekt=${deal.title||'Beratung'}, Kategorie=Bezahltes Mandat, Typ=Beratung, Owner=${owner}${value ? ', Budget='+value+' CHF' : ''}, Beschreibung=Aus Lead ${deal.lead_code||id} konvertiert`;
            chatInput.focus();
            showToast('Lead als gewonnen markiert – Projektdetails im Chat vervollständigen', 'success');
        }

        async function crmLeadLost(id) {
            const deal = crmDeals.find(d => d.id === id);
            if (!deal) return;

            // Ask for reason
            const reasons = [
                'Preis zu hoch',
                'Timing / Budget nicht verfügbar',
                'Wettbewerber gewählt',
                'Kein Bedarf mehr',
                'Kein Entscheid gefällt',
                'Interner Champion verloren',
                'Scope passte nicht',
                'Anderer Grund'
            ];
            const reasonHtml = reasons.map((r,i) => `<button onclick="document.getElementById('lossReason').value='${r}';this.parentElement.querySelectorAll('button').forEach(b=>b.style.background='transparent');this.style.background='rgba(239,68,68,0.15)'" style="padding:5px 10px;border-radius:6px;border:1px solid rgba(239,68,68,0.15);background:transparent;color:rgba(239,68,68,0.7);font-size:11px;cursor:pointer;font-family:inherit;transition:all 0.1s">${r}</button>`).join('');

            const modal = document.createElement('div');
            modal.id = 'lossModal';
            modal.style.cssText = 'position:fixed;inset:0;z-index:20000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)';
            modal.onclick = (e) => { if(e.target===modal) modal.remove(); };
            modal.innerHTML = `<div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;max-width:480px;width:92vw;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,0.5)">
                <div style="font-size:15px;font-weight:700;color:white;margin-bottom:4px">❌ Lead verloren: ${deal.title}</div>
                <div style="font-size:12px;color:var(--text-muted);margin-bottom:16px">${deal.company_name||''} · ${deal.lead_code||''}</div>
                <div style="font-size:11px;color:rgba(255,255,255,0.4);text-transform:uppercase;margin-bottom:8px">Verlustgrund</div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">${reasonHtml}</div>
                <input id="lossReason" class="mb-input" placeholder="Grund eingeben oder oben wählen..." style="width:100%;font-size:13px;padding:10px 14px;margin-bottom:12px;box-sizing:border-box">
                <div style="font-size:11px;color:rgba(255,255,255,0.4);text-transform:uppercase;margin-bottom:6px">Was hätten wir besser machen können?</div>
                <textarea id="lossLearning" class="mb-input" placeholder="Learnings für zukünftige Leads..." style="width:100%;font-size:13px;padding:10px 14px;min-height:60px;resize:vertical;box-sizing:border-box"></textarea>
                <div style="display:flex;gap:8px;margin-top:16px;justify-content:flex-end">
                    <button onclick="document.getElementById('lossModal').remove()" style="padding:8px 18px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text-muted);font-size:12px;cursor:pointer">Abbrechen</button>
                    <button onclick="crmSubmitLoss('${id}')" style="padding:8px 18px;border-radius:8px;border:none;background:rgba(239,68,68,0.15);color:#ef4444;font-size:12px;font-weight:600;cursor:pointer">❌ Als verloren markieren</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
        }

        async function crmSubmitLoss(id) {
            const deal = crmDeals.find(d => d.id === id);
            const reason = document.getElementById('lossReason')?.value || 'Nicht angegeben';
            const learning = document.getElementById('lossLearning')?.value || '';
            document.getElementById('lossModal')?.remove();

            // 1. Move to "lost" stage
            try { await crmChangeStage(id, 'lost'); } catch(e) {}

            // 2. Add loss analysis note
            const lossNote = `\n\n❌ VERLOREN – ${new Date().toLocaleDateString('de-CH')}\nGrund: ${reason}${learning ? '\nLearning: ' + learning : ''}`;
            try {
                await fetch(`${API}/crm/deals/${id}`, {
                    method: 'PUT', headers: {...H(), 'Content-Type':'application/json'},
                    body: JSON.stringify({ notes: (deal?.notes||'') + lossNote })
                });
            } catch(e) {}

            // 3. Save loss analysis to KB
            try {
                const content = `VERLUSTANALYSE: ${deal?.title || 'Lead'}\n\nKunde: ${deal?.company_name||'–'}\nLead-Code: ${deal?.lead_code||'–'}\nWert: ${deal?.value ? deal.value + ' CHF' : '–'}\nOwner: ${(deal?.owner||'').replace('OWN-','')}\nPhase bei Verlust: ${deal?.stage||'–'}\nDatum: ${new Date().toLocaleDateString('de-CH')}\n\nVERLUSTGRUND: ${reason}\n\nLEARNINGS: ${learning || 'Keine angegeben'}\n\nIMPLIKATIONEN:\n- Was können wir beim nächsten ähnlichen Lead besser machen?\n- Welche Signale haben wir übersehen?\n- War der Zeitpunkt falsch oder das Angebot?`;
                await fetch(`${API}/text`, {
                    method: 'POST', headers: {...H(), 'Content-Type':'application/json'},
                    body: JSON.stringify({
                        title: `Verlustanalyse: ${deal?.title||'Lead'} (${deal?.company_name||''})`,
                        content: content,
                        category: 'note',
                        language: 'de',
                        tags: ['verlustanalyse', 'crm', deal?.company_name||'', reason].filter(Boolean),
                        database: 'knowledge_base'
                    })
                });
            } catch(e) {}

            crmCloseDrawer();
            loadCrmData();
            showToast(`Lead als verloren markiert – Verlustanalyse gespeichert (Grund: ${reason})`, 'info');
        }

        let crmCompaniesData = [];
        let companiesExpanded = {};
        let companyCategory = 'all';

        function companyGetCategory(c) {
            // Active Projects: strategic/context type with ACTIVE status or has_customer_folder + active relationship
            if ((c.type === 'strategic' || c.type === 'context') && (c.relationship_status === 'ACTIVE' || c.status === 'ACTIVE'))
                return 'active';
            // Past Projects: has customer folder or context data but NOT active
            if (c.has_customer_folder || c.has_context || c.has_profile)
                return 'past';
            // Leads: has any lead activity, contacts, or next_action
            const hasActivity = (c.children?.length > 0) || c.contact_persons > 0 || c.next_action || c.fit_score > 0 || c.hot_lead;
            if (c.type === 'lead' && hasActivity)
                return 'leads';
            // Also leads if status suggests pipeline
            if (['PROSPECT','QUALIFIED','PROPOSAL','NEGOTIATION'].includes((c.status||'').toUpperCase()))
                return 'leads';
            // New / Never worked with
            return 'new';
        }

        function companySetCategory(cat, el) {
            const catLabels = {active:'Aktive Projekte',leads:'Leads',past:'Frühere Projekte',new:'Noch nie gearbeitet'};
            if (companyCategory === cat || cat === 'all') {
                companyCategory = 'all';
                document.querySelectorAll('.comp-card').forEach(c => c.classList.remove('active'));
                document.getElementById('companyFilterBanner').style.display = 'none';
            } else {
                companyCategory = cat;
                document.querySelectorAll('.comp-card').forEach(c => c.classList.remove('active'));
                if (el) el.classList.add('active');
                const banner = document.getElementById('companyFilterBanner');
                banner.style.display = 'flex';
                document.getElementById('companyFilterLabel').textContent = `Filter: ${catLabels[cat] || cat}`;
            }
            crmFilterCompanies();
        }

        function crmShowCompanies() {
            showSection('companies', document.querySelector('[data-section=companies]'));
        }

        // ── Unified Registry Auto-Search (CH: Zefix + DE: Handelsregister.ai) ──
        let _regTimer = null;
        let _regCache = {};
        function registryAutoSearch() {
            const q = document.getElementById('ncName').value.trim();
            const status = document.getElementById('zefixStatus');
            const results = document.getElementById('zefixResults');
            if (q.length < 3) { results.style.display = 'none'; status.textContent = ''; return; }
            clearTimeout(_regTimer);
            status.textContent = '🔍 suche CH+DE…';
            _regTimer = setTimeout(async () => {
                if (_regCache[q]) { registryShowResults(_regCache[q]); return; }
                try {
                    const resp = await fetch(`${API}/registry/search?q=${encodeURIComponent(q)}&limit=8`, { headers: H() });
                    if (!resp.ok) {
                        // Fallback: try Zefix only
                        const zResp = await fetch(`${API}/zefix/search?q=${encodeURIComponent(q)}&limit=8`, { headers: H() });
                        if (zResp.ok) {
                            const zData = await zResp.json();
                            const mapped = (zData.results||[]).map(r => ({...r, _source:'zefix', _country:'CH', _flag:'🇨🇭'}));
                            _regCache[q] = mapped;
                            registryShowResults(mapped);
                        } else { status.textContent = '⚠️ Register offline'; }
                        return;
                    }
                    const data = await resp.json();
                    _regCache[q] = data.results;
                    registryShowResults(data.results);
                } catch(e) { status.textContent = '⚠️ Suchfehler'; }
            }, 400);
        }
        // Backward compat
        function zefixAutoSearch() { registryAutoSearch(); }

        function registryShowResults(items) {
            const results = document.getElementById('zefixResults');
            const status = document.getElementById('zefixStatus');
            if (!items || !items.length) {
                results.style.display = 'none';
                status.textContent = 'Kein Treffer (CH/DE)';
                return;
            }
            const chCount = items.filter(i => i._country === 'CH').length;
            const deCount = items.filter(i => i._country === 'DE').length;
            const parts = [];
            if (chCount) parts.push(`🇨🇭${chCount}`);
            if (deCount) parts.push(`🇩🇪${deCount}`);
            status.textContent = `${items.length} Treffer (${parts.join(' + ')})`;
            results.innerHTML = items.map((z, i) => {
                const flag = z._flag || (z._country === 'DE' ? '🇩🇪' : '🇨🇭');
                const name = z.legal_name || z.name || '';
                const form = z.legal_form || '';
                const loc = z.locality || z.city || '';
                const pc = z.postal_code || z.zip_code || '';
                const uid = z.uid || (z.register_type ? `${z.register_type} ${z.register_number||''}` : '') || '';
                const tagColor = z._country === 'DE' ? '#ffb74d' : '#4dd0e1';
                return `<div onclick="registrySelect(${i})" style="padding:10px 14px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.05);transition:background 0.15s"
                     onmouseover="this.style.background='rgba(77,208,225,0.08)'" onmouseout="this.style.background='transparent'">
                    <div style="font-size:13px;color:white;font-weight:500">${flag} ${name}</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">
                        ${form ? '<span style="color:'+tagColor+'">'+form+'</span> · ' : ''}${loc}${pc ? ' ('+pc+')' : ''}${uid ? ' · '+uid : ''}
                    </div>
                </div>`;
            }).join('');
            results.style.display = 'block';
            results._data = items;
        }
        // Backward compat
        function zefixShowResults(items) { registryShowResults(items); }

        function registrySelect(idx) {
            const results = document.getElementById('zefixResults');
            const z = results._data[idx];
            if (!z) return;
            const isDE = z._country === 'DE';
            const name = z.legal_name || z.name || '';
            // Fill form
            document.getElementById('ncName').value = name;
            // Auto-generate code
            const words = name.replace(/AG$|GmbH$|SA$|Ltd\.?$|SE$|e\.V\.$|eG$/i, '').trim().split(/\s+/);
            let code = words.length > 1 ? words.map(w => w[0]).join('').toUpperCase().slice(0,5) : name.replace(/\s/g,'').slice(0,4).toUpperCase();
            code = code.replace(/[^A-Z]/g, '');
            document.getElementById('ncCode').value = code;
            // Store data for notes
            const parts = [];
            if (isDE) {
                if (z.register_type) parts.push(`${z.register_type} ${z.register_number||''}`);
                if (z.register_court) parts.push(z.register_court);
                const street = z.street ? `${z.street} ${z.house_number||''}`.trim() : '';
                if (street) parts.push(street);
                const loc = z.zip_code || z.city ? [z.zip_code, z.city].filter(Boolean).join(' ') : '';
                if (loc) parts.push(loc);
                if (z.legal_form) parts.push(z.legal_form);
            } else {
                if (z.uid) parts.push('UID: ' + z.uid);
                if (z.street) parts.push(z.street);
                if (z.postal_code || z.locality) parts.push([z.postal_code, z.locality].filter(Boolean).join(' '));
                if (z.legal_form) parts.push(z.legal_form);
            }
            document.getElementById('ncNotes').value = parts.join(' | ');
            results.style.display = 'none';
            const flag = isDE ? '🇩🇪' : '🇨🇭';
            const src = isDE ? 'Handelsregister' : 'Zefix';
            document.getElementById('zefixStatus').innerHTML = `✅ <span style="color:${isDE?'#ffb74d':'#4dd0e1'}">${flag} ${src}-Daten übernommen</span>`;
        }
        // Backward compat
        function zefixSelect(idx) { registrySelect(idx); }

        // Close dropdown on outside click
        document.addEventListener('click', e => {
            const r = document.getElementById('zefixResults');
            if (r && !r.contains(e.target) && e.target.id !== 'ncName') r.style.display = 'none';
        });

        async function zefixEnrichCompany(code, name) {
            showToast('🔍 Suche in CH+DE Registern…', 'info');
            try {
                // Try unified search first
                const resp = await fetch(`${API}/registry/search?q=${encodeURIComponent(name)}&limit=5`, { headers: H() });
                if (!resp.ok) throw new Error('Register nicht erreichbar');
                const data = await resp.json();
                if (!data.results?.length) { showToast('Kein Treffer für ' + name, 'warning'); return; }
                const z = data.results[0];
                const isDE = z._country === 'DE';
                const flag = isDE ? '🇩🇪' : '🇨🇭';
                const parts = [];
                const dName = z.legal_name || z.name || '';
                if (dName) parts.push(`<b>${dName}</b>`);
                if (isDE) {
                    if (z.register_type) parts.push(`${z.register_type} ${z.register_number||''}`);
                    if (z.legal_form) parts.push(z.legal_form);
                    const street = z.street ? `${z.street} ${z.house_number||''}`.trim() : '';
                    if (street) parts.push(street);
                    if (z.zip_code || z.city) parts.push([z.zip_code, z.city].filter(Boolean).join(' '));
                } else {
                    if (z.uid) parts.push(`UID: ${z.uid}`);
                    if (z.legal_form) parts.push(z.legal_form);
                    if (z.street) parts.push(z.street);
                    if (z.postal_code || z.locality) parts.push([z.postal_code, z.locality].filter(Boolean).join(' '));
                }
                const desc = z.description || z.zefix_description || '';
                if (desc) parts.push(`<br><span style="font-size:11px;color:rgba(255,255,255,0.3)">${desc.slice(0,180)}…</span>`);
                showToast(`${flag} ${parts.join(' · ')}`, 'success', 8000);
            } catch(e) { showToast('Register-Fehler: ' + e.message, 'error'); }
        }

        function crmToggleCompanyForm() {
            const f = document.getElementById('crmCompanyForm');
            f.style.display = f.style.display === 'none' ? 'block' : 'none';
        }

        async function crmSaveNewCompany() {
            const name = document.getElementById('ncName').value.trim();
            if (!name) { showToast('Firmenname erforderlich', 'error'); return; }
            const btn = document.getElementById('ncSaveBtn');
            btn.disabled = true; btn.textContent = 'Wird angelegt…';
            try {
                const resp = await fetch(`${API}/crm/companies`, {
                    method: 'POST', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name, code: document.getElementById('ncCode').value.trim(),
                        industry: document.getElementById('ncIndustry').value,
                        country: document.getElementById('ncCountry').value,
                        website: document.getElementById('ncWebsite').value.trim(),
                        fa_owner: document.getElementById('ncOwner').value,
                        notes: document.getElementById('ncNotes').value.trim()
                    })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.detail || 'Fehler');
                showToast(`✅ ${name} angelegt (${data.code}) – GitHub: ${data.github}${data.zefix ? ' · Zefix ✓' : ''}`, 'success');
                document.getElementById('crmCompanyForm').style.display = 'none';
                ['ncName','ncCode','ncWebsite','ncNotes'].forEach(id => document.getElementById(id).value = '');
                crmLoadCompanies();
            } catch(e) { showToast('Fehler: ' + e.message, 'error'); }
            finally { btn.disabled = false; btn.textContent = 'Firma anlegen'; }
        }

        async function crmLoadCompanies() {
            document.getElementById('companiesListView').style.display = '';
            document.getElementById('companiesProfileView').style.display = 'none';
            document.getElementById('crmCompaniesList').innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">Lade Firmendaten aus GitHub…</div>';
            try {
                const resp = await fetch(`${API}/crm/companies/enriched`, { headers: H() });
                crmCompaniesData = resp.ok ? await resp.json() : [];
                // Assign categories + compute counts
                const counts = {active:0, leads:0, past:0, new:0};
                crmCompaniesData.forEach(c => {
                    c._category = companyGetCategory(c);
                    counts[c._category] = (counts[c._category]||0) + 1;
                });
                document.getElementById('catCountActive').textContent = counts.active;
                document.getElementById('catCountLeads').textContent = counts.leads;
                document.getElementById('catCountPast').textContent = counts.past;
                document.getElementById('catCountNew').textContent = counts.new;
                const totalChildren = crmCompaniesData.reduce((s, c) => s + (c.children?.length || 0), 0);
                document.getElementById('crmCompaniesCount').textContent = `${crmCompaniesData.length} Unternehmen · ${totalChildren + crmCompaniesData.length} Einträge · Quelle: GitHub`;
                crmFilterCompanies();
            } catch(e) {
                document.getElementById('crmCompaniesList').innerHTML = '<div style="padding:40px;text-align:center;color:var(--error)">Fehler beim Laden</div>';
            }
        }

        const COUNTRY_FLAGS = {AT:'\u{1F1E6}\u{1F1F9}',CH:'\u{1F1E8}\u{1F1ED}',DE:'\u{1F1E9}\u{1F1EA}',SE:'\u{1F1F8}\u{1F1EA}',UK:'\u{1F1EC}\u{1F1E7}',US:'\u{1F1FA}\u{1F1F8}'};
        const INDUSTRY_LABELS = {finance:'Finanz',insurance:'Versicherung',retail:'Handel',fmcg:'FMCG',construction:'Bau',packaging:'Verpackung',public_sector:'Öffentlich',telecom:'Telekom',media:'Medien',precious_metals:'Edelmetalle',automotive:'Automobil',health:'Gesundheit',transport:'Transport',professional_services:'Services',technology:'Tech',energy:'Energie',ngo:'NGO',pharma_health:'Pharma/Health',manufacturing:'Industrie',creative:'Kreativ',consulting:'Consulting'};

        function crmFilterCompanies() {
            const q = (document.getElementById('crmCompaniesSearch')?.value || '').toLowerCase();
            let filtered = crmCompaniesData;

            // Category filter
            if (companyCategory !== 'all') {
                filtered = filtered.filter(c => c._category === companyCategory);
            }

            // Text search
            if (q) {
                filtered = filtered.filter(c =>
                    (c.name || '').toLowerCase().includes(q) ||
                    (c.industry || '').toLowerCase().includes(q) ||
                    (c.code || '').toLowerCase().includes(q) ||
                    (c.country || '').toLowerCase().includes(q) ||
                    (c.children || []).some(ch => (ch.name||'').toLowerCase().includes(q))
                );
            }

            if (!filtered.length) {
                document.getElementById('crmCompaniesList').innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">Keine Firmen gefunden</div>';
                return;
            }

            const rows = filtered.map(c => {
                const flag = COUNTRY_FLAGS[c.country] || '';
                const indLabel = INDUSTRY_LABELS[c.industry] || c.industry || '';
                const ind = indLabel ? `<span style="font-size:10px;padding:2px 8px;border-radius:8px;background:rgba(42,127,142,0.1);color:#2A7F8E;border:1px solid rgba(42,127,142,0.2)">${indLabel}</span>` : '';
                const type = c.type === 'strategic' ? '<span style="font-size:9px;padding:1px 6px;border-radius:6px;background:rgba(232,163,61,0.1);color:#E8A33D;border:1px solid rgba(232,163,61,0.2)">Strategic</span>' : '';
                const hasFolder = c.has_customer_folder ? '\u{1F4C1}' : '';
                const hasContext = c.has_context ? '\u{1F9E0}' : '';
                const owner = c.fa_owner ? `<span style="font-size:9px;padding:1px 5px;border-radius:6px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.3)">${c.fa_owner}</span>` : '';
                const totalContacts = c.total_contacts || c.contact_persons || 0;
                const contactBadge = totalContacts > 0 ? `<span style="font-size:10px;color:rgba(255,255,255,0.3)">\u{1F464}${totalContacts}</span>` : '';

                // Category indicator
                const catColors = {active:'#34d399',leads:'#fbbf24',past:'rgba(139,170,255,0.5)',new:'rgba(255,255,255,0.15)'};
                const catDot = `<div style="width:8px;height:8px;border-radius:50%;background:${catColors[c._category]||catColors.new};flex-shrink:0" title="${{active:'Aktives Projekt',leads:'Lead',past:'Früheres Projekt',new:'Neu'}[c._category]||''}"></div>`;

                const childCount = (c.children?.length || 0) + 1;
                const isExpanded = companiesExpanded[c.code];
                const expandable = c.children?.length > 0;
                const leadBadge = expandable
                    ? `<span onclick="event.stopPropagation();companyToggle('${c.code}')" style="font-size:11px;padding:3px 10px;border-radius:8px;background:rgba(251,191,36,0.08);color:#fbbf24;border:1px solid rgba(251,191,36,0.15);cursor:pointer;white-space:nowrap">${childCount} Leads ${isExpanded ? '\u25BE' : '\u25B8'}</span>`
                    : '';

                let html = `<div style="display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'" onclick="companyOpenProfile('${c.code}')">
                    ${catDot}
                    <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,rgba(42,127,142,0.15),rgba(27,54,93,0.3));display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#2A7F8E;flex-shrink:0">${flag || (c.name||'?')[0].toUpperCase()}</div>
                    <div style="flex:1;min-width:0">
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="font-weight:600;color:white;font-size:14px">${c.short_name || c.name || '\u2013'}</span>
                            ${hasFolder}${hasContext}
                        </div>
                        <div style="display:flex;gap:6px;align-items:center;margin-top:3px;flex-wrap:wrap">${ind}${type}${contactBadge}${owner}</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;flex-shrink:0">${leadBadge}</div>
                </div>`;

                if (expandable && isExpanded) {
                    html += '<div style="border-bottom:1px solid rgba(255,255,255,0.06)">';
                    c.children.forEach(ch => {
                        const chOwner = ch.fa_owner ? `<span style="font-size:9px;padding:1px 5px;border-radius:6px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.3)">${ch.fa_owner}</span>` : '';
                        const chContacts = ch.contact_persons > 0 ? `<span style="font-size:10px;color:rgba(255,255,255,0.25)">\u{1F464}${ch.contact_persons}</span>` : '';
                        const chNext = ch.next_action ? `<span style="font-size:10px;color:rgba(251,191,36,0.6)">\u2192 ${ch.next_action}</span>` : '';
                        const chStatus = ch.status ? `<span style="font-size:9px;padding:1px 6px;border-radius:6px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.3)">${ch.status}</span>` : '';
                        html += `<div style="display:flex;align-items:center;gap:10px;padding:10px 20px 10px 72px;border-bottom:1px solid rgba(255,255,255,0.02);cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.015)'" onmouseout="this.style.background='transparent'" onclick="event.stopPropagation();companyOpenProfile('${ch.code}')">
                            <div style="width:6px;height:6px;border-radius:50%;background:rgba(42,127,142,0.4);flex-shrink:0"></div>
                            <div style="flex:1;min-width:0">
                                <div style="font-size:12px;font-weight:500;color:rgba(255,255,255,0.7)">${ch.name || ch.code}</div>
                                <div style="display:flex;gap:6px;align-items:center;margin-top:2px;flex-wrap:wrap">${chStatus}${chContacts}${chOwner}${chNext}</div>
                            </div>
                        </div>`;
                    });
                    html += '</div>';
                }
                return html;
            }).join('');
            document.getElementById('crmCompaniesList').innerHTML = rows;
        }

        function companyToggle(code) { companiesExpanded[code] = !companiesExpanded[code]; crmFilterCompanies(); }

        function companyBackToList() {
            document.getElementById('companiesListView').style.display = '';
            document.getElementById('companiesProfileView').style.display = 'none';
        }

        function companyOpenProfile(code) {
            let company = crmCompaniesData.find(x => x.code === code);
            if (!company) {
                for (const p of crmCompaniesData) {
                    const ch = (p.children || []).find(x => x.code === code);
                    if (ch) { company = ch; company._parent = p; break; }
                }
            }
            if (!company) return;

            document.getElementById('companiesListView').style.display = 'none';
            document.getElementById('companiesProfileView').style.display = '';
            document.getElementById('companyProfileName').textContent = company.name || company.code;
            document.getElementById('companyProfileCode').textContent = company.code;
            const catLabels = {active:'Aktives Projekt',leads:'Lead',past:'Früheres Projekt',new:'Noch nie gearbeitet'};
            const catColors = {active:'#34d399',leads:'#fbbf24',past:'rgba(139,170,255,0.6)',new:'rgba(255,255,255,0.25)'};
            const cat = company._category || companyGetCategory(company);
            document.getElementById('companyProfileCatBadge').innerHTML = `<span style="font-size:11px;padding:3px 10px;border-radius:8px;display:inline-flex;align-items:center;gap:5px;background:${catColors[cat]}15;color:${catColors[cat]};border:1px solid ${catColors[cat]}30"><span style="width:6px;height:6px;border-radius:50%;background:${catColors[cat]}"></span>${catLabels[cat]}</span>`;

            const flag = COUNTRY_FLAGS[company.country] || '';
            const indLabel = INDUSTRY_LABELS[company.industry] || company.industry || '';

            let ph = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:24px">';
            // Overview Card
            ph += `<div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:20px">
                <div style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">\u00DCbersicht</div>
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                    <div style="width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,rgba(42,127,142,0.2),rgba(27,54,93,0.4));display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;color:#2A7F8E">${flag || (company.name||'?')[0]}</div>
                    <div>
                        <div style="font-size:18px;font-weight:700;color:white">${company.short_name || company.name}</div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.4)">${company.name}</div>
                    </div>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:6px">
                    ${indLabel ? `<span style="font-size:11px;padding:3px 10px;border-radius:8px;background:rgba(42,127,142,0.1);color:#2A7F8E;border:1px solid rgba(42,127,142,0.2)">${indLabel}</span>` : ''}
                    ${company.type==='strategic'?'<span style="font-size:11px;padding:3px 10px;border-radius:8px;background:rgba(232,163,61,0.1);color:#E8A33D;border:1px solid rgba(232,163,61,0.2)">Strategic</span>':''}
                    ${company.country?`<span style="font-size:11px;padding:3px 10px;border-radius:8px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.4)">${flag} ${company.country}</span>`:''}
                    ${company.segment?`<span style="font-size:11px;padding:3px 10px;border-radius:8px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.4)">${company.segment}</span>`:''}
                </div>
                ${company.website?`<div style="margin-top:12px"><a href="${company.website}" target="_blank" style="font-size:11px;color:var(--accent)">${company.website}</a></div>`:''}
                ${company.notes?`<div style="margin-top:12px;font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5">${company.notes}</div>`:''}
                <button onclick="zefixEnrichCompany('${company.code}','${(company.name||'').replace(/'/g,"\\'")}')" style="margin-top:12px;padding:5px 12px;font-size:11px;background:rgba(77,208,225,0.08);color:#4dd0e1;border:1px solid rgba(77,208,225,0.2);border-radius:8px;cursor:pointer">🔍 Register nachschlagen (🇨🇭/🇩🇪)</button>
            </div>`;

            // Data Card
            ph += `<div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:20px">
                <div style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">Daten & Status</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px"><div style="font-size:10px;color:rgba(255,255,255,0.3)">Owner</div><div style="font-size:14px;font-weight:600;color:white;margin-top:2px">${company.fa_owner||'\u2013'}</div></div>
                    <div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px"><div style="font-size:10px;color:rgba(255,255,255,0.3)">Status</div><div style="font-size:14px;font-weight:600;color:${company.relationship_status==='ACTIVE'?'#34d399':'white'};margin-top:2px">${company.relationship_status||company.status||'\u2013'}</div></div>
                    <div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px"><div style="font-size:10px;color:rgba(255,255,255,0.3)">Kontakte</div><div style="font-size:14px;font-weight:600;color:white;margin-top:2px">${company.contact_persons||0}</div></div>
                    <div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px"><div style="font-size:10px;color:rgba(255,255,255,0.3)">Fit Score</div><div style="font-size:14px;font-weight:600;color:${company.fit_score>70?'#34d399':company.fit_score>40?'#fbbf24':'white'};margin-top:2px">${company.fit_score||'\u2013'}</div></div>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:14px">
                    ${company.has_customer_folder?'<span style="font-size:10px;padding:3px 8px;border-radius:6px;background:rgba(52,211,153,0.08);color:#34d399;border:1px solid rgba(52,211,153,0.15)">\u{1F4C1} Kunden-Ordner</span>':''}
                    ${company.has_context?'<span style="font-size:10px;padding:3px 8px;border-radius:6px;background:rgba(139,170,255,0.08);color:rgba(139,170,255,0.6);border:1px solid rgba(139,170,255,0.15)">\u{1F9E0} Kontextvektoren</span>':''}
                    ${company.ebf_context_vectors?'<span style="font-size:10px;padding:3px 8px;border-radius:6px;background:rgba(139,170,255,0.08);color:rgba(139,170,255,0.6);border:1px solid rgba(139,170,255,0.15)">\u{1F52C} EBF Vectors</span>':''}
                </div>
                ${company.next_action?`<div style="margin-top:14px;padding:10px;background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.1);border-radius:8px"><div style="font-size:10px;color:rgba(251,191,36,0.6)">N\u00E4chste Aktion</div><div style="font-size:12px;color:#fbbf24;margin-top:2px">\u2192 ${company.next_action}</div></div>`:''}
            </div>`;
            ph += '</div>';

            // Children
            if (company.children?.length > 0) {
                ph += `<div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:16px">
                    <div style="padding:14px 20px;border-bottom:1px solid var(--border)"><span style="font-size:13px;font-weight:600;color:white">Abteilungen / Leads (${company.children.length})</span></div>`;
                company.children.forEach(ch => {
                    ph += `<div style="display:flex;align-items:center;gap:10px;padding:12px 20px;border-bottom:1px solid rgba(255,255,255,0.03);cursor:pointer" onclick="companyOpenProfile('${ch.code}')">
                        <div style="width:6px;height:6px;border-radius:50%;background:rgba(42,127,142,0.4);flex-shrink:0"></div>
                        <div style="flex:1"><div style="font-size:13px;color:rgba(255,255,255,0.7)">${ch.name}</div>
                        ${ch.next_action?`<div style="font-size:11px;color:rgba(251,191,36,0.6);margin-top:2px">\u2192 ${ch.next_action}</div>`:''}</div>
                        ${ch.contact_persons>0?`<span style="font-size:10px;color:rgba(255,255,255,0.25)">\u{1F464}${ch.contact_persons}</span>`:''}
                        ${ch.status?`<span style="font-size:10px;padding:2px 8px;border-radius:6px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.3)">${ch.status}</span>`:''}
                    </div>`;
                });
                ph += '</div>';
            }

            // Placeholder
            ph += `<div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px;text-align:center">
                <div style="font-size:14px;color:rgba(255,255,255,0.25);margin-bottom:8px">\u{1F4CA} Detailliertes Unternehmensprofil</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.15)">Finanzdaten, Projekte, EBF-Modelle und Interventionshistorie.<br>Quelle: data/customers/${(company.code||'').toLowerCase()}/</div>
            </div>`;

            document.getElementById('companyProfileContent').innerHTML = ph;
        }


        // ── PROJECT WIZARD ──
        let prjMode = 'schnell';
        let prjStep = 1;
        let prjCompaniesCache = null;

        // ═══ MY PROJECTS (Kundenprojekte — filtered by user) ═══
        let myPrjCache = null;
        let myPrjAllCache = null;
        let myPrjScope = 'mine'; // 'mine' or 'all'

        function myPrjSetScope(scope) {
            myPrjScope = scope;
            document.getElementById('myPrjToggleMine').style.background = scope === 'mine' ? 'var(--accent)' : 'transparent';
            document.getElementById('myPrjToggleMine').style.color = scope === 'mine' ? 'white' : 'rgba(255,255,255,0.4)';
            document.getElementById('myPrjToggleAll').style.background = scope === 'all' ? 'var(--accent)' : 'transparent';
            document.getElementById('myPrjToggleAll').style.color = scope === 'all' ? 'white' : 'rgba(255,255,255,0.4)';
            myPrjRender();
        }

        async function myPrjLoad() {
            const listEl = document.getElementById('myPrjList');
            listEl.innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">Lade deine Projekte…</div>';
            try {
                const resp = await fetch(`${API}/projects`, { headers: H() });
                const allProjects = resp.ok ? await resp.json() : [];
                myPrjAllCache = allProjects;

                // Filter: projects where user is owner, team member, or creator
                const ownerCode = (currentUser.crm_owner_code || '').toUpperCase();
                const userEmail = (currentUser.email || '').toLowerCase();
                const userName = (currentUser.name || '').toLowerCase();

                myPrjCache = allProjects.filter(p => {
                    if (ownerCode && (p.fa_owner || '').toUpperCase() === ownerCode) return true;
                    if (userEmail && (p.created_by || '').toLowerCase() === userEmail) return true;
                    if (Array.isArray(p.fa_team)) {
                        for (const m of p.fa_team) {
                            const mCode = (typeof m === 'string' ? m : m?.code || m?.name || '').toUpperCase();
                            const mEmail = (typeof m === 'object' ? m?.email || '' : '').toLowerCase();
                            if (ownerCode && mCode === ownerCode) return true;
                            if (userEmail && mEmail === userEmail) return true;
                        }
                    }
                    return false;
                });

                // If no owner code and no matches, show all for admins
                if (!ownerCode && !myPrjCache.length && currentUser.admin) {
                    myPrjCache = allProjects;
                }

                // Show "Alle" toggle only for admins or CRM users
                const showAll = currentUser.admin || currentUser.crm_access;
                const allBtn = document.getElementById('myPrjToggleAll');
                if (allBtn) allBtn.style.display = showAll ? '' : 'none';

                myPrjRender();
            } catch(e) {
                console.error('myPrjLoad error:', e);
                listEl.innerHTML = '<div style="padding:40px;text-align:center;color:var(--error)">Fehler beim Laden</div>';
            }
        }

        function myPrjRender() {
            if (!myPrjCache) return;
            const source = myPrjScope === 'all' ? (myPrjAllCache || myPrjCache) : myPrjCache;
            const filterStatus = document.getElementById('myPrjFilter')?.value || 'all';
            const projects = filterStatus === 'all'
                ? source
                : source.filter(p => {
                    if (filterStatus === 'active') return p.status === 'active' || p.status === 'aktiv';
                    return p.status === filterStatus;
                });

            // Subtitle
            const ownerCode = (currentUser.crm_owner_code || '').toUpperCase();
            const subtitle = myPrjScope === 'all'
                ? `${source.length} Projekte gesamt`
                : ownerCode
                    ? `${source.length} Projekte für ${currentUser.name || ownerCode}`
                    : `${source.length} Projekte für ${currentUser.name || currentUser.email}`;
            document.getElementById('myPrjSubtitle').textContent = subtitle;

            // KPIs from source (not filtered)
            const active = source.filter(p => p.status === 'active' || p.status === 'aktiv').length;
            const planning = source.filter(p => p.status === 'planning').length;
            const completed = source.filter(p => p.status === 'completed').length;
            document.getElementById('myPrjActive').textContent = active;
            document.getElementById('myPrjPlanning').textContent = planning;
            document.getElementById('myPrjDone').textContent = completed;
            document.getElementById('myPrjTotal').textContent = source.length;

            if (!projects.length) {
                document.getElementById('myPrjList').innerHTML = `<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">${source.length ? 'Keine Projekte mit diesem Filter.' : myPrjScope === 'all' ? 'Noch keine Projekte vorhanden.' : 'Du hast noch keine Kundenprojekte. Eröffne ein neues Projekt oder lass dich als Teammitglied hinzufügen.'}</div>`;
                return;
            }

            const statusColors = {active:'#34d399',aktiv:'#34d399',planning:'#fbbf24',completed:'rgba(139,170,255,0.5)',on_hold:'rgba(255,255,255,0.2)'};
            const statusLabels = {active:'Aktiv',aktiv:'Aktiv',planning:'Planung',completed:'Abgeschlossen',on_hold:'On Hold'};
            const catIcons = {mandat:'💼', lead:'🎯', probono:'🤝'};
            const catColors = {mandat:'52,211,153', lead:'251,191,36', probono:'139,170,255'};

            const rows = projects.map(p => {
                const sc = statusColors[p.status] || 'rgba(255,255,255,0.2)';
                const sl = statusLabels[p.status] || p.status;
                const cat = p.project_category || '';
                const catIcon = catIcons[cat] || '';
                const catRgb = catColors[cat] || '255,255,255';
                const code = p.project_code || '';
                return `<div style="display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'" onclick="prjCameFrom='myprojects';prjOpenLanding('${p.slug}');showSection('projects')">
                    <div style="width:8px;height:8px;border-radius:50%;background:${sc};flex-shrink:0"></div>
                    <div style="flex:1;min-width:0">
                        <div style="display:flex;align-items:center;gap:8px">
                            ${code ? `<span style="font-size:10px;padding:2px 8px;border-radius:6px;background:rgba(255,255,255,0.06);color:var(--accent-light);font-weight:700;font-family:monospace;letter-spacing:0.5px">${code}</span>` : ''}
                            <span style="font-weight:600;color:white;font-size:14px">${p.name || p.project_code}</span>
                        </div>
                        <div style="display:flex;gap:6px;align-items:center;margin-top:3px;flex-wrap:wrap">
                            <span style="font-size:11px;color:rgba(255,255,255,0.4)">${p.customer_name || ''}</span>
                            ${cat ? `<span style="font-size:9px;padding:2px 6px;border-radius:6px;background:rgba(${catRgb},0.08);color:rgba(${catRgb},0.7);border:1px solid rgba(${catRgb},0.15)">${catIcon} ${cat}</span>` : ''}
                            <span style="font-size:10px;padding:2px 8px;border-radius:8px;background:${sc}15;color:${sc};border:1px solid ${sc}30">${sl}</span>
                        </div>
                    </div>
                    <div style="text-align:right;flex-shrink:0">
                        ${p.start_date ? `<div style="font-size:10px;color:rgba(255,255,255,0.2)">${p.start_date}</div>` : ''}
                    </div>
                </div>`;
            }).join('');
            document.getElementById('myPrjList').innerHTML = rows;
        }

        // ── TASK MANAGEMENT ──────────────────────────────
        let _taskFilter = 'active';
        let _tasksData = [];

        async function loadTasks() {
            const list = document.getElementById('taskList');
            list.innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">Lade Tasks…</div>';
            try {
                // Load stats
                const sr = await fetch(`${API}/tasks/stats`, {headers: H()});
                if (sr.ok) {
                    const stats = await sr.json();
                    document.getElementById('taskOverdue').textContent = stats.overdue || 0;
                    document.getElementById('taskDueToday').textContent = stats.due_today || 0;
                    document.getElementById('taskDueWeek').textContent = stats.due_this_week || 0;
                    document.getElementById('taskActive').textContent = stats.active_total || 0;
                    document.getElementById('taskDone').textContent = (stats.by_status||{}).done || 0;
                    document.getElementById('taskCount').textContent = `${stats.active_total||0} offene Tasks, ${stats.overdue||0} überfällig`;
                    // Color overdue KPI red if > 0
                    if (stats.overdue > 0) document.getElementById('taskOverdue').parentElement.style.borderColor = 'rgba(239,68,68,0.3)';
                }
                // Load tasks based on filter
                let url = `${API}/tasks?limit=100`;
                if (_taskFilter === 'active') url += '&status=active';
                else if (_taskFilter === 'done') url += '&status=done';
                else if (['consultant','bdm','beatrix','external'].includes(_taskFilter)) url += `&status=active&assignee_type=${_taskFilter}`;
                const r = await fetch(url, {headers: H()});
                if (!r.ok) throw new Error('Fehler beim Laden');
                const data = await r.json();
                _tasksData = data.tasks || [];
                renderTaskList(_tasksData);
            } catch(e) {
                list.innerHTML = `<div style="padding:40px;text-align:center;color:#ef4444">❌ ${e.message}</div>`;
            }
        }

        function filterTasks(filter, el) {
            _taskFilter = filter;
            document.querySelectorAll('.task-filter').forEach(b => b.classList.remove('active'));
            if (el) el.classList.add('active');
            loadTasks();
        }

        function renderTaskList(tasks) {
            const list = document.getElementById('taskList');
            if (!tasks.length) {
                list.innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">Keine Tasks gefunden</div>';
                return;
            }
            const typeIcons = {consultant:'👤', bdm:'🏢', beatrix:'🤖', external:'🔄'};
            const typeLabels = {consultant:'Berater', bdm:'BDM', beatrix:'BEATRIX', external:'Extern'};
            const priColors = {urgent:'#ef4444', high:'#fbbf24', normal:'rgba(255,255,255,0.15)', low:'rgba(255,255,255,0.06)'};
            const today = new Date().toISOString().slice(0,10);

            list.innerHTML = tasks.map(t => {
                const isDone = t.status === 'done';
                const isOverdue = t.due_date && t.due_date < today && !isDone;
                const isToday = t.due_date === today;
                const dueColor = isOverdue ? '#ef4444' : isToday ? '#fbbf24' : 'rgba(255,255,255,0.3)';
                const dueLabel = isOverdue ? '⚠ Überfällig' : isToday ? 'Heute' : (t.due_date || '');

                return `<div class="task-row ${isDone?'done':''} task-pri-${t.priority||'normal'}">
                    <div class="task-check ${isDone?'checked':''}" onclick="toggleTask('${t.id}',${isDone})" title="${isDone?'Wieder öffnen':'Erledigen'}">
                        ${isDone ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                    </div>
                    <div style="flex:1;min-width:0">
                        <div style="font-size:13px;color:${isDone?'rgba(255,255,255,0.3)':'white'};font-weight:${isDone?'400':'500'};${isDone?'text-decoration:line-through':''}">
                            ${t.title}
                        </div>
                        <div style="display:flex;gap:8px;margin-top:4px;flex-wrap:wrap;align-items:center">
                            <span style="font-size:10px;padding:1px 6px;background:rgba(42,127,142,0.1);border:1px solid rgba(42,127,142,0.2);border-radius:6px;color:rgba(42,127,142,0.7)">${typeIcons[t.assignee_type]||'?'} ${t.assignee||typeLabels[t.assignee_type]||''}</span>
                            ${t.customer_code ? `<span style="font-size:10px;color:rgba(255,255,255,0.25)">${t.customer_code.toUpperCase()}</span>` : ''}
                            ${t.project_slug ? `<span style="font-size:10px;color:rgba(139,170,255,0.4)">${t.project_slug}</span>` : ''}
                            ${t.category ? `<span style="font-size:10px;color:rgba(255,255,255,0.2)">${t.category}</span>` : ''}
                            ${t.source === 'auto' ? `<span style="font-size:9px;color:rgba(52,211,153,0.4)">⚡auto</span>` : ''}
                        </div>
                    </div>
                    <div style="text-align:right;flex-shrink:0">
                        ${t.due_date ? `<div style="font-size:11px;color:${dueColor};font-weight:${isOverdue?'600':'400'}">${dueLabel}</div>` : ''}
                        ${t.priority && t.priority !== 'normal' ? `<div style="font-size:10px;color:${priColors[t.priority]||'white'};margin-top:2px">${t.priority === 'urgent' ? '🔴' : t.priority === 'high' ? '●' : '○'}</div>` : ''}
                    </div>
                    <div style="flex-shrink:0;cursor:pointer;padding:4px;color:rgba(255,255,255,0.15)" onclick="deleteTask('${t.id}')" title="Löschen">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </div>
                </div>`;
            }).join('');
        }

        async function toggleTask(taskId, isDone) {
            try {
                const endpoint = isDone ? `${API}/tasks/${taskId}/reopen` : `${API}/tasks/${taskId}/complete`;
                await fetch(endpoint, {method:'POST', headers:H()});
                loadTasks();
            } catch(e) { showToast('Fehler: ' + e.message, 'error'); }
        }

        async function deleteTask(taskId) {
            if (!await bxConfirm('Task wirklich löschen?', {title:'Task löschen', icon:'🗑️', confirmText:'Löschen', danger:true})) return;
            try {
                await fetch(`${API}/tasks/${taskId}`, {method:'DELETE', headers:H()});
                loadTasks();
                showToast('Task gelöscht', 'success');
            } catch(e) { showToast('Fehler: ' + e.message, 'error'); }
        }

        function showNewTaskModal() {
            const modal = document.createElement('div');
            modal.id = 'taskModal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px';
            const fld = 'width:100%;padding:10px 12px;background:var(--navy-mid);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;outline:none';
            const lbl = 'font-size:11px;font-weight:600;color:rgba(255,255,255,0.4);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.3px';
            modal.innerHTML = `<div style="background:var(--navy-card);border:1px solid var(--border);border-radius:16px;padding:24px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                    <h3 style="margin:0;color:white;font-size:18px">✅ Neue Aufgabe</h3>
                    <span style="cursor:pointer;color:rgba(255,255,255,0.3);font-size:20px" onclick="document.getElementById('taskModal').remove()">✕</span>
                </div>
                <div style="display:flex;flex-direction:column;gap:14px">
                    <div><div style="${lbl}">Titel *</div><input id="ntTitle" style="${fld}" placeholder="Was muss erledigt werden?"></div>
                    <div><div style="${lbl}">Beschreibung</div><textarea id="ntDesc" style="${fld};min-height:60px;resize:vertical" placeholder="Details..."></textarea></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <div><div style="${lbl}">Typ</div><select id="ntType" style="${fld}" onchange="ntTypeChanged()">
                            <option value="consultant">👤 Berater</option>
                            <option value="bdm">🏢 BDM-Team</option>
                            <option value="beatrix">🤖 BEATRIX</option>
                            <option value="external">🔄 Extern</option>
                        </select></div>
                        <div><div style="${lbl}">Zugewiesen an</div><input id="ntAssignee" style="${fld}" placeholder="GF, AF, BDM, ..."></div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <div><div style="${lbl}">Fällig am</div><input id="ntDue" type="date" style="${fld}"></div>
                        <div><div style="${lbl}">Priorität</div><select id="ntPri" style="${fld}">
                            <option value="normal">◐ Normal</option>
                            <option value="low">○ Niedrig</option>
                            <option value="high">● Hoch</option>
                            <option value="urgent">🔴 Dringend</option>
                        </select></div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <div><div style="${lbl}">Kunde (Code)</div><input id="ntCustomer" style="${fld}" placeholder="z.B. alpla, lukb"></div>
                        <div><div style="${lbl}">Projekt (Slug)</div><input id="ntProject" style="${fld}" placeholder="z.B. alp005-workshop"></div>
                    </div>
                    <div id="ntCategoryRow"><div style="${lbl}">Kategorie</div><select id="ntCategory" style="${fld}">
                        <option value="">—</option>
                        <option value="sales">Sales</option><option value="delivery">Delivery</option>
                        <option value="vertrag">Vertrag</option><option value="rechnung">Rechnung</option>
                        <option value="reise">Reise</option><option value="termin">Termin</option>
                        <option value="dokument">Dokument</option><option value="zugang">Zugang</option>
                        <option value="offerte">Offerte</option><option value="data">Daten</option>
                        <option value="allgemein">Allgemein</option>
                    </select></div>
                    <div id="ntEscRow" style="display:none"><div style="${lbl}">Eskalation nach X Tagen</div><input id="ntEsc" type="number" style="${fld}" placeholder="z.B. 7"></div>
                    <button onclick="createTaskFromModal()" style="width:100%;padding:12px;background:linear-gradient(135deg,var(--accent),#2A7F8E);border:none;border-radius:10px;color:white;font-size:14px;font-weight:700;cursor:pointer;margin-top:8px">✓ Task erstellen</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
            document.getElementById('ntTitle').focus();
        }

        function ntTypeChanged() {
            const t = document.getElementById('ntType').value;
            document.getElementById('ntEscRow').style.display = t === 'external' ? '' : 'none';
            const a = document.getElementById('ntAssignee');
            if (t === 'bdm') a.value = 'BDM';
            else if (t === 'beatrix') a.value = 'system';
            else if (t === 'consultant') a.value = '';
            else a.value = '';
        }

        async function createTaskFromModal() {
            const title = document.getElementById('ntTitle').value.trim();
            if (!title) { showToast('Titel eingeben', 'error'); return; }
            try {
                const payload = {
                    title,
                    description: document.getElementById('ntDesc').value.trim(),
                    assignee_type: document.getElementById('ntType').value,
                    assignee: document.getElementById('ntAssignee').value.trim(),
                    due_date: document.getElementById('ntDue').value || null,
                    priority: document.getElementById('ntPri').value,
                    customer_code: document.getElementById('ntCustomer').value.trim() || null,
                    project_slug: document.getElementById('ntProject').value.trim() || null,
                    category: document.getElementById('ntCategory').value || null,
                    escalation_after_days: document.getElementById('ntEsc').value ? parseInt(document.getElementById('ntEsc').value) : null,
                    source: 'manual'
                };
                const r = await fetch(`${API}/tasks`, {method:'POST', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify(payload)});
                if (!r.ok) throw new Error('Fehler');
                document.getElementById('taskModal').remove();
                showToast('✓ Task erstellt', 'success');
                loadTasks();
            } catch(e) { showToast('Fehler: ' + e.message, 'error'); }
        }

        async function prjLoad() {
            document.getElementById('prjListView').style.display = '';
            document.getElementById('prjWizardView').style.display = 'none';
            document.getElementById('prjList').innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">Lade Projekte aus GitHub…</div>';
            try {
                const resp = await fetch(`${API}/projects`, { headers: H() });
                const projects = resp.ok ? await resp.json() : [];
                const active = projects.filter(p => p.status === 'active' || p.status === 'aktiv').length;
                const planning = projects.filter(p => p.status === 'planning').length;
                const completed = projects.filter(p => p.status === 'completed').length;
                document.getElementById('prjCountActive').textContent = active;
                document.getElementById('prjCountPlanning').textContent = planning;
                document.getElementById('prjCountCompleted').textContent = completed;
                document.getElementById('prjCountTotal').textContent = projects.length;
                document.getElementById('prjCount').textContent = `${projects.length} Projekte · Quelle: GitHub data/projects/`;

                if (!projects.length) {
                    document.getElementById('prjList').innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">Noch keine Projekte. Klicke „+ Neues Projekt" um zu starten.</div>';
                    return;
                }

                const statusColors = {active:'#34d399',aktiv:'#34d399',planning:'#fbbf24',completed:'rgba(139,170,255,0.5)',on_hold:'rgba(255,255,255,0.2)'};
                const statusLabels = {active:'Aktiv',aktiv:'Aktiv',planning:'Planung',completed:'Abgeschlossen',on_hold:'On Hold'};
                const typeLabels = {beratung:'Beratung',workshop:'Workshop',studie:'Studie',intervention:'Intervention',keynote:'Keynote',training:'Training',retainer:'Retainer'};
                const catIcons = {mandat:'💼', lead:'🎯', probono:'🤝'};
                const catColors = {mandat:'52,211,153', lead:'251,191,36', probono:'139,170,255'};

                const rows = projects.map(p => {
                    const sc = statusColors[p.status] || 'rgba(255,255,255,0.2)';
                    const sl = statusLabels[p.status] || p.status;
                    const tl = typeLabels[p.type] || p.type || '';
                    const cat = p.project_category || '';
                    const catIcon = catIcons[cat] || '';
                    const catRgb = catColors[cat] || '255,255,255';
                    const code = p.project_code || '';
                    return `<div style="display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'" onclick="prjCameFrom='projects';prjOpenLanding('${p.slug}')">
                        <div style="width:8px;height:8px;border-radius:50%;background:${sc};flex-shrink:0"></div>
                        <div style="flex:1;min-width:0">
                            <div style="display:flex;align-items:center;gap:8px">
                                ${code ? `<span style="font-size:10px;padding:2px 8px;border-radius:6px;background:rgba(255,255,255,0.06);color:var(--accent-light);font-weight:700;font-family:monospace;letter-spacing:0.5px">${code}</span>` : ''}
                                <span style="font-weight:600;color:white;font-size:14px">${p.name || p.project_code}</span>
                            </div>
                            <div style="display:flex;gap:6px;align-items:center;margin-top:3px;flex-wrap:wrap">
                                <span style="font-size:11px;color:rgba(255,255,255,0.4)">${p.customer_name || ''}</span>
                                ${cat ? `<span style="font-size:9px;padding:2px 6px;border-radius:6px;background:rgba(${catRgb},0.08);color:rgba(${catRgb},0.7);border:1px solid rgba(${catRgb},0.15)">${catIcon} ${cat}</span>` : ''}
                                ${tl ? `<span style="font-size:10px;padding:2px 8px;border-radius:8px;background:rgba(42,127,142,0.1);color:#2A7F8E;border:1px solid rgba(42,127,142,0.2)">${tl}</span>` : ''}
                                <span style="font-size:10px;padding:2px 8px;border-radius:8px;background:${sc}15;color:${sc};border:1px solid ${sc}30">${sl}</span>
                            </div>
                        </div>
                        <div style="text-align:right;flex-shrink:0">
                            ${p.fa_owner ? `<span style="font-size:10px;padding:2px 6px;border-radius:6px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.3)">${p.fa_owner}</span>` : ''}
                            ${p.start_date ? `<div style="font-size:10px;color:rgba(255,255,255,0.2);margin-top:2px">${p.start_date}</div>` : ''}
                        </div>
                    </div>`;
                }).join('');
                document.getElementById('prjList').innerHTML = rows;
            } catch(e) {
                document.getElementById('prjList').innerHTML = '<div style="padding:40px;text-align:center;color:var(--error)">Fehler beim Laden</div>';
            }
        }

        async function prjEnsureCompanies() {
            if (prjCompaniesCache) return prjCompaniesCache;
            try {
                const resp = await fetch(`${API}/crm/companies/enriched`, { headers: H() });
                prjCompaniesCache = resp.ok ? await resp.json() : [];
            } catch(e) { prjCompaniesCache = []; }
            return prjCompaniesCache;
        }

        async function prjStartWizard() {
            document.getElementById('prjListView').style.display = 'none';
            document.getElementById('prjWizardView').style.display = '';
            const companies = await prjEnsureCompanies();
            // Populate firma dropdowns
            const opts = companies.map(c => `<option value="${c.code}">${c.short_name || c.name} (${c.code})</option>`).join('');
            document.getElementById('prjFirma').innerHTML = '<option value="">Firma auswählen…</option>' + opts;
            document.getElementById('prjSchnellFirma').innerHTML = '<option value="">Firma auswählen…</option>' + opts;
            // Set today as default start
            document.getElementById('prjStart').value = new Date().toISOString().slice(0,10);
            prjSetMode(prjMode);
        }

        function prjCancelWizard() {
            document.getElementById('prjListView').style.display = '';
            document.getElementById('prjWizardView').style.display = 'none';
        }

        function prjSetMode(mode) {
            prjMode = mode;
            document.querySelectorAll('.prj-mode-card').forEach(c => {
                c.classList.toggle('active', c.dataset.mode === mode);
                c.style.borderColor = c.dataset.mode === mode ? 'rgba(42,127,142,0.5)' : '';
                c.style.background = c.dataset.mode === mode ? 'rgba(42,127,142,0.08)' : 'var(--navy-card)';
            });
            document.getElementById('prjSchnellPanel').style.display = mode === 'schnell' ? '' : 'none';
            document.getElementById('prjProgress').style.display = mode === 'gefuehrt' ? '' : 'none';
            document.querySelectorAll('.prj-step').forEach(s => s.style.display = 'none');
            if (mode === 'gefuehrt') { prjGoStep(1); }
        }

        function prjSelectCategory(el, cat) {
            document.getElementById('prjCategory').value = cat;
            const colors = {mandat:'52,211,153', lead:'251,191,36', probono:'139,170,255'};
            const textColors = {mandat:'#34d399', lead:'#fbbf24', probono:'rgba(139,170,255,0.8)'};
            document.querySelectorAll('#prjCategoryCards .prj-cat-card').forEach(c => {
                const isCat = c.dataset.cat === cat;
                const rgb = colors[c.dataset.cat] || '255,255,255';
                c.style.borderColor = isCat ? `rgba(${rgb},0.3)` : 'var(--border)';
                c.style.background = isCat ? `rgba(${rgb},0.06)` : 'rgba(255,255,255,0.02)';
                c.querySelector('div:nth-child(2)').style.color = isCat ? textColors[c.dataset.cat] : 'rgba(255,255,255,0.5)';
            });
        }

        function prjSchnellCat(el, cat) {
            document.getElementById('prjSchnellCategory').value = cat;
            const colors = {mandat:'52,211,153', lead:'251,191,36', probono:'139,170,255'};
            const textColors = {mandat:'#34d399', lead:'#fbbf24', probono:'rgba(139,170,255,0.8)'};
            document.querySelectorAll('.prj-schnell-cat').forEach(b => {
                const isCat = b.dataset.cat === cat;
                const rgb = colors[b.dataset.cat] || '255,255,255';
                b.style.borderColor = isCat ? `rgba(${rgb},0.3)` : 'var(--border)';
                b.style.background = isCat ? `rgba(${rgb},0.08)` : 'rgba(255,255,255,0.02)';
                b.style.color = isCat ? textColors[b.dataset.cat] : 'rgba(255,255,255,0.4)';
            });
        }

        function prjGoStep(n) {
            prjStep = n;
            document.querySelectorAll('.prj-step').forEach(s => s.style.display = 'none');
            const el = document.getElementById('prjStep' + n);
            if (el) el.style.display = '';
            // Progress bar
            const labels = ['Firma & Lead', 'Projekt', 'Timeline', 'Team', 'Review'];
            let html = '';
            for (let i = 1; i <= 5; i++) {
                const active = i === n;
                const done = i < n;
                const col = done ? '#34d399' : active ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
                html += `<div style="flex:1;height:4px;border-radius:2px;background:${col};transition:background 0.3s"></div>`;
            }
            document.getElementById('prjProgressSteps').innerHTML = html;
            document.getElementById('prjProgressLabel').textContent = `Schritt ${n}/5 · ${labels[n-1]}`;
            // Build review on step 5
            if (n === 5) prjBuildReview();
        }

        function prjOnFirmaChange() {
            const code = document.getElementById('prjFirma').value;
            const infoEl = document.getElementById('prjFirmaInfo');
            const leadSel = document.getElementById('prjLead');
            const btn = document.getElementById('prjStep1Next');

            if (!code) { infoEl.style.display = 'none'; btn.disabled = true; btn.style.opacity = '0.5'; return; }
            btn.disabled = false; btn.style.opacity = '1';

            const c = prjCompaniesCache.find(x => x.code === code);
            if (!c) return;
            infoEl.style.display = '';
            const indLabels = {finance:'Finanz',insurance:'Versicherung',retail:'Handel',fmcg:'FMCG',construction:'Bau',packaging:'Verpackung',public_sector:'Öffentlich',telecom:'Telekom',media:'Medien'};
            infoEl.innerHTML = `<strong>${c.name}</strong> · ${indLabels[c.industry] || c.industry || ''} · ${c.country || ''}<br>
                ${c.fa_owner ? 'Owner: ' + c.fa_owner + ' · ' : ''}Kontakte: ${c.contact_persons || 0}
                ${c.has_customer_folder ? ' · 📁 Kunden-Ordner' : ''}${c.has_context ? ' · 🧠 Kontext' : ''}`;

            // Auto-fill owner in step 4
            if (c.fa_owner) {
                const ownerSel = document.getElementById('prjOwner');
                for (let o of ownerSel.options) { if (o.value === c.fa_owner) { ownerSel.value = c.fa_owner; break; } }
            }

            // Populate leads for this company
            const children = c.children || [];
            const allLeads = [c, ...children];
            let leadOpts = '<option value="">Kein Lead / Neues Projekt</option>';
            allLeads.forEach(l => {
                if (l.code !== c.code || children.length === 0) {
                    leadOpts += `<option value="${l.code}">${l.name}${l.next_action ? ' → ' + l.next_action : ''}</option>`;
                }
            });
            leadSel.innerHTML = leadOpts;

            // Show client contacts in step 4
            const contacts = c.contact_persons > 0 ? `${c.contact_persons} Kontaktpersonen aus GitHub` : 'Keine Kontakte hinterlegt';
            document.getElementById('prjClientContacts').textContent = contacts;
        }

        function prjOnLeadChange() {
            const code = document.getElementById('prjLead').value;
            const infoEl = document.getElementById('prjLeadInfo');
            if (!code) { infoEl.style.display = 'none'; return; }
            // Find lead in companies cache (could be child)
            let lead = null;
            for (const c of prjCompaniesCache) {
                if (c.code === code) { lead = c; break; }
                const ch = (c.children || []).find(x => x.code === code);
                if (ch) { lead = ch; break; }
            }
            if (!lead) { infoEl.style.display = 'none'; return; }
            infoEl.style.display = '';
            infoEl.innerHTML = `<strong>${lead.name}</strong>${lead.status ? ' · Status: ' + lead.status : ''}${lead.fit_score ? ' · Fit: ' + lead.fit_score : ''}
                ${lead.next_action ? '<br>→ ' + lead.next_action : ''}${lead.notes ? '<br>' + lead.notes : ''}`;
            // Auto-fill project name from lead
            if (!document.getElementById('prjName').value && lead.name) {
                document.getElementById('prjName').value = lead.name;
            }
        }

        function prjBuildReview() {
            const firma = document.getElementById('prjFirma');
            const firmaName = firma.options[firma.selectedIndex]?.text || '–';
            const name = document.getElementById('prjName').value || '(kein Name)';
            const type = document.getElementById('prjType');
            const typeName = type.options[type.selectedIndex]?.text || '';
            const category = document.getElementById('prjCategory').value || 'mandat';
            const catLabels = {mandat:'💼 Bezahltes Mandatsprojekt', lead:'🎯 Lead-Projekt (Akquise)', probono:'🤝 Pro-Bono-Projekt'};
            const desc = document.getElementById('prjDesc').value;
            const start = document.getElementById('prjStart').value;
            const end = document.getElementById('prjEnd').value;
            const budget = document.getElementById('prjBudget').value;
            const billing = document.querySelector('input[name="prjBilling"]:checked')?.value || 'fixed';
            const owner = document.getElementById('prjOwner');
            const ownerName = owner.options[owner.selectedIndex]?.text || '';
            const team = document.getElementById('prjTeam').value;

            const slug = (firma.value + '-' + name).toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').slice(0, 50);
            // Preview code format
            const prefix = firma.value.toUpperCase().replace(/-/g,'').slice(0,5);
            const previewCode = `${prefix || '???'}0XX`;

            document.getElementById('prjReviewContent').innerHTML = `
                <div style="display:grid;grid-template-columns:120px 1fr;gap:8px 16px">
                    <div style="color:rgba(255,255,255,0.3)">Projektkürzel</div><div><strong style="color:var(--accent-light);font-size:15px">${previewCode}</strong> <span style="font-size:10px;color:rgba(255,255,255,0.2)">(wird bei Erstellung eindeutig vergeben)</span></div>
                    <div style="color:rgba(255,255,255,0.3)">Kategorie</div><div>${catLabels[category] || category}</div>
                    <div style="color:rgba(255,255,255,0.3)">Firma</div><div><strong>${firmaName}</strong></div>
                    <div style="color:rgba(255,255,255,0.3)">Projekt</div><div><strong>${name}</strong></div>
                    <div style="color:rgba(255,255,255,0.3)">Typ</div><div>${typeName}</div>
                    ${desc ? `<div style="color:rgba(255,255,255,0.3)">Beschreibung</div><div>${desc}</div>` : ''}
                    <div style="color:rgba(255,255,255,0.3)">Timeline</div><div>${start || '?'} → ${end || 'offen'}</div>
                    ${budget ? `<div style="color:rgba(255,255,255,0.3)">Budget</div><div>${Number(budget).toLocaleString('de-CH')} CHF (${billing})</div>` : ''}
                    <div style="color:rgba(255,255,255,0.3)">Owner</div><div>${ownerName}</div>
                    ${team ? `<div style="color:rgba(255,255,255,0.3)">Team</div><div>${team}</div>` : ''}
                </div>
                <div style="margin-top:16px;padding:10px;background:rgba(42,127,142,0.05);border:1px solid rgba(42,127,142,0.1);border-radius:8px;font-size:11px;color:rgba(255,255,255,0.3)">
                    📁 Wird erstellt: <code>data/projects/${slug}/project.yaml</code>
                </div>`;
        }

        // Schnell mode
        function prjSchnellAutoFill() {
            const code = document.getElementById('prjSchnellFirma').value;
            const nameInput = document.getElementById('prjSchnellName');
            const preview = document.getElementById('prjSchnellPreview');
            const btn = document.getElementById('prjSchnellBtn');

            if (!code) { preview.style.display = 'none'; btn.disabled = true; btn.style.opacity = '0.5'; return; }

            const c = prjCompaniesCache.find(x => x.code === code);
            if (!c) return;

            // Smart defaults
            const today = new Date().toISOString().slice(0,10);
            const endDate = new Date(Date.now() + 90*24*60*60*1000).toISOString().slice(0,10);

            preview.style.display = '';
            preview.innerHTML = `<strong>${c.short_name || c.name}</strong> · ${c.industry || ''} · ${c.country || ''}<br>
                Owner: ${c.fa_owner || 'GF'} · Start: ${today} · Ende: ~${endDate}<br>
                Typ: Beratung · Status: planning
                ${c.has_customer_folder ? '<br>📁 Kunden-Ordner vorhanden' : ''}
                ${c.next_action ? '<br>→ ' + c.next_action : ''}`;

            // Enable button when name is filled
            const check = () => {
                const ok = code && nameInput.value.trim();
                btn.disabled = !ok; btn.style.opacity = ok ? '1' : '0.5';
            };
            nameInput.oninput = check;
            check();
        }

        async function prjSchnellCreate() {
            const code = document.getElementById('prjSchnellFirma').value;
            const name = document.getElementById('prjSchnellName').value.trim();
            const category = document.getElementById('prjSchnellCategory').value || 'mandat';
            if (!code || !name) return;

            const c = prjCompaniesCache.find(x => x.code === code);
            const today = new Date().toISOString().slice(0,10);
            const btn = document.getElementById('prjSchnellBtn');
            btn.disabled = true; btn.textContent = 'Erstelle auf GitHub…';

            try {
                const resp = await fetch(`${API}/projects`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_code: code,
                        name: name,
                        type: 'beratung',
                        project_category: category,
                        description: '',
                        start_date: today,
                        end_date: '',
                        budget_chf: null,
                        billing_type: 'fixed',
                        fa_owner: c?.fa_owner || 'GF',
                        fa_team: [],
                        lead_code: ''
                    })
                });
                const result = await resp.json();
                if (resp.ok) {
                    const catIcons = {mandat:'💼', lead:'🎯', probono:'🤝'};
                    showToast(`✓ ${catIcons[category]||''} Projekt "${name}" eröffnet · Kürzel: ${result.project_code}`, 'success');
                    prjCancelWizard();
                    prjLoad();
                } else {
                    showToast(result.error || 'Fehler', 'error');
                    btn.disabled = false; btn.textContent = '✓ Jetzt eröffnen → GitHub';
                }
            } catch(e) {
                showToast('Fehler: ' + e.message, 'error');
                btn.disabled = false; btn.textContent = '✓ Jetzt eröffnen → GitHub';
            }
        }

        async function prjCreate() {
            const firmaCode = document.getElementById('prjFirma').value;
            const name = document.getElementById('prjName').value.trim();
            if (!firmaCode || !name) { showToast('Firma und Projektname erforderlich', 'error'); return; }

            const btn = document.getElementById('prjCreateBtn');
            btn.disabled = true; btn.textContent = 'Erstelle auf GitHub…';

            try {
                const resp = await fetch(`${API}/projects`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_code: firmaCode,
                        name: name,
                        type: document.getElementById('prjType').value,
                        project_category: document.getElementById('prjCategory').value || 'mandat',
                        description: document.getElementById('prjDesc').value,
                        start_date: document.getElementById('prjStart').value,
                        end_date: document.getElementById('prjEnd').value,
                        budget_chf: document.getElementById('prjBudget').value ? Number(document.getElementById('prjBudget').value) : null,
                        billing_type: document.querySelector('input[name="prjBilling"]:checked')?.value || 'fixed',
                        fa_owner: document.getElementById('prjOwner').value,
                        fa_team: document.getElementById('prjTeam').value.split(',').map(s => s.trim()).filter(Boolean),
                        lead_code: document.getElementById('prjLead').value
                    })
                });
                const result = await resp.json();
                if (resp.ok) {
                    showToast(`✓ Projekt "${name}" eröffnet · Kürzel: ${result.project_code}`, 'success');
                    prjCancelWizard();
                    prjLoad();
                } else {
                    showToast(result.error || 'Fehler', 'error');
                    btn.disabled = false; btn.textContent = '✓ Projekt eröffnen → GitHub';
                }
            } catch(e) {
                showToast('Fehler: ' + e.message, 'error');
                btn.disabled = false; btn.textContent = '✓ Projekt eröffnen → GitHub';
            }
        }

        // ════════════════════════════════════════════════
        // PROJECT LANDING PAGE
        // ════════════════════════════════════════════════
        let prjLandingData = null;
        let prjCurrentSlug = '';
        let prjCameFrom = 'projects';

        function prjBackToList() {
            document.getElementById('prjLandingView').style.display = 'none';
            if (prjCameFrom === 'myprojects') {
                showSection('myprojects');
            } else {
                document.getElementById('prjListView').style.display = '';
            }
        }

        async function prjOpenLanding(slug) {
            prjCurrentSlug = slug;
            document.getElementById('prjListView').style.display = 'none';
            document.getElementById('prjWizardView').style.display = 'none';
            document.getElementById('prjLandingView').style.display = '';
            document.getElementById('prjLandingHeader').innerHTML = '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.3)">Lade Projektdaten…</div>';
            document.getElementById('prjLandingResources').innerHTML = '';
            document.getElementById('prjLandingData').innerHTML = '';
            // Clear project chat
            const chatMsgs = document.getElementById('prjChatMessages');
            if (chatMsgs) chatMsgs.innerHTML = `<div id="prjChatWelcome" style="text-align:center;padding:24px 20px">
                <div style="font-size:24px;margin-bottom:8px">🧠</div>
                <div style="font-size:13px;color:var(--text-secondary);line-height:1.6">BEATRIX kennt den Projektkontext.<br>Stelle Fragen — Ergebnisse werden im Projekt gespeichert.</div>
            </div>`;
            prjChatHistory = [];
            prjChatDraft = {};
            prjChatIntent = '';
            prjChatAttachments = [];
            const attEl = document.getElementById('prjChatAttachments');
            if (attEl) { attEl.innerHTML = ''; attEl.style.display = 'none'; }
            // Reset to Übersicht main tab
            prjSwitchMainTab('overview');
            const backBtn = document.getElementById('prjBackBtn');
            if (backBtn) backBtn.textContent = prjCameFrom === 'myprojects' ? '← Meine Projekte' : '← Alle Projekte';

            try {
                const resp = await fetch(`${API}/projects/${slug}/landing`, { headers: H() });
                if (!resp.ok) throw new Error('Projekt nicht gefunden');
                prjLandingData = await resp.json();
                prjLandingData.slug = slug;
                prjRenderLanding();
            } catch(e) {
                document.getElementById('prjLandingHeader').innerHTML = `<div style="text-align:center;padding:20px;color:var(--error)">${e.message}</div>`;
            }
        }

        function prjRenderLanding() {
            const d = prjLandingData;
            const p = d.project || {};
            const meta = p.metadata || {};
            const client = p.client || {};
            const project = p.project || {};
            const timeline = p.timeline || {};
            const team = p.team || {};
            const scope = p.scope || {};
            const objective = p.objective || {};
            const fehradvice_scope = p.fehradvice_scope || {};
            const res = d.resources || {};

            // Status
            const status = (meta.status || 'planning').toLowerCase();
            const statusColors = {active:'#34d399',aktiv:'#34d399',planning:'#fbbf24',completed:'rgba(139,170,255,0.6)','on-hold':'rgba(255,255,255,0.3)'};
            const statusLabels = {active:'Aktiv',aktiv:'Aktiv',planning:'Planung',completed:'Abgeschlossen','on-hold':'On Hold'};
            const sc = statusColors[status] || 'rgba(255,255,255,0.3)';

            // Header
            const prjName = project.name || meta.name || meta.project_code || '–';
            const custName = client.name || client.short_name || '';
            const prjType = project.type || '';
            const owner = team.fa_owner || '';
            const prjCode = meta.project_code || '';
            const prjCat = meta.project_category || '';
            const catIcons = {mandat:'💼', lead:'🎯', probono:'🤝'};
            const catLabels = {mandat:'Mandat', lead:'Lead', probono:'Pro Bono'};
            const catColors = {mandat:'52,211,153', lead:'251,191,36', probono:'139,170,255'};
            // Extract team members
            let teamMembers = [];
            if (Array.isArray(team.fa_team)) teamMembers = team.fa_team;
            if (Array.isArray(team.fehradvice_team)) {
                teamMembers = team.fehradvice_team.map(t => typeof t === 'string' ? t : t.name || t.code || '');
            }
            // Extract contacts
            let contacts = [];
            if (Array.isArray(client.contacts)) contacts = client.contacts.map(c => typeof c === 'string' ? c : c.name || '');
            if (Array.isArray(team.customer_contacts)) contacts = team.customer_contacts.map(c => typeof c === 'string' ? c : c.name || '');

            // ── Tab Status (must be calculated before header) ──
            const cv = res.context_vector || {};
            const mo = res.models || {};
            const pr = res.profile || {};
            const sc2 = res.scenarios || {};
            const pe = res.personas || {};
            const docs = res.documents || {};
            const df = res.data_files || {};
            const kpisRes = res.kpis || {};

            const objSummaryCheck = objective.summary || project.description || '';
            const inScopeCheck = scope.in_scope || fehradvice_scope.deliverables || [];
            const behObjCheck = fehradvice_scope.behavioral_objectives || [];
            let tlCheck = Array.isArray(p.timeline) ? p.timeline : [];
            const phasesCheck = p.phases || [];
            const sessionsCheck = p.sessions || [];
            const deliverablesCheck = p.deliverables || p.final_deliverables || fehradvice_scope.deliverables || [];
            const risksCheck = p.risks || [];
            const kpisCheck = p.kpis || [];
            const ebfCheck = (p.ebf_integration||{}).primary_10c_dimensions || fehradvice_scope.ten_c_focus || [];
            let budgetCheck = false;
            if (typeof p.timeline === 'object' && !Array.isArray(p.timeline)) {
                budgetCheck = !!(p.timeline.budget_chf || p.timeline.budget_eur);
            }
            const teamCheck = teamMembers.length > 0 || contacts.length > 0 || !!owner;

            const tabStatus = {
                overview: true,
                auftrag: !!(objSummaryCheck || inScopeCheck.length || behObjCheck.length),
                planung: !!(tlCheck.length || phasesCheck.length),
                meetings: sessionsCheck.length > 0,
                deliverables: deliverablesCheck.length > 0,
                dokumente: !!(docs.available),
                modelle: !!(mo.available || cv.available || ebfCheck.length),
                risiken: risksCheck.length > 0,
                kommunikation: false,
                budget: budgetCheck,
                learnings: kpisCheck.length > 0
            };

            const filledCount = Object.values(tabStatus).filter(v => v).length - 1;
            const totalTabs = 10;

            document.getElementById('prjLandingHeader').innerHTML = `
                <div style="display:flex;align-items:flex-start;gap:16px">
                    <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,${sc}30,${sc}10);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;border:1px solid ${sc}40">📋</div>
                    <div style="flex:1">
                        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                            ${prjCode ? `<span style="font-size:12px;padding:3px 10px;border-radius:6px;background:rgba(255,255,255,0.06);color:var(--accent-light);font-weight:700;font-family:monospace;letter-spacing:0.5px">${prjCode}</span>` : ''}
                            <div style="font-size:20px;font-weight:700;color:white">${prjName}</div>
                            <span style="font-size:10px;padding:3px 10px;border-radius:8px;background:${sc}15;color:${sc};border:1px solid ${sc}30;font-weight:600">${statusLabels[status]||status}</span>
                            ${prjCat ? `<span style="font-size:10px;padding:3px 10px;border-radius:8px;background:rgba(${catColors[prjCat]||'255,255,255'},0.08);color:rgba(${catColors[prjCat]||'255,255,255'},0.7);border:1px solid rgba(${catColors[prjCat]||'255,255,255'},0.15)">${catIcons[prjCat]||''} ${catLabels[prjCat]||prjCat}</span>` : ''}
                        </div>
                        <div style="display:flex;gap:12px;align-items:center;margin-top:6px;flex-wrap:wrap;font-size:13px;color:rgba(255,255,255,0.5)">
                            ${custName ? `<span>🏢 ${custName}</span>` : ''}
                            ${owner ? `<span>👤 ${owner}</span>` : ''}
                            ${prjType ? `<span>📌 ${prjType}</span>` : ''}
                            ${meta.project_id ? `<span style="font-size:10px;color:rgba(255,255,255,0.2)">${meta.project_id}</span>` : ''}
                        </div>
                        ${contacts.length ? `<div style="margin-top:8px;font-size:11px;color:rgba(255,255,255,0.3)">Kundenkontakte: ${contacts.join(', ')}</div>` : ''}
                        ${teamMembers.length ? `<div style="margin-top:4px;font-size:11px;color:rgba(255,255,255,0.3)">FA Team: ${teamMembers.join(', ')}</div>` : ''}
                    </div>
                </div>
                <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border);display:flex;align-items:center;gap:12px">
                    <div style="font-size:11px;color:rgba(255,255,255,0.3)">Projektdaten</div>
                    <div style="flex:1;height:4px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden">
                        <div style="height:100%;width:${Math.round(filledCount/totalTabs*100)}%;background:linear-gradient(90deg,#34d399,#2A7F8E);border-radius:2px;transition:width 0.3s"></div>
                    </div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4);font-weight:600">${filledCount}/${totalTabs}</div>
                    ${d.has_local_edits ? `<button onclick="prjSyncGitHub()" style="padding:4px 10px;background:rgba(232,163,61,0.1);border:1px solid rgba(232,163,61,0.3);border-radius:6px;color:#E8A33D;font-size:10px;cursor:pointer;margin-left:8px" title="Lokale Änderungen noch nicht in GitHub">⟳ Sync</button>` : ''}
                </div>`;

            // ── Tab Status Dots (apply) ──
            document.querySelectorAll('#prjMainPm .prj-tab').forEach(tab => {
                const key = tab.dataset.tab;
                if (key === 'overview') return;
                const has = tabStatus[key];
                const dot = has ? '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:#34d399;margin-left:5px;vertical-align:middle"></span>'
                               : '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:rgba(248,113,113,0.6);margin-left:5px;vertical-align:middle"></span>';
                // Preserve original text, add dot
                const icon = tab.textContent.trim().split(' ')[0];
                const label = tab.textContent.trim().substring(icon.length).trim();
                tab.innerHTML = `${icon} ${label} ${dot}`;
            });

            // ── Left: Verfügbare Ressourcen ──
            const tile = (icon, label, available, detail, sub, tabTarget) => `
                <div onclick="${tabTarget ? `prjSwitchMainTab('pm');prjSwitchTab('${tabTarget}')` : ''}" style="background:var(--navy-card);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all 0.15s" onmouseover="this.style.borderColor='rgba(42,127,142,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
                    <div style="font-size:18px;width:32px;text-align:center">${icon}</div>
                    <div style="flex:1;min-width:0">
                        <div style="font-size:13px;font-weight:600;color:white">${label}</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">${detail}</div>
                        ${sub ? `<div style="font-size:10px;color:rgba(255,255,255,0.2);margin-top:2px">${sub}</div>` : ''}
                    </div>
                    <div style="font-size:14px;flex-shrink:0">${available ? '✅' : '❌'}</div>
                </div>`;

            let resourceHtml = '';
            resourceHtml += tile('🧭', 'Kontextvektor',
                cv.available,
                cv.available ? `${cv.count} Dimensionen erfasst` : 'Noch nicht erstellt',
                cv.available ? cv.files?.slice(0,3).map(f => f.replace(/.*_context_/,'').replace('.yaml','')).join(', ') : '', 'modelle');
            resourceHtml += tile('🧠', 'Modelle',
                mo.available,
                mo.available ? `${mo.count} Modell${mo.count>1?'e':''}` : 'Noch kein Modell',
                mo.available ? mo.files?.join(', ') : '', 'modelle');
            resourceHtml += tile('📁', 'Kundenprofil',
                pr.available,
                pr.available ? 'Profil vorhanden' : 'Noch nicht angelegt',
                '', '');
            resourceHtml += tile('📊', 'KPIs & Daten',
                kpisRes.available || df.available,
                `${kpisRes.available ? 'KPIs definiert' : ''}${kpisRes.available && df.available ? ' · ' : ''}${df.available ? df.count + ' Datensätze' : ''}` || 'Keine Daten',
                '', 'learnings');
            resourceHtml += tile('🔮', 'Szenarien',
                sc2.available,
                sc2.available ? `${sc2.count} Szenario${sc2.count>1?'s':''}` : 'Keine Szenarien',
                '', '');
            resourceHtml += tile('👤', 'Personas',
                pe.available,
                pe.available ? 'Personas vorhanden' : 'Keine Personas',
                '', '');
            resourceHtml += tile('📄', 'Dokumente',
                docs.available,
                `${docs.pdfs||0} PDFs · ${docs.mds||0} Markdown`,
                docs.available ? docs.pdf_files?.slice(0,2).map(f => f.length > 35 ? f.substring(0,32)+'…' : f).join(', ') : '', 'dokumente');

            if (res.total_files) {
                resourceHtml += `<div style="text-align:center;font-size:10px;color:rgba(255,255,255,0.2);padding:8px">📁 ${res.total_files} Dateien in data/customers/${res.customer_code}/</div>`;
            }
            if (res.customer_folder_exists === false) {
                resourceHtml += `<div style="text-align:center;padding:16px;font-size:12px;color:rgba(255,255,255,0.3)">Kein Kundenordner vorhanden.<br>Wird bei erster Analyse automatisch erstellt.</div>`;
            }

            // ── Verknüpfte Projekte tile ──
            const linkedAll = [...(d.other_projects||[]).filter(o=>o.slug), ...(d.linked_projects||[])];
            const linkedCount = linkedAll.length;
            resourceHtml += `
                <div onclick="prjToggleLinkedPanel()" style="background:var(--navy-card);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all 0.15s" onmouseover="this.style.borderColor='rgba(42,127,142,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
                    <div style="font-size:18px;width:32px;text-align:center">🔗</div>
                    <div style="flex:1;min-width:0">
                        <div style="font-size:13px;font-weight:600;color:white">Verknüpfte Projekte</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">${linkedCount > 0 ? linkedCount + ' Projekt' + (linkedCount>1?'e':'') + ' verknüpft' : 'Noch keine Verknüpfungen'}</div>
                    </div>
                    <div style="font-size:14px;flex-shrink:0">${linkedCount > 0 ? '✅' : '➕'}</div>
                </div>`;

            document.getElementById('prjLandingResources').innerHTML = resourceHtml;

            // ── Right: Projektdaten ──
            let projHtml = '';

            // Beratungsauftrag (Scope)
            const objSummary = objective.summary || project.description || fehradvice_scope.behavioral_objectives?.join(', ') || '';
            const inScope = scope.in_scope || fehradvice_scope.deliverables || [];
            const outScope = scope.out_of_scope || [];
            const scopeCount = inScope.length + outScope.length;
            projHtml += tile('📋', 'Beratungsauftrag',
                !!(objSummary || scopeCount),
                objSummary ? (objSummary.length > 60 ? objSummary.substring(0,57)+'…' : objSummary) : (scopeCount ? `${inScope.length} Scope-Punkte definiert` : 'Noch nicht definiert'),
                outScope.length ? `${outScope.length} Out-of-Scope` : '', 'auftrag');

            // Team
            const teamCount = teamMembers.length + (owner ? 1 : 0);
            const contactCount = contacts.length;
            projHtml += tile('👥', 'Team & Kontakte',
                teamCount > 0 || contactCount > 0,
                `${teamCount ? teamCount + ' FA' : ''}${teamCount && contactCount ? ' · ' : ''}${contactCount ? contactCount + ' Kunde' : ''}` || 'Noch nicht zugewiesen',
                '', 'auftrag');

            // Timeline
            let tlItems = [];
            if (Array.isArray(p.timeline)) {
                tlItems = p.timeline;
            } else if (p.timeline && typeof p.timeline === 'object') {
                if (p.timeline.start_date) tlItems.push({date: p.timeline.start_date, milestone: 'Start'});
                if (p.timeline.end_date) tlItems.push({date: p.timeline.end_date, milestone: 'Ende'});
            }
            const phases = p.phases || [];
            projHtml += tile('📅', 'Timeline',
                tlItems.length > 0 || phases.length > 0,
                tlItems.length ? `${tlItems.length} Milestones` : (phases.length ? `${phases.length} Phasen` : 'Keine Timeline'),
                phases.length ? phases.map(ph => ph.name || ph.phase || '').filter(Boolean).slice(0,3).join(' → ') : '', 'planung');

            // Deliverables
            const deliverables = p.deliverables || p.final_deliverables || fehradvice_scope.deliverables || [];
            projHtml += tile('📦', 'Deliverables',
                deliverables.length > 0,
                deliverables.length ? `${deliverables.length} Deliverable${deliverables.length>1?'s':''}` : 'Keine definiert',
                deliverables.length ? deliverables.slice(0,3).map(d => typeof d === 'string' ? d : d.name || d.id || '').filter(Boolean).join(', ') : '', 'deliverables');

            // EBF Integration
            const ebf = p.ebf_integration || {};
            const tenC = ebf.primary_10c_dimensions || fehradvice_scope.ten_c_focus || [];
            const bcm = ebf.bcm_models || [];
            const barriers = ebf.behavioral_barriers || [];
            projHtml += tile('🧬', 'EBF Integration',
                tenC.length > 0 || bcm.length > 0,
                tenC.length ? `10C: ${tenC.join(', ')}` : (bcm.length ? `${bcm.length} BCM Modell${bcm.length>1?'e':''}` : 'Keine EBF-Verknüpfung'),
                barriers.length ? `Barriers: ${barriers.slice(0,2).join(', ')}` : '', 'modelle');

            // KPIs
            const projKpis = p.kpis || [];
            projHtml += tile('📊', 'KPIs & Wirkung',
                projKpis.length > 0,
                projKpis.length ? `${projKpis.length} KPI${projKpis.length>1?'s':''}` : 'Keine KPIs definiert',
                projKpis.length ? projKpis.slice(0,2).map(k => k.name || k.kpi_id || '').filter(Boolean).join(', ') : '', 'learnings');

            // Budget
            let budget = '';
            if (typeof p.timeline === 'object' && !Array.isArray(p.timeline)) {
                budget = p.timeline.budget_chf || p.timeline.budget_eur || '';
            }
            if (budget) {
                const curr = p.timeline.budget_eur ? 'EUR' : 'CHF';
                projHtml += tile('💰', 'Budget',
                    true,
                    `${curr} ${parseInt(budget).toLocaleString('de-CH')}`,
                    p.timeline.billing_type || '', 'budget');
            }

            // Risks
            const risks = p.risks || [];
            if (risks.length) {
                projHtml += tile('⚠', 'Risiken',
                    true,
                    `${risks.length} identifiziert`,
                    risks.slice(0,2).map(r => typeof r === 'string' ? r : r.description || '').filter(Boolean).map(s => s.length > 40 ? s.substring(0,37)+'…' : s).join(', '), 'risiken');
            }

            document.getElementById('prjLandingData').innerHTML = projHtml;

            // ── Other Projects (same customer) + Manual Links ──
            const other = d.other_projects || [];
            const manualLinks = d.linked_projects || [];
            const otherSection = document.getElementById('prjLandingOtherSection');
            const otherStatusColors = {active:'#34d399',aktiv:'#34d399',completed:'rgba(139,170,255,0.5)',planning:'#fbbf24',proposal:'#fbbf24',scoping:'#fbbf24'};
            const otherStatusLabels = {active:'Aktiv',aktiv:'Aktiv',completed:'Abgeschlossen',planning:'Planung'};
            let rows = '';

            // Auto-detected: same customer (from GitHub scan)
            const githubOther = other.filter(op => op.source === 'github');
            if (githubOther.length > 0) {
                rows += githubOther.map(op => {
                    const osc = otherStatusColors[op.status] || 'rgba(255,255,255,0.2)';
                    const osl = otherStatusLabels[op.status] || op.status;
                    return `<div onclick="prjOpenLanding('${op.slug||''}')" style="display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.03)'" onmouseout="this.style.background='transparent'">
                        <div style="width:6px;height:6px;border-radius:50%;background:${osc};flex-shrink:0"></div>
                        ${op.project_code ? `<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(255,255,255,0.06);color:var(--accent-light);font-family:monospace;font-weight:700">${op.project_code}</span>` : ''}
                        <div style="flex:1;font-size:13px;color:white;font-weight:500">${op.name}</div>
                        <span style="font-size:9px;padding:2px 8px;border-radius:6px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.3)">gleicher Kunde</span>
                        <span style="font-size:10px;padding:2px 8px;border-radius:6px;background:${osc}15;color:${osc};border:1px solid ${osc}30">${osl}</span>
                    </div>`;
                }).join('');
            }

            // CRM-sourced other projects (from leads, no slug)
            const crmOther = other.filter(op => op.source !== 'github');
            if (crmOther.length > 0) {
                rows += crmOther.map(op => {
                    const osc = otherStatusColors[op.status] || 'rgba(255,255,255,0.2)';
                    return `<div style="display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid rgba(255,255,255,0.03);opacity:0.5">
                        <div style="width:6px;height:6px;border-radius:50%;background:${osc};flex-shrink:0"></div>
                        <div style="flex:1;font-size:13px;color:rgba(255,255,255,0.5)">${op.name}</div>
                        <span style="font-size:9px;padding:2px 8px;border-radius:6px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.2)">CRM</span>
                    </div>`;
                }).join('');
            }

            // Manually linked projects
            if (manualLinks.length > 0) {
                rows += manualLinks.map(link => {
                    const linkType = link.type || 'related';
                    const typeLabels = {predecessor:'Vorgänger',successor:'Nachfolger',related:'Verwandt',reference:'Referenz',parent:'Hauptprojekt',child:'Teilprojekt'};
                    const typeIcons = {predecessor:'⬅️',successor:'➡️',related:'🔗',reference:'📚',parent:'🏠',child:'📁'};
                    const lsc = otherStatusColors[link.status] || 'rgba(255,255,255,0.2)';
                    const lsl = otherStatusLabels[link.status] || link.status || '';
                    return `<div onclick="prjOpenLanding('${link.slug||''}')" style="display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.03)'" onmouseout="this.style.background='transparent'">
                        <div style="font-size:12px">${typeIcons[linkType]||'🔗'}</div>
                        ${link.project_code ? `<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(255,255,255,0.06);color:var(--accent-light);font-family:monospace;font-weight:700">${link.project_code}</span>` : ''}
                        <div style="flex:1;font-size:13px;color:white;font-weight:500">${link.name||link.slug||'–'}</div>
                        ${link.note ? `<span style="font-size:9px;color:rgba(255,255,255,0.2)" title="${link.note}">💬</span>` : ''}
                        <span style="font-size:9px;padding:2px 8px;border-radius:6px;background:rgba(42,127,142,0.08);color:rgba(42,127,142,0.6);border:1px solid rgba(42,127,142,0.15)">${typeLabels[linkType]||linkType}</span>
                        ${lsl ? `<span style="font-size:10px;padding:2px 8px;border-radius:6px;background:${lsc}15;color:${lsc};border:1px solid ${lsc}30">${lsl}</span>` : ''}
                        <button onclick="event.stopPropagation();prjUnlinkProject('${link.slug}')" style="font-size:9px;background:none;border:none;color:rgba(255,255,255,0.15);cursor:pointer;padding:2px" title="Verknüpfung lösen">✕</button>
                    </div>`;
                }).join('');
            }

            if (!rows) {
                rows = '<div style="padding:16px;text-align:center;font-size:12px;color:rgba(255,255,255,0.2)">Noch keine verknüpften Projekte. Klicke „+ Projekt verknüpfen" um Zusammenhänge herzustellen.</div>';
            }
            document.getElementById('prjLandingOther').innerHTML = rows;
        }

        let prjActiveTab = 'overview';

        // ── PROJECT LINKING ──
        let _prjLinkAllProjects = [];

        function prjToggleLinkedPanel() {
            const el = document.getElementById('prjLandingOtherSection');
            if (!el) return;
            const isHidden = el.style.display === 'none';
            el.style.display = isHidden ? '' : 'none';
            if (isHidden) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function prjLinkProjectStart() {
            if (!prjCurrentSlug) return;
            // Load all projects for selection
            try {
                const resp = await fetch(`${API}/projects`, { headers: H() });
                _prjLinkAllProjects = resp.ok ? await resp.json() : [];
            } catch(e) { _prjLinkAllProjects = []; }

            // Get already-linked slugs to exclude
            const alreadyLinked = new Set();
            alreadyLinked.add(prjCurrentSlug);
            (prjLandingData?.linked_projects || []).forEach(l => alreadyLinked.add(l.slug));
            (prjLandingData?.other_projects || []).filter(o => o.slug).forEach(o => alreadyLinked.add(o.slug));

            const available = _prjLinkAllProjects.filter(p => !alreadyLinked.has(p.slug));

            const statusColors = {active:'#34d399',aktiv:'#34d399',planning:'#fbbf24',completed:'rgba(139,170,255,0.5)'};
            const typeOptions = `
                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">
                    <button class="prj-link-type-btn selected" data-type="predecessor" onclick="prjLinkTypeSelect(this)" style="font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid rgba(42,127,142,0.3);background:rgba(42,127,142,0.15);color:var(--accent-light);cursor:pointer;font-family:inherit">⬅️ Vorgänger</button>
                    <button class="prj-link-type-btn" data-type="successor" onclick="prjLinkTypeSelect(this)" style="font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);cursor:pointer;font-family:inherit">➡️ Nachfolger</button>
                    <button class="prj-link-type-btn" data-type="related" onclick="prjLinkTypeSelect(this)" style="font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);cursor:pointer;font-family:inherit">🔗 Verwandt</button>
                    <button class="prj-link-type-btn" data-type="reference" onclick="prjLinkTypeSelect(this)" style="font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);cursor:pointer;font-family:inherit">📚 Referenz</button>
                    <button class="prj-link-type-btn" data-type="parent" onclick="prjLinkTypeSelect(this)" style="font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);cursor:pointer;font-family:inherit">🏠 Hauptprojekt</button>
                    <button class="prj-link-type-btn" data-type="child" onclick="prjLinkTypeSelect(this)" style="font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);cursor:pointer;font-family:inherit">📁 Teilprojekt</button>
                </div>`;

            const projectList = available.length === 0
                ? '<div style="padding:20px;text-align:center;color:rgba(255,255,255,0.3);font-size:12px">Keine weiteren Projekte verfügbar.</div>'
                : available.map(p => {
                    const sc = statusColors[p.status] || 'rgba(255,255,255,0.2)';
                    return `<div class="prj-link-item" data-slug="${p.slug}" data-name="${(p.name||'').toLowerCase()} ${(p.project_code||'').toLowerCase()} ${(p.customer_name||'').toLowerCase()}" onclick="prjLinkSelect(this,'${p.slug}')" style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:background 0.15s;border-radius:6px" onmouseover="this.style.background='rgba(255,255,255,0.04)'" onmouseout="if(!this.classList.contains('selected'))this.style.background='transparent'">
                        <div style="width:6px;height:6px;border-radius:50%;background:${sc};flex-shrink:0"></div>
                        ${p.project_code ? `<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(255,255,255,0.06);color:var(--accent-light);font-family:monospace;font-weight:700">${p.project_code}</span>` : ''}
                        <div style="flex:1;min-width:0">
                            <div style="font-size:13px;color:white;font-weight:500">${p.name||p.slug}</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.3)">${p.customer_name||''}</div>
                        </div>
                    </div>`;
                }).join('');

            // Show modal
            const modal = document.createElement('div');
            modal.id = 'prjLinkModal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9500;display:flex;align-items:center;justify-content:center;padding:20px';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:16px;width:min(560px,95vw);max-height:80vh;display:flex;flex-direction:column;overflow:hidden">
                    <div style="padding:20px 20px 0;flex-shrink:0">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                            <h3 style="font-size:16px;font-weight:700;color:white;margin:0">🔗 Projekt verknüpfen</h3>
                            <button onclick="document.getElementById('prjLinkModal').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer;padding:4px">✕</button>
                        </div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-bottom:12px">Art der Verknüpfung:</div>
                        ${typeOptions}
                        <input id="prjLinkSearch" type="text" placeholder="Projekt suchen…" oninput="prjLinkFilter(this.value)" style="width:100%;box-sizing:border-box;padding:10px 14px;background:var(--navy-light);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;margin-bottom:4px;font-family:inherit">
                        <input id="prjLinkNote" type="text" placeholder="Optionale Notiz zur Verknüpfung…" style="width:100%;box-sizing:border-box;padding:8px 14px;background:var(--navy-light);border:1px solid var(--border);border-radius:8px;color:white;font-size:12px;margin-top:6px;margin-bottom:8px;font-family:inherit;color:rgba(255,255,255,0.5)">
                    </div>
                    <div id="prjLinkList" style="flex:1;overflow-y:auto;padding:8px 20px 20px;min-height:100px;max-height:400px">
                        ${projectList}
                    </div>
                    <div style="padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;flex-shrink:0">
                        <button onclick="document.getElementById('prjLinkModal').remove()" style="padding:8px 16px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text-secondary);font-size:12px;cursor:pointer;font-family:inherit">Abbrechen</button>
                        <button id="prjLinkConfirmBtn" onclick="prjLinkConfirm()" disabled style="padding:8px 20px;border:none;border-radius:8px;background:rgba(42,127,142,0.3);color:rgba(42,127,142,0.5);font-size:12px;font-weight:600;cursor:not-allowed;font-family:inherit;transition:all 0.15s">Verknüpfen</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            document.getElementById('prjLinkSearch').focus();
        }

        let _prjLinkSelectedSlug = null;
        let _prjLinkSelectedType = 'predecessor';

        function prjLinkTypeSelect(btn) {
            document.querySelectorAll('.prj-link-type-btn').forEach(b => {
                b.classList.remove('selected');
                b.style.background = 'transparent';
                b.style.borderColor = 'var(--border)';
                b.style.color = 'var(--text-secondary)';
            });
            btn.classList.add('selected');
            btn.style.background = 'rgba(42,127,142,0.15)';
            btn.style.borderColor = 'rgba(42,127,142,0.3)';
            btn.style.color = 'var(--accent-light)';
            _prjLinkSelectedType = btn.dataset.type;
        }

        function prjLinkSelect(el, slug) {
            document.querySelectorAll('.prj-link-item').forEach(i => {
                i.classList.remove('selected');
                i.style.background = 'transparent';
                i.style.outline = 'none';
            });
            el.classList.add('selected');
            el.style.background = 'rgba(42,127,142,0.08)';
            el.style.outline = '1px solid rgba(42,127,142,0.3)';
            _prjLinkSelectedSlug = slug;
            const btn = document.getElementById('prjLinkConfirmBtn');
            if (btn) {
                btn.disabled = false;
                btn.style.background = 'linear-gradient(135deg,var(--accent),#2A7F8E)';
                btn.style.color = 'white';
                btn.style.cursor = 'pointer';
            }
        }

        function prjLinkFilter(q) {
            const query = q.toLowerCase().trim();
            document.querySelectorAll('.prj-link-item').forEach(el => {
                const data = el.dataset.name || '';
                el.style.display = (!query || data.includes(query)) ? 'flex' : 'none';
            });
        }

        async function prjLinkConfirm() {
            if (!_prjLinkSelectedSlug || !prjCurrentSlug) return;
            const note = document.getElementById('prjLinkNote')?.value || '';
            const btn = document.getElementById('prjLinkConfirmBtn');
            if (btn) { btn.textContent = 'Verknüpfe…'; btn.disabled = true; }

            try {
                const resp = await fetch(`${API}/projects/${prjCurrentSlug}/link`, {
                    method: 'POST', headers: {...H(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({ target_slug: _prjLinkSelectedSlug, type: _prjLinkSelectedType, note })
                });
                const res = await resp.json();
                if (resp.ok) {
                    showToast(`✅ Projekt verknüpft (${_prjLinkSelectedType})`, 'success');
                    document.getElementById('prjLinkModal')?.remove();
                    // Reload landing to show updated links
                    prjOpenLanding(prjCurrentSlug);
                } else {
                    showToast('❌ ' + (res.error || res.detail || 'Fehler'), 'error');
                    if (btn) { btn.textContent = 'Verknüpfen'; btn.disabled = false; }
                }
            } catch(e) {
                showToast('❌ ' + e.message, 'error');
                if (btn) { btn.textContent = 'Verknüpfen'; btn.disabled = false; }
            }
        }

        async function prjUnlinkProject(targetSlug) {
            if (!prjCurrentSlug || !targetSlug) return;
            if (!await bxConfirm(`Verknüpfung zu "${targetSlug}" wirklich lösen?`, {title:'Verknüpfung lösen', icon:'🔗', confirmText:'Lösen', danger:true})) return;
            try {
                const resp = await fetch(`${API}/projects/${prjCurrentSlug}/link/${targetSlug}`, {
                    method: 'DELETE', headers: H()
                });
                if (resp.ok) {
                    showToast('Verknüpfung gelöst', 'success');
                    prjOpenLanding(prjCurrentSlug);
                } else {
                    showToast('❌ Fehler beim Lösen', 'error');
                }
            } catch(e) { showToast('❌ ' + e.message, 'error'); }
        }

        function prjSwitchMainTab(tab) {
            // Main tabs: overview, inhalt, pm
            document.querySelectorAll('#prjTabBar .prj-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
            document.querySelectorAll('.prj-main-tab-content').forEach(c => c.classList.remove('active'));
            const mainMap = {overview:'prjMainOverview', inhalt:'prjMainInhalt', pm:'prjMainPm'};
            const el = document.getElementById(mainMap[tab]);
            if (el) el.classList.add('active');
            // On PM open, render first sub-tab
            if (tab === 'pm' && prjLandingData) {
                prjSwitchTab('auftrag');
            }
            // On inhalt open, render module status badges
            if (tab === 'inhalt' && prjLandingData) {
                prjRenderModuleStatus();
            }
        }

        function prjSwitchTab(tab) {
            prjActiveTab = tab;
            // Only toggle PM sub-tabs
            document.querySelectorAll('#prjMainPm .prj-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
            document.querySelectorAll('#prjMainPm .prj-tab-content').forEach(c => c.classList.remove('active'));
            const tabMap = {auftrag:'prjTabAuftrag',planung:'prjTabPlanung',meetings:'prjTabMeetings',deliverables:'prjTabDeliverables',dokumente:'prjTabDokumente',risiken:'prjTabRisiken',kommunikation:'prjTabKommunikation',budget:'prjTabBudget',learnings:'prjTabLearnings'};
            const el = document.getElementById(tabMap[tab]);
            if (el) el.classList.add('active');
            if (prjLandingData) prjRenderTab(tab);
        }

        function prjLaunchModule(module) {
            // Navigate to the Behavioral Design module with project context pre-loaded
            const slug = prjLandingData?.slug || '';
            const code = prjLandingData?.project?.metadata?.project_code || '';
            const customerCode = prjLandingData?.project?.client?.customer_code || '';
            const customerName = prjLandingData?.project?.client?.name || '';

            // Store project context for the module
            window._prjContext = { slug, code, customerCode, customerName, fromProject: true };

            // Switch to the module section
            navDropClick(module);

            // Show toast with context info
            showToast(`🔗 ${code || slug} → ${module.charAt(0).toUpperCase() + module.slice(1)}`, 'success');
        }

        // ── PROJECT CHAT (100% identical format to main chat) ──
        let prjChatHistory = [];
        let prjChatDraft = {};
        let prjChatIntent = '';
        let prjChatAttachments = []; // [{type, name, content_text, image_base64, media_type, size}]

        async function prjChatFileSelected(input) {
            const files = Array.from(input.files);
            if (!files.length) return;

            const container = document.getElementById('prjChatAttachments');
            container.style.display = 'flex';

            for (const file of files) {
                // Show uploading indicator
                const tempId = 'att_' + Date.now() + Math.random().toString(36).slice(2,6);
                container.insertAdjacentHTML('beforeend', `<div id="${tempId}" style="display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--navy-card);border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--text-secondary)">
                    <span style="animation:blink 0.8s infinite">⏳</span> ${file.name.length > 20 ? file.name.slice(0,17)+'...' : file.name}
                </div>`);

                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    const r = await fetch(`${API}/chat/upload`, {
                        method: 'POST',
                        headers: {'Authorization': 'Bearer ' + authToken},
                        body: formData
                    });
                    const d = await r.json();

                    if (!r.ok) {
                        document.getElementById(tempId).innerHTML = `<span style="color:var(--error)">❌</span> ${file.name}: ${d.detail || 'Fehler'}`;
                        setTimeout(() => document.getElementById(tempId)?.remove(), 3000);
                        continue;
                    }

                    // Store attachment
                    d._tempId = tempId;
                    prjChatAttachments.push(d);

                    // Update preview
                    const el = document.getElementById(tempId);
                    if (d.type === 'image') {
                        el.innerHTML = `<img src="data:${d.media_type};base64,${d.image_base64.slice(0,100)}" style="width:24px;height:24px;border-radius:4px;object-fit:cover">
                            <span>🖼 ${d.name}</span>
                            <span onclick="prjRemoveAttachment('${tempId}')" style="cursor:pointer;color:rgba(255,255,255,0.3);margin-left:4px">✕</span>`;
                        const img = el.querySelector('img');
                        img.src = `data:${d.media_type};base64,${d.image_base64}`;
                    } else {
                        const sizeKb = Math.round(d.size / 1024);
                        let paperBadge = '';
                        if (d.paper_detected) {
                            const p = d.paper;
                            if (p.duplicate) {
                                paperBadge = `<div style="font-size:10px;color:#f59e0b;margin-top:2px">⚠️ Bereits in KB: ${p.title}</div>`;
                            } else if (p.ok) {
                                paperBadge = `<div style="font-size:10px;color:#34d399;margin-top:2px">📚 Paper erkannt → KB + GitHub ✓</div>`;
                            } else {
                                paperBadge = `<div style="font-size:10px;color:#ef4444;margin-top:2px">📚 Paper erkannt, Pipeline-Fehler</div>`;
                            }
                        } else if (d.paper_detected === false) {
                            paperBadge = `<div style="font-size:10px;color:rgba(255,255,255,0.25);margin-top:2px">📄 Kein Paper erkannt — nur als Chat-Kontext</div>`;
                        }
                        el.innerHTML = `<div style="display:flex;align-items:center;gap:6px">
                            <span>${d.paper_detected ? '📚' : '📄'}</span>
                            <div>
                                <div>${d.name} (${sizeKb} KB, ${d.chars || '?'} Zeichen)</div>
                                ${paperBadge}
                            </div>
                            <span onclick="prjRemoveAttachment('${tempId}')" style="cursor:pointer;color:rgba(255,255,255,0.3);margin-left:auto">✕</span>
                        </div>`;
                    }
                } catch(e) {
                    const el = document.getElementById(tempId);
                    if (el) el.innerHTML = `<span style="color:var(--error)">❌ ${e.message}</span>`;
                }
            }
            input.value = ''; // Reset file input
        }

        function prjRemoveAttachment(tempId) {
            prjChatAttachments = prjChatAttachments.filter(a => a._tempId !== tempId);
            const el = document.getElementById(tempId);
            if (el) el.remove();
            if (!prjChatAttachments.length) {
                document.getElementById('prjChatAttachments').style.display = 'none';
            }
        }

        function prjAppendMessage(role, content, sources) {
            const welcome = document.getElementById('prjChatWelcome');
            if (welcome) welcome.style.display = 'none';
            const container = document.getElementById('prjChatMessages');
            const initials = role === 'user' ? (currentUser?.name || currentUser?.email || 'U').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2) : 'B';
            const msgId = 'prjMsg_' + Date.now();
            let html = `<div class="chat-msg ${role}" id="${msgId}">
                <div class="chat-msg-avatar">${initials}</div>
                <div class="chat-msg-body">${formatMessage(content)}`;
            if (sources && sources.length > 0) {
                html += `<div class="chat-sources">${sources.map(s => `<span class="chat-source-tag">${s.title || s}</span>`).join('')}</div>`;
            }
            if (role === 'assistant') {
                html += `<div style="margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.04);display:flex;gap:6px">
                    <button onclick="copyAnswer('${msgId}')" style="padding:3px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:rgba(255,255,255,0.3);font-size:10px;cursor:pointer;transition:all 0.15s" onmouseenter="this.style.background='rgba(255,255,255,0.06)';this.style.color='rgba(255,255,255,0.6)'" onmouseleave="this.style.background='transparent';this.style.color='rgba(255,255,255,0.3)'">📋 Kopieren</button>
                    <button onclick="challengeAnswer('${msgId}')" style="padding:3px 10px;border-radius:6px;border:1px solid rgba(255,140,0,0.2);background:transparent;color:rgba(255,140,0,0.5);font-size:10px;cursor:pointer;transition:all 0.15s" onmouseenter="this.style.background='rgba(255,140,0,0.1)';this.style.color='#ff8c00'" onmouseleave="this.style.background='transparent';this.style.color='rgba(255,140,0,0.5)'">🔥 Challenge</button>
                </div>`;
            }
            html += `</div></div>`;
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
        }

        function prjShowTyping(message) {
            const container = document.getElementById('prjChatMessages');
            const existing = document.getElementById('prjTypingIndicator');
            if (existing) existing.remove();
            container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant" id="prjTypingIndicator">
                <div class="chat-msg-avatar">B</div>
                <div class="chat-msg-body">
                    <div style="display:flex;align-items:center;gap:10px;color:var(--text-muted);">
                        <div class="chat-typing"><span></span><span></span><span></span></div>
                        <span id="prjTypingText">${message || 'BEATRIX denkt nach...'}</span>
                    </div>
                </div>
            </div>`);
            container.scrollTop = container.scrollHeight;
        }

        function prjRemoveTyping() {
            const el = document.getElementById('prjTypingIndicator');
            if (el) el.remove();
        }

        async function prjChatSend() {
            const input = document.getElementById('prjChatInput');
            const btn = document.getElementById('prjChatSendBtn');
            const question = input.value.trim();
            if (!question && !prjChatAttachments.length) return;
            if (!prjCurrentSlug) return;

            const currentAttachments = [...prjChatAttachments];
            input.value = ''; autoResize(input);
            btn.disabled = true;
            prjChatAttachments = [];
            document.getElementById('prjChatAttachments').innerHTML = '';
            document.getElementById('prjChatAttachments').style.display = 'none';

            // User message with file previews
            const welcome = document.getElementById('prjChatWelcome');
            if (welcome) welcome.style.display = 'none';
            const container = document.getElementById('prjChatMessages');
            const initials = (currentUser?.name || currentUser?.email || 'U').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);

            let attachHtml = '';
            if (currentAttachments.length) {
                attachHtml = '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">';
                for (const att of currentAttachments) {
                    if (att.type === 'image') {
                        attachHtml += `<div style="border-radius:8px;overflow:hidden;border:1px solid var(--border)">
                            <img src="data:${att.media_type};base64,${att.image_base64}" style="max-width:200px;max-height:150px;display:block">
                        </div>`;
                    } else {
                        attachHtml += `<div style="padding:6px 10px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--text-secondary)">
                            📄 ${att.name} (${Math.round(att.size/1024)} KB)
                        </div>`;
                    }
                }
                attachHtml += '</div>';
            }

            container.insertAdjacentHTML('beforeend', `<div class="chat-msg user">
                <div class="chat-msg-avatar">${initials}</div>
                <div class="chat-msg-body">${attachHtml}${question ? formatMessage(question) : '<span style="color:var(--text-muted);font-style:italic">Datei hochgeladen</span>'}</div>
            </div>`);
            container.scrollTop = container.scrollHeight;

            const msgText = question || `Analysiere die hochgeladenen Datei(en): ${currentAttachments.map(a=>a.name).join(', ')}`;
            prjChatHistory.push({role:'user', content: msgText});

            // Typing indicator — identical to main chat
            const intentLabels = {project:'Projekt analysieren',lead:'Lead analysieren',model:'Modell bauen',context:'Kontext erfassen'};
            prjShowTyping(prjChatIntent ? `BEATRIX: ${intentLabels[prjChatIntent]||'analysiert'}...` : 'BEATRIX analysiert (mit Projektkontext)...');

            try {
                // ── Same endpoint as bxCmd: /api/chat/intent ──
                const r = await fetch(`${API}/chat/intent`, {
                    method: 'POST',
                    headers: {...H(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: msgText,
                        history: prjChatHistory,
                        current_draft: prjChatDraft,
                        intent: prjChatIntent,
                        project_slug: prjCurrentSlug
                    })
                });
                const d = await r.json();
                prjRemoveTyping();

                if (!r.ok || !d.ok) {
                    prjAppendMessage('assistant', d.error || 'Fehler bei der Verarbeitung.');
                    btn.disabled = false; input.focus(); return;
                }

                // If redirect to KB → use project-scoped STREAMING chat
                if (d.status === 'redirect_kb') {
                    prjRemoveTyping();

                    // Create assistant message shell with cursor
                    const container = document.getElementById('prjChatMessages');
                    const msgId = 'prjStreamMsg_' + Date.now();
                    container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant">
                        <div class="chat-msg-avatar">B</div>
                        <div class="chat-msg-body" id="${msgId}">
                            <span class="mb-cursor" style="display:inline-block;width:2px;height:16px;background:var(--accent);animation:blink 0.8s infinite;vertical-align:middle"></span>
                        </div>
                    </div>`);
                    container.scrollTop = container.scrollHeight;

                    const targetEl = document.getElementById(msgId);
                    let fullText = '';
                    let renderTimer = null;
                    let streamSources = [];
                    let githubSaved = false;

                    try {
                        const streamResp = await fetch(`${API}/chat/project/${prjCurrentSlug}/stream`, {
                            method: 'POST',
                            headers: {...H(), 'Content-Type': 'application/json'},
                            body: JSON.stringify({ question: msgText, session_id: chatSessionId, attachments: currentAttachments.map(a => ({type:a.type, name:a.name, content_text:a.content_text, image_base64:a.image_base64, media_type:a.media_type})) })
                        });

                        if (!streamResp.ok) throw new Error(`Stream error: ${streamResp.status}`);

                        const reader = streamResp.body.getReader();
                        const decoder = new TextDecoder();
                        let sseBuffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            sseBuffer += decoder.decode(value, { stream: true });

                            const events = sseBuffer.split('\n\n');
                            sseBuffer = events.pop();

                            for (const evt of events) {
                                for (const line of evt.split('\n')) {
                                    if (!line.startsWith('data: ')) continue;
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'token' && data.text) {
                                            fullText += data.text;
                                            if (!renderTimer) {
                                                renderTimer = setTimeout(() => {
                                                    targetEl.innerHTML = mbRenderMd(fullText) +
                                                        '<span class="mb-cursor" style="display:inline-block;width:2px;height:14px;background:var(--accent);animation:blink 0.8s infinite;vertical-align:middle;margin-left:2px"></span>';
                                                    container.scrollTop = container.scrollHeight;
                                                    renderTimer = null;
                                                }, 50);
                                            }
                                        } else if (data.type === 'sources' && data.sources) {
                                            streamSources = data.sources;
                                        } else if (data.type === 'meta') {
                                            githubSaved = data.github_saved;
                                        } else if (data.type === 'done') {
                                            // Final render
                                        }
                                    } catch(e) {}
                                }
                            }
                        }

                        // Final render without cursor
                        if (renderTimer) { clearTimeout(renderTimer); renderTimer = null; }
                        let finalHtml = mbRenderMd(fullText);
                        if (streamSources.length > 0) {
                            finalHtml += `<div class="chat-sources">${streamSources.map(s => `<span class="chat-source-tag">${s.title || ''}</span>`).join('')}</div>`;
                        }
                        if (githubSaved) {
                            finalHtml += '<div style="font-size:10px;color:rgba(52,211,153,0.5);margin-top:8px;padding-top:6px;border-top:1px solid var(--border)">✓ Auf GitHub gespeichert</div>';
                        }
                        targetEl.innerHTML = finalHtml;
                        addMsgActionButtons(targetEl);
                        prjChatHistory.push({role:'assistant', content: fullText});

                    } catch(e) {
                        // Fallback to non-streaming
                        console.warn('Stream failed, falling back:', e);
                        try {
                            const kr = await fetch(`${API}/chat/project/${prjCurrentSlug}`, {
                                method: 'POST',
                                headers: {...H(), 'Content-Type': 'application/json'},
                                body: JSON.stringify({ question: msgText, session_id: chatSessionId, attachments: currentAttachments.map(a => ({type:a.type, name:a.name, content_text:a.content_text, image_base64:a.image_base64, media_type:a.media_type})) })
                            });
                            const kd = await kr.json();
                            let fallbackHtml = mbRenderMd(kd.answer || '');
                            if (kd.github_saved) fallbackHtml += '<div style="font-size:10px;color:rgba(52,211,153,0.5);margin-top:8px">✓ Auf GitHub gespeichert</div>';
                            targetEl.innerHTML = fallbackHtml;
                            addMsgActionButtons(targetEl);
                            prjChatHistory.push({role:'assistant', content: kd.answer || ''});
                        } catch(e2) {
                            targetEl.innerHTML = '<span style="color:var(--error)">Fehler: ' + e2.message + '</span>';
                        }
                    }
                } else {
                    // ── Structured card response (SAME as bxCmd) ──
                    const intent = d.intent || 'project';
                    prjChatIntent = intent;

                    if (d.data && Object.keys(d.data).length > 0) {
                        d.data.project_slug = prjCurrentSlug;
                        prjChatDraft = {...prjChatDraft, ...d.data};
                    }

                    let cardHtml = '';
                    const hasData = d.data && Object.keys(d.data).length > 0;

                    if (hasData) {
                        switch(intent) {
                            case 'project': cardHtml = renderProjectCard(prjChatDraft, d.status, d.missing, d.confidence, d.message); break;
                            case 'lead': cardHtml = renderLeadCard(prjChatDraft, d.status, d.missing, d.confidence, d.message); break;
                            case 'company': cardHtml = renderCompanyCard(prjChatDraft, d.status, d.missing, d.confidence, d.message); break;
                            case 'model': cardHtml = renderModelCard(prjChatDraft, d.status, d.missing, d.confidence, d.message); break;
                            case 'context': cardHtml = renderContextCard(prjChatDraft, d.status, d.missing, d.confidence, d.message); break;
                            case 'task': cardHtml = renderTaskCard(prjChatDraft, d.status, d.missing, d.confidence, d.message); break;
                        }
                    }
                    const textHtml = (!cardHtml && d.message) ? formatMessage(d.message) : '';
                    const bi = BX_INTENTS[intent] || {icon:'💡', color:'42,127,142'};

                    // Render in same format as main chat bxCmd
                    const container = document.getElementById('prjChatMessages');
                    container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant">
                        <div class="chat-msg-avatar" style="background:linear-gradient(135deg,rgba(${bi.color},0.8),rgba(${bi.color},0.4));font-size:12px">${bi.icon}</div>
                        <div class="chat-msg-body">${cardHtml}${textHtml}</div>
                    </div>`);
                    container.scrollTop = container.scrollHeight;
                    prjChatHistory.push({role:'assistant', content: d.message || JSON.stringify(d.data)});
                }
            } catch(e) {
                prjRemoveTyping();
                prjAppendMessage('assistant', 'Verbindungsfehler: ' + e.message);
            }

            btn.disabled = false;
            input.focus();
        }

        function prjRenderModuleStatus() {
            if (!prjLandingData) return;
            const res = prjLandingData.resources || {};
            const modules = ['context','segmente','journey','nutzen','architektur','model','audit','wirkung','evidenz'];
            modules.forEach(mod => {
                const el = document.getElementById('prjModStatus_' + mod);
                if (!el) return;
                const hasData = res[mod] || res[mod + '_analysis'];
                if (hasData) {
                    el.innerHTML = '<span style="font-size:10px;padding:2px 8px;border-radius:8px;background:rgba(52,211,153,0.1);color:#34d399;border:1px solid rgba(52,211,153,0.2)">✓ Daten vorhanden</span>';
                } else {
                    el.innerHTML = '<span style="font-size:10px;padding:2px 8px;border-radius:8px;background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.06)">Noch leer</span>';
                }
            });
        }

        function prjRenderTab(tab) {
            const d = prjLandingData;
            const p = d.project || {};
            const res = d.resources || {};
            const scope = p.scope || {};
            const objective = p.objective || {};
            const fehradvice_scope = p.fehradvice_scope || {};
            const project = p.project || {};
            const client = p.client || {};
            const team = p.team || {};
            const meta = p.metadata || {};

            if (tab === 'auftrag') {
                const objSummary = objective.summary || project.description || '';
                const coreInsight = objective.core_insight || '';
                const inScope = scope.in_scope || fehradvice_scope.deliverables || [];
                const outScope = scope.out_of_scope || [];
                const behObj = fehradvice_scope.behavioral_objectives || [];
                const tenC = fehradvice_scope.ten_c_focus || (p.ebf_integration||{}).primary_10c_dimensions || [];
                const stratCtx = project.strategic_context || '';
                // Contacts
                let auftraggeber = '', projektleiter = '';
                const contacts = client.contacts || team.customer_contacts || [];
                contacts.forEach(c => {
                    if (typeof c === 'object') {
                        if ((c.role||'').toLowerCase().includes('auftrag') || (c.role||'').toLowerCase().includes('sponsor')) auftraggeber = c.name || '';
                        if ((c.role||'').toLowerCase().includes('projektl') || (c.role||'').toLowerCase().includes('lead')) projektleiter = c.name || '';
                    }
                });

                let html = '<div style="display:flex;flex-direction:column;gap:20px">';
                // Beratungsziel
                html += `<div>
                    <div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:8px">Beratungsziel</div>
                    <div style="padding:14px;background:rgba(42,127,142,0.05);border:1px solid rgba(42,127,142,0.15);border-radius:8px">${objSummary || '<span style="color:rgba(255,255,255,0.3)">Noch nicht definiert</span>'}</div>
                    ${coreInsight ? `<div style="margin-top:8px;padding:10px 14px;background:rgba(251,191,36,0.05);border-left:3px solid rgba(251,191,36,0.4);border-radius:0 8px 8px 0;font-size:12px;color:rgba(255,255,255,0.5)">💡 ${coreInsight}</div>` : ''}
                </div>`;
                // Scope
                if (inScope.length) {
                    html += `<div>
                        <div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:8px">Beratungs-Scope</div>
                        <div style="display:flex;flex-direction:column;gap:6px">${inScope.map(s => {
                            const txt = typeof s === 'string' ? s : s.name || s.id || JSON.stringify(s);
                            return `<div style="padding:8px 12px;background:rgba(52,211,153,0.05);border:1px solid rgba(52,211,153,0.1);border-radius:6px;font-size:12px">✅ ${txt}</div>`;
                        }).join('')}</div>
                    </div>`;
                }
                if (outScope.length) {
                    html += `<div>
                        <div style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.4);margin-bottom:8px">Out-of-Scope</div>
                        <div style="display:flex;flex-direction:column;gap:6px">${outScope.map(s => `<div style="padding:8px 12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:6px;font-size:12px;color:rgba(255,255,255,0.4)">⛔ ${s}</div>`).join('')}</div>
                    </div>`;
                }
                // Behavioral Objectives & 10C
                if (behObj.length || tenC.length) {
                    html += `<div>
                        <div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:8px">Behavioral Framework</div>
                        ${behObj.length ? `<div style="margin-bottom:8px">${behObj.map(b => `<div style="padding:6px 12px;font-size:12px;color:rgba(255,255,255,0.5)">🎯 ${b}</div>`).join('')}</div>` : ''}
                        ${tenC.length ? `<div style="display:flex;gap:6px;flex-wrap:wrap">${tenC.map(c => `<span style="padding:4px 10px;font-size:11px;border-radius:6px;background:rgba(42,127,142,0.1);color:#2A7F8E;border:1px solid rgba(42,127,142,0.2)">${c}</span>`).join('')}</div>` : ''}
                    </div>`;
                }
                // Auftraggeber / Projektleiter
                if (auftraggeber || projektleiter || contacts.length) {
                    html += `<div>
                        <div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:8px">Kundenseitige Verantwortung</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                            <div style="padding:12px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px">
                                <div style="font-size:10px;color:rgba(255,255,255,0.3)">Auftraggeber</div>
                                <div style="font-size:13px;color:white;margin-top:4px">${auftraggeber || '–'}</div>
                            </div>
                            <div style="padding:12px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px">
                                <div style="font-size:10px;color:rgba(255,255,255,0.3)">Projektleiter (Kunde)</div>
                                <div style="font-size:13px;color:white;margin-top:4px">${projektleiter || '–'}</div>
                            </div>
                        </div>
                    </div>`;
                }
                if (!objSummary && !inScope.length && !outScope.length) {
                    html += '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Beratungsauftrag noch nicht definiert.<br>Wird beim Import aus Proposal/Offerte automatisch befüllt.</div>';
                }
                html += '</div>';
                document.getElementById('prjAuftragContent').innerHTML = html;
            }

            else if (tab === 'planung') {
                let tl = p.timeline || [];
                const phases = p.phases || [];
                let html = '';
                if (Array.isArray(tl) && tl.length) {
                    html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:12px">Milestones</div>';
                    html += '<div style="display:flex;flex-direction:column;gap:6px">';
                    tl.forEach(m => {
                        const statusIcon = (m.status||'').toLowerCase().includes('done') || (m.status||'').toLowerCase().includes('erledigt') ? '✅' : (m.status||'').toUpperCase() === 'HEUTE' ? '📍' : '⏳';
                        html += `<div style="display:flex;align-items:center;gap:12px;padding:10px 14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px">
                            <div style="font-size:14px">${statusIcon}</div>
                            <div style="width:90px;font-size:11px;color:rgba(255,255,255,0.3);flex-shrink:0">${m.date||''}</div>
                            <div style="flex:1;font-size:13px;color:rgba(255,255,255,0.7)">${m.milestone||m.name||''}</div>
                            <div style="font-size:10px;color:rgba(255,255,255,0.2)">${m.status||''}</div>
                        </div>`;
                    });
                    html += '</div>';
                }
                if (phases.length) {
                    html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:12px;margin-top:20px">Phasen</div>';
                    phases.forEach((ph, i) => {
                        html += `<div style="padding:14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:8px">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                                <span style="font-size:11px;padding:2px 8px;border-radius:6px;background:var(--accent-glow);color:var(--accent-light)">${ph.phase||'Phase '+(i+1)}</span>
                                <span style="font-size:13px;font-weight:600;color:white">${ph.name||''}</span>
                                ${ph.duration_weeks ? `<span style="font-size:10px;color:rgba(255,255,255,0.3)">${ph.duration_weeks} Wochen</span>` : ''}
                            </div>
                            ${ph.description ? `<div style="font-size:12px;color:rgba(255,255,255,0.5)">${ph.description}</div>` : ''}
                        </div>`;
                    });
                }
                if (!html) {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Noch keine Projektplanung hinterlegt.</div>';
                }
                document.getElementById('prjPlanungContent').innerHTML = html;
            }

            else if (tab === 'meetings') {
                const sessions = p.sessions || [];
                let html = '';
                if (sessions.length) {
                    sessions.forEach(s => {
                        const statusIcon = s.status === 'completed' ? '✅' : s.status === 'scheduled' ? '📅' : '📝';
                        html += `<div style="padding:14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:8px">
                            <div style="display:flex;align-items:center;gap:10px">
                                <span style="font-size:16px">${statusIcon}</span>
                                <div style="flex:1">
                                    <div style="font-size:13px;font-weight:600;color:white">${s.purpose||s.type||s.id||'Session'}</div>
                                    <div style="font-size:11px;color:rgba(255,255,255,0.3)">${s.date||''} · ${s.type||''} · ${s.mode||''}</div>
                                </div>
                                <span style="font-size:10px;padding:2px 8px;border-radius:6px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.3)">${s.status||''}</span>
                            </div>
                        </div>`;
                    });
                } else {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Noch keine Meetings erfasst.</div>';
                }
                document.getElementById('prjMeetingsContent').innerHTML = html;
            }

            else if (tab === 'deliverables') {
                const deliverables = p.deliverables || p.final_deliverables || fehradvice_scope.deliverables || [];
                let html = '';
                if (deliverables.length) {
                    deliverables.forEach(d => {
                        const name = typeof d === 'string' ? d : d.name || d.id || '';
                        const desc = typeof d === 'object' ? d.description || '' : '';
                        html += `<div style="padding:12px 14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:6px">
                            <div style="font-size:13px;font-weight:600;color:white">📦 ${name}</div>
                            ${desc ? `<div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px">${desc}</div>` : ''}
                        </div>`;
                    });
                } else {
                    html = '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.3)">Keine Deliverables definiert.</div>';
                }
                // File section
                html += `<div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <div style="font-size:13px;font-weight:600;color:rgba(255,255,255,0.6)">📎 Dateien</div>
                        <label style="padding:5px 12px;background:rgba(42,127,142,0.1);border:1px solid rgba(42,127,142,0.25);border-radius:8px;color:var(--accent-light);font-size:12px;cursor:pointer">
                            + Datei hochladen
                            <input type="file" style="display:none" onchange="prjDeliverableUpload(this)" multiple accept=".pdf,.docx,.pptx,.xlsx,.txt,.md,.csv,.json,.png,.jpg,.zip">
                        </label>
                    </div>
                    <div id="prjDeliverableFiles" style="min-height:40px"><div style="text-align:center;color:rgba(255,255,255,0.2);font-size:12px;padding:12px">Lade...</div></div>
                </div>`;
                document.getElementById('prjDeliverablesContent').innerHTML = html;
                prjLoadDeliverableFiles();
            }

            else if (tab === 'dokumente') {
                const docs = res.documents || {};
                let html = '';
                if (docs.available) {
                    if (docs.pdf_files?.length) {
                        html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:10px">PDFs</div>';
                        docs.pdf_files.forEach(f => {
                            html += `<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:6px">
                                <span style="font-size:16px">📕</span>
                                <div style="flex:1;font-size:13px;color:rgba(255,255,255,0.7)">${f}</div>
                            </div>`;
                        });
                    }
                    if (docs.md_files?.length) {
                        html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:10px;margin-top:16px">Markdown</div>';
                        docs.md_files.forEach(f => {
                            html += `<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:6px">
                                <span style="font-size:16px">📝</span>
                                <div style="flex:1;font-size:13px;color:rgba(255,255,255,0.7)">${f}</div>
                            </div>`;
                        });
                    }
                } else {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Keine Dokumente im Kundenordner.</div>';
                }
                document.getElementById('prjDokumenteContent').innerHTML = html;
            }

            else if (tab === 'modelle') {
                const models = res.models || {};
                const ebf = p.ebf_integration || {};
                let html = '';
                if (models.available) {
                    html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:10px">Vorhandene Modelle</div>';
                    models.files.forEach(f => {
                        html += `<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(42,127,142,0.05);border:1px solid rgba(42,127,142,0.15);border-radius:8px;margin-bottom:6px">
                            <span style="font-size:16px">🧠</span>
                            <div style="flex:1;font-size:13px;color:rgba(255,255,255,0.7)">${f.replace('.yaml','').replace(/_/g,' ')}</div>
                        </div>`;
                    });
                }
                // Context Vector
                const cv = res.context_vector || {};
                if (cv.available) {
                    html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:10px;margin-top:16px">Kontextvektor</div>';
                    html += `<div style="display:flex;flex-wrap:wrap;gap:6px">`;
                    cv.files.forEach(f => {
                        const dim = f.replace(/.*_context_/,'').replace('.yaml','').replace('_',' ');
                        html += `<span style="padding:4px 10px;font-size:11px;border-radius:6px;background:rgba(42,127,142,0.1);color:#2A7F8E;border:1px solid rgba(42,127,142,0.2)">${dim}</span>`;
                    });
                    html += '</div>';
                }
                // EBF
                if (ebf.primary_10c_dimensions?.length || ebf.behavioral_barriers?.length) {
                    html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:10px;margin-top:16px">EBF Integration</div>';
                    if (ebf.primary_10c_dimensions?.length) html += `<div style="margin-bottom:6px;font-size:12px;color:rgba(255,255,255,0.5)">10C: ${ebf.primary_10c_dimensions.join(', ')}</div>`;
                    if (ebf.behavioral_barriers?.length) html += `<div style="font-size:12px;color:rgba(255,255,255,0.5)">Barriers: ${ebf.behavioral_barriers.join(', ')}</div>`;
                }
                if (!html) {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Noch keine Modelle für diesen Kunden erstellt.<br>→ Modell über den Model Builder anlegen.</div>';
                }
                document.getElementById('prjModelleContent').innerHTML = html;
            }

            else if (tab === 'risiken') {
                const risks = p.risks || [];
                let html = '';
                if (risks.length) {
                    risks.forEach(r => {
                        const desc = typeof r === 'string' ? r : r.description || '';
                        const prob = r.probability || '';
                        const impact = r.impact || '';
                        const mitigation = r.mitigation || '';
                        html += `<div style="padding:14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:8px">
                            <div style="font-size:13px;font-weight:600;color:white">⚠ ${desc}</div>
                            ${prob || impact ? `<div style="display:flex;gap:12px;margin-top:6px;font-size:11px;color:rgba(255,255,255,0.3)">${prob ? `<span>P: ${prob}</span>` : ''}${impact ? `<span>Impact: ${impact}</span>` : ''}</div>` : ''}
                            ${mitigation ? `<div style="margin-top:6px;padding:8px 10px;background:rgba(52,211,153,0.05);border-left:2px solid rgba(52,211,153,0.3);border-radius:0 6px 6px 0;font-size:12px;color:rgba(255,255,255,0.5)">Mitigation: ${mitigation}</div>` : ''}
                        </div>`;
                    });
                } else {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Keine Risiken erfasst.</div>';
                }
                document.getElementById('prjRisikenContent').innerHTML = html;
            }

            else if (tab === 'budget') {
                let budget = null, billing = '', currency = 'CHF';
                if (typeof p.timeline === 'object' && !Array.isArray(p.timeline)) {
                    budget = p.timeline.budget_chf || p.timeline.budget_eur || null;
                    billing = p.timeline.billing_type || '';
                    if (p.timeline.budget_eur) currency = 'EUR';
                }
                let html = '';
                if (budget) {
                    const billingLabels = {fixed:'Fixpreis',time_material:'Time & Material',retainer:'Retainer'};
                    html = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                        <div style="padding:20px;background:rgba(52,211,153,0.05);border:1px solid rgba(52,211,153,0.15);border-radius:10px;text-align:center">
                            <div style="font-size:10px;color:rgba(255,255,255,0.3)">Projektbudget</div>
                            <div style="font-size:28px;font-weight:700;color:#34d399;margin-top:6px">${currency} ${parseInt(budget).toLocaleString('de-CH')}</div>
                        </div>
                        <div style="padding:20px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:10px;text-align:center">
                            <div style="font-size:10px;color:rgba(255,255,255,0.3)">Abrechnungsmodell</div>
                            <div style="font-size:20px;font-weight:600;color:white;margin-top:6px">${billingLabels[billing]||billing||'–'}</div>
                        </div>
                    </div>`;
                } else {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Kein Budget hinterlegt.</div>';
                }
                document.getElementById('prjBudgetContent').innerHTML = html;
            }

            else if (tab === 'kommunikation') {
                document.getElementById('prjKommunikationContent').innerHTML = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Kommunikationslog wird in einer nächsten Version verfügbar.<br>Hier werden E-Mails, Abstimmungen und Vereinbarungen erfasst.</div>';
            }

            else if (tab === 'learnings') {
                const kpis = p.kpis || [];
                const sm = p.success_metrics || {};
                let html = '';
                if (kpis.length) {
                    html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:10px">KPIs & Wirkungsmessung</div>';
                    kpis.forEach(k => {
                        html += `<div style="padding:12px 14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:6px">
                            <div style="display:flex;align-items:center;gap:8px">
                                <span style="font-size:13px;font-weight:600;color:white">${k.name||k.kpi_id||''}</span>
                                ${k.target ? `<span style="font-size:10px;padding:2px 8px;border-radius:6px;background:rgba(52,211,153,0.1);color:#34d399">Ziel: ${k.target}</span>` : ''}
                            </div>
                            ${k.description ? `<div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px">${k.description}</div>` : ''}
                        </div>`;
                    });
                }
                if (!html) {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Noch keine Learnings oder KPIs erfasst.<br>Wird nach Projektabschluss / Meilensteinen befüllt.</div>';
                }
                document.getElementById('prjLearningsContent').innerHTML = html;
            }
        }

        function prjAddMeeting() { prjStartEdit('meetings'); }

        // ════════════════════════════════════════════════
        // PROJECT EDIT SYSTEM
        // ════════════════════════════════════════════════
        let prjEditMode = false;

        const prjInputStyle = 'width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;font-family:inherit;resize:vertical;outline:none;';
        const prjBtnSave = 'padding:8px 20px;background:linear-gradient(135deg,#34d399,#2A7F8E);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer;';
        const prjBtnCancel = 'padding:8px 20px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:13px;cursor:pointer;';
        const prjFieldLabel = 'font-size:11px;font-weight:600;color:rgba(255,255,255,0.4);margin-bottom:4px;';

        function prjStartEdit(tab) {
            prjEditMode = true;
            const d = prjLandingData;
            const p = d.project || {};

            if (tab === 'auftrag') {
                const obj = p.objective || {};
                const scope = p.scope || {};
                const project = p.project || {};
                const fs = p.fehradvice_scope || {};
                document.getElementById('prjAuftragContent').innerHTML = `
                    <div style="display:flex;flex-direction:column;gap:16px">
                        <div><div style="${prjFieldLabel}">Beratungsziel</div>
                            <textarea id="prjEditObjSummary" style="${prjInputStyle}min-height:80px">${obj.summary || project.description || ''}</textarea></div>
                        <div><div style="${prjFieldLabel}">Core Insight</div>
                            <input id="prjEditCoreInsight" style="${prjInputStyle}" value="${(obj.core_insight||'').replace(/"/g,'&quot;')}" placeholder="Zentrale Erkenntnis…"></div>
                        <div><div style="${prjFieldLabel}">In-Scope (eine Zeile pro Punkt)</div>
                            <textarea id="prjEditInScope" style="${prjInputStyle}min-height:80px">${(scope.in_scope || fs.deliverables || []).map(s => typeof s === 'string' ? s : s.name || '').join('\n')}</textarea></div>
                        <div><div style="${prjFieldLabel}">Out-of-Scope (eine Zeile pro Punkt)</div>
                            <textarea id="prjEditOutScope" style="${prjInputStyle}min-height:60px">${(scope.out_of_scope || []).join('\n')}</textarea></div>
                        <div><div style="${prjFieldLabel}">Behavioral Objectives (eine Zeile pro Ziel)</div>
                            <textarea id="prjEditBehObj" style="${prjInputStyle}min-height:60px">${(fs.behavioral_objectives || []).join('\n')}</textarea></div>
                        <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:8px">
                            <button onclick="prjCancelEdit('auftrag')" style="${prjBtnCancel}">Abbrechen</button>
                            <button onclick="prjSaveEdit('auftrag')" style="${prjBtnSave}">💾 Speichern</button>
                        </div>
                    </div>`;
            }

            else if (tab === 'planung') {
                const tl = Array.isArray(p.timeline) ? p.timeline : [];
                const rows = tl.map((m,i) => `
                    <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px" data-ms="${i}">
                        <input style="${prjInputStyle}width:120px;flex-shrink:0" value="${m.date||''}" placeholder="YYYY-MM-DD">
                        <input style="${prjInputStyle}flex:1" value="${(m.milestone||m.name||'').replace(/"/g,'&quot;')}" placeholder="Milestone">
                        <select style="${prjInputStyle}width:110px;flex-shrink:0"><option ${m.status==='planned'?'selected':''}>planned</option><option ${m.status==='done'?'selected':''}>done</option><option ${m.status==='HEUTE'?'selected':''}>HEUTE</option></select>
                        <button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(248,113,113,0.6);cursor:pointer;font-size:16px">✕</button>
                    </div>`).join('');
                document.getElementById('prjPlanungContent').innerHTML = `
                    <div id="prjEditMilestones">${rows}</div>
                    <button onclick="prjAddMilestone()" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:12px;cursor:pointer;margin:10px 0">+ Milestone</button>
                    <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:8px">
                        <button onclick="prjCancelEdit('planung')" style="${prjBtnCancel}">Abbrechen</button>
                        <button onclick="prjSaveEdit('planung')" style="${prjBtnSave}">💾 Speichern</button>
                    </div>`;
            }

            else if (tab === 'meetings') {
                const now = new Date().toISOString().split('T')[0];
                document.getElementById('prjMeetingsContent').innerHTML += `
                    <div style="background:rgba(42,127,142,0.05);border:1px solid rgba(42,127,142,0.15);border-radius:10px;padding:16px;margin-top:12px">
                        <div style="font-size:13px;font-weight:600;color:var(--accent-light);margin-bottom:12px">Neues Meeting</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                            <div><div style="${prjFieldLabel}">Datum</div><input id="prjNewMeetDate" type="date" value="${now}" style="${prjInputStyle}"></div>
                            <div><div style="${prjFieldLabel}">Typ</div><select id="prjNewMeetType" style="${prjInputStyle}"><option>workshop</option><option>call</option><option>presentation</option><option>review</option><option>kickoff</option><option>offsite</option></select></div>
                            <div><div style="${prjFieldLabel}">Zweck / Titel</div><input id="prjNewMeetPurpose" style="${prjInputStyle}" placeholder="Zweck des Meetings…"></div>
                            <div><div style="${prjFieldLabel}">Modus</div><select id="prjNewMeetMode" style="${prjInputStyle}"><option>in-person</option><option>remote</option><option>hybrid</option></select></div>
                        </div>
                        <div style="margin-top:10px"><div style="${prjFieldLabel}">Notizen</div><textarea id="prjNewMeetNotes" style="${prjInputStyle}min-height:60px" placeholder="Agenda, Teilnehmer, Ergebnisse…"></textarea></div>
                        <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:10px">
                            <button onclick="prjCancelEdit('meetings')" style="${prjBtnCancel}">Abbrechen</button>
                            <button onclick="prjSaveEdit('meetings')" style="${prjBtnSave}">💾 Meeting speichern</button>
                        </div>
                    </div>`;
            }

            else if (tab === 'deliverables') {
                const deliverables = p.deliverables || p.final_deliverables || (p.fehradvice_scope||{}).deliverables || [];
                const rows = deliverables.map((d,i) => {
                    const name = typeof d === 'string' ? d : d.name || d.id || '';
                    const desc = typeof d === 'object' ? d.description || '' : '';
                    return `<div style="display:flex;gap:8px;align-items:start;margin-bottom:8px" data-del="${i}">
                        <div style="flex:1"><input style="${prjInputStyle}" value="${name.replace(/"/g,'&quot;')}" placeholder="Name"><input style="${prjInputStyle}margin-top:4px;font-size:11px" value="${desc.replace(/"/g,'&quot;')}" placeholder="Beschreibung (optional)"></div>
                        <button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(248,113,113,0.6);cursor:pointer;font-size:16px;margin-top:8px">✕</button>
                    </div>`;
                }).join('');
                document.getElementById('prjDeliverablesContent').innerHTML = `
                    <div id="prjEditDeliverables">${rows}</div>
                    <button onclick="prjAddDeliverable()" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:12px;cursor:pointer;margin:10px 0">+ Deliverable</button>
                    <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:8px">
                        <button onclick="prjCancelEdit('deliverables')" style="${prjBtnCancel}">Abbrechen</button>
                        <button onclick="prjSaveEdit('deliverables')" style="${prjBtnSave}">💾 Speichern</button>
                    </div>`;
            }

            else if (tab === 'risiken') {
                const risks = p.risks || [];
                const rows = risks.map((r,i) => {
                    const desc = typeof r === 'string' ? r : r.description || '';
                    const mit = typeof r === 'object' ? r.mitigation || '' : '';
                    return `<div style="display:flex;gap:8px;align-items:start;margin-bottom:8px;padding:10px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px" data-risk="${i}">
                        <div style="flex:1"><input style="${prjInputStyle}" value="${desc.replace(/"/g,'&quot;')}" placeholder="Risiko-Beschreibung"><input style="${prjInputStyle}margin-top:4px;font-size:11px" value="${mit.replace(/"/g,'&quot;')}" placeholder="Mitigation"></div>
                        <button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(248,113,113,0.6);cursor:pointer;font-size:16px;margin-top:8px">✕</button>
                    </div>`;
                }).join('');
                document.getElementById('prjRisikenContent').innerHTML = `
                    <div id="prjEditRisiken">${rows}</div>
                    <button onclick="prjAddRisk()" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:12px;cursor:pointer;margin:10px 0">+ Risiko</button>
                    <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:8px">
                        <button onclick="prjCancelEdit('risiken')" style="${prjBtnCancel}">Abbrechen</button>
                        <button onclick="prjSaveEdit('risiken')" style="${prjBtnSave}">💾 Speichern</button>
                    </div>`;
            }

            else if (tab === 'budget') {
                const tl = (typeof p.timeline === 'object' && !Array.isArray(p.timeline)) ? p.timeline : {};
                document.getElementById('prjBudgetContent').innerHTML = `
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                        <div><div style="${prjFieldLabel}">Budget (CHF)</div><input id="prjEditBudgetCHF" type="number" style="${prjInputStyle}" value="${tl.budget_chf||''}"></div>
                        <div><div style="${prjFieldLabel}">Abrechnungsmodell</div><select id="prjEditBilling" style="${prjInputStyle}"><option value="">–</option><option ${tl.billing_type==='fixed'?'selected':''} value="fixed">Fixpreis</option><option ${tl.billing_type==='time_material'?'selected':''} value="time_material">Time & Material</option><option ${tl.billing_type==='retainer'?'selected':''} value="retainer">Retainer</option></select></div>
                    </div>
                    <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:16px">
                        <button onclick="prjCancelEdit('budget')" style="${prjBtnCancel}">Abbrechen</button>
                        <button onclick="prjSaveEdit('budget')" style="${prjBtnSave}">💾 Speichern</button>
                    </div>`;
            }
        }

        function prjAddMilestone() {
            const el = document.getElementById('prjEditMilestones');
            if (!el) return;
            el.insertAdjacentHTML('beforeend', `
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
                    <input style="${prjInputStyle}width:120px;flex-shrink:0" placeholder="YYYY-MM-DD">
                    <input style="${prjInputStyle}flex:1" placeholder="Milestone">
                    <select style="${prjInputStyle}width:110px;flex-shrink:0"><option>planned</option><option>done</option></select>
                    <button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(248,113,113,0.6);cursor:pointer;font-size:16px">✕</button>
                </div>`);
        }

        function prjAddDeliverable() {
            const el = document.getElementById('prjEditDeliverables');
            if (!el) return;
            el.insertAdjacentHTML('beforeend', `
                <div style="display:flex;gap:8px;align-items:start;margin-bottom:8px">
                    <div style="flex:1"><input style="${prjInputStyle}" placeholder="Name"><input style="${prjInputStyle}margin-top:4px;font-size:11px" placeholder="Beschreibung (optional)"></div>
                    <button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(248,113,113,0.6);cursor:pointer;font-size:16px;margin-top:8px">✕</button>
                </div>`);
        }

        async function prjLoadDeliverableFiles() {
            const container = document.getElementById('prjDeliverableFiles');
            if (!container || !currentProjectSlug) return;
            try {
                const r = await fetch(`${API}/projects/${currentProjectSlug}/deliverables/files`, {headers: H()});
                const data = await r.json();
                const files = data.files || [];
                if (!files.length) {
                    container.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.25);font-size:12px;padding:16px">Noch keine Dateien hochgeladen.</div>';
                    return;
                }
                const extIcons = {pdf:'📕',docx:'📄',pptx:'📊',xlsx:'📈',txt:'📝',md:'📝',csv:'📊',json:'🔧',png:'🖼️',jpg:'🖼️',jpeg:'🖼️',zip:'📦'};
                container.innerHTML = files.map(f => {
                    const ext = f.name.split('.').pop().toLowerCase();
                    const icon = extIcons[ext] || '📎';
                    const sizeStr = f.size > 1024*1024 ? (f.size/1024/1024).toFixed(1)+' MB' : f.size > 1024 ? Math.round(f.size/1024)+' KB' : f.size+' B';
                    return `<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:5px">
                        <span style="font-size:16px">${icon}</span>
                        <div style="flex:1;min-width:0">
                            <div style="font-size:13px;color:rgba(255,255,255,0.8);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${f.name}</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.3)">${sizeStr}</div>
                        </div>
                        ${f.html_url ? `<a href="${f.html_url}" target="_blank" style="font-size:11px;color:var(--accent-light);text-decoration:none;flex-shrink:0" title="Auf GitHub öffnen">↗</a>` : ''}
                        <button onclick="prjDeleteDeliverableFile('${f.name.replace(/'/g,"\\'")}')" style="background:none;border:none;color:rgba(248,113,113,0.5);cursor:pointer;font-size:14px;flex-shrink:0" title="Löschen">✕</button>
                    </div>`;
                }).join('');
            } catch(e) {
                container.innerHTML = '<div style="text-align:center;color:rgba(248,113,113,0.5);font-size:12px;padding:12px">Fehler beim Laden der Dateien.</div>';
            }
        }

        async function prjDeliverableUpload(input) {
            if (!input.files.length || !currentProjectSlug) return;
            const container = document.getElementById('prjDeliverableFiles');
            const origHtml = container.innerHTML;
            for (const file of input.files) {
                const fd = new FormData();
                fd.append('file', file);
                container.insertAdjacentHTML('afterbegin', `<div id="prjDelUploadProg" style="padding:8px 14px;background:rgba(42,127,142,0.08);border:1px solid rgba(42,127,142,0.2);border-radius:8px;margin-bottom:5px;font-size:12px;color:var(--accent-light)">⏳ Lade hoch: ${file.name}...</div>`);
                try {
                    const r = await fetch(`${API}/projects/${currentProjectSlug}/deliverables/upload`, {
                        method: 'POST', headers: {'Authorization': `Bearer ${authToken}`}, body: fd
                    });
                    const prog = document.getElementById('prjDelUploadProg');
                    if (prog) prog.remove();
                    if (r.ok) {
                        showToast(`${file.name} hochgeladen`, 'success');
                    } else {
                        const err = await r.json().catch(() => ({}));
                        showToast(err.detail || 'Upload fehlgeschlagen', 'error');
                    }
                } catch(e) {
                    const prog = document.getElementById('prjDelUploadProg');
                    if (prog) prog.remove();
                    showToast(`Fehler: ${e.message}`, 'error');
                }
            }
            input.value = '';
            prjLoadDeliverableFiles();
        }

        async function prjDeleteDeliverableFile(filename) {
            if (!await bxConfirm(`Datei "${filename}" wirklich löschen?`, {title:'Datei löschen', icon:'🗑️', confirmText:'Löschen', danger:true})) return;
            try {
                const r = await fetch(`${API}/projects/${currentProjectSlug}/deliverables/files/${encodeURIComponent(filename)}`, {
                    method: 'DELETE', headers: H()
                });
                if (r.ok) {
                    showToast(`${filename} gelöscht`, 'success');
                    prjLoadDeliverableFiles();
                } else {
                    showToast('Löschen fehlgeschlagen', 'error');
                }
            } catch(e) { showToast(`Fehler: ${e.message}`, 'error'); }
        }

        function prjAddRisk() {
            const el = document.getElementById('prjEditRisiken');
            if (!el) return;
            el.insertAdjacentHTML('beforeend', `
                <div style="display:flex;gap:8px;align-items:start;margin-bottom:8px;padding:10px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px">
                    <div style="flex:1"><input style="${prjInputStyle}" placeholder="Risiko-Beschreibung"><input style="${prjInputStyle}margin-top:4px;font-size:11px" placeholder="Mitigation"></div>
                    <button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(248,113,113,0.6);cursor:pointer;font-size:16px;margin-top:8px">✕</button>
                </div>`);
        }

        function prjCancelEdit(tab) {
            prjEditMode = false;
            prjRenderTab(tab);
        }

        async function prjSyncGitHub() {
            try {
                const resp = await fetch(`${API}/projects/${prjCurrentSlug}/sync`, { method:'POST', headers:H() });
                const r = await resp.json();
                if (r.synced?.length) showToast(`${r.synced.length} Sektionen nach GitHub synchronisiert`, 'success');
                else if (r.failed?.length) showToast(`GitHub-Sync fehlgeschlagen: ${r.failed.map(f=>f.section).join(', ')}`, 'error');
                else showToast('Alles bereits synchronisiert', 'success');
                // Reload
                const resp2 = await fetch(`${API}/projects/${prjCurrentSlug}/landing`, { headers: H() });
                prjLandingData = await resp2.json();
                prjRenderLanding();
                prjSwitchTab(prjActiveTab);
            } catch(e) { showToast('Sync-Fehler: '+e.message,'error'); }
        }

        async function prjSaveEdit(tab) {
            let section = '', data = {};

            if (tab === 'auftrag') {
                const summary = document.getElementById('prjEditObjSummary')?.value.trim() || '';
                const insight = document.getElementById('prjEditCoreInsight')?.value.trim() || '';
                const inScope = document.getElementById('prjEditInScope')?.value.split('\n').map(s=>s.trim()).filter(Boolean) || [];
                const outScope = document.getElementById('prjEditOutScope')?.value.split('\n').map(s=>s.trim()).filter(Boolean) || [];
                const behObj = document.getElementById('prjEditBehObj')?.value.split('\n').map(s=>s.trim()).filter(Boolean) || [];
                // Save to multiple sections
                try {
                    await fetch(`${API}/projects/${prjCurrentSlug}`, { method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({section:'objective', data:{summary, core_insight:insight}})});
                    await fetch(`${API}/projects/${prjCurrentSlug}`, { method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({section:'scope', data:{in_scope:inScope, out_of_scope:outScope}})});
                    if (behObj.length) await fetch(`${API}/projects/${prjCurrentSlug}`, { method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({section:'fehradvice_scope', data:{behavioral_objectives:behObj}})});
                    showToast('Beratungsauftrag gespeichert', 'success');
                } catch(e) { showToast('Fehler: '+e.message,'error'); return; }
            }

            else if (tab === 'planung') {
                const rows = document.querySelectorAll('#prjEditMilestones > div');
                const milestones = [];
                rows.forEach(r => {
                    const inputs = r.querySelectorAll('input, select');
                    if (inputs[0]?.value || inputs[1]?.value) {
                        milestones.push({date:inputs[0].value, milestone:inputs[1].value, status:inputs[2].value});
                    }
                });
                section = 'timeline'; data = milestones;
            }

            else if (tab === 'meetings') {
                const date = document.getElementById('prjNewMeetDate')?.value || '';
                const type = document.getElementById('prjNewMeetType')?.value || '';
                const purpose = document.getElementById('prjNewMeetPurpose')?.value || '';
                const mode = document.getElementById('prjNewMeetMode')?.value || '';
                const notes = document.getElementById('prjNewMeetNotes')?.value || '';
                if (!purpose) { showToast('Bitte Zweck eingeben','error'); return; }
                const newSession = {id:`SES-${Date.now()}`, date, type, purpose, mode, status:'scheduled', notes};
                section = 'sessions'; data = {action:'add', session:newSession};
            }

            else if (tab === 'deliverables') {
                const rows = document.querySelectorAll('#prjEditDeliverables > div');
                const items = [];
                rows.forEach(r => {
                    const inputs = r.querySelectorAll('input');
                    if (inputs[0]?.value) items.push({name:inputs[0].value, description:inputs[1]?.value||''});
                });
                section = 'deliverables'; data = items;
            }

            else if (tab === 'risiken') {
                const rows = document.querySelectorAll('#prjEditRisiken > div');
                const items = [];
                rows.forEach(r => {
                    const inputs = r.querySelectorAll('input');
                    if (inputs[0]?.value) items.push({description:inputs[0].value, mitigation:inputs[1]?.value||''});
                });
                section = 'risks'; data = items;
            }

            else if (tab === 'budget') {
                const budgetCHF = document.getElementById('prjEditBudgetCHF')?.value || '';
                const billing = document.getElementById('prjEditBilling')?.value || '';
                section = 'budget'; data = {};
                if (budgetCHF) data.budget_chf = parseInt(budgetCHF);
                if (billing) data.billing_type = billing;
            }

            // Send to API (unless auftrag which was already sent above)
            if (section && tab !== 'auftrag') {
                try {
                    const resp = await fetch(`${API}/projects/${prjCurrentSlug}`, {
                        method: 'PUT', headers: {...H(), 'Content-Type':'application/json'},
                        body: JSON.stringify({section, data})
                    });
                    if (!resp.ok) { const e = await resp.json(); throw new Error(e.error || 'Fehler'); }
                    showToast(`${tab} gespeichert → GitHub`, 'success');
                } catch(e) { showToast('Fehler: '+e.message,'error'); return; }
            }

            // Reload project data
            prjEditMode = false;
            try {
                const resp = await fetch(`${API}/projects/${prjCurrentSlug}/landing`, { headers: H() });
                prjLandingData = await resp.json();
                prjRenderLanding();
                prjSwitchTab(tab);
            } catch(e) { prjRenderTab(tab); }
        }

        let crmCompanyFilter = null;

        async function crmChangeStage(dealId, ns) {
            try { await fetch(`${API}/crm/deals/${dealId}`, { method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({stage:ns}) }); crmCloseDrawer(); crmLoad(); showToast('Stage → '+ns, 'success'); } catch(e) { showToast('Fehler','error'); }
        }

        async function crmAddNote(dealId) {
            const note = document.getElementById('crmQuickNote')?.value.trim();
            if (!note) return;
            try {
                await fetch(`${API}/crm/activities`, { method:'POST', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({deal_id:dealId,type:'note',subject:note}) });
                const deal = crmDeals.find(d=>d.id===dealId);
                const ts = new Date().toLocaleString('de-CH');
                await fetch(`${API}/crm/deals/${dealId}`, { method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({notes:(deal?.notes||'')+`\n[${ts}] ${note}`}) });
                showToast('Notiz ✓','success'); crmLoad(); crmCloseDrawer();
            } catch(e) { showToast('Fehler','error'); }
        }

        async function crmDeleteDeal(id) {
            if (!await bxConfirm('Lead wirklich löschen?', {title:'Lead löschen', icon:'🗑️', confirmText:'Endgültig löschen', danger:true})) return;
            try { await fetch(`${API}/crm/deals/${id}`,{method:'DELETE',headers:H()}); crmCloseDrawer(); crmLoad(); showToast('Lead gelöscht','success'); } catch(e) { showToast('Fehler','error'); }
        }

        async function crmSyncGithub() {
            const btn = document.getElementById('crmSyncBtn');
            btn.disabled=true; btn.textContent='⏳ Synchronisiere...';
            try {
                const r = await fetch(`${API}/crm/sync-github`, { method:'POST', headers:H() });
                const data = await r.json();
                if (r.ok) { crmLastSync = new Date(); showToast(`Sync: ${data.stats.deals} Leads, ${data.stats.companies} Firmen ✓`, 'success'); crmLoad(); }
                else throw new Error(data.detail||'failed');
            } catch(e) { showToast('Sync fehlgeschlagen: '+e.message, 'error'); }
            btn.disabled=false; btn.textContent='🔄 Synchronisieren';
        }

        // ═══ UPLOAD PRIORITY TOP 100 ═══
        let _upData = [];
        let _upFilter = 'all';

        async function loadUploadPriority() {
            const wrapper = document.getElementById('upTableWrapper');
            if (!wrapper) return;
            wrapper.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.3)"><div class="loading-spinner" style="width:20px;height:20px;border-width:2px;margin:0 auto 10px"></div>Lade Priority-Liste...</div>';
            try {
                const r = await fetch(`${API}/papers/upload-priority`, {headers: H()});
                if (!r.ok) throw new Error('Fehler');
                const data = await r.json();
                _upData = data.papers || data;
                renderUploadPriority();
                document.getElementById('upMethodology').style.display = 'block';
            } catch(e) {
                wrapper.innerHTML = `<div style="text-align:center;padding:40px;color:rgba(248,113,113,0.6)">Fehler: ${e.message}</div>`;
            }
        }

        function upFilter(filter, btn) {
            _upFilter = filter;
            document.querySelectorAll('#upFilterBar .up-filter').forEach(b => {
                b.classList.remove('active');
                b.style.background = 'transparent';
            });
            if (btn) { btn.classList.add('active'); btn.style.background = 'rgba(255,255,255,0.06)'; }
            renderUploadPriority();
        }

        function renderUploadPriority() {
            const wrapper = document.getElementById('upTableWrapper');
            if (!wrapper || !_upData.length) return;

            let papers = _upData;
            if (_upFilter === 'I5') papers = papers.filter(p => p.integration_level === 'I5');
            else if (_upFilter === 'I4') papers = papers.filter(p => p.integration_level === 'I4');
            else if (_upFilter === 'I3') papers = papers.filter(p => p.integration_level === 'I3');
            else if (_upFilter === 'doi') papers = papers.filter(p => p.doi || p.doi_strategy);

            // Stats
            const stats = document.getElementById('upStatsBar');
            if (stats) {
                const ilCounts = {}, clCounts = {};
                let doiCount = 0;
                _upData.forEach(p => {
                    ilCounts[p.integration_level] = (ilCounts[p.integration_level]||0) + 1;
                    clCounts[p.content_level] = (clCounts[p.content_level]||0) + 1;
                    if (p.doi || p.doi_strategy) doiCount++;
                });
                stats.innerHTML = Object.entries(ilCounts).sort().map(([k,v]) => {
                    const colors = {I5:'139,92,246', I4:'59,130,246', I3:'52,211,153', I2:'251,191,36', I1:'255,255,255'};
                    const c = colors[k] || '255,255,255';
                    return `<span style="padding:3px 8px;border-radius:4px;font-size:10px;background:rgba(${c},0.1);color:rgba(${c},0.7);border:1px solid rgba(${c},0.15)">${v}× ${k}</span>`;
                }).join('') + `<span style="padding:3px 8px;border-radius:4px;font-size:10px;background:rgba(251,191,36,0.1);color:rgba(251,191,36,0.7);border:1px solid rgba(251,191,36,0.15)">${doiCount} DOI</span>`;
            }

            if (!papers.length) {
                wrapper.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.3)">Keine Papers in diesem Filter.</div>';
                return;
            }

            const ilColors = {I5:'139,92,246', I4:'59,130,246', I3:'52,211,153', I2:'251,191,36', I1:'180,180,180'};
            const clColors = {L0:'248,113,113', L1:'251,191,36', L2:'52,211,153', L3:'59,130,246'};

            let html = `<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px">
                <thead><tr style="border-bottom:1px solid var(--border)">
                    <th style="padding:8px 6px;text-align:left;color:rgba(255,255,255,0.4);font-weight:600;white-space:nowrap">#</th>
                    <th style="padding:8px 6px;text-align:left;color:rgba(255,255,255,0.4);font-weight:600">Paper</th>
                    <th style="padding:8px 6px;text-align:center;color:rgba(255,255,255,0.4);font-weight:600">IL</th>
                    <th style="padding:8px 6px;text-align:center;color:rgba(255,255,255,0.4);font-weight:600">CL</th>
                    <th style="padding:8px 6px;text-align:center;color:rgba(255,255,255,0.4);font-weight:600">Score</th>
                    <th style="padding:8px 6px;text-align:center;color:rgba(255,255,255,0.4);font-weight:600">DOI</th>
                    <th style="padding:8px 6px;text-align:center;color:rgba(255,255,255,0.4);font-weight:600">Cases</th>
                    <th style="padding:8px 6px;text-align:right;color:rgba(255,255,255,0.4);font-weight:600">Aktion</th>
                </tr></thead><tbody>`;

            papers.forEach(p => {
                const ilC = ilColors[p.integration_level] || '180,180,180';
                const clC = clColors[p.content_level] || '180,180,180';
                const author = p.first_author || p.bibtex_key.replace(/\d+.*/, '');
                const shortTitle = (p.title || '').length > 60 ? p.title.slice(0,57)+'...' : p.title;
                const doiLink = p.doi ? `<a href="https://doi.org/${p.doi}" target="_blank" style="color:rgba(251,191,36,0.7);text-decoration:none;font-size:10px" title="${p.doi}">🔗</a>` : (p.doi_strategy ? `<span style="font-size:10px;color:rgba(255,255,255,0.25)" title="DOI-Strategie: ${p.doi_strategy}">◐</span>` : '<span style="font-size:10px;color:rgba(255,255,255,0.15)">–</span>');
                
                html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.1s;cursor:pointer" onclick="upGoToUpload(${p.rank})" onmouseenter="this.style.background='rgba(255,255,255,0.03)'" onmouseleave="this.style.background='transparent'" title="Klicken → Upload-Bereich">
                    <td style="padding:8px 6px;color:rgba(255,255,255,0.3);font-weight:600">${p.rank}</td>
                    <td style="padding:8px 6px">
                        <div style="font-size:12px;color:rgba(255,255,255,0.8);font-weight:500">${author} (${p.year || '?'})</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.35);margin-top:2px;max-width:400px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${(p.title||'').replace(/"/g,'&quot;')}">${shortTitle}</div>
                        ${p.journal ? `<div style="font-size:10px;color:rgba(255,255,255,0.2);margin-top:1px;font-style:italic">${p.journal}</div>` : ''}
                    </td>
                    <td style="padding:8px 6px;text-align:center"><span style="padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;background:rgba(${ilC},0.12);color:rgba(${ilC},0.8);border:1px solid rgba(${ilC},0.2)">${p.integration_level}</span></td>
                    <td style="padding:8px 6px;text-align:center"><span style="padding:2px 8px;border-radius:4px;font-size:10px;background:rgba(${clC},0.12);color:rgba(${clC},0.8);border:1px solid rgba(${clC},0.2)">${p.content_level}</span></td>
                    <td style="padding:8px 6px;text-align:center;font-size:11px;color:rgba(255,255,255,0.5);font-weight:600">${p.priority_score}</td>
                    <td style="padding:8px 6px;text-align:center">${doiLink}</td>
                    <td style="padding:8px 6px;text-align:center;font-size:11px;color:rgba(255,255,255,${p.linked_cases > 0 ? '0.6' : '0.15'})">${p.linked_cases || '–'}</td>
                    <td style="padding:8px 6px;text-align:right" onclick="event.stopPropagation()">
                        ${p.doi ? `<a href="https://doi.org/${p.doi}" target="_blank" style="padding:3px 10px;border-radius:6px;border:1px solid rgba(52,211,153,0.2);background:transparent;color:rgba(52,211,153,0.6);font-size:10px;text-decoration:none;cursor:pointer" title="Paper via DOI finden">📥 DOI</a>` : `<span style="font-size:10px;color:rgba(255,255,255,0.2)">Manuell</span>`}
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            html += `<div style="text-align:center;padding:8px;font-size:11px;color:rgba(255,255,255,0.2)">${papers.length} von ${_upData.length} Papers</div>`;
            wrapper.innerHTML = html;
        }

        function upGoToUpload(rank) {
            const p = _upData.find(x => x.rank === rank);
            if (!p) return;
            // Store current paper context
            window._upCurrentPaper = p;
            // Switch to Research Papers DB
            const researchDb = document.querySelector('[data-db="research"]');
            if (researchDb) selectDB(researchDb);
            // Switch to upload section
            showSection('upload', document.querySelector('[data-section="upload"]'));
            // Pre-fill title
            const titleInput = document.getElementById('textTitle');
            const author = p.first_author || p.bibtex_key.replace(/\d+.*/, '');
            if (titleInput) titleInput.value = `${author} (${p.year || '?'}) – ${p.title || p.bibtex_key}`;
            // Show PDF search panel
            upShowPdfSearch(p);
        }

        async function upShowPdfSearch(p) {
            const author = p.first_author || p.bibtex_key.replace(/\d+.*/, '');
            // Create or get the search panel
            let panel = document.getElementById('upPdfSearchPanel');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'upPdfSearchPanel';
                panel.style.cssText = 'margin:16px 0;padding:16px;background:rgba(42,127,142,0.06);border:1px solid rgba(42,127,142,0.2);border-radius:12px';
                const dropZone = document.getElementById('dropZone');
                if (dropZone) dropZone.parentNode.insertBefore(panel, dropZone);
                else return;
            }
            panel.style.display = 'block';
            panel.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <div>
                        <div style="font-size:13px;font-weight:600;color:var(--accent)">🔍 PDF suchen: ${author} (${p.year || '?'})</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.35);margin-top:2px">${(p.title||'').slice(0,80)}${p.title && p.title.length > 80 ? '...' : ''}</div>
                    </div>
                    <button onclick="document.getElementById('upPdfSearchPanel').style.display='none'" style="background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:16px">✕</button>
                </div>
                <div id="upPdfResults" style="min-height:40px">
                    <div style="display:flex;align-items:center;gap:8px;padding:12px;color:rgba(255,255,255,0.4)">
                        <div class="loading-spinner" style="width:14px;height:14px;border-width:2px"></div>
                        Suche in Unpaywall, Semantic Scholar, CORE...
                    </div>
                </div>`;

            // Scroll to panel
            setTimeout(() => panel.scrollIntoView({behavior:'smooth', block:'center'}), 200);

            // Call API
            try {
                const r = await fetch(`${API}/papers/find-pdf`, {
                    method: 'POST', headers: {...H(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({doi: p.doi, title: p.title, author: author, year: p.year})
                });
                const data = await r.json();
                upRenderPdfResults(data, p);
            } catch(e) {
                document.getElementById('upPdfResults').innerHTML = `<div style="padding:12px;color:rgba(248,113,113,0.6);font-size:12px">Fehler: ${e.message}</div>`;
            }
        }

        function upRenderPdfResults(data, paper) {
            const container = document.getElementById('upPdfResults');
            if (!container) return;
            const pdfs = (data.results || []).filter(r => r.type === 'pdf');
            const landings = (data.results || []).filter(r => r.type === 'landing');
            const searches = (data.results || []).filter(r => r.type === 'search');
            const author = paper.first_author || paper.bibtex_key.replace(/\d+.*/, '');

            let html = '';
            if (pdfs.length > 0) {
                html += `<div style="padding:8px 12px;background:rgba(52,211,153,0.08);border-radius:8px;margin-bottom:8px">
                    <div style="font-size:12px;font-weight:600;color:rgba(52,211,153,0.8);margin-bottom:6px">✅ ${pdfs.length} PDF-Quelle${pdfs.length > 1 ? 'n' : ''} gefunden</div>`;
                pdfs.forEach((r, i) => {
                    html += `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;${i > 0 ? 'border-top:1px solid rgba(255,255,255,0.04)' : ''}">
                        <span style="font-size:10px;color:rgba(255,255,255,0.35);min-width:60px">${r.source}</span>
                        <a href="${r.url}" target="_blank" style="font-size:11px;color:rgba(52,211,153,0.7);text-decoration:none;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${r.url}">${r.url.slice(0,60)}...</a>
                        <button onclick="upFetchAndUpload('${r.url.replace(/'/g, "\\'")}')" style="padding:4px 12px;border-radius:6px;border:1px solid rgba(52,211,153,0.3);background:rgba(52,211,153,0.1);color:rgba(52,211,153,0.8);font-size:10px;font-weight:600;cursor:pointer;white-space:nowrap">📥 Holen & Upload</button>
                    </div>`;
                });
                html += '</div>';
            } else {
                html += `<div style="padding:8px 12px;background:rgba(251,191,36,0.06);border-radius:8px;margin-bottom:8px">
                    <div style="font-size:12px;color:rgba(251,191,36,0.7)">⚠️ Kein Open-Access-PDF gefunden. Manuelle Suche nötig:</div>
                </div>`;
            }

            // Landing pages
            if (landings.length > 0) {
                html += `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px">`;
                landings.forEach(r => {
                    html += `<a href="${r.url}" target="_blank" style="padding:4px 10px;border-radius:6px;border:1px solid rgba(59,130,246,0.2);background:transparent;color:rgba(59,130,246,0.6);font-size:10px;text-decoration:none">🔗 ${r.source}</a>`;
                });
                html += '</div>';
            }

            // Search links
            if (searches.length > 0) {
                html += `<div style="display:flex;gap:6px;flex-wrap:wrap">`;
                searches.forEach(r => {
                    html += `<a href="${r.url}" target="_blank" style="padding:4px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:rgba(255,255,255,0.4);font-size:10px;text-decoration:none">🔍 ${r.source}</a>`;
                });
                html += '</div>';
            }

            container.innerHTML = html;
        }

        async function upFetchAndUpload(url) {
            const p = window._upCurrentPaper;
            if (!p) { showToast('Kein Paper-Kontext', 'error'); return; }
            const author = p.first_author || p.bibtex_key.replace(/\d+.*/, '');

            // Show loading
            const btn = event.target;
            const origText = btn.textContent;
            btn.textContent = '⏳ Lade...';
            btn.disabled = true;
            btn.style.opacity = '0.5';

            try {
                const r = await fetch(`${API}/papers/fetch-and-upload`, {
                    method: 'POST', headers: {...H(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({url, paper_id: p.paper_id, title: p.title, author, year: p.year, doi: p.doi})
                });
                const data = await r.json();
                if (data.ok) {
                    btn.textContent = '✅ In DB!';
                    btn.style.background = 'rgba(52,211,153,0.2)';
                    const sizeKB = (data.size/1024).toFixed(0);
                    const paperInfo = data.is_paper ? `📚 Paper (Score: ${data.paper_score})` : '📄 Dokument';
                    const extractInfo = data.extracted ? ` → ${data.extracted.author} (${data.extracted.year})` : '';
                    showToast(`✅ ${data.filename}\n${paperInfo}${extractInfo}\n${sizeKB} KB | ${(data.text_length/1000).toFixed(0)}k Zeichen | ${data.status}`, 'success');
                    // Show details below button
                    const info = document.createElement('div');
                    info.style.cssText = 'margin-top:4px;font-size:10px;color:rgba(52,211,153,0.5);line-height:1.4';
                    info.innerHTML = `✅ DB + GitHub + Embedding<br>${data.extracted ? data.extracted.author + ' (' + data.extracted.year + ')' : ''}`;
                    if (data.github_url || data.html_url) {
                        const link = document.createElement('a');
                        link.href = data.github_url || data.html_url;
                        link.target = '_blank';
                        link.style.cssText = 'display:inline;margin-left:4px;font-size:10px;color:rgba(52,211,153,0.7);text-decoration:none';
                        link.textContent = '↗ GitHub';
                        info.appendChild(link);
                    }
                    btn.parentNode.appendChild(info);
                } else if (data.duplicate) {
                    btn.textContent = '⚠️ Duplikat';
                    btn.style.background = 'rgba(251,191,36,0.2)';
                    btn.style.color = 'rgba(251,191,36,0.8)';
                    showToast(`⚠️ Bereits vorhanden: ${data.title || 'Dokument'}\n${data.message || ''}`, 'info');
                } else if (data.verified === false) {
                    btn.textContent = '❌ Falsches Paper';
                    btn.style.background = 'rgba(239,68,68,0.15)';
                    btn.style.color = 'rgba(239,68,68,0.8)';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    showToast(`❌ Title-Check: ${(data.match_ratio*100).toFixed(0)}% Match\n${data.message || 'PDF enthält nicht das erwartete Paper'}`, 'error');
                } else {
                    throw new Error(data.detail || 'Upload fehlgeschlagen');
                }
            } catch(e) {
                btn.textContent = origText;
                btn.disabled = false;
                btn.style.opacity = '1';
                showToast(`❌ ${e.message}`, 'error');
            }
        }

        async function loadStats() {
            try{const r=await fetch(`${API}/documents`,{headers:H()});if(r.status===401)return;const d=await r.json();
                document.getElementById('statDocs').textContent=d.length;document.getElementById('statKB').textContent=d.filter(x=>x.database_target==='knowledge_base').length;document.getElementById('statAxioms').textContent=d.filter(x=>x.database_target==='bcm_axioms').length;
            }catch(e){document.getElementById('statDocs').textContent='–';}
        }

        // ═══ PAPER FINDER ═══
        let _pfData = null;
        let _pfFilter = 'all';

        async function loadPaperFinder() {
            const grid = document.getElementById('pfResearcherGrid');
            if (!grid) return;
            if (_pfData) { renderPaperFinder(); return; }
            grid.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.3)"><div class="loading-spinner" style="width:20px;height:20px;border-width:2px;margin:0 auto 10px"></div>Lade Paper Finder Sources...</div>';
            try {
                const r = await fetch(`${API}/papers/sources`, {headers: H()});
                if (!r.ok) throw new Error('Fehler ' + r.status);
                _pfData = await r.json();
                renderPaperFinder();
            } catch(e) {
                grid.innerHTML = `<div style="text-align:center;padding:40px;color:rgba(248,113,113,0.6)">Fehler: ${e.message}</div>`;
            }
        }

        function pfSetFilter(filter, btn) {
            _pfFilter = filter;
            document.querySelectorAll('#pfFilterBar .pf-filter').forEach(b => {
                b.classList.remove('active');
                b.style.background = 'transparent';
            });
            if (btn) { btn.classList.add('active'); btn.style.background = 'rgba(255,255,255,0.06)'; }
            renderPaperFinder();
        }

        function renderPaperFinder() {
            if (!_pfData) return;
            const grid = document.getElementById('pfResearcherGrid');
            const stats = document.getElementById('pfStatsBar');
            const algo = document.getElementById('pfAlgoInfo');
            const filterBar = document.getElementById('pfFilterBar');
            const researchers = _pfData.researchers || {};
            const s = _pfData.stats || {};

            // Stats bar
            if (stats) {
                stats.innerHTML = `
                    <span style="padding:3px 8px;border-radius:4px;font-size:10px;background:rgba(52,211,153,0.1);color:rgba(52,211,153,0.7);border:1px solid rgba(52,211,153,0.15)">${s.total_verified_pdfs || 0} verified PDFs</span>
                    <span style="padding:3px 8px;border-radius:4px;font-size:10px;background:rgba(59,130,246,0.1);color:rgba(59,130,246,0.7);border:1px solid rgba(59,130,246,0.15)">${s.total_researchers || 0} Forscher</span>
                    <span style="padding:3px 8px;border-radius:4px;font-size:10px;background:rgba(139,92,246,0.1);color:rgba(139,92,246,0.7);border:1px solid rgba(139,92,246,0.15)">~${s.total_estimated_pdfs || 0} est. PDFs</span>`;
            }

            // Filter bar
            if (filterBar) {
                const fieldLabels = {all:'Alle',verified:'✅ Verified',discovered:'🔍 Discovered',behavioral_econ:'Behavioral Econ',experimental:'Experimental',psychology:'Psychology',neuro:'Neuro',labor:'Labor/Public',social_pref:'Social Pref',development:'Development',decision:'Decision Theory',info_econ:'Info Econ',market_design:'Market Design',policy:'Public Policy',org_econ:'Organizations',health:'Health',institutions:'Institutions',ai_econ:'AI+Econ',behavioral_finance:'Beh. Finance'};
                const fieldColors = {all:'255,255,255',verified:'52,211,153',discovered:'59,130,246',behavioral_econ:'251,191,36',experimental:'139,92,246',psychology:'248,113,113',neuro:'236,72,153',labor:'52,211,153',social_pref:'59,130,246',development:'251,191,36',decision:'139,92,246',info_econ:'168,85,247',market_design:'52,211,153',policy:'59,130,246',org_econ:'251,191,36',health:'248,113,113',institutions:'168,85,247',ai_econ:'52,211,153',behavioral_finance:'251,191,36'};
                const fields = s.fields || {};
                let filterHtml = '';
                ['all','verified','discovered'].forEach(f => {
                    const c = fieldColors[f]||'255,255,255';
                    const count = f==='all' ? Object.keys(researchers).length : f==='verified' ? (s.verified_researchers||0) : (s.discovered_researchers||0);
                    filterHtml += `<button class="pf-filter ${_pfFilter===f?'active':''}" onclick="pfSetFilter('${f}',this)" style="padding:4px 10px;border-radius:6px;border:1px solid rgba(${c},0.2);background:${_pfFilter===f?'rgba(255,255,255,0.06)':'transparent'};color:rgba(${c},0.7);font-size:10px;cursor:pointer">${fieldLabels[f]||f} (${count})</button>`;
                });
                filterHtml += '<span style="width:1px;height:16px;background:rgba(255,255,255,0.08);margin:0 4px"></span>';
                Object.entries(fields).sort((a,b)=>b[1]-a[1]).forEach(([f,count]) => {
                    if (f==='unknown') return;
                    const c = fieldColors[f]||'255,255,255';
                    filterHtml += `<button class="pf-filter ${_pfFilter===f?'active':''}" onclick="pfSetFilter('${f}',this)" style="padding:4px 10px;border-radius:6px;border:1px solid rgba(${c},0.15);background:${_pfFilter===f?'rgba(255,255,255,0.06)':'transparent'};color:rgba(${c},0.6);font-size:10px;cursor:pointer">${fieldLabels[f]||f} (${count})</button>`;
                });
                filterBar.style.display = 'flex';
                filterBar.innerHTML = filterHtml;
            }

            // Algorithm info
            if (algo && _pfData.algorithm) {
                algo.style.display = 'block';
                const a = _pfData.algorithm;
                document.getElementById('pfAlgoName').textContent = `Discovery Algorithm v${a.version} — ${a.name}`;
                const stepsEl = document.getElementById('pfAlgoSteps');
                if (a.pipeline && stepsEl) {
                    stepsEl.innerHTML = a.pipeline.map((step, i) => 
                        `<span style="padding:3px 10px;border-radius:6px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);color:rgba(255,255,255,0.5)">${i+1}. ${step.name}</span>`
                    ).join('<span style="color:rgba(255,255,255,0.15)">→</span>');
                }
            }

            // Filter researchers
            let entries = Object.entries(researchers);
            if (_pfFilter === 'verified') entries = entries.filter(([,r]) => r.tier === 'verified');
            else if (_pfFilter === 'discovered') entries = entries.filter(([,r]) => r.tier === 'discovered');
            else if (_pfFilter !== 'all') entries = entries.filter(([,r]) => r.field === _pfFilter);

            // Sort: verified first, then by count
            entries.sort((a,b) => {
                const aV = a[1].tier === 'verified' ? 1 : 0;
                const bV = b[1].tier === 'verified' ? 1 : 0;
                if (aV !== bV) return bV - aV;
                return (b[1].count||0) - (a[1].count||0);
            });

            const fieldColors2 = {behavioral_econ:'251,191,36',experimental:'139,92,246',psychology:'248,113,113',neuro:'236,72,153',labor:'52,211,153',social_pref:'59,130,246',development:'251,191,36',decision:'139,92,246',info_econ:'168,85,247',market_design:'52,211,153',policy:'59,130,246',org_econ:'251,191,36',health:'248,113,113',institutions:'168,85,247',ai_econ:'52,211,153',behavioral_finance:'251,191,36'};
            const fieldLabels2 = {behavioral_econ:'BE',experimental:'EXP',psychology:'PSY',neuro:'NEU',labor:'LAB',social_pref:'SOC',development:'DEV',decision:'DEC',info_econ:'INFO',market_design:'MKT',policy:'POL',org_econ:'ORG',health:'HLT',institutions:'INST',ai_econ:'AI',behavioral_finance:'FIN'};

            let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px">';
            entries.forEach(([key, r]) => {
                const isVerified = r.tier === 'verified';
                const isComplete = (r.status||'').includes('COMPLETE');
                const borderColor = isComplete ? 'rgba(52,211,153,0.25)' : isVerified ? 'rgba(59,130,246,0.2)' : 'rgba(255,255,255,0.05)';
                const bgColor = isComplete ? 'rgba(52,211,153,0.03)' : 'rgba(255,255,255,0.015)';
                const displayName = r.name || key.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
                const pdfCount = r.count || 0;
                const barWidth = Math.min(100, (pdfCount / 120) * 100);
                const fc = fieldColors2[r.field] || '255,255,255';
                const fl = fieldLabels2[r.field] || '';
                const inst = r.institution ? `<span style="font-size:9px;color:rgba(255,255,255,0.25)">${r.institution}</span>` : '';

                html += `<div onclick="pfShowDetail('${key}')" style="padding:12px 14px;background:${bgColor};border:1px solid ${borderColor};border-radius:10px;cursor:pointer;transition:all 0.15s" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='${borderColor}'">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <div style="font-size:12px;font-weight:600;color:rgba(255,255,255,${isVerified?'0.9':'0.6'})">${isComplete?'✅ ':isVerified?'📚 ':''}${displayName}</div>
                        <span style="padding:1px 6px;border-radius:3px;font-size:10px;font-weight:700;background:rgba(${pdfCount>50?'52,211,153':pdfCount>10?'59,130,246':'255,255,255'},0.1);color:rgba(${pdfCount>50?'52,211,153':pdfCount>10?'59,130,246':'255,255,255'},0.6)">${pdfCount}</span>
                    </div>
                    <div style="height:2px;background:rgba(255,255,255,0.04);border-radius:1px;margin-bottom:6px;overflow:hidden">
                        <div style="height:100%;width:${barWidth}%;background:rgba(${isComplete?'52,211,153':isVerified?'59,130,246':'255,255,255'},0.4);border-radius:1px"></div>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        ${fl ? `<span style="padding:1px 6px;border-radius:3px;font-size:8px;background:rgba(${fc},0.08);color:rgba(${fc},0.6);letter-spacing:0.5px">${fl}</span>` : '<span></span>'}
                        ${inst}
                    </div>
                </div>`;
            });
            html += '</div>';
            html += `<div style="text-align:center;padding:10px;font-size:11px;color:rgba(255,255,255,0.2)">${entries.length} von ${Object.keys(researchers).length} Forschern</div>`;
            grid.innerHTML = html;
        }

        async function pfShowDetail(key) {
            const panel = document.getElementById('pfDetailPanel');
            if (!panel || !_pfData) return;
            const r = _pfData.researchers[key];
            if (!r) return;
            
            panel.style.display = 'block';
            const name = key.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
            const isComplete = (r.status||'').includes('COMPLETE');
            const sources = r.primary_sources || {};
            const keyPapers = r.key_papers_for_ebf || [];
            const pdfs = r.verified_pdfs || [];

            let html = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <div>
                        <div style="font-size:16px;font-weight:700;color:white">${isComplete ? '✅ ' : '🔍 '}${name}</div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:2px">${r.count || 0} verifizierte PDFs — ${r.status || 'In Arbeit'}</div>
                    </div>
                    <button onclick="document.getElementById('pfDetailPanel').style.display='none'" style="background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:18px">✕</button>
                </div>`;

            // Primary sources
            if (Object.keys(sources).length > 0) {
                html += `<div style="margin-bottom:16px"><div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.5);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Primärquellen</div>`;
                Object.entries(sources).forEach(([sKey, sVal]) => {
                    const url = typeof sVal === 'string' ? sVal : (sVal.journal_articles || sVal.publications || sVal.url || sVal.base_url || '');
                    const desc = typeof sVal === 'object' ? (sVal.description || sVal.type || '') : '';
                    if (url) {
                        html += `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03)">
                            <span style="font-size:10px;color:rgba(255,255,255,0.35);min-width:80px">${sKey}</span>
                            <a href="${url}" target="_blank" style="font-size:11px;color:var(--accent);text-decoration:none;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${url}</a>
                        </div>`;
                    }
                });
                html += '</div>';
            }

            // Key papers for EBF
            if (keyPapers.length > 0) {
                html += `<div style="margin-bottom:16px"><div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.5);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Schlüssel-Papers für BCM/EBF</div>`;
                keyPapers.forEach(p => {
                    const stars = (p.match(/★/g) || []).length;
                    const starColor = stars >= 3 ? '139,92,246' : stars >= 2 ? '59,130,246' : '255,255,255';
                    html += `<div style="padding:4px 8px;margin-bottom:3px;font-size:11px;color:rgba(${starColor},0.7);background:rgba(${starColor},0.04);border-radius:4px">${p}</div>`;
                });
                html += '</div>';
            }

            // Verified PDFs (show first 15)
            if (pdfs.length > 0) {
                html += `<div><div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.5);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Verifizierte PDFs (${pdfs.length})</div>`;
                const showPdfs = pdfs.slice(0, 15);
                showPdfs.forEach(p => {
                    const title = p.t || p.title || '';
                    const url = p.u || p.url || '';
                    const doi = p.doi || '';
                    html += `<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.02)">
                        <div style="flex:1;font-size:11px;color:rgba(255,255,255,0.6);white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${title}">${title}</div>
                        <div style="display:flex;gap:4px">
                            ${url ? `<a href="${url}" target="_blank" style="padding:2px 8px;border-radius:4px;font-size:9px;background:rgba(52,211,153,0.1);color:rgba(52,211,153,0.7);text-decoration:none;white-space:nowrap">📄 PDF</a>` : ''}
                            ${doi ? `<a href="https://doi.org/${doi}" target="_blank" style="padding:2px 8px;border-radius:4px;font-size:9px;background:rgba(251,191,36,0.1);color:rgba(251,191,36,0.7);text-decoration:none;white-space:nowrap">🔗 DOI</a>` : ''}
                            ${url ? `<button onclick="pfFetchPdf('${url.replace(/'/g,"\\'")}','${title.replace(/'/g,"\\'").slice(0,80)}','${name}')" style="padding:2px 8px;border-radius:4px;font-size:9px;background:rgba(42,127,142,0.12);border:1px solid rgba(42,127,142,0.25);color:var(--accent);cursor:pointer;white-space:nowrap">📥 Upload</button>` : ''}
                        </div>
                    </div>`;
                });
                if (pdfs.length > 15) {
                    html += `<div style="padding:8px;text-align:center;font-size:11px;color:rgba(255,255,255,0.25)">... und ${pdfs.length - 15} weitere PDFs</div>`;
                }
                html += '</div>';
            }

            panel.innerHTML = html;
            setTimeout(() => panel.scrollIntoView({behavior:'smooth', block:'start'}), 100);
        }

        async function pfFetchPdf(url, title, author) {
            const btn = event.target;
            const origText = btn.textContent;
            btn.textContent = '⏳';
            btn.disabled = true;
            try {
                const r = await fetch(`${API}/papers/fetch-and-upload`, {
                    method: 'POST', headers: {...H(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({url, title, author, year: ''})
                });
                const data = await r.json();
                if (data.ok) {
                    btn.textContent = '✅';
                    btn.style.background = 'rgba(52,211,153,0.2)';
                    showToast(`✅ ${data.filename} → DB + GitHub`, 'success');
                } else if (data.duplicate) {
                    btn.textContent = '⚠️ Dup';
                    btn.style.background = 'rgba(251,191,36,0.15)';
                    showToast(`⚠️ Bereits vorhanden: ${data.title || 'Dokument'}`, 'info');
                } else {
                    throw new Error(data.detail || data.message || 'Fehler');
                }
            } catch(e) {
                btn.textContent = '❌';
                btn.disabled = false;
                showToast(`❌ ${e.message}`, 'error');
                setTimeout(() => { btn.textContent = origText; }, 2000);
            }
        }

        function showToast(msg,type='info'){const c=document.getElementById('toastContainer'),t=document.createElement('div');t.className=`toast ${type}`;t.innerHTML=`<span>${{success:'✓',error:'✗',info:'ℹ'}[type]||''}</span> ${msg}`;c.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transform='translateX(20px)';t.style.transition='0.3s';setTimeout(()=>t.remove(),300);},4000);}

        function bxConfirm(message, {title='Bestätigung', icon='⚠️', confirmText='OK', cancelText='Abbrechen', danger=false} = {}) {
            return new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9900;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.15s ease';
                const accentColor = danger ? '#f87171' : 'var(--accent)';
                const accentBg = danger ? 'rgba(248,113,113,0.15)' : 'linear-gradient(135deg,var(--accent),#2A7F8E)';
                const accentBorder = danger ? 'rgba(248,113,113,0.3)' : 'rgba(42,127,142,0.3)';
                overlay.innerHTML = `
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:16px;width:min(420px,90vw);overflow:hidden;animation:slideUp 0.2s ease">
                        <div style="padding:24px 24px 0">
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                                <div style="font-size:24px">${icon}</div>
                                <div style="font-size:16px;font-weight:700;color:white">${title}</div>
                            </div>
                            <div style="font-size:14px;color:rgba(255,255,255,0.7);line-height:1.6;padding-bottom:20px">${message}</div>
                        </div>
                        <div style="padding:12px 24px 20px;display:flex;justify-content:flex-end;gap:10px;border-top:1px solid var(--border)">
                            <button id="bxConfirmCancel" style="padding:10px 20px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text-secondary);font-size:13px;cursor:pointer;font-family:inherit;transition:all 0.15s" onmouseenter="this.style.background='rgba(255,255,255,0.04)'" onmouseleave="this.style.background='transparent'">${cancelText}</button>
                            <button id="bxConfirmOk" style="padding:10px 24px;border:1px solid ${accentBorder};border-radius:10px;background:${accentBg};color:white;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.15s" onmouseenter="this.style.opacity='0.85'" onmouseleave="this.style.opacity='1'">${confirmText}</button>
                        </div>
                    </div>`;
                document.body.appendChild(overlay);
                const cleanup = (result) => { overlay.remove(); resolve(result); };
                overlay.querySelector('#bxConfirmOk').onclick = () => cleanup(true);
                overlay.querySelector('#bxConfirmCancel').onclick = () => cleanup(false);
                overlay.onclick = (e) => { if (e.target === overlay) cleanup(false); };
                // ESC to cancel
                const esc = (e) => { if (e.key === 'Escape') { document.removeEventListener('keydown', esc); cleanup(false); } };
                document.addEventListener('keydown', esc);
                overlay.querySelector('#bxConfirmOk').focus();
            });
        }
        function clearAll(){files=[];tags=[];fileTags=[];renderFileList();renderTags();renderFileTags();document.getElementById('textTitle').value='';document.getElementById('textContent').value='';document.getElementById('fileTitle').value='';document.getElementById('fileCategory').value='general';document.getElementById('fileLang').value='de';document.getElementById('textZone').classList.remove('has-content','focused','active');document.getElementById('textCharCount').style.display='none';updateCount();lastAnalyzedLength=0;document.getElementById('textAnalysisPreview').style.display='none';document.getElementById('fileAnalysisPreview').style.display='none';}
        document.getElementById('textContent').addEventListener('input',updateCount);

        // ── Admin Dashboard ──────────────────────────────
        const ROLE_CONFIG = {
            researcher:        { label: 'Researcher',   color: '#8b9aff', tabs: ['Fragen','Modell-Building','Upload','Dokumente','Profil'] },
            sales:             { label: 'Sales',        color: '#fbbf24', tabs: ['Fragen','Upload','Ausgangslage','Profil'] },
            operations:        { label: 'Operations',   color: '#34d399', tabs: ['Fragen','Upload','Ausgangslage','Profil'] },
            senior_management: { label: 'Senior Mgmt',  color: '#f59e0b', tabs: ['Fragen','Modell-Building','Upload','Dokumente','Ausgangslage','Profil'] },
            partner:           { label: 'Partner',      color: '#ef4444', tabs: ['Fragen','Modell-Building','Upload','Dokumente','Ausgangslage','Profil'] },
            admin:             { label: 'Admin',        color: '#f87171', tabs: ['Alle Tabs'] }
        };
        // Owner codes from YAML team_registry
        const CRM_OWNER_CODES = ['','OWN-GF','OWN-EB','OWN-MdL','OWN-AJ','OWN-MR','OWN-MFA','OWN-MF'];

        async function loadAdminData() {
            if (!currentUser || !currentUser.admin) return;
            try {
                const [usersR, settingsR, docsR] = await Promise.all([
                    fetch(`${API}/admin/users`, {headers:H()}),
                    fetch(`${API}/admin/settings`, {headers:H()}),
                    fetch(`${API}/documents`, {headers:H()})
                ]);
                if (usersR.status===401) { doLogout(); return; }
                const users = usersR.ok ? await usersR.json() : [];
                const settings = settingsR.ok ? await settingsR.json() : {};
                const docs = docsR.ok ? await docsR.json() : [];

                // Stats
                document.getElementById('adminStatUsers').textContent = users.length;
                document.getElementById('adminStatDocs').textContent = docs.length;
                const regMode = settings.registration === 'open' ? 'Offen' : 'Eingeschränkt';
                document.getElementById('adminStatReg').textContent = regMode;
                const domains = settings.allowed_email_domains || [];
                document.getElementById('adminStatRegSub').textContent = domains.includes('*') ? 'Alle Domains' : domains.map(d => '@'+d).join(', ') || 'Alle Domains';
                document.getElementById('adminUserCount').textContent = users.length;

                // User table
                const tbody = users.map(u => {
                    const created = u.created_at ? new Date(u.created_at).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',year:'numeric'}) : '–';
                    const lastLogin = u.last_login ? new Date(u.last_login).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}) : 'Nie';
                    const userRole = u.is_admin ? 'admin' : (u.role || 'researcher');
                    const rc = ROLE_CONFIG[userRole] || ROLE_CONFIG.researcher;
                    const statusBadge = u.is_active ? '<span class="user-badge active">Aktiv</span>' : '<span class="user-badge inactive">Inaktiv</span>';
                    const verifiedBadge = u.email_verified ? '<span class="user-badge active">✓</span>' : '<span class="user-badge inactive">✗</span>';

                    // Role dropdown + admin toggle
                    const isSelf = u.email === currentUser.email;
                    const adminToggle = !isSelf
                        ? (u.is_admin
                            ? `<button onclick="adminToggleAdmin('${u.id}','${u.email}',false)" style="font-size:9px;padding:2px 6px;margin-left:4px;background:transparent;color:rgba(248,113,113,0.6);border:1px solid rgba(248,113,113,0.2);border-radius:6px;cursor:pointer" title="Admin-Rechte entziehen">✕</button>`
                            : `<button onclick="adminToggleAdmin('${u.id}','${u.email}',true)" style="font-size:9px;padding:2px 6px;margin-left:4px;background:transparent;color:rgba(251,191,36,0.5);border:1px solid rgba(251,191,36,0.2);border-radius:6px;cursor:pointer" title="Zum Admin ernennen">👑</button>`)
                        : '';
                    const roleCell = u.is_admin
                        ? `<span style="font-size:11px;padding:4px 10px;border-radius:12px;background:${ROLE_CONFIG.admin.color}18;color:${ROLE_CONFIG.admin.color};border:1px solid ${ROLE_CONFIG.admin.color}44;font-weight:600">Admin</span>${adminToggle}`
                        : `<select onchange="adminSetRole('${u.id}',this.value)" style="font-size:11px;padding:4px 8px;background:${rc.color}12;color:${rc.color};border:1px solid ${rc.color}44;border-radius:8px;cursor:pointer;font-weight:600;appearance:auto">
                            ${Object.entries(ROLE_CONFIG).filter(([k]) => k !== 'admin').map(([k, v]) =>
                                `<option value="${k}" ${k === userRole ? 'selected' : ''} style="color:#000">${v.label}</option>`
                            ).join('')}
                        </select>${adminToggle}`;

                    // CRM access controls (only for @fehradvice.com)
                    const isFa = u.email.toLowerCase().endsWith('@fehradvice.com');
                    const isSenior = ['senior_management','partner'].includes(u.role);
                    const crmCell = isFa
                        ? `<div style="display:flex;flex-direction:column;gap:4px">
                            <label style="display:flex;align-items:center;gap:5px;cursor:pointer" title="CRM-Zugang">
                                <input type="checkbox" ${u.crm_access ? 'checked' : ''} onchange="adminToggleCrm('${u.id}',{crm_access:this.checked})" style="accent-color:#2A7F8E;cursor:pointer">
                                <span style="font-size:10px;color:${u.crm_access ? '#2A7F8E' : 'rgba(255,255,255,0.25)'}">CRM</span>
                            </label>
                            ${u.crm_access ? `<label style="display:flex;align-items:center;gap:5px;cursor:pointer" title="Lead-Management (eigene Leads)">
                                <input type="checkbox" ${u.lead_management ? 'checked' : ''} onchange="adminToggleCrm('${u.id}',{lead_management:this.checked})" style="accent-color:#E8A33D;cursor:pointer">
                                <span style="font-size:10px;color:${u.lead_management ? '#E8A33D' : 'rgba(255,255,255,0.25)'}">Leads</span>
                            </label>
                            <select onchange="adminToggleCrm('${u.id}',{crm_owner_code:this.value})" style="font-size:9px;padding:2px 4px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.5);border:1px solid rgba(255,255,255,0.08);border-radius:4px;cursor:pointer">
                                ${CRM_OWNER_CODES.map(c => `<option value="${c}" ${c===(u.crm_owner_code||'') ? 'selected' : ''} style="color:#000">${c || '– kein Owner –'}</option>`).join('')}
                            </select>
                            <select onchange="adminToggleCrm('${u.id}',{crm_role:this.value})" style="font-size:9px;padding:2px 4px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.5);border:1px solid rgba(255,255,255,0.08);border-radius:4px;cursor:pointer">
                                ${['none','viewer','manager','admin'].map(r => `<option value="${r}" ${r===(u.crm_role||'none') ? 'selected' : ''} style="color:#000">${r==='none'?'– keine Rolle –':r==='viewer'?'Viewer (eigene)':r==='manager'?'Manager (alle)':'Admin'}</option>`).join('')}
                            </select>` : ''}
                          </div>`
                        : '<span style="font-size:10px;color:rgba(255,255,255,0.15)">–</span>';

                    // Tab access pills (include CRM if access)
                    const tabs = u.is_admin ? ['Alle'] : [...rc.tabs.filter(t => !['Profil'].includes(t)), ...(u.crm_access && isFa ? ['CRM'] : [])];
                    const tabPills = tabs.map(t =>
                        `<span style="font-size:9px;padding:2px 6px;border-radius:8px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.35);border:1px solid rgba(255,255,255,0.06)">${t}</span>`
                    ).join(' ');

                    const toggleBtn = u.is_active
                        ? `<button class="btn-toggle deactivate" onclick="toggleUserActive('${u.id}','${u.email}')">Deaktivieren</button>`
                        : `<button class="btn-toggle activate" onclick="toggleUserActive('${u.id}','${u.email}')">Aktivieren</button>`;
                    const verifyBtn = !u.email_verified ? ` <button class="btn-toggle activate" onclick="adminVerifyUser('${u.id}','${u.email}')">Bestätigen</button>` : '';

                    return `<tr style="border-bottom:1px solid rgba(255,255,255,0.04)">
                        <td style="padding:10px 8px"><span style="font-weight:500;color:white">${u.name || '–'}</span><br><span style="font-size:11px;color:var(--text-muted)">${u.email}</span></td>
                        <td style="padding:10px 6px">${roleCell}</td>
                        <td style="padding:10px 4px">${crmCell}</td>
                        <td style="padding:10px 4px"><div style="display:flex;flex-wrap:wrap;gap:3px">${tabPills}</div></td>
                        <td style="padding:10px 4px;text-align:center">${verifiedBadge}</td>
                        <td style="padding:10px 4px">${statusBadge}</td>
                        <td style="padding:10px 4px;font-size:11px;color:rgba(255,255,255,0.4)">${lastLogin}</td>
                        <td style="padding:10px 4px">${toggleBtn}${verifyBtn}</td>
                    </tr>`;
                }).join('');

                document.getElementById('adminUserTable').innerHTML = `<table class="user-table" style="width:100%;border-collapse:collapse">
                    <thead><tr style="border-bottom:1px solid rgba(255,255,255,0.08)">
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Benutzer</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Rolle</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">CRM</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Tab-Zugang</th>
                        <th style="text-align:center;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">E-Mail</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Status</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Letzter Login</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Aktionen</th>
                    </tr></thead>
                    <tbody>${tbody}</tbody>
                </table>`;

                // Settings
                document.getElementById('adminSettings').innerHTML = `
                    <div class="settings-row"><span class="settings-label">E-Mail-Verifizierung</span><span class="settings-value" style="color:${settings.email_verification?'var(--success)':'var(--text-muted)'}">${settings.email_verification ? '✓ Aktiv' : '✗ Deaktiviert'}</span></div>
                    <div class="settings-row"><span class="settings-label">E-Mail-Versand (Resend)</span><span class="settings-value" style="color:${settings.smtp_configured?'var(--success)':'var(--error)'}">${settings.smtp_configured ? '✓ Konfiguriert' : '✗ Nicht konfiguriert'}</span></div>
                    <div class="settings-row"><span class="settings-label">Registrierung</span><span class="settings-value">${regMode}</span></div>
                    <div class="settings-row"><span class="settings-label">Erlaubte Domains</span><span class="settings-value">${domains.includes('*') ? 'Alle (*)' : domains.map(d=>'@'+d).join(', ') || 'Alle (*)'}</span></div>
                    <div class="settings-row"><span class="settings-label">JWT Gültigkeit</span><span class="settings-value">${settings.jwt_expiry_hours || 24}h</span></div>
                `;

                // Load feedback
                try {
                    const fbR = await fetch(`${API}/feedback`, {headers:H()});
                    const feedbacks = fbR.ok ? await fbR.json() : [];
                    const openFb = feedbacks.filter(f => f.status === 'neu');
                    document.getElementById('adminStatFb').textContent = openFb.length;
                    document.getElementById('adminStatFbSub').textContent = `von ${feedbacks.length} gesamt`;
                    document.getElementById('adminFbCount').textContent = feedbacks.length;

                    if (feedbacks.length === 0) {
                        document.getElementById('adminFeedbackList').innerHTML = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Noch kein Feedback eingegangen.</div>';
                    } else {
                        const typeIcons = { bug: '🐛', wunsch: '💡', frage: '❓' };
                        const statusColors = { neu: '#f87171', bearbeitung: '#fbbf24', erledigt: '#34d399' };
                        document.getElementById('adminFeedbackList').innerHTML = feedbacks.map(f => {
                            const sc = statusColors[f.status] || '#94a3b8';
                            const date = f.created_at ? new Date(f.created_at).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : '–';
                            return `<div style="padding:14px 16px;background:var(--navy-card);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;display:flex;align-items:center;gap:12px">
                                <span style="font-size:20px">${typeIcons[f.type] || '📝'}</span>
                                <div style="flex:1;min-width:0">
                                    <div style="font-size:13px;color:white;margin-bottom:3px">${f.comment || '–'}</div>
                                    <div style="font-size:11px;color:rgba(255,255,255,0.3)">${f.created_by} · ${date} · Tab: ${f.page || '–'} · ${f.viewport || ''}</div>
                                </div>
                                <button onclick="fbShowScreenshot('${f.id}')" style="padding:4px 10px;border-radius:6px;border:1px solid rgba(139,170,255,0.2);background:transparent;color:rgba(139,170,255,0.7);font-size:11px;cursor:pointer;white-space:nowrap">📸 Bild</button>
                                <select onchange="fbUpdateStatus('${f.id}',this.value)" style="font-size:11px;padding:4px 8px;background:transparent;color:${sc};border:1px solid ${sc}44;border-radius:6px;cursor:pointer">
                                    ${['neu','bearbeitung','erledigt'].map(s => `<option value="${s}" ${s===f.status?'selected':''}>${s}</option>`).join('')}
                                </select>
                            </div>`;
                        }).join('');
                    }
                } catch(e) { console.error('Feedback load:', e); }
            } catch(e) {
                document.getElementById('adminUserTable').innerHTML = '<p style="color:var(--error)">Fehler beim Laden der Admin-Daten.</p>';
            }
        }

        async function toggleUserActive(userId, email) {
            if (!await bxConfirm(`Benutzer ${email} wirklich umschalten?`, {title:'Benutzer deaktivieren', icon:'👤', confirmText:'Umschalten', danger:true})) return;
            try {
                const r = await fetch(`${API}/admin/users/${userId}/toggle-active`, {method:'PUT', headers:H()});
                if (!r.ok) { showToast('Fehler beim Ändern', 'error'); return; }
                const data = await r.json();
                showToast(`${email}: ${data.is_active ? 'aktiviert' : 'deaktiviert'}`, data.is_active ? 'success' : 'info');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function adminVerifyUser(userId, email) {
            if (!await bxConfirm(`E-Mail von ${email} manuell bestätigen?`, {title:'E-Mail verifizieren', icon:'✉️', confirmText:'Bestätigen'})) return;
            try {
                const r = await fetch(`${API}/admin/users/${userId}/verify`, {method:'PUT', headers:H()});
                if (!r.ok) { showToast('Fehler', 'error'); return; }
                showToast(`${email}: E-Mail bestätigt ✓`, 'success');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function adminSetRole(userId, role) {
            try {
                const r = await fetch(`${API}/admin/users/${userId}/role`, {
                    method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role })
                });
                if (!r.ok) { showToast('Fehler beim Setzen der Rolle', 'error'); return; }
                const rc = ROLE_CONFIG[role] || ROLE_CONFIG.researcher;
                showToast(`Rolle → ${rc.label} gesetzt`, 'success');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function adminToggleAdmin(userId, email, makeAdmin) {
            const action = makeAdmin ? `${email} zum Admin ernennen?` : `Admin-Rechte von ${email} entziehen?`;
            if (!await bxConfirm(action, {title:'Admin-Rechte ändern', icon:'⚙️', confirmText:'Ändern', danger:true})) return;
            try {
                const r = await fetch(`${API}/admin/users/${userId}/toggle-admin`, {
                    method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_admin: makeAdmin })
                });
                if (!r.ok) { const d = await r.json().catch(()=>({})); showToast(d.detail || 'Fehler', 'error'); return; }
                showToast(makeAdmin ? `${email} ist jetzt Admin 👑` : `Admin-Rechte entfernt`, 'success');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function adminToggleCrm(userId, data) {
            try {
                const r = await fetch(`${API}/admin/users/${userId}/crm-access`, {
                    method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!r.ok) { const d = await r.json().catch(()=>({})); showToast(d.detail || 'Fehler', 'error'); loadAdminData(); return; }
                const label = data.crm_access !== undefined ? (data.crm_access ? 'CRM freigeschaltet ✓' : 'CRM deaktiviert')
                    : data.lead_management !== undefined ? (data.lead_management ? 'Lead-Mgmt aktiviert ✓' : 'Lead-Mgmt deaktiviert')
                    : data.crm_owner_code !== undefined ? `Owner: ${data.crm_owner_code || '–'}`
                    : data.crm_role !== undefined ? `CRM-Rolle: ${data.crm_role}`
                    : 'Aktualisiert ✓';
                showToast(label, 'success');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function fbShowScreenshot(id) {
            try {
                const r = await fetch(`${API}/feedback/${id}/screenshot`, { headers: H() });
                if (!r.ok) { showToast('Bild nicht gefunden', 'error'); return; }
                const data = await r.json();
                // Show in modal overlay
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;inset:0;z-index:20000;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;cursor:pointer;padding:20px';
                modal.onclick = () => modal.remove();
                const img = document.createElement('img');
                img.src = data.screenshot;
                img.style.cssText = 'max-width:95%;max-height:95%;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,0.5)';
                modal.appendChild(img);
                document.body.appendChild(modal);
            } catch(e) { showToast('Fehler', 'error'); }
        }

        async function fbUpdateStatus(id, status) {
            try {
                await fetch(`${API}/feedback/${id}`, {
                    method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                loadAdminData();
            } catch(e) { showToast('Fehler', 'error'); }
        }

        // ── Password Change ──────────────────────────────
        function openPwModal() {
            document.getElementById('pwModal').classList.add('visible');
            document.getElementById('pwCurrent').value='';
            document.getElementById('pwNew').value='';
            document.getElementById('pwConfirm').value='';
            document.getElementById('pwMsg').className='modal-msg';
            document.getElementById('pwCurrent').focus();
        }
        async function closePwModal() { document.getElementById('pwModal').classList.remove('visible'); }

        async function changePassword() {
            const cur = document.getElementById('pwCurrent').value;
            const nw = document.getElementById('pwNew').value;
            const conf = document.getElementById('pwConfirm').value;
            const msg = document.getElementById('pwMsg');
            const btn = document.getElementById('pwBtn');
            msg.className='modal-msg';
            if (!cur) { msg.className='modal-msg error'; msg.textContent='Bitte aktuelles Passwort eingeben.'; return; }
            if (nw.length < 6) { msg.className='modal-msg error'; msg.textContent='Neues Passwort muss mindestens 6 Zeichen haben.'; return; }
            if (nw !== conf) { msg.className='modal-msg error'; msg.textContent='Neue Passwörter stimmen nicht überein.'; return; }
            btn.disabled=true; btn.textContent='Wird geändert...';
            try {
                const r = await fetch(`${API}/change-password`, {method:'POST', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({current_password:cur, new_password:nw})});
                const d = await r.json();
                if (!r.ok) { msg.className='modal-msg error'; msg.textContent=d.detail||'Fehler'; btn.disabled=false; btn.textContent='Ändern'; return; }
                msg.className='modal-msg success'; msg.textContent='✓ Passwort erfolgreich geändert!';
                showToast('Passwort geändert','success');
                setTimeout(closePwModal, 1500);
            } catch(e) { msg.className='modal-msg error'; msg.textContent='Verbindungsfehler'; }
            btn.disabled=false; btn.textContent='Ändern';
        }
        document.addEventListener('keydown', e => { if(e.key==='Escape') closePwModal(); });

        // ── Profile ──────────────────────────────────────────────────────────
        let profileData = null;
        let profileExpertise = [];

        async function loadProfile() {
            try {
                const r = await fetch(`${API}/profile`, {headers:H()});
                if (!r.ok) return;
                profileData = await r.json();
                profileExpertise = profileData.expertise || [];
                // Fill form
                document.getElementById('profileName').value = profileData.name || '';
                document.getElementById('profilePosition').value = profileData.position || '';
                document.getElementById('profileCompany').value = profileData.company || '';
                document.getElementById('profilePhone').value = profileData.phone || '';
                document.getElementById('profileLinkedin').value = profileData.linkedin_url || '';
                document.getElementById('profileBio').value = profileData.bio || '';
                // Fill display card
                const name = profileData.name || profileData.email.split('@')[0];
                document.getElementById('profileDisplayName').textContent = name;
                document.getElementById('profileDisplayPosition').textContent = [profileData.position, profileData.company].filter(Boolean).join(' · ') || '–';
                document.getElementById('profileDisplayEmail').textContent = profileData.email;
                document.getElementById('profileDisplayCompany').textContent = profileData.company || '–';
                document.getElementById('profileDisplayPhone').textContent = profileData.phone || '–';
                if (profileData.created_at) {
                    document.getElementById('profileMemberSince').textContent = new Date(profileData.created_at).toLocaleDateString('de-CH', {month:'long', year:'numeric'});
                }
                // Avatar
                const avatar = document.getElementById('profileAvatar');
                if (profileData.profile_photo_url) {
                    avatar.innerHTML = `<img src="${profileData.profile_photo_url}" alt="Foto">`;
                } else {
                    const initials = name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
                    document.getElementById('profileInitials').textContent = initials;
                }
                // LinkedIn button state
                if (profileData.linkedin_connected) {
                    document.getElementById('linkedinBtn').className = 'linkedin-btn connected';
                    document.getElementById('linkedinBtnText').textContent = 'LinkedIn verbunden ✓';
                }
                // Expertise tags
                renderExpertise();
                // Load Ψ-Profile
                loadPsiProfile();
            } catch(e) { console.error('Profile load error:', e); }
        }

        async function loadPsiProfile() {
            try {
                const r = await fetch(`${API}/insight/profile`, { headers: H() });
                if (!r.ok) return;
                const psi = await r.json();
                const el = document.getElementById('psiProfileContent');

                if (!psi.has_profile || psi.total_insights === 0) {
                    el.innerHTML = `
                        <div style="text-align:center;padding:12px 0;color:rgba(255,255,255,0.4)">
                            <div style="font-size:20px;margin-bottom:8px">○</div>
                            <div>Noch kein Ψ-Profil vorhanden.</div>
                            <div style="margin-top:4px;font-size:12px">Beantworte Login-Fragen um dein Profil aufzubauen.</div>
                        </div>`;
                    return;
                }

                // Engagement bar
                const engColor = psi.engagement_score > 60 ? '#22c55e' : psi.engagement_score > 30 ? '#f59e0b' : 'var(--accent)';

                // Domain labels
                const domainLabels = { FIN: '💰 Finanzen', HLT: '🏥 Gesundheit', ORG: '🏢 Organisation', REL: '🕊️ Religion', EDU: '🎓 Bildung', ENV: '🌱 Umwelt', POL: '🏛️ Politik', OTH: '📋 Andere' };

                // Speed icon
                const speedIcon = psi.decision_speed === 'fast' ? '⚡' : psi.decision_speed === 'deliberate' ? '🧘' : '⚖️';

                // Build answer list
                let answersHtml = '';
                if (psi.answers && psi.answers.length > 0) {
                    answersHtml = '<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px">' +
                        '<div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px">Deine Antworten</div>' +
                        psi.answers.map(a => {
                            const domBadge = a.domain ? `<span style="font-size:10px;padding:2px 6px;border-radius:6px;background:rgba(139,170,255,0.1);color:var(--accent)">${a.domain}</span>` : '';
                            const styleBadge = a.style ? `<span style="font-size:10px;padding:2px 6px;border-radius:6px;background:rgba(255,255,255,0.05);color:var(--text-secondary)">${a.style.split('_')[0]}</span>` : '';
                            const latency = a.latency_ms ? `<span style="font-size:10px;color:var(--text-muted)">${(a.latency_ms/1000).toFixed(1)}s</span>` : '';
                            return `<div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04)">
                                <div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:3px">${a.question}</div>
                                <div style="font-size:13px;color:rgba(255,255,255,0.85);font-weight:500">${a.choice_index ? '●' : '○'} ${a.answer}</div>
                                <div style="display:flex;gap:6px;margin-top:4px;align-items:center">${domBadge}${styleBadge}${latency}</div>
                            </div>`;
                        }).join('') + '</div>';
                }

                el.innerHTML = `
                    <div style="margin-bottom:14px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                            <span style="font-size:12px;color:var(--text-muted)">Engagement</span>
                            <span style="font-size:12px;font-weight:700;color:${engColor}">${psi.engagement_score}/100</span>
                        </div>
                        <div style="height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden">
                            <div style="height:100%;width:${psi.engagement_score}%;background:${engColor};border-radius:3px;transition:width 0.5s"></div>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
                        <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:10px;text-align:center">
                            <div style="font-size:18px">${domainLabels[psi.primary_domain] || '📋'}</div>
                            <div style="font-size:10px;color:var(--text-muted);margin-top:2px">Primary Domain</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:10px;text-align:center">
                            <div style="font-size:18px">${speedIcon}</div>
                            <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${psi.decision_speed}</div>
                        </div>
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
                        ${Object.entries(psi.thinking_styles || {}).map(([s, c]) =>
                            '<span style="font-size:11px;padding:3px 8px;border-radius:8px;background:rgba(139,170,255,0.1);color:var(--accent)">' + s + ' (' + c + ')</span>'
                        ).join('')}
                    </div>
                    <div style="font-size:12px;color:var(--text-muted)">
                        ${psi.total_insights} Insights · ${psi.avg_decision_latency_ms ? (psi.avg_decision_latency_ms/1000).toFixed(1)+'s ø Entscheidungszeit' : ''}
                    </div>
                    ${answersHtml}
                `;
            } catch(e) { console.error('Ψ-Profile load error:', e); }
        }

        function renderExpertise() {
            document.getElementById('profileExpertiseTags').innerHTML = profileExpertise.map((t,i) =>
                `<span class="profile-tag">${t}<span class="remove" onclick="removeExpertise(${i})">×</span></span>`
            ).join('') || '<span style="font-size:12px;color:var(--text-muted)">Noch keine Expertise hinzugefügt</span>';
        }

        function addExpertise() {
            const input = document.getElementById('expertiseInput');
            const val = input.value.trim();
            if (!val || profileExpertise.includes(val)) { input.value=''; return; }
            if (profileExpertise.length >= 20) { showToast('Max. 20 Expertise-Tags','info'); return; }
            profileExpertise.push(val);
            input.value = '';
            renderExpertise();
            saveProfile(true);
        }

        function removeExpertise(idx) {
            profileExpertise.splice(idx, 1);
            renderExpertise();
            saveProfile(true);
        }

        async function saveProfile(silent) {
            const data = {
                name: document.getElementById('profileName').value.trim(),
                position: document.getElementById('profilePosition').value.trim(),
                company: document.getElementById('profileCompany').value.trim(),
                phone: document.getElementById('profilePhone').value.trim(),
                linkedin_url: document.getElementById('profileLinkedin').value.trim(),
                bio: document.getElementById('profileBio').value.trim(),
                expertise: profileExpertise
            };
            try {
                const r = await fetch(`${API}/profile`, {method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify(data)});
                if (!r.ok) { showToast('Fehler beim Speichern','error'); return; }
                if (!silent) showToast('Profil gespeichert ✓','success');
                // Update nav user name
                if (data.name) document.getElementById('navUser').textContent = data.name;
                loadProfile();
            } catch(e) { showToast('Verbindungsfehler','error'); }
        }

        async function uploadPhoto(input) {
            if (!input.files.length) return;
            const fd = new FormData();
            fd.append('file', input.files[0]);
            try {
                const r = await fetch(`${API}/profile/photo`, {method:'POST', headers:H(), body:fd});
                if (!r.ok) { const d=await r.json(); showToast(d.detail||'Fehler','error'); return; }
                showToast('Foto aktualisiert ✓','success');
                loadProfile();
            } catch(e) { showToast('Upload fehlgeschlagen','error'); }
            input.value='';
        }

        async function connectLinkedIn() {
            if (profileData?.linkedin_connected) {
                if (!await bxConfirm('LinkedIn-Verbindung trennen?', {title:'LinkedIn trennen', icon:'🔗', confirmText:'Trennen', danger:true})) return;
                try {
                    await fetch(`${API}/profile/linkedin/disconnect`, {method:'POST', headers:H()});
                    showToast('LinkedIn getrennt','info');
                    loadProfile();
                } catch(e) { showToast('Fehler','error'); }
                return;
            }
            try {
                const r = await fetch(`${API}/auth/linkedin`, {headers:H()});
                if (!r.ok) { const d=await r.json(); showToast(d.detail||'LinkedIn nicht konfiguriert','error'); return; }
                const {auth_url} = await r.json();
                const popup = window.open(auth_url, 'linkedin', 'width=600,height=700,left=200,top=100');
                window.addEventListener('message', async function handler(e) {
                    if (e.data?.type === 'linkedin_success') {
                        window.removeEventListener('message', handler);
                        try {
                            await fetch(`${API}/profile/linkedin`, {method:'POST', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify(e.data.data)});
                            showToast('LinkedIn verbunden ✓','success');
                            loadProfile();
                        } catch(err) { showToast('Fehler beim Speichern','error'); }
                    } else if (e.data?.type === 'linkedin_error') {
                        window.removeEventListener('message', handler);
                        showToast('LinkedIn-Verbindung fehlgeschlagen','error');
                    }
                });
            } catch(e) { showToast('Verbindungsfehler','error'); }
        }

        // ── Chat ──────────────────────────────────────────────────────────────
        let chatLoaded = false;

        function chatAreaClick(e) {
            // Click on empty chat area or welcome → focus input (desktop only)
            if (e.target.closest('.chat-msg') || e.target.closest('button') || e.target.closest('a') || e.target.closest('pre') || e.target.closest('code')) return;
            const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            if (isTouch) return; // Don't auto-focus on touch devices – prevents keyboard popup
            const input = document.getElementById('chatInput');
            if (input) input.focus();
        }

        // ── iOS/iPad keyboard detection ──
        (function() {
            const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            if (!isTouch) return;

            let keyboardOpen = false;
            const toggle = (open) => {
                if (open === keyboardOpen) return;
                // Only apply keyboard mode in chat section
                const chatSection = document.getElementById('chat-section');
                if (!chatSection || !chatSection.classList.contains('active')) { open = false; }
                // Only apply if a chat input is focused
                const active = document.activeElement;
                if (open && active && active.id !== 'chatInput') { open = false; }
                if (open === keyboardOpen) return;
                keyboardOpen = open;
                document.body.classList.toggle('keyboard-open', open);
                // Scroll chat to bottom when keyboard opens
                if (open) {
                    setTimeout(() => {
                        const msgs = document.getElementById('chatMessages');
                        if (msgs) msgs.scrollTop = msgs.scrollHeight;
                    }, 100);
                }
            };

            // Method 1: visualViewport API (best for iOS 13+)
            if (window.visualViewport) {
                const initialHeight = window.visualViewport.height;
                window.visualViewport.addEventListener('resize', () => {
                    const diff = initialHeight - window.visualViewport.height;
                    toggle(diff > 150); // keyboard typically > 200px
                });
            }

            // Method 2: focus/blur fallback – only for chatInput
            document.addEventListener('focusin', (e) => {
                if (e.target.id === 'chatInput') {
                    setTimeout(() => toggle(true), 300);
                }
            });
            document.addEventListener('focusout', (e) => {
                if (e.target.id === 'chatInput') {
                    setTimeout(() => toggle(false), 100);
                }
            });
        })();

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }

        /**
         * Generate canonical filename for papers/books/studies.
         * MUST match backend generate_canonical_key() exactly.
         * Format: [TYPE]_Author_Year_Short-Title.ext
         */
        function generateCanonicalKey(author, year, title, docType = 'PAP', ext = 'pdf') {
            // Clean author
            let a = (author || 'Unknown').trim()
                .replace(/ä/g,'ae').replace(/ö/g,'oe').replace(/ü/g,'ue')
                .replace(/Ä/g,'Ae').replace(/Ö/g,'Oe').replace(/Ü/g,'Ue')
                .replace(/ß/g,'ss').replace(/[^A-Za-z]/g, '');
            if (a) a = a[0].toUpperCase() + a.slice(1);
            if (!a) a = 'Unknown';

            // Clean year
            let y = (year || '0000').trim().slice(0,4);
            if (!/^\d{4}$/.test(y)) y = '0000';

            // Clean title: first 5 meaningful words, hyphenated
            let t = (title || 'Untitled').trim().replace(/[^\w\s-]/g, '');
            const stop = new Set(['a','an','the','of','in','on','at','to','for','and','or','is','are','was','by','with','from','der','die','das','und','oder','ein','eine','von','zu','im','am','des','den','dem','für','als','auf','nach','über','bei','mit']);
            let words = t.split(/\s+/).filter(w => w);
            let meaningful = words.filter(w => !stop.has(w.toLowerCase()));
            if (!meaningful.length) meaningful = words.slice(0,5);
            let shortTitle = meaningful.slice(0,5).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('-');
            if (shortTitle.length > 60) shortTitle = shortTitle.slice(0,60).replace(/-[^-]*$/, '');
            if (!shortTitle) shortTitle = 'Untitled';

            // Clean type and ext
            let dtype = (docType || 'PAP').toUpperCase().slice(0,4);
            let e = (ext || 'pdf').toLowerCase().replace(/^\./, '');

            return `${dtype}_${a}_${y}_${shortTitle}.${e}`;
        }

        function formatMessage(text) {
            // Use full markdown renderer
            return mbRenderMd(text);
        }

        function appendMessage(role, content, sources) {
            const welcome = document.getElementById('chatWelcome');
            if (welcome) welcome.style.display = 'none';
            const container = document.getElementById('chatMessages');
            const initials = role === 'user' ? (currentUser?.name || currentUser?.email || 'U').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2) : 'B';
            const msgId = 'msg_' + Date.now();
            let html = `<div class="chat-msg ${role}" id="${msgId}">
                <div class="chat-msg-avatar">${initials}</div>
                <div class="chat-msg-body">${formatMessage(content)}`;
            if (sources && sources.length > 0) {
                html += `<div class="chat-sources">${sources.map(s => `<span class="chat-source-tag">${s.title}</span>`).join('')}</div>`;
            }
            if (role === 'assistant') {
                html += `<div style="margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.04);display:flex;gap:6px">
                    <button onclick="copyAnswer('${msgId}')" style="padding:3px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:rgba(255,255,255,0.3);font-size:10px;cursor:pointer;transition:all 0.15s" onmouseenter="this.style.background='rgba(255,255,255,0.06)';this.style.color='rgba(255,255,255,0.6)'" onmouseleave="this.style.background='transparent';this.style.color='rgba(255,255,255,0.3)'">📋 Kopieren</button>
                    <button onclick="challengeAnswer('${msgId}')" style="padding:3px 10px;border-radius:6px;border:1px solid rgba(255,140,0,0.2);background:transparent;color:rgba(255,140,0,0.5);font-size:10px;cursor:pointer;transition:all 0.15s" onmouseenter="this.style.background='rgba(255,140,0,0.1)';this.style.color='#ff8c00'" onmouseleave="this.style.background='transparent';this.style.color='rgba(255,140,0,0.5)'">🔥 Challenge</button>
                </div>`;
            }
            html += `</div></div>`;
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
            updateCloseSessionBtn();
        }

        function showTyping(message) {
            const container = document.getElementById('chatMessages');
            const existing = document.getElementById('typingIndicator');
            if (existing) existing.remove();
            container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant" id="typingIndicator">
                <div class="chat-msg-avatar">B</div>
                <div class="chat-msg-body">
                    <div style="display:flex;align-items:center;gap:10px;color:var(--text-muted);">
                        <div class="chat-typing"><span></span><span></span><span></span></div>
                        <span id="typingText">${message || 'BEATRIX denkt nach...'}</span>
                    </div>
                </div>
            </div>`);
            container.scrollTop = container.scrollHeight;
        }

        function updateTypingText(text) {
            const el = document.getElementById('typingText');
            if (el) el.textContent = text;
        }

        function removeTyping() {
            const el = document.getElementById('typingIndicator');
            if (el) el.remove();
        }

        async function pollForAnswer(issueNumber) {
            const maxAttempts = 60; // 5 min max
            const interval = 5000; // 5 seconds
            const phases = [
                'BEATRIX liest das Evidence-Based Framework...',
                'Analysiert relevante Modelle und Axiome...',
                'Prüft Ψ-Dimensionen und Kontextfaktoren...',
                'Formuliert die Antwort...'
            ];

            for (let i = 0; i < maxAttempts; i++) {
                // Update phase message
                const phase = phases[Math.min(Math.floor(i / 5), phases.length - 1)];
                updateTypingText(phase);

                await new Promise(r => setTimeout(r, interval));
                try {
                    const r = await fetch(`${API}/chat/poll/${issueNumber}`, {headers:H()});
                    if (r.status === 401) { doLogout(); return null; }
                    const data = await r.json();
                    if (data.status === 'done') return data;
                    if (data.status === 'error') return {status:'error', answer: data.message};
                } catch(e) { /* retry */ }
            }
            return {status: 'timeout', answer: 'Die Analyse dauert länger als erwartet. Die Antwort wird in Issue #' + issueNumber + ' auf GitHub erscheinen.'};
        }

        // ── Main Chat File Upload ──
        let mainChatAttachments = [];

        // ── Session Persistence ──
        function generateSessionId() {
            return 'S-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,6);
        }
        function saveSessionToStorage() {
            try {
                localStorage.setItem('bx_session_id', chatSessionId);
                localStorage.setItem('bx_session_type', chatSessionType || 'general');
                localStorage.setItem('bx_session_entities', JSON.stringify(chatSessionEntities || {}));
                localStorage.setItem('bx_session_ts', Date.now().toString());
            } catch(e) {}
        }
        function loadSessionFromStorage() {
            try {
                const sid = localStorage.getItem('bx_session_id');
                const ts = parseInt(localStorage.getItem('bx_session_ts') || '0');
                // Session expires after 4 hours of inactivity
                if (sid && ts && (Date.now() - ts) < 4 * 60 * 60 * 1000) {
                    chatSessionId = sid;
                    chatSessionType = localStorage.getItem('bx_session_type') || 'general';
                    try { chatSessionEntities = JSON.parse(localStorage.getItem('bx_session_entities') || '{}'); } catch { chatSessionEntities = {}; }
                    return true;
                }
            } catch(e) {}
            return false;
        }
        function clearSessionStorage() {
            try {
                localStorage.removeItem('bx_session_id');
                localStorage.removeItem('bx_session_type');
                localStorage.removeItem('bx_session_entities');
                localStorage.removeItem('bx_session_ts');
            } catch(e) {}
        }

        // Init: restore or create
        let chatSessionId;
        if (!loadSessionFromStorage()) {
            chatSessionId = generateSessionId();
        }

        async function mainChatFileSelected(input) {
            const files = Array.from(input.files);
            if (!files.length) return;
            const container = document.getElementById('mainChatAttachments');
            container.style.display = 'flex';

            for (const file of files) {
                const tempId = 'matt_' + Date.now() + Math.random().toString(36).slice(2,6);
                container.insertAdjacentHTML('beforeend', `<div id="${tempId}" style="display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--navy-card);border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--text-secondary)">
                    <span style="animation:blink 0.8s infinite">⏳</span> ${file.name.length > 25 ? file.name.slice(0,22)+'...' : file.name}
                </div>`);

                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    const r = await fetch(`${API}/chat/upload`, {
                        method: 'POST',
                        headers: {'Authorization': 'Bearer ' + authToken},
                        body: formData
                    });
                    const d = await r.json();
                    if (!r.ok) {
                        document.getElementById(tempId).innerHTML = `<span style="color:var(--error)">❌</span> ${file.name}: ${d.detail || 'Fehler'}`;
                        setTimeout(() => document.getElementById(tempId)?.remove(), 3000);
                        continue;
                    }
                    d._tempId = tempId;
                    mainChatAttachments.push(d);
                    const el = document.getElementById(tempId);
                    if (d.type === 'image') {
                        el.innerHTML = `<img src="data:${d.media_type};base64,${d.image_base64}" style="width:24px;height:24px;border-radius:4px;object-fit:cover">
                            <span>🖼 ${d.name}</span>
                            <span onclick="mainRemoveAttachment('${tempId}')" style="cursor:pointer;color:rgba(255,255,255,0.3);margin-left:4px">✕</span>`;
                    } else {
                        let paperBadge = '';
                        if (d.paper_detected) {
                            const p = d.paper;
                            paperBadge = p.duplicate
                                ? `<div style="font-size:10px;color:#f59e0b;margin-top:2px">⚠️ Bereits in KB: ${p.title}</div>`
                                : p.ok ? `<div style="font-size:10px;color:#34d399;margin-top:2px">📚 Paper erkannt → KB + GitHub ✓</div>`
                                : `<div style="font-size:10px;color:#ef4444;margin-top:2px">📚 Paper erkannt, Pipeline-Fehler</div>`;
                        } else if (d.paper_detected === false) {
                            paperBadge = `<div style="font-size:10px;color:rgba(255,255,255,0.25);margin-top:2px">📄 Kein Paper — nur Chat-Kontext</div>`;
                        }
                        el.innerHTML = `<div style="display:flex;align-items:center;gap:6px">
                            <span>${d.paper_detected ? '📚' : '📄'}</span>
                            <div><div>${d.name} (${Math.round(d.size/1024)} KB)</div>${paperBadge}</div>
                            <span onclick="mainRemoveAttachment('${tempId}')" style="cursor:pointer;color:rgba(255,255,255,0.3);margin-left:auto">✕</span>
                        </div>`;
                    }
                } catch(e) {
                    const el = document.getElementById(tempId);
                    if (el) el.innerHTML = `<span style="color:var(--error)">❌ ${e.message}</span>`;
                }
            }
            input.value = '';
        }

        function mainRemoveAttachment(tempId) {
            mainChatAttachments = mainChatAttachments.filter(a => a._tempId !== tempId);
            const el = document.getElementById(tempId);
            if (el) el.remove();
            if (!mainChatAttachments.length) document.getElementById('mainChatAttachments').style.display = 'none';
        }

        let _chatSending = false;
        async function sendChat() {
            if (_chatSending) return;
            const input = document.getElementById('chatInput');
            const btn = document.getElementById('chatSendBtn');
            const question = input.value.trim();
            if (!question && !mainChatAttachments.length) return;

            // Immediately prevent double-send
            _chatSending = true;
            btn.disabled = true;
            // Safety: auto-reset after 120s to prevent permanent stuck state
            const _safetyTimer = setTimeout(() => {
                if (_chatSending) {
                    _chatSending = false; btn.disabled = false;
                    removeTyping();
                    // Clean up stuck streaming dots
                    const stuckDots = document.querySelector('#bxStreamText .typing-dots');
                    if (stuckDots) stuckDots.remove();
                    const stuckStream = document.getElementById('bxStreamMsg');
                    if (stuckStream) {
                        const body = stuckStream.querySelector('.chat-msg-body');
                        const text = body?.textContent?.trim();
                        if (text === '●●●' || text === '') {
                            body.innerHTML = '<span style="color:#fbbf24">⏱ Zeitüberschreitung – bitte nochmal versuchen.</span>';
                        }
                    }
                    console.warn('BEATRIX: safety reset after timeout');
                }
            }, 120000);

            // ── Auto-detect intent OR use command mode ──
            // BUT: if attachments present, always use normal stream (supports Vision)
            const hasAttachments = mainChatAttachments.length > 0;
            const intentKeywords = /\b(neues projekt|projekt eröffnen|projekt anlegen|eröffne.*projekt|erstell.*projekt|leg.*projekt an|mandat.*für|probono.*für|workshop.*für|beratung.*für|neuer lead|lead.*anlegen|lead.*erfassen|opportunity|akquise.*für|bcm.*modell|modell.*bauen|psi.*dimension|kontextvektor|behavioral.*model|intervention.*design|ausgangslage|kontext.*erfassen|situation.*bei|marktumfeld|herausforderung.*bei)\b/i;
            if (!hasAttachments && (bxCmdMode || (question && intentKeywords.test(question)))) {
                if (!bxCmdMode) {
                    bxCmdMode = true;
                    const tbtn = document.getElementById('prjChatToggle');
                    tbtn.style.background = 'rgba(42,127,142,0.15)';
                    tbtn.style.borderColor = 'rgba(42,127,142,0.4)';
                    tbtn.style.color = 'var(--accent-light)';
                    document.getElementById('prjChatIndicator').style.display = '';
                    bxCmdDraft = {};
                    bxCmdHistory = [];
                    bxCmdIntent = '';
                }
                sendBxCmd(question);
                return;
            }

            const currentAttachments = [...mainChatAttachments];
            mainChatAttachments = [];
            const attContainer = document.getElementById('mainChatAttachments');
            if (attContainer) { attContainer.innerHTML = ''; attContainer.style.display = 'none'; }

            input.value = ''; autoResize(input);
            btn.disabled = true;

            // Show user message with file previews
            const welcome = document.getElementById('chatWelcome');
            if (welcome) welcome.style.display = 'none';
            const container = document.getElementById('chatMessages');
            const initials = (currentUser?.name || currentUser?.email || 'U').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);

            let attachHtml = '';
            if (currentAttachments.length) {
                attachHtml = '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">';
                for (const att of currentAttachments) {
                    if (att.type === 'image') {
                        attachHtml += `<div style="border-radius:8px;overflow:hidden;border:1px solid var(--border)"><img src="data:${att.media_type};base64,${att.image_base64}" style="max-width:200px;max-height:150px;display:block"></div>`;
                    } else {
                        const icon = att.paper_detected ? '📚' : '📄';
                        attachHtml += `<div style="padding:6px 10px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--text-secondary)">${icon} ${att.name}${att.paper_detected ? ' <span style="color:#34d399">→ KB</span>' : ''}</div>`;
                    }
                }
                attachHtml += '</div>';
            }

            const msgText = question || `Analysiere: ${currentAttachments.map(a=>a.name).join(', ')}`;
            container.insertAdjacentHTML('beforeend', `<div class="chat-msg user">
                <div class="chat-msg-avatar">${initials}</div>
                <div class="chat-msg-body">${attachHtml}${question ? formatMessage(question) : '<span style="color:var(--text-muted);font-style:italic">Datei hochgeladen</span>'}</div>
            </div>`);
            container.scrollTop = container.scrollHeight;

            // If attachments → use streaming with attachments
            if (currentAttachments.length) {
                // Create assistant shell with cursor
                const streamMsgId = 'mainStreamMsg_' + Date.now();
                container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant">
                    <div class="chat-msg-avatar">B</div>
                    <div class="chat-msg-body" id="${streamMsgId}">
                        <span class="mb-cursor" style="display:inline-block;width:2px;height:16px;background:var(--accent);animation:blink 0.8s infinite;vertical-align:middle"></span>
                    </div>
                </div>`);
                container.scrollTop = container.scrollHeight;
                const targetEl = document.getElementById(streamMsgId);
                let fullText = '';
                let renderTimer = null;

                try {
                    const streamResp = await fetch(`${API}/chat/stream`, {
                        method: 'POST',
                        headers: {...H(), 'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            question: msgText,
                            session_id: chatSessionId,
                            attachments: currentAttachments.map(a => ({type:a.type, name:a.name, content_text:a.content_text, image_base64:a.image_base64, media_type:a.media_type}))
                        })
                    });
                    if (!streamResp.ok) throw new Error(`Stream error: ${streamResp.status}`);
                    const reader = streamResp.body.getReader();
                    const decoder = new TextDecoder();
                    let sseBuffer = '';
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        sseBuffer += decoder.decode(value, { stream: true });
                        const events = sseBuffer.split('\n\n');
                        sseBuffer = events.pop();
                        for (const evt of events) {
                            for (const line of evt.split('\n')) {
                                if (!line.startsWith('data: ')) continue;
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    if (data.type === 'token' && data.text) {
                                        fullText += data.text;
                                        if (!renderTimer) {
                                            renderTimer = setTimeout(() => {
                                                targetEl.innerHTML = mbRenderMd(fullText) +
                                                    '<span class="mb-cursor" style="display:inline-block;width:2px;height:14px;background:var(--accent);animation:blink 0.8s infinite;vertical-align:middle;margin-left:2px"></span>';
                                                container.scrollTop = container.scrollHeight;
                                                renderTimer = null;
                                            }, 50);
                                        }
                                    }
                                } catch(e) {}
                            }
                        }
                    }
                    if (renderTimer) { clearTimeout(renderTimer); }
                    targetEl.innerHTML = mbRenderMd(fullText);
                    addMsgActionButtons(targetEl);
                } catch(e) {
                    targetEl.innerHTML = '<span style="color:var(--error)">Fehler: ' + e.message + '</span>';
                }
            } else {
                // Normal chat flow (no attachments)
                showTyping('BEATRIX sucht in der Wissensbasis...');
                try {
                    const r = await fetch(`${API}/chat`, {method:'POST', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({question, session_id: chatSessionId})});
                    if (r.status === 401) { doLogout(); return; }
                    const d = await r.json();
                    if (!r.ok) { removeTyping(); appendMessage('assistant', d.detail || 'Entschuldigung, es gab einen Fehler.'); return; }

                    if (d.status === 'done' && d.path === 'fast') {
                        removeTyping();
                        appendMessage('assistant', d.answer, d.sources);
                    } else if (d.status === 'processing' && d.issue_number) {
                        showTyping('Neue Frage! BEATRIX erarbeitet die Antwort mit dem EBF Framework (~3-5 Min)...');
                        const result = await pollForAnswer(d.issue_number);
                        removeTyping();
                        if (result && result.answer) {
                            appendMessage('assistant', result.answer, [{title: '🔬 EBF Deep Analysis', type: 'github', url: d.issue_url}]);
                        } else {
                            appendMessage('assistant', 'BEATRIX konnte keine Antwort generieren. Versuche es erneut.');
                        }
                    } else if (d.answer) {
                        removeTyping();
                        appendMessage('assistant', d.answer, d.sources);
                    }
                } catch(e) {
                    removeTyping();
                    appendMessage('assistant', 'Verbindungsfehler. Bitte versuche es erneut.');
                }
            }
            _chatSending = false;
            btn.disabled = false;
            input.focus();
        }

        const SESSION_TYPES = {
            lead: {label:'Lead Management', icon:'🎯', color:'251,191,36'},
            project: {label:'Projekt', icon:'📋', color:'52,211,153'},
            model: {label:'BCM Modell', icon:'🔬', color:'139,170,255'},
            context: {label:'Kontext-Analyse', icon:'🧠', color:'232,163,61'},
            research: {label:'Research', icon:'📚', color:'168,162,255'},
            task: {label:'Aufgabe', icon:'✅', color:'120,200,120'},
            general: {label:'Allgemein', icon:'💬', color:'42,127,142'}
        };
        let chatSessionType = 'general';
        let chatSessionEntities = {};

        function updateSessionBadge() {
            const badge = document.getElementById('chatSessionBadge');
            if (badge) badge.textContent = chatSessionId;
            const badge2 = document.getElementById('chatSessionBadge2');
            if (badge2) badge2.textContent = chatSessionId ? `📜 ${chatSessionId.slice(0,12)}` : '';
            updateSessionTypeBadge();
            saveSessionToStorage();
        }
        function updateSessionTypeBadge(type) {
            if (type) chatSessionType = type;
            const el = document.getElementById('chatSessionType');
            if (!el) return;
            const st = SESSION_TYPES[chatSessionType] || SESSION_TYPES.general;
            if (chatSessionType === 'general') {
                el.style.display = 'none';
                return;
            }
            el.style.display = 'inline-block';
            el.textContent = st.icon + ' ' + st.label;
            el.style.background = `rgba(${st.color},0.15)`;
            el.style.color = `rgba(${st.color},0.9)`;
            el.style.border = `1px solid rgba(${st.color},0.3)`;
            saveSessionToStorage();
        }
        function startNewChatSession() {
            chatSessionId = generateSessionId();
            chatSessionType = 'general';
            chatSessionEntities = {};
            saveSessionToStorage();
            updateSessionBadge();
            // Clear chat messages
            const container = document.getElementById('chatMessages');
            if (container) {
                const welcome = container.querySelector('.chat-welcome');
                container.innerHTML = '';
                if (welcome) { welcome.style.display = ''; container.appendChild(welcome); }
            }
            // Re-apply returning user welcome if applicable
            if (sessionStorage.getItem('bea_returning') === '1') showReturningWelcome();
            // Reset command mode state
            bxCmdDraft = {};
            bxCmdHistory = [];
            bxCmdIntent = '';
            _chatSending = false;
            updateCloseSessionBtn();
        }
        async function closeCurrentSession() {
            if (!chatSessionId) return;
            const msgs = document.querySelectorAll('#chatMessages .chat-msg.user, #chatMessages .chat-msg.assistant');
            if (msgs.length === 0) { showToast('Keine aktive Session zum Schliessen', 'info'); return; }
            // Confirm
            if (!await bxConfirm('Session schliessen? Der Chat-Verlauf wird gelöscht und eine neue Session gestartet.', {title:'Session schliessen', icon:'📜', confirmText:'Schliessen'})) return;
            // Optionally notify backend to close/archive
            try {
                await fetch(`${API}/chat/session/${chatSessionId}/close`, {
                    method: 'POST', headers: {...H(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'close'})
                });
            } catch(e) { console.warn('Session close notify:', e); }
            // Show closing indicator
            const container = document.getElementById('chatMessages');
            if (container) {
                container.insertAdjacentHTML('beforeend', `<div style="text-align:center;padding:8px 0;margin:4px 0"><span style="font-size:11px;padding:4px 14px;border-radius:12px;background:rgba(220,80,80,0.1);color:rgba(220,130,130,0.85);border:1px solid rgba(220,80,80,0.2)">✕ Session ${chatSessionId} geschlossen</span></div>`);
            }
            // Start fresh after brief delay
            setTimeout(() => {
                startNewChatSession();
                showToast('Session geschlossen – neuer Chat bereit', 'success');
            }, 600);
        }
        function updateCloseSessionBtn() {
            const btn = document.getElementById('btnCloseSession');
            const btn2 = document.getElementById('btnCloseSession2');
            const msgs = document.querySelectorAll('#chatMessages .chat-msg.user, #chatMessages .chat-msg.assistant');
            const show = msgs.length > 0 ? 'inline-block' : 'none';
            if (btn) btn.style.display = show;
            if (btn2) btn2.style.display = show;
        }

        // ── SESSION HISTORY ──
        let _sessionHistoryOpen = false;
        async function toggleSessionHistory() {
            const overlay = document.getElementById('sessionHistoryOverlay');
            const drawer = document.getElementById('sessionHistoryDrawer');
            if (!overlay || !drawer) return;
            _sessionHistoryOpen = !_sessionHistoryOpen;
            if (_sessionHistoryOpen) {
                overlay.style.display = 'block';
                setTimeout(() => drawer.style.transform = 'translateX(0)', 10);
                loadSessionHistory();
            } else {
                drawer.style.transform = 'translateX(100%)';
                setTimeout(() => overlay.style.display = 'none', 260);
            }
        }
        async function loadSessionHistory() {
            const list = document.getElementById('sessionHistoryList');
            const count = document.getElementById('sessionHistoryCount');
            if (!list) return;
            list.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-muted)">⏳ Lade Sessions...</div>';
            try {
                const r = await fetch(`${API}/chat/sessions`, {headers: H()});
                if (!r.ok) throw new Error('Fehler');
                const sessions = await r.json();
                if (count) count.textContent = `${sessions.length} Sessions`;
                if (!sessions.length) {
                    list.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-muted)">Noch keine Sessions vorhanden</div>';
                    return;
                }
                list.innerHTML = sessions.map(s => {
                    const isCurrent = s.session_id === chatSessionId;
                    const isClosed = s.is_closed;
                    const dt = new Date(s.started_at);
                    const updatedAt = s.updated_at ? new Date(s.updated_at) : dt;
                    const dateStr = dt.toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',year:'2-digit'});
                    const timeStr = dt.toLocaleTimeString('de-CH', {hour:'2-digit',minute:'2-digit'});
                    const title = s.title || s.session_id;
                    const hoursAgo = (Date.now() - updatedAt.getTime()) / 3600000;
                    const isStale = !isClosed && !isCurrent && hoursAgo > 1;
                    const statusBadge = isCurrent
                        ? '<span style="font-size:9px;padding:1px 6px;border-radius:8px;background:rgba(42,200,120,0.15);color:rgba(42,200,120,0.9);border:1px solid rgba(42,200,120,0.25)">aktiv</span>'
                        : isClosed
                            ? '<span style="font-size:9px;padding:1px 6px;border-radius:8px;background:rgba(220,80,80,0.1);color:rgba(220,130,130,0.8);border:1px solid rgba(220,80,80,0.2)">geschlossen</span>'
                            : isStale
                                ? '<span style="font-size:9px;padding:1px 6px;border-radius:8px;background:rgba(251,191,36,0.1);color:rgba(251,191,36,0.8);border:1px solid rgba(251,191,36,0.2)">pausiert</span>'
                                : '<span style="font-size:9px;padding:1px 6px;border-radius:8px;background:rgba(99,102,241,0.1);color:rgba(129,140,248,0.8);border:1px solid rgba(99,102,241,0.2)">offen</span>';

                    // Quick action buttons
                    let actions = '<div style="display:flex;gap:6px;margin-top:8px" onclick="event.stopPropagation()">';
                    if (isCurrent) {
                        actions += `<button onclick="closeSessionDetail();toggleSessionHistory();document.getElementById('chatInput').focus()" style="padding:3px 10px;border-radius:6px;border:1px solid rgba(42,127,142,0.25);background:rgba(42,127,142,0.08);color:var(--accent);font-size:10px;cursor:pointer">💬 Weiterschreiben</button>`;
                        actions += `<button onclick="sessionClose('${s.session_id}')" style="padding:3px 10px;border-radius:6px;border:1px solid rgba(251,191,36,0.2);background:transparent;color:rgba(251,191,36,0.6);font-size:10px;cursor:pointer">🔒 Schliessen</button>`;
                    } else if (!isClosed) {
                        actions += `<button onclick="sessionContinue('${s.session_id}')" style="padding:3px 10px;border-radius:6px;border:1px solid rgba(42,127,142,0.25);background:rgba(42,127,142,0.08);color:var(--accent);font-size:10px;cursor:pointer">💬 Weiterchatten</button>`;
                        actions += `<button onclick="sessionClose('${s.session_id}')" style="padding:3px 10px;border-radius:6px;border:1px solid rgba(251,191,36,0.2);background:transparent;color:rgba(251,191,36,0.6);font-size:10px;cursor:pointer">🔒 Schliessen</button>`;
                    }
                    actions += `<button onclick="sessionDelete('${s.session_id}')" style="padding:3px 10px;border-radius:6px;border:1px solid rgba(239,68,68,0.15);background:transparent;color:rgba(239,68,68,0.4);font-size:10px;cursor:pointer">🗑</button>`;
                    actions += '</div>';

                    return `<div onclick="openSessionDetail('${s.session_id}')" style="padding:12px 14px;border:1px solid ${isCurrent ? 'rgba(42,127,142,0.3)' : 'var(--border,#1e2d4a)'};border-radius:10px;margin-bottom:8px;cursor:pointer;transition:all 0.15s;background:${isCurrent ? 'rgba(42,127,142,0.06)' : 'rgba(255,255,255,0.02)'}" onmouseenter="this.style.background='rgba(255,255,255,0.05)'" onmouseleave="this.style.background='${isCurrent ? 'rgba(42,127,142,0.06)' : 'rgba(255,255,255,0.02)'}'">`
                        + `<div style="display:flex;justify-content:space-between;align-items:center;gap:8px">`
                        + `<span style="font-size:13px;font-weight:600;color:white;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.session_icon || '💬'} ${title.length > 50 ? title.slice(0,47) + '...' : title}</span>`
                        + `${statusBadge}`
                        + `</div>`
                        + `<div style="display:flex;gap:12px;margin-top:5px;font-size:11px;color:var(--text-muted,#6b7fa3)">`
                        + `<span>📅 ${dateStr} ${timeStr}</span>`
                        + `<span>💬 ${s.messages} Nachrichten</span>`
                        + (s.duration_minutes > 0 ? `<span>⏱ ${s.duration_minutes}min</span>` : '')
                        + `</div>`
                        + (s.summary ? `<div style="margin-top:5px;font-size:11px;color:var(--text-secondary,#8899b8);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.summary.slice(0,80)}</div>` : '')
                        + actions
                        + `</div>`;
                }).join('');
            } catch(e) {
                list.innerHTML = `<div style="text-align:center;padding:30px;color:var(--text-muted)">📭 Noch keine abgeschlossenen Sessions</div>`;
            }
        }
        let _viewedSessionId = null;
        let _viewedSessionClosed = false;
        async function openSessionDetail(sid) {
            _viewedSessionId = sid;
            const modal = document.getElementById('sessionDetailModal');
            const titleEl = document.getElementById('sessionDetailTitle');
            const metaEl = document.getElementById('sessionDetailMeta');
            const msgsEl = document.getElementById('sessionDetailMessages');
            const actionsEl = document.getElementById('sessionDetailActions');
            if (!modal || !msgsEl) return;
            modal.style.display = 'block';
            if (actionsEl) actionsEl.style.display = 'none';
            msgsEl.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-muted)">⏳ Lade Nachrichten...</div>';
            try {
                const r = await fetch(`${API}/chat/session/${sid}/messages`, {headers: H()});
                if (!r.ok) throw new Error('Fehler beim Laden');
                const data = await r.json();
                _viewedSessionClosed = data.meta?.type === 'closed' || data.meta?.is_closed;
                const isCurrent = sid === chatSessionId;
                if (titleEl) titleEl.textContent = data.meta?.title || sid;
                if (metaEl) {
                    const parts = [];
                    if (data.meta?.created_at) parts.push('📅 ' + new Date(data.meta.created_at).toLocaleString('de-CH'));
                    parts.push(`💬 ${data.messages.length} Nachrichten`);
                    if (data.meta?.duration_min > 0) parts.push(`⏱ ${data.meta.duration_min}min`);
                    if (_viewedSessionClosed) parts.push('🔒 Geschlossen');
                    else if (isCurrent) parts.push('🟢 Aktiv');
                    metaEl.textContent = parts.join(' · ');
                }
                if (!data.messages.length) {
                    msgsEl.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-muted)">Keine Nachrichten</div>';
                } else {
                    msgsEl.innerHTML = data.messages.map(m => {
                        const isUser = m.role === 'user';
                        const time = m.timestamp ? new Date(m.timestamp).toLocaleTimeString('de-CH', {hour:'2-digit', minute:'2-digit'}) : '';
                        return `<div style="margin-bottom:12px;display:flex;gap:10px;${isUser ? 'flex-direction:row-reverse' : ''}">`
                            + `<div style="width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;${isUser ? 'background:rgba(91,138,245,0.12);color:rgba(91,138,245,0.8);border:1px solid rgba(91,138,245,0.2)' : 'background:rgba(42,127,142,0.1);color:var(--accent-light);border:1px solid var(--border)'}">${isUser ? 'GF' : 'B'}</div>`
                            + `<div style="max-width:80%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.5;${isUser ? 'background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.15);color:rgba(200,215,245,0.9)' : 'background:rgba(255,255,255,0.03);border:1px solid var(--border);color:var(--text-secondary)'}">`
                            + `<div>${formatMessage(m.content)}</div>`
                            + (time ? `<div style="text-align:right;font-size:9px;color:var(--text-muted);margin-top:4px">${time}</div>` : '')
                            + `</div></div>`;
                    }).join('');
                }

                // Action buttons
                if (actionsEl) {
                    let btns = '';
                    if (!isCurrent && !_viewedSessionClosed) {
                        btns += `<button onclick="sessionContinue('${sid}')" style="padding:8px 18px;border-radius:8px;border:none;background:rgba(42,127,142,0.15);color:var(--accent);font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s" onmouseenter="this.style.background='rgba(42,127,142,0.25)'" onmouseleave="this.style.background='rgba(42,127,142,0.15)'">💬 Weiterchatten</button>`;
                        btns += `<button onclick="sessionClose('${sid}')" style="padding:8px 18px;border-radius:8px;border:none;background:rgba(251,191,36,0.1);color:#fbbf24;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.15s" onmouseenter="this.style.background='rgba(251,191,36,0.2)'" onmouseleave="this.style.background='rgba(251,191,36,0.1)'">🔒 Schliessen</button>`;
                    } else if (isCurrent) {
                        btns += `<button onclick="closeSessionDetail();document.getElementById('chatInput').focus()" style="padding:8px 18px;border-radius:8px;border:none;background:rgba(42,127,142,0.15);color:var(--accent);font-size:12px;font-weight:600;cursor:pointer">💬 Weiterschreiben</button>`;
                        btns += `<button onclick="sessionClose('${sid}')" style="padding:8px 18px;border-radius:8px;border:none;background:rgba(251,191,36,0.1);color:#fbbf24;font-size:12px;font-weight:500;cursor:pointer">🔒 Schliessen</button>`;
                    } else {
                        btns += `<span style="font-size:11px;color:var(--text-muted)">🔒 Diese Session ist abgeschlossen</span>`;
                    }
                    btns += `<button onclick="sessionDelete('${sid}')" style="padding:8px 18px;border-radius:8px;border:none;background:rgba(239,68,68,0.08);color:rgba(239,68,68,0.6);font-size:12px;font-weight:500;cursor:pointer;transition:all 0.15s" onmouseenter="this.style.background='rgba(239,68,68,0.15)';this.style.color='#ef4444'" onmouseleave="this.style.background='rgba(239,68,68,0.08)';this.style.color='rgba(239,68,68,0.6)'">🗑 Löschen</button>`;
                    actionsEl.innerHTML = btns;
                    actionsEl.style.display = 'flex';
                }
            } catch(e) {
                msgsEl.innerHTML = `<div style="text-align:center;padding:30px;color:rgba(220,80,80,0.8)">❌ ${e.message}</div>`;
            }
        }

        function sessionContinue(sid) {
            chatSessionId = sid;
            const badge = document.getElementById('chatSessionBadge');
            if (badge) badge.textContent = sid.slice(0,15) + '…';
            // Clear chat, load session messages
            const container = document.getElementById('chatMessages');
            if (container) container.innerHTML = '';
            closeSessionDetail();
            toggleSessionHistory();
            showSection('chat', document.querySelector('[data-section="chat"]'));
            // Reload messages
            fetch(`${API}/chat/session/${sid}/messages`, {headers: H()})
                .then(r => r.json())
                .then(data => {
                    if (data.messages) {
                        data.messages.forEach(m => appendMessage(m.role, m.content, m.sources));
                    }
                    showToast('Session fortgesetzt', 'success');
                })
                .catch(() => showToast('Session geladen', 'success'));
        }

        async function sessionClose(sid) {
            if (!await bxConfirm('Session wirklich schliessen? Du kannst danach nicht mehr weiterschreiben.', {title:'Session schliessen', icon:'📜', confirmText:'Schliessen'})) return;
            try {
                const r = await fetch(`${API}/chat/session/${sid}/close`, {method:'POST', headers: H()});
                if (!r.ok) throw new Error('Fehler');
                showToast('Session geschlossen', 'success');
                if (sid === chatSessionId) {
                    // Start new session
                    chatSessionId = 'S-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
                    const badge = document.getElementById('chatSessionBadge');
                    if (badge) badge.textContent = chatSessionId.slice(0,15) + '…';
                    const container = document.getElementById('chatMessages');
                    if (container) container.innerHTML = '';
                    const welcome = document.getElementById('chatWelcome');
                    if (welcome) welcome.style.display = '';
                }
                closeSessionDetail();
                loadSessionHistory();
            } catch(e) { showToast('Fehler beim Schliessen', 'error'); }
        }

        async function sessionDelete(sid) {
            if (!await bxConfirm('Session unwiderruflich löschen? Alle Nachrichten gehen verloren.', {title:'Session löschen', icon:'🗑️', confirmText:'Endgültig löschen', danger:true})) return;
            try {
                const r = await fetch(`${API}/chat/session/${sid}`, {method:'DELETE', headers: H()});
                if (!r.ok && r.status !== 404) throw new Error('Fehler');
                showToast('Session gelöscht', 'success');
                if (sid === chatSessionId) {
                    chatSessionId = 'S-' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
                    const badge = document.getElementById('chatSessionBadge');
                    if (badge) badge.textContent = chatSessionId.slice(0,15) + '…';
                    const container = document.getElementById('chatMessages');
                    if (container) container.innerHTML = '';
                    const welcome = document.getElementById('chatWelcome');
                    if (welcome) welcome.style.display = '';
                }
                closeSessionDetail();
                loadSessionHistory();
            } catch(e) { showToast('Fehler beim Löschen', 'error'); }
        }
        function closeSessionDetail() {
            const modal = document.getElementById('sessionDetailModal');
            if (modal) modal.style.display = 'none';
        }
        function showSessionTypePicker(anchor) {
            // Remove existing picker
            const old = document.getElementById('sessionTypePicker');
            if (old) { old.remove(); return; }
            const types = Object.entries(SESSION_TYPES).filter(([k]) => k !== 'general');
            let html = types.map(([k, v]) =>
                `<div onclick="switchSessionType('${k}')" style="padding:6px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;border-radius:6px;transition:background 0.15s" onmouseenter="this.style.background='rgba(255,255,255,0.08)'" onmouseleave="this.style.background='transparent'"><span style="font-size:14px">${v.icon}</span><span style="font-size:12px;color:rgba(${v.color},0.9)">${v.label}</span></div>`
            ).join('');
            const picker = document.createElement('div');
            picker.id = 'sessionTypePicker';
            picker.style.cssText = 'position:absolute;top:100%;left:50%;transform:translateX(-50%);margin-top:6px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:6px;z-index:100;min-width:160px;box-shadow:0 8px 24px rgba(0,0,0,0.3)';
            picker.innerHTML = html;
            anchor.parentElement.style.position = 'relative';
            anchor.parentElement.appendChild(picker);
            setTimeout(() => document.addEventListener('click', function rem(e) {
                if (!picker.contains(e.target)) { picker.remove(); document.removeEventListener('click', rem); }
            }), 10);
        }
        async function switchSessionType(type) {
            const old = document.getElementById('sessionTypePicker');
            if (old) old.remove();
            chatSessionType = type;
            updateSessionTypeBadge(type);
            saveSessionToStorage();
            // Persist to backend
            try {
                await fetch(`${API}/chat/session/${chatSessionId}/type`, {
                    method: 'PUT', headers: {...H(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({type})
                });
            } catch(e) {}
            const st = SESSION_TYPES[type] || SESSION_TYPES.general;
            const container = document.getElementById('chatMessages');
            if (container) {
                container.insertAdjacentHTML('beforeend', `<div style="text-align:center;padding:6px 0;margin:4px 0"><span style="font-size:11px;padding:3px 12px;border-radius:12px;background:rgba(${st.color},0.1);color:rgba(${st.color},0.85);border:1px solid rgba(${st.color},0.2)">↻ Gewechselt zu ${st.icon} ${st.label}</span></div>`);
            }
        }
        async function resumeSession() {
            /* On login/reload: restore session state from backend if localStorage only has partial info */
            if (!chatSessionId) return;
            try {
                const r = await fetch(`${API}/chat/session/${chatSessionId}`, {headers: H()});
                if (r.ok) {
                    const s = await r.json();
                    if (s.type && s.type !== 'general') {
                        chatSessionType = s.type;
                        chatSessionEntities = s.entities || {};
                        updateSessionTypeBadge(s.type);
                        saveSessionToStorage();
                    }
                }
            } catch(e) {}
        }
        // Init session badge on load + resume from backend
        setTimeout(() => { updateSessionBadge(); resumeSession(); updateCloseSessionBtn(); }, 200);

        function askSuggestion(el) {
            document.getElementById('chatInput').value = el.textContent;
            sendChat();
        }

        // ── BEATRIX COMMAND MODE (Universal Intent) ──
        let bxCmdMode = true;  // Always on by default – intent router handles everything
        let bxCmdDraft = {};
        let bxCmdHistory = [];
        let bxCmdIntent = '';  // current active intent

        const BX_INTENTS = {
            project: {icon:'📋', label:'Projekt', color:'52,211,153'},
            lead:    {icon:'🎯', label:'Lead', color:'251,191,36'},
            task:    {icon:'✅', label:'Task', color:'52,211,153'},
            model:   {icon:'🔬', label:'Modell', color:'139,170,255'},
            context: {icon:'🧠', label:'Kontext', color:'232,163,61'}
        };

        function toggleBxCmd() {
            bxCmdMode = !bxCmdMode;
            const btn = document.getElementById('prjChatToggle');
            const indicator = document.getElementById('prjChatIndicator');
            const input = document.getElementById('chatInput');
            if (bxCmdMode) {
                btn.style.background = 'rgba(42,127,142,0.15)';
                btn.style.borderColor = 'rgba(42,127,142,0.4)';
                btn.style.color = 'var(--accent-light)';
                btn.title = 'BEATRIX Command Mode aktiv (klicken zum Beenden)';
                indicator.style.display = '';
                input.placeholder = '💡 Beschreibe was du brauchst... Projekt, Lead, Modell, Kontext-Analyse...';
                bxCmdDraft = {};
                bxCmdHistory = [];
                bxCmdIntent = '';
            } else {
                btn.style.background = 'rgba(255,255,255,0.04)';
                btn.style.borderColor = 'var(--border)';
                btn.style.color = 'rgba(255,255,255,0.4)';
                btn.title = 'BEATRIX Command Mode';
                indicator.style.display = 'none';
                input.placeholder = 'Stelle eine Frage an BEATRIX...';
                bxCmdDraft = {};
                bxCmdHistory = [];
                bxCmdIntent = '';
            }
        }

        // ── Card Renderers per Intent ──

        function renderProjectCard(data, status, missing, confidence, message) {
            const p = data;
            const catIcons = {mandat:'💼', lead:'🎯', probono:'🤝'};
            const catLabels = {mandat:'Bezahltes Mandat', lead:'Lead-Projekt', probono:'Pro Bono'};
            const typeLabels = {beratung:'Beratung',workshop:'Workshop',studie:'Studie',intervention:'Intervention',keynote:'Keynote',training:'Training',retainer:'Retainer'};
            const cat = p.project_category || '';
            const rgb = '52,211,153';
            const isComplete = status === 'complete' && confidence >= 0.7;
            const field = (l,v) => v ? `<div style="display:flex;gap:8px;padding:3px 0"><span style="color:rgba(255,255,255,0.3);min-width:100px;font-size:11px">${l}</span><span style="color:white;font-size:12px">${v}</span></div>` : '';
            let f = '';
            f += field('Kunde', (p.customer_code||'').toUpperCase());
            f += field('Projekt', p.name);
            f += field('Kategorie', `${catIcons[cat]||''} ${catLabels[cat]||cat}`);
            f += field('Typ', typeLabels[p.type]||p.type);
            if (p.description) f += field('Beschreibung', p.description);
            f += field('Start', p.start_date);
            if (p.end_date) f += field('Ende', p.end_date);
            if (p.budget_chf || p.budget) {
                const cur = p.currency || 'CHF';
                const val = p.budget || p.budget_chf;
                const valChf = p.budget_chf || val;
                if (cur !== 'CHF' && val && valChf) {
                    f += field('Budget', `${Number(val).toLocaleString('de-CH')} ${cur} <span style="color:rgba(255,255,255,0.3);font-size:10px">(≈ CHF ${Number(valChf).toLocaleString('de-CH')})</span>`);
                } else {
                    f += field('Budget', `CHF ${Number(valChf).toLocaleString('de-CH')}`);
                }
            }
            f += field('Owner', p.fa_owner);
            if (p.fa_team?.length) f += field('Team', p.fa_team.join(', '));
            return bxCard('📋','Projekt', rgb, isComplete, f, missing, message, confidence, isComplete ? `<button onclick="bxConfirmProject()" style="${bxBtnConfirm}">✓ Projekt eröffnen → GitHub</button><button onclick="bxRefine()" style="${bxBtnRefine}">✏ Anpassen</button>` : '');
        }

        function renderLeadCard(data, status, missing, confidence, message) {
            const d = data;
            const rgb = '251,191,36';
            const stageLabels = {initial_contact:'Erstkontakt',qualification:'Qualifizierung',proposal:'Proposal',negotiation:'Verhandlung',won:'Gewonnen',lost:'Verloren'};
            const isComplete = status === 'complete' && confidence >= 0.7;
            const field = (l,v) => v ? `<div style="display:flex;gap:8px;padding:3px 0"><span style="color:rgba(255,255,255,0.3);min-width:100px;font-size:11px">${l}</span><span style="color:white;font-size:12px">${v}</span></div>` : '';
            let f = '';
            f += field('Kunde', d.customer_name || (d.customer_code||'').toUpperCase());
            if (d.customer_code) f += field('Code', d.customer_code.toUpperCase());
            const neuBadge = d.is_new_customer === false ? '<span style="padding:2px 8px;background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.3);border-radius:8px;font-size:10px;color:#34d399;font-weight:600">B · Bestandskunde</span>' : '<span style="padding:2px 8px;background:rgba(139,170,255,0.1);border:1px solid rgba(139,170,255,0.3);border-radius:8px;font-size:10px;color:rgba(139,170,255,0.8);font-weight:600">N · Neukunde</span>';
            f += `<div style="padding:3px 0">${neuBadge}</div>`;
            f += field('Opportunity', d.opportunity);
            f += field('Phase', stageLabels[d.stage]||d.stage);
            f += field('Kontakt', d.contact_person);
            if (d.contact_email) f += field('E-Mail', d.contact_email);
            // Currency-aware value display
            if (d.estimated_value || d.estimated_value_chf) {
                const cur = d.currency || 'CHF';
                const val = d.estimated_value || d.estimated_value_chf;
                const valChf = d.estimated_value_chf || val;
                if (cur !== 'CHF' && val && valChf) {
                    f += field('Wert', `${Number(val).toLocaleString('de-CH')} ${cur} <span style="color:rgba(255,255,255,0.3);font-size:10px">(≈ CHF ${Number(valChf).toLocaleString('de-CH')})</span>`);
                } else {
                    f += field('Wert', `CHF ${Number(valChf).toLocaleString('de-CH')}`);
                }
            }
            if (d.probability) f += field('Wahrsch.', `${d.probability}%`);
            f += field('Next Step', d.next_action);
            if (d.next_action_date) f += field('Datum', d.next_action_date);
            f += field('Owner', d.fa_owner);
            if (d.notes) f += field('Notizen', d.notes);
            return bxCard('🎯','Lead', rgb, isComplete, f, missing, message, confidence, isComplete ? `<button onclick="bxConfirmLead()" style="${bxBtnConfirm}">✓ Lead erfassen → GitHub</button><button onclick="bxRefine()" style="${bxBtnRefine}">✏ Anpassen</button>` : '');
        }

        function renderModelCard(data, status, missing, confidence, message) {
            const d = data;
            const rgb = '139,170,255';
            const isComplete = status === 'complete' && confidence >= 0.6;
            const field = (l,v) => v ? `<div style="display:flex;gap:8px;padding:3px 0"><span style="color:rgba(255,255,255,0.3);min-width:100px;font-size:11px">${l}</span><span style="color:white;font-size:12px">${typeof v==='object'?JSON.stringify(v):v}</span></div>` : '';
            let f = '';
            f += field('Typ', d.model_type);
            f += field('Kunde', (d.customer_code||'').toUpperCase());
            f += field('Zielverhalten', d.target_behavior);
            f += field('Zielgruppe', d.target_group);
            if (d.current_state) f += field('Ist-Zustand', d.current_state);
            if (d.desired_state) f += field('Soll-Zustand', d.desired_state);
            if (d.psi_dimensions && typeof d.psi_dimensions === 'object') {
                const psiHtml = (Array.isArray(d.psi_dimensions) ? d.psi_dimensions : Object.entries(d.psi_dimensions)).map(p => {
                    if (typeof p === 'string') return `<span style="padding:2px 8px;background:rgba(139,170,255,0.1);border-radius:6px;font-size:10px;color:rgba(139,170,255,0.7)">${p}</span>`;
                    const [k,v] = Array.isArray(p) ? p : [p.dimension||p.name, p.level||p.score||''];
                    return `<span style="padding:2px 8px;background:rgba(139,170,255,0.1);border-radius:6px;font-size:10px;color:rgba(139,170,255,0.7)">${k}: ${v}</span>`;
                }).join(' ');
                f += `<div style="padding:3px 0"><span style="color:rgba(255,255,255,0.3);font-size:11px">Ψ-Dimensionen</span><div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px">${psiHtml}</div></div>`;
            }
            if (d.hypotheses) f += field('Hypothesen', Array.isArray(d.hypotheses) ? d.hypotheses.join('; ') : d.hypotheses);
            if (d.interventions) f += field('Interventionen', Array.isArray(d.interventions) ? d.interventions.join('; ') : d.interventions);
            return bxCard('🔬','Modell', rgb, isComplete, f, missing, message, confidence, isComplete ? `<button onclick="bxConfirmModel()" style="${bxBtnConfirm}">✓ Modell speichern</button><button onclick="bxRefine()" style="${bxBtnRefine}">✏ Anpassen</button>` : '');
        }

        function renderCompanyCard(data, status, missing, confidence, message) {
            const d = data;
            const rgb = '96,165,250'; // blue
            const isComplete = status === 'complete' && confidence >= 0.6;
            const indLabels = {finance:'Finanz',insurance:'Versicherung',retail:'Handel',fmcg:'FMCG',construction:'Bau',packaging:'Verpackung',public_sector:'Öffentlich',telecom:'Telekom',media:'Medien',automotive:'Automobil',pharma_health:'Pharma/Health',manufacturing:'Industrie',technology:'Technologie',energy:'Energie',transport:'Transport',creative:'Kreativ',ngo:'NGO/Verband',consulting:'Consulting'};
            const flags = {CH:'🇨🇭',AT:'🇦🇹',DE:'🇩🇪',SE:'🇸🇪',UK:'🇬🇧',US:'🇺🇸'};
            const field = (l,v) => v ? `<div style="display:flex;gap:8px;padding:3px 0"><span style="color:rgba(255,255,255,0.3);min-width:100px;font-size:11px">${l}</span><span style="color:white;font-size:12px">${v}</span></div>` : '';
            let f = '';
            f += field('Firma', d.name);
            if (d.code) f += field('Kürzel', `<span style="font-family:monospace;color:var(--accent)">${d.code.toUpperCase()}</span>`);
            if (d.short_name) f += field('Kurzname', d.short_name);
            const country = d.country || 'CH';
            f += field('Land', `${flags[country]||''} ${country}`);
            if (d.industry) f += field('Branche', indLabels[d.industry] || d.industry);
            if (d.website) f += field('Website', d.website);
            if (d.fa_owner) f += field('Owner', d.fa_owner);
            const neuBadge = d.is_new_customer === false ? '<span style="padding:2px 8px;background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.3);border-radius:8px;font-size:10px;color:#34d399;font-weight:600">Bestandskunde</span>' : '<span style="padding:2px 8px;background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.3);border-radius:8px;font-size:10px;color:rgb(96,165,250);font-weight:600">Neukunde</span>';
            f += `<div style="padding:3px 0">${neuBadge}</div>`;
            if (d.notes) f += field('Notizen', d.notes);
            return bxCard('🏢','Firma', rgb, isComplete, f, missing, message, confidence, isComplete ? `<button onclick="bxConfirmCompany()" style="${bxBtnConfirm}">✓ Firma anlegen → Registry</button><button onclick="bxRefine()" style="${bxBtnRefine}">✏ Anpassen</button>` : '');
        }

        function renderContextCard(data, status, missing, confidence, message) {
            const d = data;
            const rgb = '232,163,61';
            const isComplete = status === 'complete' && confidence >= 0.6;
            const field = (l,v) => v ? `<div style="display:flex;gap:8px;padding:3px 0"><span style="color:rgba(255,255,255,0.3);min-width:100px;font-size:11px">${l}</span><span style="color:white;font-size:12px">${typeof v==='object'?(Array.isArray(v)?v.join('; '):JSON.stringify(v)):v}</span></div>` : '';
            let f = '';
            f += field('Kunde', (d.customer_code||'').toUpperCase());
            f += field('Typ', d.context_type);
            f += field('Zusammenfassung', d.summary);
            if (d.challenges) f += field('Herausforderungen', d.challenges);
            if (d.opportunities) f += field('Chancen', d.opportunities);
            if (d.behavioral_patterns) f += field('Verhaltensmuster', d.behavioral_patterns);
            if (d.assessment) f += field('Einschätzung', d.assessment);
            return bxCard('🧠','Kontext', rgb, isComplete, f, missing, message, confidence, isComplete ? `<button onclick="bxConfirmContext()" style="${bxBtnConfirm}">✓ Kontext speichern</button><button onclick="bxRefine()" style="${bxBtnRefine}">✏ Anpassen</button>` : '');
        }

        function renderTaskCard(data, status, missing, confidence, message) {
            const d = data;
            const rgb = '52,211,153'; // green
            const typeLabels = {consultant:'👤 Berater', bdm:'🏢 BDM-Team', beatrix:'🤖 BEATRIX', external:'🔄 Extern'};
            const priLabels = {low:'○ Niedrig', normal:'◐ Normal', high:'● Hoch', urgent:'🔴 Dringend'};
            const priColors = {low:'rgba(255,255,255,0.3)', normal:'rgba(255,255,255,0.5)', high:'#fbbf24', urgent:'#ef4444'};
            const isComplete = status === 'complete' && confidence >= 0.6;
            const field = (l,v) => v ? `<div style="display:flex;gap:8px;padding:3px 0"><span style="color:rgba(255,255,255,0.3);min-width:100px;font-size:11px">${l}</span><span style="color:white;font-size:12px">${v}</span></div>` : '';
            let f = '';
            f += field('Aufgabe', d.title);
            if (d.description) f += field('Details', d.description);
            const at = d.assignee_type || 'consultant';
            f += `<div style="padding:3px 0"><span style="padding:2px 8px;background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.3);border-radius:8px;font-size:10px;color:#34d399;font-weight:600">${typeLabels[at]||at}</span></div>`;
            f += field('Zugewiesen an', d.assignee || (at==='bdm'?'BDM':at==='beatrix'?'System':''));
            if (d.customer_code) f += field('Kunde', d.customer_code.toUpperCase());
            if (d.project_slug) f += field('Projekt', d.project_slug);
            if (d.lead_id) f += field('Lead', d.lead_id);
            if (d.due_date) f += field('Fällig', d.due_date);
            if (d.priority) f += field('Priorität', `<span style="color:${priColors[d.priority]||'white'}">${priLabels[d.priority]||d.priority}</span>`);
            if (d.category) f += field('Kategorie', d.category);
            if (d.escalation_after_days) f += field('Eskalation', `nach ${d.escalation_after_days} Tagen`);
            return bxCard('✅','Task', rgb, isComplete, f, missing, message, confidence, isComplete ? `<button onclick="bxConfirmTask()" style="${bxBtnConfirm}">✓ Task erstellen</button><button onclick="bxRefine()" style="${bxBtnRefine}">✏ Anpassen</button>` : '');
        }

        // Shared card shell
        const bxBtnConfirm = "flex:1;padding:10px;background:linear-gradient(135deg,#34d399,#2A7F8E);border:none;border-radius:8px;color:white;font-size:13px;font-weight:700;cursor:pointer";
        const bxBtnRefine = "padding:10px 16px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:12px;cursor:pointer";

        function bxCard(icon, label, rgb, isComplete, fieldsHtml, missing, message, confidence, buttonsHtml) {
            const missingHtml = (missing?.length && !isComplete) ? `<div style="margin-top:10px;padding:8px 12px;background:rgba(251,191,36,0.06);border:1px solid rgba(251,191,36,0.15);border-radius:8px;font-size:11px;color:rgba(251,191,36,0.7)">⚠ Noch offen: ${missing.join(', ')}</div>` : '';
            const msgHtml = message ? `<div style="margin-top:10px;font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5">${message}</div>` : '';
            return `<div style="background:rgba(${rgb},0.04);border:1px solid rgba(${rgb},0.15);border-radius:12px;padding:16px;margin:8px 0;max-width:520px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                    <span style="font-size:16px">${isComplete?'✅':icon}</span>
                    <span style="font-size:13px;font-weight:700;color:white">${isComplete?label+' bereit':label+'-Entwurf'}</span>
                    ${confidence?`<span style="font-size:10px;padding:2px 8px;border-radius:8px;background:rgba(${rgb},0.1);color:rgba(${rgb},0.7)">${Math.round(confidence*100)}%</span>`:''}
                </div>
                ${fieldsHtml}${missingHtml}${msgHtml}
                ${buttonsHtml?`<div style="display:flex;gap:8px;margin-top:14px">${buttonsHtml}</div>`:''}
            </div>`;
        }

        // ── Universal Send (SSE Streaming) ──
        async function sendBxCmd(message) {
            const input = document.getElementById('chatInput');
            const btn = document.getElementById('chatSendBtn');
            if (!message) message = input.value.trim();

            // Collect attachments before clearing
            const currentAttachments = [...mainChatAttachments];
            mainChatAttachments = [];
            const attContainer = document.getElementById('mainChatAttachments');
            if (attContainer) { attContainer.innerHTML = ''; attContainer.style.display = 'none'; }

            if (!message && !currentAttachments.length) { _chatSending = false; btn.disabled = false; return; }
            input.value = ''; autoResize(input);
            btn.disabled = true;

            // Show user message with attachments
            let attachHtml = '';
            if (currentAttachments.length) {
                attachHtml = '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">';
                for (const att of currentAttachments) {
                    if (att.type === 'image') {
                        attachHtml += `<div style="border-radius:8px;overflow:hidden;border:1px solid var(--border)"><img src="data:${att.media_type};base64,${att.image_base64}" style="max-width:200px;max-height:150px;display:block"></div>`;
                    } else {
                        attachHtml += `<div style="padding:6px 10px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--text-secondary)">📄 ${att.name}</div>`;
                    }
                }
                attachHtml += '</div>';
            }
            if (!message) message = `Analysiere: ${currentAttachments.map(a=>a.name).join(', ')}`;
            appendMessage('user', attachHtml + formatMessage(message));
            bxCmdHistory.push({role:'user', content:message});

            const intentLabels = {project:'Projekt analysieren',lead:'Lead analysieren',model:'Modell bauen',context:'Kontext erfassen'};
            showTyping(bxCmdIntent ? `BEATRIX: ${intentLabels[bxCmdIntent]||'analysiert'}...` : 'BEATRIX erkennt Intent...');

            // Timeout controller - kill stuck requests after 90s
            const abortCtrl = new AbortController();
            const fetchTimeout = setTimeout(() => abortCtrl.abort(), 90000);

            try {
                const r = await fetch(`${API}/chat/intent/stream`, {
                    method:'POST',
                    headers:{...H(),'Content-Type':'application/json'},
                    signal: abortCtrl.signal,
                    body: JSON.stringify({
                        message, history: bxCmdHistory, current_draft: bxCmdDraft,
                        intent: bxCmdIntent, session_id: chatSessionId,
                        attachments: currentAttachments.map(a => ({type:a.type, name:a.name, content_text:a.content_text, image_base64:a.image_base64, media_type:a.media_type}))
                    })
                });

                if (!r.ok) {
                    const err = await r.json().catch(()=>({}));
                    removeTyping();
                    appendMessage('assistant', err.detail || err.error || 'Fehler.');
                    _chatSending = false; btn.disabled = false; input.focus(); return;
                }

                const reader = r.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let streamingMsgEl = null;
                let streamedText = '';
                let finalData = null;

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, {stream: true});

                    while (buffer.includes('\n\n')) {
                        const idx = buffer.indexOf('\n\n');
                        const line = buffer.substring(0, idx);
                        buffer = buffer.substring(idx + 2);

                        if (!line.startsWith('data: ')) continue;
                        let evt;
                        try { evt = JSON.parse(line.substring(6)); } catch { continue; }

                        if (evt.type === 'intent') {
                            // Update session type from intent
                            const newType = evt.session_type || evt.intent;
                            if (newType && newType !== 'general' && newType !== 'knowledge' && newType !== chatSessionType) {
                                const st = SESSION_TYPES[newType] || SESSION_TYPES.general;
                                const container = document.getElementById('chatMessages');
                                if (container) {
                                    container.insertAdjacentHTML('beforeend', `<div style="text-align:center;padding:6px 0;margin:4px 0"><span style="font-size:11px;padding:3px 12px;border-radius:12px;background:rgba(${st.color},0.1);color:rgba(${st.color},0.85);border:1px solid rgba(${st.color},0.2)">${st.icon} ${st.label}-Session gestartet</span></div>`);
                                }
                                updateSessionTypeBadge(newType);
                            } else if (newType) {
                                updateSessionTypeBadge(newType);
                            }
                            if (evt.entities) {
                                chatSessionEntities = {...chatSessionEntities, ...evt.entities};
                            }
                            removeTyping();
                            // Handle redirect to KB - call stream API directly (message already shown)
                            if (evt.status === 'redirect_kb') {
                                clearTimeout(fetchTimeout);
                                bxCmdMode = false;
                                toggleBxCmd();
                                // Stream response directly from /chat/stream
                                const container = document.getElementById('chatMessages');
                                const streamMsgId = 'bxRedirectMsg_' + Date.now();
                                container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant">
                                    <div class="chat-msg-avatar">B</div>
                                    <div class="chat-msg-body" id="${streamMsgId}">
                                        <span class="mb-cursor" style="display:inline-block;width:2px;height:16px;background:var(--accent);animation:blink 0.8s infinite;vertical-align:middle"></span>
                                    </div>
                                </div>`);
                                container.scrollTop = container.scrollHeight;
                                const targetEl = document.getElementById(streamMsgId);
                                let fullText = '';
                                const kbAbort = new AbortController();
                                const kbTimeout = setTimeout(() => kbAbort.abort(), 90000);
                                try {
                                    const sr = await fetch(`${API}/chat/stream`, {
                                        method:'POST', headers:{...H(),'Content-Type':'application/json'},
                                        signal: kbAbort.signal,
                                        body: JSON.stringify({question: message, session_id: chatSessionId, attachments: currentAttachments.map(a => ({type:a.type, name:a.name, content_text:a.content_text, image_base64:a.image_base64, media_type:a.media_type}))})
                                    });
                                    const sReader = sr.body.getReader();
                                    const sDec = new TextDecoder();
                                    let sBuf = '';
                                    while (true) {
                                        const {done,value} = await sReader.read();
                                        if (done) break;
                                        sBuf += sDec.decode(value, {stream:true});
                                        const sevts = sBuf.split('\n\n');
                                        sBuf = sevts.pop();
                                        for (const se of sevts) {
                                            for (const sl of se.split('\n')) {
                                                if (!sl.startsWith('data: ')) continue;
                                                try {
                                                    const sd = JSON.parse(sl.slice(6));
                                                    if (sd.type==='token' && sd.text) {
                                                        fullText += sd.text;
                                                        targetEl.innerHTML = mbRenderMd(fullText) + '<span class="mb-cursor" style="display:inline-block;width:2px;height:14px;background:var(--accent);animation:blink 0.8s infinite;vertical-align:middle;margin-left:2px"></span>';
                                                        container.scrollTop = container.scrollHeight;
                                                    }
                                                } catch(e){}
                                            }
                                        }
                                    }
                                    targetEl.innerHTML = mbRenderMd(fullText);
                                } catch(e) {
                                    targetEl.innerHTML = e.name === 'AbortError'
                                        ? '<span style="color:#fbbf24">⏱ Zeitüberschreitung – bitte nochmal versuchen.</span>'
                                        : '<span style="color:var(--error)">Fehler: ' + e.message + '</span>';
                                }
                                clearTimeout(kbTimeout);
                                _chatSending = false;
                                btn.disabled = false; input.focus(); return;
                            }
                            // Update intent indicator
                            const intent = evt.intent || 'project';
                            bxCmdIntent = intent;
                            updateBxIndicator(intent);
                            // Create streaming message container (unique ID per message)
                            const container = document.getElementById('chatMessages');
                            const bi = BX_INTENTS[intent] || {icon:'💡', color:'42,127,142'};
                            // Remove old bxStreamMsg IDs to avoid collision
                            document.querySelectorAll('#bxStreamMsg').forEach(el => el.removeAttribute('id'));
                            document.querySelectorAll('#bxStreamText').forEach(el => el.removeAttribute('id'));
                            const _msgUid = 'bx_' + Date.now();
                            container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant" id="bxStreamMsg" data-uid="${_msgUid}">
                                <div class="chat-msg-avatar" style="background:linear-gradient(135deg,rgba(${bi.color},0.8),rgba(${bi.color},0.4));font-size:12px">${bi.icon}</div>
                                <div class="chat-msg-body"><div id="bxStreamText" style="font-size:13px;line-height:1.6;color:rgba(255,255,255,0.85)"><span class="typing-dots" style="color:rgba(255,255,255,0.3)">●●●</span></div></div>
                            </div>`);
                            streamingMsgEl = document.getElementById('bxStreamText');
                            container.scrollTop = container.scrollHeight;
                        }

                        else if (evt.type === 'token' && streamingMsgEl) {
                            streamedText += evt.text;
                            streamingMsgEl.innerHTML = formatMessage(streamedText);
                            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
                        }

                        else if (evt.type === 'data') {
                            finalData = evt;
                            // Collect entities from structured data
                            if (evt.entities) chatSessionEntities = {...chatSessionEntities, ...evt.entities};
                            if (evt.data) {
                                if (evt.data.customer_code) chatSessionEntities.customer = evt.data.customer_code;
                                if (evt.data.customer_name) chatSessionEntities.customer_name = evt.data.customer_name;
                                if (evt.data.contact_person) chatSessionEntities.contact = evt.data.contact_person;
                                if (evt.data.name) chatSessionEntities.project_name = evt.data.name;
                            }
                        }

                        else if (evt.type === 'error') {
                            removeTyping();
                            if (streamingMsgEl) streamingMsgEl.innerHTML = `<span style="color:#f87171">Fehler: ${evt.text}</span>`;
                            else appendMessage('assistant', 'Fehler: ' + evt.text);
                        }
                    }
                }

                // ── Process final data ──
                if (finalData) {
                    const d = finalData;
                    const intent = d.intent || bxCmdIntent || 'project';

                    // Update draft
                    if (d.data && Object.keys(d.data).length > 0) {
                        bxCmdDraft = {...bxCmdDraft, ...d.data};
                    }

                    // Render structured card
                    let cardHtml = '';
                    const hasData = d.data && Object.keys(d.data).length > 0;
                    if (hasData) {
                        switch(intent) {
                            case 'project': cardHtml = renderProjectCard(bxCmdDraft, d.status, d.missing, d.confidence, d.message); break;
                            case 'lead': cardHtml = renderLeadCard(bxCmdDraft, d.status, d.missing, d.confidence, d.message); break;
                            case 'company': cardHtml = renderCompanyCard(bxCmdDraft, d.status, d.missing, d.confidence, d.message); break;
                            case 'model': cardHtml = renderModelCard(bxCmdDraft, d.status, d.missing, d.confidence, d.message); break;
                            case 'context': cardHtml = renderContextCard(bxCmdDraft, d.status, d.missing, d.confidence, d.message); break;
                            case 'task': cardHtml = renderTaskCard(bxCmdDraft, d.status, d.missing, d.confidence, d.message); break;
                        }
                    }

                    // Replace streaming div with final card (or keep text if no card)
                    const streamDiv = document.getElementById('bxStreamMsg');
                    if (streamDiv) {
                        if (cardHtml) {
                            const bi = BX_INTENTS[intent] || {icon:'💡', color:'42,127,142'};
                            streamDiv.querySelector('.chat-msg-body').innerHTML = cardHtml;
                        } else if (!streamedText && d.message) {
                            streamDiv.querySelector('.chat-msg-body').innerHTML = formatMessage(d.message);
                        }
                        // If we already streamed text AND have a card, show both
                        else if (streamedText && cardHtml) {
                            const bi = BX_INTENTS[intent] || {icon:'💡', color:'42,127,142'};
                            streamDiv.querySelector('.chat-msg-body').innerHTML = cardHtml;
                        }
                    }

                    bxCmdHistory.push({role:'assistant', content: d.message || streamedText || JSON.stringify(d.data)});
                    document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
                } else if (streamedText) {
                    // No structured data, just text
                    bxCmdHistory.push({role:'assistant', content: streamedText});
                } else {
                    // Nothing at all - show fallback
                    const stuckDiv = document.getElementById('bxStreamMsg');
                    if (stuckDiv) {
                        stuckDiv.querySelector('.chat-msg-body').innerHTML = '<span style="color:#fbbf24">Keine Antwort erhalten – bitte nochmal versuchen.</span>';
                    }
                }

            } catch(e) {
                removeTyping();
                // Clean up stuck streaming dots
                const stuckStream = document.getElementById('bxStreamMsg');
                if (stuckStream) {
                    const body = stuckStream.querySelector('.chat-msg-body');
                    if (body && body.textContent.trim() === '●●●') {
                        body.innerHTML = e.name === 'AbortError'
                            ? '<span style="color:#fbbf24">⏱ Zeitüberschreitung – bitte nochmal versuchen.</span>'
                            : `<span style="color:#f87171">Verbindungsfehler: ${e.message}</span>`;
                    }
                } else {
                    appendMessage('assistant', e.name === 'AbortError'
                        ? '⏱ Zeitüberschreitung – bitte nochmal versuchen.'
                        : 'Verbindungsfehler: ' + e.message);
                }
            }
            clearTimeout(fetchTimeout);
            // Always clean up stuck streaming indicators
            const leftoverDots = document.querySelector('#bxStreamText .typing-dots');
            if (leftoverDots) leftoverDots.remove();
            // Add copy/challenge buttons to the streamed message
            const finalStreamEl = document.getElementById('bxStreamMsg');
            if (finalStreamEl) addMsgActionButtons(finalStreamEl);
            removeTyping();
            _chatSending = false;
            btn.disabled = false;
            input.focus();
        }

        function updateBxIndicator(intent) {
            const bi = BX_INTENTS[intent];
            if (!bi) return;
            const el = document.getElementById('prjChatIndicator');
            el.innerHTML = `${bi.icon} <strong>${bi.label}-Modus</strong> – Beschreibe Details, BEATRIX strukturiert automatisch.
                <span onclick="toggleBxCmd()" style="cursor:pointer;margin-left:8px;color:rgba(255,255,255,0.3)">✕</span>`;
            el.style.borderColor = `rgba(${bi.color},0.15)`;
            el.style.background = `rgba(${bi.color},0.06)`;
            el.style.color = `rgba(${bi.color},0.7)`;
        }

        function bxRefine() {
            document.getElementById('chatInput').focus();
            document.getElementById('chatInput').placeholder = '✏ Was möchtest du ändern?';
        }

        // ── Confirm Actions ──
        async function bxConfirmProject() {
            const d = bxCmdDraft;
            if (!d.customer_code || !d.name) { showToast('Kunde und Projektname fehlen', 'error'); return; }
            showTyping('Projekt wird auf GitHub eröffnet...');
            try {
                const r = await fetch(`${API}/projects`, {
                    method:'POST', headers:{...H(),'Content-Type':'application/json'},
                    body: JSON.stringify({
                        customer_code: d.customer_code, name: d.name,
                        type: d.type||'beratung', project_category: d.project_category||'mandat',
                        description: d.description||'', start_date: d.start_date||new Date().toISOString().slice(0,10),
                        end_date: d.end_date||'', budget_chf: d.budget_chf||d.budget||null,
                        budget: d.budget||d.budget_chf||null, currency: d.currency||'CHF',
                        billing_type: d.billing_type||'fixed', fa_owner: d.fa_owner||'GF',
                        fa_team: d.fa_team||[]
                    })
                });
                const res = await r.json();
                removeTyping();
                if (r.ok && res.ok) {
                    bxShowSuccess('Projekt eröffnet', res.project_code, d.name, d.project_category, `showSection('projects');prjOpenLanding('${res.slug}')`);
                    bxCmdDraft = {}; bxCmdHistory = []; bxCmdIntent = '';
                    showToast(`✓ ${res.project_code} eröffnet!`, 'success');
                } else { appendMessage('assistant', '❌ ' + (res.error||'Fehler')); }
            } catch(e) { removeTyping(); appendMessage('assistant', '❌ ' + e.message); }
        }

        async function bxConfirmLead() {
            const d = bxCmdDraft;
            if (!d.customer_name && !d.customer_code) { showToast('Kundenname fehlt', 'error'); return; }
            showTyping('Lead wird erfasst...');
            try {
                const payload = {
                    company: d.customer_name || d.customer_code || '',
                    customer_code: d.customer_code || '',
                    is_new_customer: d.is_new_customer !== false,
                    contact: d.contact_person || '',
                    email: d.contact_email || '',
                    stage: d.stage || 'initial_contact',
                    value: d.estimated_value_chf || d.estimated_value || 0,
                    currency: d.currency || 'CHF',
                    value_original: d.estimated_value || d.estimated_value_chf || 0,
                    source: d.source || 'inbound',
                    notes: [d.opportunity, d.notes, d.next_action ? `Next: ${d.next_action}` : '', d.currency && d.currency !== 'CHF' ? `Originalwährung: ${d.currency}` : ''].filter(Boolean).join(' | ')
                };
                const r = await fetch(`${API}/leads`, {
                    method:'POST', headers:{...H(),'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
                const res = await r.json();
                removeTyping();
                if (r.ok) {
                    const leadCode = res.lead_code || '';
                    bxShowSuccess('Lead erfasst', leadCode, d.opportunity||d.customer_name, 'lead', '');
                    bxCmdDraft = {}; bxCmdHistory = []; bxCmdIntent = '';
                    showToast(`✓ ${leadCode || 'Lead'} erfasst!`, 'success');
                } else { appendMessage('assistant', '❌ ' + (res.error||res.detail||'Fehler')); }
            } catch(e) { removeTyping(); appendMessage('assistant', '❌ ' + e.message); }
        }

        async function bxConfirmCompany() {
            const d = bxCmdDraft;
            if (!d.name) { showToast('Firmenname fehlt', 'error'); return; }
            showTyping('Firma wird angelegt...');
            try {
                const payload = {
                    name: d.name,
                    code: d.code || '',
                    short_name: d.short_name || d.code || '',
                    industry: d.industry || '',
                    country: d.country || 'CH',
                    website: d.website || '',
                    fa_owner: d.fa_owner || '',
                    notes: d.notes || '',
                    is_new_customer: d.is_new_customer !== false
                };
                const r = await fetch(`${API}/crm/companies`, {
                    method: 'POST', headers: {...H(), 'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const res = await r.json();
                removeTyping();
                if (r.ok) {
                    const code = res.code || d.code || '';
                    const ghStatus = res.github === 'added' ? ' + GitHub Registry' : res.github === 'exists' ? ' (existierte schon in Registry)' : '';
                    bxShowSuccess('Firma angelegt', `CUS-${code}`, d.name, 'company', '');
                    bxCmdDraft = {}; bxCmdHistory = []; bxCmdIntent = '';
                    showToast(`✓ ${d.name} (${code}) angelegt${ghStatus}`, 'success');
                    // Refresh companies view if loaded
                    if (crmCompaniesData.length) crmLoadCompanies();
                } else { appendMessage('assistant', '❌ ' + (res.error||res.detail||'Fehler')); }
            } catch(e) { removeTyping(); appendMessage('assistant', '❌ ' + e.message); }
        }

        async function bxConfirmModel() {
            // Save model to project or as standalone
            const d = bxCmdDraft;
            showTyping('Modell wird gespeichert...');
            try {
                if (d.project_slug) {
                    const r = await fetch(`${API}/projects/${d.project_slug}`, {
                        method:'PUT', headers:{...H(),'Content-Type':'application/json'},
                        body: JSON.stringify({section:'ebf_integration', data: d})
                    });
                    removeTyping();
                    if (r.ok) {
                        bxShowSuccess('Modell gespeichert', '', d.model_type||'BCM', 'model', d.project_slug ? `showSection('projects');prjOpenLanding('${d.project_slug}')` : '');
                        bxCmdDraft = {}; bxCmdHistory = []; bxCmdIntent = '';
                        showToast('✓ Modell gespeichert!', 'success');
                    } else { appendMessage('assistant', '❌ Fehler beim Speichern'); }
                } else {
                    removeTyping();
                    // Show as downloadable summary
                    const container = document.getElementById('chatMessages');
                    container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant">
                        <div class="chat-msg-avatar" style="background:linear-gradient(135deg,rgba(139,170,255,0.8),rgba(139,170,255,0.4));font-size:12px">🔬</div>
                        <div class="chat-msg-body"><div style="padding:12px;background:rgba(139,170,255,0.06);border:1px solid rgba(139,170,255,0.15);border-radius:12px;font-size:12px;color:rgba(255,255,255,0.5)">
                            ✅ Modell erstellt. Um es in ein Projekt zu integrieren, nenne das Projektkürzel oder erstelle zuerst ein Projekt.
                            <pre style="margin-top:8px;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;font-size:10px;overflow-x:auto;color:rgba(255,255,255,0.4)">${JSON.stringify(d, null, 2)}</pre>
                        </div></div>
                    </div>`);
                    container.scrollTop = container.scrollHeight;
                    bxCmdDraft = {}; bxCmdHistory = []; bxCmdIntent = '';
                }
            } catch(e) { removeTyping(); appendMessage('assistant', '❌ ' + e.message); }
        }

        async function bxConfirmContext() {
            const d = bxCmdDraft;
            if (!d.customer_code) { showToast('Kundencode fehlt', 'error'); return; }
            showTyping('Kontext wird gespeichert...');
            try {
                // Save to customer folder as context.yaml
                const r = await fetch(`${API}/customers/${d.customer_code}/context`, {
                    method:'PUT', headers:{...H(),'Content-Type':'application/json'},
                    body: JSON.stringify(d)
                });
                removeTyping();
                if (r.ok) {
                    bxShowSuccess('Kontext gespeichert', '', (d.customer_code||'').toUpperCase(), 'context', '');
                    bxCmdDraft = {}; bxCmdHistory = []; bxCmdIntent = '';
                    showToast('✓ Kontext gespeichert!', 'success');
                } else {
                    // Fallback: show summary
                    const container = document.getElementById('chatMessages');
                    container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant">
                        <div class="chat-msg-avatar" style="background:linear-gradient(135deg,rgba(232,163,61,0.8),rgba(232,163,61,0.4));font-size:12px">🧠</div>
                        <div class="chat-msg-body"><div style="padding:12px;background:rgba(232,163,61,0.06);border:1px solid rgba(232,163,61,0.15);border-radius:12px;font-size:12px;color:rgba(255,255,255,0.5)">
                            ✅ Kontext erfasst. Speicher-Endpoint noch nicht eingerichtet – hier die strukturierten Daten:
                            <pre style="margin-top:8px;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;font-size:10px;overflow-x:auto;color:rgba(255,255,255,0.4)">${JSON.stringify(d, null, 2)}</pre>
                        </div></div>
                    </div>`);
                    container.scrollTop = container.scrollHeight;
                    bxCmdDraft = {}; bxCmdHistory = []; bxCmdIntent = '';
                }
            } catch(e) { removeTyping(); appendMessage('assistant', '❌ ' + e.message); }
        }

        async function bxConfirmTask() {
            const d = bxCmdDraft;
            if (!d.title) { showToast('Task-Titel fehlt', 'error'); return; }
            showTyping('Task wird erstellt...');
            try {
                const payload = {
                    title: d.title,
                    description: d.description || '',
                    assignee_type: d.assignee_type || 'consultant',
                    assignee: d.assignee || '',
                    customer_code: d.customer_code || '',
                    project_slug: d.project_slug || '',
                    lead_id: d.lead_id || '',
                    priority: d.priority || 'normal',
                    due_date: d.due_date || null,
                    category: d.category || '',
                    source: 'chat',
                    escalation_after_days: d.escalation_after_days || null
                };
                const r = await fetch(`${API}/tasks`, {
                    method:'POST', headers:{...H(),'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
                const res = await r.json();
                removeTyping();
                if (r.ok) {
                    const typeLabels = {consultant:'Berater', bdm:'BDM-Team', beatrix:'BEATRIX', external:'Extern'};
                    bxShowSuccess('Task erstellt', res.id || '', `${d.title} → ${typeLabels[d.assignee_type]||d.assignee_type}`, 'task', '');
                    bxCmdDraft = {}; bxCmdHistory = []; bxCmdIntent = '';
                    showToast(`✓ ${res.id || 'Task'} erstellt!`, 'success');
                } else { appendMessage('assistant', '❌ ' + (res.error||res.detail||'Fehler')); }
            } catch(e) { removeTyping(); appendMessage('assistant', '❌ ' + e.message); }
        }

        function bxShowSuccess(title, code, subtitle, cat, onclickAction) {
            const container = document.getElementById('chatMessages');
            const bi = BX_INTENTS[cat] || {icon:'✅', color:'52,211,153'};
            container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant">
                <div class="chat-msg-avatar" style="background:linear-gradient(135deg,rgba(${bi.color},0.8),rgba(${bi.color},0.4));font-size:12px">✓</div>
                <div class="chat-msg-body">
                    <div style="background:rgba(52,211,153,0.06);border:1px solid rgba(52,211,153,0.2);border-radius:12px;padding:16px">
                        <div style="font-size:14px;font-weight:700;color:#34d399;margin-bottom:8px">✅ ${title}</div>
                        ${code ? `<div style="font-size:20px;font-weight:800;color:white;font-family:monospace;letter-spacing:1px;margin-bottom:4px">${code}</div>` : ''}
                        <div style="font-size:12px;color:rgba(255,255,255,0.4)">${subtitle}</div>
                        ${onclickAction ? `<div style="margin-top:12px"><button onclick="${onclickAction}" style="padding:8px 16px;background:rgba(42,127,142,0.15);border:1px solid rgba(42,127,142,0.3);border-radius:8px;color:var(--accent-light);font-size:12px;font-weight:600;cursor:pointer">→ Öffnen</button></div>` : ''}
                    </div>
                </div>
            </div>`);
            container.scrollTop = container.scrollHeight;
        }

        async function loadChatHistory() {
            if (chatLoaded) return;
            try {
                const r = await fetch(`${API}/chat/history?limit=30`, {headers:H()});
                if (!r.ok) return;
                const msgs = await r.json();
                if (msgs.length > 0) {
                    const welcome = document.getElementById('chatWelcome');
                    if (welcome) welcome.style.display = 'none';
                    for (const m of msgs) {
                        appendMessage(m.role, m.content, m.sources);
                    }
                }
                chatLoaded = true;
            } catch(e) { console.error('Chat history error:', e); }
        }

        // ═══════ MODEL BUILDING WORKFLOW ═══════
        const mbState = { mode: null, step: 0, question: '', selections: {}, sessionId: null, selectedProblem: null };

        const MB_MODELS = [
            { id:'MOD-001', name:'Religious Tradition Distance Model', v:'2.0', domain:'REL', type:'distance_comparison' },
            { id:'MOD-REF-001', name:'Organic Referral Behavior Model', v:'1.0', domain:'ORG', type:'behavior' },
            { id:'MOD-PSF', name:'Papal Succession Framework', v:'2.0', domain:'REL', type:'process' },
            { id:'MOD-ESL', name:'Empirical Stability of Language Framework', v:'1.0', domain:'EDU', type:'analysis' },
            { id:'MOD-NEAR-001', name:'Nearshoring Location Decision Model', v:'1.0', domain:'FIN', type:'decision' },
            { id:'MOD-IDV-001', name:'Interdependence Understanding Model', v:'2.0', domain:'ORG', type:'analysis' },
            { id:'MOD-PSM-001', name:'Philoro Strategy Model', v:'1.0', domain:'FIN', type:'strategy' },
            { id:'MOD-MSR-001', name:'Mission Statement Resonance Model', v:'1.0', domain:'ORG', type:'analysis' },
            { id:'MOD-ECHfP-001', name:'ECHfP Heating Replacement Behavioral Model', v:'1.0', domain:'ENV', type:'decision' },
            { id:'MOD-CPS-001', name:'Complex Problem Solving 10C Mapping', v:'1.0', domain:'EDU', type:'analysis' },
            { id:'MOD-TA-001', name:'Time-Intensive Goods Substitution Model', v:'1.0', domain:'FIN', type:'continuous' },
            { id:'MOD-HMWM-001', name:'Holistic Migration Welfare Model', v:'3.3', domain:'POL', type:'process' },
            { id:'MOD-012', name:'Fiscal Behavior Model (FBM-CH)', v:'1.0', domain:'FIN', type:'continuous' },
            { id:'MOD-ZIN-001', name:'Kreislaufwirtschaft Behavior Dynamics ODE Model', v:'1.0', domain:'ENV', type:'process' },
            { id:'MOD-PMWT-001', name:'Pharma-MFN Welfare Transfer Model', v:'1.0', domain:'HLT', type:'analysis' },
            { id:'MOD-FIN-BUBBLE-001', name:'AI Bubble Diagnostic & Prognostic Model', v:'1.1', domain:'FIN', type:'analysis' },
            { id:'MOD-ORG-BMW-001', name:'BMW Product Compliance Behavioral Model', v:'1.0', domain:'ORG', type:'decision' },
            { id:'MOD-HLT-RES-001', name:'Health Reskilling Readiness Model', v:'1.0', domain:'HLT', type:'process' },
            { id:'MOD-EDU-LLL-001', name:'Lifelong Learning Adoption Model', v:'1.0', domain:'EDU', type:'continuous' },
            { id:'MOD-POL-TAX-001', name:'Tax Compliance Behavioral Model', v:'1.0', domain:'POL', type:'continuous' },
            { id:'MOD-ENV-MOB-001', name:'Sustainable Mobility Transition Model', v:'1.0', domain:'ENV', type:'process' }
        ];

        const DOMAIN_LABELS = { REL:'Religion', FIN:'Finance', HLT:'Health', ENV:'Environment', POL:'Policy', ORG:'Organization', EDU:'Education', OTH:'Other' };
        const DOMAIN_COLORS = { REL:'#a78bfa', FIN:'#34d399', HLT:'#f87171', ENV:'#60a5fa', POL:'#fbbf24', ORG:'#f472b6', EDU:'#38bdf8', OTH:'#94a3b8' };

        function mbSelectMode(el, mode) {
            // Double-tap = Workflow starten
            if (el.classList.contains('selected') && mbState.mode === mode) {
                mbStartWorkflow();
                return;
            }
            document.querySelectorAll('.mb-mode-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            mbState.mode = mode;
            document.getElementById('mbStartBtn').disabled = false;
        }

        // ── Smart Defaults Engine ──────────────────────
        let mbUserProfile = null;  // loaded on workflow start
        let mbDefaults = {};       // computed defaults per step

        async function mbLoadUserProfile() {
            try {
                const [profResp, psiResp] = await Promise.all([
                    fetch('/api/profile', { headers: { 'Authorization': 'Bearer ' + authToken } }),
                    fetch('/api/insight/profile', { headers: { 'Authorization': 'Bearer ' + authToken } }).catch(() => null)
                ]);
                const profile = await profResp.json();
                let psi = null;
                if (psiResp && psiResp.ok) psi = await psiResp.json();

                mbUserProfile = {
                    name: profile.name || '',
                    expertise: profile.expertise || [],
                    position: profile.position || '',
                    company: profile.company || '',
                    psiInsights: psi?.total_insights || 0,
                    psiDomain: psi?.primary_domain || null,
                    psiStyle: psi?.primary_thinking_style || null,
                    psiEngagement: psi?.engagement_score || 0,
                    psiSpeed: psi?.avg_decision_speed || null,
                };
                console.log('📊 User profile loaded:', mbUserProfile);
                mbComputeDefaults();
                return profile;
            } catch(e) {
                console.warn('Profile load failed, using BEATRIX defaults');
                mbUserProfile = null;
                mbComputeDefaults();
                return null;
            }
        }

        function mbComputeDefaults() {
            const u = mbUserProfile;
            const isNew = !u || (u.psiInsights === 0 && u.expertise.length === 0);
            const isExperienced = u && (u.psiInsights >= 3 || u.expertise.length >= 2);
            const domain = mbState.selections?.domain || u?.psiDomain || null;
            const style = u?.psiStyle || null;

            // Mode
            if (isNew) {
                mbDefaults.mode = 'gefuehrt';
            } else if (isExperienced) {
                mbDefaults.mode = 'schnell';
            } else {
                mbDefaults.mode = 'gefuehrt';
            }

            // Step 1: Entry Point
            if (style?.includes('analytical') || style?.includes('systemic')) {
                mbDefaults.step1 = 'theory';
            } else if (style?.includes('intuitive') || style?.includes('empathic')) {
                mbDefaults.step1 = 'practice';
            } else if (isExperienced) {
                mbDefaults.step1 = 'hybrid';
            } else {
                mbDefaults.step1 = 'practice';
            }

            // Step 2: Scope (Behavior Type)
            if (['FIN', 'POL'].includes(domain)) {
                mbDefaults.step2 = 'decision';
            } else if (['HLT', 'ENV', 'EDU'].includes(domain)) {
                mbDefaults.step2 = 'continuous';
            } else if (['ORG'].includes(domain)) {
                mbDefaults.step2 = 'process';
            } else {
                mbDefaults.step2 = 'decision';
            }

            // Step 3: Context Ψ
            if (isNew) {
                mbDefaults.step3 = 'ggg-default';
            } else if (isExperienced) {
                mbDefaults.step3 = 'full-8psi';
            } else {
                mbDefaults.step3 = 'ggg-default';
            }

            // Step 6: Report Depth
            if (isNew) {
                mbDefaults.depth = 'standard';
            } else {
                mbDefaults.depth = 'deep';
            }

            console.log('🎯 Defaults computed:', mbDefaults, '(isNew:', isNew, 'isExperienced:', isExperienced, ')');
        }

        function mbApplyDefault(step) {
            // Recompute with latest domain info from Step 0
            mbComputeDefaults();

            if (step === 'start') {
                // Auto-select mode
                const cards = document.querySelectorAll('.mb-mode-card');
                const modeMap = ['schnell', 'gefuehrt', 'template', 'custom'];
                cards.forEach((card, i) => {
                    card.querySelector('.mb-default-badge')?.remove();
                    if (modeMap[i] === mbDefaults.mode) {
                        card.insertAdjacentHTML('beforeend', '<div class="mb-default-badge">empfohlen</div>');
                        // Auto-select
                        if (!mbState.mode) {
                            mbSelectMode(card, mbDefaults.mode);
                        }
                    }
                });
            }

            if (step === 1) {
                mbApplyChoiceDefault('mbStep1', mbDefaults.step1);
            }
            if (step === 2) {
                mbApplyChoiceDefault('mbStep2', mbDefaults.step2);
            }
            if (step === 3) {
                mbApplyChoiceDefault('mbStep3', mbDefaults.step3);
            }
            if (step === 6) {
                // Depth default
                const def = mbDefaults.depth || 'standard';
                setTimeout(() => {
                    // Remove old badges first
                    document.querySelectorAll('#mbDepthChoice .mb-default-badge').forEach(b => b.remove());
                    const el = def === 'deep' ? document.getElementById('mbDepthDeep') : document.getElementById('mbDepthStd');
                    if (el) {
                        el.style.position = 'relative';
                        el.insertAdjacentHTML('afterbegin', '<div class="mb-default-badge" style="position:absolute;top:10px;right:12px">empfohlen</div>');
                        mbSelectDepth(def, el);
                    }
                }, 150);
            }
        }

        function mbApplyChoiceDefault(panelId, defaultValue) {
            const panel = document.getElementById(panelId);
            if (!panel) return;
            const choices = panel.querySelectorAll('.mb-choice');
            let applied = false;

            choices.forEach(choice => {
                // Remove old badges
                choice.querySelector('.mb-default-badge')?.remove();

                // Find value from onclick
                const onclick = choice.getAttribute('onclick') || '';
                const match = onclick.match(/mbSelect\(this,'([^']+)'\)/);
                if (match && match[1] === defaultValue) {
                    choice.insertAdjacentHTML('beforeend', '<div class="mb-default-badge">empfohlen</div>');
                    // Auto-select if nothing selected yet
                    const alreadySelected = panel.querySelector('.mb-choice.selected');
                    if (!alreadySelected) {
                        mbSelect(choice, defaultValue, true);  // silent, no confirmation
                        applied = true;
                    }
                }
            });
        }

        function mbStartWorkflow() {
            if (!mbState.mode) return;
            mbState.step = 0;
            mbState.selectedProblem = null;
            mbShowPanel('mbStep0');
            document.getElementById('mbProgress').style.display = 'flex';
            mbUpdateProgress(0);
            mbLoadPersonalizedQuestions();
            mbApplyDefault(0);
        }

        async function mbLoadPersonalizedQuestions() {
            const container = document.getElementById('mbStep0Choices');
            try {
                // Use already-loaded profile or load fresh
                const profile = mbUserProfile || await mbLoadUserProfile();
                const expertise = (profile?.expertise || []).join(', ') || 'Behavioral Economics';
                const userName = profile?.name || 'User';
                const position = profile?.position || '';
                const company = profile?.company || '';

                // 2. Ask BEATRIX to generate 3 personalized questions
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: `Generiere genau 3 Problemstellungen für den EEE Model-Building Workflow, personalisiert für dieses Profil:
- Name: ${userName}
- Position: ${position}
- Unternehmen: ${company}
- Expertise: ${expertise}

Jede Problemstellung soll ein reales Verhaltensphänomen beschreiben, das mit dem BCM modellierbar ist.

Antworte NUR als JSON Array:
[{"icon":"emoji","title":"Kurztitel max 4 Worte","phenomenon":"Beobachtbares Verhalten, 1 Satz mit Zahlen/Fakten","paradox":"Warum ist das überraschend/problematisch, 1 Satz","question":"Konkrete Forschungsfrage, 1 Satz","domain":"REL/FIN/HLT/ENV/POL/ORG/EDU/OTH"}]` })
                });
                const data = await resp.json();

                let questions = null;
                if (data.answer) {
                    try {
                        const jsonMatch = data.answer.match(/\[[\s\S]*\]/);
                        if (jsonMatch) questions = JSON.parse(jsonMatch[0]);
                    } catch(e) { console.error('Parse error:', e); }
                }

                // 3. Fallback if generation failed
                if (!questions || questions.length < 3) {
                    questions = [
                        { icon: '🏢', title: 'Strategie & Verhalten', phenomenon: `Über 70% der strategischen Initiativen in Beratungsunternehmen wie ${company || 'FehrAdvice'} stoßen auf interne Verhaltenswiderstände.`, paradox: 'Selbst Mitarbeiter, die den Wandel befürworten, fallen in alte Routinen zurück.', question: 'Welche BCM-Hebel können die Umsetzungsrate strategischer Entscheidungen nachhaltig steigern?', domain: 'ORG' },
                        { icon: '🧠', title: 'Decision Architecture', phenomenon: 'Change-Prozesse in Organisationen erreichen typischerweise nur 30% der geplanten Akzeptanzrate.', paradox: 'Mehr Kommunikation und Incentives führen paradoxerweise zu stärkerem Widerstand.', question: 'Wie kann Choice Architecture die Akzeptanz von Veränderungsprozessen in Organisationen erhöhen?', domain: 'ORG' },
                        { icon: '💰', title: 'Finanzentscheidungen', phenomenon: 'Privatinvestoren erzielen im Schnitt 2-4% weniger Rendite als passive Markt-Benchmarks.', paradox: 'Trotz verfügbarer ETF-Strategien handeln 80% aktiv und systematisch schlechter.', question: 'Wie kann Decision Architecture die rationalen Anlageentscheidungen von Privatinvestoren korrigieren?', domain: 'FIN' }
                    ];
                }

                // 4. Render personalized choices as clean tap cards
                // Store questions globally for structured selection
                window._mbQuestions = questions.slice(0, 3);
                container.innerHTML = window._mbQuestions.map((q, i) => `
                    <div onclick="mbSelectProblemStructured(${i})"
                         style="padding:16px 18px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:all 0.2s;background:rgba(255,255,255,0.02)"
                         onmouseover="this.style.borderColor='var(--accent)';this.style.background='rgba(139,170,255,0.06)'"
                         onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.background='rgba(255,255,255,0.02)'">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                            <span style="font-size:18px">${q.icon || '📋'}</span>
                            <span style="font-weight:600;color:white;font-size:15px">${q.title}</span>
                            <span style="margin-left:auto;font-size:11px;color:var(--accent);opacity:0.6">${q.domain}</span>
                        </div>
                        <div style="font-size:13px;color:rgba(255,255,255,0.55);line-height:1.5">${q.phenomenon || q.question || ''}</div>
                    </div>
                `).join('');

            } catch(e) {
                console.error('Load questions error:', e);
                window._mbQuestions = [
                    { icon: '🧠', title: 'Behavioral Strategy', phenomenon: 'Über 60% der strategischen Initiativen in Organisationen scheitern an Verhaltensbarrieren.', paradox: 'Selbst wenn alle Stakeholder zustimmen, blockiert Status-Quo-Bias die Umsetzung.', question: 'Wie kann Behavioral Economics die Implementierungsrate strategischer Entscheidungen verbessern?', domain: 'ORG' },
                    { icon: '🏗️', title: 'Change & Architecture', phenomenon: 'Change-Prozesse erreichen typischerweise nur 30% der geplanten Akzeptanzrate.', paradox: 'Mehr Information und Kommunikation führt paradoxerweise zu mehr Widerstand.', question: 'Wie kann Decision Architecture die Akzeptanz von Veränderungsprozessen erhöhen?', domain: 'ORG' },
                    { icon: '💰', title: 'Investment Biases', phenomenon: 'Privatanleger erzielen im Schnitt 2-4% weniger Rendite als Markt-Benchmarks.', paradox: 'Trotz verfügbarer passiver Strategien handeln 80% aktiv und verlieren.', question: 'Welche BCM-Hebel können systematische Anlage-Verzerrungen korrigieren?', domain: 'FIN' }
                ];
                container.innerHTML = window._mbQuestions.map((q, i) => `
                    <div onclick="mbSelectProblemStructured(${i})"
                         style="padding:16px 18px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:all 0.2s;background:rgba(255,255,255,0.02)"
                         onmouseover="this.style.borderColor='var(--accent)';this.style.background='rgba(139,170,255,0.06)'"
                         onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.background='rgba(255,255,255,0.02)'">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                            <span style="font-size:18px">${q.icon}</span>
                            <span style="font-weight:600;color:white;font-size:15px">${q.title}</span>
                            <span style="margin-left:auto;font-size:11px;color:var(--accent);opacity:0.6">${q.domain}</span>
                        </div>
                        <div style="font-size:13px;color:rgba(255,255,255,0.55);line-height:1.5">${q.phenomenon}</div>
                    </div>
                `).join('');
            }
        }

        // ── Universal Streaming + Progressive Reveal ──────────
        function mbRenderMd(text) {
            // v3.12 Full markdown → HTML renderer
            if (!text || typeof text !== 'string') return '';
            try {
            const lines = text.split('\n');
            let html = '';
            let inTable = false;
            let tableRows = [];
            let inList = false;

            function flushTable() {
                if (!tableRows.length) return '';
                let t = '<table style="width:100%;border-collapse:collapse;margin:16px 0;font-size:13px">';
                tableRows.forEach((row, ri) => {
                    // Skip separator rows (|---|---|)
                    if (/^\|[\s\-:]+\|/.test(row) && row.replace(/[\s\-:|]/g, '') === '') return;
                    const cells = row.split('|').filter((c, i, a) => i > 0 && i < a.length - 1);
                    const isHeader = ri === 0;
                    t += '<tr>';
                    cells.forEach(cell => {
                        const tag = isHeader ? 'th' : 'td';
                        const style = isHeader
                            ? 'padding:8px 10px;text-align:left;font-weight:600;color:var(--accent);border-bottom:2px solid rgba(139,170,255,0.2);font-size:12px;text-transform:uppercase;letter-spacing:0.3px'
                            : 'padding:8px 10px;text-align:left;color:rgba(255,255,255,0.8);border-bottom:1px solid rgba(255,255,255,0.05);vertical-align:top;line-height:1.5';
                        const content = cell.trim().replace(/\*\*(.*?)\*\*/g, '<strong style="color:white">$1</strong>');
                        t += `<${tag} style="${style}">${content}</${tag}>`;
                    });
                    t += '</tr>';
                });
                t += '</table>';
                tableRows = [];
                inTable = false;
                return t;
            }

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Table detection
                if (line.trim().startsWith('|') && line.trim().endsWith('|')) {
                    if (!inTable) inTable = true;
                    tableRows.push(line);
                    continue;
                } else if (inTable) {
                    html += flushTable();
                }

                // Horizontal rule
                if (/^---+$/.test(line.trim())) {
                    html += '<hr style="border:none;border-top:1px solid rgba(255,255,255,0.08);margin:20px 0">';
                    continue;
                }

                // Headers
                if (line.startsWith('#### ')) {
                    html += `<div style="font-size:13px;font-weight:700;color:rgba(255,255,255,0.85);margin:16px 0 6px">${inlineMd(line.slice(5))}</div>`;
                    continue;
                }
                if (line.startsWith('### ')) {
                    html += `<h4 style="color:var(--accent);font-size:14px;font-weight:700;margin:20px 0 8px;letter-spacing:0.3px">${line.slice(4)}</h4>`;
                    continue;
                }
                if (line.startsWith('## ')) {
                    html += `<div style="font-size:16px;font-weight:700;color:white;margin:24px 0 10px;padding-bottom:6px;border-bottom:1px solid rgba(139,170,255,0.15)">${line.slice(3)}</div>`;
                    continue;
                }
                if (line.startsWith('# ')) {
                    html += `<div style="font-size:20px;font-weight:700;color:white;margin:8px 0 12px">${line.slice(2)}</div>`;
                    continue;
                }

                // List items
                if (/^[-*] /.test(line.trim())) {
                    const content = line.trim().replace(/^[-*] /, '');
                    html += `<div style="display:flex;gap:8px;padding:3px 0 3px 4px"><span style="color:var(--accent);flex-shrink:0">•</span><span>${inlineMd(content)}</span></div>`;
                    continue;
                }
                if (/^\d+\. /.test(line.trim())) {
                    const m = line.trim().match(/^(\d+)\. (.*)/);
                    html += `<div style="display:flex;gap:8px;padding:3px 0 3px 4px"><span style="color:var(--accent);flex-shrink:0;font-weight:600;min-width:18px">${m[1]}.</span><span>${inlineMd(m[2])}</span></div>`;
                    continue;
                }

                // Empty line = paragraph break
                if (line.trim() === '') {
                    html += '<div style="height:8px"></div>';
                    continue;
                }

                // Normal paragraph
                html += `<div style="padding:2px 0;line-height:1.7">${inlineMd(line)}</div>`;
            }

            // Flush remaining table
            if (inTable) html += flushTable();

            return html;
            } catch(e) {
                console.error('mbRenderMd error:', e);
                // Fallback: basic inline rendering
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');
            }
        }

        function inlineMd(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color:rgba(255,255,255,0.95)">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em style="color:rgba(255,255,255,0.7)">$1</em>')
                .replace(/`(.*?)`/g, '<code style="background:rgba(139,170,255,0.1);padding:1px 5px;border-radius:4px;font-size:12px;color:var(--accent)">$1</code>');
        }

        async function mbStreamChat(prompt, targetEl, opts = {}) {
            /**
             * Streams Claude response into targetEl with typewriter effect.
             * opts: { onStart, onDone, onError, showCursor }
             */
            const { onStart, onDone, onError, showCursor = true } = opts;
            let fullText = '';
            let renderBuffer = '';
            let renderTimer = null;

            // Show cursor
            if (showCursor) {
                targetEl.innerHTML = '<span class="mb-cursor" style="display:inline-block;width:2px;height:16px;background:var(--accent);animation:blink 0.8s infinite;vertical-align:middle"></span>';
            }
            if (onStart) onStart();

            try {
                const resp = await fetch(`${API}/chat/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: prompt })
                });

                if (!resp.ok) {
                    throw new Error(`Stream error: ${resp.status}`);
                }

                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let sseBuffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    sseBuffer += decoder.decode(value, { stream: true });

                    // Parse SSE events
                    const events = sseBuffer.split('\n\n');
                    sseBuffer = events.pop(); // Keep incomplete event

                    for (const evt of events) {
                        for (const line of evt.split('\n')) {
                            if (!line.startsWith('data: ')) continue;
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.type === 'token' && data.text) {
                                    fullText += data.text;
                                    // Throttle rendering to every 50ms for performance
                                    if (!renderTimer) {
                                        renderTimer = setTimeout(() => {
                                            targetEl.innerHTML = '<div style="font-size:14px;line-height:1.8;color:rgba(255,255,255,0.85)">' +
                                                mbRenderMd(fullText) +
                                                (showCursor ? '<span class="mb-cursor" style="display:inline-block;width:2px;height:14px;background:var(--accent);animation:blink 0.8s infinite;vertical-align:middle;margin-left:2px"></span>' : '') +
                                                '</div>';
                                            targetEl.scrollTop = targetEl.scrollHeight;
                                            renderTimer = null;
                                        }, 50);
                                    }
                                } else if (data.type === 'done') {
                                    // Final render without cursor
                                    if (renderTimer) { clearTimeout(renderTimer); renderTimer = null; }
                                    targetEl.innerHTML = '<div style="font-size:14px;line-height:1.8;color:rgba(255,255,255,0.85)">' + mbRenderMd(fullText) + '</div>';
                                }
                            } catch(e) {}
                        }
                    }
                }

                // Ensure final render
                if (renderTimer) { clearTimeout(renderTimer); renderTimer = null; }
                targetEl.innerHTML = '<div style="font-size:14px;line-height:1.8;color:rgba(255,255,255,0.85)">' + mbRenderMd(fullText) + '</div>';
                if (onDone) onDone(fullText);
                return fullText;

            } catch(e) {
                console.error('Stream error:', e);
                // Fallback to non-streaming
                try {
                    const resp = await fetch(`${API}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                        body: JSON.stringify({ question: prompt })
                    });
                    const data = await resp.json();
                    if (data.answer) {
                        fullText = data.answer;
                        targetEl.innerHTML = '<div style="font-size:14px;line-height:1.8;color:rgba(255,255,255,0.85)">' + mbRenderMd(fullText) + '</div>';
                        if (onDone) onDone(fullText);
                        return fullText;
                    }
                } catch(e2) {}
                if (onError) onError(e);
                targetEl.innerHTML = '<div style="color:#ef4444;padding:12px">⚠ Fehler bei der Verbindung. Bitte erneut versuchen.</div>';
                return '';
            }
        }

        function mbShowThinking(targetEl, stages) {
            /**
             * Shows animated "thinking" stages while waiting.
             * Returns { stop() } to call when done.
             */
            let currentStage = 0;
            const startTime = Date.now();

            function render() {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(0);
                let html = '<div style="padding:8px 0">';
                for (let i = 0; i < stages.length; i++) {
                    const isDone = i < currentStage;
                    const isActive = i === currentStage;
                    const icon = isDone ? '<span style="color:#22c55e">✓</span>' :
                                 isActive ? '<span style="display:inline-block;width:12px;height:12px;border:2px solid var(--accent);border-top-color:transparent;border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle"></span>' :
                                 '<span style="color:rgba(255,255,255,0.2)">○</span>';
                    const opacity = isDone ? '0.5' : isActive ? '1' : '0.25';
                    html += `<div style="display:flex;align-items:center;gap:10px;padding:5px 0;opacity:${opacity};transition:all 0.3s">
                        <div style="width:20px;text-align:center">${icon}</div>
                        <div style="font-size:13px;color:rgba(255,255,255,0.7)">${stages[i]}</div>
                    </div>`;
                }
                html += `<div style="font-size:11px;color:rgba(255,255,255,0.3);margin-top:8px;padding-left:30px">${elapsed}s</div>`;
                html += '</div>';
                targetEl.innerHTML = html;
            }

            render();
            const interval = setInterval(() => {
                if (currentStage < stages.length - 1) currentStage++;
                render();
            }, 2000);

            return {
                stop() { clearInterval(interval); },
                complete() {
                    clearInterval(interval);
                    currentStage = stages.length;
                    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                    let html = '<div style="padding:8px 0">';
                    for (const s of stages) {
                        html += `<div style="display:flex;align-items:center;gap:10px;padding:3px 0;opacity:0.5"><div style="width:20px;text-align:center"><span style="color:#22c55e">✓</span></div><div style="font-size:13px;color:rgba(255,255,255,0.5)">${s}</div></div>`;
                    }
                    html += `<div style="font-size:11px;color:#22c55e;margin-top:6px;padding-left:30px">✓ Abgeschlossen in ${elapsed}s</div></div>`;
                    targetEl.innerHTML = html;
                }
            };
        }

        function mbGoToStart() {
            mbState.step = 0;
            mbState.selections = {};
            mbState.question = '';
            document.getElementById('mbProgress').style.display = 'none';
            mbShowPanel('mbStart');
            document.querySelectorAll('.mb-mode-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('mbStartBtn').disabled = true;
        }

        function mbShowPanel(panelId) {
            document.querySelectorAll('#model-section .mb-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(panelId).classList.add('active');
        }

        function mbUpdateProgress(step) {
            document.querySelectorAll('.mb-step-dot').forEach(d => {
                const s = parseInt(d.dataset.step);
                d.classList.remove('active','completed');
                if (s < step) d.classList.add('completed');
                else if (s === step) d.classList.add('active');
            });
            document.querySelectorAll('.mb-step-line').forEach((l, i) => {
                l.classList.toggle('completed', i < step);
            });
        }

        function mbGoStep(step) {
            mbState.step = step;
            mbUpdateProgress(step);
            mbShowPanel('mbStep' + step);
            // Reset to ViewA for steps with dual views
            mbResetStepViews(step);
            mbApplyDefault(step);
        }

        function mbResetStepViews(step) {
            const viewA = document.getElementById('mbStep' + step + 'ViewA');
            const viewB = document.getElementById('mbStep' + step + 'ViewB');
            if (viewA) viewA.style.display = 'block';
            if (viewB) viewB.style.display = 'none';
        }

        function mbNextStep(step) {
            mbState.step = step;
            mbUpdateProgress(step);
            mbShowPanel('mbStep' + step);
            // Reset to ViewA for the new step
            mbResetStepViews(step);
            // Step 6: reset depth choice first, THEN apply defaults
            if (step === 6) {
                mbState.reportDepth = null;
                const btn = document.getElementById('mbComputeBtn');
                if (btn) { btn.disabled = true; btn.style.opacity = '0.4'; }
                document.getElementById('mbDepthChoice').style.display = 'flex';
                document.getElementById('mbComputeProgress').style.display = 'none';
                document.getElementById('mbResultContent').style.display = 'none';
                document.getElementById('mbExportBtn').style.display = 'none';
                document.getElementById('mbNewModelBtn').style.display = 'none';
                document.querySelectorAll('#mbDepthChoice > div').forEach(d => {
                    d.classList.remove('depth-active');
                    d.style.borderColor = 'rgba(255,255,255,0.08)';
                    d.style.background = 'transparent';
                });
            }
            // Apply defaults AFTER any resets
            mbApplyDefault(step);
        }

        function mbSelectDepth(depth, el) {
            // Double-tap = Report generieren
            if (el.classList.contains('depth-active') && mbState.reportDepth === depth) {
                const btn = document.getElementById('mbComputeBtn');
                if (btn && !btn.disabled) btn.click();
                return;
            }
            mbState.reportDepth = depth;
            document.querySelectorAll('#mbDepthChoice > div').forEach(d => {
                d.classList.remove('depth-active');
                d.style.borderColor = 'rgba(255,255,255,0.08)';
                d.style.background = 'transparent';
            });
            el.classList.add('depth-active');
            el.style.borderColor = 'var(--accent)';
            el.style.background = 'rgba(139,170,255,0.08)';
            const btn = document.getElementById('mbComputeBtn');
            if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
        }

        // ── Choice Confirmation System ──────────────────
        let mbPendingConfirm = null; // { step, value, nextAction }

        const mbChoiceExplanations = {
            // Step 1: Entry Point
            'mbStep1': {
                'theory': {
                    icon: '📚', title: 'Theory-Driven',
                    body: 'Du startest mit einem bestehenden EBF-Konzept aus den CORE Appendices (AAA–AW). BEATRIX leitet daraus die praktische Anwendung ab.',
                    implication: 'BEATRIX wird zuerst relevante Theorien und Frameworks identifizieren, dann auf dein konkretes Problem anwenden. Ideal wenn du weisst, welches Konzept du nutzen möchtest.'
                },
                'practice': {
                    icon: '🎯', title: 'Practice-Driven',
                    body: 'Du startest mit deinem konkreten Problem oder Gestaltungsanlass. BEATRIX findet die passenden theoretischen Grundlagen automatisch.',
                    implication: 'BEATRIX analysiert dein Problem und mapped es auf die relevanten BCM-Dimensionen. Der schnellste Weg zu einem anwendbaren Modell.'
                },
                'hybrid': {
                    icon: '🔄', title: 'Hybrid (Iteration)',
                    body: 'Abwechselnde Theorie-Praxis-Zyklen. Du pendelt zwischen EBF-Konzepten und praktischer Anwendung.',
                    implication: 'BEATRIX wird iterativ vorgehen: Theorie → Praxis → Validierung → Anpassung. Braucht mehr Zeit, liefert aber das robusteste Modell.'
                },
                'custom': {
                    icon: '🔧', title: 'Custom Entry Point',
                    body: 'Du definierst den Startpunkt selbst. Maximale Flexibilität für erfahrene Modellierer.',
                    implication: 'BEATRIX gibt dir volle Kontrolle über den Entry Point. Du kannst Theorie und Praxis frei kombinieren.'
                }
            },
            // Step 2: Scope
            'mbStep2': {
                'decision': {
                    icon: '⚖️', title: 'Decision (Einmalentscheidung)',
                    body: 'Du modellierst eine diskrete Entscheidung: Ja/Nein, Option A vs. B. Typisch für Versicherungswahl, Impfentscheidung, Jobwechsel.',
                    implication: 'Mathematik: Logistic / Binary Choice Model. BEATRIX berechnet die Wahrscheinlichkeit P(B=1) dass das Zielverhalten eintritt. Ergebnis ist eine klare Ja/Nein-Prognose mit Konfidenz.'
                },
                'continuous': {
                    icon: '📈', title: 'Continuous (Wiederholtes Verhalten)',
                    body: 'Du modellierst ein Verhalten mit variabler Intensität: Sparbetrag, Energieverbrauch, Trainingsfrequenz.',
                    implication: 'Mathematik: CES Functional Form. BEATRIX berechnet den erwarteten Verhaltenslevel B* und die Elastizitäten der Einflussfaktoren.'
                },
                'process': {
                    icon: '🔄', title: 'Process (Veränderung über Zeit)',
                    body: 'Du modellierst eine Verhaltensveränderung über Zeit: Habit-Bildung, Adoption Journey, Lernprozesse.',
                    implication: 'Mathematik: Dynamic BCJ Models. BEATRIX modelliert die Trajektorie und identifiziert kritische Übergangspunkte zwischen Stages.'
                },
                'custom': {
                    icon: '🔧', title: 'Custom Scope',
                    body: 'Du kombinierst oder erweiterst die Standard-Typen frei.',
                    implication: 'Flexible Modell-Spezifikation – du definierst die funktionale Form und den Outcome-Typ selbst.'
                }
            },
            // Step 3: Context Ψ
            'mbStep3': {
                'ggg-default': {
                    icon: '📊', title: 'GGG Defaults',
                    body: 'Vorkonfigurierte Ψ-Werte aus Tabelle GGG-1 basierend auf Domain und Level. Schnell und empirisch validiert.',
                    implication: 'BEATRIX nutzt die Standard-Kalibrierung: trust, digital_adoption, autonomy, risk_aversion. Das spart ~15 Minuten und liefert robuste Baseline-Werte.'
                },
                'custom-psi': {
                    icon: '🎛️', title: 'Custom Ψ-Dimensionen',
                    body: 'Du definierst explizit welche Kontextfaktoren relevant sind – z.B. Saisonalität, Peer Effects, Availability.',
                    implication: 'BEATRIX verwendet deine spezifischen Ψ-Dimensionen statt der Defaults. Ideal wenn du den Kontext besser kennst als die Standard-Kalibrierung.'
                },
                'full-8psi': {
                    icon: '🔬', title: 'Alle 8 Ψ-Dimensionen',
                    body: 'Vollständige Analyse aller 8 Kontextdimensionen: Institutional, Social, Knowledge, Cultural, Temporal, Economic, Motivational, Framing.',
                    implication: 'Maximale Tiefe und Differenzierung. BEATRIX analysiert jeden Kontextfaktor einzeln und berechnet den gewichteten Gesamt-Ψ-Score. Dauert etwas länger, liefert aber die präziseste Kalibrierung.'
                },
                'custom': {
                    icon: '🔧', title: 'Custom Context',
                    body: 'Eigene Kontext-Konfiguration mit freier Ψ-Auswahl.',
                    implication: 'Du wählst und gewichtest die Ψ-Dimensionen selbst. Für Experten mit spezifischen Kontext-Hypothesen.'
                }
            }
        };

        function mbSelect(el, value, silent) {
            const panel = el.closest('.mb-panel');
            const stepId = panel.id;

            // Double-tap same choice = weiter (fallback)
            if (el.classList.contains('selected') && mbState.selections[stepId] === value) {
                const btn = panel.querySelector('.mb-btn-primary');
                if (btn && !btn.disabled) btn.click();
                return;
            }

            panel.querySelectorAll('.mb-choice').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            mbState.selections[stepId] = value;
            const btn = panel.querySelector('.mb-btn-primary');
            if (btn) btn.disabled = false;

            // Auto-advance: tap = select + go
            if (!silent) {
                setTimeout(() => {
                    if (btn && !btn.disabled) btn.click();
                }, 350);
            }
        }

        function mbShowConfirmation(stepLabel, icon, title, body, implication) {
            document.getElementById('mbConfirmStep').textContent = stepLabel;
            document.getElementById('mbConfirmIcon').textContent = icon;
            document.getElementById('mbConfirmTitle').textContent = title;
            document.getElementById('mbConfirmBody').textContent = body;
            document.getElementById('mbConfirmImplText').textContent = implication;

            const overlay = document.getElementById('mbConfirmOverlay');
            const card = document.getElementById('mbConfirmCard');
            overlay.style.display = 'block';
            requestAnimationFrame(() => {
                overlay.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            });
        }

        function mbHideConfirmation() {
            const overlay = document.getElementById('mbConfirmOverlay');
            const card = document.getElementById('mbConfirmCard');
            card.style.transform = 'translateY(100%)';
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 350);
        }

        function mbConfirmProceed() {
            if (!mbPendingConfirm) return;
            mbHideConfirmation();
            mbPendingConfirm = null;
        }

        function mbConfirmBack() {
            mbHideConfirmation();
            mbPendingConfirm = null;
        }

        // Steps 1-2: advance to next step
        function mbConfirmAndAdvance(fromStep, toStep) {
            mbNextStep(toStep);
        }

        function mbRenderProblemCard(data) {
            // data: { icon, title, phenomenon, paradox, question, domain, generated }
            const labels = { phenomenon: 'Phänomen', paradox: 'Paradox', question: 'Forschungsfrage' };
            const icons = { phenomenon: '🔍', paradox: '⚡', question: '🎯' };
            const colors = { phenomenon: 'rgba(255,255,255,0.7)', paradox: 'rgba(251,191,36,0.8)', question: 'rgba(139,170,255,0.9)' };

            let rows = '';
            for (const key of ['phenomenon', 'paradox', 'question']) {
                if (data[key]) {
                    rows += `
                    <div style="display:flex;gap:10px;align-items:flex-start;padding:8px 0;${key !== 'question' ? 'border-bottom:1px solid rgba(255,255,255,0.04)' : ''}">
                        <div style="flex-shrink:0;width:20px;text-align:center;font-size:13px;padding-top:1px">${icons[key]}</div>
                        <div>
                            <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:rgba(255,255,255,0.3);margin-bottom:3px">${labels[key]}</div>
                            <div style="font-size:13px;color:${colors[key]};line-height:1.55">${data[key]}</div>
                        </div>
                    </div>`;
                }
            }

            return `
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
                    <span style="font-size:20px">${data.icon || '📋'}</span>
                    <span style="font-weight:600;color:white;font-size:15px">${data.title || ''}</span>
                    <span style="margin-left:auto;font-size:11px;color:var(--accent);opacity:0.5">${data.domain || ''}</span>
                </div>
                ${rows}
                ${data.generated ? '<div style="margin-top:8px;font-size:10px;color:rgba(255,255,255,0.25)">🤖 Von BEATRIX generiert</div>' : ''}
            `;
        }

        // Parse a flat question string into structured components
        function mbParseQuestion(text) {
            // Try to split by sentence-ending patterns (? or .)
            const sentences = text.match(/[^.?!]+[.?!]+/g) || [text];
            if (sentences.length >= 3) {
                return { phenomenon: sentences[0].trim(), paradox: sentences[1].trim(), question: sentences.slice(2).join(' ').trim() };
            } else if (sentences.length === 2) {
                return { phenomenon: sentences[0].trim(), question: sentences[1].trim() };
            }
            return { question: text };
        }

        function mbSelectProblemStructured(idx) {
            const q = (typeof idx === 'number') ? window._mbQuestions[idx] : idx;
            if (!q) return;
            const fullQ = [q.phenomenon, q.paradox, q.question].filter(Boolean).join(' ');
            mbState.selectedProblem = fullQ;

            document.getElementById('mbStep0ViewA').style.display = 'none';
            document.getElementById('mbStep0ViewB').style.display = 'block';
            document.getElementById('mbStep0SelectedQ').innerHTML = mbRenderProblemCard(q);
            mbProcessStep0();
        }

        function mbSelectProblem(el, question) {
            mbState.selectedProblem = question;
            // Get structured data from the card if available
            const titleEl = el.querySelector('[style*="font-weight:600"]');
            const icon = el.querySelector('[style*="font-size:18px"]');
            const domainEl = el.querySelector('[style*="opacity:0.6"]');

            const parsed = mbParseQuestion(question);
            parsed.icon = icon ? icon.textContent : '📋';
            parsed.title = titleEl ? titleEl.textContent : '';
            parsed.domain = domainEl ? domainEl.textContent : '';

            document.getElementById('mbStep0ViewA').style.display = 'none';
            document.getElementById('mbStep0ViewB').style.display = 'block';
            document.getElementById('mbStep0SelectedQ').innerHTML = mbRenderProblemCard(parsed);
            mbProcessStep0();
        }

        function mbStep0Back() {
            document.getElementById('mbStep0ViewB').style.display = 'none';
            document.getElementById('mbStep0ViewA').style.display = 'block';
            document.getElementById('mbStep0Result').style.display = 'none';
            mbState.selectedProblem = null;
        }

        function mbShowCustomInput() {
            mbState.selectedProblem = null;
            const ci = document.getElementById('mbCustomInput');
            ci.style.display = 'block';
            ci.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => document.getElementById('mbQuestion').focus(), 200);
        }

        async function mbLetBeatrixDefine() {
            // Switch to a generation view
            document.getElementById('mbStep0ViewA').style.display = 'none';
            document.getElementById('mbStep0ViewB').style.display = 'block';
            document.getElementById('mbStep0SelectedQ').innerHTML = `
                <div style="display:flex;align-items:center;gap:10px">
                    <div style="width:14px;height:14px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0"></div>
                    <span style="color:rgba(255,255,255,0.5)">BEATRIX generiert eine Problemstellung...</span>
                </div>`;
            document.getElementById('mbStep0Result').style.display = 'none';
            const btn = document.getElementById('mbStep0Btn');
            btn.disabled = true;
            btn.textContent = 'Wird generiert...';

            try {
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: `Generiere eine Problemstellung für den EEE Model-Building Workflow.
Antworte NUR als JSON:
{
  "icon": "passendes emoji",
  "title": "Kurztitel 3-4 Worte",
  "phenomenon": "Das beobachtbare Verhalten in 1 Satz (was passiert konkret, mit Zahlen/Fakten)",
  "paradox": "Die Spannung/das Paradox in 1 Satz (warum ist es überraschend oder problematisch)",
  "question": "Die konkrete Forschungsfrage in 1 Satz (was wollen wir herausfinden)",
  "domain": "REL/FIN/HLT/ENV/POL/ORG/EDU/OTH"
}` })
                });
                const data = await resp.json();
                let parsed = null;
                if (data.answer) {
                    try { const m = data.answer.match(/\{[\s\S]*\}/); if(m) parsed = JSON.parse(m[0]); } catch(e){}
                }
                if (!parsed) parsed = { icon: '🔬', title: 'Behavioral Analysis', phenomenon: data.answer || '', paradox: '', question: '', domain: 'OTH' };

                // Compose full question for state
                const fullQ = [parsed.phenomenon, parsed.paradox, parsed.question].filter(Boolean).join(' ');
                mbState.selectedProblem = fullQ;

                // Show as structured card
                document.getElementById('mbStep0SelectedQ').innerHTML = mbRenderProblemCard(parsed);

                // Auto-trigger analysis
                mbProcessStep0();

            } catch(e) {
                console.error('Generate error:', e);
                document.getElementById('mbStep0SelectedQ').innerHTML = '<div style="color:#ef4444">⚠ Fehler bei der Generierung. Bitte erneut versuchen.</div>';
                btn.textContent = 'Analysieren →';
                btn.disabled = false;
            }
        }

        // ── Universal Inline Progress ──────────────────────────
        const MB_STEP_STAGES = {
            0: [
                { label: 'Frage parsen', pct: 15 },
                { label: 'Domain erkennen', pct: 35 },
                { label: 'Verhaltensziel identifizieren', pct: 55 },
                { label: 'Scope definieren', pct: 75 },
                { label: 'Session erstellen', pct: 92 },
            ],
            3: [
                { label: 'Kontext-Variablen laden', pct: 12 },
                { label: 'Ψ-Dimensionen berechnen', pct: 30 },
                { label: '10C CORE Mapping', pct: 50 },
                { label: 'Domain-Konfiguration', pct: 68 },
                { label: 'Sensitivität prüfen', pct: 82 },
                { label: 'Modell-Match suchen', pct: 95 },
            ],
        };

        function mbStartProgress(stepNum) {
            const el = document.getElementById('mbProgress' + stepNum);
            if (!el) return null;
            const stages = MB_STEP_STAGES[stepNum] || [];
            el.style.display = 'block';
            el.innerHTML = `
                <div class="mb-prog-header">
                    <div class="mb-prog-spinner"></div>
                    <div>
                        <div style="font-size:14px;font-weight:600;color:rgba(255,255,255,0.9)" id="mbProgLabel${stepNum}">BEATRIX arbeitet...</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px" id="mbProgDetail${stepNum}"></div>
                    </div>
                </div>
                <div class="mb-prog-bar-bg"><div class="mb-prog-bar" id="mbProgBar${stepNum}"></div></div>
                <div class="mb-prog-meta">
                    <span id="mbProgPct${stepNum}">0%</span>
                    <span id="mbProgTime${stepNum}">Geschätzt: ~${Math.round(stages.length * 2)}s</span>
                </div>
                <div class="mb-prog-stages">
                    ${stages.map((s, i) => `
                        <div class="mb-prog-stage" id="mbProgS${stepNum}_${i}">
                            <div class="mb-prog-dot" id="mbProgD${stepNum}_${i}">○</div>
                            <span>${s.label}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            const startTime = Date.now();
            let idx = 0;
            const interval = setInterval(() => {
                if (idx >= stages.length) { clearInterval(interval); return; }
                const s = stages[idx];

                // Update bar
                const bar = document.getElementById('mbProgBar' + stepNum);
                const pct = document.getElementById('mbProgPct' + stepNum);
                const label = document.getElementById('mbProgLabel' + stepNum);
                const time = document.getElementById('mbProgTime' + stepNum);
                if (bar) bar.style.width = s.pct + '%';
                if (pct) pct.textContent = s.pct + '%';
                if (label) label.textContent = s.label + '...';

                // Elapsed
                const elapsed = Math.round((Date.now() - startTime) / 1000);
                const remaining = Math.max(1, Math.round((stages.length - idx) * 2));
                if (time) time.textContent = `${elapsed}s · ~${remaining}s verbleibend`;

                // Mark active
                const row = document.getElementById('mbProgS' + stepNum + '_' + idx);
                const dot = document.getElementById('mbProgD' + stepNum + '_' + idx);
                if (row) row.className = 'mb-prog-stage active';
                if (dot) dot.innerHTML = '●';

                // Mark previous done
                if (idx > 0) {
                    const prevRow = document.getElementById('mbProgS' + stepNum + '_' + (idx - 1));
                    const prevDot = document.getElementById('mbProgD' + stepNum + '_' + (idx - 1));
                    if (prevRow) prevRow.className = 'mb-prog-stage done';
                    if (prevDot) prevDot.innerHTML = '✓';
                }

                idx++;
            }, 2000);

            return { interval, startTime, stepNum };
        }

        function mbStopProgress(handle) {
            if (!handle) return;
            clearInterval(handle.interval);
            const stepNum = handle.stepNum;
            const el = document.getElementById('mbProgress' + stepNum);
            const stages = MB_STEP_STAGES[stepNum] || [];
            const totalTime = ((Date.now() - handle.startTime) / 1000).toFixed(1);

            // Mark all done
            stages.forEach((s, i) => {
                const row = document.getElementById('mbProgS' + stepNum + '_' + i);
                const dot = document.getElementById('mbProgD' + stepNum + '_' + i);
                if (row) row.className = 'mb-prog-stage done';
                if (dot) dot.innerHTML = '✓';
            });

            // Complete bar
            const bar = document.getElementById('mbProgBar' + stepNum);
            const pct = document.getElementById('mbProgPct' + stepNum);
            const label = document.getElementById('mbProgLabel' + stepNum);
            const time = document.getElementById('mbProgTime' + stepNum);
            if (bar) bar.style.width = '100%';
            if (pct) pct.textContent = '100%';
            if (label) label.textContent = '✓ Abgeschlossen';
            if (time) time.textContent = `Fertig in ${totalTime}s`;

            // Hide after delay
            setTimeout(() => { if (el) el.style.display = 'none'; }, 1200);
        }

        async function mbProcessStep0() {
            const q = document.getElementById('mbQuestion') ? document.getElementById('mbQuestion').value.trim() : '';
            const selectedQ = mbState.selectedProblem || q;
            if (!selectedQ) return;
            mbState.question = selectedQ;

            // Switch to View B if not already there (custom input case)
            if (document.getElementById('mbStep0ViewA').style.display !== 'none') {
                document.getElementById('mbStep0ViewA').style.display = 'none';
                document.getElementById('mbStep0ViewB').style.display = 'block';
                const parsed = mbParseQuestion(selectedQ);
                parsed.icon = '✏️';
                parsed.title = 'Eigene Problemstellung';
                document.getElementById('mbStep0SelectedQ').innerHTML = mbRenderProblemCard(parsed);
            }

            const btn = document.getElementById('mbStep0Btn');
            btn.disabled = true;
            btn.textContent = 'BEATRIX analysiert...';
            const progHandle = mbStartProgress(0);

            try {
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: `Analysiere diese Frage für den EEE Model-Building Workflow. Antworte NUR als JSON: {"domain":"REL/FIN/HLT/ENV/POL/ORG/EDU/OTH","domain_signals":["..."],"question_type":"analysis/decision/behavior_change/comparison","has_behavior_goal":true/false,"behavior_goal":"...oder null","scope_in":["..."],"scope_out":["..."],"suggested_mode":"schnell/gefuehrt/template/custom","session_id":"EBF-S-2026-02-08-XXX-001"}\n\nFrage: ${q}` })
                });
                const data = await resp.json();
                let parsed = null;
                if (data.answer) {
                    try {
                        const jsonMatch = data.answer.match(/\{[\s\S]*\}/);
                        if (jsonMatch) parsed = JSON.parse(jsonMatch[0]);
                    } catch(e) {}
                }

                if (!parsed) {
                    parsed = {
                        domain: 'OTH', domain_signals: [q.split(' ').slice(0,3).join(' ')],
                        question_type: 'analysis', has_behavior_goal: false, behavior_goal: null,
                        scope_in: ['Modell-Analyse'], scope_out: ['Interventionen'],
                        suggested_mode: mbState.mode, session_id: `EBF-S-2026-02-08-OTH-001`
                    };
                }

                mbState.sessionId = parsed.session_id;
                mbState.selections.domain = parsed.domain;
                mbState.selections.questionType = parsed.question_type;

                const summaryEl = document.getElementById('mbSessionSummary');
                const domainColor = DOMAIN_COLORS[parsed.domain] || '#94a3b8';
                const domainLabel = DOMAIN_LABELS[parsed.domain] || parsed.domain;
                const typeLabels = { analysis: 'Analyse', decision: 'Entscheidung', behavior_change: 'Behavior Change', comparison: 'Vergleich', strategy: 'Strategie' };
                const typeLabel = typeLabels[parsed.question_type] || parsed.question_type;

                const signalTags = (parsed.domain_signals || []).map(s =>
                    `<span style="display:inline-block;font-size:11px;padding:3px 10px;border-radius:12px;background:rgba(139,170,255,0.08);border:1px solid rgba(139,170,255,0.12);color:rgba(255,255,255,0.7);margin:2px 4px 2px 0">${s}</span>`
                ).join('');

                const scopeInTags = (parsed.scope_in || []).map(s =>
                    `<span style="display:inline-block;font-size:11px;padding:3px 10px;border-radius:12px;background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.15);color:rgba(34,197,94,0.8);margin:2px 4px 2px 0">✓ ${s}</span>`
                ).join('');

                const scopeOutTags = (parsed.scope_out || []).map(s =>
                    `<span style="display:inline-block;font-size:11px;padding:3px 10px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);color:rgba(255,255,255,0.35);margin:2px 4px 2px 0">✗ ${s}</span>`
                ).join('');

                summaryEl.innerHTML = `
                    <!-- Header: Domain + Type + ID -->
                    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:16px">
                        <span style="display:inline-flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;background:${domainColor}18;border:1px solid ${domainColor}40;font-size:13px;font-weight:600;color:${domainColor}">
                            <span style="width:8px;height:8px;border-radius:50%;background:${domainColor}"></span>
                            ${domainLabel}
                        </span>
                        <span style="display:inline-flex;align-items:center;padding:5px 12px;border-radius:20px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);font-size:12px;color:rgba(255,255,255,0.6)">
                            ${typeLabel}
                        </span>
                        <span style="margin-left:auto;font-size:11px;font-family:monospace;color:rgba(255,255,255,0.25);letter-spacing:0.3px">${parsed.session_id}</span>
                    </div>

                    ${parsed.has_behavior_goal ? `
                    <!-- Behavior Goal: Prominent -->
                    <div style="padding:14px 16px;border-radius:10px;background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.15);margin-bottom:16px">
                        <div style="font-size:11px;font-weight:600;color:rgba(34,197,94,0.7);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Verhaltensziel</div>
                        <div style="font-size:14px;color:rgba(255,255,255,0.9);line-height:1.5">${parsed.behavior_goal || 'Definiert'}</div>
                    </div>` : `
                    <div style="padding:12px 16px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);margin-bottom:16px;font-size:13px;color:rgba(255,255,255,0.4)">
                        ⚠ Kein explizites Verhaltensziel erkannt — BEATRIX leitet eines ab.
                    </div>`}

                    <!-- Signals -->
                    <div style="margin-bottom:16px">
                        <div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Erkannte Signale</div>
                        <div style="display:flex;flex-wrap:wrap">${signalTags}</div>
                    </div>

                    <!-- Scope: In / Out -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <div>
                            <div style="font-size:11px;font-weight:600;color:rgba(34,197,94,0.6);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">In Scope</div>
                            <div style="display:flex;flex-wrap:wrap">${scopeInTags}</div>
                        </div>
                        <div>
                            <div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Out of Scope</div>
                            <div style="display:flex;flex-wrap:wrap">${scopeOutTags}</div>
                        </div>
                    </div>
                `;
                document.getElementById('mbStep0Result').style.display = 'block';

                mbStopProgress(progHandle);
                btn.textContent = 'Weiter zu Schritt 1 →';
                btn.disabled = false;
                btn.onclick = () => mbNextStep(1);

            } catch(e) {
                mbStopProgress(progHandle);
                btn.textContent = 'Analysieren →';
                btn.disabled = false;
                console.error('Step 0 error:', e);
            }
        }

        async function mbProcessStep3() {
            const psiChoice = mbState.selections.mbStep3 || 'ggg-default';
            const psiLabels = { 'ggg-default': '📊 GGG Defaults', 'custom-psi': '🎛️ Custom Ψ', 'full-8psi': '🔬 Alle 8 Ψ-Dimensionen', 'custom': '🔧 Custom' };

            // Switch to ViewB
            document.getElementById('mbStep3ViewA').style.display = 'none';
            document.getElementById('mbStep3ViewB').style.display = 'block';
            document.getElementById('mbStep3Selection').textContent = psiLabels[psiChoice] || psiChoice;

            const btn = document.getElementById('mbStep3NextBtn');
            btn.disabled = true;
            btn.textContent = 'BEATRIX analysiert...';
            const progHandle = mbStartProgress(3);

            try {
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: `Für den EEE Model-Building Workflow Step 3 (Kontext Ψ). Frage: "${mbState.question}". Domain: ${mbState.selections.domain}. Modus: ${psiChoice}. Entry: ${mbState.selections.mbStep1||'practice'}. Scope: ${mbState.selections.mbStep2||'decision'}. Erstelle eine Kontext-Analyse mit den Ψ-Dimensionen. Antworte NUR als JSON: {"psi_dimensions":[{"id":"Ψ_I","name":"Institutional","value":0.7,"rationale":"..."},...],"domain_config":"...","level":"Individual/Household/Organization","10c_mapping":{"WHO":"...","WHAT":"...","HOW":"...","WHEN":"...","WHERE":"...","AWARE":"...","READY":"...","STAGE":"...","HIERARCHY":"...","EIT":"..."}}` })
                });
                const data = await resp.json();
                let parsed = null;
                if (data.answer) {
                    try { const m = data.answer.match(/\{[\s\S]*\}/); if(m) parsed = JSON.parse(m[0]); } catch(e){}
                }

                if (parsed && parsed.psi_dimensions) {
                    mbState.selections.psi = parsed;
                    // Store for use in Step 4+5 prompts
                    mbState.selections.psiSummary = parsed.psi_dimensions.map(p => `${p.id}=${p.value}`).join(', ');
                }

                mbStopProgress(progHandle);
                mbNextStep(4);

            } catch(e) {
                mbStopProgress(progHandle);
                console.error('Step 3 error:', e);
                btn.textContent = 'Erneut versuchen →';
                btn.disabled = false;
                btn.onclick = () => mbProcessStep3();
            }
        }

        function mbStep3Back() {
            document.getElementById('mbStep3ViewB').style.display = 'none';
            document.getElementById('mbStep3ViewA').style.display = 'block';
            document.getElementById('mbStep3Result').innerHTML = '';
        }

        function mbConfirmAndAdvance(fromStep, toStep) {
            mbNextStep(toStep);
        }

        async function mbRunStep4() {
            const btn = document.getElementById('mbStep4Btn');
            const resultEl = document.getElementById('mbModelResult');
            btn.disabled = true;
            btn.textContent = 'BEATRIX erstellt Modell...';

            const prompt = `Erstelle die 10C Modell-Spezifikation für: "${mbState.question}".
Session: ${mbState.sessionId}. Domain: ${mbState.selections.domain || 'OTH'}.
Entry: ${mbState.selections.mbStep1 || 'practice'}. Scope: ${mbState.selections.mbStep2 || 'decision'}.
Ψ-Config: ${mbState.selections.mbStep3 || 'ggg-default'}.

Strukturiere mit Markdown:
### Modell-Typ & ID
Identifiziere den passenden Modell-Typ (Decision/Continuous/Process) und vergib eine BCM-Modell-ID.

### 10C Complementarity Mapping
Tabelle mit | Dimension | Spezifikation | Relevanz (Hoch/Mittel/Niedrig) |
für alle 10 Dimensionen: WHO, WHAT, HOW, WHEN, WHERE, AWARE, READY, STAGE, HIERARCHY, EIT.

### Funktionale Form
Welche mathematische Spezifikation: Logistic, CES, Dynamic BCJ?

Schreibe kompakt und präzise.`;

            resultEl.innerHTML = `<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border)">
                <div style="width:14px;height:14px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0" id="mbStep4Spinner"></div>
                <div style="font-size:13px;color:var(--text-secondary)" id="mbStep4Meta">Modell wird erstellt...</div>
            </div><div id="mbStep4Stream" style="max-height:50vh;overflow-y:auto"></div>`;

            const startTime = Date.now();
            await mbStreamChat(prompt, document.getElementById('mbStep4Stream'), {
                onDone: (text) => {
                    const t = ((Date.now() - startTime) / 1000).toFixed(1);
                    const sp = document.getElementById('mbStep4Spinner');
                    if (sp) { sp.style.animation = 'none'; sp.style.borderColor = '#22c55e'; sp.style.borderTopColor = '#22c55e'; }
                    const meta = document.getElementById('mbStep4Meta');
                    if (meta) meta.textContent = `✓ Modell erstellt in ${t}s`;
                    mbState.selections.step4Result = text;
                    btn.textContent = 'Weiter zu Parameter →';
                    btn.disabled = false;
                    btn.onclick = () => mbNextStep(5);
                }
            });
        }

        async function mbRunStep5() {
            const btn = document.getElementById('mbStep5Btn');
            const resultEl = document.getElementById('mbParamResult');
            btn.disabled = true;
            btn.textContent = 'BEATRIX schätzt Parameter...';

            const prompt = `Schätze die BCM-Parameter für: "${mbState.question}".
Session: ${mbState.sessionId}. Domain: ${mbState.selections.domain || 'OTH'}.
Ψ-Config: ${mbState.selections.mbStep3 || 'ggg-default'}.
Modell-Kontext aus Step 4: ${(mbState.selections.step4Result || '').slice(0, 500)}

Strukturiere mit Markdown:
### Willingness (W)
- **Aktueller Wert:** [0.0–1.0]
- **Gate Condition:** W ≥ θ_W? Ja/Nein
- Begründung (2–3 Sätze) basierend auf motivationalen Faktoren

### Ability (A_mod)
- **Aktueller Wert:** [0.0–1.0]
- Subkomponenten: Skills, Knowledge, Resources
- Begründung

### Capacity (C)
- **Aktueller Wert:** [0.0–1.0]
- Externe Constraints, Facilitating Conditions
- Begründung

### BCM Gesamtschätzung
Tabelle: | Parameter | Wert | Gate | Interpretation |
| W | ... | ... | ... |
| A_mod | ... | ... | ... |
| C | ... | ... | ... |
| **P(B)** | ... | — | Verhaltenswahrscheinlichkeit |

Berechne P(B) nach BCM-Formel. Schreibe wissenschaftlich fundiert.`;

            resultEl.innerHTML = `<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border)">
                <div style="width:14px;height:14px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0" id="mbStep5Spinner"></div>
                <div style="font-size:13px;color:var(--text-secondary)" id="mbStep5Meta">Parameter werden geschätzt...</div>
            </div><div id="mbStep5Stream" style="max-height:50vh;overflow-y:auto"></div>`;

            const startTime = Date.now();
            await mbStreamChat(prompt, document.getElementById('mbStep5Stream'), {
                onDone: (text) => {
                    const t = ((Date.now() - startTime) / 1000).toFixed(1);
                    const sp = document.getElementById('mbStep5Spinner');
                    if (sp) { sp.style.animation = 'none'; sp.style.borderColor = '#22c55e'; sp.style.borderTopColor = '#22c55e'; }
                    const meta = document.getElementById('mbStep5Meta');
                    if (meta) meta.textContent = `✓ Parameter geschätzt in ${t}s`;
                    mbState.selections.step5Result = text;
                    btn.textContent = 'Weiter zum Ergebnis →';
                    btn.disabled = false;
                    btn.onclick = () => mbNextStep(6);
                }
            });
        }

        function mbShowRegistry() {
            mbShowPanel('mbRegistry');
            document.getElementById('mbProgress').style.display = 'none';

            const list = document.getElementById('mbRegistryList');
            list.innerHTML = MB_MODELS.map(m => {
                const color = DOMAIN_COLORS[m.domain] || '#94a3b8';
                return `<div class="mb-model-card" onclick="mbUseTemplate('${m.id}')">
                    <span class="mb-model-id" style="background:${color}22;color:${color}">${m.id}</span>
                    <div class="mb-model-info">
                        <div class="mb-model-name">${m.name}</div>
                        <div class="mb-model-meta">${DOMAIN_LABELS[m.domain]||m.domain} · ${m.type}</div>
                    </div>
                    <span class="mb-model-version">v${m.v}</span>
                </div>`;
            }).join('');
        }

        function mbUseTemplate(modelId) {
            const model = MB_MODELS.find(m => m.id === modelId);
            if (!model) return;
            mbState.mode = 'template';
            mbState.selections.templateModel = model;
            document.getElementById('mbQuestion').value = `Basierend auf ${model.name} (${model.id})`;
            mbShowPanel('mbStep0');
            document.getElementById('mbProgress').style.display = 'flex';
            mbUpdateProgress(0);
        }

        const MB_COMPUTE_STAGES = [
            { label: 'Modell initialisieren', detail: 'Session-Daten laden und validieren', pct: 5 },
            { label: 'Frage analysieren', detail: 'Problemstellung und Kontext parsen', pct: 12 },
            { label: '10C Mapping', detail: 'Complementarity-Dimensionen zuordnen', pct: 22 },
            { label: 'Ψ-Kontext laden', detail: 'Psychologische Kontextvariablen integrieren', pct: 35 },
            { label: 'Modellparameter setzen', detail: 'Willingness · Ability · Capacity kalibrieren', pct: 48 },
            { label: 'BCM Berechnung', detail: 'Behavioral Compliance Model anwenden', pct: 62 },
            { label: 'Sensitivitätsanalyse', detail: 'Parameter-Robustheit über ±20% Range testen', pct: 78 },
            { label: 'Report generieren', detail: 'Ergebnis, Empfehlungen und Visualisierungen erstellen', pct: 90 },
            { label: 'Finalisieren', detail: 'Qualitätsprüfung und Formatierung', pct: 97 },
        ];

        async function mbComputeResult() {
            const depth = mbState.reportDepth || 'standard';
            const isDeep = depth === 'deep';

            // Hide choice, show progress
            document.getElementById('mbDepthChoice').style.display = 'none';
            document.getElementById('mbComputeBtn').style.display = 'none';

            const progressEl = document.getElementById('mbComputeProgress');
            const resultEl = document.getElementById('mbResultContent');
            const stageEl = document.getElementById('mbComputeStage');
            const detailEl = document.getElementById('mbComputeDetail');
            const timeEl = document.getElementById('mbComputeTime');

            progressEl.style.display = 'block';
            resultEl.style.display = 'none';
            stageEl.textContent = isDeep ? 'Tiefenanalyse wird vorbereitet...' : 'Report wird vorbereitet...';
            detailEl.textContent = isDeep ? 'Standard++ · 4–6 Seiten' : 'Standard · 1–2 Seiten';
            timeEl.textContent = '';

            const startTime = Date.now();
            const s4 = mbState.selections.step4Result ? `\n\nModell-Spezifikation aus Step 4:\n${mbState.selections.step4Result.slice(0, 800)}` : '';
            const s5 = mbState.selections.step5Result ? `\n\nParameter-Schätzung aus Step 5:\n${mbState.selections.step5Result.slice(0, 800)}` : '';

            const promptStandard = `Erstelle einen kompakten BCM Modell-Report für: "${mbState.question}".
Session: ${mbState.sessionId}. Mode: ${mbState.mode}.${s4}${s5}

Struktur (nutze exakt diese Markdown-Überschriften):
## Modell-Report: [Kurztitel]
### 1. Problemstellung & Domain
Kurze Einordnung (3–4 Sätze).
### 2. 10C Mapping
Nenne die 3–4 relevantesten Complementarity-Dimensionen als Aufzählung mit je 1 Satz.
### 3. BCM Parameter
Tabelle mit | Parameter | Wert | Interpretation |
für Willingness (W), Ability (A), Capacity (C). Nutze die Werte aus Step 5 falls vorhanden.
### 4. Ergebnis
Klare Verhaltensvorhersage in 2–3 Sätzen.
### 5. Handlungsempfehlungen
3–5 konkrete Massnahmen als nummerierte Liste.

Schreibe präzise und professionell. Maximal 500 Wörter.`;

            const promptDeep = `Erstelle einen umfassenden BCM Modell-Report (Standard++) für: "${mbState.question}".
Session: ${mbState.sessionId}. Mode: ${mbState.mode}.${s4}${s5}

Struktur (nutze exakt diese Markdown-Überschriften):
## Modell-Report: [Kurztitel]
### 1. Problemstellung & Domain-Analyse
Detaillierte Einordnung der Fragestellung, Zielgruppe, Verhaltensänderungsziel.
### 2. 10C Complementarity Mapping
Vollständige Tabelle | Dimension | Spezifikation | BCM Relevanz | für alle 10 Dimensionen. Nutze die Spezifikation aus Step 4 falls vorhanden.
### 3. Ψ-Kontextdimensionen
Tabelle | Ψ-Dimension | Wert (0–1) | Impact | Rationale | für die 8 Ψ-Dimensionen.
### 4. BCM Parameter (Willingness · Ability · Capacity)
Detaillierte Tabelle mit Subkomponenten, Werten und Interpretation. Nutze die Schätzungen aus Step 5 falls vorhanden.
#### Key Insight
Zusammenfassende Erkenntnis.
### 5. Ergebnis & Verhaltensvorhersage
Klare Vorhersage mit Konfidenzintervall und Begründung. Berechne P(B) nach BCM-Formel.
### 6. Sensitivitätsanalyse
Welche Parameter haben den grössten Einfluss? ±20% Variation analysieren.
### 7. Handlungsempfehlungen
#### Strategische Intervention Roadmap
Phasenplan mit 3–4 Phasen, jeweils mit Zeitrahmen, Ziel, Taktiken und Interventionen.

Schreibe detailliert, wissenschaftlich fundiert und praxisorientiert. Nutze Tabellen wo sinnvoll.`;

            const prompt = isDeep ? promptDeep : promptStandard;

            try {
                await new Promise(r => setTimeout(r, 500));
                progressEl.style.display = 'none';
                resultEl.style.display = 'block';
                const depthLabel = isDeep ? '🔬 Standard++' : '📋 Standard';
                resultEl.innerHTML = `
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
                        <div style="width:16px;height:16px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0" id="mbReportSpinner"></div>
                        <div>
                            <div style="font-size:14px;font-weight:600;color:white">📊 Modell-Report <span style="font-size:12px;color:var(--accent);font-weight:400">${depthLabel}</span></div>
                            <div style="font-size:11px;color:var(--text-secondary)" id="mbReportMeta">Session ${mbState.sessionId || 'N/A'} · Streaming...</div>
                        </div>
                    </div>
                    <div id="mbStreamTarget" style="max-height:65vh;overflow-y:auto;padding-right:8px"></div>
                `;

                const targetEl = document.getElementById('mbStreamTarget');
                await mbStreamChat(prompt, targetEl, {
                    onDone: (text) => {
                        const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
                        const spinner = document.getElementById('mbReportSpinner');
                        if (spinner) { spinner.style.animation = 'none'; spinner.style.borderColor = '#22c55e'; spinner.style.borderTopColor = '#22c55e'; }
                        const meta = document.getElementById('mbReportMeta');
                        if (meta) meta.textContent = `Session ${mbState.sessionId || 'N/A'} · Generiert in ${totalTime}s`;
                        document.getElementById('mbExportBtn').style.display = '';
                        document.getElementById('mbNewModelBtn').style.display = '';
                    }
                });

            } catch(e) {
                console.error('Compute error:', e);
                resultEl.style.display = 'block';
                resultEl.innerHTML = '<div style="color:#ef4444;padding:20px;text-align:center">⚠ Fehler. Bitte erneut versuchen.</div>';
                document.getElementById('mbExportBtn').style.display = '';
                document.getElementById('mbNewModelBtn').style.display = '';
            }
        }

        async function mbExportModel() {
            // Re-run computation or copy to clipboard
            const content = document.getElementById('mbResultContent').innerText;
            if (content) {
                try {
                    await navigator.clipboard.writeText(content);
                    showToast('Modell-Report in Zwischenablage kopiert ✓', 'success');
                } catch(e) {
                    // Fallback: download as text
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = `BEATRIX-Report-${mbState.sessionId || 'export'}.txt`;
                    a.click(); URL.revokeObjectURL(url);
                    showToast('Report heruntergeladen ✓', 'success');
                }
            }
        }


        


        checkAuth();
    </script>

    <!-- ═══ Feedback Widget v3.17 – Single Screen ═══ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        #fbBtn { position:fixed; bottom:24px; right:24px; z-index:9999; width:48px; height:48px; border-radius:50%; background:linear-gradient(135deg,#8b9aff,#6366f1); border:none; cursor:pointer; box-shadow:0 4px 20px rgba(99,102,241,0.4); display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
        #fbBtn:hover { transform:scale(1.1); box-shadow:0 6px 28px rgba(99,102,241,0.6); }
        #fbBtn svg { width:22px; height:22px; fill:white; }
        #fbOverlay { display:none; position:fixed; inset:0; z-index:10000; background:rgba(6,8,20,0.97); flex-direction:column; }
        #fbOverlay.active { display:flex; }
        #fbToolbar { display:flex; align-items:center; gap:6px; padding:8px 12px; background:rgba(20,20,40,0.95); border-bottom:1px solid rgba(255,255,255,0.08); flex-shrink:0; flex-wrap:wrap; }
        .fb-tool { padding:5px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:transparent; color:rgba(255,255,255,0.6); font-size:12px; cursor:pointer; transition:all 0.15s; }
        .fb-tool:hover, .fb-tool.active { background:rgba(139,170,255,0.15); color:white; border-color:rgba(139,170,255,0.4); }
        /* CRM Kanban */
        .crm-col { min-width:180px; flex:1; background:rgba(255,255,255,0.02); border-radius:10px; border:1px solid rgba(255,255,255,0.04); display:flex; flex-direction:column; }
        .crm-card { padding:10px; background:var(--navy-card); border:1px solid rgba(255,255,255,0.06); border-radius:8px; cursor:pointer; transition:all 0.15s; }
        .crm-card:hover { border-color:rgba(139,170,255,0.3); background:rgba(139,170,255,0.04); transform:translateY(-1px); }
        .crm-card[draggable=true] { cursor:grab; }
        .crm-card[draggable=true]:active { cursor:grabbing; opacity:0.7; }
        .fb-color { width:22px; height:22px; border-radius:50%; border:2px solid transparent; cursor:pointer; transition:transform 0.15s; }
        .fb-color:hover, .fb-color.active { transform:scale(1.2); border-color:white; }
        #fbCanvas { flex:1; cursor:crosshair; }
        #fbBottom { display:flex; align-items:center; gap:8px; padding:8px 12px; background:rgba(20,20,40,0.95); border-top:1px solid rgba(255,255,255,0.08); flex-shrink:0; }
        #fbComment { flex:1; padding:8px 14px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); border-radius:10px; color:white; font-size:13px; outline:none; font-family:inherit; }
        #fbComment::placeholder { color:rgba(255,255,255,0.25); }
        #fbComment:focus { border-color:rgba(139,170,255,0.4); }
        .fb-type { padding:4px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:transparent; color:rgba(255,255,255,0.5); font-size:12px; cursor:pointer; }
        .fb-type.active { background:rgba(139,170,255,0.15); color:white; border-color:rgba(139,170,255,0.4); }
        #fbSend { padding:8px 18px; border-radius:10px; border:none; background:linear-gradient(135deg,#8b9aff,#6366f1); color:white; font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; }
        #fbSend:hover { filter:brightness(1.1); }
        #fbSend:disabled { opacity:0.5; cursor:not-allowed; }
        /* AI circles on screenshot */
        .fb-ai-circle { position:absolute; z-index:3; pointer-events:auto; cursor:pointer; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; color:white; box-shadow:0 2px 10px rgba(0,0,0,0.5); animation:fbPop 0.4s ease-out; border:2px solid rgba(255,255,255,0.4); }
        .fb-ai-circle:hover { transform:scale(1.15); }
        .fb-ai-area { position:absolute; z-index:2; border:2px dashed; border-radius:6px; pointer-events:none; animation:fbPop 0.5s ease-out; }
        @keyframes fbPop { from { transform:scale(0.5); opacity:0; } to { transform:scale(1); opacity:1; } }
        /* Suggestion list items */
        .fb-sug-item { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; cursor:pointer; transition:all 0.15s; border:1px solid transparent; margin-bottom:4px; }
        .fb-sug-item:hover { background:rgba(139,170,255,0.06); border-color:rgba(139,170,255,0.2); }
        .fb-sug-num { width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:white; flex-shrink:0; }
        .fb-sug-text { flex:1; min-width:0; }
        .fb-sug-title { font-size:12px; font-weight:600; color:rgba(255,255,255,0.85); }
        .fb-sug-desc { font-size:11px; color:rgba(255,255,255,0.35); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        #fbAiLoading { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:4; display:flex; align-items:center; gap:10px; padding:12px 22px; background:rgba(20,20,40,0.9); border-radius:12px; border:1px solid rgba(255,255,255,0.08); }
    </style>

    <button id="fbBtn" onclick="fbCapture()" title="Feedback geben" style="display:none">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12zM11 5h2v4h-2zm0 6h2v2h-2z"/></svg>
    </button>

    <div id="fbOverlay">
        <div id="fbToolbar">
            <span id="fbHeaderMsg" style="font-size:12px;color:rgba(255,255,255,0.5);margin-right:4px">🙏 Danke! Markiere oder tippe auf einen Vorschlag.</span>
            <div style="flex:1"></div>
            <button class="fb-tool active" onclick="fbSetTool('draw')" id="fbToolDraw">✏️</button>
            <button class="fb-tool" onclick="fbSetTool('arrow')" id="fbToolArrow">➡️</button>
            <button class="fb-tool" onclick="fbSetTool('rect')" id="fbToolRect">▢</button>
            <div style="width:1px;height:18px;background:rgba(255,255,255,0.1)"></div>
            <div class="fb-color active" style="background:#f87171" onclick="fbSetColor('#f87171')" data-color="#f87171"></div>
            <div class="fb-color" style="background:#fbbf24" onclick="fbSetColor('#fbbf24')" data-color="#fbbf24"></div>
            <div class="fb-color" style="background:#34d399" onclick="fbSetColor('#34d399')" data-color="#34d399"></div>
            <div style="width:1px;height:18px;background:rgba(255,255,255,0.1)"></div>
            <button class="fb-tool" onclick="fbUndo()">↩</button>
            <button class="fb-tool" onclick="fbClose()" style="color:rgba(248,113,113,0.8)">✕</button>
        </div>
        <div style="flex:1;position:relative;overflow:hidden" id="fbCanvasWrap">
            <canvas id="fbCanvas"></canvas>
            <div id="fbAnnotations" style="position:absolute;inset:0;pointer-events:none"></div>
            <div id="fbAiLoading" style="display:none">
                <div style="width:14px;height:14px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid #8b9aff;border-radius:50%;animation:spin 0.8s linear infinite"></div>
                <span style="font-size:12px;color:rgba(255,255,255,0.5)">BEATRIX analysiert...</span>
            </div>
        </div>
        <!-- AI Suggestion List (appears after analysis) -->
        <div id="fbSugList" style="display:none;padding:8px 12px;background:rgba(20,20,40,0.95);border-top:1px solid rgba(255,255,255,0.08);flex-shrink:0">
            <div style="display:flex;align-items:center;margin-bottom:6px">
                <span style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:0.5px;flex:1">BEATRIX Vorschläge</span>
                <button onclick="fbDismissAll()" style="border:none;background:none;color:rgba(255,255,255,0.25);font-size:11px;cursor:pointer;padding:2px 6px">alle ausblenden</button>
            </div>
            <div id="fbSugItems"></div>
        </div>
        <div id="fbBottom">
            <button class="fb-type active" onclick="fbSetType('bug')" id="fbTypeBug">🐛</button>
            <button class="fb-type" onclick="fbSetType('wunsch')" id="fbTypeWunsch">💡</button>
            <button class="fb-type" onclick="fbSetType('frage')" id="fbTypeFrage">❓</button>
            <input id="fbComment" placeholder="Was fällt dir auf?" maxlength="500" onkeydown="if(event.key==='Enter')fbSend()">
            <button id="fbSend" onclick="fbSend()">Senden ➤</button>
        </div>
    </div>

    
    <!-- ═══ SESSION HISTORY DRAWER ═══ -->
    <div id="sessionHistoryOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9000;transition:opacity 0.2s" onclick="if(event.target===this)toggleSessionHistory()">
        <div id="sessionHistoryDrawer" style="position:absolute;right:0;top:0;bottom:0;width:min(420px,90vw);background:var(--surface,#0f1729);border-left:1px solid var(--border,#1e2d4a);display:flex;flex-direction:column;transform:translateX(100%);transition:transform 0.25s ease;overflow:hidden">
            <div style="padding:16px 20px;border-bottom:1px solid var(--border,#1e2d4a);display:flex;justify-content:space-between;align-items:center">
                <div>
                    <h3 style="margin:0;font-size:16px;color:white">📋 Session-Verlauf</h3>
                    <p style="margin:2px 0 0;font-size:11px;color:var(--text-muted,#6b7fa3)" id="sessionHistoryCount"></p>
                </div>
                <button onclick="toggleSessionHistory()" style="background:none;border:none;color:var(--text-muted,#6b7fa3);font-size:20px;cursor:pointer;padding:4px 8px">✕</button>
            </div>
            <div id="sessionHistoryList" style="flex:1;overflow-y:auto;padding:12px"></div>
        </div>
    </div>
    <!-- Session Detail Modal -->
    <div id="sessionDetailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9100;overflow-y:auto" onclick="if(event.target===this)closeSessionDetail()">
        <div style="max-width:700px;margin:40px auto;background:var(--surface,#0f1729);border:1px solid var(--border,#1e2d4a);border-radius:14px;overflow:hidden">
            <div style="padding:16px 20px;border-bottom:1px solid var(--border,#1e2d4a);display:flex;justify-content:space-between;align-items:center">
                <div>
                    <h3 style="margin:0;font-size:15px;color:white" id="sessionDetailTitle">Session</h3>
                    <p style="margin:2px 0 0;font-size:11px;color:var(--text-muted,#6b7fa3)" id="sessionDetailMeta"></p>
                </div>
                <button onclick="closeSessionDetail()" style="background:none;border:none;color:var(--text-muted,#6b7fa3);font-size:20px;cursor:pointer;padding:4px 8px">✕</button>
            </div>
            <div id="sessionDetailMessages" style="padding:16px 20px;max-height:60vh;overflow-y:auto"></div>
            <div id="sessionDetailActions" style="display:none;padding:12px 20px;border-top:1px solid var(--border,#1e2d4a);display:flex;gap:8px;justify-content:center;flex-wrap:wrap"></div>
        </div>
    </div>

<script>
// ═══ Universities Knowledge Base (isolated script) ═══
// ── Universities Knowledge Base ───────────────────
        let _uniData = null;
        let _uniView = 'universities'; // universities | departments | professors | papers
        let _uniPath = {}; // {uni, dept, prof}

        const _UNI_KB_EMBEDDED = {"version":"1.0","updated":"2026-02-13","source":"ZORA (Zurich Open Repository and Archive)","universities":{"uzh":{"name":"Universit\u00e4t Z\u00fcrich","short":"UZH","logo":"https://www.uzh.ch/static/favicons/apple-touch-icon.png","departments":{"economics":{"name":"Department of Economics","url":"https://www.econ.uzh.ch","professors":{"fehr_ernst":{"name":"Ernst Fehr","field":"Behavioral Economics","chair":"Economics of Institutions","zora_total":288,"pdfs":13,"papers":[{"t":"How do monetary incentives affect the measurement of social preferences?","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2d2823bf-76aa-484e-9cad-b6967776e11c/content","id":"302e8251-e5fb-40e7-9ee5-fb59dace18ed"},{"t":"Oxytocin increases trust in humans with a low disposition to trust","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/d55b55dd-e1bd-4228-bc0b-ba7fb5bc958d/content","id":"376a337f-c7d6-4712-b003-a5ab8d5812d9"},{"t":"The Complementarity Between Trust and Contract Enforcement","y":"2025","j":"Crossref:10.1093/ej/ueaf077","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5edcdfc4-7264-456c-9d3f-ec5631b1cf9a/content","id":"8830963d-89fb-4de3-b444-96ec2e694a9e"},{"t":"Essays in economic history and political economy","y":"2025","j":"","pdf":null,"id":"ca1cbd9e-64ec-4432-92fa-5f15a6a13c81"},{"t":"Building bridges to the future: a tribute to Kaspar Villiger's legacy","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6e590abf-a9ba-4166-84c1-958a897fd346/content","id":"a2207eb1-2098-4ab9-a2e1-081652fd4fc7"},{"t":"Common ratio and common consequence effects arise from true preferences","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/86602e77-0936-4bb8-90e4-bc393f9b942b/content","id":"5167560e-e2cc-4d45-b402-4ec38c731370"},{"t":"The complementarity between trust and contract enforcement","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/91a78fd6-e017-4709-a7d4-4e6ef419fceb/content","id":"2757d176-005c-43b0-b30c-8aa7af3e7c80"},{"t":"Inequality aversion predicts support for public and private redistribution","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c71cd854-7a41-4ce3-a3c6-35db5d1db5e3/content","id":"299e916c-996a-4049-ac56-b51d1b81d776"},{"t":"Social preferences and redistributive politics","y":"2024","j":"","pdf":null,"id":"0b2821db-c326-4139-94ac-e7fe7552be29"},{"t":"Finding and developing the 21st century scientific pioneer","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b08dbea3-84ed-4fb1-a2a3-030bd5912a52/content","id":"84325714-94e3-43b6-add1-d00b99ec4af6"},{"t":"On the psychological foundations of ambiguity and compound risk aversion","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/91daf57c-a382-4604-a7f1-0d013f42b691/content","id":"1bad018b-1473-4d5f-a3c2-f34d5048f4c3"},{"t":"Social preferences: fundamental characteristics and economic consequences","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/a1e352af-71c0-4fdc-9715-478673ad5252/content","id":"377c64ff-5d51-4d63-adc9-1e83778856a0"},{"t":"Super-additive cooperation","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ac4e366e-08f1-4ba2-9049-c6664de41382/content","id":"e36e960d-800d-499c-a139-676a67dac890"},{"t":"Beliefs about inequality and the nature of support of redistribution","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/aadc94a4-aad4-4731-92bc-2360ad5feafa/content","id":"25e60992-f120-47f4-b057-d7d947a1e80a"},{"t":"Beliefs about inequality and the nature of support for redistribution","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/57599189-1618-4b70-a93d-0bf5a779cdb2/content","id":"7f44cbf5-8766-45cf-9d57-71cb46d73a60"}]},"weber_roberto":{"name":"Roberto Weber","field":"Experimental","chair":"Theory of the Firm","zora_total":91,"pdfs":15,"papers":[{"t":"The Causal Effect of Income on Market Social Responsibility","y":"2025","j":"Crossref:10.1093/ej/ueaf064","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/34f36ac3-fa2e-416c-a9c4-94a88f7eb4ef/content","id":"f2438cdd-4c08-49aa-b31d-9b790a606f2c"},{"t":"What money shouldn't buy? Measuring aversion to monetary incentives for health behaviors","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/d583b026-c12c-4c1b-8870-a526fb43f5c8/content","id":"2a25ae63-d982-4708-9c2f-bf9e73908b85"},{"t":"Revealed privacy preferences: are privacy choices rational?","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/03958a4a-a116-4936-9397-e700c2bc7f0a/content","id":"b08e130a-ac4f-42d8-ae9b-8f742690d03d"},{"t":"Building bridges to the future: a tribute to Kaspar Villiger's legacy","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6e590abf-a9ba-4166-84c1-958a897fd346/content","id":"a2207eb1-2098-4ab9-a2e1-081652fd4fc7"},{"t":"Gender identity and economic decision making","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f23868fe-ec23-437e-b3f4-acb84d0c9590/content","id":"8bfc3796-1d3f-49be-9ebd-26e45b9f704b"},{"t":"Sorting and wage premiums in immoral work","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f288724b-0b8b-4e12-95b6-0d09ea68569f/content","id":"3b33ba3d-51c4-4b67-9505-305e61120888"},{"t":"Does redistribution affect cooperation and trust?","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6da023bf-d64b-436e-8f72-be1106fc8f8a/content","id":"2dc91d59-5814-4aad-af68-96d5c864737e"},{"t":"Public discourse and socially responsible market behavior","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/582188d6-cad6-4b46-8b5e-92c2494146c8/content","id":"8ad75332-096d-410c-ae03-8598c591aa59"},{"t":"Introduction to the special issue in honor of Amnon Rapoport, part 1","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f185c5e2-5079-43b6-b8f0-853412801ac2/content","id":"1c797fb5-ecc8-4258-a953-fe17f969a9a9"},{"t":"Effective leadership across economic contexts","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/80f1ec28-9187-4c97-9aaf-9860fe572d15/content","id":"3849a076-2a3b-400b-a125-c8aedfb99407"},{"t":"The causal effect of income on market social responsibility","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/d02e8f3d-bd26-4232-9935-a59866183c68/content","id":"ca9723ab-8259-4b5c-a5cb-b0eabcb3fdb0"},{"t":"Public discourse and socially responsible market behavior","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/cf1d9535-5a67-490a-9726-298391269cf5/content","id":"8c817621-0b0d-4c97-b029-436a3c55e09a"},{"t":"Sorting and wage premiums in immoral work","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/99b6e7f2-f081-44d4-a4f0-a8075e5593b9/content","id":"c47e283c-9d8f-44fc-bc61-cfc0641cc206"},{"t":"What money can buy: how market exchange promotes values","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/330301a0-9bac-4638-bd2a-088423050568/content","id":"2c94ee7f-c551-4ae1-a710-c8d985f26981"},{"t":"Does redistribution affect social capital?","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/4b0cbeeb-6b2c-4718-8415-c85ce22906e4/content","id":"57780322-c776-40b7-b847-2ecc95470e06"}]},"bartling_bjoern":{"name":"Bj\u00f6rn Bartling","field":"Experimental","chair":"Applied Micro","zora_total":66,"pdfs":12,"papers":[{"t":"The Causal Effect of Income on Market Social Responsibility","y":"2025","j":"Crossref:10.1093/ej/ueaf064","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/34f36ac3-fa2e-416c-a9c4-94a88f7eb4ef/content","id":"f2438cdd-4c08-49aa-b31d-9b790a606f2c"},{"t":"The Complementarity Between Trust and Contract Enforcement","y":"2025","j":"Crossref:10.1093/ej/ueaf077","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5edcdfc4-7264-456c-9d3f-ec5631b1cf9a/content","id":"8830963d-89fb-4de3-b444-96ec2e694a9e"},{"t":"Free to fail? Paternalistic preferences in the United States","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b2b78699-a2ba-4952-bf6c-99c0c8ee5726/content","id":"8e1c8ee8-798a-490e-ae01-9cdaebb7ba48"},{"t":"Paternalistic interventions: determinants of demand and supply","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/113c6352-36b4-4fdc-bdee-e290ced7c734/content","id":"8e80f571-dfc0-49c1-bf7b-5ceb2e53458f"},{"t":"The talent paradox: why is it fair to reward talent but not luck?","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c39c790d-f2c1-43a7-bd4e-65cf80109682/content","id":"5bb79817-c661-49fa-9d9a-7854572c9825"},{"t":"The complementarity between trust and contract enforcement","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/91a78fd6-e017-4709-a7d4-4e6ef419fceb/content","id":"2757d176-005c-43b0-b30c-8aa7af3e7c80"},{"t":"Public discourse and socially responsible market behavior","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/582188d6-cad6-4b46-8b5e-92c2494146c8/content","id":"8ad75332-096d-410c-ae03-8598c591aa59"},{"t":"Fairness in winner-take-all competitions","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b9d038a4-34a7-497a-a879-f1f42be6b5e7/content","id":"3fef55e4-6246-49fd-a5c3-d368ff38942f"},{"t":"The causal effect of income on market social responsibility","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/d02e8f3d-bd26-4232-9935-a59866183c68/content","id":"ca9723ab-8259-4b5c-a5cb-b0eabcb3fdb0"},{"t":"Public discourse and socially responsible market behavior","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/cf1d9535-5a67-490a-9726-298391269cf5/content","id":"8c817621-0b0d-4c97-b029-436a3c55e09a"},{"t":"Essays in behavioral public economics","y":"2024","j":"","pdf":null,"id":"cca409ab-c5ee-4f50-b95c-52086816536d"},{"t":"The limits to moral erosion in markets: Social norms and the replacement excuse","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/34a243f7-7bad-4ee4-99f1-dd339ec89d01/content","id":"f76da9d9-fd63-4bbf-8b48-d066fd801e9b"},{"t":"Does market interaction erode moral values?","y":"2023","j":"","pdf":null,"id":"0ad25725-555f-4633-a66f-6007fbd34bbd"},{"t":"Essays on value (mis)perceptions, beliefs, and economic decision making","y":"2022","j":"","pdf":null,"id":"57facb45-081e-46aa-97e1-1e6eec2d0f42"},{"t":"Does market interaction erode moral values?","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/a716563d-5cb4-4afc-8449-2689a3b30020/content","id":"a07d62d7-c9a4-4c26-b419-2ab3e8861b82"}]},"marechal_michel":{"name":"Michel Mar\u00e9chal","field":"Behavioral Econ","chair":"Behavioral Econ of Firms","zora_total":45,"pdfs":11,"papers":[{"t":"Standing in prisoners' shoes: a randomized trial on how incarceration shapes criminal justice preferences","y":"2026","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/921a3944-8a2a-409a-90f0-00a942735a3b/content","id":"bb49b19d-41cf-48df-b971-c2330b668ff3"},{"t":"Understanding inequality and redistribution: the role of perceptions and preferences","y":"2025","j":"","pdf":null,"id":"255f0646-ea53-4e9b-b853-a33a96120b2a"},{"t":"What do cross-country surveys tell us about social capital?","y":"2025","j":"","pdf":null,"id":"d198e2f1-ff60-4791-b7f3-3567462ecd11"},{"t":"Essays in behavioral public economics","y":"2024","j":"","pdf":null,"id":"cca409ab-c5ee-4f50-b95c-52086816536d"},{"t":"Whose preferences matter for redistribution: cross-country evidence","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/edba6f12-fa32-4507-929d-4f68074997b0/content","id":"c1d691b3-e6d0-4468-bda0-86d76d532c4a"},{"t":"Vaccine nationalism counterintuitively erodes public trust in leaders","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e40c88a8-c5ca-4193-9fff-d00ab88a6521/content","id":"f503f468-4ca0-4622-9964-9855502a3170"},{"t":"Whose preferences matter for redistribution: cross-country evidence","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/0d6e53b3-7618-442f-9336-ca439c345006/content","id":"fa6550dc-20af-4b40-85e5-29c668d71901"},{"t":"A closer look at civic honesty in collectivist cultures","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/4d2f8222-7131-4540-99ca-db023cd807f6/content","id":"7bec295b-a9e0-4555-b39c-41b8a2207691"},{"t":"Honesty in the digital age","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/7109a16d-f65b-4217-8e04-22657c2b7600/content","id":"4437c1a2-19e8-40cf-8eee-37b526fc770f"},{"t":"What do cross-country surveys tell us about social capital?","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/513fe5b4-56b9-4145-b8ba-cba5d7e3e5e1/content","id":"02b1f215-f75f-4e66-9beb-eeff76db1547"},{"t":"Moral dilemmas and trust in leaders during a global health crisis","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/18f99188-2f85-4232-9071-bcfc617bbc24/content","id":"5134e5cf-74da-4cf9-ba97-d58bba74e067"},{"t":"Frequent job changes can signal poor work attitude and reduce employability","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/dd462e7e-f826-440d-9004-3abd386b333c/content","id":"40f2053c-ab82-424e-a45e-80df4d92c4f1"},{"t":"Essays on peer effects, gender, disparities, and skill formation","y":"2021","j":"","pdf":null,"id":"7f42177e-35ed-4e41-b98a-93a3127aac17"},{"t":"Honesty in the digital age","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/90c51e4b-143e-49d3-9725-9165cd8c0091/content","id":"68b8a9b4-c8ea-4bcc-921a-eb2c00c29530"},{"t":"Motivated misremembering of selfish decisions","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e8a0c838-ca89-4662-8f09-ffe2ef3c5f03/content","id":"ffe5c315-c48a-4277-b844-ac6013eda61f"}]},"alos_ferrer":{"name":"Carlos Al\u00f3s-Ferrer","field":"Neuroeconomics","chair":"NOMIS Prof","zora_total":102,"pdfs":14,"papers":[{"t":"Improving numerical measures of human feelings: the case of pain","y":"2025","j":"Crossref:10.1016/j.socscimed.2025.118472","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e40f020c-d185-43ca-8e0c-c1e7eef25aea/content","id":"66a25c28-673f-4b0d-bc39-f6bfc6fa379f"},{"t":"Common ratio and common consequence effects arise from true preferences","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/86602e77-0936-4bb8-90e4-bc393f9b942b/content","id":"5167560e-e2cc-4d45-b402-4ec38c731370"},{"t":"Part-time Bayesians: incentives and behavioral heterogeneity in belief updating","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/18c4f591-dcef-4df9-b0b3-5533dc996a60/content","id":"d5ed32b7-dd76-4aee-b0c4-7d877ff2f6a0"},{"t":"Does choice change preferences? An incentivized test of the mere choice effect","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2c767cbf-bbe6-474a-8043-d477e7ce5cd4/content","id":"20e89241-c3a4-4af1-9c1c-8c60c802396f"},{"t":"Gut instincts are useful shortcuts: but they can also be misleading","y":"2023","j":"","pdf":null,"id":"9e326091-0bff-40a7-9343-85d03ea76e5c"},{"t":"Identifying nontransitive preferences","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/0d3565c7-ec60-4513-b513-a8e1315d52f7/content","id":"6caeda90-f6ed-4dae-b2b5-83819619e552"},{"t":"An axiomatic characterization of Bayesian updating","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ea32a6d8-ccb4-42d1-97f9-5af8af1a9835/content","id":"90604dde-ab0d-4d8d-b53e-6ce8eafb4b53"},{"t":"Ethical allocation of scarce vaccine doses: the Priority-Equality protocol","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1cc83f05-12c3-4a8f-8bc5-65f4b9f52eb1/content","id":"8cc34e61-e3cf-46de-b8f6-8509a5270bd8"},{"t":"Who likes it more? Using response times to elicit group preferences in surveys","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/986badd8-1913-4749-951d-f0cb28db9626/content","id":"1a0579b6-160a-4051-ac59-44716c9a71fd"},{"t":"Voting under time pressure","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/66dfaf41-daa9-4582-8ea6-e5b92a51c2fc/content","id":"1a1b3b49-fb6c-4fe4-b5b8-e97ce3600623"},{"t":"Excess payoff dynamics in games","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ce34801b-1b30-4139-9de3-4b71976f1cb5/content","id":"762258dd-d41d-40ad-80dd-7eddceee6b8b"},{"t":"The gradual nature of economic errors","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/28944b15-39cd-46ea-838d-7581c20fe023/content","id":"723fb8f1-6827-4dcc-b4c1-3398bc8d94ea"},{"t":"Attention and salience in preference reversals","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/31d12c0d-bd3b-47be-9608-17577f3edfec/content","id":"1777767b-6c3a-4911-b7de-a47994f21b1a"},{"t":"Strength of preference and decisions under risk","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/fd99fdb3-7412-4275-a5c0-363d53e4f875/content","id":"8c32dc98-e029-401d-9085-5b0421e6f70e"},{"t":"Do traders learn to select efficient market institutions?","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c57de8c8-a4ac-4d47-ad2c-a7131baed360/content","id":"b3b32629-9f77-4368-b788-1ef201d46644"}]},"hare_todd":{"name":"Todd Hare","field":"Neuroeconomics","chair":"Neuroeconomics","zora_total":92,"pdfs":15,"papers":[{"t":"Trial-by-trial learning signatures in self-reported affect that require introspection and are orthogonal to social choice","y":"2025","j":"Crossref:10.1037/emo0001623","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/4e8f7798-4a3a-4662-b1d0-d21021517295/content","id":"075c8f8a-53b2-41c6-b09e-deb8ee1578a4"},{"t":"Pre-choice midbrain fluctuations affect self-control in food choice: a functional magnetic resonance imaging (fMRI) study","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/80a5d76d-25c3-4517-9d80-32aa4479f222/content","id":"ccb02ec0-7117-43a7-9429-b3114c387637"},{"t":"Neuropharmacological basis of behavioral flexibility","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f1a6f703-10c2-4241-a9e0-310861e9269f/content","id":"5a6d2fff-f282-436e-b7bf-b3128ec1f500"},{"t":"Rationality, preferences, and emotions with biological constraints: it all starts from our senses","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6206cdd2-0b7b-4d6d-8687-0d8c8d017ec6/content","id":"cffd72f4-640e-4f28-9923-e302b3a32c94"},{"t":"Intrachoice dynamics shape social decisions","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/50eb2f2d-c550-436a-8e83-ab7ca57492a3/content","id":"3663abde-0e32-42f3-bcc6-e195c3af1a8f"},{"t":"Mapping expectancy-based appetitive placebo effects onto the brain in women","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c896426c-9e97-410c-8525-0b92f24e818b/content","id":"edf91370-2d4c-488b-8081-aa0e4c748cf6"},{"t":"Goal-dependent hippocampal representations facilitate self-control","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ae11edc9-7aff-4f45-a96b-40f5d9b51f55/content","id":"8fdfa169-9e7b-49d1-8695-ea6465f915d3"},{"t":"The interplay of hedonic appetite and attentional abilities is linked to poorer dietary self-control: two studies on young adults living in cities","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/08ea35b1-8256-41a0-b346-71783399ae43/content","id":"934fde87-5f29-4725-a01c-e017a3535dbb"},{"t":"Sensory perception relies on fitness-maximizing codes","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b6b135f1-1526-4e29-a3d2-e57369a024c6/content","id":"dfa8e204-a422-494c-b65d-801d95b537f1"},{"t":"Value certainty and choice confidence are multidimensional constructs that guide decision-making","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/4108d800-f741-41c0-bd85-6f08430333ff/content","id":"4be4630a-fdeb-4101-838f-423b9767cccb"},{"t":"Rethinking model-based and model-free influences on mental effort and striatal prediction errors","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/85c7f54a-3ca8-41e8-953a-342613e953b3/content","id":"959e904f-3303-418d-8c42-f51452cd405e"},{"t":"Taste matters: mapping expectancy-based appetitive placebo effects onto the brain","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/27da8c91-65cb-442a-9d7a-df8eb548aec4/content","id":"77a61dd7-707f-4e1e-8ddf-2916d6a92ed3"},{"t":"BOLD activity during emotion reappraisal positively correlates with dietary self-control success","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/9401bd09-1a22-475e-abbb-b215b016a8c4/content","id":"6f60913d-35c8-418f-bcee-11e39a560b6d"},{"t":"Intra-individual variability in task performance after cognitive training is associated with long-term outcomes in children","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/3665bfa0-cd11-4975-a562-ba3eda538090/content","id":"36e6f403-34c4-47e2-b542-0a712f04d48b"},{"t":"Deconstructing neural and behavioral mechanisms underlying social behavior","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/0e426452-79a1-4fb2-9705-b7f166095542/content","id":"946496ae-1e67-41e4-983b-3d4517dc851e"}]},"ruff_christian":{"name":"Christian Ruff","field":"Neuroeconomics","chair":"Motivation & Action","zora_total":148,"pdfs":15,"papers":[{"t":"Neural and behavioural differences in multisensory statistical and reinforcement learning across development and task variants","y":"2026","j":"PubMed:PMID:41641174","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/73ee9f8e-fd24-4f7c-beaf-f0bb4911b1b9/content","id":"730adf60-c069-4771-9a9b-42f22b3a851a"},{"t":"Causal evidence for a domain-specific role of left superior frontal sulcus in human perceptual decision making","y":"2025","j":"Crossref:10.7554/elife.94576.3","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/7bdef815-49f8-40da-9bec-a00201da131b/content","id":"3196e6dd-c91a-4d6f-868d-aa35f109c647"},{"t":"Growing minds, integrating senses: neural and computational insights into age-related changes in audio-visual and tactile-visual learning in children","y":"2025","j":"Crossref:10.1016/j.dcn.2025.101622","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5d0570f8-ebab-462b-a70f-ec5ca25dc8f7/content","id":"2813bdcf-73c7-411c-94fe-4c6cc83ed9e6"},{"t":"Understanding resilience in medical interns through ecological momentary assessments, predictive modelling, and topic analysis","y":"2025","j":"Crossref:10.1038/s43856-025-01084-2","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/78ffe89c-1ce6-4edb-90a9-cb980f33ab6e/content","id":"3ce88c87-af08-46fd-a002-a4a22a43110b"},{"t":"A computational account of multiple motives guiding context-dependent prosocial behavior","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5f822fe8-b449-41dd-93f2-e62b5a5994b6/content","id":"3908857d-5824-4851-9d7e-5e044a8a0dde"},{"t":"Manipulating attention facilitates cooperation","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/0d28254a-edca-44ed-b253-aab8d401478a/content","id":"ed19f54f-5ea2-40ba-9743-ccc95a88ab58"},{"t":"Frontopolar cortex interacts with dorsolateral prefrontal cortex to causally guide metacognition","y":"2025","j":"Crossref:10.1002/hbm.70146","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6dd85287-2289-40d9-bb55-c20ff5f67807/content","id":"ee2c863b-d818-4d8c-8812-a6515adb1274"},{"t":"New insights from gene expression patterns on the neurobiological basis of risky behavior","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e6ceb622-f221-4984-8523-a0029e2c23c0/content","id":"32c9e165-57f5-4545-9c8c-79521c588620"},{"t":"Causal involvement of dorsomedial prefrontal cortex in learning the predictability of observable actions","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f6883843-40f8-4721-867d-64fcff1634dd/content","id":"2f8558aa-df21-4de3-9d19-ac4909575100"},{"t":"Acute stress reduces effortful prosocial behaviour","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2ffab730-c9a9-4ac1-8474-76ebc866c013/content","id":"631b3f1e-1462-43ce-b107-9779c3cf23fc"},{"t":"Individual risk attitudes arise from noise in neurocognitive magnitude representations","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2ba7d0da-c2df-4ab1-a047-64cdf02b904c/content","id":"3c8a73dd-579e-4d67-85a8-c5ee0baca663"},{"t":"Occipital transcranial direct current stimulation in episodic migraine patients: effect on cerebral perfusion","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/49e974ab-c947-4432-9f15-9d35dd60eb95/content","id":"bfd2f318-40ee-4487-ba61-3961aeaf31ec"},{"t":"Combined neuroimaging methods","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5dee0637-f814-48bb-bb42-89e038edbbe5/content","id":"db74acb7-b056-423a-99b3-28d986ad7ee9"},{"t":"Fairness: das Sorgenkind moderner Gesellschaften?","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/80e22b1f-d724-4c06-bd34-5d2ff882b1f2/content","id":"11f6ec9d-c2c1-410c-b651-376670649125"},{"t":"A unified neural account of contextual and individual differences in altruism","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/06941aa2-b360-4c8d-bd19-95056aba6039/content","id":"0204c8e7-b40d-45e0-b76a-03200abc74e8"}]},"tobler_philippe":{"name":"Philippe Tobler","field":"Neuroeconomics","chair":"Social Neuroscience","zora_total":197,"pdfs":15,"papers":[{"t":"Dopamine and serotonin neurotransmissions exert complementary control over primate approach and avoidance","y":"2025","j":"Crossref:10.1038/s41398-025-03794-6","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f41c295a-d4df-440d-80f6-6bb8c9ecaea5/content","id":"724e3b02-ccf8-48fc-b64c-34fbfd4b5898"},{"t":"Learning reduces ingroup bias more with perceived losses than gains across cultures","y":"2025","j":"Crossref:10.1038/s41539-025-00362-x","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ef785c57-6fb6-4841-9a13-309a7485516d/content","id":"25226507-594a-4611-bc8e-b23cb812653f"},{"t":"Improving numerical measures of human feelings: the case of pain","y":"2025","j":"Crossref:10.1016/j.socscimed.2025.118472","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e40f020c-d185-43ca-8e0c-c1e7eef25aea/content","id":"66a25c28-673f-4b0d-bc39-f6bfc6fa379f"},{"t":"An attractiveness bias? How women entrepreneurs' physical appearance affects men investors","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/942bf7bd-00f6-459c-ada9-1bd26a107ace/content","id":"c4681cbe-e37d-4422-89eb-eeb92707e5a6"},{"t":"How testosterone administration affects learning to avoid harm in healthy men: a double-blind, placebo-controlled study","y":"2025","j":"Crossref:10.1016/j.biopsycho.2025.109108","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/bbabdba8-c38b-4a90-9a17-5d03bb9c0d7b/content","id":"fc0ddef5-3c16-41ed-ab82-e6c30835b4f9"},{"t":"Improving rationality by increasing attention","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/0d87214c-e226-4a60-b071-6d10347368a5/content","id":"e5e2f188-d993-45d3-9838-aca219d31f6e"},{"t":"The anterior insula processes a time-resolved subjective risk prediction error","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/45b41390-74f4-4237-b275-d21548c92bd1/content","id":"9ac20d80-fef9-47ea-aebb-a3f03d1d310c"},{"t":"Volitional regulation and transferable patterns of midbrain oscillations","y":"2025","j":"Crossref:10.1523/jneurosci.1808-24.2025","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5ceb6baf-decd-497c-9476-07237003f76f/content","id":"cad12d83-3929-4092-ba75-f22c626ba9c2"},{"t":"Testosterone administration increases the computational impact of social evaluation on the updating of state self-esteem","y":"2025","j":"Crossref:10.1016/j.bpsc.2025.02.008","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/76c8fce3-7cc9-49ed-8ec5-f0e10a7fa98a/content","id":"7fe71123-42fe-47a1-af50-f3d6705b8b19"},{"t":"Social risk coding by amygdala activity and connectivity with dorsal anterior cingulate cortex","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b7e7ded8-7455-4f1b-b007-5a472db029c6/content","id":"c9deb278-53d2-4906-8f6f-b57c8875f60d"},{"t":"Frontopolar cortex interacts with dorsolateral prefrontal cortex to causally guide metacognition","y":"2025","j":"Crossref:10.1002/hbm.70146","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6dd85287-2289-40d9-bb55-c20ff5f67807/content","id":"ee2c863b-d818-4d8c-8812-a6515adb1274"},{"t":"Multisensory Learning Across Development:  A Computational and Neuroimaging Investigation of Multisensory Processing and Learning","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/14adbb63-d035-46ac-be14-fcf8924b918c/content","id":"9f0a5c50-d869-41ff-8653-33f50d191855"},{"t":"Tipping the balance between fairness and efficiency through temporoparietal stimulation","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/7f63db5b-d81e-4d26-9567-9136f78d2207/content","id":"2467ffff-4b05-418e-8972-fd0a2da5caf0"},{"t":"Neuropharmacological basis of behavioral flexibility","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f1a6f703-10c2-4241-a9e0-310861e9269f/content","id":"5a6d2fff-f282-436e-b7bf-b3128ec1f500"},{"t":"Causal involvement of dorsomedial prefrontal cortex in learning the predictability of observable actions","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f6883843-40f8-4721-867d-64fcff1634dd/content","id":"2f8558aa-df21-4de3-9d19-ac4909575100"}]},"scheuer_florian":{"name":"Florian Scheuer","field":"Public Finance","chair":"Dept Chair","zora_total":49,"pdfs":8,"papers":[{"t":"The economics of a cap on the profit-to-cost ratio of firms","y":"2025","j":"","pdf":null,"id":"88cebfe1-31e3-48e9-959c-c506ce675b08"},{"t":"What's luck got to do with it? Essays on inequality and redistribution","y":"2025","j":"","pdf":null,"id":"f908e954-c809-4173-9140-5f216e5d7f33"},{"t":"Building bridges to the future: a tribute to Kaspar Villiger's legacy","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6e590abf-a9ba-4166-84c1-958a897fd346/content","id":"a2207eb1-2098-4ab9-a2e1-081652fd4fc7"},{"t":"Putting the 'finance' into 'public finance': a theory of capital gains taxation","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/a3dc418d-98d9-466a-bcd0-3624f5fb777d/content","id":"fed5c00e-7195-4ba7-899a-d9c7e421b9d1"},{"t":"Taxing capital, but right: why realized gains, not asset values, should guide tax policy","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8d1c23b5-aa94-43fa-bdfb-c1eab2f2a061/content","id":"6d442ce5-04bf-4b79-9703-eccc95b8859f"},{"t":"Wie Institutionen \u00fcber Arm und Reich entscheiden","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2274d6ec-ec15-43c3-8196-9f1205f15a20/content","id":"8eb89002-72d7-40f4-9432-5800d0c707fc"},{"t":"How does the perception of a welfare magnet influence support for immigration and redistribution? Evidence from Switzerland","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/3f8bed95-ecd9-4c93-bee1-af5a0158ff0b/content","id":"34ef02c1-e776-498e-9556-aac767e30cc8"},{"t":"Putting the 'finance' into 'public finance': a theory of capital gains taxation","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/fb9e73f1-e410-493d-bf0f-e11a84712e9a/content","id":"3dda2e4b-514e-4a54-8998-de55a7dbbdbc"},{"t":"Monetary policy, financial shocks, and banks : the role of lending relationships and intangible assets in transmission to the real economy","y":"2024","j":"","pdf":null,"id":"2f572cd6-8d37-45d5-8913-c4505f98061b"},{"t":"Essays on clean growth, the renewable energy transition, and financial shocks in the intangible economy","y":"2024","j":"","pdf":null,"id":"c22d0e12-7c39-4a4f-becf-f3c1b9b2eafc"},{"t":"Does a progressive wealth tax reduce top wealth inequality? Evidence from Switzerland","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c571ffae-7b75-40cc-99af-ef3e07d51476/content","id":"61d4180d-caef-48db-8c91-04d958906b18"},{"t":"Does a progressive wealth tax reduce top wealth inequality? Evidence from Switzerland","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2e775b90-3e2a-4a58-a7e1-33e9a534c685/content","id":"0a38c712-8be2-4f67-926c-9b1a3c8d7716"},{"t":"Essays in labor and public economics","y":"2023","j":"","pdf":null,"id":"b1fad44a-c666-4f41-acd3-46b674a4b619"},{"t":"Essays on macroeconomics and market power","y":"2023","j":"","pdf":null,"id":"39536442-a025-4832-a891-28628c7f86cb"},{"t":"Essays in labor economics","y":"2023","j":"","pdf":null,"id":"a1f671e6-f9d4-49e0-914f-fb8485eee9c3"}]},"netzer_nick":{"name":"Nick Netzer","field":"Micro Theory","chair":"Micro Theory","zora_total":57,"pdfs":12,"papers":[{"t":"Time is knowledge: what response times reveal","y":"2026","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/a166e850-f026-4b8d-b805-09e35adc7f44/content","id":"051427fe-d64d-43c9-998a-8b8e1b4fc8d9"},{"t":"The Complementarity Between Trust and Contract Enforcement","y":"2025","j":"Crossref:10.1093/ej/ueaf077","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5edcdfc4-7264-456c-9d3f-ec5631b1cf9a/content","id":"8830963d-89fb-4de3-b444-96ec2e694a9e"},{"t":"Risk perception: measurement and aggregation","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/02a29928-f737-47af-87e1-087dcf115ad4/content","id":"8ac1751b-39ad-4075-9bab-df90b225662d"},{"t":"Improving rationality by increasing attention","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/0d87214c-e226-4a60-b071-6d10347368a5/content","id":"e5e2f188-d993-45d3-9838-aca219d31f6e"},{"t":"The complementarity between trust and contract enforcement","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/91a78fd6-e017-4709-a7d4-4e6ef419fceb/content","id":"2757d176-005c-43b0-b30c-8aa7af3e7c80"},{"t":"Neural reward representations enable utilitarian welfare maximization","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5527d796-db39-4eaf-9ac1-291cda04af59/content","id":"dcd2adbf-2eb8-40c8-ab55-ed4da5d7dc79"},{"t":"Essays in behavioral economics","y":"2024","j":"","pdf":null,"id":"e1a23945-07b4-4129-bcb3-86e284544122"},{"t":"Happy times: measuring happiness using response times","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/abe432a5-c214-4869-bca7-2f95cc3b1884/content","id":"cde0ea80-87cf-4b4d-a006-f95475a0d1b6"},{"t":"Optimal contest design: tuning the heat","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/036f0272-6961-45bd-87d0-1f6dd27914ef/content","id":"dd4116bc-ea55-4db5-99ac-0df075db4ede"},{"t":"The swaps index for consumer choice","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/dca33d8f-2332-490c-b28e-1c0e11df6040/content","id":"e33840f1-39da-44f8-b034-2faab5ceec2b"},{"t":"Happy times: measuring happiness using response times","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/efb14c9e-06df-4fce-a2d9-1590b5f26835/content","id":"446a8f2a-32ec-4574-aafb-dadde20e0ae1"},{"t":"Second-best probability weighting","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c94547bb-bb36-49b7-b958-c1162156f58f/content","id":"6bfe53b5-3e3a-40e7-bf2e-f8abec7300d0"},{"t":"Wozu Volkswirtschaftslehre? Wider ein paar Missverst\u00e4ndnisse","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e769f633-dfcd-44fa-9138-cb2afce7a881/content","id":"2f6ddbc1-fe28-4487-8481-bc2250d9be86"},{"t":"Essays in economic theory","y":"2023","j":"","pdf":null,"id":"53a7bc69-8c14-4704-b46c-cb59f84a2bf2"},{"t":"Essays on expectations and contingencies","y":"2023","j":"","pdf":null,"id":"cc3bff65-4087-486e-8c2c-c83e20864952"}]},"pomeranz_dina":{"name":"Dina Pomeranz","field":"Development","chair":"Applied Micro","zora_total":37,"pdfs":14,"papers":[{"t":"Building bridges to the future: a tribute to Kaspar Villiger's legacy","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6e590abf-a9ba-4166-84c1-958a897fd346/content","id":"a2207eb1-2098-4ab9-a2e1-081652fd4fc7"},{"t":"Distortion by audit: evidence from public procurement","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/32472dc1-9711-42d0-b891-512a95369f70/content","id":"84dfbc9d-2273-493c-bc62-3a86910cda4c"},{"t":"Wie steht es um die Schweizer Entwicklungshilfe?","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/7f522ade-a6ab-47ea-8980-d410aa582427/content","id":"6e2f7532-1a8c-4394-9bde-d83163c07cec"},{"t":"Entwicklungshilfe erzielt klare und \u00fcberpr\u00fcfbare Effekte","y":"2024","j":"","pdf":null,"id":"e0dec8c7-afaf-498d-922d-40442dc8e1c4"},{"t":"Savings accounts to borrow less: experimental evidence from Chile","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/bfa92f3d-ddc5-4417-822f-b5d896370a23/content","id":"5e89888b-b580-4c65-b713-12af7cc8c04c"},{"t":"Ghosting the tax authority: fake firms and tax fraud in Ecuador","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e6d5af10-771b-418d-8dbe-8b0108432cd3/content","id":"e271db3a-926b-4122-b126-b04c848e8ecd"},{"t":"Welchen Einfluss hat der Klimawandel auf die Armut?","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/d934fe76-daf5-43d7-9322-3b19f858f31b/content","id":"78e0eafa-59f8-46cd-b8cb-a72dcf210485"},{"t":"Misallocation in firm production: a nonparametric analysis using procurement lotteries","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/62438019-8dab-4932-89c2-220cf40dca20/content","id":"27202484-2153-4336-94a5-ce0c3e01239a"},{"t":"The race between tax enforcement and tax planning: evidence from a natural experiment in Chile","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/7c581b3e-ebf4-43a3-a3a0-bff511414b5e/content","id":"680e9228-239c-4e56-8e7d-43b00169c30a"},{"t":"Ghosting the tax authority: fake firms and tax fraud in Ecuador","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ebf10477-418e-4753-b1eb-c38e6f3a3e43/content","id":"6f7c877c-6eba-49c7-a437-1cb63bc9d9d1"},{"t":"Imports, exports, and earnings inequality: measures of exposure and estimates of incidence","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/7ae6e1b1-e22e-4653-8ff8-48b0846a6440/content","id":"02875b56-92f8-4057-9d84-45e05004db4c"},{"t":"The race between tax enforcement and tax planning: evidence from a natural experiment in Chile","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1b4982d9-d2ec-4f36-8159-4b8585e77ce0/content","id":"52c26e24-df4f-4412-b910-6f29a6aae9b3"},{"t":"International trade and earnings inequality: a new factor content approach","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/be1e32c9-757f-48ef-a6db-2024c3c89fdd/content","id":"c74a30e0-6bcb-4f59-ac35-70e57943306b"},{"t":"\u00abEs stimmt nicht, dass Sozialhilfe faul macht\u00bb","y":"2019","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ee471088-ec98-4681-96ef-024356c5ceb0/content","id":"c2765217-3a17-4b58-b26a-038c1105b271"},{"t":"Der diesj\u00e4hrige Wirtschaftsnobelpreis ehrt eine \u00d6konomie, die anpackt","y":"2019","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/28f16791-d597-443d-80ff-6b7d6acdd484/content","id":"458e5763-3666-4f98-949d-7899d1ecd88b"}]},"casaburi_lorenzo":{"name":"Lorenzo Casaburi","field":"Development","chair":"Applied Micro","zora_total":22,"pdfs":10,"papers":[{"t":"Land rental markets: experimental evidence from Kenya","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/be74a665-fac3-418e-87de-b6c92aee1bed/content","id":"50c6ab74-9dc1-42e5-8180-7f708792f2cc"},{"t":"Building bridges to the future: a tribute to Kaspar Villiger's legacy","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6e590abf-a9ba-4166-84c1-958a897fd346/content","id":"a2207eb1-2098-4ab9-a2e1-081652fd4fc7"},{"t":"Harvesting votes: the electoral effects of the Italian land reform","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f085d06a-1b42-468d-ab0d-29ceab3a77d4/content","id":"2c2c29a6-1a6a-4564-9bcc-2ce62969db08"},{"t":"Essays on the political economy of organized labor, corruption, and political engagement","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/90b642a5-9266-43bc-9a30-6530ef0570c3/content","id":"99b4c204-46e4-49e5-a53d-948d741c6ecb"},{"t":"Value chain microfinance","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/967b9819-fe76-4cea-94d1-6d266255fe2e/content","id":"179b9c9c-11e8-4489-bb9f-26744c6a9bf1"},{"t":"Land rental markets: experimental evidence from Kenya","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/448e19c9-374b-42f7-ae2f-5e4897ca6ab4/content","id":"705d0ef1-24d0-490e-be73-66c4e28d9c26"},{"t":"Essays on environmental and agricultural economics","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5fb7f1bf-3a18-42f4-accd-97321f566847/content","id":"4a5949ed-8107-41bd-b1f2-6db95cef3bf1"},{"t":"Essays in development economics","y":"2023","j":"","pdf":null,"id":"1e6b1c95-09c5-4951-9ea0-889ad639c996"},{"t":"Essays in experimental economics","y":"2023","j":"","pdf":null,"id":"4b0548a5-fdeb-470f-a799-e3792b9943bb"},{"t":"Introduction to development engineering: a framework with applications from the field","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b37e24e5-150a-43b5-b3ca-1b7535de5097/content","id":"7b56d168-dd4d-4c12-a0a6-445c123d108a"},{"t":"Using individual-level randomized treatment to learn about market structure","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/edef2c82-dd97-416f-96a7-d741b93df612/content","id":"49e4196d-f40b-4145-9710-b1dbc1f021b4"},{"t":"Essays in applied microeconomics","y":"2022","j":"","pdf":null,"id":"c6282537-6f71-4e82-a9dd-55b6f70088ca"},{"t":"Essays on infrastructure, accessibility, and spatial patterns","y":"2022","j":"","pdf":null,"id":"994ee346-99c1-41b2-aabb-7ae28f614148"},{"t":"How does trade liberalization affect the intensity of conflicts?","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ad7a8712-b2c1-4c34-bf66-3e9143f872dc/content","id":"84d0045e-0bb1-4e09-ac42-86370eb32219"},{"t":"Essays in development economics and political economy","y":"2021","j":"","pdf":null,"id":"ae5b3cd7-1d66-4308-a53d-adbb8b02e85f"}]},"zoelitz_ulf":{"name":"Ulf Z\u00f6litz","field":"Labor","chair":"Applied Economics","zora_total":36,"pdfs":13,"papers":[{"t":"Disconnecting women: gender disparities in the impact of online instruction","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/dd7f357e-e360-4693-8d89-4038383b727c/content","id":"345e144e-3842-4ad4-b1a2-713e9f6fb854"},{"t":"Understanding inequality and redistribution: the role of perceptions and preferences","y":"2025","j":"","pdf":null,"id":"255f0646-ea53-4e9b-b853-a33a96120b2a"},{"t":"Same-sex teacher effects","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f1ff87b2-bb82-4694-b0d6-c5430fe3d1dd/content","id":"37fa81eb-6f33-48aa-9348-0cb9be4a2031"},{"t":"The causal impact of socio-emotional skills training on educational success","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/676120a5-e064-4284-a22b-acda8a272e7d/content","id":"27988035-135e-4c72-9d1f-95e6babf7482"},{"t":"Same-sex teacher effects","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/0360810f-0b7a-4955-852c-42b157d7d7c4/content","id":"f3adb3bb-0aed-4979-93ff-c17d451995a7"},{"t":"The causal impact of socio-emotional skills training on educational success","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/950c9169-2355-4756-814d-ce59fdab71fe/content","id":"0261780d-25ff-4c64-8038-c600ee5b22a3"},{"t":"Same-sex role model effects in education","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/9ae47ecc-8946-41f8-8b9f-21d57c9f1a1b/content","id":"bae8cd9d-4230-43ff-afd8-25e57ef3763d"},{"t":"An integrative approach for the analysis of risk and health across the life course: challenges, innovations, and opportunities for life course research","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/0d9df6d5-411e-4fd6-8a39-ed93edb1af73/content","id":"ca19826a-86d6-40d3-936c-03543021ca6d"},{"t":"Essays in labor economics and human capital allocation","y":"2023","j":"","pdf":null,"id":"25608c27-6a8a-48bf-b00f-2c01c6da554b"},{"t":"Peers affect personality development","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6e79de9c-80f1-46e5-b2e7-e9eed48f619e/content","id":"3e0b1511-6dd0-4519-9801-6c11d933a104"},{"t":"The effect of higher-achieving peers on major choices and labor market outcomes","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c19d8600-746b-4c33-8ae8-5940bb8331c7/content","id":"d8acd64a-6087-4b6a-9052-2c04aacdac96"},{"t":"The effect of peer gender on major choice in business school","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/85ee65da-1903-4f7f-9b98-a1e7bf82c26a/content","id":"1621eae6-f0f2-44aa-94d9-3614ca02e0c9"},{"t":"Achievement rank affects performance and major choices in college","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e78df4bf-c880-4add-bd99-b236655633bc/content","id":"7fa167f8-0f94-4a1d-9e7d-b660b7264966"},{"t":"The effect of higher-achieving peers on major choices and labor market outcomes","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/579aaaec-2e59-43c1-bc80-a60f02379bb9/content","id":"9378a403-acd8-4b58-b616-9f6f3f5d64e9"},{"t":"The impact of peer personality on academic achievement","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/58da78ef-d756-4837-bf39-f673279dfdb6/content","id":"a6111e5a-3e7b-4bce-b184-3b79786d930d"}]},"ewerhart_christian":{"name":"Christian Ewerhart","field":"Game Theory","chair":"Contract Theory","zora_total":97,"pdfs":15,"papers":[{"t":"Mediated subgame perfect equilibrium","y":"2026","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b7536077-3b16-4c1b-9da0-027c032f35d0/content","id":"5b7d9282-dc24-4b69-a674-34edde181daa"},{"t":"Solving the n-player Tullock contest","y":"2026","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e9756970-d1b7-4523-98a3-b7deca411bcf/content","id":"3d671fba-10fb-4f5b-8885-a5513dbcab8d"},{"t":"On asymmetric equilibria in rent-seeking contests with strictly increasing returns","y":"2025","j":"Crossref:10.1007/s40505-025-00301-4","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/3cbee7a1-d601-4695-9c0d-d98390270b58/content","id":"5b5e5e30-cb75-466c-ae39-4d74c4e9dda6"},{"t":"A variant of Alaoglu's theorem for semicontinuous functions","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/68593371-4731-4b34-a391-676722de4a5b/content","id":"c55cf773-4717-401e-8868-9f3cfa673d29"},{"t":"A simple proof of the continuity of expected payoffs","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c54b98da-272e-4e01-9ea0-318e96303a30/content","id":"5a256370-ae1c-43bd-b3c6-c022d7c93b8c"},{"t":"Games with (dis-)continuous payoff functions and the problem of measurability","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/459b0386-896c-4168-ba6b-35f4a27b5ba0/content","id":"ec768883-1d46-4fcd-b4f2-9593a1909f50"},{"t":"On asymmetric equilibria in rent-seeking contests with strictly increasing returns","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8f083ef4-f3eb-48f0-a953-65d58c764729/content","id":"2b2a14e7-b52a-4320-a1e3-bcef779b866f"},{"t":"Finite approximations of the Sion-Wolfe game","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2d3eb33b-c2de-439a-aa0b-05d5920d0dfb/content","id":"f19608f4-85b7-4021-8c17-eb9616eccee8"},{"t":"T1 vs. T2: on the definition of mixed strategies in noncooperative games","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/fb2dc8e3-909e-4ecd-9296-a27c97039556/content","id":"4c20e254-c0ce-48bf-87bb-b7443cd62cd6"},{"t":"On the (im-)possibility of representing probability distributions as a difference of i.i.d. noise terms","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/7b4686d9-047a-4180-9c31-6c1a708d5767/content","id":"d30e437c-e465-465f-a357-9aad4fac865a"},{"t":"On the uniqueness of the mixed equilibrium in the Tullock contest","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/86790b29-008f-4965-a6af-6522d515a4f9/content","id":"dcc6dbae-417e-4f02-b75f-4bef29b4ba5e"},{"t":"On the uniqueness of the mixed equilibrium in the Tullock contest","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/83feebc8-3c90-4db0-a801-4e332f228bde/content","id":"6a2726aa-7a56-440e-a9ff-0bb1a8d837f4"},{"t":"Voluntary disclosure in asymmetric contests","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/11b52622-f438-47b4-af79-370a92f214ff/content","id":"c185110b-aa1a-44ab-8476-e33479870485"},{"t":"An equilibrium analysis of the Arad-Rubinstein game","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/dacba052-f705-4e1a-b40d-3350135309b3/content","id":"e65856b4-faa9-4f96-a4e7-052bf9104c8c"},{"t":"Rules in International Tennis Tournaments: A Game Theoretic Perspective","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/a257410b-7173-4f7a-854c-026a0d36ff35/content","id":"044be9ae-0ac0-43d9-9eb6-468f7718f181"}]},"schmutzler_armin":{"name":"Armin Schmutzler","field":"Industrial Org","chair":"Micro & IO","zora_total":115,"pdfs":11,"papers":[{"t":"Essays on cooperative bargaining","y":"2025","j":"","pdf":null,"id":"5bd829cd-40cc-4d81-85e4-ac18f6bd79d2"},{"t":"Hotelling meets Shaked and Sutton: a unified linear model of product differentiation","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/79696c50-b6d9-45c9-85ed-046b5a726fc4/content","id":"1886d00e-8912-4aa7-b227-0ff37a33e715"},{"t":"Providing innovation incentives for the green transition","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/81a433e6-4396-4dd7-9efa-ee3b091e476f/content","id":"7ca51338-f5a4-4c49-b0b2-f16e3d0b3a7a"},{"t":"A theory of recommendations","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ded525cf-91b3-4d36-a04a-4fe068945ea9/content","id":"e4d5ed09-9f7c-42a2-9dde-a36851e0c155"},{"t":"Research joint ventures: the role of financial constraints","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/3da24fcc-379a-4772-b873-3feb44274cb2/content","id":"a8a45b72-9d1e-40bd-8817-ef38358ebb22"},{"t":"Killer acquisitions and beyond: policy effects on innovation strategies","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f9306716-b5ee-494e-aa41-5d1d92df859c/content","id":"c772cb44-bf19-415c-b83b-9a3e89caf0f8"},{"t":"The Benefits of Procurement Auctions: Competitive Pressure vs Selection of Efficient Suppliers","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5713d689-22c0-4cb6-975d-fce1e3ff9774/content","id":"61ce575f-b6b0-45d6-bff2-606bfde66e48"},{"t":"Research joint ventures: the role of financial constraints","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/7f9318e5-e3fb-47e7-898e-123a7837ddf7/content","id":"a4dffdb2-ec9e-4515-b036-3ca863e64a85"},{"t":"Killer acquisitions and beyond: policy effects on innovation strategies","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/d7909a7b-25fa-4c42-9951-c2670f0fe2a7/content","id":"ee226936-0764-4680-ba96-9d30548428be"},{"t":"Essays on empirical industrial organization and the economics of information","y":"2023","j":"","pdf":null,"id":"b79c9da7-166f-4155-8f93-b9da5caa8dc3"},{"t":"Essays in industrial organization and competition policy","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/7ae96c2e-845f-431f-a210-fa7b805a6c68/content","id":"b2aa7f3d-fe68-4840-9756-0b7102f2701d"},{"t":"Essays on industrial organization and competition policy","y":"2023","j":"","pdf":null,"id":"878535bc-563d-4f58-9360-9c47cc000214"},{"t":"Challenging the incumbent: entry in markets with captive consumers and taste heterogeneity","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b9805f34-1691-469c-9234-42a91836dfb3/content","id":"0fd3ac11-1ff0-43e6-8bac-b1dd4f61ef45"},{"t":"Preferences, confusion and competition","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/dbb569e4-d8e3-4d9c-aa97-5331511b8939/content","id":"57beb8f5-f4f1-41ea-a933-85965284e2a2"},{"t":"Essays on dynamic games","y":"2022","j":"","pdf":null,"id":"b482dce1-b0e3-427d-a63f-d8499c98a079"}]},"dorn_david":{"name":"David Dorn","field":"Labor","chair":"Globalization","zora_total":78,"pdfs":12,"papers":[{"t":"Building bridges to the future: a tribute to Kaspar Villiger's legacy","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6e590abf-a9ba-4166-84c1-958a897fd346/content","id":"a2207eb1-2098-4ab9-a2e1-081652fd4fc7"},{"t":"Places versus people: the ins and outs of labor market adjustment to globalization","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/12e052da-a210-481c-86a0-9911a5c1ad2b/content","id":"a6b7db09-1c9e-4ca9-92e8-51dd681bbf43"},{"t":"Trading places: mobility responses of native- and foreign-born adults to the China trade shock","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/705f38c8-999a-405d-8fdc-a6c8ea28a94b/content","id":"051532ce-2f36-4f8a-80cd-a34d337b1144"},{"t":"'Herr Pr\u00e4sident, verzichten Sie auf die Z\u00f6lle, die Sie angek\u00fcndigt haben'","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f415ac39-250c-44d9-bf90-26d0da7e6654/content","id":"419ae8ec-3e07-465c-bed1-4cacccf33d4a"},{"t":"Places versus people: the ins and outs of labor market adjustment to globalization","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5efec1b0-ed1e-4c10-90d8-bdb169544106/content","id":"bce329be-c278-4bc4-b93f-31019f5ccf48"},{"t":"Labour market impacts of the China shock: why the tide of Globalisation did not lift all boats","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/58bc31a5-5775-43bb-8f19-edf2ae2199ae/content","id":"fd21cf8d-c6c8-4816-98a0-1abe74e42fbc"},{"t":"Soft skills, AI and jobs","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b361786e-6dae-46a0-92a3-ddf533a65ccb/content","id":"856cae54-d83a-42a3-9f72-45349fc8fe9f"},{"t":"Labour market impacts of the China shock: why the tide of globalisation did not lift all boats","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/56c93261-e301-4298-9133-82e86a4f14ae/content","id":"0a8b2a6a-af71-4496-8ec3-3d6fcefd656b"},{"t":"Trade and inequality in Europe and the US","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5e7d1d77-2904-4420-8fc9-687c7d486c9b/content","id":"2cb62820-8b21-41cc-b49b-28e18a795f7d"},{"t":"Die US-Z\u00f6lle gegen China bringen wirtschaftlich nichts","y":"2024","j":"","pdf":null,"id":"b5546a21-3ce8-48cf-9f7c-29eca9328f45"},{"t":"\u00abDer Handelskrieg war ein politischer Erfolg\u00bb","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8d187dd3-2e9d-499e-ab64-c5a05f3e773e/content","id":"55ddf75f-7861-41c0-a1fb-246b8e166797"},{"t":"Empirical essays in labor economics and macroeconomics","y":"2024","j":"","pdf":null,"id":"332087a8-c110-4766-80fe-1b4938fcb0e8"},{"t":"Essays on inequality, trade, finance and climate change","y":"2024","j":"","pdf":null,"id":"5da4cc05-a307-4789-8c4d-1719c062280d"},{"t":"Help for the heartland? The employment and electoral effects of the Trump tariffs in the United States","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b812c0c5-927a-431e-8a1c-a2ad60276561/content","id":"a50515f2-cee4-402d-af02-c4ea794f9f2f"},{"t":"Wegen der 10-Millionen-Schweiz die Wirtschaft zu schw\u00e4chen, w\u00e4re absurd","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/d7622733-7551-4f3c-a963-430a1329a13f/content","id":"6cbb5695-42d9-419f-aab0-dafa0c017b85"}]},"crawford_gregory":{"name":"Gregory Crawford","field":"Applied Micro","chair":"Applied Micro","zora_total":46,"pdfs":11,"papers":[{"t":"Finding and developing the 21st century scientific pioneer","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b08dbea3-84ed-4fb1-a2a3-030bd5912a52/content","id":"84325714-94e3-43b6-add1-d00b99ec4af6"},{"t":"Essays on empirical industrial organization and the economics of information","y":"2023","j":"","pdf":null,"id":"b79c9da7-166f-4155-8f93-b9da5caa8dc3"},{"t":"Essays in industrial organization and competition policy","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/7ae96c2e-845f-431f-a210-fa7b805a6c68/content","id":"b2aa7f3d-fe68-4840-9756-0b7102f2701d"},{"t":"More competitive search through regulation","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/30104240-b2d2-4661-9857-5f0ef5ffe9bd/content","id":"4e4e74ca-c2bc-424b-9b6d-4fa70ecdc473"},{"t":"Essays on macroeconomics and market power","y":"2023","j":"","pdf":null,"id":"39536442-a025-4832-a891-28628c7f86cb"},{"t":"Consumer protection for online markets and large digital platforms","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/fc58e729-8d8e-4a10-b2bd-17593642da4a/content","id":"779a4b29-622e-482c-8775-aa00db338f39"},{"t":"Fairness and contestability in the digital markets act","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/10e6be32-ea53-4ff6-9797-4db18dd1c7cd/content","id":"c3057832-6eff-488b-b82f-d413214c2c9d"},{"t":"Essays on industrial organization and competition policy","y":"2023","j":"","pdf":null,"id":"878535bc-563d-4f58-9360-9c47cc000214"},{"t":"Equitable interoperability: the 'supertool' of digital platform governance","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/384b93f9-f508-4f89-9f07-f0b1f22e9ad3/content","id":"d83305e2-a4ca-4244-b577-d5b7d9a94d77"},{"t":"Amazon entry on Amazon Marketplace","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/36e8a128-a319-46dc-bec3-4d55de2e525a/content","id":"175abdf2-15a9-41ed-8e5d-f75bdcde612b"},{"t":"Essays on the Political Economy of the Mass Media","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/46b9c9ba-90ec-43b2-a65a-9fe84268e221/content","id":"d33f9658-b895-474a-b85f-bb7146cf0eaf"},{"t":"More competitive search through regulation","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5b6eaf28-2118-471e-a773-ac479caff169/content","id":"2d846ca3-379b-414f-a714-b7df4f9e7cab"},{"t":"A survey of preference estimation with unobserved choice set heterogeneity","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e335bda3-dde8-4e29-9a8a-593087513157/content","id":"a20d044d-8a53-41e2-b4fc-473f05ee4755"},{"t":"Consumer protection for online markets and large digital platforms","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/a42ccfa4-5e0b-44e8-9043-967cd862c98d/content","id":"beae497b-959a-4efe-b1d1-e2b8458fa51e"},{"t":"The antitrust orthodoxy is blind to real data harms","y":"2021","j":"","pdf":null,"id":"c5d30053-2d9e-4de6-a19a-035a0e2b1f75"}]},"ossa_ralph":{"name":"Ralph Ossa","field":"International Trade","chair":"WTO Chief Economist","zora_total":40,"pdfs":10,"papers":[{"t":"Trade, innovation and optimal patent protection","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/0f84fe17-fa6d-49bf-99e0-27f60208ef08/content","id":"532b7600-8ae4-46c1-a064-6278048e8259"},{"t":"Building bridges to the future: a tribute to Kaspar Villiger's legacy","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6e590abf-a9ba-4166-84c1-958a897fd346/content","id":"a2207eb1-2098-4ab9-a2e1-081652fd4fc7"},{"t":"Standing in international investment and trade disputes","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/49d1ba7f-b20e-44a0-825d-f3f46c25d6ca/content","id":"b802ee8b-f9d5-472e-b60e-4f78447dbdf4"},{"t":"Essays on international trade and economic growth","y":"2023","j":"","pdf":null,"id":"bdb69c7f-dff9-4cbd-9ff5-520abbb1bc1a"},{"t":"Die Globalisierung ist eine Art S\u00fcndenbock","y":"2023","j":"","pdf":null,"id":"efe5b12e-ee4d-4441-a829-a599d122bf6d"},{"t":"A quantitative analysis of subsidy competition in the U.S.","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/730ef31b-4c59-4497-ba6d-92eb4cf76f34/content","id":"c1ef1f23-f5d8-474b-874c-36c6c34136de"},{"t":"The political economy of international regulatory cooperation","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/88296b80-7678-4d8b-8046-a30fffb7ec87/content","id":"034eb97e-17cb-49e8-be63-809187588c91"},{"t":"Gains from trade liberalization with flexible extensive margin adjustment","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f5d6e241-1aa9-4106-946d-bd74a4b67509/content","id":"a5f1c856-1e71-45dd-acce-6dc0653c7295"},{"t":"Essays in housing, labor and international economics","y":"2023","j":"","pdf":null,"id":"51fc0da9-da7a-4913-a5e0-022dd9aeead5"},{"t":"Essays on infrastructure, accessibility, and spatial patterns","y":"2022","j":"","pdf":null,"id":"994ee346-99c1-41b2-aabb-7ae28f614148"},{"t":"Gains from trade liberalization with flexible extensive margin adjustment","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b188d547-94c9-4beb-bd29-d457ba5b85af/content","id":"102ba74b-70f7-4c88-8a36-de2ac7dddd4c"},{"t":"The political economy of deep integration","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/36ab648d-c377-4ac7-842a-0c6eef15197c/content","id":"4c30e6e9-3885-4465-9c7a-4abda682f684"},{"t":"Crumbling economy, booming trade: the surprising resilience of world trade in 2020","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/af87a5b5-2b17-47eb-b9cd-9b2951619c3e/content","id":"640dfe49-8df0-4204-a0e9-8941a311d27c"},{"t":"Buy green not local: how international trade can help save our planet","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e7136afb-2b64-4a14-b83c-dc7379859293/content","id":"7fc9af96-016d-4751-a40a-adf40352ebda"},{"t":"Essays on consumption, international trade, and the environment","y":"2021","j":"","pdf":null,"id":"eeb38f41-998d-4ec1-b188-a22aaf4ba193"}]},"yanagizawa_david":{"name":"David Yanagizawa-Drott","field":"Development","chair":"Dev & Emerging Markets","zora_total":40,"pdfs":10,"papers":[{"t":"Essays in economic history and political economy","y":"2025","j":"","pdf":null,"id":"ca1cbd9e-64ec-4432-92fa-5f15a6a13c81"},{"t":"Building bridges to the future: a tribute to Kaspar Villiger's legacy","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6e590abf-a9ba-4166-84c1-958a897fd346/content","id":"a2207eb1-2098-4ab9-a2e1-081652fd4fc7"},{"t":"Socializing alone: how online homophily has underminded social cohesion in the US","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/4c75a403-8712-4d29-a1f4-453a92d2c886/content","id":"9797ac2b-248a-405e-aac0-98f0b1b311c3"},{"t":"Image(s)","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/43565d61-4eb9-43ad-947d-3c14c9b7427b/content","id":"e2eec9c5-b23d-4bb2-a9d9-a33be08c9e92"},{"t":"Essays on the political economy of organized labor, corruption, and political engagement","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/90b642a5-9266-43bc-9a30-6530ef0570c3/content","id":"99b4c204-46e4-49e5-a53d-948d741c6ecb"},{"t":"How are gender norms perceived?","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/92241674-85a9-4f85-96ad-9cd26267302b/content","id":"25be1e3b-56f1-4077-99f5-75d405b77a04"},{"t":"Opinions as facts","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5880da9b-352d-4195-ac80-2d996205f232/content","id":"dfcffa44-657c-4bc5-b49a-f1599c1f1d28"},{"t":"Essays on environmental and agricultural economics","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5fb7f1bf-3a18-42f4-accd-97321f566847/content","id":"4a5949ed-8107-41bd-b1f2-6db95cef3bf1"},{"t":"How are gender norms perceived?","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ec2b6c8e-eecf-47e6-8dce-10ccab50fd37/content","id":"4d8e8dec-240f-4e5a-88cc-e32c0130978e"},{"t":"Essays in development economics","y":"2023","j":"","pdf":null,"id":"1e6b1c95-09c5-4951-9ea0-889ad639c996"},{"t":"Essays in experimental economics","y":"2023","j":"","pdf":null,"id":"4b0548a5-fdeb-470f-a799-e3792b9943bb"},{"t":"Can good products drive out bad? A randomized intervention in the antimalarial medicine market in Uganda","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/bab7ece9-0fd0-4e9a-99ec-f64fe52cce59/content","id":"99533206-9023-4ac1-bc7a-24dedeb1b7da"},{"t":"Essays in applied microeconomics","y":"2022","j":"","pdf":null,"id":"c6282537-6f71-4e82-a9dd-55b6f70088ca"},{"t":"Essays in applied microeconomics","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1856dcad-b7be-4190-944a-d511fd16617e/content","id":"02c5e735-f117-41b0-87f9-e9c2f74b5f47"},{"t":"Essays in applied microeconomics","y":"2022","j":"","pdf":null,"id":"e1a5969f-2e01-4703-8d30-b58177fdef7e"}]},"kuebler_felix":{"name":"Felix K\u00fcbler","field":"Financial Econ","chair":"Financial Economics","zora_total":100,"pdfs":15,"papers":[{"t":"Self-justified equilibria: Existence and Computation","y":"2025","j":"Crossref:10.1093/jeea/jvaf062","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/47043ea2-936f-475f-bb58-b5a2df9462b2/content","id":"42467023-0a16-4d27-9447-10fa63092c0c"},{"t":"Building Interpretable Climate Emulators for Economics","y":"2025","j":"Crossref:10.1093/ej/ueaf131","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/15a102ab-a5a0-4e1a-a238-13e9c8be0113/content","id":"6dd18b37-ee75-49a4-b0f6-3ea0fc3dbaba"},{"t":"Incomplete financial markets, the social cost of carbon and constrained efficient carbon pricing","y":"2025","j":"Crossref:10.1016/j.jet.2025.106105","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8d28fb2b-f6d6-48bd-a0d0-d123d5a3e234/content","id":"612ed934-9e85-4ddf-a08f-5f2301c073e1"},{"t":"A Lagrangian Approach to Optimal Lotteries in Non-Convex Economies","y":"2025","j":"Crossref:10.2139/ssrn.5233164","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/72fe2f95-6bff-45b8-b653-bf40aaeecca4/content","id":"e4e986c6-1e56-45c2-a4f3-d1b6c57cf103"},{"t":"The Climate in Climate Economics","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/04561df4-dcc1-4f79-9c55-e6fe68f37ada/content","id":"ab041422-b09b-43e4-930a-0afdd68d71a6"},{"t":"When Interest Rates Go Low, Should Public Debt Go High?","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ee804c0f-c41a-4b9c-8e52-459ac60ec80c/content","id":"0948b557-b8f1-4d96-b41c-f7a4918ced9f"},{"t":"Can today's and tomorrow's world uniformly gain from carbon taxation?","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5b1f8558-a139-4cf4-ab2b-5afa2c75d4d6/content","id":"1bb09f9c-70f7-4fbc-a7ba-151632c9be5e"},{"t":"Identification in general equilibrium","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1da316f0-89a5-4b3b-aa35-a2a89eb3c14f/content","id":"bfceeaee-8d0e-4105-9414-5c8b0b81eb6e"},{"t":"Essays in finance","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6f58cf92-d694-450a-8e78-dfdae61795d9/content","id":"b7dbe4f5-c32c-430d-b540-05e33babd146"},{"t":"Uniformly self-justified equilibria","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/d600fc48-2c4d-4195-9c83-b0be399022cf/content","id":"69bad4e4-7605-4a62-b7f6-02bffc5d9f71"},{"t":"Stochastic overlapping generations with non-convex budget sets","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/cba66055-dd10-4f31-ab35-cfe6ebe58557/content","id":"9c847de8-e7ed-4a55-ad88-4c4dcb9bd192"},{"t":"Uniformly self-justified equilibria","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ee16aa0e-1e3f-43f3-8fb6-e6c43cb33156/content","id":"78fdc646-5d4e-475f-b8cd-23cdde80f87c"},{"t":"The climate in climate economics","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2464c63c-805b-4926-965d-ccc8f3aebcdd/content","id":"f8150b47-c1b8-4ab8-ac39-74b1033b333c"},{"t":"When interest rates go low, should public debt go high?","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/d78e1954-5b01-4ba5-8941-7aebfe8a4e41/content","id":"86e21b7a-25ee-4153-90d1-99a35c9349e6"},{"t":"Can today's and tomorrow's world uniformly gain from carbon taxation?","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/bcd3a963-ed42-4c28-bc56-a22aaa2cffd2/content","id":"3ac9c9a5-dcff-43ed-a18e-e7b465740eb7"}]},"winkelmann_rainer":{"name":"Rainer Winkelmann","field":"Econometrics","chair":"Statistics","zora_total":138,"pdfs":13,"papers":[{"t":"Assessing the quality of public services: for-profits, chains, and concentration in the hospital market","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/9cb41aeb-2b71-456a-be8f-845e9cfb79a5/content","id":"18ec8235-3761-43fc-b508-39f1d57ac398"},{"t":"Random effects panel data models with known heteroskedasticity","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8f2c2af3-8dfe-4086-bb12-0b63e6f8839b/content","id":"a575f134-ff8a-41a3-9a05-973bc5793a27"},{"t":"Neglected heterogeneity, Simpson's paradox, and the anatomy of least squares","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/afb45604-9fed-453d-bbf6-379c3ed1858e/content","id":"2f0dc699-18c8-4394-8a2e-bfa27ab6186d"},{"t":"Misspecified exponential regressions: estimation, interpretation, and average marginal effects","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/9047b885-b22a-40fc-bd8f-c1b6e6490a88/content","id":"337ca410-7bcd-47c5-aef4-bde36ba3e294"},{"t":"Neglected heterogeneity, Simpson's paradox, and the anatomy of least squares","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/a5395a09-8f88-42a2-901d-ac337f3de14e/content","id":"cabe6acb-bfeb-4945-8f85-605df835e5fb"},{"t":"A flexible copula regression model with Bernoulli and Tweedie margins for estimating the effect of spending on mental health","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/71675ea5-f3ad-4924-b7c8-6e5213ee1569/content","id":"6ec16d93-6e70-4693-adbc-b562e2dc6fb5"},{"t":"A flexible copula regression model with Bernoulli and Tweedie margins for estimating the effect of spending on mental health","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c126a548-6f8d-43ad-8e5a-9304eb3a9904/content","id":"405a4146-a1f9-480a-b8d7-f0977db08b3a"},{"t":"Testing the binomial fixed effects logit model, with an application to female labour supply","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/eee5404e-4fe0-4d49-8c18-2b529dd0a249/content","id":"d715a311-516d-46b7-83c9-96e5a6b80db8"},{"t":"Three essays in econometrics","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/93e8aee8-8018-4be2-b21a-a0e6fd1bbdc3/content","id":"c79e2462-9c2f-4173-9e05-368fb0f93cdf"},{"t":"Essays in applied econometrics","y":"2022","j":"","pdf":null,"id":"1b165913-5466-4428-843a-e52120c15399"},{"t":"Predicting individual effects in fixed effects panel probit models","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8b16fdd4-278c-4a54-8e00-9fa0dfb216a5/content","id":"6a2d362f-4522-4a64-bd2d-a0fa3c65c6c7"},{"t":"Assessing the quality of public services: does hospital competition crowd out the for-profit quality gap?","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/03390327-1771-4a79-8b90-688d7822a458/content","id":"fa447fe3-2a4f-4a74-a617-d9c18358a092"},{"t":"feologit: a new command for fitting fixed-effects ordered logit models","y":"2020","j":"","pdf":null,"id":"3c41fa82-778c-487a-b980-b8b9e7f38fce"},{"t":"Predicting early career productivity of PhD economists: does advisor-match matter?","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/692a4e7e-e96f-4734-af29-75e6e8b09ed7/content","id":"d29c7067-ea0c-4339-8bc6-773e41cf8d3f"},{"t":"Testing the binomial fixed effects logit model; with an application to female labor supply","y":"2019","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/04e6f716-1b3a-43ab-9246-071cb2558564/content","id":"09a85ecb-a6a0-4074-bdd3-b67765b99c1a"}]},"epper_thomas":{"name":"Thomas Epper","field":"Behavioral Econ","chair":"Behavioral Theory","zora_total":33,"pdfs":14,"papers":[{"t":"How do monetary incentives affect the measurement of social preferences?","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2d2823bf-76aa-484e-9cad-b6967776e11c/content","id":"302e8251-e5fb-40e7-9ee5-fb59dace18ed"},{"t":"Inequality aversion predicts support for public and private redistribution","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c71cd854-7a41-4ce3-a3c6-35db5d1db5e3/content","id":"299e916c-996a-4049-ac56-b51d1b81d776"},{"t":"Social preferences and redistributive politics","y":"2024","j":"","pdf":null,"id":"0b2821db-c326-4139-94ac-e7fe7552be29"},{"t":"Risk in Time: The Intertwined Nature of Risk Taking and Time Discounting","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e0de0745-5419-4f6b-8a13-456831c47779/content","id":"ea5455ce-ee71-424c-ad51-d07e74366c16"},{"t":"Beliefs about inequality and the nature of support of redistribution","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/aadc94a4-aad4-4731-92bc-2360ad5feafa/content","id":"25e60992-f120-47f4-b057-d7d947a1e80a"},{"t":"Beliefs about inequality and the nature of support for redistribution","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/57599189-1618-4b70-a93d-0bf5a779cdb2/content","id":"7f44cbf5-8766-45cf-9d57-71cb46d73a60"},{"t":"Social preferences across subject pools: students vs. general population","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/a24361af-7e95-4bb4-821e-1d5cad5d3ee5/content","id":"e195df15-f85a-4c92-92c0-aead2d53413b"},{"t":"Social preferences across subject pools: students vs. general population","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e6c382d9-7e5f-4443-8b87-165aecf89392/content","id":"50e896fc-59ac-46d6-871c-62ffb657d795"},{"t":"Social preferences and redistributive politics","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/48390d68-5373-4a91-81b0-dd3bc31cd8e3/content","id":"8fcea59b-1a16-420b-a064-686b9a26f45a"},{"t":"The fundamental properties, stability and predictive power of distributional preferences","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/43a6a39f-11c6-4556-919e-6ab15aff3aed/content","id":"91a469ed-633f-4787-9bd5-374b537fa7b9"},{"t":"The fundamental properties, stability and predictive power of distributional preferences","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/827b119f-2ce3-47bb-8ee0-b9e8dbf967af/content","id":"2ef61f39-9a91-4c0b-8ef0-95d94aa4a6de"},{"t":"Social preferences and redistributive politics","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/a3cfbb78-31e4-4011-8f8e-a116e1312cc8/content","id":"2ef38bfd-0f5a-47af-a7f1-625afc18f5fd"},{"t":"Parenting values and the intergenerational transmission of time preferences","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f1226901-afb1-4996-8b58-bcc8fb8acc85/content","id":"7dbb1e5a-11bb-47c3-b5be-b76cf0d4c0dd"},{"t":"Preferences predict who commits crime among young men","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/611d72b3-d0f0-4b30-9c41-094404bdfb09/content","id":"142c6c4c-c121-4ec3-a7cb-af990fbcfa29"},{"t":"Time discounting and wealth inequality","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/0763bb29-b618-4558-ad12-785a1ceb13a7/content","id":"3cef65ba-656e-4491-b603-91d6f0209b7a"}]},"steiner_jakub":{"name":"Jakub Steiner","field":"Micro Theory","chair":"Micro Theory","zora_total":36,"pdfs":12,"papers":[{"t":"Risk perception: measurement and aggregation","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/02a29928-f737-47af-87e1-087dcf115ad4/content","id":"8ac1751b-39ad-4075-9bab-df90b225662d"},{"t":"Robust latent data representations","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1f4b528c-2a2e-41a0-b584-07d1d6d6bbaf/content","id":"08846459-8aee-47c8-aa84-9943aae39c5c"},{"t":"Growth and redistribution: the hedging perspective","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ecd71ea5-42c6-47c6-b081-f7e288231634/content","id":"087d16ca-1752-48ba-809f-dc7bbcfa850c"},{"t":"Boundedly rational demand","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e62faa2f-797e-42f2-9319-73d62bf427dd/content","id":"c0041be5-c6fa-479a-a884-a1089681d723"},{"t":"An alternative theory of stochastic choice: intrapersonal preference aggregation","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/7fc76e9c-e95a-43cb-97fe-81b1a5f68666/content","id":"95dce5fc-d87d-406e-b84b-0335d86433d1"},{"t":"Essays in behavioral economics","y":"2024","j":"","pdf":null,"id":"e1a23945-07b4-4129-bcb3-86e284544122"},{"t":"Decision theory and stochastic growth","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/63fe2da4-fb1b-4703-8299-2cfc208c144f/content","id":"a0df5724-b84d-4bd3-afdf-f5fc8d8b25cf"},{"t":"Growth and likelihood","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/91f295ee-4d89-463f-9933-1b11d991a051/content","id":"c3628d60-d17e-46ea-a7f2-9f1b1da1fe34"},{"t":"Essays on expectations and contingencies","y":"2023","j":"","pdf":null,"id":"cc3bff65-4087-486e-8c2c-c83e20864952"},{"t":"Demand in the dark","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/055db465-00ac-490e-81d7-b3d9c7203092/content","id":"b4dc95d2-a213-4f24-8b54-a8c8e95132b2"},{"t":"Endogenous risk attitudes","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/4a17bf5c-0c55-481e-a3fd-1c15ecc9323b/content","id":"7a96c94a-a769-4be2-b0c6-1e83bee0ca1e"},{"t":"Attention please!","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/cdeac32b-f3df-4b80-8e9a-e7016c8cc79b/content","id":"8cab4943-b1ac-4422-aa89-904cb0f5e897"},{"t":"Rotation as contagion mitigation","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1900633d-3ce0-4b74-a72d-36a6dff3dc2d/content","id":"ccb598dc-7258-4500-b283-d8dcac6d4c27"},{"t":"Optimal test allocation","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e4e97da8-3db7-4697-b463-b47025337a37/content","id":"dbc67415-06c2-4f52-9a1a-fdf930aabcc8"},{"t":"Essays on stochastic choice and learning","y":"2021","j":"","pdf":null,"id":"30b729d3-d147-4a22-8dd9-a8631aa70829"}]},"almas_ingvild":{"name":"Ingvild Alm\u00e5s","field":"Development","chair":"Child & Youth Dev","zora_total":32,"pdfs":13,"papers":[{"t":"Experimental evidence on attitudes toward inequality and fairness","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/241b848b-e6a7-467f-b44d-96e0d5974287/content","id":"88b2b8b6-31eb-4335-b2ff-28cddc1b6b74"},{"t":"Attitudes to inequality: preferences and beliefs","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/bbb41838-ba84-43ab-a604-ba0b9b693bdb/content","id":"600d1259-2b4c-4229-8be8-7e63a66bfc32"},{"t":"Presidential address: economics and measurement: new measures to model decision making","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/a040334a-5e6c-4c33-bd1c-7485ce47e9fc/content","id":"50f45ff1-9bda-4d1c-b785-8331403a010a"},{"t":"Reply to: Comment on 'Presidential address: economics and measurement: new measures to model decision making'","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c7824200-4719-42f7-a773-3c34caf9449f/content","id":"ca8061f3-25f6-4730-9bb6-32b3a175d96b"},{"t":"Equality of opportunity: fairness preferences and beliefs about inequality","y":"2024","j":"","pdf":null,"id":"f65d3a48-e15a-4ede-8b95-024bf53c315d"},{"t":"The macroeconomics of pandemics around the world: lives versus livelihoods revisited","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/4618db35-9665-4436-98d2-e0cf68726a8a/content","id":"ecfc7311-97c6-4939-bdc0-75ae9cd27236"},{"t":"The Economics of hypergamy","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/d1f38c95-5e86-4a76-b575-307016d12f94/content","id":"57cf6ebb-488d-4ae1-9147-cdf0042cff93"},{"t":"Household decisions and intra-household distributions","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c2e8685c-d970-4c0e-b022-8acb860ca3cc/content","id":"7c4557b1-0b68-4819-a57a-02d5ae150845"},{"t":"Understanding inequality within households","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5693cc63-b5a4-4fb0-ac63-5f255669a1ac/content","id":"33c123cb-62d1-4ea2-9484-96bd2ff50864"},{"t":"Global evidence on the selfish rich inequality hypothesis","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/9247e0f5-410d-482f-913d-c2dbe6c48658/content","id":"83968441-c9e6-42fe-b65e-b94c8af5e79a"},{"t":"Predicted COVID-19 fatality rates based on age, sex, comorbidities and health system capacity","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2ba09ecd-dcb1-4798-a22b-0b7c899f88bc/content","id":"af214df3-dd0d-435d-ae2d-40c02870fb1a"},{"t":"The effect of gender-targeted transfers: experimental evidence from India","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/caefb270-1df6-465a-8b13-4387a6e48f39/content","id":"45cfd526-10ef-4aa1-90b6-f48b59cefec8"},{"t":"Cutthroat capitalism versus cuddly socialism: are Americans more meritocratic and efficiency-seeking than Scandinavians?","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e0e8e51a-93b8-4948-97ab-483422d409dc/content","id":"834676eb-b735-42aa-8114-6886b654b315"},{"t":"Om foreldres investeringer i barns utvikling","y":"2019","j":"","pdf":null,"id":"d32d1b43-5fb2-438a-8b7f-56fc4dddf3ca"},{"t":"A behavior-based approach to the estimation of poverty in India","y":"2019","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/3355d42b-06fe-4174-a0e9-771cb0db6cd8/content","id":"b62f9a69-0dfe-4450-a470-d9426577d609"}]},"graeber_thomas":{"name":"Thomas Graeber","field":"Neuroeconomics","chair":"Cognitive Neuroecon","zora_total":1,"pdfs":1,"papers":[{"t":"Intracellular C4BPA Levels Regulate NF-\u03baB-Dependent Apoptosis","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2953c3a2-9387-4d3b-82b9-cfbe026ec857/content","id":"58b06975-9243-4c18-bb21-142c2df60920"}]}}},"business":{"name":"Department of Business Administration","url":"https://www.business.uzh.ch","professors":{"natter_martin":{"name":"Martin Natter","field":"Marketing","chair":"Dept Chair BWL","zora_total":61,"pdfs":9,"papers":[{"t":"Decanting value priorities: Wine choice as an identity signal","y":"2026","j":"Crossref:10.1017/jwe.2025.10095","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/20b9ab71-f236-410e-b6a0-94af97a9e8b1/content","id":"8577022b-28bb-414f-91f8-0657c2af44e9"},{"t":"The Impact of Cost Structure Appeals on Fairness Perceptions and Payments","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8b786d5c-4dc9-49b6-a1ec-2e948fca21e4/content","id":"5887b331-6c8d-4bbf-b42c-b8f1640e3df5"},{"t":"The predictive power of personal values - job satisfaction, digital markets, and consumer choices","y":"2025","j":"","pdf":null,"id":"3c0da859-22f1-4516-bb64-9fd31588d042"},{"t":"EXPRESS: How Insurance Prices Affect Consumers' Purchase Decisions: Insurance Price as a Risk Signal","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f51ecf21-ce45-452e-8612-fbb20db94db9/content","id":"3bbed607-c610-47d0-98a6-c7d20754b757"},{"t":"On the importance of congruence between personal and work values - How value incongruence affects job satisfaction: A multiple mediation model","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/da74abc4-4dc0-4d66-8359-daa550665257/content","id":"01510e41-4ea4-45fc-b51f-2c1080e2a06c"},{"t":"A field experiment to assess barriers to accurate household food waste measurements","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/7b8aa0b5-f398-47c6-bd87-be1371d7d4a5/content","id":"24e8e3b5-5878-4ead-bd90-9988e4bddb58"},{"t":"Live shopping promotions: which categories should a retailer discount to shoppers already in the store?","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/9243dfc2-33de-4fe4-b33a-611091b02ef7/content","id":"cb45494e-9bcd-4efb-b025-4cc786591de3"},{"t":"Older adults' decisions on smart home systems: Better put an age tag on it!","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/9e4c579e-56e1-4b9f-8273-ff9dabf1fb65/content","id":"c2cfd87b-c2d1-447c-aeb2-6e1b6eb54106"},{"t":"Buy Three to Waste One? How Real-World Purchase Data Predict Groups of Food Wasters","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/214317ce-956b-4293-b939-eb56eed5be4c/content","id":"abadc1a2-a9de-404f-8891-7f34fb68c13d"},{"t":"Transitioning to dynamic prices: Should pricing authority remain with the company or be delegated to the service employees instead?","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e82a7ac2-48fd-4487-bc24-bd6142cd7358/content","id":"7d18a848-48fd-4d3a-968b-3bc850a57fa2"},{"t":"Pricing and the relationship between consumer and firm","y":"2022","j":"","pdf":null,"id":"a8818ad7-1d50-4372-b409-931d54c86bc3"},{"t":"The Impact of Social Influence on Consumer Behavior","y":"2021","j":"","pdf":null,"id":"1035ed59-4862-42ca-8ec5-36afc0529287"},{"t":"Digitally enabled pricing and promotion strategies","y":"2021","j":"","pdf":null,"id":"004f8e88-805a-413b-b7c1-e867a4e0b448"},{"t":"Einfluss von sozialen Praferenzen auf die Profitabilitat einer Social Shopping Community","y":"2021","j":"","pdf":null,"id":"94bfba14-3bed-407f-ab4f-fd81e29611a2"},{"t":"Customer lifetime value: Relevance, improvement and implementation of existing models in non-contractual settings","y":"2020","j":"","pdf":null,"id":"adbd8720-3b09-458e-8154-a7e2537da3ed"}]},"franck_egon":{"name":"Egon Franck","field":"Strategy","chair":"Strategy & Business Econ","zora_total":89,"pdfs":13,"papers":[{"t":"Social, poliitical, and power perspectives on upper echelon decision making","y":"2025","j":"","pdf":null,"id":"82c842fd-14b0-4e1c-a964-cf900304ba4b"},{"t":"Expectational reference points and belief formation: Field evidence from financial analysts","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f24eadb0-f2a6-4432-b921-e76d175830bc/content","id":"b23cd310-88a8-4f4f-be69-71ec2d84e818"},{"t":"The Recent Evolution of the European Football Super League Project - is It Realistic to Introduce Self-governance at the Top Without Closing the Top?","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/654a40c4-c2c3-4a48-8022-90c06ba0c691/content","id":"b3d97f8f-af72-474c-9412-8a85d2f1bd66"},{"t":"When the league table lies: Does outcome bias lead to informationally inefficient markets?","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/3f2a91c8-f58a-46d4-b106-ad6aea4cee75/content","id":"c905c0ac-5ae9-402a-abe1-260b56ce9312"},{"t":"Does Performance Pressure Accentuate Outcome Bias? Evidence from Managerial Dismissals","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/98c2a562-8f6f-4f6c-9072-842e9a8a9151/content","id":"04d58d36-8244-44b6-bb6e-2bccf1bafc85"},{"t":"Overshadowed by Popularity: The Value of Second-Tier Stars in European Football","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/676ef2fc-7a81-421b-8ca6-de7a2d4d81d8/content","id":"985f4861-1c06-4eb5-a393-ac571aa54a9d"},{"t":"Replication: Do coaches stick with what barely worked? Evidence of outcome bias in sports","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/bc8adfcc-0b56-4892-b462-c4f244b161d7/content","id":"8b992b42-f3e5-43d9-9ad0-75d619f94a91"},{"t":"Awe in organizational behavior: why it is relevant, how it can be explored, and what it changes","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/eebde487-cc9a-4a04-9d22-8bc82ef706db/content","id":"9ca3f136-b81f-43f1-9955-d88b2a845309"},{"t":"Outcome bias in self-evaluations: Quasi-experimental field evidence from Swiss driving license exams","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/02023e6d-2e6d-42bf-8b30-d8447a68d668/content","id":"89ad7503-6c03-4478-8495-225ac9e006b2"},{"t":"Overshadowed by popularity: The value of second-tier stars in European football","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1ca43d7d-2fe3-4524-8441-f1ba51929984/content","id":"2c859e94-295d-404a-a900-fa3af4fb6ec9"},{"t":"Sonic Thunder vs Brian the Snail : Are people affected by uninformative racehorse names?","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1196aa9f-658f-400c-b021-d67df87a6c22/content","id":"11e379db-5d26-45e4-9d00-22e51a9f2d48"},{"t":"The performance effects of wise and unwise managerial dissmisals","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1c874e84-a937-47b9-a88b-e41ccdb9febb/content","id":"8acdf9b4-b8d5-4e92-8956-c954a289296f"},{"t":"Essays in sports economics and sports management","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5f66da5f-e853-40bd-aa43-ad0cd47cb457/content","id":"64685a6f-6a40-4915-8a97-6580b0865f66"},{"t":"Separating psychological momentum from strategic momentum: Evidence from men's professional tennis","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5ffa4f4f-7973-4e53-bb25-cc96e1fb139a/content","id":"f0b11d03-b5e4-4758-8330-c79f6c8986e0"},{"t":"The Effects of Interruptions on Performance and Risk-Taking","y":"2020","j":"","pdf":null,"id":"45869ef8-811e-40ca-951e-8962ebdfbca7"}]},"segal_carmit":{"name":"Carmit Segal","field":"Org Economics","chair":"Personnel Economics","zora_total":14,"pdfs":13,"papers":[{"t":"Effects of Workplace Competition on Work Time and Gender Inequality","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8498bffb-e63b-4e55-be68-ec6f306d98fb/content","id":"2efd2019-93e4-4362-a477-b614283d4e39"},{"t":"Effects of COVID-19 Shutdowns on Domestic Violence in the U.S","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/cebf827f-7ebd-4dfe-9efd-4520e4f743f5/content","id":"4634b11e-66c1-4cde-92ca-96d234da071d"},{"t":"Effects of the COVID-19 pandemic on domestic violence in Los Angeles","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/7f984375-e08d-4df4-9a97-71e18cd9f3c5/content","id":"fc357b29-1ecc-4005-a44e-d3838edfd1d8"},{"t":"Effects of COVID-19 shutdowns on domestic violence in US cities","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1d986264-2bb7-45a2-8cf1-ca0703f8cc41/content","id":"9830b848-e3c3-435a-8c21-9d1a0a76eb4b"},{"t":"Effects of COVID-19 shutdowns on domestic violence in US cities","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/9b444f03-85cc-4f96-94fa-2da545a12614/content","id":"f7628fca-d55d-4d97-a960-2f4154e9418e"},{"t":"Effects of the COVID-19 pandemic on domestic violence in Los Angeles","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8b90b82f-7f39-4078-968f-3191de50fd0a/content","id":"f5b93dad-6dc8-482e-af07-e4d31a5fc6eb"},{"t":"Do female officers improve law enforcement quality? effects on crime reporting and domestic violence","y":"2019","j":"","pdf":null,"id":"4a70d18d-7cb2-45a1-8f44-8e8694fd6111"},{"t":"Does Workplace Competition Increase Labor Supply? Evidence from a Field Experiment","y":"2019","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/43acfd1a-58ac-4efc-948f-50955cef721c/content","id":"03f69888-3933-4fac-8514-74d9e8ed6a13"},{"t":"Skills, personal characteristics, and labor market transitions","y":"2018","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b1278e17-14b2-4bea-a019-a97a6b64cfdc/content","id":"1f939899-8799-4ea7-81a1-43d8f41d7418"},{"t":"Do female officers improve law enforcement quality? Effects on crime reporting and domestic violence escalation","y":"2014","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ff00333b-c031-4e2c-91a6-f05d0a94cdd0/content","id":"f2ee0d4d-9af9-4ec0-8be5-f78641aca60c"},{"t":"How costly is diversity? Affirmative action in light of gender differences in competitiveness","y":"2013","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/27d6124c-2bbf-499a-a103-1ba42cb0507d/content","id":"7186a10b-9b60-4cb5-ab31-2493fc51b686"},{"t":"Misbehavior, education, and labor market outcomes","y":"2013","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5a51f30f-dfaf-49b4-a6d8-58246ba35d79/content","id":"4da3340e-ba4e-47d1-9fb0-2883355aa0e4"},{"t":"Does temporary affirmative action produce persistent effects? A study of black and female employment in law enforcement","y":"2012","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ea6d8a63-639b-4029-afda-4added7e382d/content","id":"bf6c46e0-09a1-4a83-9431-4bc9b846939f"},{"t":"Working when no one is watching: Motivation, test scores, and economic success","y":"2012","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c58e2d77-c761-48bb-9752-853cefdfb034/content","id":"6ed57219-81ec-453d-9e6c-e15312b5b5a0"}]},"luger_johannes":{"name":"Johannes Luger","field":"Strategy","chair":"Evidence-Based Strategy","zora_total":6,"pdfs":5,"papers":[{"t":"Corporate decline and turnarounds in times of digitalization","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e31081f2-8e84-446f-9ecc-89fddee29c73/content","id":"7dab3a8a-7f03-4eda-92dd-4d536e66f23a"},{"t":"Who depends on why: Toward an endogenous, purpose-driven mechanism in organizations' reference selection","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8bc1ddae-3ff6-4fde-992e-35f43a5f46da/content","id":"29a65007-aa8a-497e-9a96-f797b1e7d1e2"},{"t":"The Role of Organizational Structure in Senior Managers' Selective Information Processing","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/bde46126-f5be-44bb-bbcf-d72f7179cbdb/content","id":"2fd3c9f0-7271-42a6-b6f4-39aa91a3db5d"},{"t":"Artificial intelligence and the changing sources of competitive advantage","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/30c04f95-f571-4742-bfe3-3bda4a9133b2/content","id":"f3c40deb-d946-40e6-9d7d-865c5eba105b"},{"t":"Blown Away by hurricane Katrina: The Impact of Exogenous Shocks on CEO Dismissals","y":"2022","j":"","pdf":null,"id":"f5f5078b-8f50-47ea-858f-1b636cd25876"},{"t":"Strategic Decision Making in the Digital Age: Expert Sentiment and Corporate Capital Allocation","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/908b72d1-c76a-40d1-a89b-e1a0db18a377/content","id":"d077668d-165b-4f6b-9b82-05a7c131030b"}]},"brenoe_anne":{"name":"Anne Ardila Bren\u00f8e","field":"Personnel Econ","chair":"Business Economics","zora_total":22,"pdfs":15,"papers":[{"t":"Global Evidence on Children's Living Arrangements","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c1c1c412-e156-44f0-a307-00e66127f61a/content","id":"a517c890-d7e1-49e3-89db-bfb3ca95ca7e"},{"t":"How Do Firms Respond to Parental Leave Absences?","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/efab63b4-274b-4160-bfd5-8016709b507d/content","id":"39332ffa-1575-4904-87a0-65a9f1924cff"},{"t":"How do firms respond to parental leave absences?","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/80db4b0e-6f42-42f5-b216-57db835d97d3/content","id":"549a126a-2e64-4456-8baa-9189238d3bdd"},{"t":"Gender identity and economic decision making","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f23868fe-ec23-437e-b3f4-acb84d0c9590/content","id":"8bfc3796-1d3f-49be-9ebd-26e45b9f704b"},{"t":"Is parental leave costly for firms and coworkers?","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/873b02d0-40d0-423c-a81d-788d83b3d437/content","id":"a2af4bf4-e061-4836-b46d-8d860de6164d"},{"t":"(Not) thinking about the future: inattention and maternal labor supply","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/dd0cf095-b843-4f37-aacf-3e7b217ace81/content","id":"f4670493-ba3e-4f23-a0f8-d3a0ef26440a"},{"t":"Is parental leave costly for firms and coworkers?","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/3f967bb6-6896-433d-8737-db8ce07dcf9b/content","id":"0fef83d1-9aeb-4424-a414-4623664553fb"},{"t":"Brothers increase women's gender conformity","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2f55aef6-8c7d-4974-95b9-c0ae28738ad6/content","id":"25569bb8-63cf-4c6f-9596-4db3c901bfce"},{"t":"No evidence that siblings' gender affects personality across nine countries","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/175ff7fb-2f9c-49fb-998d-5d3436d205e8/content","id":"a0212f26-c320-4f52-a747-9c9ad9674023"},{"t":"Parenting values and the intergenerational transmission of time preferences","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f1226901-afb1-4996-8b58-bcc8fb8acc85/content","id":"7dbb1e5a-11bb-47c3-b5be-b76cf0d4c0dd"},{"t":"Continuous gender identity and economics","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8b0331ad-924d-4d25-9797-5a8b0adf33db/content","id":"388e363b-2ffa-43dc-9ab2-8f5b0243af85"},{"t":"No evidence that siblings' gender affects personality across nine countries","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/14bf48fe-e42c-4363-a559-039d899624b7/content","id":"9d1c639c-55b4-4860-89a0-c60cf6dd1e08"},{"t":"Continuous gender identity and economics","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/4d0aa1e6-4cf2-4106-b0c2-90c9c6cd68bb/content","id":"c71db075-6c67-4221-abd2-4a8d400b8755"},{"t":"Impact of parental leave on companies: taking time off to give birth has scant effect on small companies in Denmark","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/9caedf5d-517b-4d3d-a2c1-69d4b78c840f/content","id":"702d771b-d7ad-446b-b2ce-acfcf7071d82"},{"t":"Brothers increase women's gender conformity","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/a2e14c58-5590-43e7-b1c0-bf93c14dd9cb/content","id":"d1c756a8-b3fc-4712-b7e9-a72a42c2c6fc"}]},"zehnder_christian":{"name":"Christian Zehnder","field":"Org Economics","chair":"Organization & Mgmt","zora_total":26,"pdfs":12,"papers":[{"t":"Leveraging social comparisons: the role of peer assignment policies","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/dfac3be2-d0ff-4f52-afeb-7fb9abd1f5ac/content","id":"387435ee-a567-42af-aad6-d0067df1a830"},{"t":"'Just words? Just speeches?' On the economic value of charismatic leadership","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c18eaa92-332e-4198-9224-3cbdd4ef2863/content","id":"00858b3b-a8ce-4dea-a75e-afe685e6ae3b"},{"t":"Competitive pricing reduces wasteful counterproductive behaviors","y":"2017","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5dfc830d-4c07-495a-94c0-e3d03a6cbf14/content","id":"a843bd1a-7d65-4a5e-8568-7f89f0ab05a0"},{"t":"Does competition justify inequality?","y":"2015","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/789a6885-b3f9-4d49-9326-13cd9987bfe7/content","id":"c22f5b48-6621-41f4-882b-3ad8b163c311"},{"t":"How do informal agreements and revision shape contractual reference points?","y":"2015","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/95584e67-860c-42cd-9132-20c6628b2cc4/content","id":"b424de86-8ea0-4f8f-ab53-a181b148f07d"},{"t":"Slavic Conversions","y":"2015","j":"","pdf":null,"id":"941b7f39-4ebc-4a55-8013-50204051dfcf"},{"t":"How do judgmental overconfidence and overoptimism shape innovative activity?","y":"2014","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/a31d7585-ce77-4ba1-9963-03630e0b48e4/content","id":"ddd401ca-d00c-4cd6-8551-c1449babf639"},{"t":"How do judgmental overconfidence and overoptimism shape innovative activity?","y":"2013","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/456c0eb2-a34a-442c-a106-4a40949d64ef/content","id":"a3ae436c-3237-43fe-a1bb-9af37d3efab5"},{"t":"DAT1 polymorphism determines L-DOPA effects on learning about others' prosociality","y":"2013","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/fefcbb4c-592d-4b7a-b70a-cb0b0825f26c/content","id":"4c0f370b-8b65-43e8-a1b7-49b08563c366"},{"t":"Big experimenter is watching you! Anonymity and prosocial behavior in the laboratory","y":"2012","j":"","pdf":null,"id":"7c5e355e-43be-42e1-887b-f4834369577a"},{"t":"How do informal agreements and renegotiation shape contractual reference points?","y":"2011","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ec2f9255-b74e-4a71-bb36-22dfbee7b72a/content","id":"695899a9-0c7c-4453-843a-f8cacfe23740"},{"t":"Big experimenter is watching you! Anonymity and prosocial behavior in the laboratory","y":"2011","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/0fc67667-5cdf-4786-9090-eeb53802e3da/content","id":"0e73ec37-c263-4666-ac52-aefa337fdb38"},{"t":"Contracts as reference points-experimental evidence","y":"2011","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/65a0f522-9014-4ab9-ab85-584e4cc37f58/content","id":"d4a3b90b-cb88-4e0e-b1cc-d4c0f8390ec5"},{"t":"A behavioral account of the labor market: the role of fairness concerns","y":"2009","j":"","pdf":null,"id":"f8dfbd04-46c2-4230-af75-2cbc6212be9d"},{"t":"On reputation: a microfoundation of contract enforcement and price rigidity","y":"2009","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/574ea3e2-7d2b-45f8-bfed-3ccfc3460303/content","id":"cdf9410f-a224-44c0-b34b-994cb835fa8a"}]},"stoeckli_sabrina":{"name":"Sabrina St\u00f6ckli","field":"Consumer Behavior","chair":"Marketing","zora_total":28,"pdfs":15,"papers":[{"t":"The Effects of Forecasts on the Accuracy and Precision of Expectations","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2eb84a4f-148e-4671-884c-656c2d23adde/content","id":"e32f0e88-6e35-420e-bd7f-9d317745a41c"},{"t":"A field experiment to assess barriers to accurate household food waste measurements","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/7b8aa0b5-f398-47c6-bd87-be1371d7d4a5/content","id":"24e8e3b5-5878-4ead-bd90-9988e4bddb58"},{"t":"Social corrections act as a double-edged sword by reducing the perceived accuracy of false and real news in the UK, Germany, and Italy","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f3278505-7c4b-4619-b7e6-956e0905ac0d/content","id":"5fc7c7d2-048b-4e05-8b44-51e6f6699039"},{"t":"Exploring Attitudes Toward 'Sugar Relationships' Across 87 Countries: A Global Perspective on Exchanges of Resources for Sex and Companionship","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b352e80d-c4a5-49f9-b2e6-5734277b87a0/content","id":"ce743a8c-c1f0-44de-ad98-6a75aea5a270"},{"t":"Predictors of Compliance with COVID-19 Guidelines Across Countries: The role of social norms, moral values, trust, stress, and demographic factors","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/57c2df40-0bf1-47c0-a13d-93804bc7245c/content","id":"48bae1f3-a49c-459b-83dc-57ab8fa91c00"},{"t":"Partisanship and anti-elite worldviews as correlates of science and health beliefs in the multi-party system of Spain","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ea9ee015-d831-4c33-8f0a-80c775a41d86/content","id":"9e241b1e-df6c-40fd-ae2b-aa3a6e9773f3"},{"t":"Mediation analysis of conspiratorial thinking and anti-expert sentiments on vaccine willingness","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ddbab159-fec4-417e-9242-f6b41856403c/content","id":"de9290eb-36c8-4fa7-8f48-663dc32c4d72"},{"t":"Carbon footprint labels involving traffic lights foster sustainable food choices","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/3739f8eb-ef80-430e-9487-930aa82afc77/content","id":"eace2107-a1b3-4254-9f11-787bbf3c08d2"},{"t":"The effects of secondary stressors, social identity, and social support on perceived stress and resilience: Findings from the COVID-19 pandemic","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/14b6fc26-bcd6-45e3-81f7-a8432eef7e57/content","id":"c6883c7a-0919-4c7e-83a8-54aefaa9edbe"},{"t":"Stamping the vaccine passport? Public support for lifting COVID-19 related restrictions for vaccinated citizens in France, Germany, and Sweden","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/edd21c1c-7378-4fb0-8854-95a8858da976/content","id":"509d99cd-0b86-49c1-a219-a096d1f1cc72"},{"t":"Buy Three to Waste One? How Real-World Purchase Data Predict Groups of Food Wasters","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/214317ce-956b-4293-b939-eb56eed5be4c/content","id":"abadc1a2-a9de-404f-8891-7f34fb68c13d"},{"t":"COVIDiSTRESS diverse dataset on psychological and behavioural outcomes one year into the COVID-19 pandemic","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/587652ca-0a2e-4d21-8d48-a287313297b4/content","id":"246d106a-465f-4929-9642-1d6c644225d7"},{"t":"Which vaccine attributes foster vaccine uptake? A cross-country conjoint experiment","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f159d894-8fb5-4047-a193-3dcb486bb9c8/content","id":"445c6227-4695-4f3e-aedd-f4ef3fe88d25"},{"t":"Mediation Analysis of Conspiratorial Thinking and Anti-Expert Sentiments on Vaccine Willingness","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/0e9d861a-a585-4213-aaae-2f97b21fa108/content","id":"fbb92da8-5997-4cf6-bafe-6e8cd35c2c0f"},{"t":"Validity testing of the conspiratorial thinking and anti-expert sentiment scales during the COVID-19 pandemic across 24 languages from a large-scale global dataset","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c4098301-5a89-4b56-869c-05c91f90cd19/content","id":"3f4faae4-7906-4435-bda1-1d160b077db6"}]},"kube_sebastian":{"name":"Sebastian Kube","field":"Behavioral/Exp","chair":"Business Ethics","zora_total":7,"pdfs":6,"papers":[{"t":"Elections and deceptions: An experimental study on the behavioral effects of democracy","y":"2013","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c17cd54b-aa02-467d-b03a-7530548f5641/content","id":"5dfee5aa-f8e3-4d64-ae45-379fc373e1df"},{"t":"Elections and deceptions: An experimental study on the behavioral effects of democracy","y":"2013","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f57ba561-9cee-40c9-99ac-d6eb73d12143/content","id":"9f8edfdb-b538-427f-8665-e478883a4eaf"},{"t":"Do wage cuts damage work morale? Evidence from a natural field experiment","y":"2013","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/91feaff6-54bf-4a88-92a5-963a0f0e1fb2/content","id":"04ab47e1-b1e6-4811-8667-41d0f172c088"},{"t":"The currency of reciprocity: gift exchange in the workplace","y":"2012","j":"","pdf":null,"id":"5242dac6-2f3e-479d-9bb2-5f80d339f263"},{"t":"Do Wage Cuts Damage Work Morale? Evidence from a Natural Field Experiment","y":"2011","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/9c09c640-33e9-446e-9381-404752b38ef8/content","id":"8ec79bd4-db3a-4045-9c5c-287fae4bf9fd"},{"t":"The Currency of Reciprocity - Gift-Exchange in the Workplace","y":"2011","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/82a1b4d9-128c-4ab7-99bc-ee7b41c51746/content","id":"3192b41d-5a8b-4f48-9d77-bb426890f8b2"},{"t":"Two are better than one!: individuals' contributions to 'unpacked' public goods","y":"2009","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b6a54ee4-94eb-41c0-b6e7-dbaee5cdfc08/content","id":"ee19e2ec-e6be-44e7-8573-d9a0c1e7b65e"}]}}},"finance":{"name":"Department of Finance","url":"https://www.financeuzh.ch","professors":{"hens_thorsten":{"name":"Thorsten Hens","field":"Behavioral Finance","chair":"Financial Economics","zora_total":237,"pdfs":11,"papers":[{"t":"Die Aktienkurse k\u00f6nnen sich nochmals verdoppeln: Interview mit Thorsten Hens","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f6d9f383-c909-45e2-9ef3-33e1b7646210/content","id":"d39ab71a-4eef-4213-8142-f65c3acc771a"},{"t":"How good are LLMs in risk profiling?","y":"2025","j":"Crossref:10.1016/j.frl.2025.108102","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2b4fe55c-ac16-4b39-a2ca-2e64ff818b40/content","id":"cf16de9a-2e2b-4f09-bd49-a8c3bd75efc0"},{"t":"Sustainable finance and environmental outcomes: a three-part analysis of investment, welfare, and innovation","y":"2025","j":"","pdf":null,"id":"5bae6c5f-5474-4796-a852-5e3092d4240c"},{"t":"Sustainabiltiy integration and trading behavior in financial markets","y":"2024","j":"","pdf":null,"id":"06939e8f-5ca9-448d-aec8-8719f0e30e97"},{"t":"Loss Aversion in the Context of Sustainability","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1723fd0f-b515-48bd-8ea4-91455fe5c84a/content","id":"582c89cb-9a3f-4e49-a43f-8f56f6e2e590"},{"t":"Modelling sustainable investing in the CAPM","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b227420f-7834-4685-9f74-e8189afc0dab/content","id":"32f089fa-8fdc-45bf-bd78-16efa52819ef"},{"t":"Essays in decentralized finance","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/67caeb9f-893a-4d3b-9d1a-38c75dc62d38/content","id":"b1bff836-6852-457d-93e6-496807db37fa"},{"t":"'Das s\u00fcsse Gift der Gewinne vergiftet mich': Interview mit Thorsten Hens: Der Professor am Institut f\u00fcr Banking und Finance erwartet f\u00fcr das kommende Jahr weniger Aktienperformance als in 2023","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/15106b33-ff47-4794-b30a-001ace361d8b/content","id":"0fc055b1-4bc4-40e1-9434-337b499015bd"},{"t":"Three Essays in Small Business and Consumer Finance","y":"2023","j":"","pdf":null,"id":"b6e2c512-f8d1-4160-ac67-91aef94dd695"},{"t":"Strategic complementarity and substitutability of investment strategies","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/039dbc45-1685-4fb5-a1d3-3a2bdebaa483/content","id":"919a459a-559b-4ab4-a998-c0a0018f16ed"},{"t":"Experimental research on retirement decision-making: evidence from replications","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/169c2c34-605a-4ff6-9933-ea6ad717b6c7/content","id":"d4db901d-a3aa-4f93-b045-5cd852e0ae65"},{"t":"Evolutionary Finance: A model with endogenous asset payoffs","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c0f9af3e-6b24-4a80-be34-642df8a12427/content","id":"647fb251-2c72-4d7f-b9d3-94a97fe8081d"},{"t":"\u00d6konomische Grundlagen der Finanzwirtschaft : Von der Main Street zur Wall Street","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/97d66a3e-c4a3-440a-8805-170c25188674/content","id":"a6055bb0-1b80-4513-bbf9-799b09e8f541"},{"t":"Personality Traits and Investment Styles","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/470a806a-6b27-447f-af02-8dfbbbc021e3/content","id":"3c1b5966-1071-4a0a-9564-153fa9ef724a"},{"t":"Corporate Communication and News Media in the Financial Market","y":"2023","j":"","pdf":null,"id":"48eb0b28-5320-4a85-847f-0a91421bbb6e"}]},"leippold_markus":{"name":"Markus Leippold","field":"Financial Engineering","chair":"Financial Engineering","zora_total":154,"pdfs":14,"papers":[{"t":"ReportGRI: Automating GRI Alignment and Report Assessment","y":"2025","j":"Crossref:10.1145/3746252.3761469","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f6e62dd5-4682-4e1f-80ff-6cb30ec05965/content","id":"6cae31c1-d960-4500-9def-a65e14065e7c"},{"t":"Automated Evidence Extraction and Scoring for Corporate Climate Policy Engagement: A Multilingual RAG Approach","y":"2025","j":"Crossref:10.18653/v1/2025.emnlp-demos.9","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ff71edb7-4652-41b9-9b90-efb47211a450/content","id":"b5273744-2eae-40b8-be59-1ff04512ccda"},{"t":"Co-DETECT: Collaborative Discovery of Edge Cases in Text Classification","y":"2025","j":"Crossref:10.18653/v1/2025.emnlp-demos.25","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ec7d2fd6-6f16-405d-ab11-d52844da06cc/content","id":"1098ed1d-ef0b-4ada-8303-b34d608ec018"},{"t":"Using AI to assess the decision-usefulness of corporates' nature-related disclosures","y":"2025","j":"Crossref:10.1088/2515-7620/ae1357","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/95c6de7e-efe5-47ef-9d7f-e256f92df61a/content","id":"32b685af-08a4-4294-8b1d-aa247213bf2f"},{"t":"Firm-Level Green Innovation Beyond Patents","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ea297ffd-cbe8-487e-ae85-a4a9f2bfb3a4/content","id":"e95907b4-b32e-4fb6-8038-129855f38424"},{"t":"Improved inference and forecasting in economics and finance","y":"2025","j":"","pdf":null,"id":"2bb81b83-a40e-4102-9d3d-1cdcea582059"},{"t":"DIRAS: Efficient LLM Annotation of Document Relevance for Retrieval Augmented Generation","y":"2025","j":"Crossref:10.18653/v1/2025.naacl-long.271","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/84ea897d-3bb4-49bc-9988-39bb0017cdaa/content","id":"0d825a69-359e-48d7-ae7f-15b48aeda2f5"},{"t":"Automated fact-checking of climate claims with large language models","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5455b2e5-bc51-423b-a3b0-406550a9e715/content","id":"b9be4b4f-b90e-42f9-959c-8b35c4df7106"},{"t":"Using AI to assess corporate climate transition disclosures","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8a163a23-02c0-4ab1-80d0-64dc03826929/content","id":"81a2a21e-0f10-4b67-93b1-10b593793a82"},{"t":"Technical patterns and news sentiment in stock markets","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8f5fd7af-9edf-43b4-89c6-72ebd6412eca/content","id":"5f56a314-293f-4f1f-a320-6583b135e051"},{"t":"The Role of AI in Transforming Financial Practices","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/dce1695e-bd56-45a3-a079-634510d176d3/content","id":"6a2b1656-e473-49a5-a671-5266abb9f68b"},{"t":"Towards Faithful and Robust LLM Specialists for Evidence-Based Question-Answering","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/cc467682-2d25-4083-b933-75b4cccef9dc/content","id":"7d5b339d-ecda-4411-8af7-e03375d6c286"},{"t":"Integrating artificial intelligence with expert knowledge in global environmental assessments: opportunities, challenges and the way ahead","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/39801f2a-6f0a-4a21-8586-f6de95833e09/content","id":"b1ab3437-b1aa-4345-a137-f860e2ed12c3"},{"t":"Assessing Large Language Models on climate information","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/fa51d3f9-09e0-4d88-8760-f180311e2278/content","id":"eb5e17bb-eb60-4177-90cc-a62ebda53375"},{"t":"An Adversarial Attack Approach on Financial LLMs Driven by Embedding-Similarity Optimization","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1c3df7bf-a52c-4ca1-af06-2dd3a160a8d1/content","id":"577c71e0-bb35-46c9-b8d5-3b7989b68adf"}]},"wagner_alexander":{"name":"Alexander Wagner","field":"Behavioral Finance","chair":"Corporate Finance","zora_total":149,"pdfs":13,"papers":[{"t":"Conflicts of Interest and Market Failures in Unregulated Capital Markets: Evidence from ICO Analysts","y":"2026","j":"Crossref:10.1007/978-981-95-2844-8_9","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/956c8d31-922a-4c54-a176-be33d2c66990/content","id":"4c78e60d-7e61-4eac-882d-357d438558f5"},{"t":"Corporate nature risk perceptions","y":"2026","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1402ca87-b79a-4605-ac7b-53fe48091902/content","id":"da13526f-9d17-481f-93a8-2467ece08606"},{"t":"Firm-level nature dependence","y":"2026","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/cc0e8c04-3441-4788-b416-e98f5d799e01/content","id":"283950d5-6fb8-4770-bbb4-13c7ea7c49cb"},{"t":"The Intangibles Song in Takeover Announcements: Good Tempo, Hollow Tune","y":"2025","j":"Crossref:10.1093/rfs/hhaf116","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/ddcd4297-e2f7-48f9-9e60-16e6d1931e56/content","id":"22b297b2-141c-4d0f-9ab3-3ec2184a983e"},{"t":"Organizational Ethics in Action: The Use of Contemplation Questions as Decision Aids in Large Companies","y":"2025","j":"Crossref:10.2139/ssrn.5680982","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2c10f8da-9e8e-4ba5-90c9-71b5dcdb670d/content","id":"f4ae41df-b037-4158-8818-67f99270a213"},{"t":"Do Institutional Investors Stabilize Equity Markets in Crisis Periods? Evidence from COVID-19","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/17ce8d9f-c0f3-4703-8d44-7c61551f6c88/content","id":"4ff5ad08-2f7d-45b5-8672-479f93d88eae"},{"t":"The Unintended Effects of Ethical Decision Aids in Organizations","y":"2025","j":"Crossref:10.2139/ssrn.5136031","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f1262df2-f75b-4f28-8f24-71dcf20424e7/content","id":"b1966cc5-a3c5-4b8d-8166-5848cd502fa8"},{"t":"Three essays on banking, climate risks, and corporate sustainability","y":"2025","j":"","pdf":null,"id":"13a18589-bec9-4adc-9a21-89773cd133d2"},{"t":"Binding Say-on-Pay and Shareholder Value","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/f9311a6c-2aea-4ea8-b2c9-f90a7cfe1649/content","id":"eed82069-87c6-485b-88d6-279b5bbc406f"},{"t":"Die Rolle der K\u00fcnstlichen Intelligenz (KI) in der Unternehmensberichterstattung: Chancen, Risiken und Implikationen f\u00fcr die Zukunft des Accounting","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/4bd4c2d0-b4db-4b54-9189-bec48d668651/content","id":"718c3620-0283-42b0-947f-7f4531332bf0"},{"t":"Earnings Management and the Role of Moral Values in Investing","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/fb8d89aa-d8c3-4635-b24d-bc90ee8cd787/content","id":"0a0e372e-f6db-46b4-ae37-35158948334b"},{"t":"CEOs Showing Humanity: Human Care Statements in Conference Calls and Stock Market Performance during Crisis","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8583a1a7-3434-4255-b5c1-8a1dfa594002/content","id":"2f8052a6-906f-47d0-a2d4-d3fd5bd35062"},{"t":"Sustainabiltiy integration and trading behavior in financial markets","y":"2024","j":"","pdf":null,"id":"06939e8f-5ca9-448d-aec8-8719f0e30e97"},{"t":"Do investors care about biodiversity?","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6143dd26-2f03-41d6-9c08-18e67ae4586d/content","id":"233bdae5-771b-467d-a316-59f668d9e470"},{"t":"Biodiversit\u00e4t und Finanzm\u00e4rkte","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/fda71088-1568-4a92-b614-c54312c538b8/content","id":"4072157d-cda6-4a16-8605-20bbfce05e23"}]},"habib_michel":{"name":"Michel Habib","field":"Corporate Finance","chair":"Corporate Finance","zora_total":49,"pdfs":7,"papers":[{"t":"Navigating the World of Sovereign Debt","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/a94dd606-5503-4740-9d70-6e4525a6b21d/content","id":"e26d3867-b4cf-48d6-8afd-0c1195b5e9ad"},{"t":"The Implementation of Central Bank Policy in China: The Roles of Commercial Bank Ownership and CEO Faction Membership","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/3ef401d5-c541-4efe-bc50-0214cf52ae72/content","id":"34292844-c179-4398-8955-52202bf92401"},{"t":"Assessing Debt Sustainability in the Euro Area","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/864bf2e4-f946-4e9d-aee6-4304d3fe0e00/content","id":"fc250b31-0e46-4262-ad89-71b01789894b"},{"t":"Three Essays in Finance","y":"2023","j":"","pdf":null,"id":"6c013d5a-2bdf-432b-ba76-a0f69577ded3"},{"t":"Debt Sustainability with Involuntary Default","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e8be4c1f-151e-4792-8cd9-765f5580cdba/content","id":"ba2f5eb5-d27c-4904-bb7d-25ad95d5d7d1"},{"t":"Equilibrium Investor Protection: Active Mutual Fund Fees","y":"2022","j":"","pdf":null,"id":"bb2bf099-f240-4908-897b-d71915eebc69"},{"t":"Essays on Unconventional Central Bank Policies","y":"2022","j":"","pdf":null,"id":"dc067ad1-90fa-49be-90e4-db1644fbbf56"},{"t":"Managerial Discretion and Shareholder Capital at Risk","y":"2021","j":"","pdf":null,"id":"1e0d7084-b594-49be-83fb-f149099bdf33"},{"t":"Applications of New Empirical IO in Banking and Real Estate Economics","y":"2021","j":"","pdf":null,"id":"b9c55c14-0347-4aa5-86be-0a0bf7d506de"},{"t":"Cost of capital and valuation in the public and private sectors: tax, risk, and debt capacity","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/3107f587-72f7-43e6-8323-d309e07d06f0/content","id":"3fb00421-2da5-41d8-aa47-d1837f0c7b40"},{"t":"Three Essays on Bank Lending","y":"2019","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5320d3a3-536c-4112-b942-47c934937ff1/content","id":"9a504c5e-c42d-4481-a6ae-3c6c841eca74"},{"t":"Essays on valuation, investments, and asset pricing","y":"2019","j":"","pdf":null,"id":"102cae55-26c3-4f6a-a785-681b3b70e5b3"},{"t":"Multifaceted Transactions and Organizational Ownership","y":"2018","j":"","pdf":null,"id":"6334de87-85d6-4c33-98c2-cada51c3c604"},{"t":"Three essays on empirical banking","y":"2017","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c358a9a5-2b0d-43ba-b99e-5a8f7725111a/content","id":"6a074dfb-1bb8-4098-9e57-59ef56e36f53"},{"t":"Three Essays on Managerial Compensation","y":"2017","j":"","pdf":null,"id":"1a2f1319-f880-414c-81e5-1a426cd72444"}]},"dietl_helmut":{"name":"Helmut Dietl","field":"Sport Economics","chair":"Services & Operations","zora_total":240,"pdfs":15,"papers":[{"t":"Migration and Sources of Discrimination in a Social Context: Experimental Evidence from 15 Latin American Countries","y":"2026","j":"Crossref:10.1016/j.jdeveco.2025.103633","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b51d3897-7201-44a7-9cc6-61ef97db0b15/content","id":"0d333d1f-dfdb-42cc-8915-985bbbf7b371"},{"t":"New brooms sweep clean, old brooms know the corners: the effects of managerial replacement on employee performance","y":"2025","j":"Crossref:10.1080/09585192.2025.2591762","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/cbcc1bfa-965c-45cc-a60a-198c87fc9fd3/content","id":"82225afd-7d14-4f36-a9fc-e9f261eecf66"},{"t":"Arbeitsmarkt Profifussball: Dynamisch, mobil und transparent","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/53b2cfa2-abc7-4736-bf74-c298eed93534/content","id":"6badd391-c936-41f3-a898-6c9776b22906"},{"t":"Performance under pressure and its impact on compensation: Evidence from professional basketball","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/cfc28b98-17a0-4149-8c27-3b7e2b7d196a/content","id":"ebfb812e-5c53-403a-9da5-afb865ad969a"},{"t":"The superstar effect on perceived performance in professional football: An online experiment","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1dd46d89-4c21-4cdf-832d-3c284efeec65/content","id":"1e007089-5dd2-4098-9309-2b2559b90f71"},{"t":"The Four Types of Stablecoins: A Comparative Analysis","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b71a1a20-d9a8-46d0-b77c-f772dfdfec3a/content","id":"5d9bbde3-cd53-411d-8ea0-2c312bb40fbd"},{"t":"Decentralised Governance in Football: Feasibility of DAO Implementation","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1d1dbcea-0e22-4d55-a98c-b5944e7e5d69/content","id":"768db685-95f6-40ef-b263-678e48e23089"},{"t":"The effect of the initial distribution of labor-related property rights on the allocative efficiency of labor markets","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/3329e5f6-7fa9-4b61-b39b-874e008d54be/content","id":"9157e4fd-6100-4c25-830d-c6a9f11cf06e"},{"t":"Gender information and perceived quality: An experiment with professional soccer performance","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/22540a79-af14-43cb-9206-7e8d9b2d3763/content","id":"5e99586a-4b8c-44ce-818e-0014bfc8e2ef"},{"t":"Examining discrimination against Jews in Italy with three natural field experiments","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e12db370-14d0-41fb-a268-ba9b2ed7fed2/content","id":"a853d5be-b655-432e-b88a-93affdb35003"},{"t":"Content Quality Assurance on Media Platforms with User-Generated Content","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/fc555e00-4463-4ec5-979b-311cd784e203/content","id":"17fde6b8-bdce-45b4-b88a-7d1f69ee3231"},{"t":"When a woman replaces a man: evaluating coach dismissal in professional tennis","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1c23bd9f-837c-4b98-a05b-da6e2d9ad1cb/content","id":"8776c75e-8804-4e3d-a3a5-ae9fb3875083"},{"t":"The Effects of Introducing Advertising in Pay TV: A Model of Asymmetric Competition between Pay TV and Free TV","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/3b66df8d-d523-45a4-b51e-15d8b4e98c7b/content","id":"e1d805e0-fb92-48cf-b707-88d51d34bf56"},{"t":"Fakten zur Midlife-Krise","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5ed1b5a1-072c-42b5-9fd7-894363a9dfd6/content","id":"50de8a37-b14a-4a7f-a04a-5f8cbd7016b7"},{"t":"(Not) being granted the right to belong-Amateur football clubs in Germany","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/36630d84-9b04-4648-8adc-f850ebbe9a10/content","id":"6dd8fd6c-f606-411d-8770-87cfd9d99ac0"}]},"sautner_zacharias":{"name":"Zacharias Sautner","field":"Sustainable Finance","chair":"Sustainable Finance","zora_total":34,"pdfs":14,"papers":[{"t":"Corporate nature risk perceptions","y":"2026","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1402ca87-b79a-4605-ac7b-53fe48091902/content","id":"da13526f-9d17-481f-93a8-2467ece08606"},{"t":"Firm-level nature dependence","y":"2026","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/cc0e8c04-3441-4788-b416-e98f5d799e01/content","id":"283950d5-6fb8-4770-bbb4-13c7ea7c49cb"},{"t":"Institutional Investors and the Fight Against Climate Change","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5a471194-f95e-4bc6-a06f-3f0a0b91745c/content","id":"db1637a1-dc0a-49b0-84e6-4f9f086999e4"},{"t":"The Measurement and Pricing of Biodiversity Risk","y":"2025","j":"","pdf":null,"id":"60620040-d48d-4ee1-ada4-76f11c3739d4"},{"t":"The EU Taxonomy and the Syndicated Loan Market","y":"2025","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/bdbe1392-069e-4245-8197-98ef306967db/content","id":"ff94b8ce-31c1-409b-aed7-b7df717595ab"},{"t":"Climate-Related Risks - A Focus on Banks and Credit Risk","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/589e6fc7-3746-40c4-925b-4fe1112d555d/content","id":"49540d3d-bb69-4bb2-898e-4d21c6f1ccf5"},{"t":"Do investors care about biodiversity?","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6143dd26-2f03-41d6-9c08-18e67ae4586d/content","id":"233bdae5-771b-467d-a316-59f668d9e470"},{"t":"The Value of ESG: Where and Why It Matters","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1048a457-525b-4be3-8456-f2e227bead47/content","id":"462c868b-b288-46a4-be6f-3fc427817d99"},{"t":"The Effects of Mandatory ESG Disclosure Around the World","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/26039b1d-c666-4904-aa6f-dcef5d7a77e0/content","id":"240ab0da-eb41-4a51-a75a-600a395e9df2"},{"t":"Limited attention to detail in financial markets: Evidence from reduced-form and structural estimation","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/8fc7fe96-ada7-4a48-b228-0610f1664ebe/content","id":"308d3db7-a9ed-47e3-a5d5-6fbe356cd348"},{"t":"ESG Shareholder Engagement and Downside Risk","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/c3f3f356-c1e4-4aec-b1a1-bae7a49d283a/content","id":"8b0b8fa2-a499-4b23-8c35-85fff0b4eebb"},{"t":"Pricing climate change exposure","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/17a5475d-491f-4a6a-a131-f2afdcfc0b9a/content","id":"627401bd-212b-4204-9b1d-c61e7a8b38a6"},{"t":"Climate risk disclosure and institutional investors","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2e643edc-9f89-4ec6-b79e-ef365cfdd38b/content","id":"b36555de-dd67-4211-b952-2e54d1680ac0"},{"t":"Firm-level climate change exposure","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/6ff1cf8f-2211-4596-a432-dc02d28ecd5c/content","id":"2140797e-8a22-4c76-85f3-9b4e285e351e"},{"t":"Do Investors Care About Biodiversity?","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/3e1450f8-e7bb-4b6a-b66c-92418a21ec70/content","id":"5fcfacc5-e4fe-4382-a012-0d4939670e50"}]},"coculescu_delia":{"name":"Delia Coculescu","field":"Math Finance","chair":"Quantitative Finance","zora_total":24,"pdfs":14,"papers":[{"t":"Economic Growth Versus Nature Protection: A Real Option Approach","y":"2026","j":"Crossref:10.2139/ssrn.6180720","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/97678d24-83a7-472a-a0b7-09a5528a0162/content","id":"bcd9c478-0535-419e-acc1-1a12b68a4e68"},{"t":"Who Pays, Who Benefits? Producer-Insurer Games in Life-Saving Medicines","y":"2025","j":"Crossref:10.2139/ssrn.5517438","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/b34a0934-a0ca-4d43-80d4-b33befb20ce8/content","id":"02b9d20e-9688-483e-aaa1-9d8b95e06c09"},{"t":"Opinion dynamics in communities with major influencers and implicit social influence via mean-field approximation","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/2be3aaa7-ab9c-455f-b808-dfc6c927490d/content","id":"83892d13-ccc7-4a65-b8af-6ba60e662901"},{"t":"A default system with overspilling contagion","y":"2024","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/3303af6c-50f5-49c5-865b-a659afb9846d/content","id":"3332fc3c-9077-44e4-90d3-64a90e7bff2a"},{"t":"Opinion dynamics in communities with major influencers and implicit social influence via mean-field approximation","y":"2023","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/5c1130f3-e935-487c-8cdf-54842da3735e/content","id":"3e2bd327-f171-4545-bad2-415d0024a404"},{"t":"Fairness principles for insurance contracts in the presence of default risk","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/e33e0231-55dd-4b93-9c56-d648412dd0ac/content","id":"46a24ee0-6eab-4f6c-8750-ed02d9ed6900"},{"t":"Group cohesion under individual regulatory constraints","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/fa592f71-69d2-495a-ada9-6f75900bcac9/content","id":"07e1b88b-535f-4d77-94db-2174ad345a8b"},{"t":"Insiders and Their Free Lunches: The Role of Short Positions","y":"2022","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/1163fd0b-950f-4ae8-aaec-0e973d07febf/content","id":"e3578563-a833-44a8-afbf-9e9d0b61571d"},{"t":"Emergence and Evolution of Cooperation for Survival: A Continuous Time Model","y":"2021","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/dc3b31d7-dd57-433c-a3bc-5854101e303a/content","id":"ebf5f770-c96f-4888-aa8e-ed8beb88592e"},{"t":"Fairness principles for insurance contracts in the presence of default risk","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/da95a465-06b6-4341-89ab-9c92ced474b5/content","id":"bee0961f-3fbc-4f4b-8589-2b0c338c95b2"},{"t":"Insiders and their Free Lunches: the Role of Short Positions","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/00278f20-381a-45eb-b451-12ad1f3fe18c/content","id":"bce29f05-7aed-4425-a8d6-a1dbd328190c"},{"t":"Group cohesion under individual regulatory constraints","y":"2020","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/4ee9e48e-7cb5-4fa6-833e-4f367824e1ec/content","id":"a1423c23-bbb2-4545-9102-7dbbf4e11393"},{"t":"Surplus Sharing with Coherent Utility Functions","y":"2019","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/039afacf-09b6-4412-ac39-258d63d1c95e/content","id":"35b42cc7-606b-416a-b267-af5e43e41b67"},{"t":"Some no-arbitrage rules under short-sales constraints, and applications to converging asset prices","y":"2019","j":"","pdf":null,"id":"d16fc728-4907-4295-b682-922d47a9c7b3"},{"t":"Shareholder Risk Measures","y":"2018","j":"","pdf":"https://www.zora.uzh.ch/server/api/core/bitstreams/93a730bf-1686-4816-aaa5-1c14143a4b46/content","id":"79421242-20a1-489b-a77f-1c0e42c96de9"}]}}}}},"stanford":{"name":"Stanford University","short":"Stanford","departments":{"economics":{"name":"Department of Economics","url":"https://economics.stanford.edu","professors":{"milgrom_paul":{"name":"Paul Milgrom","field":"Market Design","chair":"Nobel Prize 2020, Auction Theory","zora_total":122,"pdfs":96,"papers":[{"t":"Spectrum Auctions from the Perspective of Matching, with Andrew Vogt. In Online and Matching-Based Market Design, Cambridge University Press, Aug 2023","y":"2023","j":"","pdf":null,"id":"milgrom_0"},{"t":"When Should Control Be Shared?","y":"2022","j":"Management Science","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2022/03/Homogeneity-January-2022.pdf","id":"milgrom_4"},{"t":"Auction Research Evolving: Theorems and Market Designs, American Economic Review 2021, 111(5): 1383-1405","y":"2021","j":"American Economic Review","pdf":null,"id":"milgrom_5"},{"t":"Extended Proper Equilibrium","y":"2021","j":"Journal of Economic Theory","pdf":null,"id":"milgrom_6"},{"t":"Taming the Communication and Computation Complexity of Combinatorial Auctions: The FUEL Bid Language, with Martin Bichler and Gregor Schwarz, March 14, 2020","y":"2020","j":"","pdf":null,"id":"milgrom_3"},{"t":"Clock Auctions and Radio Spectrum Reallocation with Ilya Segal, Journal of Political Economy 2020, Vol 128, No. 1, 2020: 1-31","y":"2020","j":"Journal of Political Economy","pdf":null,"id":"milgrom_7"},{"t":"Auction Market Design: Recent Innovations, Annual Reviews, Vol 11:383-405, August 2019","y":"2019","j":"Annual Reviews,","pdf":"https://drive.google.com/file/d/1KtF257bgO0MkYne-GvZVg9z0Oqo1UXA7/view?usp=sharing.pdf","id":"milgrom_8"},{"t":"How Artificial Intelligence and Machine Learning Can Impact Market Design with Steve Tadelis. In The Economics of Artificial Intelligence: An Agenda, Ajay K. Agrawal, Joshua Gans, and Avi Goldfarb, editors. NBER: 2018","y":"2018","j":"The Economics of Artificial Intelligence: An Agenda,","pdf":null,"id":"milgrom_9"},{"t":"Equilibrium Selection in Auctions and High Stakes Games","y":"2018","j":"Econometrica","pdf":null,"id":"milgrom_10"},{"t":"Redesigning Spectrum Licenses","y":"2017","j":"Regulation","pdf":null,"id":"milgrom_11"},{"t":"Designing the US Incentive Auction, with Ilya Segal (pre-publication draft shown here). In Handbook of Spectrum Auction Design, Martin Bichler and Jacob Goeree (eds), Cambridge University Press, 2017","y":"2017","j":"Handbook of Spectrum Auction Design","pdf":null,"id":"milgrom_12"},{"t":"Discovering Prices: Auction Design in Markets with Complex Constraints. Columbia University Press, 2017","y":"2017","j":"Discovering Prices: Auction Design in Markets with Complex Constraints","pdf":null,"id":"milgrom_13"},{"t":"Economics and Computer Science of a Radio Spectrum Reallocation with Kevin Leyton-Brown and Ilya Segal, Proceedings of the National Academy of Sciences ,Vol 114, No. 28, July 2017: 7202-7209","y":"2017","j":"Proceedings of the National Academy of Sciences ,","pdf":null,"id":"milgrom_14"},{"t":"Winning Play in Spectrum Auctions , with Jeremy Bulow and Jonathan Levin. In Handbook of Spectrum Auction Design, Martin Bichler and Jacob Goeree (eds), Cambridge University Press, 2017","y":"2017","j":"Handbook of Spectrum Auction Design","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2021/08/Winning-Play-in-Spectrum-Auctions.pdf","id":"milgrom_29"},{"t":"Adverse Selection and Auction Design in Internet Display Advertising, with Nick Arnosti and Marissa Beck. American Economic Review, October 2016","y":"2016","j":"American Economic Review","pdf":null,"id":"milgrom_15"},{"t":"Ascending Prices and Package Bidding: Further Experimental Analysis , with John Kagel and Yuanchuan Lien, Games and Economic Behavior. vol 85, May 2014: 210-231","y":"2014","j":"Games and Economic Behavior","pdf":null,"id":"milgrom_16"},{"t":"Designing Random Allocation Mechanisms: Theory and Applications with Eric Budish, Yeon-Koo Che and Fuhito Kojima. American Economic Review, vol 103, number 2, April 2013: 585-623. [published version]","y":"2013","j":"American Economic Review","pdf":null,"id":"milgrom_17"},{"t":"Optimal Incentives in Core-Selecting Auctions , with Bob Day, in the Handbook of Market Design, Zvika Neeman, Al Roth, and Nir Vulkan (eds), Oxford University Press, 2013","y":"2013","j":"Handbook of Market Design","pdf":null,"id":"milgrom_23"},{"t":"Incentive Auction: Rules and Discussion, by Paul Milgrom, Lawrence Ausubel, Jonathan Levin and Ilya Segal. Published as Appendix C of the FCC 12-118 (Notice of Proposed Rulemaking on the Incentive Auction, Released October 2, 2012)","y":"2012","j":"","pdf":"https://transition.fcc.gov/Daily_Releases/Daily_Business/2012/db1002/FCC-12-118A1.pdf","id":"milgrom_18"},{"t":"'Complementarity in Organizations ,' with Erik Brynjolfsson (2012), in the Handbook of Organizational Economics, Princeton University Press, John Roberts and Bob Gibbons (eds), pp 11-55","y":"2012","j":"Handbook of Organizational Economics,","pdf":null,"id":"milgrom_19"},{"t":"The Case for Unlicensed Spectrum , coauthored with Jon Levin, October 2011","y":"2011","j":"","pdf":null,"id":"milgrom_20"},{"t":"'Critical Issues in Market Design' Economic Inquiry, vol 48, number 2, April 2011: 311-320. Doi:10.1111/j.1465-7295.2010.00357","y":"2011","j":"","pdf":null,"id":"milgrom_21"},{"t":"Simplified Mechanisms with an Application to Sponsored-Search Auctions. Games and Economic Behavior, Sept 2010, vol 70, Issue 1: 62-70","y":"2010","j":"Games and Economic Behavior","pdf":null,"id":"milgrom_22"},{"t":"'Ascending Prices and Package Bidding: A Theoretical and Experimental Analysis,' with Yuanchuan Lien and John Kagel, American Economic Journal: Microeconomics, Aug 2010, vol 2, number 3: 160-185. [Data files , Instructions , Online Appendix]","y":"2010","j":"American Economic Journal: Microeconomics","pdf":null,"id":"milgrom_24"},{"t":"Online Advertising: Heterogeneity and Conflation in Market Design , with Jon Levin. American Economic Review, Vol 100, Issue 2, May 2010, pp 603-607","y":"2010","j":"American Economic Review","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2021/08/Online-Advertising-Heterogeneity-and-Conflation-in-Market-Design-.pdf","id":"milgrom_25"},{"t":"Assignment Messages and Exchanges, AEJ-Micro 1:2, August 2009, 95-113","y":"2009","j":"Handbook of Spectrum Auction Design","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2021/08/Assignment-Messages-and-Exchanges.pdf","id":"milgrom_26"},{"t":"Using Procurement Auctions to Allocate Broadband Stimulus Grants, SIEPR May 2009","y":"2009","j":"","pdf":null,"id":"milgrom_27"},{"t":"Making Carbon Markets Work, SIEPR May 2009","y":"2009","j":"","pdf":null,"id":"milgrom_28"},{"t":"The Limited Influence of Unemployment on the Wage Bargain, coauthored with Robert Hall. American Economic Review98(4) (September 2008): 1653-1674","y":"2008","j":"American Economic Review","pdf":null,"id":"milgrom_30"},{"t":"Substitute Goods, Auctions and Equilibrium","y":"2008","j":"Journal of Economic Theory","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2008/06/milgrom-strulovici_substitutes_auctions_08apr22.pdf","id":"milgrom_31"},{"t":"Core-Selecting Package Auctions","y":"2008","j":"International Journal of Game Theory","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2008/06/Core-Selecting-Package-Auctions.pdf","id":"milgrom_32"},{"t":"The Promise of Prediction Markets , multiple co-authors, May 2008","y":"2008","j":"","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2021/08/The-Promise-of-Prediction-Markets.pdf","id":"milgrom_33"},{"t":"The Promise of Prediction Markets (22 co-authors), Science, 320, May 2008, 877-878","y":"2008","j":"","pdf":"http://mason.gmu.edu/~rhanson/PromisePredMkt.pdf","id":"milgrom_34"},{"t":"What the Seller Won't Tell You: Persuasion and Disclosure in Markets , Journal of Economics Perspectives, Spring 2008, 22(2): 115-131","y":"2008","j":"Journal of Economics Perspectives","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2021/08/What-the-Seller-Wont-Tell-You-Persuasion-and-Disclosure-in-Markets-.pdf","id":"milgrom_35"},{"t":"Economists Statement on US Broadband Policy , multiple co-authors, March 2006","y":"2006","j":"","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2021/08/Economists-Statement-on-US-Broadband-Policy.pdf","id":"milgrom_37"},{"t":"Multipliers and the LeChatelier Principle, Chapter 18 in Samuelsonian Economics and the Twenty-First Century edited by Michael Szenberg, Lall Ramrattan and Aron Gottesman, Oxford University Press, 2006","y":"2006","j":"Samuelsonian Economics and the Twenty-First Century","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2005/01/LeChatelier-Samuelson.pdf","id":"milgrom_41"},{"t":"Ascending Proxy Auctions","y":"2005","j":"","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2005/12/Ascending-Proxy-Auctions.pdf","id":"milgrom_38"},{"t":"The Lovely but Lonely Vickrey Auction","y":"2005","j":"","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2005/12/Lovely-but-Lonely-Vickrey-Auction-072404a.pdf","id":"milgrom_39"},{"t":"Matching with Contracts","y":"2005","j":"American Economic Review","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2005/09/Matching-with-Contracts-AER.pdf","id":"milgrom_40"},{"t":"The Clock-Proxy Auction: A Practical Combinatorial Design","y":"2005","j":"Handbook of Spectrum Auction Design","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2004/08/clock-proxy-auction.pdf","id":"milgrom_42"},{"t":"Package Auctions and Package Exchanges (2004 Fisher-Schultz lecture), Econometrica, 75(4), July 2007, 935-966","y":"2004","j":"Econometrica","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2007/07/Package-Auctions-Exchanges-FS-lecture-2004.pdf","id":"milgrom_36"},{"t":"Putting Auction Theory to Work. Cambridge: Cambridge University Press, 2004","y":"2004","j":"Putting Auction Theory to Work","pdf":null,"id":"milgrom_44"},{"t":"Ascending Auctions with Package Bidding","y":"2002","j":"Frontiers of Theoretical Economics","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2002/08/Ascending-Auctions-w-Package-Bidding.pdf","id":"milgrom_45"},{"t":"Package Bidding: Vickrey vs Ascending Auctions","y":"2002","j":"Revue Economique","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2002/05/Package-Bidding.pdf","id":"milgrom_46"},{"t":"Envelope Theorems for Arbitrary Choice Sets","y":"2002","j":"Econometrica","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2002/03/Envelope-Theorems.pdf","id":"milgrom_47"},{"t":"Advances in Routing Technologies and Internet Peering Agreements","y":"2001","j":"AEA Papers and Proceedings","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2001/05/Advances-in-Routing-Technologies-and-Internet-Peering-Agr.-2001.pdf","id":"milgrom_48"},{"t":"Promoting Efficient Use of Spectrum Through Elimination of Barriers to Secondary Markets , multiple co-authors, February 2001","y":"2001","j":"","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2021/08/Promoting-Efficient-Use-of-Spectrum-Through-Elimination-of-Barriers-to-Secondary-Markets.pdf","id":"milgrom_49"},{"t":"An Economist's Vision of the B-to-B Marketplace. Palo Alto: Perfect, 2000","y":"2000","j":"","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2000/10/An-Economists-Vision.pdf","id":"milgrom_50"},{"t":"Competitive Effects of Internet Peering Policies","y":"2000","j":"The Internet Upheaval","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2000/08/TPRC-1999.internet-peering.pdf","id":"milgrom_51"},{"t":"Putting Auction Theory to Work: The Simultaneous Ascending Auction, Journal of Political Economy, 108:2 (April, 2000), 245-272","y":"2000","j":"Journal of Political Economy","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2000/04/Putting-Auction-Theory-to-Work.pdf","id":"milgrom_52"},{"t":"Combination Bidding in Spectrum Auctions, in Competition, Regulation and Convergence: Current Trends in Telecommunications Research, Sharon Gillett and Ingo Vogelsang (Eds), Mahwah, New Jersey: Lawrence Erlbaum Associates, Publishers, 1999, pp 19-26","y":"1999","j":"Regulation and Convergence: Current Trends in Telecommunications Research","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1999/07/Combination-Bidding-in-Spectrum-Auctions-1999.pdf","id":"milgrom_53"},{"t":"A Theory of Auctions and Competitive Bidding, II","y":"1999","j":"The Economic Theory of Auctions","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1999/04/A-Theory-of-Auctions-and-Competitive-Bidding-II.pdf","id":"milgrom_54"},{"t":"The Internal Politics of the Firm","y":"1998","j":"The Politics of Exchange and the Economics of Power","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1998/01/The-Internal-Politics-of-the-Firm-1998.pdf","id":"milgrom_55"},{"t":"Game Theory and the Spectrum Auctions, European Economic Review, 42 (1998), 771-778","y":"1998","j":"European Economic Review","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1998/01/Game-Theory-and-the-Spectrum-Auctions-1998.pdf","id":"milgrom_56"},{"t":"Procuring Universal Telephone Service, in 1997 Industry Economics Conference, Industry Commission (ed.), Conference Proceedings, 10-11 July 1997, AGPS, Canberra","y":"1997","j":"Industry Economics Conference","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1997/07/Procuring-Universal97.pdf","id":"milgrom_57"},{"t":"Procuring Universal Service: Putting Auction Theory to Work, in Le Prix Nobel: The Nobel Prizes, 1996, Nobel Foundation, 1997, 382-392. (Also available on the Nobel Prize site.)","y":"1996","j":"Le Prix Nobel: The Nobel Prizes","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1996/12/Procuring-Universal-Service-Putting-Auction-Theory-to-Work-1996.pdf","id":"milgrom_58"},{"t":"Complementarities in the Transition from Socialism: A Firm-Level Analysis","y":"1996","j":"Reforming Asian Socialism: The Growth of Market Institutions","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2021/08/Gates-Milgrom-Roberts-Transition.pdf","id":"milgrom_59"},{"t":"The LeChatelier Principle","y":"1996","j":"American Economic Review","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1996/03/The-LeChatelier-Principle.pdf","id":"milgrom_60"},{"t":"Coalition-Proofness and Correlation with Arbitrary Communication Possibilities","y":"1996","j":"Games and Economic Behavior","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1995/02/Coalition-Proofness.pdf","id":"milgrom_65"},{"t":"The Economics of Modern Manufacturing: Technology, Strategy and Organization: Reply, American Economic Review, 85 (September, 1995) 997\u2011999","y":"1995","j":"American Economic Review","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1995/09/The-Economics-of-Modern-Manufacturing-Reply.pdf","id":"milgrom_61"},{"t":"Deterring Predation in Telecommunications: Are Line-of-Business Restraints Needed?","y":"1995","j":"Managerial and Decision Economics","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1995/08/Detering-Predation.pdf","id":"milgrom_62"},{"t":"Complementarities and Fit: Strategy, Structure and Organizational Change in Manufacturing","y":"1995","j":"Journal of Accounting and Economics","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1995/05/Complementarities-and-fit.pdf","id":"milgrom_63"},{"t":"Continuous Adjustment and Fundamental Change in Business Strategy and Organization","y":"1995","j":"Trends in Business Organization: Do Participation and Cooperation Increase Competitiveness?","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2021/08/Continuous-Adjustment-and-Fundamental-Change-1995.pdf","id":"milgrom_64"},{"t":"The Firm as an Incentive System","y":"1994","j":"American Economic Review","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1994/09/The-Firm-as-an-Incentive-System.pdf","id":"milgrom_66"},{"t":"Coordination, Commitment and Enforcement: The Case of the Merchant Guild","y":"1994","j":"Explaining Social Institutions","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2021/08/CoordinationCommitment.pdf","id":"milgrom_67"},{"t":"Comparing Optima: Do Simplifying Assumptions Affect Conclusions?, Journal of Political Economy, 102(3), June 1994: 607-615","y":"1994","j":"Journal of Political Economy","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1994/06/Comparing-Optima.pdf","id":"milgrom_68"},{"t":"Comparing Equilibria","y":"1994","j":"American Economic Review","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1994/06/Comparing-Equilibria.pdf","id":"milgrom_69"},{"t":"Complementarities and Systems: Understanding Japanese Economic Organization","y":"1994","j":"Estudios Economicos","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2021/08/Milgrom-Roberts-Complements-Japan.pdf","id":"milgrom_70"},{"t":"Monotone Comparative Statics","y":"1994","j":"Econometrica","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1994/01/Monotone-Comparative-Statics.pdf","id":"milgrom_71"},{"t":"Johnson Controls, Inc - Automotive Systems Group: The Georgetown Kentucky Plant","y":"1993","j":"","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1993/11/Johnson-Controls-Inc.-1993.pdf","id":"milgrom_72"},{"t":"Is Sympathy an Economic Value? Philosophy, Economics and the Contingent Valuation Method. Contingent Valuation: A Critical Assessment. Elsevier-North Holland, 1993, Jerry Hausman (ed), 417-441","y":"1993","j":"Contingent Valuation: A Critical Assessment","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1993/08/Is-Sympathy-An-Economic-Value.pdf","id":"milgrom_73"},{"t":"Pay, Perks and Parachutes: Do They Pay?","y":"1992","j":"Stanford Business","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1992/12/Pay-Perks-and-Parachutes-1992.pdf","id":"milgrom_75"},{"t":"Organizational Prospects, Influence Costs and Ownership Changes","y":"1992","j":"Journal of Economics and Management Strategy","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1992/04/Organizational-Prospects.pdf","id":"milgrom_77"},{"t":"The Real Output of the Stock Exchange","y":"1992","j":"Output Measurement in the Services Sectors","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2021/08/The-Real-Output-of-the-Stock-Exchange-.pdf","id":"milgrom_78"},{"t":"Multitask Principal-Agent Analyses: Incentive Contracts, Asset Ownership and Job Design","y":"1991","j":"Journal of Law, Economics and Organization","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1991/09/multitask_principal_agent.pdf","id":"milgrom_79"},{"t":"A Theory of Hierarchies Based on Limited Managerial Attention","y":"1991","j":"Journal of Japanese and International Economies","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1991/05/A-Theory-of-Hierarchies.pdf","id":"milgrom_80"},{"t":"Complementarities, Momentum, and the Evolution of Modern Manufacturing","y":"1991","j":"American Economic Association Papers and Proceedings","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1991/05/Complementarities-Momentum-and-Evolution.pdf","id":"milgrom_81"},{"t":"Adaptive and Sophisticated Learning in Repeated Normal Form Games","y":"1991","j":"Games and Economic Behavior","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1991/02/Adaptive-and-Sophisticated-Learning.pdf","id":"milgrom_82"},{"t":"Information and Timing in Repeated Partnerships","y":"1991","j":"Econometrica","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1991/01/Information-and-Timing-in-Repeated-Partnerships.pdf","id":"milgrom_83"},{"t":"Short Term Contracts and Long Term Agency Relationships","y":"1990","j":"Journal of Economic Theory","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1990/06/ShortTermContracts.pdf","id":"milgrom_84"},{"t":"The Economics of Modern Manufacturing: Technology, Strategy and Organization","y":"1990","j":"American Economic Review","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1990/06/The-Economics-of-Modern-Manufacturing.pdf","id":"milgrom_85"},{"t":"The Efficiency of Equity in Organizational Decision Processes","y":"1990","j":"American Economic Review Papers and Proceedings","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1990/05/The-Efficiency-of-Equity-in-Organizational.pdf","id":"milgrom_86"},{"t":"Regulating Trade Among Agents","y":"1990","j":"Journal of Institutional and Theoretical Economics","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1990/03/RegulatingTradeAmongAgents.pdf","id":"milgrom_87"},{"t":"Bargaining Costs, Influence Costs and the Organization of Economic Activity","y":"1990","j":"Perspectives on Positive Political Economy","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1990/03/BargainingCosts.pdf","id":"milgrom_88"},{"t":"The Role of Institutions in the Revival of Trade: The Medieval Law Merchant","y":"1990","j":"Economics and Politics","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1990/03/RoleofInstitutions.pdf","id":"milgrom_89"},{"t":"Rationalizability, Learning and Equilibrium in Games With Strategic Complementarities","y":"1990","j":"Econometrica","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1990/02/Rationalizability-Learning-and-Equilibrium.pdf","id":"milgrom_90"},{"t":"New Theories of Predatory Pricing","y":"1990","j":"Industrial Structure in the New Industrial Economics","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1990/01/NewTheoriesOFPredatoryPricing.pdf","id":"milgrom_91"},{"t":"Auctions and Bidding: A Primer, Journal of Economic Perspectives, 3, Summer 1989, 3-22","y":"1989","j":"Journal of Economic Perspectives","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1989/07/Auctions-and-Bidding-Primer.pdf","id":"milgrom_92"},{"t":"An Essay on Price Discrimination, The Economics of Imperfect Competition and Employment: Joan Robinson and Beyond, edited by George Feiwel, New York: MacMillan and New York: New York University Press, 1989, 365-86","y":"1989","j":"The Economics of Imperfect Competition and Employment","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1989/01/essay_on_price_discrimination.pdf","id":"milgrom_93"},{"t":"Economic Theories of Organization: Past, Present and Future","y":"1988","j":"Canadian Journal of Economics","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1988/08/Economic-Theories-of-the-Firm.pdf","id":"milgrom_94"},{"t":"Communication and Inventories as Substitutes in Organizing Production","y":"1988","j":"Scandinavian Journal of Economics","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2021/08/Communication-and-Inventories.pdf","id":"milgrom_95"},{"t":"An Economic Approach to Influence Activities and Organizational Responses","y":"1988","j":"American Journal of Sociology","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1988/07/An-Economic-Approach.pdf","id":"milgrom_96"},{"t":"Employment Contracts, Influence Activities and Efficient Organization Design, Journal of Political Economy, 96(1), February 1988, 42-60","y":"1988","j":"Journal of Political Economy","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1988/02/Employment-Contracts-Influence-Activities.pdf","id":"milgrom_97"},{"t":"Predatory Pricing, The New Palgrave: A Dictionary of Economic Theory and Doctrine, J. Eatwell, M. Milgate, and P. Newman (eds.), London: MacMillan Press Ltd., 1988","y":"1988","j":"The New Palgrave: A Dictionary of Economic Theory and Doctrine","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1988/01/PredatoryPricing.pdf","id":"milgrom_98"},{"t":"Job Discrimination, Market Forces, and the Invisibility Hypothesis","y":"1987","j":"Quarterly Journal of Economics","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1987/08/Job-Discrimination-Market-Forces.pdf","id":"milgrom_99"},{"t":"Auction Theory, Advances in Economic Theory: Fifth World Congress, edited by Truman Bewley, London: Cambridge University Press, 1987, 1-32","y":"1987","j":"Advances in Economic Theory: Fifth World Congress","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1987/08/Auction-Theory-Advances-in-Economic-Theory-1987.pdf","id":"milgrom_100"},{"t":"Informational Asymmetries, Strategic Behavior and Industrial Organization","y":"1987","j":"AEA Papers and Proceedings","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1987/05/Informational-Asymmetries.pdf","id":"milgrom_101"},{"t":"Aggregation and Linearity in the Provision of Intertemporal Incentives","y":"1987","j":"Econometrica","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1987/03/Aggregation-and-Linearity.pdf","id":"milgrom_102"},{"t":"Relying on the Information of Interested Parties","y":"1986","j":"Rand Journal of Economics","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1986/04/Relying-on-the-Information-of-Interested-Parties.pdf","id":"milgrom_103"},{"t":"Price and Advertising Signals of Product Quality","y":"1986","j":"Journal of Political Economy","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1986/01/Pricing-and-Advertising-Signals.pdf","id":"milgrom_104"},{"t":"Measuring the Interest\u2011Rate Risk, Transactions of the Society of Actuaries, XXXVII, 1985: 241-57","y":"1985","j":"Transactions of the Society of Actuaries","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1985/12/Measuring-the-interest-rate-risk-1985.pdf","id":"milgrom_105"},{"t":"Distributional Strategies for Games with Incomplete Information","y":"1985","j":"Mathematics of Operations Research","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1985/11/DistributionalStrategies.pdf","id":"milgrom_106"},{"t":"Reply to the Comments on 'Measuring the Interest Rate Risk', Transactions of the Society of Actuaries, XXXVII, 1985: 297-302","y":"1985","j":"Transactions of the Society of Actuaries","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1985/10/Reply-to-the-comments-on-Measuring-the-interest-rate-risk.pdf","id":"milgrom_107"},{"t":"The Economics of Competitive Bidding: A Selective Survey, Social Goals and Social Organization: A Volume in Honor of Elisha Pazner, edited by L. Hurwicz, D. Schmeidler and H. Sonnenschein, London: Cambridge University Press, 1985, Chapter 9, 261-89","y":"1985","j":"","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1985/03/Economics-Of-Competitive-Bidding.pdf","id":"milgrom_108"},{"t":"Bid, Ask and Transactions Prices in a Specialist Market with Insider Trading","y":"1985","j":"Journal of Financial Economics","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1984/09/Bid-Ask-and-Transaction-Prices.pdf","id":"milgrom_109"},{"t":"Private Information in an Auction\u2011Like Securities Market, Auctions, Bidding and Contracting: Uses and Theory, edited by R. Engelbrecht\u2011Wiggans, M. Shubik and R. Stark, New York: New York University Press, New York, 1983","y":"1983","j":"Auctions, Bidding and Contracting: Uses and Theory","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1993/08/Private-Information-In-An-Auction-Like.pdf","id":"milgrom_74"},{"t":"Competitive Bidding with Proprietary Information","y":"1983","j":"Journal of Mathematical Economics","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1992/10/CompetitiveBiddingAndProprietary.pdf","id":"milgrom_76"},{"t":"The Value of Information in a Sealed Bid Auction","y":"1982","j":"The Economic Theory of Auctions","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1982/11/ValueOfInformation.pdf","id":"milgrom_110"},{"t":"Predation, Reputation, and Entry Deterrence","y":"1982","j":"Journal of Economic Theory","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1982/08/PredationAndReputation.pdf","id":"milgrom_111"},{"t":"Limit Pricing and Entry Under Incomplete Information: An Equilibrium Analysis","y":"1982","j":"Econometrica","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1982/08/Limit-Pricing-and-Entry.pdf","id":"milgrom_112"},{"t":"A Theory of Auctions and Competitive Bidding","y":"1982","j":"Econometrica","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1982/08/A-Theory-of-Auctions-and-Competitive-Bidding.pdf","id":"milgrom_113"},{"t":"Rational Cooperation in the Finitely\u2011Repeated Prisoners' Dilemma","y":"1982","j":"Journal of Economic Theory","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1982/08/RationalCooperation.pdf","id":"milgrom_114"},{"t":"Information, Trade and Common Knowledge","y":"1982","j":"Journal of Economic Theory","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1982/02/Information-Trade-and-Common-Knowledge.pdf","id":"milgrom_115"},{"t":"Good News and Bad News: Representation Theorems and Applications, Bell Journal of Economics, 12, 1981, 380\u201191","y":"1981","j":"Bell Journal of Economics","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1981/10/Good-News-and-Bad-News.pdf","id":"milgrom_116"},{"t":"An Axiomatic Characterization of Common Knowledge, Econometrica, 49, 1981, 219\u201122","y":"1981","j":"Econometrica","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1981/03/An-Axiomatic-Characterization-of-Common-Knowledge.pdf","id":"milgrom_117"},{"t":"Rational Expectations, Information Acquisition, and Competitive Bidding, Econometrica, 49, 1981, 921\u201143. Reprinted in The Economic Theory of Auctions, edited by Paul Klemperer, London: Edward Elgar Publishing, 1999","y":"1981","j":"Econometrica","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1981/03/Rational-Expectations.pdf","id":"milgrom_118"},{"t":"Topologies on Information and Strategies in Normal\u2011Form Games with Incomplete Information","y":"1981","j":"Game Theory and Mathematical Economics","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1981/02/TopologiesOfInformation.pdf","id":"milgrom_119"},{"t":"A Convergence Theorem for Competitive Bidding with Differential Information, Econometrica, 47, 1979, 679\u201188. Erratum","y":"1979","j":"","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1979/04/A-Convergence-Theory-for-Competitive-Bidding.pdf","id":"milgrom_120"},{"t":"On Understanding the Effects of GAAP Reserve Assumptions, Transactions of the Society of Actuaries, 27, 1975, 71\u201188","y":"1975","j":"Transactions of the Society of Actuaries","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/1975/05/On-Understanding-the-Effects-GAAP.pdf","id":"milgrom_121"},{"t":"Incentive Auction Design Alternatives: A Simulation Study, with Kevin Leyton-Brown, Neil Newman and Ilya Segal. Forthcoming in Management Science","y":"","j":"","pdf":null,"id":"milgrom_1"},{"t":"Algorithmic Mechanism Design with Investment, with Mohammad Akbarpour, Scott Kominers, Kevin Michael Li and Shengwu Li. Forthcoming in Econometrica","y":"","j":"","pdf":null,"id":"milgrom_2"},{"t":"Presentation and Structure of Substitutes Valuations","y":"","j":"","pdf":"https://milgrom.people.stanford.edu/wp-content/uploads/2004/05/bing_lehmann_milgrom.pdf","id":"milgrom_43"}]}}}}},"harvard":{"name":"Harvard University","short":"Harvard","departments":{"economics":{"name":"Harvard Business School / Department of Economics","url":"https://www.hbs.edu/faculty","professors":{"roth_alvin":{"name":"Alvin E. Roth","field":"Market Design","chair":"Nobel Prize 2012, Game Theory & Market Design","zora_total":84,"pdfs":9,"papers":[{"t":"Reimagining Transplant Center Incentives Beyond the CMS IOTA Model","y":"2026","j":"JAMA","pdf":"https://www.hbs.edu/faculty/Pages/download.aspx?name=jama_chan_2026_vp_250170_1769011899.17711.pdf","id":"roth_0"},{"t":"Regulation of Organ Transplantation and Procurement: A Market-Design Lab Experiment","y":"2024","j":"Journal of Political Economy","pdf":null,"id":"roth_1"},{"t":"Market Design and Maintenance","y":"2023","j":"NBER Working Paper","pdf":"https://www.nber.org/papers/w31947","id":"roth_75"},{"t":"Kidney Exchange: An Operations Perspective","y":"2021","j":"Management Science","pdf":null,"id":"roth_2"},{"t":"Marketplaces, Markets, and Market Design","y":"2018","j":"American Economic Review","pdf":null,"id":"roth_3"},{"t":"Minimizing Justified Envy in School Choice: The Design of New Orleans OneApp","y":"2017","j":"NBER Working Paper","pdf":null,"id":"roth_77"},{"t":"College Admissions as Non-Price Competition: The Case of South Korea","y":"2014","j":"NBER Working Paper","pdf":null,"id":"roth_78"},{"t":"Don't Take No for an Answer: An Experiment with Actual Organ Donor Registrations","y":"2014","j":"NBER Working Paper","pdf":null,"id":"roth_79"},{"t":"Unraveling Results from Comparable Demand and Supply: An Experimental Investigation","y":"2013","j":"Games","pdf":null,"id":"roth_5"},{"t":"Matching with Couples: Stability and Incentives in Large Markets","y":"2013","j":"Quarterly Journal of Economics","pdf":null,"id":"roth_6"},{"t":"The Handbook of Market Design","y":"2013","j":"Oxford University Press","pdf":null,"id":"roth_80"},{"t":"Organ Allocation Policy and the Decision to Donate","y":"2012","j":"American Economic Review","pdf":"http://kuznets.harvard.edu/~aroth/papers/KesslerRoth_OrganDonationAndAllocation.pdf","id":"roth_8"},{"t":"NEAD Chains in Transplantation","y":"2011","j":"American Journal of Transplantation","pdf":null,"id":"roth_9"},{"t":"Kidney Paired Donation","y":"2011","j":"Nephrology, Dialysis, Transplantation","pdf":null,"id":"roth_10"},{"t":"Nonsimultaneous Chains and Dominos in Kidney Paired Donation - Revisited","y":"2011","j":"American Journal of Transplantation","pdf":null,"id":"roth_11"},{"t":"A Choice Prediction Competition for Social Preferences in Simple Extensive Form Games","y":"2011","j":"Games","pdf":"http://www.mdpi.com/2073-4336/2/3/257/pdf","id":"roth_12"},{"t":"The Job Market for New Economists: A Market Design Perspective","y":"2010","j":"Journal of Economic Perspectives","pdf":"http://www.stanford.edu/~niederle/JobMarket.JEP2010..pdf","id":"roth_7"},{"t":"Kidneys for Sale: Who Disapproves, and Why?","y":"2010","j":"American Journal of Transplantation","pdf":null,"id":"roth_13"},{"t":"A Choice Prediction Competition: Choices from Experience and from Description","y":"2010","j":"Journal of Behavioral Decision Making","pdf":null,"id":"roth_14"},{"t":"A Choice Prediction Competition for Market Entry Games","y":"2010","j":"Games","pdf":null,"id":"roth_15"},{"t":"Strategy-proofness versus Efficiency in Matching with Indifferences: Redesigning the NYC High School Match","y":"2009","j":"American Economic Review","pdf":"http://kuznets.fas.harvard.edu/~aroth/papers/aer.NYCSchools.Dec2009.pdf","id":"roth_16"},{"t":"Market Culture: How Rules Governing Exploding Offers Affect Market Performance","y":"2009","j":"American Economic Journal: Microeconomics","pdf":null,"id":"roth_17"},{"t":"A Nonsimultaneous, Extended, Altruistic-Donor Chain","y":"2009","j":"New England Journal of Medicine","pdf":"http://kuznets.fas.harvard.edu/~aroth/papers/Rees%20etal%20NEJM%202009.pdf","id":"roth_18"},{"t":"If You Are Offered the Right of First Refusal, Should You Accept?","y":"2009","j":"Games and Economic Behavior","pdf":null,"id":"roth_19"},{"t":"The Gastroenterology Fellowship Match: The First Two Years","y":"2008","j":"Gastroenterology","pdf":null,"id":"roth_20"},{"t":"Deferred Acceptance Algorithms: History, Theory, Practice, and Open Questions","y":"2008","j":"International Journal of Game Theory","pdf":null,"id":"roth_21"},{"t":"What Have We Learned from Market Design?","y":"2008","j":"Economic Journal","pdf":null,"id":"roth_22"},{"t":"Unraveling Yields Inefficient Matchings: Evidence from Post-Season College Football Bowls","y":"2007","j":"RAND Journal of Economics","pdf":null,"id":"roth_23"},{"t":"The Art of Designing Markets","y":"2007","j":"Harvard Business Review","pdf":null,"id":"roth_24"},{"t":"Efficient Kidney Exchange: Coincidence of Wants in a Structured Market","y":"2007","j":"American Economic Review","pdf":null,"id":"roth_25"},{"t":"Repugnance as a Constraint on Markets","y":"2007","j":"Journal of Economic Perspectives","pdf":null,"id":"roth_26"},{"t":"Multi-agent Learning and the Descriptive Value of Simple Models","y":"2007","j":"Artificial Intelligence","pdf":null,"id":"roth_27"},{"t":"The New Market for Federal Judicial Law Clerks","y":"2007","j":"University of Chicago Law Review","pdf":null,"id":"roth_28"},{"t":"The Speed of Learning in Noisy Games: Partial Reinforcement and the Sustainability of Cooperation","y":"2006","j":"American Economic Review","pdf":null,"id":"roth_4"},{"t":"Utilizing List Exchange and Undirected Good Samaritan Donation through Chain Paired Kidney Exchanges","y":"2006","j":"American Journal of Transplantation","pdf":null,"id":"roth_29"},{"t":"Learning in Noisy Games: Partial Reinforcement and the Sustainability of Cooperation","y":"2006","j":"American Economic Review","pdf":null,"id":"roth_30"},{"t":"Late and Multiple Bidding in Second-Price Internet Auctions","y":"2006","j":"Games and Economic Behavior","pdf":null,"id":"roth_31"},{"t":"Increasing the Opportunity of Live Kidney Donation By Matching for Two and Three Way Exchanges","y":"2006","j":"Transplantation","pdf":null,"id":"roth_32"},{"t":"The Dynamics of Law Clerk Matching","y":"2006","j":"Journal of Economic Dynamics and Control","pdf":null,"id":"roth_33"},{"t":"What Will Be Needed for the New GI Fellowship Match to Succeed?","y":"2006","j":"Gastroenterology","pdf":null,"id":"roth_34"},{"t":"Pairwise Kidney Exchange","y":"2005","j":"Journal of Economic Theory","pdf":null,"id":"roth_35"},{"t":"The Collapse of a Medical Labor Clearinghouse (and why such failures are rare)","y":"2005","j":"American Economic Review","pdf":null,"id":"roth_36"},{"t":"The New York City High School Match","y":"2005","j":"American Economic Review","pdf":null,"id":"roth_37"},{"t":"The Boston Public School Match","y":"2005","j":"American Economic Review","pdf":null,"id":"roth_38"},{"t":"The Gastroenterology Fellowship Market: Should There Be a Match?","y":"2005","j":"American Economic Review","pdf":null,"id":"roth_39"},{"t":"A Kidney Exchange Clearinghouse in New England","y":"2005","j":"American Economic Review","pdf":null,"id":"roth_40"},{"t":"An Experimental Analysis of Ending Rules in Internet Auctions","y":"2005","j":"RAND Journal of Economics","pdf":null,"id":"roth_41"},{"t":"Auctions of Homogeneous Goods with Increasing Returns","y":"2004","j":"Management Science","pdf":null,"id":"roth_42"},{"t":"The Gastroenterology Fellowship Match: How It Failed, and Why It Could Succeed Once Again","y":"2004","j":"Gastroenterology","pdf":null,"id":"roth_43"},{"t":"Kidney Exchange","y":"2004","j":"Quarterly Journal of Economics","pdf":null,"id":"roth_44"},{"t":"The Nash Equilibrium: A Perspective","y":"2004","j":"Proceedings of the National Academy of Sciences","pdf":null,"id":"roth_45"},{"t":"Unraveling Reduces Mobility in a Labor Market: Gastroenterology with and without a Centralized Match","y":"2003","j":"Journal of Political Economy","pdf":"http://www.economics.harvard.edu/~aroth/papers/gastro.pdf","id":"roth_46"},{"t":"Bargaining under a Deadline: Evidence from the Reverse Ultimatum Game","y":"2003","j":"Games and Economic Behavior","pdf":null,"id":"roth_47"},{"t":"Relative versus Absolute Speed of Adjustment in Strategic Environments","y":"2003","j":"Experimental Economics","pdf":null,"id":"roth_48"},{"t":"Relationship Between Wages and Presence of a Match in Medical Fellowships","y":"2003","j":"JAMA","pdf":null,"id":"roth_49"},{"t":"The Origins, History, and Design of the Resident Match","y":"2003","j":"JAMA","pdf":null,"id":"roth_50"},{"t":"Last-Minute Bidding and the Rules for Ending Second-Price Auctions: Evidence from eBay and Amazon","y":"2002","j":"American Economic Review","pdf":null,"id":"roth_51"},{"t":"The Economist As Engineer: Game Theory, Experimental Economics and Computation As Tools of Design Economics","y":"2002","j":"Econometrica","pdf":null,"id":"roth_52"},{"t":"Predictive Value and the Usefulness of Game Theoretic Models","y":"2002","j":"International Journal of Forecasting","pdf":null,"id":"roth_53"},{"t":"The Timing of Bids in Internet Auctions: Market Design, Bidder Behavior, and Artificial Agents","y":"2002","j":"AI Magazine","pdf":null,"id":"roth_54"},{"t":"The Economist As Engineer","y":"2002","j":"Econometrica","pdf":null,"id":"roth_74"},{"t":"The Market for Federal Judicial Law Clerks","y":"2001","j":"University of Chicago Law Review","pdf":null,"id":"roth_55"},{"t":"The Dynamics of Reorganization in Matching Markets","y":"2000","j":"Quarterly Journal of Economics","pdf":null,"id":"roth_56"},{"t":"The Redesign of the Matching Market for American Physicians","y":"1999","j":"American Economic Review","pdf":null,"id":"roth_57"},{"t":"Truncation Strategies in Matching Markets","y":"1999","j":"Econometrica","pdf":null,"id":"roth_60"},{"t":"Predicting How People Play Games: Reinforcement Learning in Experimental Games","y":"1998","j":"American Economic Review","pdf":null,"id":"roth_58"},{"t":"Learning in High Stakes Ultimatum Games","y":"1998","j":"Econometrica","pdf":null,"id":"roth_59"},{"t":"The Effects of the Change in the NRMP Matching Algorithm","y":"1997","j":"JAMA","pdf":null,"id":"roth_61"},{"t":"Turnaround Time and Bottlenecks in Market Clearing","y":"1997","j":"Journal of Political Economy","pdf":null,"id":"roth_62"},{"t":"Handbook of Experimental Economics","y":"1997","j":"Princeton University Press","pdf":null,"id":"roth_82"},{"t":"The National Resident Matching Program as a Labor Market","y":"1996","j":"JAMA","pdf":null,"id":"roth_63"},{"t":"Learning in Extensive-Form Games: Experimental Data and Simple Dynamic Models","y":"1995","j":"Games and Economic Behavior","pdf":null,"id":"roth_64"},{"t":"Jumping the Gun: Imperfections and Institutions Related to the Timing of Market Transactions","y":"1994","j":"American Economic Review","pdf":null,"id":"roth_65"},{"t":"Considerations of Fairness and Strategy: Experimental Data from Sequential Games","y":"1992","j":"Quarterly Journal of Economics","pdf":null,"id":"roth_66"},{"t":"Bargaining and Market Behavior in Jerusalem, Ljubljana, Pittsburgh, and Tokyo","y":"1991","j":"American Economic Review","pdf":null,"id":"roth_67"},{"t":"A Natural Experiment in the Organization of Entry Level Labor Markets","y":"1991","j":"American Economic Review","pdf":null,"id":"roth_68"},{"t":"New Physicians: A Natural Experiment in Market Organization","y":"1990","j":"Science","pdf":null,"id":"roth_69"},{"t":"Two-Sided Matching: A Study in Game-Theoretic Modeling and Analysis","y":"1990","j":"Cambridge University Press","pdf":null,"id":"roth_81"},{"t":"The Shapley Value: Essays in Honor of Lloyd S. Shapley","y":"1988","j":"Cambridge University Press","pdf":null,"id":"roth_83"},{"t":"The Evolution of the Labor Market for Medical Interns and Residents","y":"1984","j":"Journal of Political Economy","pdf":null,"id":"roth_70"},{"t":"Towards a Theory of Bargaining: An Experimental Study in Economics","y":"1983","j":"Science","pdf":null,"id":"roth_71"},{"t":"Expectations and Reputations in Bargaining: An Experimental Study","y":"1983","j":"American Economic Review","pdf":null,"id":"roth_72"},{"t":"The Role of Information in Bargaining","y":"1982","j":"Econometrica","pdf":null,"id":"roth_73"},{"t":"Axiomatic Models of Bargaining","y":"1979","j":"Springer-Verlag","pdf":"http://kuznets.fas.harvard.edu/~aroth/Axiomatic_Models_of_Bargaining.pdf","id":"roth_84"}]}}}}},"bonn":{"name":"Universitat Bonn","short":"Bonn","departments":{"economics":{"name":"Institute for Applied Microeconomics (IAME)","url":"https://www.econ.uni-bonn.de/iame/en","professors":{"falk_armin":{"name":"Armin Falk","field":"Behavioral Economics","chair":"Leibniz Prize 2009, Gossen Prize 2008, ERC Grants","zora_total":58,"pdfs":7,"papers":[{"t":"Mentoring and Schooling Decisions: Causal Evidence","y":"2026","j":"Journal of Political Economy","pdf":null,"id":"falk_8"},{"t":"What's worth knowing? Economists' opinions about economics","y":"2025","j":"Working Paper","pdf":"https://www.wiwi.uni-bonn.de/falk/wps/2025-07-17_whats_worth_knowing.pdf","id":"falk_2"},{"t":"Limited Self-knowledge and Survey Response Behavior","y":"2025","j":"IZA Discussion Paper","pdf":"https://www.wiwi.uni-bonn.de/falk/wps/2025-07-08_survey_answers.pdf","id":"falk_6"},{"t":"Misperceived Social Norms and Willingness to Act Against Climate Change","y":"2025","j":"Review of Economics and Statistics","pdf":null,"id":"falk_7"},{"t":"Malleability of preferences for honesty","y":"2025","j":"Economic Journal","pdf":null,"id":"falk_9"},{"t":"Communicating through Defaults","y":"2025","j":"Review of Economics and Statistics","pdf":null,"id":"falk_10"},{"t":"Ends versus Means: Kantians, Utilitarians, and Moral Decisions","y":"2024","j":"NBER Working Paper","pdf":"https://www.nber.org/papers/w32073","id":"falk_3"},{"t":"Eliciting Moral Preferences under Image Concerns: Theory and Experiment","y":"2024","j":"Working Paper","pdf":"https://luca-henkel.github.io/papers/Moral_Preferences.pdf","id":"falk_5"},{"t":"Does a single dose of testosterone increase willingness to compete","y":"2024","j":"Hormones and Behavior","pdf":null,"id":"falk_11"},{"t":"Attention and Dread: Experimental Evidence on Preferences for Information","y":"2024","j":"Management Science","pdf":null,"id":"falk_12"},{"t":"Globally Representative Evidence on the Actual and Perceived Support for Climate Action","y":"2024","j":"Nature Climate Change","pdf":null,"id":"falk_13"},{"t":"Intertemporal Altruism","y":"2024","j":"American Economic Journal: Microeconomics","pdf":null,"id":"falk_14"},{"t":"Self-assessment: The role of the social environment","y":"2023","j":"Journal of Public Economics","pdf":null,"id":"falk_15"},{"t":"The Preference Survey Module: A Validated Instrument for Measuring Risk, Time, and Social Preferences","y":"2023","j":"Management Science","pdf":null,"id":"falk_16"},{"t":"The Origins of Gender Differences in Competitiveness and Earnings Expectations","y":"2021","j":"IZA Discussion Paper","pdf":"https://docs.iza.org/dp14800.pdf","id":"falk_0"},{"t":"Herding, Warfare, and a Culture of Honor: Global Evidence","y":"2021","j":"NBER Working Paper","pdf":"https://www.nber.org/papers/w29250","id":"falk_1"},{"t":"Patience and Comparative Development","y":"2021","j":"Review of Economic Studies","pdf":null,"id":"falk_17"},{"t":"Facing yourself - A Note on self-image","y":"2021","j":"Journal of Economic Behavior and Organization","pdf":null,"id":"falk_18"},{"t":"Socioeconomic Status and Inequalities in Children's IQ and Economic Preferences","y":"2021","j":"Journal of Political Economy","pdf":null,"id":"falk_19"},{"t":"The development of egalitarian norm enforcement in childhood and adolescence","y":"2020","j":"Journal of Economic Behavior and Organization","pdf":null,"id":"falk_20"},{"t":"Diffusion of Being Pivotal and Immoral Outcomes","y":"2020","j":"Review of Economic Studies","pdf":null,"id":"falk_21"},{"t":"Ten considerations for effectively managing the COVID-19 transition","y":"2020","j":"Nature Human Behaviour","pdf":null,"id":"falk_22"},{"t":"Re-Revisiting the marshmallow test","y":"2020","j":"Psychological Science","pdf":null,"id":"falk_23"},{"t":"The Formation of Prosociality: Causal Evidence on the Role of Social Environment","y":"2020","j":"Journal of Political Economy","pdf":null,"id":"falk_24"},{"t":"Defaults and donations: Evidence from a field experiment","y":"2019","j":"Review of Economics and Statistics","pdf":null,"id":"falk_25"},{"t":"Narratives, Imperatives, and Moral Reasoning","y":"2018","j":"NBER Working Paper","pdf":"https://www.nber.org/papers/w24798","id":"falk_4"},{"t":"Global evidence on economic preferences","y":"2018","j":"Quarterly Journal of Economics","pdf":null,"id":"falk_26"},{"t":"Relationship of gender differences in preferences to economic development and gender equality","y":"2018","j":"Science","pdf":null,"id":"falk_27"},{"t":"Risk attitudes across the life course","y":"2017","j":"Economic Journal","pdf":null,"id":"falk_28"},{"t":"Institutions and morals: A reply","y":"2015","j":"European Journal of Political Economy","pdf":null,"id":"falk_29"},{"t":"Neural patterns underlying social comparisons of personal performance","y":"2015","j":"Social Cognitive and Affective Neuroscience","pdf":null,"id":"falk_30"},{"t":"Institutions and contract enforcement","y":"2015","j":"Journal of Labor Economics","pdf":null,"id":"falk_31"},{"t":"Representative evidence on lying costs","y":"2014","j":"Journal of Public Economics","pdf":null,"id":"falk_32"},{"t":"Contractual incompleteness, unemployment, and labor market segmentation","y":"2014","j":"Review of Economic Studies","pdf":null,"id":"falk_33"},{"t":"Morals and Markets","y":"2013","j":"Science","pdf":null,"id":"falk_34"},{"t":"Do lab experiments misrepresent social preferences?","y":"2013","j":"Journal of the European Economic Association","pdf":null,"id":"falk_35"},{"t":"A city-wide experiment on trust discrimination","y":"2013","j":"Journal of Public Economics","pdf":null,"id":"falk_36"},{"t":"The relationship between economic preferences and psychological personality measures","y":"2012","j":"Annual Review of Economics","pdf":null,"id":"falk_37"},{"t":"Competition and relational contracts: The role of unemployment as a disciplinary device","y":"2012","j":"Journal of the European Economic Association","pdf":null,"id":"falk_38"},{"t":"The intergenerational transmission of risk and trust attitudes","y":"2012","j":"Review of Economic Studies","pdf":null,"id":"falk_39"},{"t":"Promotions and incentives: The case of multistage elimination tournaments","y":"2012","j":"Journal of Labor Economics","pdf":null,"id":"falk_40"},{"t":"Individual risk attitudes: Measurement, determinants, and behavioral consequences","y":"2011","j":"Journal of the European Economic Association","pdf":null,"id":"falk_41"},{"t":"Unemployment and right-wing extremist crime","y":"2011","j":"Scandinavian Journal of Economics","pdf":null,"id":"falk_42"},{"t":"You get what you pay for: Incentives and selection in the education system","y":"2010","j":"Economic Journal","pdf":null,"id":"falk_43"},{"t":"Direct evidence on risk attitudes and migration","y":"2010","j":"Review of Economics and Statistics","pdf":null,"id":"falk_44"},{"t":"Lab experiments are a major source of knowledge in the social sciences","y":"2009","j":"Science","pdf":null,"id":"falk_45"},{"t":"Homo reciprocans: Survey evidence on behavioural outcomes","y":"2009","j":"Economic Journal","pdf":null,"id":"falk_46"},{"t":"Testing theories of fairness - Intentions matter","y":"2008","j":"Games and Economic Behavior","pdf":null,"id":"falk_47"},{"t":"Representative trust and reciprocity: Prevalence and determinants","y":"2008","j":"Economic Inquiry","pdf":null,"id":"falk_48"},{"t":"Social comparison affects reward-related brain activity in the human ventral striatum","y":"2007","j":"Science","pdf":null,"id":"falk_49"},{"t":"Gift exchange in the field","y":"2007","j":"Econometrica","pdf":null,"id":"falk_50"},{"t":"The Hidden Costs of Control","y":"2006","j":"American Economic Review","pdf":null,"id":"falk_51"},{"t":"Fairness perceptions and reservation wages","y":"2006","j":"Quarterly Journal of Economics","pdf":null,"id":"falk_52"},{"t":"Clean evidence on peer effects","y":"2006","j":"Journal of Labor Economics","pdf":null,"id":"falk_53"},{"t":"Driving forces behind informal sanctions","y":"2005","j":"Econometrica","pdf":null,"id":"falk_54"},{"t":"Relational contracts and the nature of market interactions","y":"2004","j":"Econometrica","pdf":null,"id":"falk_55"},{"t":"Psychological foundations of incentives","y":"2002","j":"European Economic Review","pdf":null,"id":"falk_56"},{"t":"Wage Rigidity in a Competitive Incomplete Contract Market","y":"1999","j":"Journal of Political Economy","pdf":null,"id":"falk_57"}]}}}}}},"stats":{"universities":4,"departments":6,"professors":43,"papers_scraped":832,"pdfs_with_urls":592}};

        async function loadUniversities() {
            const el = document.getElementById('uni-content');
            if (!el) { console.error('UNI: uni-content not found'); return; }
            try {
                if (!_uniData) _uniData = _UNI_KB_EMBEDDED;
                if (!_uniData) { el.innerHTML = '<div style="color:red;padding:20px">ERROR: No data loaded</div>'; return; }
                console.log('UNI: Data loaded, professors:', _uniData?.stats?.professors);
                uniRender();
            } catch(e) {
                el.innerHTML = '<div style="color:red;padding:20px">ERROR: ' + e.message + '</div>';
                console.error('UNI Error:', e);
            }
        }

        function uniRender() {
            try {
            const el = document.getElementById('uni-content');
            const bc = document.getElementById('uni-breadcrumb');
            const stats = document.getElementById('uni-stats');
            if (!el) return;

            // Stats
            if (_uniData.stats) {
                const s = _uniData.stats;
                stats.innerHTML = `
                    <span class="uni-stat"><b>${s.universities || 1}</b> Uni${s.universities>1?'s':''}</span>
                    <span class="uni-stat"><b>${s.departments || 0}</b> Departments</span>
                    <span class="uni-stat"><b>${s.professors || 0}</b> Professoren</span>
                    <span class="uni-stat"><b>${s.pdfs_with_urls || 0}</b> PDFs</span>
                `;
            }

            if (_uniView === 'universities') {
                bc.innerHTML = '<span style="color:var(--accent)">🏛 Universitäten</span>';
                uniRenderUniversities(el);
            } else if (_uniView === 'departments') {
                bc.innerHTML = `<button class="uni-back" onclick="uniNav('universities')">🏛 Universitäten</button> <span style="color:var(--text-muted)">›</span> <span style="color:var(--accent)">${_uniData.universities[_uniPath.uni]?.name || ''}</span>`;
                uniRenderDepartments(el);
            } else if (_uniView === 'professors') {
                const uni = _uniData.universities[_uniPath.uni];
                const dept = uni?.departments[_uniPath.dept];
                bc.innerHTML = `<button class="uni-back" onclick="uniNav('universities')">🏛 Universitäten</button> <span style="color:var(--text-muted)">›</span> <button class="uni-back" onclick="uniNav('departments')">${uni?.short || uni?.name}</button> <span style="color:var(--text-muted)">›</span> <span style="color:var(--accent)">${dept?.name || ''}</span>`;
                uniRenderProfessors(el);
            } else if (_uniView === 'papers') {
                const uni = _uniData.universities[_uniPath.uni];
                const dept = uni?.departments[_uniPath.dept];
                const prof = dept?.professors[_uniPath.prof];
                bc.innerHTML = `<button class="uni-back" onclick="uniNav('universities')">🏛</button> <span style="color:var(--text-muted)">›</span> <button class="uni-back" onclick="uniNav('departments')">${uni?.short || ''}</button> <span style="color:var(--text-muted)">›</span> <button class="uni-back" onclick="uniNav('professors')">${dept?.name?.replace('Department of ','') || ''}</button> <span style="color:var(--text-muted)">›</span> <span style="color:var(--accent)">${prof?.name || ''}</span>`;
                uniRenderPapers(el);
            }
            } catch(e) {
                const el = document.getElementById('uni-content');
                if(el) el.innerHTML = '<div style="color:red;padding:20px;font-family:monospace">uniRender Error: ' + e.message + '<br>' + e.stack + '</div>';
                console.error('uniRender error:', e);
            }
        }

        function uniNav(view, key) {
            if (view === 'universities') { _uniView = 'universities'; _uniPath = {}; }
            else if (view === 'departments') { _uniView = 'departments'; if(key) _uniPath.uni = key; }
            else if (view === 'professors') { _uniView = 'professors'; if(key) _uniPath.dept = key; }
            else if (view === 'papers') { _uniView = 'papers'; if(key) _uniPath.prof = key; }
            uniRender();
        }

        function uniRenderUniversities(el) {
            const unis = _uniData.universities;
            let html = '<div class="uni-grid">';
            for (const [key, uni] of Object.entries(unis)) {
                const deptCount = Object.keys(uni.departments || {}).length;
                let profCount = 0, paperCount = 0;
                for (const dept of Object.values(uni.departments || {})) {
                    profCount += Object.keys(dept.professors || {}).length;
                    for (const prof of Object.values(dept.professors || {})) {
                        paperCount += prof.zora_total || prof.papers?.length || 0;
                    }
                }
                html += `
                    <div class="uni-card" onclick="uniNav('departments','${key}')">
                        <div class="uni-card-icon">🏛</div>
                        <div class="uni-card-title">${uni.name}</div>
                        <div class="uni-card-sub">${uni.short ? uni.short + ' — ' : ''}${_uniData.source || ''}</div>
                        <div class="uni-card-stats">
                            <span class="uni-stat"><b>${deptCount}</b> Departments</span>
                            <span class="uni-stat"><b>${profCount}</b> Professoren</span>
                            <span class="uni-stat"><b>${paperCount.toLocaleString()}</b> Papers (ZORA)</span>
                        </div>
                    </div>`;
            }
            html += '</div>';
            el.innerHTML = html;
        }

        function uniRenderDepartments(el) {
            const uni = _uniData.universities[_uniPath.uni];
            if (!uni) return;
            let html = '<div class="uni-grid">';
            const icons = {economics:'📊', business:'💼', finance:'📈'};
            for (const [key, dept] of Object.entries(uni.departments || {})) {
                const profs = Object.values(dept.professors || {});
                const profCount = profs.length;
                const paperCount = profs.reduce((s,p) => s + (p.zora_total||0), 0);
                const pdfCount = profs.reduce((s,p) => s + (p.pdfs||0), 0);
                const topProfs = profs.sort((a,b) => (b.zora_total||0) - (a.zora_total||0)).slice(0,3).map(p=>p.name).join(', ');
                html += `
                    <div class="uni-card" onclick="uniNav('professors','${key}')">
                        <div class="uni-card-icon">${icons[key]||'📚'}</div>
                        <div class="uni-card-title">${dept.name}</div>
                        <div class="uni-card-sub">${topProfs}</div>
                        <div class="uni-card-stats">
                            <span class="uni-stat"><b>${profCount}</b> Professoren</span>
                            <span class="uni-stat"><b>${paperCount.toLocaleString()}</b> Papers</span>
                            <span class="uni-stat"><b>${pdfCount}</b> PDFs verfügbar</span>
                        </div>
                    </div>`;
            }
            html += '</div>';
            el.innerHTML = html;
        }

        function uniRenderProfessors(el) {
            const dept = _uniData.universities[_uniPath.uni]?.departments[_uniPath.dept];
            if (!dept) return;
            let profs = Object.entries(dept.professors || {});
            // Filter
            const q = (document.getElementById('uni-search')?.value || '').toLowerCase();
            if (q) profs = profs.filter(([k,p]) => p.name.toLowerCase().includes(q) || p.field?.toLowerCase().includes(q));
            // Sort by zora_total desc
            profs.sort((a,b) => (b[1].zora_total||0) - (a[1].zora_total||0));

            let html = '<div class="uni-grid">';
            for (const [key, prof] of profs) {
                const initials = prof.name.split(' ').map(n=>n[0]).join('').slice(0,2);
                const pdfPct = prof.papers?.length ? Math.round(prof.pdfs / prof.papers.length * 100) : 0;
                html += `
                    <div class="uni-card" onclick="uniNav('papers','${key}')">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                            <div class="uni-prof-avatar">${initials}</div>
                            <div>
                                <div class="uni-card-title" style="margin-bottom:2px">${prof.name}</div>
                                <div style="font-size:12px;color:var(--text-secondary)">${prof.field || ''}</div>
                            </div>
                        </div>
                        <div style="font-size:12px;color:var(--text-muted);margin-bottom:10px">${prof.chair || ''}</div>
                        <div class="uni-card-stats">
                            <span class="uni-stat"><b>${prof.zora_total||0}</b> in ZORA</span>
                            <span class="uni-stat"><b>${prof.pdfs||0}</b> PDFs</span>
                            <span class="uni-stat"><b>${pdfPct}%</b> verfügbar</span>
                        </div>
                    </div>`;
            }
            html += '</div>';
            if (profs.length === 0) html = '<div style="text-align:center;padding:40px;color:var(--text-muted)">Keine Professoren gefunden.</div>';
            el.innerHTML = html;
        }

        function uniRenderPapers(el) {
            const dept = _uniData.universities[_uniPath.uni]?.departments[_uniPath.dept];
            const prof = dept?.professors[_uniPath.prof];
            if (!prof) return;

            const initials = prof.name.split(' ').map(n=>n[0]).join('').slice(0,2);
            let papers = prof.papers || [];

            // Filter
            const q = (document.getElementById('uni-search')?.value || '').toLowerCase();
            if (q) papers = papers.filter(p => p.t?.toLowerCase().includes(q) || p.j?.toLowerCase().includes(q) || p.y?.includes(q));

            let html = `
                <div class="uni-prof-header">
                    <div class="uni-prof-avatar" style="width:64px;height:64px;font-size:26px">${initials}</div>
                    <div class="uni-prof-info">
                        <h3>${prof.name}</h3>
                        <p>${prof.field || ''} · ${prof.chair || ''}</p>
                        <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
                            <span class="uni-badge">${prof.zora_total||0} Papers in ZORA</span>
                            <span class="uni-badge" style="background:rgba(52,211,153,0.1);color:var(--success);border-color:rgba(52,211,153,0.2)">${prof.pdfs||0} PDFs verfügbar</span>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom:16px;font-size:13px;color:var(--text-muted)">Zeige ${papers.length} von ${prof.zora_total||papers.length} Papers (neueste zuerst)</div>
            `;

            for (const p of papers) {
                const hasPdf = !!p.pdf;
                html += `
                    <div class="uni-paper">
                        <div class="uni-paper-title">${p.t || 'Untitled'}</div>
                        <div class="uni-paper-meta">
                            ${p.y ? `<span>📅 ${p.y}</span>` : ''}
                            ${p.j ? `<span>📰 ${p.j}</span>` : ''}
                        </div>
                        <div class="uni-paper-actions">
                            ${hasPdf ? `<a href="${p.pdf}" target="_blank" class="uni-btn-sm uni-btn-pdf" onclick="event.stopPropagation()">📄 PDF öffnen</a>` : '<span class="uni-btn-sm" style="border-color:var(--border);color:var(--text-muted);cursor:default">Kein PDF</span>'}
                            ${hasPdf ? `<button class="uni-btn-sm uni-btn-import" onclick="uniImport(this,'${encodeURIComponent(p.pdf)}','${encodeURIComponent(p.t||'')}')">⬇ Import to BEATRIX</button>` : ''}
                        </div>
                    </div>`;
            }

            if (papers.length === 0) html += '<div style="text-align:center;padding:40px;color:var(--text-muted)">Keine Papers gefunden.</div>';
            el.innerHTML = html;
        }

        async function uniImport(btn, pdfUrlEnc, titleEnc) {
            const pdfUrl = decodeURIComponent(pdfUrlEnc);
            const title = decodeURIComponent(titleEnc);
            btn.disabled = true;
            btn.textContent = '⏳ Importiere...';
            try {
                const r = await fetch(`${API}/papers/fetch-and-upload`, {
                    method:'POST',
                    headers:{'Content-Type':'application/json', ...H()},
                    body: JSON.stringify({url: pdfUrl, title: title})
                });
                if (r.ok) {
                    btn.textContent = '✅ Importiert';
                    btn.classList.add('imported');
                    showToast('Paper importiert: ' + title.slice(0,50), 'success');
                } else if (r.status === 409) {
                    btn.textContent = '✅ Bereits vorhanden';
                    btn.classList.add('imported');
                    showToast('Paper bereits in BEATRIX', 'info');
                } else {
                    const d = await r.json().catch(()=>({}));
                    throw new Error(d.detail || 'Import fehlgeschlagen');
                }
            } catch(e) {
                btn.disabled = false;
                btn.textContent = '⬇ Import to BEATRIX';
                showToast(e.message || 'Import fehlgeschlagen', 'error');
            }
        }

        function uniFilter() {
            if (_uniView === 'professors' || _uniView === 'papers') uniRender();
        }

// Auto-init: if section is active, load
document.addEventListener('DOMContentLoaded', function() {
    console.log('UNI script loaded OK');
});
</script>
</body>
</html>
